"use client";

import { zodResolver } from "@hookform/resolvers/zod";
import {
  ChevronLeft,
  ChevronRight,
  Minus,
  Plus,
  RotateCcw,
  Store,
  Truck,
  ZoomIn,
  Star,
  Share2,
  Heart,
  MessageCircle,
  MoreHorizontal,
  ThumbsUp,
  ThumbsDown,
  ArrowRight,
} from "lucide-react";
import PhotoSwipeLightbox, { PhotoSwipe } from "photoswipe/lightbox";
import { useEffect, useMemo, useRef, useState } from "react";
import {
  ControllerRenderProps,
  FormProvider,
  SubmitHandler,
  useForm,
  UseFormReturn,
} from "react-hook-form";
import { z } from "zod";

import "photoswipe/style.css";

import { cn } from "@/lib/utils";

import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from "@/components/ui/accordion";
import { AspectRatio } from "@/components/ui/aspect-ratio";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import {
  Carousel,
  CarouselApi,
  CarouselContent,
  CarouselItem,
  CarouselNext,
  CarouselPrevious,
} from "@/components/ui/carousel";
import {
  FormControl,
  FormField,
  FormItem,
  FormLabel,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Progress } from "@/components/ui/progress";
import { Separator } from "@/components/ui/separator";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Card, CardContent } from "@/components/ui/card";

// --- Types ---

type StockStatusCode = "IN_STOCK" | "OUT_OF_STOCK";

interface StockInfo {
  stockStatusCode?: StockStatusCode;
  stockQuantity?: number;
}

interface ProductImagesProps {
  images: Array<{
    alt: string;
    width: number;
    height: number;
    srcset?: string;
    src: string;
    sizes?: string;
  }>;
  galleryID: string;
}

interface Option {
  id: string;
  value: string;
  label: string;
  stockInfo: StockInfo;
  price?: price;
}

interface Hinges {
  label: string;
  id: string;
  name: FieldName;
  options?: Option[];
  min?: number;
  max?: number;
}

interface ProductFormProps {
  hinges: Record<FieldName, Hinges>;
  onSubmit: SubmitHandler<FormType>;
  stockInfo?: StockInfo;
  form: UseFormReturn<z.infer<typeof formSchema>>;
  selectedSize?: string;
  productInfo: {
    name: string;
    thumbnail: {
      src: string;
      alt: string;
    };
    price?: price;
  };
}

type price = {
  regular?: number;
  sale?: number;
  currency?: string;
};

interface PriceProps extends price {
  size?: "default" | "sm" | "lg";
}

type FormType = z.infer<typeof formSchema>;
type FieldName = keyof FormType;

interface SizeRadioGroupProps {
  options?: Array<Option>;
  field: ControllerRenderProps<FormType>;
}

interface QuantityProps {
  field: ControllerRenderProps<FormType>;
  max?: number;
  min?: number;
}

// --- Data ---

const PRODUCT_DETAILS = {
  name: "This Ben Hogan Men's Solid Ottoman Golf Polo Shirt",
  rating: 4.8,
  reviewCount: 136,
  store: {
    name: "Berkah Disoko Mall",
    verified: true,
    rating: "95%",
    location: "Tanjungpinang",
    ready: "98%",
  },
  price: {
    regular: 250000,
    sale: 187500,
    currency: "IDR",
  },
  images: [
    {
      src: "https://images.unsplash.com/photo-1618354691373-d851c5c3a990?q=80&w=1000&auto=format&fit=crop",
      alt: "Black Polo Shirt Front",
      width: 1000,
      height: 1000,
    },
    {
      src: "https://images.unsplash.com/photo-1581655353564-df123a1eb820?q=80&w=1000&auto=format&fit=crop",
      alt: "Black Polo Shirt Detail",
      width: 1000,
      height: 1000,
    },
    {
      src: "https://images.unsplash.com/photo-1586363104862-3a5e2ab60d99?q=80&w=1000&auto=format&fit=crop",
      alt: "Black Polo Shirt Back",
      width: 1000,
      height: 1000,
    },
    {
      src: "https://images.unsplash.com/photo-1576566588028-4147f3842f27?q=80&w=1000&auto=format&fit=crop",
      alt: "Black Polo Shirt Model",
      width: 1000,
      height: 1000,
    },
  ],
  description:
    "This Ben Hogan Men's Solid Ottoman Golf Polo Shirt makes for versatile casualwear or golf apparel. Built-in moisture wicking and sun protection keep you feeling dry while blocking out harmful UV rays. Durable textured Ottoman fabric and a ribbed collar with three-button placket give it classic polo style. The solid color makes this golf top easy to pair up with any pants or shorts for style that looks great both on and off the course.",
  details: [
    { label: "Package Dimensions", value: "27.2 x 24.8 x 4.9 cm; 190 g" },
    { label: "Specification", value: "Moisture-Wicking, Stretchy, SPF/UV Protection, Easy Care" },
    { label: "Date First Available", value: "August 30, 2021" },
    { label: "Department", value: "Mens" },
  ],
  hinges: {
    size: {
      label: "Select Size",
      id: "size",
      name: "size",
      options: [
        {
          id: "s",
          value: "s",
          label: "S",
          stockInfo: { stockStatusCode: "IN_STOCK" },
        },
        {
          id: "m",
          value: "m",
          label: "M",
          stockInfo: { stockStatusCode: "IN_STOCK" },
        },
        {
          id: "l",
          value: "l",
          label: "L",
          stockInfo: { stockStatusCode: "IN_STOCK" },
        },
        {
          id: "xl",
          value: "xl",
          label: "XL",
          stockInfo: { stockStatusCode: "IN_STOCK" },
        },
        {
          id: "xxl",
          value: "xxl",
          label: "XXL",
          stockInfo: { stockStatusCode: "IN_STOCK" },
        },
        {
          id: "3xl",
          value: "3xl",
          label: "3XL",
          stockInfo: { stockStatusCode: "OUT_OF_STOCK" },
        },
      ],
    },
    quantity: {
      label: "Quantity",
      id: "quantity",
      name: "quantity",
      min: 1,
      max: 99,
    },
  } as Record<FieldName, Hinges>,
};

const STYLING_IDEAS = [
  {
    name: "Orange Men's wicking shirt 100% cotton...",
    price: 330000,
    sale: 240000,
    image: "https://images.unsplash.com/photo-1576566588028-4147f3842f27?q=80&w=300&auto=format&fit=crop",
  },
  {
    name: "Mens Easy Reader Date Black/Silver/W...",
    price: 595000,
    sale: 410000,
    image: "https://images.unsplash.com/photo-1524592094714-0f0654e20314?q=80&w=300&auto=format&fit=crop",
  },
  {
    name: "Sport Running Shoes for Men Ideal Breath...",
    price: 740000,
    sale: 665000,
    image: "https://images.unsplash.com/photo-1542291026-7eec264c27ff?q=80&w=300&auto=format&fit=crop",
  },
];

const REVIEWS = [
  {
    id: 1,
    author: "His favorite shirts!",
    date: "10 August 2023",
    rating: 5,
    content: "They are cool shirts, do not try this garbage, they give you poor quality rags, do not buy more clothes in this place, on top of that you want to return it and they block you, it is miserable.",
    likes: 22,
    dislikes: 6,
    variant: "Color: Black • Size: XL",
  },
  {
    id: 2,
    author: "Cool as a cucumber",
    date: "12 July 2023",
    rating: 5,
    content: "This shirt is made of polyester and I wasn't sure how that would go for me, but since I sweat a lot and stay hot I, I realized that the weave is quite different from the polyester shirts of my childhood. There was nothing uncomfortable about it, it had a certain sheen to it, which looked nice. The grey color is great for me, not too dark or light.",
    likes: 54,
    dislikes: 4,
    variant: "Color: Grey • Size: L",
  },
  {
    id: 3,
    author: "My Son-inLaw likes these shirts",
    date: "6 July 2023",
    rating: 5,
    content: "Nice solid pattern shirt for my husband who wants smart shirts. Keeps shape and no stretches after washes which is handy as a scratch including its medium light weight fabric that is cooler than most polo shirts with a texture weave that allows air flow. Great for lighter heat for warmer weather and the fit is just right with a little extra room for air and long enough to allow you to bend over comfortably.",
    likes: 21,
    dislikes: 8,
    variant: "Color: Black • Size: XXL",
  },
  {
    id: 4,
    author: "Good comfortable polo shirt for everyday",
    date: "5 July 2023",
    rating: 5,
    content: "The most comfortable and youthful polo shirts for summer wear. And you definitely can't beat the price for these. I have 3 so far/ I bought three shades of red, black, and heather grey before the prices started going up.",
    likes: 55,
    dislikes: 1,
    variant: "Color: Black • Size: XXL",
  },
];

const BEST_SELLERS = [
  {
    name: "UrbanEdge Men's Jeans Collection",
    price: 253000,
    sale: 420000,
    rating: 4.2,
    sold: "10k+",
    image: "https://images.unsplash.com/photo-1542272617-08f086302542?q=80&w=300&auto=format&fit=crop",
  },
  {
    name: "EHM M41 Men's Slip-on Shoes Cloth Shoes Sne...",
    price: 175000,
    sale: 450000,
    rating: 4.8,
    sold: "1.8k+",
    image: "https://images.unsplash.com/photo-1560769629-975ec94e6a86?q=80&w=300&auto=format&fit=crop",
  },
  {
    name: "Mellon Men's New Distressed Cap Men Co...",
    price: 125000,
    sale: 150000,
    rating: 4.9,
    sold: "6k+",
    image: "https://images.unsplash.com/photo-1588850561407-ed78c282e89b?q=80&w=300&auto=format&fit=crop",
  },
  {
    name: "GOGO Men's Flannel Hoodie Shirts Long Slee...",
    price: 325000,
    sale: null,
    rating: 4.5,
    sold: "2k+",
    image: "https://images.unsplash.com/photo-1617137968427-85924c809a10?q=80&w=300&auto=format&fit=crop",
  },
];

// --- Components ---

const formSchema = z.object({
  quantity: z.number().min(1).max(99),
  size: z.string(),
});

export default function ProductPage() {
  const form = useForm<FormType>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      size: "xl",
      quantity: 1,
    },
  });

  const sizeHinges = PRODUCT_DETAILS.hinges?.size;
  const size = form.watch("size");

  const selectedItem = useMemo(() => {
    return sizeHinges?.options?.find((item) => item.value === size);
  }, [size, sizeHinges]);

  const stockInfo = selectedItem?.stockInfo;

  const onSubmit = (data: FormType) => {
    console.log(data);
  };

  return (
    <div className="min-h-screen bg-background font-sans text-foreground">
      <div className="container mx-auto px-4 py-8 lg:px-8">
        {/* Breadcrumb (Mock) */}
        <div className="mb-6 flex items-center gap-2 text-sm text-muted-foreground">
          <span>Home</span>
          <ChevronRight className="h-4 w-4" />
          <span>Products</span>
          <ChevronRight className="h-4 w-4" />
          <span className="text-foreground font-medium truncate">{PRODUCT_DETAILS.name}</span>
        </div>

        <div className="grid grid-cols-1 gap-8 lg:grid-cols-12">
          {/* Left Column: Images */}
          <div className="lg:col-span-7">
            <ProductImages
              images={PRODUCT_DETAILS.images}
              galleryID="gallery-demo"
            />
          </div>

          {/* Right Column: Product Info */}
          <div className="lg:col-span-5">
            <div className="flex flex-col gap-6">
              <div>
                <h1 className="text-2xl font-bold leading-tight lg:text-3xl">
                  {PRODUCT_DETAILS.name}
                </h1>
                <div className="mt-2 flex items-center gap-4">
                  <div className="flex items-center gap-1">
                    <Star className="h-4 w-4 fill-yellow-400 text-yellow-400" />
                    <span className="font-medium">{PRODUCT_DETAILS.rating}</span>
                    <span className="text-muted-foreground">
                      • {PRODUCT_DETAILS.reviewCount} Reviews
                    </span>
                  </div>
                  <div className="text-sm text-green-600 font-medium">
                    93% Recommended
                  </div>
                </div>
              </div>

              <div className="flex items-baseline gap-3">
                <Price
                  regular={PRODUCT_DETAILS.price.regular}
                  sale={PRODUCT_DETAILS.price.sale}
                  currency={PRODUCT_DETAILS.price.currency}
                  size="lg"
                />
                {PRODUCT_DETAILS.price.sale && (
                  <Badge variant="destructive" className="text-xs">
                    25% OFF
                  </Badge>
                )}
              </div>

              {/* Color Selection (Mock) */}
              <div>
                <div className="mb-3 text-sm font-medium">Select Color</div>
                <div className="flex gap-3">
                  <div className="h-10 w-10 rounded-md border-2 border-primary bg-black ring-2 ring-offset-2 ring-offset-background"></div>
                  <div className="h-10 w-10 rounded-md border border-input bg-gray-200"></div>
                </div>
              </div>

              <ProductForm
                hinges={PRODUCT_DETAILS.hinges}
                form={form}
                onSubmit={onSubmit}
                selectedSize={selectedItem?.label}
                stockInfo={stockInfo}
                productInfo={{
                  name: PRODUCT_DETAILS.name,
                  price: PRODUCT_DETAILS.price,
                  thumbnail: { src: PRODUCT_DETAILS.images[0].src, alt: PRODUCT_DETAILS.name },
                }}
              />

              <div className="flex items-center justify-between border-t border-b py-4">
                <div className="flex gap-6">
                  <button className="flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-foreground">
                    <MessageCircle className="h-4 w-4" />
                    Chat
                  </button>
                  <button className="flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-foreground">
                    <Heart className="h-4 w-4" />
                    Wishlist
                  </button>
                  <button className="flex items-center gap-2 text-sm font-medium text-muted-foreground hover:text-foreground">
                    <Share2 className="h-4 w-4" />
                    Share
                  </button>
                </div>
              </div>

              {/* Store Info */}
              <div className="rounded-lg border p-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <Avatar>
                      <AvatarImage src="https://github.com/shadcn.png" />
                      <AvatarFallback>BD</AvatarFallback>
                    </Avatar>
                    <div>
                      <div className="flex items-center gap-1 font-medium">
                        {PRODUCT_DETAILS.store.name}
                        {PRODUCT_DETAILS.store.verified && (
                          <Badge variant="secondary" className="h-4 px-1 text-[10px] text-blue-600">
                            ✓
                          </Badge>
                        )}
                      </div>
                      <div className="text-xs text-muted-foreground">Online</div>
                    </div>
                  </div>
                  <div className="flex gap-2">
                    <Button variant="outline" size="sm">Follow</Button>
                    <Button variant="outline" size="sm">Visit Store</Button>
                  </div>
                </div>
                <div className="mt-4 grid grid-cols-3 gap-4 text-center text-sm">
                  <div>
                    <div className="font-medium">{PRODUCT_DETAILS.store.rating}</div>
                    <div className="text-xs text-muted-foreground">Rating Store</div>
                  </div>
                  <div>
                    <div className="font-medium">{PRODUCT_DETAILS.store.location}</div>
                    <div className="text-xs text-muted-foreground">Location Store</div>
                  </div>
                  <div>
                    <div className="font-medium">{PRODUCT_DETAILS.store.ready}</div>
                    <div className="text-xs text-muted-foreground">On Ready</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Tabs / Details Section */}
        <div className="mt-12">
          <div className="flex gap-4 border-b">
            <Button variant="ghost" className="rounded-none border-b-2 border-primary px-6 py-2 font-medium text-primary hover:text-primary">
              Description
            </Button>
            <Button variant="ghost" className="rounded-none px-6 py-2 font-medium text-muted-foreground hover:text-foreground">
              Styling Ideas
            </Button>
            <Button variant="ghost" className="rounded-none px-6 py-2 font-medium text-muted-foreground hover:text-foreground">
              Review
            </Button>
            <Button variant="ghost" className="rounded-none px-6 py-2 font-medium text-muted-foreground hover:text-foreground">
              Best Seller
            </Button>
            <div className="ml-auto flex items-center gap-2 text-sm text-muted-foreground">
              <RotateCcw className="h-4 w-4" />
              Report Product
            </div>
          </div>

          <div className="py-8">
            <h3 className="mb-4 text-lg font-bold">Product Details</h3>
            <p className="mb-6 text-muted-foreground leading-relaxed">
              {PRODUCT_DETAILS.description}
            </p>
            <div className="grid grid-cols-1 gap-y-2 text-sm sm:grid-cols-2 lg:w-2/3">
              {PRODUCT_DETAILS.details.map((detail, idx) => (
                <div key={idx} className="grid grid-cols-[150px_1fr]">
                  <span className="text-muted-foreground">{detail.label}</span>
                  <span className="font-medium">: {detail.value}</span>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Styling Ideas Section */}
        <div className="mt-8 rounded-xl bg-muted/30 p-6">
          <div className="mb-6 flex items-center justify-between">
            <h3 className="text-xl font-bold">Styling Ideas</h3>
            <Button variant="link">See more</Button>
          </div>
          <div className="grid grid-cols-1 gap-6 lg:grid-cols-[300px_1fr]">
            <div className="aspect-[3/4] overflow-hidden rounded-lg bg-white p-4 shadow-sm">
               <img
                  src={PRODUCT_DETAILS.images[0].src}
                  alt="Main Look"
                  className="h-full w-full object-contain"
                />
            </div>
            <div className="grid grid-cols-1 gap-4 sm:grid-cols-3">
              {STYLING_IDEAS.map((item, idx) => (
                <Card key={idx} className="overflow-hidden border-none shadow-sm">
                  <div className="flex h-full flex-col">
                    <div className="aspect-square bg-muted">
                      <img src={item.image} alt={item.name} className="h-full w-full object-cover" />
                    </div>
                    <div className="flex flex-1 flex-col p-3">
                      <h4 className="mb-1 text-sm font-medium line-clamp-2">{item.name}</h4>
                      <div className="mt-auto">
                        <div className="text-xs text-muted-foreground line-through">
                          {new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(item.price)}
                        </div>
                        <div className="flex items-center justify-between">
                          <div className="font-bold text-red-600">
                            {new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(item.sale)}
                          </div>
                          <Button size="sm" className="h-8 bg-black text-white hover:bg-gray-800">
                            Add to Bag
                          </Button>
                        </div>
                      </div>
                    </div>
                  </div>
                </Card>
              ))}
              <div className="flex flex-col justify-center items-center p-6 bg-white rounded-lg shadow-sm text-center">
                 <div className="text-lg font-bold mb-1">Total</div>
                 <div className="text-xl font-bold text-primary mb-2">Rp1.187.500</div>
                 <div className="text-sm text-green-600 mb-4">Save Rp407.500</div>
                 <Button className="w-full bg-black text-white">Add to Bag</Button>
              </div>
            </div>
          </div>
        </div>

        {/* Customer Reviews */}
        <div className="mt-12">
          <h3 className="mb-6 text-xl font-bold">Customer Reviews</h3>
          <div className="grid grid-cols-1 gap-12 lg:grid-cols-[300px_1fr]">
            <div>
              <div className="flex items-center gap-4">
                <div className="flex h-20 w-20 items-center justify-center rounded-full border-4 border-primary text-2xl font-bold">
                  4.8
                </div>
                <div>
                  <div className="flex text-yellow-400">
                    <Star className="fill-current" />
                    <Star className="fill-current" />
                    <Star className="fill-current" />
                    <Star className="fill-current" />
                    <Star className="fill-current" />
                  </div>
                  <div className="mt-1 font-medium">98% of buyers are satisfied</div>
                  <div className="text-sm text-muted-foreground">98 rating • 136 Reviews</div>
                </div>
              </div>
              <div className="mt-6 space-y-2">
                {[5, 4, 3, 2, 1].map((star) => (
                  <div key={star} className="flex items-center gap-2 text-sm">
                    <Star className="h-4 w-4 fill-yellow-400 text-yellow-400" />
                    <span className="w-3">{star}</span>
                    <Progress value={star === 5 ? 80 : star === 4 ? 15 : 2} className="h-2" />
                    <span className="w-8 text-right text-muted-foreground">
                      {star === 5 ? 136 : star === 4 ? 28 : 5}
                    </span>
                  </div>
                ))}
              </div>
              <div className="mt-6 flex flex-wrap gap-2">
                 {["All (136)", "With Photo (48)", "Fast Shipping (98)", "5 Stars (112)", "4 Stars (20)", "3 Stars (4)", "2 Stars (0)", "1 Star (0)", "Good Quality (82)"].map(tag => (
                    <Badge key={tag} variant="outline" className="font-normal cursor-pointer hover:bg-muted">{tag}</Badge>
                 ))}
              </div>
            </div>

            <div className="grid grid-cols-1 gap-6 md:grid-cols-2">
              {REVIEWS.map((review) => (
                <Card key={review.id} className="border-none shadow-sm bg-muted/20">
                  <CardContent className="p-6">
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex text-yellow-400">
                        {[...Array(5)].map((_, i) => (
                          <Star key={i} className={`h-4 w-4 ${i < review.rating ? "fill-current" : ""}`} />
                        ))}
                      </div>
                      <span className="text-xs text-muted-foreground">{review.date}</span>
                    </div>
                    <h4 className="font-bold mb-1">{review.author}</h4>
                    <div className="text-xs text-muted-foreground mb-3">{review.variant}</div>
                    <p className="text-sm text-muted-foreground leading-relaxed mb-4">
                      {review.content}
                    </p>
                    <div className="flex items-center gap-4 text-sm text-muted-foreground">
                      <button className="flex items-center gap-1 hover:text-foreground">
                        <ThumbsUp className="h-4 w-4" /> {review.likes}
                      </button>
                      <button className="flex items-center gap-1 hover:text-foreground">
                        <ThumbsDown className="h-4 w-4" /> {review.dislikes}
                      </button>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          </div>
          <div className="mt-8 text-center">
            <Button variant="outline">See All Reviews</Button>
          </div>
        </div>

        {/* Best Seller */}
        <div className="mt-16 mb-16">
          <div className="mb-6 flex items-center justify-between">
            <h3 className="text-xl font-bold">Best Seller</h3>
            <div className="flex gap-2">
               <Button variant="outline" size="icon"><ChevronLeft className="h-4 w-4" /></Button>
               <Button variant="default" size="icon" className="bg-black"><ArrowRight className="h-4 w-4" /></Button>
            </div>
          </div>
          <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4">
            {BEST_SELLERS.map((item, idx) => (
              <Card key={idx} className="overflow-hidden border-none shadow-sm bg-muted/20">
                <div className="relative aspect-square bg-white p-4">
                   <div className="absolute top-3 right-3 z-10">
                      <Button size="icon" variant="ghost" className="h-8 w-8 rounded-full bg-white/80 hover:bg-white">
                         <Heart className="h-4 w-4" />
                      </Button>
                   </div>
                   <img src={item.image} alt={item.name} className="h-full w-full object-contain mix-blend-multiply" />
                   {item.sale && (
                      <Badge className="absolute bottom-3 left-3 bg-orange-500 hover:bg-orange-600">
                         Flash Sale
                      </Badge>
                   )}
                </div>
                <CardContent className="p-4">
                  <h4 className="mb-2 text-sm font-medium line-clamp-2">{item.name}</h4>
                  <div className="flex items-center gap-1 mb-2">
                     <Star className="h-3 w-3 fill-orange-400 text-orange-400" />
                     <span className="text-xs font-medium">{item.rating}</span>
                     <span className="text-xs text-muted-foreground">• {item.sold} Sold</span>
                  </div>
                  <div className="flex items-center justify-between">
                     <div className="font-bold">
                        {new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(item.price)}
                     </div>
                     {item.sale && (
                        <div className="text-xs text-red-500 line-through">
                           {new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR" }).format(item.sale)}
                        </div>
                     )}
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

// --- Subcomponents (Copied & Adapted from ProductDetail6) ---

const ProductImages = ({ images, galleryID }: ProductImagesProps) => {
  const [api, setApi] = useState<CarouselApi>();
  const [current, setCurrent] = useState(0);
  const lightboxRef = useRef<PhotoSwipeLightbox | null>(null);

  useEffect(() => {
    const lightbox = new PhotoSwipeLightbox({
      gallery: "#" + galleryID,
      children: "a",
      bgOpacity: 1,
      wheelToZoom: true,
      arrowPrev: false,
      arrowNext: false,
      close: false,
      zoom: false,
      counter: false,
      mainClass: "[&>div:first-child]:!bg-background",
      pswpModule: () => import("photoswipe"),
    });
    lightbox.init();
    lightboxRef.current = lightbox;

    // ... (Keep existing lightbox UI logic if needed, simplified for now) ...

    return () => lightbox.destroy();
  }, [galleryID]);

  useEffect(() => {
    if (!api) return;
    const updateCurrent = () => setCurrent(api.selectedScrollSnap());
    updateCurrent();
    api.on("select", updateCurrent);
    return () => {
      api.off("select", updateCurrent);
    };
  }, [api]);

  if (!images) return null;

  return (
    <div className="flex flex-col-reverse gap-4 lg:flex-row">
      {/* Thumbnails (Left on Desktop) */}
      <div className="hidden w-24 flex-col gap-4 lg:flex">
        {images.map((img, index) => (
          <div
            key={index}
            className={cn(
              "cursor-pointer overflow-hidden rounded-lg border-2 transition-all",
              current === index ? "border-primary" : "border-transparent hover:border-muted-foreground/25"
            )}
            onClick={() => api?.scrollTo(index)}
          >
            <AspectRatio ratio={1}>
              <img
                src={img.src}
                alt={img.alt}
                className="h-full w-full object-cover"
              />
            </AspectRatio>
          </div>
        ))}
      </div>

      {/* Main Image */}
      <div className="flex-1 overflow-hidden rounded-2xl bg-muted" id={galleryID}>
        <Carousel setApi={setApi} className="w-full">
          <CarouselContent>
            {images.map((img, index) => (
              <CarouselItem key={index}>
                <AspectRatio ratio={1} className="flex items-center justify-center bg-gray-50">
                  <a
                    href={img.src}
                    data-pswp-width={img.width}
                    data-pswp-height={img.height}
                    target="_blank"
                    rel="noreferrer"
                  >
                    <img
                      src={img.src}
                      alt={img.alt}
                      className="max-h-full max-w-full object-contain"
                    />
                  </a>
                </AspectRatio>
              </CarouselItem>
            ))}
          </CarouselContent>
          <div className="absolute bottom-4 right-4 flex gap-2 lg:hidden">
             <Button size="icon" variant="secondary" onClick={() => api?.scrollPrev()}><ChevronLeft className="h-4 w-4" /></Button>
             <Button size="icon" variant="secondary" onClick={() => api?.scrollNext()}><ChevronRight className="h-4 w-4" /></Button>
          </div>
        </Carousel>
      </div>
    </div>
  );
};

const Price = ({ regular, sale, currency, size = "default" }: PriceProps) => {
  if (!regular || !currency) return null;

  const formatCurrency = (value: number) => {
    return new Intl.NumberFormat("id-ID", {
      style: "currency",
      currency,
      minimumFractionDigits: 0,
    }).format(value);
  };

  return (
    <div className="flex items-baseline gap-2">
      {sale ? (
        <>
          <span className={cn("font-bold text-primary", size === "lg" ? "text-3xl" : "text-lg")}>
            {formatCurrency(sale)}
          </span>
          <span className="text-sm text-muted-foreground line-through">
            {formatCurrency(regular)}
          </span>
        </>
      ) : (
        <span className={cn("font-bold text-primary", size === "lg" ? "text-3xl" : "text-lg")}>
          {formatCurrency(regular)}
        </span>
      )}
    </div>
  );
};

const ProductForm = ({
  hinges,
  form,
  onSubmit,
  stockInfo,
  selectedSize,
}: ProductFormProps) => {
  const sizeHinges = hinges?.size;
  const quantityHinges = hinges?.quantity;

  return (
    <FormProvider {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="flex flex-col gap-6">
        {sizeHinges && (
          <FormField
            control={form.control}
            name={sizeHinges.name}
            render={({ field }) => (
              <FormItem>
                <div className="mb-3 flex items-center justify-between">
                  <FormLabel className="text-sm font-medium">
                    Select Size <span className="ml-2 text-muted-foreground">Size Guide</span>
                  </FormLabel>
                </div>
                <FormControl>
                  <SizeRadioGroup field={field} options={sizeHinges.options} />
                </FormControl>
              </FormItem>
            )}
          />
        )}

        <div className="flex flex-col gap-4">
          <Button className="w-full bg-slate-900 text-white hover:bg-slate-800" size="lg">
            Buy this Now
          </Button>
          <Button variant="outline" className="w-full" size="lg">
            Add to Bag
          </Button>
        </div>
      </form>
    </FormProvider>
  );
};

const SizeRadioGroup = ({ options, field }: SizeRadioGroupProps) => {
  if (!options) return null;

  return (
    <RadioGroup
      {...field}
      value={`${field.value}`}
      onValueChange={field.onChange}
      className="flex flex-wrap gap-3"
    >
      {options.map((item) => (
        <FormItem key={item.id}>
          <FormLabel className="cursor-pointer">
            <RadioGroupItem
              value={item.value}
              id={item.id}
              className="peer sr-only"
              disabled={item.stockInfo.stockStatusCode === "OUT_OF_STOCK"}
            />
            <div className="flex h-10 min-w-[3rem] items-center justify-center rounded-md border bg-background px-3 text-sm font-medium transition-all hover:border-primary peer-data-[state=checked]:border-primary peer-data-[state=checked]:bg-primary peer-data-[state=checked]:text-primary-foreground peer-disabled:cursor-not-allowed peer-disabled:opacity-50">
              {item.label}
            </div>
          </FormLabel>
        </FormItem>
      ))}
    </RadioGroup>
  );
};
