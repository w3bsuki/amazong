# I18N.md — Internationalization Reference

> **SSOT for Treido's i18n setup.** Covers locales, messages, routing, and formatting.

| Scope | Internationalization system |
|-------|----------------------------|
| Audience | AI agents, developers |
| Type | Reference |

---

## Quick Reference

| Setting | Value |
|---------|-------|
| Library | `next-intl` 4.x |
| Locales | `en` (English), `bg` (Bulgarian) |
| Default | `en` |
| URL Pattern | Always prefixed: `/en/*`, `/bg/*` |
| Currency | EUR (€) for all locales |
| Timezone | `Europe/Sofia` |
| Message Files | `messages/en.json`, `messages/bg.json` |
| Total Namespaces | 97 |

---

## Core Configuration Files

| File | Purpose |
|------|---------|
| `i18n/routing.ts` | Locale routing config, navigation APIs (`Link`, `redirect`, `useRouter`, `usePathname`) |
| `i18n/request.ts` | Server-side config: message loading, formats, timezone, error handling |
| `proxy.ts` | Middleware: locale detection, routing, geo-detection |
| `next.config.ts` | Plugin setup via `createNextIntlPlugin()` |

---

## Type Definitions

From `i18n/routing.ts`:

```typescript
export type Locale = 'en' | 'bg'
export const locales: readonly Locale[] = ['en', 'bg'] as const

// Validation helpers
export function isValidLocale(locale: string): locale is Locale
export function validateLocale(locale: string): Locale  // Falls back to 'en'
```

---

## Routing Configuration

From `i18n/routing.ts`:

| Option | Value | Description |
|--------|-------|-------------|
| `locales` | `['en', 'bg']` | Supported languages |
| `defaultLocale` | `'en'` | Fallback locale |
| `localePrefix` | `'always'` | URLs always include locale segment |
| `localeDetection` | `true` | Auto-detect from Accept-Language + cookie |
| `localeCookie.name` | `'NEXT_LOCALE'` | Cookie storing preference |
| `localeCookie.maxAge` | 1 year | Cookie TTL |

---

## Message Namespaces (97 total)

### Authentication & Account
`Account`, `AccountDrawer`, `AccountPlansUpgrade`, `Auth`, `NavUser`

### Commerce & Shopping
`Cart`, `CartDropdown`, `CartPage`, `Categories`, `CategoryNotFound`, `CheckoutFooter`, `CheckoutHeader`, `CheckoutPage`, `CheckoutSuccess`, `CheckoutSuccessPage`, `Product`, `ProductFeed`, `ProductForm`, `ProductModal`, `ProductNotFound`, `ProductSocialProof`

### Search & Filtering
`FilterHub`, `FilterSidebar`, `QuickFilters`, `SaveSearch`, `SearchCategories`, `SearchFilters`, `SearchOverlay`

### Seller & Business
`Sell`, `Seller`, `SellerVerification`, `SellersDirectory`, `SellingDropdown`, `SellingProducts`, `seller`

### Navigation & Layout
`Breadcrumbs`, `Categories`, `Drawers`, `Footer`, `Header`, `HeroSearch`, `Home`, `LocaleSwitcher`, `LocationDropdown`, `MobileMenu`, `Navigation`, `Sidebar`, `SidebarMenuV2`

### User Features
`Messages`, `MessagesDropdown`, `NotificationsDropdown`, `Plans`, `ProfileError`, `ProfileNotFound`, `ProfilePage`, `Reviews`, `SharedWishlist`, `Wishlist`, `WishlistDropdown`

### Legal & Support
`About`, `AccessibilityPage`, `CareersPage`, `ComingSoon`, `Contact`, `Cookies`, `CustomerService`, `FAQPage`, `Feedback`, `Privacy`, `Returns`, `ReturnsDropdown`, `Security`, `Terms`

### Promotions & Features
`Boost`, `GiftCards`, `RegistryPage`, `TodaysDeals`

### Common & Utilities
`Common`, `Errors`, `Freshness`, `GlobalError`, `GlobalNotFound`, `NotFound`, `ViewMode`

### Admin (Internal)
`AdminDashboard`, `AdminDocs`, `AdminHeader`, `AdminNav`, `AdminNotes`, `AdminOrders`, `AdminProducts`, `AdminSellers`, `AdminTasks`, `AdminUsers`

### Demo & Experimental
`Assistant`, `BusinessCommandPalette`, `Charts`, `DemoCodex`, `DemoSell6`, `GeoWelcome`, `TabbedProductFeed`

### Static Pages
`AdvertisePage`, `AffiliatesPage`, `BlogPage`, `FreeShippingPage`, `InvestorsPage`, `MembersPage`, `StoreLocatorPage`, `SuppliersPage`

---

## Usage Patterns

### Client Components

```typescript
'use client'
import { useTranslations, useLocale } from 'next-intl'

function MyComponent() {
  const t = useTranslations('Product')  // Single namespace
  const locale = useLocale()            // 'en' | 'bg'
  
  return <h1>{t('title')}</h1>
}
```

### Server Components

```typescript
import { getTranslations, setRequestLocale } from 'next-intl/server'

export default async function Page({
  params
}: {
  params: Promise<{ locale: string }>
}) {
  const { locale } = await params
  
  // CRITICAL: Enable static rendering
  setRequestLocale(locale)
  
  const t = await getTranslations('Product')
  return <h1>{t('title')}</h1>
}
```

### Locale-Aware Navigation

```typescript
import { Link, redirect, usePathname, useRouter } from '@/i18n/routing'

// Auto-includes current locale
<Link href="/products">Products</Link>

// Switch locale explicitly
<Link href="/products" locale="bg">Продукти</Link>

// Programmatic navigation
const router = useRouter()
router.push('/products')
router.push('/products', { locale: 'bg' })
```

---

## ICU Message Syntax

### Interpolation

```json
{ "greeting": "Hello {name}!" }
```
```typescript
t('greeting', { name: 'Ivan' })  // "Hello Ivan!"
```

### Pluralization

```json
{ "items": "{count, plural, =0 {No items} =1 {1 item} other {# items}}" }
```
```typescript
t('items', { count: 5 })  // "5 items"
```

### Select (Enum)

```json
{ "status": "{status, select, pending {Pending} shipped {Shipped} other {Unknown}}" }
```
```typescript
t('status', { status: 'shipped' })  // "Shipped"
```

---

## Global Formats (from request.ts)

### Date/Time Formats

| Format | Pattern | Example |
|--------|---------|---------|
| `short` | day, month short, year | Dec 27, 2025 |
| `long` | weekday, day, month, year | Friday, December 27, 2025 |
| `delivery` | day, month short | Dec 27 |
| `order` | day, month, year, time | Dec 27, 2025, 10:30 AM |

### Number Formats

| Format | Style | Example |
|--------|-------|---------|
| `currency` | EUR, 2 decimals | €29.99 |
| `precise` | 1 decimal max | 4.5 |
| `percent` | percentage | 25% |
| `integer` | no decimals | 100 |

### List Formats

| Format | Type | Example |
|--------|------|---------|
| `enumeration` | conjunction | "A, B, and C" |
| `options` | disjunction | "A, B, or C" |

---

## Currency & Price Formatting

### Utilities in `lib/currency.ts`

```typescript
import { formatPrice, formatPriceParts, getCurrencySymbol } from '@/lib/currency'

formatPrice(29.99, 'en')       // "€29.99"
formatPrice(29.99, 'bg')       // "29,99 €"
getCurrencySymbol('en')        // "€"
```

### Utilities in `lib/format-price.ts`

```typescript
import { formatPrice, formatPriceRange, formatDiscount } from '@/lib/format-price'

formatPrice(29.99, { locale: 'en' })                 // "€29.99"
formatPriceRange(10, 20, 'bg')                       // "10,00 € - 20,00 €"
formatDiscount(80, 100, 'en').percentage             // 20
```

---

## Provider Architecture

Provider chain in `app/[locale]/locale-providers.tsx`:

```
NextIntlClientProvider (locale, messages, timezone)
  └── ThemeProvider
      └── AuthStateManager
          └── CurrencyProvider
              └── CartProvider
                  └── WishlistProvider
                      └── DrawerProvider
                          └── MessageProvider
                              └── {children}
```

---

## Route Structure

```
app/
└── [locale]/
    ├── layout.tsx              # Validates locale, sets <html lang>
    ├── locale-providers.tsx    # Server: setRequestLocale, getMessages
    ├── intl-client-provider.tsx # Client: NextIntlClientProvider wrapper
    ├── (main)/                 # E-commerce pages
    ├── (account)/              # Account pages with sidebar
    ├── (auth)/                 # Auth flows
    ├── (checkout)/             # Checkout process
    ├── (sell)/                 # Seller management
    ├── (admin)/                # Admin dashboard
    └── [username]/             # Public profiles
```

---

## Language Switcher

Location: `components/shared/locale-switcher.tsx`

Uses `useLocale()` hook and renders locale-prefixed `Link` for switching.

---

## Test Coverage

| Test File | Coverage |
|-----------|----------|
| `__tests__/i18n-messages-parity.test.ts` | Key parity between en.json and bg.json |
| `__tests__/currency.test.ts` | `formatPrice`, `formatPriceParts` |
| `__tests__/format-price.test.ts` | Price formatting functions |
| `__tests__/stripe-locale.test.ts` | Locale URL building |

---

## Common Patterns

### ✅ DO

```typescript
// Always call setRequestLocale in server components
setRequestLocale(locale)

// Use routing.ts navigation for locale-aware links
import { Link } from '@/i18n/routing'

// Use namespace scoping
const t = useTranslations('Product')
t('title')  // Not t('Product.title')

// Handle missing translations gracefully
t.has('optionalKey') && t('optionalKey')
```

### ❌ DON'T

```typescript
// Don't use next/link directly - loses locale
import Link from 'next/link'  // Wrong!

// Don't hardcode locale in URLs
<a href="/en/products">  // Wrong!

// Don't forget setRequestLocale - breaks static rendering
export default async function Page() {
  // Missing setRequestLocale(locale)!
}

// Don't access messages directly - use t()
messages.Product.title  // Wrong!
```

---

## Error Handling

From `i18n/request.ts`:

- **Missing translation**: Logs warning, returns `[Namespace.key]`
- **Other errors**: Logs error, returns `⚠️ Namespace.key`

---

## Adding New Translations

1. Add key to both `messages/en.json` and `messages/bg.json`
2. Use existing namespace or create new one (grouped by domain)
3. Run parity test: `pnpm test __tests__/i18n-messages-parity.test.ts`
4. Use ICU syntax for dynamic content

---

## See Also

- [ARCHITECTURE.md](./ARCHITECTURE.md) — Module boundaries
- [ROUTES.md](./ROUTES.md) — Route structure with `[locale]`
- [next-intl docs](https://next-intl.dev/docs) — Library documentation

---

*Last updated: 2026-02-01*

