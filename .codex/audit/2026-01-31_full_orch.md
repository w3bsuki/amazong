## TW4

### Scope
- Files:
  - app/globals.css
  - components/shared/wishlist/wishlist-drawer.tsx
  - components/mobile/drawers/cart-drawer.tsx
  - components/layout/header/mobile/product-header.tsx
  - components/shared/wishlist/mobile-wishlist-button.tsx
  - components/desktop/filters-sidebar.tsx
- Lines: n/a

### Findings
| ID | Severity | File:Line | Issue | Fix |
|----|----------|-----------|-------|-----|
| TW4-001 | High | components/shared/wishlist/wishlist-drawer.tsx:62 | Arbitrary value class `max-h-(--wishlist-drawer-max-h-*)` bypasses token rails; same pattern appears in components/mobile/drawers/cart-drawer.tsx:51. | Replace with tokenized height classes (e.g., `max-h-dialog` / `max-h-dialog-sm`) and keep conditionals only between token classes. |
| TW4-002 | Medium | components/shared/wishlist/wishlist-drawer.tsx:157 | Opacity hack `hover:bg-destructive/10` on a drawer action button violates token rules. | Use `hover:bg-hover` or `hover:bg-active` with `text-destructive`, or swap to an existing semantic destructive-subtle token. |
| TW4-003 | Medium | components/layout/header/mobile/product-header.tsx:154 | Wishlist buttons use non-token touch sizes (`size-11` here; `size-10` in components/shared/wishlist/mobile-wishlist-button.tsx:38), bypassing touch-size tokens. | Replace with `size-touch` (or `size-touch-lg`) and keep icon sizing via `size-icon-header`. |
| TW4-004 | Medium | components/layout/header/mobile/product-header.tsx:157 | Opacity hack `hover:bg-wishlist-active/10` for wishlist state. | Swap to `hover:bg-hover` or `bg-selected` for active state; keep `text-wishlist-active`. |
| TW4-005 | Medium | components/desktop/filters-sidebar.tsx:68 | Homepage filter sidebar uses non-token heights (`h-9` here; `min-h-9` at :93; `h-9` at :105). | Use `h-touch-sm` / `min-h-touch-sm` and tokenized spacing utilities. |

### Acceptance Checks
- [ ] `pnpm -s styles:gate`
- [ ] `node .codex/skills/spec-tailwind/scripts/scan.mjs`

### Risks
- Replacing drawer max-height logic with token classes can change drawer scroll/overflow behavior for empty vs long lists; needs UI QA.
- Opacity-based token usage is widespread in the repo (many `bg-*/xx` patterns), so fixing only these spots may leave additional rail violations.

## SHADCN

### Scope
- Files:
  - components/ui/dialog.tsx
  - components/shared/modal.tsx
  - app/[locale]/(account)/@modal/(.)account/plans/upgrade/page.tsx
  - components/shared/filters/filter-modal.tsx
  - components/shared/wishlist/wishlist-drawer.tsx
  - components/desktop/desktop-filter-modal.tsx
- Lines: n/a

### Findings
| ID | Severity | File:Line | Issue | Fix |
|----|----------|-----------|-------|-----|
| SHADCN-001 | High | components/ui/dialog.tsx:23 | Dialog wrapper forces `modal={false}` for all dialogs, disabling Radix modal semantics (focus trap/aria-hidden). This makes every “modal” effectively non‑modal. | Allow `modal` to pass through (default `true`), or create a separate non‑modal wrapper for the sticky-header use case. |
| SHADCN-002 | Medium | components/shared/modal.tsx:6; app/[locale]/(account)/@modal/(.)account/plans/upgrade/page.tsx:84 | `Modal` allows missing title/description; `UpgradeLoadingFallback` renders `<Modal>` without either, producing an unnamed dialog (a11y). | Require a title (or inject sr‑only fallback), or set `aria-label` on `DialogContent` when title/description are absent. |

### Acceptance Checks
- [ ] Manual: open a dialog (e.g., filter modal) and verify focus is trapped and the dialog is announced with a title.
- [ ] Manual: open the upgrade loading modal and confirm it has an accessible name.

### Risks
- Restoring `modal={true}` may reintroduce the sticky‑header scroll lock issue; may need a targeted non‑modal variant.

## NEXTJS

### Scope
- Files:
  - app/[locale]/[username]/[productSlug]/page.tsx
  - lib/data/products.ts
  - app/[locale]/(main)/page.tsx
- Lines: n/a

### Findings
| ID | Severity | File:Line | Issue | Fix |
|----|----------|-----------|-------|-----|
| NEXTJS-001 | Medium | app/[locale]/[username]/[productSlug]/page.tsx:143 | `connection()` opts this page into dynamic rendering, which defeats the stated ISR/static intent (`generateStaticParams` + ISR comments) and can bypass page-level caching benefits. | Remove `connection()` unless truly required; if you only need time-based logic, move it into cached functions with `cacheLife` or use short revalidation. |
| NEXTJS-002 | Low | lib/data/products.ts:731 | `getBoostedProducts` calls `connection()`, which forces any caller (e.g. home page at app/[locale]/(main)/page.tsx:57) into dynamic rendering and undermines full-page caching. | If homepage should be cacheable/ISR, avoid `connection()` here; use a short cache TTL or filter expiration inside a cached function with controlled revalidation. |

### Acceptance Checks
- [ ] pnpm -s typecheck
- [ ] pnpm -s lint

### Risks
- Removing `connection()` may surface stale boosted-product visibility until cache revalidation; align TTL with business expectations.

## SUPABASE

### Scope
- Files:
  - lib/supabase/server.ts
  - lib/supabase/client.ts
  - lib/supabase/middleware.ts
  - app/actions/username.ts
  - app/actions/profile.ts
  - app/actions/boosts.ts
  - app/api/**/route.ts (spot-checked route handlers using createRouteHandlerClient)
- Lines: n/a
- MCP checks: public tables RLS/policies; advisors (security/perf); information_schema column check.

### Findings
| ID | Severity | File:Line | Issue | Fix |
|----|----------|-----------|-------|-----|
| SUPABASE-001 | Medium | app/actions/username.ts:608 | `getCurrentUserProfile()` selects `vat_number` from `profiles`, but MCP info_schema shows `vat_number` exists only on `private_profiles`. This will raise a column error and make the profile fetch fail. | Remove `vat_number` from the `profiles` select and fetch it from `private_profiles` (join or parallel query), or move it to the correct table if intended. |

### Acceptance Checks
- [ ] `pnpm -s typecheck`

### Risks
- Supabase security advisor reports leaked password protection disabled (Auth config hardening).
- Supabase performance advisor reports multiple unused indexes; consider removing if confirmed unused in prod workloads.
- RLS/policy review is limited to MCP metadata; no deep policy logic audit performed.
