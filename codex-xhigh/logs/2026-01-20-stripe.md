# Stripe Log — 2026-01-20

## Goal
- Complete Phase 2 Stripe items (webhooks + Connect onboarding + `/sell` gating) and Phase 3 monetization items (DB-driven buyer protection fees in checkout + plans).

## Tasks Done
- ✅ `P2-STRIPE-01`: Canonical webhook ownership + dedupe (orders vs boosts vs subscriptions vs Connect); strengthened boost idempotency.
- ✅ `P2-STRIPE-02`: Connect onboarding supports individual vs business correctly (Express `business_type`) and uses locale-safe return/refresh URLs.
- ✅ `P2-STRIPE-03`: Gated `/sell` until payout setup is ready; added i18n strings.
- ✅ `P3-MON-02`: Fee calculation reads `subscription_plans` config (no hardcoded fee defaults).
- ✅ `P3-MON-03`: Checkout UI shows buyer protection fee and totals include it; Stripe line item localized.
- ✅ `P3-MON-04`: Plans UI reads buyer protection + seller fee from DB fields (no hardcoded fallback values).

## Files Changed
- `app/api/checkout/webhook/route.ts`
- `app/api/payments/webhook/route.ts`
- `app/api/subscriptions/webhook/route.ts`
- `app/api/connect/webhook/route.ts`
- `app/api/connect/onboarding/route.ts`
- `app/api/payments/setup/route.ts`
- `app/[locale]/(checkout)/_actions/checkout.ts`
- `app/[locale]/(checkout)/_components/checkout-page-client.tsx`
- `app/[locale]/(sell)/sell/page.tsx`
- `app/[locale]/(sell)/sell/client.tsx`
- `app/[locale]/(plans)/_components/plans-page-client.tsx`
- `lib/stripe-connect.ts`
- `messages/en.json`
- `messages/bg.json`

## Commands Run
- `pnpm -s exec tsc -p tsconfig.json --noEmit` → ✅ pass
- `REUSE_EXISTING_SERVER=true pnpm test:e2e:smoke` → ✅ 16 passed

## Safety Cleanup
- Removed building absolute redirect URLs from request `Origin` header; now uses `lib/stripe-locale.ts`.

## Blockers
- None

