"use client";

import { useState, useEffect, useRef } from "react";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import { Switch } from "@/components/ui/switch";
import { Separator } from "@/components/ui/separator";
import { ScrollArea } from "@/components/ui/scroll-area";
import { cn } from "@/lib/utils";
import { 
  Check, Copy, Sun, Moon, Star, Heart, ShoppingCart, 
  Truck, Shield, Package, Clock, AlertCircle, CheckCircle,
  Info, X, ChevronRight, ArrowRight, Flame, Zap, Eye,
  Home, Palette, Type, Square, MousePointer, LayoutGrid, Layers, Box, Menu,
} from "lucide-react";

const NAV_SECTIONS = [
  { id: "overview", label: "Overview", icon: Home },
  { id: "colors", label: "Colors", icon: Palette },
  { id: "typography", label: "Typography", icon: Type },
  { id: "surfaces", label: "Surfaces", icon: Layers },
  { id: "buttons", label: "Buttons", icon: MousePointer },
  { id: "badges", label: "Badges", icon: Square },
  { id: "forms", label: "Forms", icon: LayoutGrid },
  { id: "cards", label: "Cards", icon: Box },
  { id: "spacing", label: "Spacing", icon: LayoutGrid },
  { id: "marketplace", label: "Marketplace", icon: ShoppingCart },
] as const;

function useCopyToClipboard() {
  const [copiedValue, setCopiedValue] = useState<string | null>(null);
  const copy = (text: string) => {
    navigator.clipboard.writeText(text);
    setCopiedValue(text);
    setTimeout(() => setCopiedValue(null), 2000);
  };
  return { copiedValue, copy };
}

function CopyButton({ value, className }: { value: string; className?: string }) {
  const { copiedValue, copy } = useCopyToClipboard();
  return (
    <button
      onClick={() => copy(value)}
      className={cn("inline-flex items-center justify-center rounded-md p-1.5 text-muted-foreground hover:bg-muted hover:text-foreground", className)}
      title={copiedValue === value ? "Copied!" : "Copy"}
    >
      {copiedValue === value ? <Check className="size-3.5 text-success" /> : <Copy className="size-3.5" />}
    </button>
  );
}

function CodeBlock({ code }: { code: string }) {
  return (
    <div className="group relative">
      <pre className="overflow-x-auto rounded-lg border bg-muted/50 p-4 text-sm"><code className="font-mono text-foreground">{code}</code></pre>
      <CopyButton value={code} className="absolute right-2 top-2 opacity-0 group-hover:opacity-100" />
    </div>
  );
}

function TokenSwatch({ name, value, cssVar }: { name: string; value: string; cssVar: string }) {
  return (
    <div className="group flex items-center gap-3 rounded-lg border bg-card p-3 hover:bg-muted/50">
      <div className="size-12 shrink-0 rounded-md border shadow-sm" style={{ backgroundColor: ar() }} />
      <div className="min-w-0 flex-1">
        <p className="font-medium">{name}</p>
        <p className="truncate font-mono text-xs text-muted-foreground">{value}</p>
      </div>
      <CopyButton value={cssVar} className="opacity-0 group-hover:opacity-100" />
    </div>
  );
}

export default function DesignSystemPage() {
  const [activeSection, setActiveSection] = useState("overview");
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const observerRef = useRef<IntersectionObserver | null>(null);

  useEffect(() => {
    observerRef.current = new IntersectionObserver((entries) => {
      entries.forEach((entry) => { if (entry.isIntersecting) setActiveSection(entry.target.id); });
    }, { rootMargin: "-100px 0px -66% 0px" });
    NAV_SECTIONS.forEach(({ id }) => { const el = document.getElementById(id); if (el) observerRef.current?.observe(el); });
    return () => observerRef.current?.disconnect();
  }, []);

  return (
    <div className="flex min-h-screen">
      <aside className={cn("fixed inset-y-0 left-0 z-50 w-64 border-r bg-card transition-transform lg:sticky lg:top-0 lg:h-screen lg:translate-x-0", sidebarOpen ? "translate-x-0" : "-translate-x-full")}>
        <div className="flex h-full flex-col">
          <div className="flex h-16 items-center gap-3 border-b px-4">
            <div className="flex size-8 items-center justify-center rounded-md bg-primary text-primary-foreground"><Palette className="size-4" /></div>
            <div><h1 className="font-semibold">Treido Design</h1><p className="text-xs text-muted-foreground">v2.0 • Tailwind v4</p></div>
          </div>
          <ScrollArea className="flex-1 p-4">
            <nav className="space-y-1">
              {NAV_SECTIONS.map(({ id, label, icon: Icon }) => (
                <a key={id} href={`+"#"+id} onClick={() => { setActiveSection(id); setSidebarOpen(false); }}
                   className={cn("flex items-center gap-3 rounded-md px-3 py-2 text-sm", activeSection === id ? "bg-primary/10 font-medium text-primary" : "text-muted-foreground hover:bg-muted hover:text-foreground")}>
                  <Icon className="size-4" />{label}
                </a>
              ))}
            </nav>
            <Separator className="my-4" />
            <Link href="/" className="flex items-center gap-2 rounded-md px-3 py-2 text-sm text-muted-foreground hover:bg-muted"><Home className="size-4" />Back to Site</Link>
          </ScrollArea>
          <div className="border-t p-4"><div className="rounded-lg bg-muted/50 p-3 text-center"><p className="text-xs text-muted-foreground">shadcn/ui • oklch</p></div></div>
        </div>
      </aside>
      <button onClick={() => setSidebarOpen(!sidebarOpen)} className="fixed left-4 top-4 z-50 rounded-md border bg-card p-2 shadow-sm lg:hidden">{sidebarOpen ? <X className="size-5" /> : <Menu className="size-5" />}</button>
      {sidebarOpen && <div className="fixed inset-0 z-40 bg-black/50 lg:hidden" onClick={() => setSidebarOpen(false)} />}
      <main className="flex-1"><div className="mx-auto max-w-4xl px-6 py-12 lg:px-12">
        <OverviewSection /><ColorsSection /><TypographySection /><SurfacesSection /><ButtonsSection /><BadgesSection /><FormsSection /><CardsSection /><SpacingSection /><MarketplaceSection />
        <footer className="mt-24 border-t pt-8 text-center"><p className="text-sm text-muted-foreground">Treido Design System • shadcn/ui • Tailwind v4</p></footer>
      </div></main>
    </div>
  );
}
