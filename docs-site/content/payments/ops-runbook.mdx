# Payments Ops Runbook

This is the day-to-day and incident playbook for keeping Treido payments reliable.

## Principles (non-negotiable)

- Stripe webhooks are the **source of truth**.
- Webhook handlers must be **idempotent**.
- Never log secrets (signatures, full request bodies, PII).

## Daily checks (launch period)

- Webhook health: no backlog / no signature failures
- Payment failures: spikes by payment method / issuer
- Refund queue: pending refunds and reasons
- Chargebacks: new disputes and response deadlines
- Connect: onboarding completion rate, payout failures

## Incident types & response

### 1) Webhook lag / downtime

Symptoms:

- orders stuck in an old state (paid but not updated)
- refunds initiated in Stripe but not reflected in app

Actions:

1. Confirm Stripe is sending events (Stripe dashboard).
2. Check if signature verification is failing (key mismatch, env issues).
3. Pause risky automation (payout releases) until state is consistent.
4. Replay safely: use stored event ids to avoid duplicates.
5. After recovery: backfill missing state transitions.

### 2) “Payment succeeded but order not updated”

Actions:

- Verify webhook event received and processed.
- If missing: reconcile by querying Stripe for the PaymentIntent and updating order state server-side.
- If duplicate/out-of-order: ensure idempotency keys are enforced.

### 3) Transfer / payout failures

Actions:

- Confirm seller Connect status (charges/payouts enabled).
- Confirm transfer destination is correct.
- If failure: keep order in “payout pending”, notify support, and retry once fixed.

### 4) Refund mismatch

Actions:

- Treat Stripe as canonical; update DB state to match Stripe.
- Verify inventory/restock effects (if applicable) are correct.
- Communicate outcome to buyer and seller.

### 5) Chargeback received

Actions:

- Capture evidence bundle (order timeline, tracking, chat excerpt, photos).
- Respond before deadline; keep an internal log of outcome.
- If patterns repeat: adjust policies and risk controls (limits, verification, UX).

## Post-incident

- Write a short postmortem (what happened, impact, fixes, prevention).
- Add follow-up tasks in `/admin/tasks`.

