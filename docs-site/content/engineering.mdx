# ARCHITECTURE.md — System Architecture

> Technical architecture reference. Module boundaries, data flow, caching patterns.

| Scope | Technical system design |
|-------|------------------------|
| Audience | AI agents, developers |
| Type | Concept |

---

## Quick Reference

| Layer | Technology |
|-------|------------|
| Framework | Next.js 16 (App Router) + React 19 + TypeScript |
| Styling | Tailwind CSS v4 + shadcn/ui (Radix) + lucide-react |
| i18n | next-intl |
| Database | Supabase (Postgres + RLS) |
| Auth | Supabase Auth via `@supabase/ssr` |
| Storage | Supabase Storage |
| Payments | Stripe + Stripe Connect |
| Testing | Vitest (unit) + Playwright (E2E) |

---

## 1. Directory Structure

| Directory | Purpose |
|-----------|---------|
| `app/[locale]/` | Locale-scoped routes (en/bg) |
| `app/actions/` | Shared server actions |
| `app/api/` | Route handlers (webhooks, REST) |
| `components/ui/` | shadcn primitives only — DO NOT EDIT |
| `components/shared/` | Shared composites (cards, fields, filters) |
| `components/layout/` | Header, footer, sidebars, shells |
| `components/providers/` | Context providers |
| `components/mobile/` | Mobile-specific components |
| `components/desktop/` | Desktop-specific components |
| `hooks/` | Reusable React hooks |
| `lib/` | Pure utilities, clients, domain helpers |
| `i18n/` | next-intl routing config |
| `messages/` | Translation files (en.json, bg.json) |

---

## 2. Route Groups

All routes live under `app/[locale]/`. Route groups share layouts.

| Group | Layout | Purpose |
|-------|--------|---------|
| `(main)` | Full nav + footer | Homepage, search, categories, cart |
| `(account)` | Account sidebar | Settings, orders, profile |
| `(auth)` | Minimal chrome | Login, signup, password flows |
| `(sell)` | Seller nav | Create listing flow |
| `(checkout)` | Minimal | Payment flow |
| `(business)` | Business dashboard | B2B features |
| `(chat)` | Messaging | Buyer/seller conversations |
| `(plans)` | Plans/pricing | Subscription selection |
| `(admin)` | Admin panel | Site administration |
| `[username]/` | Public profiles | Seller pages + product detail |

### Route-Private Conventions

Keep route-specific code private:

| Convention | Purpose |
|------------|---------|
| `_components/` | Route-specific components |
| `_actions/` | Route-specific server actions |
| `_lib/` | Route-specific utilities |
| `_providers/` | Route-specific context |

**Rule:** Never import across route groups.

---

## 3. Module Reference (`lib/`)

| Module | Purpose |
|--------|---------|
| `lib/supabase/` | Supabase clients (server, client, admin, static) |
| `lib/data/` | Cached data fetchers (products, categories, plans) |
| `lib/auth/` | Auth utilities (`requireAuth`, admin/business checks) |
| `lib/ai/` | AI model config, schemas, tools |
| `lib/api/` | Response helpers |
| `lib/badges/` | Category badge specifications |
| `lib/boost/` | Boost status utilities |
| `lib/filters/` | Search filter utilities |
| `lib/sell/` | Listing schema v4 |
| `lib/types/` | TypeScript types |
| `lib/upload/` | Image upload utilities |
| `lib/validation/` | Zod schemas for orders |
| `lib/validations/` | Auth validations |
| `lib/view-models/` | View model transformations |
| `lib/stripe.ts` | Server-side Stripe instance |
| `lib/stripe-connect.ts` | Stripe Connect utilities |
| `lib/currency.ts` | Currency utilities |
| `lib/shipping.ts` | Shipping region filters |
| `lib/logger.ts` | Logging |
| `lib/env.ts` | Environment variable access |
| `lib/feature-flags.ts` | Feature flag system |

---

## 4. Supabase Clients

| Client | Use Case | File |
|--------|----------|------|
| `createClient()` | Server Components / Actions | `lib/supabase/server.ts` |
| `createStaticClient()` | Cached/public reads (no cookies) | `lib/supabase/server.ts` |
| `createRouteHandlerClient()` | API route handlers | `lib/supabase/server.ts` |
| `createAdminClient()` | Bypass RLS (webhooks, admin) | `lib/supabase/server.ts` |
| `createBrowserClient()` | Client Components | `lib/supabase/client.ts` |

### Selection Rules

- **Cached reads:** Use `createStaticClient()` — safe for `'use cache'`
- **User-specific data:** Use `createClient()` — reads cookies
- **Webhooks/admin:** Use `createAdminClient()` — bypasses RLS
- **Client-side:** Use `createBrowserClient()` only

---

## 5. Data Flow

### Request Flow

```
Request → proxy.ts → i18n routing → geo detection → session refresh → App Router
```

### Server Actions (`app/actions/`)

| Action File | Purpose |
|-------------|---------|
| `products.ts` | CRUD operations, bulk updates |
| `orders.ts` | Order management |
| `payments.ts` | Payment operations |
| `boosts.ts` | Listing boosts |
| `profile.ts` | Profile updates |
| `reviews.ts` | Review system |
| `onboarding.ts` | Post-signup flow |

### API Routes (`app/api/`)

| Route | Purpose |
|-------|---------|
| `/api/checkout/webhook` | Stripe checkout webhook (orders) |
| `/api/payments/webhook` | Stripe payments webhook (boosts) |
| `/api/subscriptions/webhook` | Subscription events |
| `/api/connect/*` | Stripe Connect onboarding + dashboard |
| `/api/categories/` | Category data |
| `/api/products/` | Product search/listing |
| `/api/orders/` | Order operations |
| `/api/upload-image/` | Image uploads |

### Cached Fetchers (`lib/data/`)

| Fetcher | Purpose |
|---------|---------|
| `getProducts()` | Product listings with filters |
| `getCategories()` | Category tree |
| `getPlans()` | Subscription plans |
| `getProfile()` | User profile data |

---

## 6. Caching Patterns

### Cache Profiles

Defined in `next.config.ts`:

| Profile | TTL | Use For |
|---------|-----|---------|
| `categories` | Long | Category tree |
| `products` | Medium | Product listings |
| `deals` | Short | Time-sensitive |
| `user` | Short | User-specific |
| `max` | Longest | Static content |

### Cache Rules

1. **Always pair:** `cacheLife('<profile>')` + `cacheTag('<tag>')`
2. **Invalidate with two args:** `revalidateTag(tag, profile)`
3. **Never inside cache:**
   - `cookies()` or `headers()`
   - `new Date()` (causes ISR write storms)
   - User-specific reads
4. **Use `createStaticClient()`** for cached Supabase reads

### Example Pattern

```ts
"use cache"
import { cacheLife, cacheTag } from "next/cache";
import { createStaticClient } from "@/lib/supabase/server";

export async function getCategories() {
  cacheLife("categories");
  cacheTag("categories");
  const supabase = createStaticClient();
  // ... fetch
}
```

---

## 7. Import Rules

### Boundaries

```
components/ui/       → shadcn primitives ONLY (no app logic)
components/shared/   → shared composites (use ui + lib)
components/layout/   → shells (header, nav, footer)
components/providers/→ thin contexts
hooks/               → reusable React hooks
lib/                 → pure utilities (no React, no app imports)
```

### Forbidden Imports

- Never import `_components/` across route groups
- Never import app code into `lib/`
- Never import app hooks into `components/ui/`

---

## 8. Component Patterns

### Server vs Client

- **Default to Server Components**
- Add `"use client"` only for: state, effects, event handlers
- Keep client components "dumb" — data as props

### Forms

- Use `components/shared/field.tsx` (`Field`, `FieldLabel`, `FieldError`)
- Use `components/ui/*` inputs/buttons

### i18n

- Server: `getTranslations()` + `setRequestLocale()`
- Client: `useTranslations()`
- Links: Use `Link` from `@/i18n/routing`

---

## 9. UI Ownership Map

| UI Element | Location |
|------------|----------|
| App header | `components/layout/header/app-header.tsx` |
| Mobile header | `components/layout/header/mobile/` |
| Desktop header | `components/layout/header/desktop/` |
| Footer | `components/layout/footer/site-footer.tsx` |
| Desktop shell | `components/layout/desktop-shell.tsx` |
| Product cards | `components/shared/product/product-card.tsx` |
| Quick view (shared) | `components/shared/product/quick-view/` |
| Quick view (desktop) | `components/desktop/product/product-quick-view-dialog.tsx` |
| Quick view (mobile) | `components/mobile/drawers/product-quick-view-drawer.tsx` |
| Cart (desktop) | `components/layout/header/cart/cart-dropdown.tsx` |
| Cart (mobile drawer) | `components/mobile/drawers/cart-drawer.tsx` |

---

## 10. Security Rules

### Supabase

- RLS must be enabled on all user data tables
- Use `supabase.auth.getUser()` (not `getSession()`) for security checks
- Never ship `SUPABASE_SERVICE_ROLE_KEY` to client

### Stripe

- Verify webhook signatures with `stripe.webhooks.constructEvent()`
- Make handlers idempotent (events can retry)
- Never log secrets or customer PII

### Auth Boundaries

Protected by middleware:
- `/account/*`
- `/sell/*`
- `/chat/*`
- `/protected/*`

Use `requireAuth()` from `lib/auth/require-auth.ts` in server actions.

---

## 11. Performance Rules

### Avoid

- `select('*')` in hot paths — project only needed fields
- Wide joins in list views — use RPCs for aggregations
- Caching user-specific data
- Missing `generateStaticParams()` on hot segments (ISR spikes)

### Prefer

- Server Components over client fetching
- Granular cache tags over broad ones
- Stable query ordering in cached functions

---

## 12. Ownership Domains

> "Departments" are responsibility zones, not separate executors. Treido ships through a single implementation workflow.

| Domain | Ownership | Owns |
|--------|-----------|------|
| Styling | Current implementer | Tailwind v4 semantic token rails + shadcn-safe patterns |
| UI/UX design | Current implementer | Hierarchy, spacing, states, polish |
| Next.js App Router | Current implementer | Route/layout boundaries, Server vs Client, cache-safe request patterns |
| Data + auth | Current implementer | Supabase client selection, query shape, auth/session boundaries |
| Payments | Current implementer | Checkout/webhooks/idempotency safety |
| Testing | Current implementer | Playwright + Next.js reliability and CI stability |
| Accessibility | Current implementer | WCAG 2.2 AA semantics, keyboard/focus, screen-reader support |

### Optional Runtime State

- `.codex/TASKS.md` — active task queue (only if you want a backlog)
- `.codex/DECISIONS.md` — decision log (only if you need traceability)
- `.codex/SHIPPED.md` — shipped log

---

## See Also

- [PRD.md](/platform) — Product vision & scope
- [DESIGN.md](/) — UI/UX rules
- [ROUTES.md](/routes) — Route map
- [AGENTS.md](/workflow) — Entry point + non-negotiables
- [WORKFLOW.md](/workflow) — Default shipping loop

---

*Last updated: 2026-02-08*

