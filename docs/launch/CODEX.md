# Codex Launch Instructions

> Read this when the orchestrator assigns you a checklist section.

## Setup

1. Read `AGENTS.md` — project identity, conventions, constraints.
2. Read this file — understand the workflow.
3. Work on the assigned section ONLY.

## Your Job

You are auditing AND fixing a section of the codebase for production readiness. Within your assigned scope:

1. **Read every file** in the scoped directories listed for your section in `docs/launch/CHECKLIST.md`.
2. **Find issues** — type safety, missing validation, wrong Supabase client usage, convention violations (AGENTS.md), hardcoded strings that should be i18n, missing error handling, accessibility gaps, wrong imports (`next/link` vs `@/i18n/routing`), palette colors instead of semantic tokens.
3. **Fix them.** You have bounded autonomy within the scoped directories.
4. **Don't touch** files outside your section scope. Don't touch DB migrations, RLS policies, webhook verification core logic, or other sections.
5. **Run gates** after your changes:
   ```bash
   pnpm -s typecheck && pnpm -s lint && pnpm -s styles:gate && pnpm -s test:unit
   ```
6. **Log what you did** — append a summary to the `## Log` section below.

## Standards

- Full TypeScript strictness — no `any`, no `as` casts without justification
- Zod validation at boundaries (forms, API inputs, webhooks)
- Correct Supabase client per context (see `docs/STACK.md` § Supabase Client Selection)
- Semantic Tailwind tokens only (`bg-background`, not `bg-gray-100` or `bg-[#fff]`)
- shadcn/ui components used correctly
- Mobile-first responsive design
- i18n: all user-facing strings via `useTranslations()` / `getTranslations()`
- Navigation: `Link` / `redirect` from `@/i18n/routing`, never `next/link`
- `"use client"` only when needed (state, effects, event handlers, browser APIs)
- Loading states for async operations
- Error handling — try/catch in server actions, error boundaries in routes

## Log

<!-- Codex appends summaries here after each section. Format: date, section, what was found/fixed. -->
- 2026-02-23, Section 1 (Infrastructure & Gates), ran full gates and build; fixed `lint` warnings in product-card test mocks (sanitized `next/image` and `Link` mock props), removed stray `console.error` calls from `app/[locale]/(account)/account/_components/use-badges.ts`, fixed `react-hooks/refs` lint error in `app/[locale]/(auth)/auth/reset-password/reset-password-client.tsx` by moving `handleSubmit(...)` invocation into an event handler, and fixed `build` prerender failure (`next-prerender-current-time`) by making `components/shared/product/freshness-indicator.tsx` a client component. Final status: `typecheck`, `lint`, `styles:gate`, `test:unit`, and `build` all pass.
- 2026-02-23, Section 1 (Infrastructure & Gates) follow-up, fixed additional `build` type failure in `lib/data/category-attributes.ts` by widening `toCategoryAttribute` input row typing to match query-selected columns, and reduced expected prerender cancellation noise in `app/api/seller/top/route.ts` by skipping logs for Next prerender fetch-rejection sentinel errors. Re-ran full gate suite and `build` successfully.
- 2026-02-23, Section 1 (Infrastructure & Gates) final polish, suppressed noisy known-schema-mismatch logs for missing `is_browseable` in `lib/data/categories/hierarchy.ts` while preserving fallback behavior, then fixed resulting lint style warnings and re-ran `build` and the full gate suite to final green.
- 2026-02-23, Supabase launch blockers execution: connected via Supabase CLI/API to linked project `dhtzybnkvpimmomzwrce` and re-ran advisors. Security advisor result: `security_total=1`, `security_warn=1`, `security_critical=0` (only `auth_leaked_password_protection`). Attempted to enable leaked password protection (`password_hibp_enabled=true`) through `PATCH /v1/projects/{ref}/config/auth`; request failed with `402 Payment Required` because HIBP leaked-password protection is only available on Pro plan and above. Performance advisor result: `performance_total=23`, `performance_warn=0`, `performance_critical=0` (all INFO).

- 2026-02-23 — Section 2 (Auth): Audited and fixed all files in `app/[locale]/(auth)/`, `components/auth/`, `lib/auth/`, and `app/api/auth/` for auth-launch readiness. Key fixes: removed production `console.error` usage in auth API/component flows; replaced reset-password session validity check from `auth.getSession()` to `auth.getUser()`; tightened auth server-action safety (`signUp` try/catch, username format validation, safer failure handling); localized auth-route metadata (`error`, `forgot-password`, `reset-password`, `sign-up-success`, `welcome`) and removed hardcoded auth/welcome UI strings by reusing existing i18n keys; improved sign-up success resend flow feedback and locale persistence; hardened welcome onboarding flow with upload validation, load/action error handling, safe profile fallback paths, and corrected `onboarding_completed` persistence timing (now only finalized at profile completion step). Verification: `pnpm -s typecheck && pnpm -s lint && pnpm -s styles:gate && pnpm -s test:unit` passed.
- 2026-02-23 — Section 3 (Selling): audited and fixed scoped sell flow + listing management files in `app/[locale]/(sell)/`, `app/[locale]/(account)/account/selling/`, `app/actions/products-{create,update,bulk,shared}.ts`, `lib/sell/`, and `app/api/upload-image/`. Key fixes: aligned sell schema + UI behavior (EUR-only pricing control, trimmed title/description validation, required shipping-region and seller-city checks), hardened submit error UX by mapping server Zod issues back to form fields, fixed toggle interactions that could double-fire (`acceptOffers` / `freeShipping`), improved photo upload response parsing and failure handling, migrated sell drafts to seller-scoped storage keys with legacy fallback, replaced in-scope `console.error` usage in product/sell actions with structured logger paths, added localized metadata for selling/edit routes, tightened edit-listing client validation (title/price/discount/shipping checks), and added explicit listing status badges on desktop management rows. Verification run: `pnpm -s typecheck && pnpm -s lint && pnpm -s styles:gate && pnpm -s test:unit` passed (lint still reports pre-existing warnings outside selling scope).
- 2026-02-23 — Section 6 (Checkout & Payments): Audited and fixed all scoped files in `app/[locale]/(checkout)/`, `app/api/checkout/`, `app/actions/payments.ts`, and `lib/stripe-connect.ts` (read-only audit for `lib/stripe.ts`; no webhook-signature core logic changes). Checkout/auth fixes: added server-side auth guards + localized metadata for checkout and success routes, redirecting unauthenticated users to localized login with `next` return path; kept mobile/desktop checkout layouts and loading states intact. Payment flow robustness: replaced fragile checkout error-string parsing with typed action error codes; hardened checkout session creation logging and seller payout fallback handling; strengthened success verification with Zod session-id validation, session ownership checks, payment-intent guards, structured success payload (`orderId`, `totalAmount`, `itemCount`), and localized failure messaging/UI. Webhook and payment action hardening: made checkout webhook order insert path type-safe (`payment_intent` extraction, shared route logging key, paid-status guard only when provided), removed unnecessary line-item fetch dependency, and validated payment-method ownership before delete/default mutations in `app/actions/payments.ts`. UI/data quality fixes: stable order-item keys for variant carts, null-safe address rendering, stricter shipping-method typing, and safer fee math fallbacks (`maybeSingle`, normalized values). Verification status: `pnpm -s styles:gate` passed; `pnpm -s test:unit` passed after scoped fixes (including checkout webhook idempotency test). `pnpm -s typecheck` currently fails due pre-existing unrelated errors in PDP/account files outside scope, and `pnpm -s lint` reports 3 pre-existing warnings in `app/[locale]/(account)/account/selling/edit/edit-product-client.tsx` outside scope.
- 2026-02-23 — Section 4 (Product Display / PDP): audited all scoped files in `app/[locale]/[username]/[productSlug]/`, product-related files in `app/[locale]/[username]/` (`page.tsx`, `layout.tsx`, `profile-client*.tsx`), `components/shared/product/`, and `lib/view-models/product-page.ts`. Fixed launch blockers and quality issues: removed non-functional report CTA behavior by hiding it when no handler is wired; wired mobile seller drawer chat CTA to real `/chat?seller=...&product=...` navigation and hid unavailable follow/chat actions gracefully; added safe async error handling for review submission and wishlist toggles (mobile gallery, desktop buy box, card actions, quick view) to prevent unhandled promise console errors; implemented working desktop share actions (Web Share API with clipboard fallback) in gallery and buy box; localized review date formatting by active locale; improved a11y thumbnail labels in quick view with localized strings; switched PDP primary price surfaces and JSON-LD `priceCurrency` to BGN (`DesktopBuyBox`, `ProductHeader`, `MobileBottomBar`, PDP schema); and hardened `buildProductPageViewModel` by validating/filtering malformed related-product rows before rendering. Verification: `pnpm -s typecheck && pnpm -s lint && pnpm -s styles:gate && pnpm -s test:unit` passed.
- 2026-02-24 — Section 7 (Orders): audited and fixed all scoped files in `app/[locale]/(account)/account/orders/`, `app/[locale]/(account)/account/sales/`, `app/[locale]/(sell)/sell/orders/`, `app/actions/orders-*.ts`, `components/shared/order-detail/`, `components/shared/order-list-item.tsx`, `lib/order-status.ts`, and `lib/order-conversations.ts`. Key fixes: added buyer order-list pagination (`page` query, page controls, page-reset on search/status filter changes), localized scoped metadata titles/descriptions for orders/sales/seller-orders pages, corrected sales table action target to seller order management (`/sell/orders`), fixed sales status source to item-level status, strengthened seller orders UI copy for both `en/bg` and localized status/tab/empty-state messaging, improved order detail chat deep-linking to existing order conversations, and removed production `console.*` usage in scoped UI/action files. Server-action hardening: replaced ad-hoc order action failures with typed failure codes in `orders-status`/`orders-support`, added structured logger events in `orders-reads`/`orders-status`/`orders-support`, and kept `requireAuth`/`getUser` auth guards intact. Verification: `pnpm -s styles:gate` passed. `pnpm -s typecheck` fails on pre-existing unrelated error in `app/actions/username-account.ts` (`exactOptionalPropertyTypes` mismatch). `pnpm -s lint` reports pre-existing unrelated warnings in account profile files (`_locale` unused). `pnpm -s test:unit` fails in pre-existing unrelated `__tests__/hooks/use-product-search.test.ts` due missing `useTranslations` in the `next-intl` test mock.
- 2026-02-24 — Section 8 (Profile & Account): audited scoped profile/account files and implemented a full profile hardening pass across `app/[locale]/(account)/account/profile/`, `app/actions/profile-*.ts`, and `app/actions/username-*.ts`, plus scoped account surfaces under `app/[locale]/(account)/account/`. Key fixes: localized profile/account-profile UI copy via `next-intl` by introducing `Account.profileEditor` keys (`messages/en.json` + `messages/bg.json`) and replacing hardcoded locale branches in profile cards/dialogs/editor; converted profile + username server actions to typed `errorCode` responses (instead of free-form English strings), then mapped those codes to localized user messages in profile clients; removed production `console.error` usage in all touched section-8 files, switching to structured `logger.error` events; localized profile page metadata via `generateMetadata` + `getTranslations`; and preserved semantic tokens, mobile-first layouts, auth-guard expectations, and i18n routing imports. Verification: `pnpm -s typecheck && pnpm -s lint && pnpm -s styles:gate && pnpm -s test:unit` completed; one unrelated pre-existing lint warning remains in `hooks/use-product-search.ts` (`unicorn/prefer-spread`), outside Section 8 scope.
- 2026-02-24 — Section 9 (Cart & Wishlist): audited and fixed scoped files in `app/[locale]/(main)/cart/`, `app/[locale]/(main)/wishlist/`, `app/api/wishlist/`, `components/shared/wishlist/`, and `components/mobile/drawers/`. Key fixes: removed scoped production `console.error` usage and switched to structured `logger.error` in `app/api/wishlist/[token]/route.ts` and `components/mobile/drawers/account-drawer.tsx`; localized shared wishlist metadata by replacing hard-coded metadata in `app/[locale]/(main)/wishlist/shared/[token]/page.tsx` with `generateMetadata` + `getTranslations`; and closed remaining i18n string gaps by replacing hardcoded `"Product"` fallbacks with translation-driven labels in shared wishlist add-to-cart/image fallback paths. Added `SharedWishlist.metadataTitle` and `SharedWishlist.metadataDescription` for both `en/bg` locales. Verification: `pnpm -s typecheck && pnpm -s lint && pnpm -s styles:gate && pnpm -s test:unit` passed.
- 2026-02-24 — Section 10 (Onboarding): audited `app/[locale]/(onboarding)/` plus `app/actions/onboarding.ts` and fixed remaining production logging violations in the onboarding server action. Key fixes: replaced scoped `console.error` calls in `completePostSignupOnboarding` with structured `logger.error` events for validation and profile update failures while preserving typed return contracts and existing onboarding flow behavior. Verified no scoped regressions in auth guard usage (`getUser` in onboarding layout), i18n usage, routing imports, semantic tokens, loading states, and mobile-first layout behavior. Verification: `pnpm -s typecheck && pnpm -s lint && pnpm -s styles:gate && pnpm -s test:unit` passed.
- 2026-02-24 — Section 11 (Navigation & Layout): audited scoped layout/chrome/drawer/desktop shell files (`components/layout/`, `components/mobile/chrome/`, `components/mobile/drawers/`, `components/desktop/`, `app/[locale]/layout.tsx`, `app/[locale]/not-found.tsx`, `app/[locale]/error.tsx`, `app/global-error.tsx`, `app/global-not-found.tsx`) and fixed remaining launch-rule violations. Key fixes: removed production `console.error` from `app/global-error.tsx`; localized hardcoded mobile progress accessibility fallback text in `components/mobile/chrome/mobile-step-progress.tsx` via `useTranslations("MobileStepProgress")`; replaced raw `<a>` links in `app/global-not-found.tsx` with locale-aware `Link` from `@/i18n/routing`; and added `MobileStepProgress` i18n keys for `en/bg` in messages. Verification: `pnpm -s typecheck && pnpm -s lint && pnpm -s styles:gate && pnpm -s test:unit` passed.
- 2026-02-24 — Section 5 (Search & Browse): audited and fixed scoped files in `app/[locale]/(main)/page.tsx`, `app/[locale]/(main)/search/`, `app/[locale]/(main)/categories/`, `app/[locale]/(main)/_components/`, `app/[locale]/(main)/_lib/`, `components/shared/search/`, `components/shared/filters/`, `components/mobile/category-nav/`, `lib/filters/`, and `hooks/use-product-search.ts`. FIX-001 root cause: raw query strings (notably commas) were interpolated into Supabase `.or(...)` filters, breaking PostgREST parsing and causing search failures. Implemented `lib/filters/search-query.ts` to tokenize/normalize queries and safely build `ilike` OR filters; wired it into listings search (`search-products.ts`) and sellers search (`search-sellers.ts`), with added error logging for category/profile/product fetch failures. Localized search metadata (`search-page-metadata.ts`) and price preset labels in filter UI (`price-filter-section.tsx`), updated sort UX to explicit `relevance` while preserving legacy `featured` URL compatibility (`sort-select.tsx`), removed remaining hardcoded seller fallback label, and hardened client search hook (`use-product-search.ts`) with normalized query requests + schema-validated response/localStorage parsing. Also updated hook unit mock for `next-intl` translations (`__tests__/hooks/use-product-search.test.ts`). Validation: verified `/en/search?q=iphone,samsung`, `/en/search`, `/en/search?mode=sellers&q=phone`, `/en/categories/electronics`, and empty-search cases via HTTP checks; ran `pnpm -s typecheck && pnpm -s lint && pnpm -s styles:gate && pnpm -s test:unit` successfully.
