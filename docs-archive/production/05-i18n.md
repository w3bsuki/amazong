# Phase 5: Internationalization (i18n) - FINALIZED ‚úÖ

> **Priority:** üü¢ Complete
> **Status:** Production-ready with next-intl 4.x best practices
> **Next.js Version:** 16+

---

## ‚úÖ Implementation Summary

This project uses **next-intl 4.x** with the **App Router** pattern, following all official best practices for Next.js 16+.

### Core Configuration Files

| File | Purpose |
|------|---------|
| `i18n/routing.ts` | Centralized routing config with locale validation, detection & cookie persistence |
| `i18n/request.ts` | Per-request config with timezone, formats, and error handling |
| `proxy.ts` | **Next.js 16 Proxy entrypoint** (replaces deprecated `middleware.ts`) combining i18n routing with geo-detection & auth |
| `messages/en.json` | English translations (source of truth) |
| `messages/bg.json` | Bulgarian translations |

---

## üèóÔ∏è Architecture

### Locale Strategy: `localePrefix: 'always'`

```
/en/products     ‚Üí English product listing
/bg/products     ‚Üí Bulgarian product listing
/en/about        ‚Üí English about page
/bg/about        ‚Üí Bulgarian about page
```

**Important exceptions:** Some technical routes are intentionally *not* localized and are excluded from the middleware matcher (e.g. `/auth/callback` and `/auth/confirm` for auth flows). The user-facing site routes live under `/en/*` and `/bg/*`.

**Why `always`:**
- ‚úÖ Clear, stable URLs for SEO
- ‚úÖ No ambiguity about which locale is active
- ‚úÖ Consistent behavior across all routes
- ‚úÖ Easy to share locale-specific links

### Type Safety with Locale Type

```typescript
// i18n/routing.ts
export type Locale = 'en' | 'bg';
export const locales: readonly Locale[] = ['en', 'bg'] as const;

export function isValidLocale(locale: string): locale is Locale {
  return locales.includes(locale as Locale);
}

export function validateLocale(locale: string): Locale {
  if (isValidLocale(locale)) {
    return locale;
  }
  console.warn(`Invalid locale "${locale}", falling back to "en"`);
  return 'en';
}
```

**Benefits:**
- ‚úÖ Strict typing for locale parameters
- ‚úÖ Runtime validation with type narrowing
- ‚úÖ Consistent locale handling across routing, middleware, and layouts
- ‚úÖ Locale-aware navigation helpers (Link/redirect/router) from `createNavigation(routing)`

---

## üìÅ File Structure

```
‚îú‚îÄ‚îÄ i18n/
‚îÇ   ‚îú‚îÄ‚îÄ routing.ts      # defineRouting + createNavigation + Locale type
‚îÇ   ‚îî‚îÄ‚îÄ request.ts      # getRequestConfig with formats
‚îú‚îÄ‚îÄ messages/
‚îÇ   ‚îú‚îÄ‚îÄ en.json         # English (1200+ keys)
‚îÇ   ‚îî‚îÄ‚îÄ bg.json         # Bulgarian (1200+ keys)
‚îú‚îÄ‚îÄ proxy.ts            # Next.js 16 Proxy entrypoint (i18n + geo + auth/session)
‚îî‚îÄ‚îÄ app/[locale]/       # Locale-segmented routes
```

---

## üîß Configuration Details

### 0. Proxy Entrypoint (`proxy.ts`)

Next.js 16+ uses the `proxy.ts` file convention (the old `middleware.ts` convention is deprecated in 16.x). This repo implements i18n routing + geo cookies + session updates in `proxy.ts`.

```typescript
import createMiddleware from 'next-intl/middleware';
import type { NextRequest } from 'next/server';

import { routing } from './i18n/routing';

const handleI18nRouting = createMiddleware(routing);

export async function proxy(request: NextRequest) {
  const response = handleI18nRouting(request);
  // ... geo cookies + session update ...
  return response;
}

export default proxy;

export const config = {
  matcher: ['/((?!api|_next|_vercel|auth/callback|auth/confirm|.*\\..*).*)']
};
```

### Middleware Matcher (what the middleware runs on)

The shared middleware logic lives in `proxy.ts` and exports a `config.matcher` that intentionally skips:
- API routes (`/api/*`)
- Next.js internals (`/_next/*`, `/_vercel/*`)
- Auth callback/confirm routes (`/auth/callback`, `/auth/confirm`)
- Static files (paths containing a `.` like `favicon.ico`)

This keeps locale routing + cookies + session handling on app pages, while avoiding breaking third-party callbacks and static assets.

### 1. Routing (`i18n/routing.ts`)

```typescript
export const routing = defineRouting({
  locales: ['en', 'bg'],
  defaultLocale: 'en',
  localePrefix: 'always',
  localeDetection: true,
  localeCookie: {
    name: 'NEXT_LOCALE',
    maxAge: 60 * 60 * 24 * 365,  // 1 year
    sameSite: 'lax',
    path: '/'
  }
});
```

### 2. Request Config (`i18n/request.ts`)

```typescript
export default getRequestConfig(async ({ requestLocale }) => {
  const requested = await requestLocale;
  const locale = hasLocale(routing.locales, requested)
    ? requested
    : routing.defaultLocale;

  return {
    locale,
    messages: (await import(`../messages/${locale}.json`)).default,
    timeZone: 'Europe/Sofia',
    formats: {
      dateTime: { short: {...}, long: {...}, delivery: {...}, order: {...} },
      number: { currency: {...}, precise: {...}, percent: {...} },
      list: { enumeration: {...}, options: {...} }
    },
    onError(error) { /* Handle missing translations */ },
    getMessageFallback({ namespace, key }) { /* Return fallback text */ }
  };
});
```

### 3. Next.js Config (`next.config.ts`)

```typescript
import createNextIntlPlugin from 'next-intl/plugin';

const withNextIntl = createNextIntlPlugin();
export default withNextIntl(nextConfig);
```

---

## üß≠ Navigation Best Practices

### Use Locale-Aware Navigation APIs

```typescript
// ‚úÖ Import from @/i18n/routing (not next/navigation)
import { Link, useRouter, usePathname, redirect } from '@/i18n/routing';

// Links automatically include current locale
<Link href="/products">Products</Link>

// Switch locale explicitly
<Link href="/products" locale="bg">–ü—Ä–æ–¥—É–∫—Ç–∏</Link>

// Programmatic navigation
const router = useRouter();
router.push('/products');
router.push('/products', { locale: 'bg' });
```

### Server Components

```typescript
import { getTranslations, setRequestLocale } from 'next-intl/server';
import { validateLocale } from '@/i18n/routing';

export default async function Page({ params }: { params: Promise<{ locale: string }> }) {
  const { locale: localeParam } = await params;
  const locale = validateLocale(localeParam);  // Type-safe narrowing
  
  // Enable static rendering - CRITICAL for performance
  setRequestLocale(locale);
  
  const t = await getTranslations('ProductPage');
  
  return <h1>{t('title')}</h1>;
}
```

### Client Components

```typescript
'use client';
import { useTranslations, useLocale } from 'next-intl';

export function ProductCard() {
  const t = useTranslations('Product');
  const locale = useLocale();
  
  return <button>{t('addToCart')}</button>;
}
```

---

## üí∞ Currency & Number Formatting

### Bulgarian Lev (BGN) Configuration

```typescript
// In request.ts formats
number: {
  currency: {
    style: 'currency',
    currency: 'BGN',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }
}
```

### Usage

```typescript
import { useFormatter } from 'next-intl';

function Price({ amount }: { amount: number }) {
  const format = useFormatter();
  
  // Outputs: "29,99 –ª–≤" (Bulgarian) or "BGN 29.99" (English)
  return <span>{format.number(amount, 'currency')}</span>;
}
```

---

## üìÖ Date/Time Formatting

### Configured Formats

| Format | Example Output (bg) | Use Case |
|--------|---------------------|----------|
| `short` | 27 –¥–µ–∫. 2025 | General dates |
| `long` | –ø–µ—Ç—ä–∫, 27 –¥–µ–∫–µ–º–≤—Ä–∏ 2025 | Full dates |
| `delivery` | 27 –¥–µ–∫. | Delivery estimates |
| `order` | 27 –¥–µ–∫. 2025, 10:30 | Order timestamps |

### Usage

```typescript
import { useFormatter } from 'next-intl';

function DeliveryDate({ date }: { date: Date }) {
  const format = useFormatter();
  
  return <span>{format.dateTime(date, 'delivery')}</span>;
}
```

---

## üî§ Message Syntax (ICU)

### Interpolation

```json
{
  "greeting": "–ó–¥—Ä–∞–≤–µ–π, {name}!",
  "freeDeliveryDate": "–ë–ï–ó–ü–õ–ê–¢–ù–ê –¥–æ—Å—Ç–∞–≤–∫–∞ {date}"
}
```

```typescript
t('greeting', { name: user.name });
t('freeDeliveryDate', { date: formatDate(deliveryDate, 'delivery') });
```

### Pluralization (Bulgarian)

```json
{
  "items": "{count, plural, one {# –∞—Ä—Ç–∏–∫—É–ª} other {# –∞—Ä—Ç–∏–∫—É–ª–∞}}",
  "reviews": "{count, plural, one {# –æ—Ç–∑–∏–≤} few {# –æ—Ç–∑–∏–≤–∞} other {# –æ—Ç–∑–∏–≤–∞}}"
}
```

```typescript
t('items', { count: 1 });  // "1 –∞—Ä—Ç–∏–∫—É–ª"
t('items', { count: 5 });  // "5 –∞—Ä—Ç–∏–∫—É–ª–∞"
```

### Select

```json
{
  "orderStatus": "{status, select, pending {–í –∏–∑—á–∞–∫–≤–∞–Ω–µ} shipped {–ò–∑–ø—Ä–∞—Ç–µ–Ω–∞} delivered {–î–æ—Å—Ç–∞–≤–µ–Ω–∞} other {–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ}}"
}
```

---

## üß™ Testing Configuration

### Vitest Setup

```typescript
// vitest.config.ts (recommended single config)
// Inline next-intl for ESM compatibility in Vitest
test: {
  server: {
    deps: {
      inline: ['next-intl'],
    },
  },
}
```

### Testing with Provider

```typescript
import { render } from '@testing-library/react';
import { NextIntlClientProvider } from 'next-intl';
import messages from '@/messages/en.json';

function renderWithI18n(ui: React.ReactElement) {
  return render(
    <NextIntlClientProvider locale="en" messages={messages}>
      {ui}
    </NextIntlClientProvider>
  );
}
```

---

## üîç SEO Best Practices

### Hreflang / Alternates

For internationalized SEO, prefer emitting alternate language links (hreflang) via:
- Metadata `alternates.languages` (per route), and/or
- `app/sitemap.ts` entries that include `alternates.languages`.

This repo currently generates per-locale sitemap URLs (e.g. `/en/...` and `/bg/...`). If you want the canonical hreflang model, add alternates mapping per entry.

### Metadata with Translations

```typescript
// app/[locale]/layout.tsx
export async function generateMetadata({ params }: { params: Promise<{ locale: string }> }) {
  const { locale } = await params;
  
  return {
    title: locale === 'bg' ? 'AMZN - –û–Ω–ª–∞–π–Ω –º–∞–≥–∞–∑–∏–Ω' : 'AMZN - Online Shopping',
    openGraph: {
      locale: locale === 'bg' ? 'bg_BG' : 'en_US'
    }
  };
}
```

### Static Params Generation

```typescript
// Required for static rendering with [locale] segment
export function generateStaticParams() {
  return routing.locales.map((locale) => ({ locale }));
}
```

---

## ‚úÖ Checklist - ALL COMPLETE

### Configuration
- [x] `i18n/routing.ts` with defineRouting + Locale type + validateLocale helper
- [x] `i18n/request.ts` with getRequestConfig
- [x] next-intl plugin in `next.config.ts`
- [x] Middleware with proper matcher

### Type Safety
- [x] `Locale` type exported from routing.ts
- [x] `validateLocale()` for runtime type narrowing
- [x] `isValidLocale()` type guard
- [x] `locales` const array for generateStaticParams
- [ ] (Optional) Add next-intl message key typing via `next-intl` `AppConfig` module augmentation

### Formatting
- [x] Timezone: Europe/Sofia
- [x] Currency: BGN with proper formatting
- [x] Date formats: short, long, delivery, order
- [x] Number formats: currency, precise, percent, integer
- [x] List formats: enumeration, options

### Error Handling
- [x] onError handler for missing messages
- [x] getMessageFallback for graceful degradation
- [x] Development-friendly error messages

### Testing
- [x] Vitest configured to inline next-intl
- [x] Test helpers available

### Messages
- [x] en.json - 1200+ translation keys
- [x] bg.json - 1200+ translation keys (native Bulgarian)
- [x] Organized by namespace (Header, Navigation, Product, etc.)

---

## üèÅ Next Step

‚Üí Proceed to [Phase 6: Testing](./06-testing.md)
