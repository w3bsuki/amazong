[{"filePath":"J:\\amazong\\__tests__\\ai-model-spec.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\badge-intent.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\boost-status.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\category-badge.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\category-tone.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\currency.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\format-price.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\geolocation.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ShippingZoneCode' is defined but never used.","line":9,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":24,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ShippingZoneCode"},"fix":{"range":[176,202],"text":""},"desc":"Remove unused variable \"ShippingZoneCode\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, expect, it } from 'vitest'\r\nimport {\r\n  COUNTRY_NAMES,\r\n  COUNTRY_NAMES_BG,\r\n  SHIPPING_ZONES,\r\n  getCountryName,\r\n  getZoneForCountry,\r\n  getCompatibleZones,\r\n  type ShippingZoneCode\r\n} from '@/lib/geolocation'\r\n\r\ndescribe('lib/geolocation', () => {\r\n  describe('COUNTRY_NAMES', () => {\r\n    it('contains major countries in English', () => {\r\n      expect(COUNTRY_NAMES.US).toBe('United States')\r\n      expect(COUNTRY_NAMES.GB).toBe('United Kingdom')\r\n      expect(COUNTRY_NAMES.DE).toBe('Germany')\r\n      expect(COUNTRY_NAMES.FR).toBe('France')\r\n      expect(COUNTRY_NAMES.BG).toBe('Bulgaria')\r\n    })\r\n    \r\n    it('contains all EU member states', () => {\r\n      const euCountries = [\r\n        'AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR',\r\n        'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL',\r\n        'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE'\r\n      ]\r\n      \r\n      for (const code of euCountries) {\r\n        expect(COUNTRY_NAMES[code], `${code} should have English name`).toBeDefined()\r\n      }\r\n    })\r\n  })\r\n  \r\n  describe('COUNTRY_NAMES_BG', () => {\r\n    it('contains major countries in Bulgarian', () => {\r\n      expect(COUNTRY_NAMES_BG.US).toBe('╨í╨É╨⌐')\r\n      expect(COUNTRY_NAMES_BG.GB).toBe('╨Æ╨╡╨╗╨╕╨║╨╛╨▒╤Ç╨╕╤é╨░╨╜╨╕╤Å')\r\n      expect(COUNTRY_NAMES_BG.DE).toBe('╨ô╨╡╤Ç╨╝╨░╨╜╨╕╤Å')\r\n      expect(COUNTRY_NAMES_BG.FR).toBe('╨ñ╤Ç╨░╨╜╤å╨╕╤Å')\r\n      expect(COUNTRY_NAMES_BG.BG).toBe('╨æ╤è╨╗╨│╨░╤Ç╨╕╤Å')\r\n    })\r\n    \r\n    it('has same keys as COUNTRY_NAMES', () => {\r\n      const enKeys = Object.keys(COUNTRY_NAMES).sort()\r\n      const bgKeys = Object.keys(COUNTRY_NAMES_BG).sort()\r\n      expect(bgKeys).toEqual(enKeys)\r\n    })\r\n  })\r\n  \r\n  describe('SHIPPING_ZONES', () => {\r\n    describe('BG zone', () => {\r\n      it('has correct configuration', () => {\r\n        expect(SHIPPING_ZONES.BG.code).toBe('BG')\r\n        expect(SHIPPING_ZONES.BG.name).toBe('Bulgaria Only')\r\n        expect(SHIPPING_ZONES.BG.name_bg).toBe('╨í╨░╨╝╨╛ ╨æ╤è╨╗╨│╨░╤Ç╨╕╤Å')\r\n        expect(SHIPPING_ZONES.BG.countries).toEqual(['BG'])\r\n      })\r\n    })\r\n    \r\n    describe('EU zone', () => {\r\n      it('has correct configuration', () => {\r\n        expect(SHIPPING_ZONES.EU.code).toBe('EU')\r\n        expect(SHIPPING_ZONES.EU.name).toBe('Europe')\r\n        expect(SHIPPING_ZONES.EU.name_bg).toBe('╨ò╨▓╤Ç╨╛╨┐╨░')\r\n      })\r\n      \r\n      it('includes Bulgaria in EU zone', () => {\r\n        expect(SHIPPING_ZONES.EU.countries).toContain('BG')\r\n      })\r\n      \r\n      it('includes major EU countries', () => {\r\n        const majorEuCountries = ['DE', 'FR', 'IT', 'ES', 'NL', 'PL', 'AT', 'BE']\r\n        for (const country of majorEuCountries) {\r\n          expect(SHIPPING_ZONES.EU.countries, `${country} should be in EU zone`).toContain(country)\r\n        }\r\n      })\r\n      \r\n      it('includes UK and associated countries', () => {\r\n        expect(SHIPPING_ZONES.EU.countries).toContain('GB')\r\n      })\r\n      \r\n      it('includes EEA countries (Norway, Switzerland)', () => {\r\n        expect(SHIPPING_ZONES.EU.countries).toContain('NO')\r\n        expect(SHIPPING_ZONES.EU.countries).toContain('CH')\r\n      })\r\n    })\r\n    \r\n    describe('WW zone', () => {\r\n      it('has correct configuration', () => {\r\n        expect(SHIPPING_ZONES.WW.code).toBe('WW')\r\n        expect(SHIPPING_ZONES.WW.name).toBe('Worldwide')\r\n        expect(SHIPPING_ZONES.WW.name_bg).toBe('╨ª╨╡╨╗╨╕╤Å╤é ╤ü╨▓╤Å╤é')\r\n        expect(SHIPPING_ZONES.WW.countries).toEqual([]) // Empty means all\r\n      })\r\n    })\r\n  })\r\n  \r\n  describe('getCountryName', () => {\r\n    it('returns English name by default', () => {\r\n      expect(getCountryName('US')).toBe('United States')\r\n      expect(getCountryName('BG')).toBe('Bulgaria')\r\n    })\r\n    \r\n    it('returns English name for en locale', () => {\r\n      expect(getCountryName('DE', 'en')).toBe('Germany')\r\n    })\r\n    \r\n    it('returns Bulgarian name for bg locale', () => {\r\n      expect(getCountryName('DE', 'bg')).toBe('╨ô╨╡╤Ç╨╝╨░╨╜╨╕╤Å')\r\n      expect(getCountryName('US', 'bg')).toBe('╨í╨É╨⌐')\r\n    })\r\n    \r\n    it('handles lowercase country codes', () => {\r\n      expect(getCountryName('us')).toBe('United States')\r\n      expect(getCountryName('bg')).toBe('Bulgaria')\r\n    })\r\n    \r\n    it('returns code for unknown countries', () => {\r\n      expect(getCountryName('XX')).toBe('XX')\r\n      expect(getCountryName('ZZ', 'bg')).toBe('ZZ')\r\n    })\r\n    \r\n    it('falls back to English if Bulgarian name is missing', () => {\r\n      // Both dictionaries have same keys, but test the fallback logic\r\n      const result = getCountryName('US', 'bg')\r\n      expect(result).toBeDefined()\r\n    })\r\n  })\r\n  \r\n  describe('getZoneForCountry', () => {\r\n    it('returns BG for Bulgaria', () => {\r\n      expect(getZoneForCountry('BG')).toBe('BG')\r\n    })\r\n    \r\n    it('returns EU for European countries', () => {\r\n      const euCountries = ['DE', 'FR', 'IT', 'ES', 'NL', 'PL', 'AT', 'BE', 'SE', 'FI', 'GB']\r\n      for (const country of euCountries) {\r\n        expect(getZoneForCountry(country), `${country} should be in EU zone`).toBe('EU')\r\n      }\r\n    })\r\n    \r\n    it('returns WW for non-EU countries', () => {\r\n      const wwCountries = ['US', 'AU', 'JP', 'CN', 'BR', 'CA']\r\n      for (const country of wwCountries) {\r\n        expect(getZoneForCountry(country), `${country} should be in WW zone`).toBe('WW')\r\n      }\r\n    })\r\n    \r\n    it('handles lowercase country codes', () => {\r\n      expect(getZoneForCountry('bg')).toBe('BG')\r\n      expect(getZoneForCountry('de')).toBe('EU')\r\n    })\r\n    \r\n    it('returns WW for unknown countries', () => {\r\n      expect(getZoneForCountry('XX')).toBe('WW')\r\n      expect(getZoneForCountry('')).toBe('WW')\r\n    })\r\n  })\r\n  \r\n  describe('getCompatibleZones', () => {\r\n    it('returns all zones for Bulgarian users', () => {\r\n      const zones = getCompatibleZones('BG')\r\n      expect(zones).toEqual(['BG', 'EU', 'WW'])\r\n    })\r\n    \r\n    it('returns EU and WW for EU users', () => {\r\n      const zones = getCompatibleZones('DE')\r\n      expect(zones).toEqual(['EU', 'WW'])\r\n    })\r\n    \r\n    it('returns only WW for non-EU users', () => {\r\n      const zones = getCompatibleZones('US')\r\n      expect(zones).toEqual(['WW'])\r\n      \r\n      const zonesAu = getCompatibleZones('AU')\r\n      expect(zonesAu).toEqual(['WW'])\r\n    })\r\n    \r\n    it('handles lowercase country codes', () => {\r\n      expect(getCompatibleZones('bg')).toEqual(['BG', 'EU', 'WW'])\r\n      expect(getCompatibleZones('de')).toEqual(['EU', 'WW'])\r\n    })\r\n    \r\n    it('returns WW only for unknown countries', () => {\r\n      expect(getCompatibleZones('XX')).toEqual(['WW'])\r\n    })\r\n  })\r\n  \r\n  describe('integration scenarios', () => {\r\n    it('Bulgarian user can see products from all zones', () => {\r\n      const zones = getCompatibleZones('BG')\r\n      expect(zones).toContain('BG')\r\n      expect(zones).toContain('EU')\r\n      expect(zones).toContain('WW')\r\n    })\r\n    \r\n    it('German user can see EU and worldwide products', () => {\r\n      const zones = getCompatibleZones('DE')\r\n      expect(zones).not.toContain('BG')\r\n      expect(zones).toContain('EU')\r\n      expect(zones).toContain('WW')\r\n    })\r\n    \r\n    it('US user can only see worldwide products', () => {\r\n      const zones = getCompatibleZones('US')\r\n      expect(zones).not.toContain('BG')\r\n      expect(zones).not.toContain('EU')\r\n      expect(zones).toContain('WW')\r\n    })\r\n    \r\n    it('country name and zone are consistent', () => {\r\n      // Bulgaria\r\n      expect(getCountryName('BG')).toBe('Bulgaria')\r\n      expect(getZoneForCountry('BG')).toBe('BG')\r\n      \r\n      // Germany (EU)\r\n      expect(getCountryName('DE')).toBe('Germany')\r\n      expect(getZoneForCountry('DE')).toBe('EU')\r\n    })\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\guest-sell-cta.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\hooks\\use-badges.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\hooks\\use-geo-welcome.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\hooks\\use-mobile.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\hooks\\use-product-search.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'waitFor' is defined but never used.","line":2,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":34,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"waitFor"},"fix":{"range":[98,107],"text":""},"desc":"Remove unused variable \"waitFor\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'React' is defined but never used.","line":3,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":18,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"React"},"fix":{"range":[141,171],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, expect, it, beforeEach, afterEach, vi } from 'vitest'\r\nimport { renderHook, act, waitFor } from '@testing-library/react'\r\nimport * as React from 'react'\r\n\r\n// We need to mock next-intl before importing the hook\r\nvi.mock('next-intl', () => ({\r\n  useLocale: vi.fn(() => 'en')\r\n}))\r\n\r\n// Import after mocking\r\nimport { useProductSearch, type SearchProduct } from '@/hooks/use-product-search'\r\n\r\n// Mock global fetch\r\nconst mockFetch = vi.fn()\r\n\r\ndescribe('hooks/use-product-search', () => {\r\n  const STORAGE_KEYS = {\r\n    recentSearches: 'recentSearches',\r\n    recentProducts: 'recentSearchedProducts'\r\n  }\r\n  \r\n  let mockStorage: Record<string, string> = {}\r\n  \r\n  beforeEach(() => {\r\n    mockStorage = {}\r\n    \r\n    vi.stubGlobal('fetch', mockFetch)\r\n    mockFetch.mockReset()\r\n    \r\n    vi.spyOn(Storage.prototype, 'getItem').mockImplementation((key: string) => {\r\n      return mockStorage[key] ?? null\r\n    })\r\n    \r\n    vi.spyOn(Storage.prototype, 'setItem').mockImplementation((key: string, value: string) => {\r\n      mockStorage[key] = value\r\n    })\r\n    \r\n    vi.spyOn(Storage.prototype, 'removeItem').mockImplementation((key: string) => {\r\n      delete mockStorage[key]\r\n    })\r\n    \r\n    vi.useFakeTimers()\r\n  })\r\n  \r\n  afterEach(() => {\r\n    vi.unstubAllGlobals()\r\n    vi.restoreAllMocks()\r\n    vi.useRealTimers()\r\n  })\r\n  \r\n  const createMockProduct = (id: string): SearchProduct => ({\r\n    id,\r\n    title: `Product ${id}`,\r\n    price: 29.99,\r\n    images: [`/images/${id}.jpg`],\r\n    slug: `product-${id}`,\r\n    storeSlug: `store-${id}`\r\n  })\r\n  \r\n  describe('initial state', () => {\r\n    it('returns initial empty state', () => {\r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      expect(result.current.query).toBe('')\r\n      expect(result.current.products).toEqual([])\r\n      expect(result.current.isSearching).toBe(false)\r\n      expect(result.current.recentSearches).toEqual([])\r\n      expect(result.current.recentProducts).toEqual([])\r\n      expect(result.current.minSearchLength).toBe(2)\r\n    })\r\n    \r\n    it('provides trending searches based on locale', () => {\r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      expect(result.current.trendingSearches).toContain('Black Friday deals')\r\n      expect(result.current.trendingSearches).toContain('iPhone 15 Pro')\r\n    })\r\n    \r\n    it('accepts custom maxResults parameter', () => {\r\n      const { result } = renderHook(() => useProductSearch(5))\r\n      // Hook should work with custom max results\r\n      expect(result.current.products).toEqual([])\r\n    })\r\n  })\r\n  \r\n  describe('query and setQuery', () => {\r\n    it('updates query via setQuery', () => {\r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.setQuery('test')\r\n      })\r\n      \r\n      expect(result.current.query).toBe('test')\r\n    })\r\n    \r\n    it('clears query and products via clearQuery', () => {\r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.setQuery('test')\r\n      })\r\n      \r\n      act(() => {\r\n        result.current.clearQuery()\r\n      })\r\n      \r\n      expect(result.current.query).toBe('')\r\n      expect(result.current.products).toEqual([])\r\n    })\r\n  })\r\n  \r\n  describe('debounced search', () => {\r\n    it('does not search when query length is below minimum', async () => {\r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.setQuery('a') // Only 1 character\r\n      })\r\n      \r\n      // Advance past debounce\r\n      act(() => {\r\n        vi.advanceTimersByTime(400)\r\n      })\r\n      \r\n      expect(mockFetch).not.toHaveBeenCalled()\r\n    })\r\n    \r\n    it('searches after debounce delay', async () => {\r\n      mockFetch.mockResolvedValueOnce({\r\n        ok: true,\r\n        json: async () => ({ products: [createMockProduct('1')] })\r\n      })\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.setQuery('phone')\r\n      })\r\n      \r\n      // Not searched immediately\r\n      expect(mockFetch).not.toHaveBeenCalled()\r\n      \r\n      // Advance past debounce (300ms)\r\n      await act(async () => {\r\n        vi.advanceTimersByTime(350)\r\n      })\r\n      \r\n      expect(mockFetch).toHaveBeenCalledWith(\r\n        expect.stringContaining('/api/products/search?q=phone'),\r\n        expect.objectContaining({ signal: expect.any(AbortSignal) })\r\n      )\r\n    })\r\n    \r\n    it('cancels previous search when query changes', async () => {\r\n      mockFetch.mockResolvedValue({\r\n        ok: true,\r\n        json: async () => ({ products: [] })\r\n      })\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.setQuery('phone')\r\n      })\r\n      \r\n      act(() => {\r\n        vi.advanceTimersByTime(100)\r\n      })\r\n      \r\n      act(() => {\r\n        result.current.setQuery('laptop')\r\n      })\r\n      \r\n      await act(async () => {\r\n        vi.advanceTimersByTime(350)\r\n      })\r\n      \r\n      // Should only search for 'laptop' (final query)\r\n      const calls = mockFetch.mock.calls\r\n      const lastCall = calls[calls.length - 1]\r\n      expect(lastCall[0]).toContain('q=laptop')\r\n    })\r\n    \r\n    it('handles search API error gracefully', async () => {\r\n      mockFetch.mockResolvedValueOnce({\r\n        ok: false,\r\n        status: 500\r\n      })\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.setQuery('phone')\r\n      })\r\n      \r\n      await act(async () => {\r\n        vi.advanceTimersByTime(350)\r\n      })\r\n      \r\n      expect(result.current.products).toEqual([])\r\n      expect(result.current.isSearching).toBe(false)\r\n    })\r\n  })\r\n  \r\n  describe('recent searches', () => {\r\n    it('loads recent searches from localStorage on mount', () => {\r\n      mockStorage[STORAGE_KEYS.recentSearches] = JSON.stringify(['phone', 'laptop'])\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      expect(result.current.recentSearches).toEqual(['phone', 'laptop'])\r\n    })\r\n    \r\n    it('saves search to recent searches', () => {\r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.saveSearch('phone')\r\n      })\r\n      \r\n      expect(result.current.recentSearches).toContain('phone')\r\n      expect(JSON.parse(mockStorage[STORAGE_KEYS.recentSearches])).toContain('phone')\r\n    })\r\n    \r\n    it('does not save empty or whitespace-only searches', () => {\r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.saveSearch('')\r\n        result.current.saveSearch('   ')\r\n      })\r\n      \r\n      expect(result.current.recentSearches).toEqual([])\r\n    })\r\n    \r\n    it('moves duplicate search to front', () => {\r\n      mockStorage[STORAGE_KEYS.recentSearches] = JSON.stringify(['laptop', 'phone', 'tablet'])\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.saveSearch('phone')\r\n      })\r\n      \r\n      expect(result.current.recentSearches[0]).toBe('phone')\r\n    })\r\n    \r\n    it('limits recent searches to MAX_RECENT_SEARCHES (5)', () => {\r\n      mockStorage[STORAGE_KEYS.recentSearches] = JSON.stringify([\r\n        'one', 'two', 'three', 'four', 'five'\r\n      ])\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.saveSearch('six')\r\n      })\r\n      \r\n      expect(result.current.recentSearches).toHaveLength(5)\r\n      expect(result.current.recentSearches[0]).toBe('six')\r\n      expect(result.current.recentSearches).not.toContain('five')\r\n    })\r\n    \r\n    it('clears all recent searches', () => {\r\n      mockStorage[STORAGE_KEYS.recentSearches] = JSON.stringify(['phone', 'laptop'])\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.clearRecentSearches()\r\n      })\r\n      \r\n      expect(result.current.recentSearches).toEqual([])\r\n      expect(mockStorage[STORAGE_KEYS.recentSearches]).toBeUndefined()\r\n    })\r\n  })\r\n  \r\n  describe('recent products', () => {\r\n    it('loads recent products from localStorage on mount', () => {\r\n      const products = [\r\n        { id: '1', title: 'Product 1', price: 29.99, image: '/img.jpg', slug: 'p1', searchedAt: Date.now() }\r\n      ]\r\n      mockStorage[STORAGE_KEYS.recentProducts] = JSON.stringify(products)\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      expect(result.current.recentProducts).toHaveLength(1)\r\n      expect(result.current.recentProducts[0].id).toBe('1')\r\n    })\r\n    \r\n    it('saves product to recent products', () => {\r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.saveProduct(createMockProduct('test'))\r\n      })\r\n      \r\n      expect(result.current.recentProducts).toHaveLength(1)\r\n      expect(result.current.recentProducts[0].id).toBe('test')\r\n      expect(result.current.recentProducts[0].searchedAt).toBeDefined()\r\n    })\r\n    \r\n    it('moves duplicate product to front with updated timestamp', () => {\r\n      const products = [\r\n        { id: '1', title: 'Product 1', price: 10, image: null, slug: 'p1', searchedAt: 1000 },\r\n        { id: '2', title: 'Product 2', price: 20, image: null, slug: 'p2', searchedAt: 2000 }\r\n      ]\r\n      mockStorage[STORAGE_KEYS.recentProducts] = JSON.stringify(products)\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.saveProduct(createMockProduct('1'))\r\n      })\r\n      \r\n      expect(result.current.recentProducts[0].id).toBe('1')\r\n      expect(result.current.recentProducts[0].searchedAt).toBeGreaterThan(1000)\r\n    })\r\n    \r\n    it('limits recent products to MAX_RECENT_PRODUCTS (6)', () => {\r\n      const products = Array.from({ length: 6 }, (_, i) => ({\r\n        id: `${i}`, title: `Product ${i}`, price: 10, image: null, slug: `p${i}`, searchedAt: i * 1000\r\n      }))\r\n      mockStorage[STORAGE_KEYS.recentProducts] = JSON.stringify(products)\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.saveProduct(createMockProduct('new'))\r\n      })\r\n      \r\n      expect(result.current.recentProducts).toHaveLength(6)\r\n      expect(result.current.recentProducts[0].id).toBe('new')\r\n    })\r\n    \r\n    it('clears all recent products', () => {\r\n      mockStorage[STORAGE_KEYS.recentProducts] = JSON.stringify([\r\n        { id: '1', title: 'Product 1', price: 10, image: null, slug: 'p1', searchedAt: 1000 }\r\n      ])\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      act(() => {\r\n        result.current.clearRecentProducts()\r\n      })\r\n      \r\n      expect(result.current.recentProducts).toEqual([])\r\n      expect(mockStorage[STORAGE_KEYS.recentProducts]).toBeUndefined()\r\n    })\r\n  })\r\n  \r\n  describe('formatPrice', () => {\r\n    it('formats price for English locale', () => {\r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      const formatted = result.current.formatPrice(29.99)\r\n      \r\n      expect(formatted).toContain('29')\r\n      expect(formatted).toContain('99')\r\n    })\r\n    \r\n    it('handles zero price', () => {\r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      const formatted = result.current.formatPrice(0)\r\n      \r\n      expect(formatted).toContain('0')\r\n    })\r\n    \r\n    it('handles large prices', () => {\r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      const formatted = result.current.formatPrice(1234567.89)\r\n      \r\n      expect(formatted).toBeDefined()\r\n      expect(typeof formatted).toBe('string')\r\n    })\r\n  })\r\n  \r\n  describe('localStorage error handling', () => {\r\n    it('handles corrupted recentSearches in localStorage', () => {\r\n      mockStorage[STORAGE_KEYS.recentSearches] = 'not valid json'\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      // Should not crash and return empty array\r\n      expect(result.current.recentSearches).toEqual([])\r\n    })\r\n    \r\n    it('handles non-array recentSearches in localStorage', () => {\r\n      mockStorage[STORAGE_KEYS.recentSearches] = JSON.stringify({ not: 'an array' })\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      expect(result.current.recentSearches).toEqual([])\r\n    })\r\n    \r\n    it('handles corrupted recentProducts in localStorage', () => {\r\n      mockStorage[STORAGE_KEYS.recentProducts] = 'not valid json'\r\n      \r\n      const { result } = renderHook(() => useProductSearch())\r\n      \r\n      expect(result.current.recentProducts).toEqual([])\r\n    })\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\hooks\\use-recently-viewed.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\hooks\\use-toast.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'toast' is defined but never used.","line":3,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"toast"},"fix":{"range":[149,156],"text":""},"desc":"Remove unused variable \"toast\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, expect, it, beforeEach, afterEach, vi } from 'vitest'\r\nimport { renderHook, act } from '@testing-library/react'\r\nimport { useToast, toast, reducer } from '@/hooks/use-toast'\r\n\r\ndescribe('hooks/use-toast', () => {\r\n  beforeEach(() => {\r\n    vi.useFakeTimers()\r\n  })\r\n  \r\n  afterEach(() => {\r\n    vi.useRealTimers()\r\n  })\r\n  \r\n  describe('reducer', () => {\r\n    const initialState = { toasts: [] }\r\n    \r\n    describe('ADD_TOAST', () => {\r\n      it('adds a toast to empty state', () => {\r\n        const newToast = { id: '1', title: 'Test', open: true }\r\n        const result = reducer(initialState, {\r\n          type: 'ADD_TOAST',\r\n          toast: newToast\r\n        })\r\n        \r\n        expect(result.toasts).toHaveLength(1)\r\n        expect(result.toasts[0]).toEqual(newToast)\r\n      })\r\n      \r\n      it('prepends new toast to existing toasts', () => {\r\n        const existingState = {\r\n          toasts: [{ id: '1', title: 'First', open: true }]\r\n        }\r\n        const newToast = { id: '2', title: 'Second', open: true }\r\n        \r\n        const result = reducer(existingState, {\r\n          type: 'ADD_TOAST',\r\n          toast: newToast\r\n        })\r\n        \r\n        expect(result.toasts).toHaveLength(1) // Due to TOAST_LIMIT = 1\r\n        expect(result.toasts[0].id).toBe('2')\r\n      })\r\n      \r\n      it('respects TOAST_LIMIT of 1', () => {\r\n        const state = { toasts: [] }\r\n        let newState = reducer(state, {\r\n          type: 'ADD_TOAST',\r\n          toast: { id: '1', title: 'First', open: true }\r\n        })\r\n        newState = reducer(newState, {\r\n          type: 'ADD_TOAST',\r\n          toast: { id: '2', title: 'Second', open: true }\r\n        })\r\n        \r\n        expect(newState.toasts).toHaveLength(1)\r\n        expect(newState.toasts[0].id).toBe('2')\r\n      })\r\n    })\r\n    \r\n    describe('UPDATE_TOAST', () => {\r\n      it('updates existing toast by id', () => {\r\n        const state = {\r\n          toasts: [{ id: '1', title: 'Original', open: true }]\r\n        }\r\n        \r\n        const result = reducer(state, {\r\n          type: 'UPDATE_TOAST',\r\n          toast: { id: '1', title: 'Updated' }\r\n        })\r\n        \r\n        expect(result.toasts[0].title).toBe('Updated')\r\n        expect(result.toasts[0].open).toBe(true) // Preserved\r\n      })\r\n      \r\n      it('does not update non-matching toasts', () => {\r\n        const state = {\r\n          toasts: [{ id: '1', title: 'Original', open: true }]\r\n        }\r\n        \r\n        const result = reducer(state, {\r\n          type: 'UPDATE_TOAST',\r\n          toast: { id: '999', title: 'Updated' }\r\n        })\r\n        \r\n        expect(result.toasts[0].title).toBe('Original')\r\n      })\r\n    })\r\n    \r\n    describe('DISMISS_TOAST', () => {\r\n      it('sets open to false for specific toast', () => {\r\n        const state = {\r\n          toasts: [{ id: '1', title: 'Test', open: true }]\r\n        }\r\n        \r\n        const result = reducer(state, {\r\n          type: 'DISMISS_TOAST',\r\n          toastId: '1'\r\n        })\r\n        \r\n        expect(result.toasts[0].open).toBe(false)\r\n      })\r\n      \r\n      it('sets open to false for all toasts when no id provided', () => {\r\n        const state = {\r\n          toasts: [\r\n            { id: '1', title: 'First', open: true },\r\n            { id: '2', title: 'Second', open: true }\r\n          ]\r\n        }\r\n        \r\n        const result = reducer(state, {\r\n          type: 'DISMISS_TOAST',\r\n          toastId: undefined\r\n        })\r\n        \r\n        expect(result.toasts.every(t => t.open === false)).toBe(true)\r\n      })\r\n    })\r\n    \r\n    describe('REMOVE_TOAST', () => {\r\n      it('removes specific toast by id', () => {\r\n        const state = {\r\n          toasts: [\r\n            { id: '1', title: 'First', open: false },\r\n            { id: '2', title: 'Second', open: true }\r\n          ]\r\n        }\r\n        \r\n        const result = reducer(state, {\r\n          type: 'REMOVE_TOAST',\r\n          toastId: '1'\r\n        })\r\n        \r\n        expect(result.toasts).toHaveLength(1)\r\n        expect(result.toasts[0].id).toBe('2')\r\n      })\r\n      \r\n      it('removes all toasts when no id provided', () => {\r\n        const state = {\r\n          toasts: [\r\n            { id: '1', title: 'First', open: false },\r\n            { id: '2', title: 'Second', open: false }\r\n          ]\r\n        }\r\n        \r\n        const result = reducer(state, {\r\n          type: 'REMOVE_TOAST',\r\n          toastId: undefined\r\n        })\r\n        \r\n        expect(result.toasts).toHaveLength(0)\r\n      })\r\n    })\r\n  })\r\n  \r\n  describe('useToast hook', () => {\r\n    it('returns initial empty state', () => {\r\n      const { result } = renderHook(() => useToast())\r\n      \r\n      expect(result.current.toasts).toEqual([])\r\n      expect(typeof result.current.toast).toBe('function')\r\n      expect(typeof result.current.dismiss).toBe('function')\r\n    })\r\n    \r\n    it('adds toast via toast function', () => {\r\n      const { result } = renderHook(() => useToast())\r\n      \r\n      act(() => {\r\n        result.current.toast({ title: 'Test Toast' })\r\n      })\r\n      \r\n      expect(result.current.toasts).toHaveLength(1)\r\n      expect(result.current.toasts[0].title).toBe('Test Toast')\r\n      expect(result.current.toasts[0].open).toBe(true)\r\n    })\r\n    \r\n    it('dismisses toast by id', () => {\r\n      const { result } = renderHook(() => useToast())\r\n      \r\n      let toastId: string\r\n      act(() => {\r\n        const { id } = result.current.toast({ title: 'Test' })\r\n        toastId = id\r\n      })\r\n      \r\n      act(() => {\r\n        result.current.dismiss(toastId!)\r\n      })\r\n      \r\n      expect(result.current.toasts[0]?.open).toBe(false)\r\n    })\r\n    \r\n    it('dismisses all toasts when no id provided', () => {\r\n      const { result } = renderHook(() => useToast())\r\n      \r\n      act(() => {\r\n        result.current.toast({ title: 'First' })\r\n      })\r\n      \r\n      act(() => {\r\n        result.current.dismiss()\r\n      })\r\n      \r\n      expect(result.current.toasts.every(t => t.open === false)).toBe(true)\r\n    })\r\n  })\r\n  \r\n  describe('toast function', () => {\r\n    it('returns update and dismiss methods', () => {\r\n      const { result } = renderHook(() => useToast())\r\n      \r\n      let toastMethods: { id: string; update: (props: unknown) => void; dismiss: () => void }\r\n      act(() => {\r\n        toastMethods = result.current.toast({ title: 'Test' })\r\n      })\r\n      \r\n      expect(toastMethods!.id).toBeDefined()\r\n      expect(typeof toastMethods!.update).toBe('function')\r\n      expect(typeof toastMethods!.dismiss).toBe('function')\r\n    })\r\n    \r\n    it('generates unique ids for each toast', () => {\r\n      const { result } = renderHook(() => useToast())\r\n      \r\n      const ids: string[] = []\r\n      act(() => {\r\n        ids.push(result.current.toast({ title: 'First' }).id)\r\n        ids.push(result.current.toast({ title: 'Second' }).id)\r\n        ids.push(result.current.toast({ title: 'Third' }).id)\r\n      })\r\n      \r\n      const uniqueIds = new Set(ids)\r\n      expect(uniqueIds.size).toBe(3)\r\n    })\r\n    \r\n    it('update method updates toast properties', () => {\r\n      const { result } = renderHook(() => useToast())\r\n      \r\n      let toastMethods: { id: string; update: (props: { title?: string }) => void; dismiss: () => void }\r\n      act(() => {\r\n        toastMethods = result.current.toast({ title: 'Original' })\r\n      })\r\n      \r\n      act(() => {\r\n        toastMethods!.update({ title: 'Updated' })\r\n      })\r\n      \r\n      expect(result.current.toasts[0]?.title).toBe('Updated')\r\n    })\r\n    \r\n    it('dismiss method closes the toast', () => {\r\n      const { result } = renderHook(() => useToast())\r\n      \r\n      let toastMethods: { id: string; update: (props: unknown) => void; dismiss: () => void }\r\n      act(() => {\r\n        toastMethods = result.current.toast({ title: 'Test' })\r\n      })\r\n      \r\n      act(() => {\r\n        toastMethods!.dismiss()\r\n      })\r\n      \r\n      expect(result.current.toasts[0]?.open).toBe(false)\r\n    })\r\n  })\r\n  \r\n  describe('toast with description and action', () => {\r\n    it('includes description in toast', () => {\r\n      const { result } = renderHook(() => useToast())\r\n      \r\n      act(() => {\r\n        result.current.toast({\r\n          title: 'Title',\r\n          description: 'This is a description'\r\n        })\r\n      })\r\n      \r\n      expect(result.current.toasts[0].description).toBe('This is a description')\r\n    })\r\n    \r\n    it('includes action element in toast', () => {\r\n      const { result } = renderHook(() => useToast())\r\n      \r\n      const mockAction = { altText: 'Undo' }\r\n      act(() => {\r\n        result.current.toast({\r\n          title: 'Title',\r\n          action: mockAction as unknown as React.ReactElement\r\n        })\r\n      })\r\n      \r\n      expect(result.current.toasts[0].action).toBe(mockAction)\r\n    })\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\i18n-messages-parity.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\image-utils.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\normalize-image-url.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\order-status.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'OrderItemStatus' is defined but never used.","line":7,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":23,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"OrderItemStatus"},"fix":{"range":[156,180],"text":""},"desc":"Remove unused variable \"OrderItemStatus\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, expect, it } from 'vitest'\nimport {\n  canSellerUpdateStatus,\n  getNextStatusOptions,\n  getOrderStatusFromItems,\n  SHIPPING_CARRIER_VALUES,\n  type OrderItemStatus,\n} from '@/lib/order-status'\n\ndescribe('lib/order-status', () => {\n  describe('getOrderStatusFromItems', () => {\n    it('returns fallback for empty list', () => {\n      expect(getOrderStatusFromItems([], 'pending')).toBe('pending')\n      expect(getOrderStatusFromItems([], 'paid')).toBe('paid')\n    })\n\n    it('returns cancelled when all items are cancelled', () => {\n      expect(getOrderStatusFromItems(['cancelled', 'cancelled'])).toBe('cancelled')\n    })\n\n    it('returns delivered when all active items delivered', () => {\n      expect(getOrderStatusFromItems(['delivered', 'delivered'])).toBe('delivered')\n    })\n\n    it('returns shipped when any item shipped/delivered', () => {\n      expect(getOrderStatusFromItems(['processing', 'shipped'])).toBe('shipped')\n      expect(getOrderStatusFromItems(['processing', 'delivered'])).toBe('shipped')\n    })\n\n    it('returns processing when any item processing/received', () => {\n      expect(getOrderStatusFromItems(['pending', 'received'])).toBe('processing')\n      expect(getOrderStatusFromItems(['pending', 'processing'])).toBe('processing')\n    })\n  })\n\r\n  describe('canSellerUpdateStatus', () => {\r\n    it('returns true for updateable statuses', () => {\r\n      expect(canSellerUpdateStatus('pending')).toBe(true)\r\n      expect(canSellerUpdateStatus('received')).toBe(true)\r\n      expect(canSellerUpdateStatus('processing')).toBe(true)\r\n      expect(canSellerUpdateStatus('shipped')).toBe(true)\r\n    })\r\n\r\n    it('returns false for terminal statuses', () => {\r\n      expect(canSellerUpdateStatus('delivered')).toBe(false)\r\n      expect(canSellerUpdateStatus('cancelled')).toBe(false)\r\n    })\r\n  })\r\n\r\n  describe('getNextStatusOptions', () => {\n    it('returns correct next options for pending', () => {\r\n      const options = getNextStatusOptions('pending')\r\n      expect(options).toContain('received')\r\n    })\r\n\r\n    it('returns correct next options for received', () => {\r\n      const options = getNextStatusOptions('received')\r\n      expect(options).toContain('processing')\r\n    })\r\n\r\n    it('returns correct next options for processing', () => {\r\n      const options = getNextStatusOptions('processing')\r\n      expect(options).toContain('shipped')\r\n    })\r\n\r\n    it('returns correct next options for shipped', () => {\r\n      const options = getNextStatusOptions('shipped')\r\n      expect(options).toContain('delivered')\r\n    })\r\n\r\n    it('returns empty array for delivered (no next status)', () => {\r\n      const options = getNextStatusOptions('delivered')\r\n      expect(options).toEqual([])\r\n    })\r\n\r\n    it('returns empty array for cancelled', () => {\n      const options = getNextStatusOptions('cancelled')\n      expect(options).toEqual([])\n    })\n  })\n\n  describe('SHIPPING_CARRIER_VALUES', () => {\n    it('contains the expected values', () => {\n      expect(SHIPPING_CARRIER_VALUES).toContain('speedy')\n      expect(SHIPPING_CARRIER_VALUES).toContain('other')\n    })\n\n    it('does not contain duplicates', () => {\n      expect(new Set(SHIPPING_CARRIER_VALUES).size).toBe(SHIPPING_CARRIER_VALUES.length)\n    })\n  })\n})\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\product-card-hero-attributes.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\product-card-mobile-rules.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\product-card-price.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\product-price.test.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\products-normalize.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\proxy-matcher.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\proxy-middleware.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\safe-json.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\shipping.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ShippingRegion' is defined but never used.","line":10,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ShippingRegion"},"fix":{"range":[214,238],"text":""},"desc":"Remove unused variable \"ShippingRegion\"."}]},{"ruleId":"unicorn/no-useless-undefined","severity":1,"message":"Do not use useless `undefined`.","line":292,"column":34,"nodeType":"Identifier","messageId":"no-useless-undefined","endLine":292,"endColumn":43,"fix":{"range":[10108,10117],"text":""}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { describe, expect, it } from 'vitest'\r\nimport {\r\n  getShippingRegion,\r\n  getSellerCategory,\r\n  getDeliveryEstimate,\r\n  productShipsToRegion,\r\n  getShippingFilter,\r\n  parseShippingRegion,\r\n  SHIPPING_REGIONS,\r\n  type ShippingRegion\r\n} from '@/lib/shipping'\r\n\r\ndescribe('lib/shipping', () => {\r\n  describe('getShippingRegion', () => {\r\n    it('returns BG for Bulgaria', () => {\r\n      expect(getShippingRegion('BG')).toBe('BG')\r\n      expect(getShippingRegion('bg')).toBe('BG') // Case insensitive\r\n    })\r\n    \r\n    it('returns UK for United Kingdom', () => {\r\n      expect(getShippingRegion('GB')).toBe('UK')\r\n      expect(getShippingRegion('UK')).toBe('UK')\r\n    })\r\n    \r\n    it('returns EU for European countries', () => {\r\n      const euCountries = ['DE', 'FR', 'IT', 'ES', 'NL', 'PL', 'AT', 'BE', 'SE', 'FI']\r\n      for (const country of euCountries) {\r\n        expect(getShippingRegion(country)).toBe('EU')\r\n      }\r\n    })\r\n    \r\n    it('returns US for United States', () => {\r\n      expect(getShippingRegion('US')).toBe('US')\r\n    })\r\n    \r\n    it('returns WW for unknown countries', () => {\r\n      expect(getShippingRegion('XX')).toBe('WW')\r\n      expect(getShippingRegion('AU')).toBe('WW')\r\n      expect(getShippingRegion('JP')).toBe('WW')\r\n    })\r\n    \r\n    it('handles empty string', () => {\r\n      expect(getShippingRegion('')).toBe('WW')\r\n    })\r\n  })\r\n  \r\n  describe('getSellerCategory', () => {\r\n    it('returns BG for Bulgarian sellers', () => {\r\n      expect(getSellerCategory('BG')).toBe('BG')\r\n    })\r\n    \r\n    it('returns UK for UK sellers', () => {\r\n      expect(getSellerCategory('GB')).toBe('UK')\r\n      expect(getSellerCategory('UK')).toBe('UK')\r\n    })\r\n    \r\n    it('returns DE (EU representative) for EU sellers', () => {\r\n      const euCountries = ['DE', 'FR', 'IT', 'ES', 'NL', 'PL', 'AT', 'BE']\r\n      for (const country of euCountries) {\r\n        expect(getSellerCategory(country)).toBe('DE')\r\n      }\r\n    })\r\n    \r\n    it('returns US for American sellers', () => {\r\n      expect(getSellerCategory('US')).toBe('US')\r\n    })\r\n    \r\n    it('returns OTHER for unknown countries', () => {\r\n      expect(getSellerCategory('AU')).toBe('OTHER')\r\n      expect(getSellerCategory('JP')).toBe('OTHER')\r\n      expect(getSellerCategory('XX')).toBe('OTHER')\r\n    })\r\n  })\r\n  \r\n  describe('getDeliveryEstimate', () => {\r\n    describe('Bulgarian seller', () => {\r\n      it('ships to Bulgaria in 1-3 days', () => {\r\n        const estimate = getDeliveryEstimate('BG', 'BG')\r\n        expect(estimate.minDays).toBe(1)\r\n        expect(estimate.maxDays).toBe(3)\r\n        expect(estimate.label).toBe('1-3 days')\r\n        expect(estimate.labelBg).toBe('1-3 ╨┤╨╜╨╕')\r\n      })\r\n      \r\n      it('ships to UK in 5-12 days', () => {\r\n        const estimate = getDeliveryEstimate('BG', 'UK')\r\n        expect(estimate.minDays).toBe(5)\r\n        expect(estimate.maxDays).toBe(12)\r\n      })\r\n      \r\n      it('ships to EU in 5-10 days', () => {\r\n        const estimate = getDeliveryEstimate('BG', 'EU')\r\n        expect(estimate.minDays).toBe(5)\r\n        expect(estimate.maxDays).toBe(10)\r\n      })\r\n      \r\n      it('ships to US in 10-20 days', () => {\r\n        const estimate = getDeliveryEstimate('BG', 'US')\r\n        expect(estimate.minDays).toBe(10)\r\n        expect(estimate.maxDays).toBe(20)\r\n      })\r\n      \r\n      it('ships worldwide in 15-30 days', () => {\r\n        const estimate = getDeliveryEstimate('BG', 'WW')\r\n        expect(estimate.minDays).toBe(15)\r\n        expect(estimate.maxDays).toBe(30)\r\n      })\r\n    })\r\n    \r\n    describe('US seller', () => {\r\n      it('ships domestically in 1-5 days', () => {\r\n        const estimate = getDeliveryEstimate('US', 'US')\r\n        expect(estimate.minDays).toBe(1)\r\n        expect(estimate.maxDays).toBe(5)\r\n      })\r\n      \r\n      it('ships to Bulgaria in 10-20 days', () => {\r\n        const estimate = getDeliveryEstimate('US', 'BG')\r\n        expect(estimate.minDays).toBe(10)\r\n        expect(estimate.maxDays).toBe(20)\r\n      })\r\n    })\r\n    \r\n    describe('UK seller', () => {\r\n      it('ships domestically in 1-3 days', () => {\r\n        const estimate = getDeliveryEstimate('GB', 'UK')\r\n        expect(estimate.minDays).toBe(1)\r\n        expect(estimate.maxDays).toBe(3)\r\n      })\r\n    })\r\n    \r\n    describe('EU seller (e.g., Germany)', () => {\r\n      it('ships within EU in 2-5 days', () => {\r\n        const estimate = getDeliveryEstimate('DE', 'EU')\r\n        expect(estimate.minDays).toBe(2)\r\n        expect(estimate.maxDays).toBe(5)\r\n      })\r\n    })\r\n    \r\n    describe('OTHER country seller', () => {\r\n      it('has longer delivery times', () => {\r\n        const estimate = getDeliveryEstimate('AU', 'US')\r\n        expect(estimate.minDays).toBe(7)\r\n        expect(estimate.maxDays).toBe(21)\r\n      })\r\n    })\r\n  })\r\n  \r\n  describe('productShipsToRegion', () => {\r\n    const createProduct = (flags: Partial<{\r\n      ships_to_bulgaria: boolean | null\r\n      ships_to_uk: boolean | null\r\n      ships_to_europe: boolean | null\r\n      ships_to_usa: boolean | null\r\n      ships_to_worldwide: boolean | null\r\n      pickup_only: boolean | null\r\n    }>) => ({\r\n      ships_to_bulgaria: null,\r\n      ships_to_uk: null,\r\n      ships_to_europe: null,\r\n      ships_to_usa: null,\r\n      ships_to_worldwide: null,\r\n      pickup_only: null,\r\n      ...flags\r\n    })\r\n    \r\n    it('worldwide region always returns true', () => {\r\n      const product = createProduct({})\r\n      expect(productShipsToRegion(product, 'WW')).toBe(true)\r\n    })\r\n    \r\n    it('pickup only products dont ship anywhere', () => {\r\n      const product = createProduct({\r\n        pickup_only: true,\r\n        ships_to_worldwide: true\r\n      })\r\n      expect(productShipsToRegion(product, 'BG')).toBe(false)\r\n      expect(productShipsToRegion(product, 'US')).toBe(false)\r\n    })\r\n    \r\n    it('worldwide shipping covers all regions', () => {\r\n      const product = createProduct({ ships_to_worldwide: true })\r\n      \r\n      expect(productShipsToRegion(product, 'BG')).toBe(true)\r\n      expect(productShipsToRegion(product, 'UK')).toBe(true)\r\n      expect(productShipsToRegion(product, 'EU')).toBe(true)\r\n      expect(productShipsToRegion(product, 'US')).toBe(true)\r\n    })\r\n    \r\n    describe('Bulgaria region (BG)', () => {\r\n      it('ships if ships_to_bulgaria is true', () => {\r\n        const product = createProduct({ ships_to_bulgaria: true })\r\n        expect(productShipsToRegion(product, 'BG')).toBe(true)\r\n      })\r\n      \r\n      it('ships if ships_to_europe is true (BG is in EU)', () => {\r\n        const product = createProduct({ ships_to_europe: true })\r\n        expect(productShipsToRegion(product, 'BG')).toBe(true)\r\n      })\r\n      \r\n      it('does not ship if only ships_to_usa', () => {\r\n        const product = createProduct({ ships_to_usa: true })\r\n        expect(productShipsToRegion(product, 'BG')).toBe(false)\r\n      })\r\n    })\r\n    \r\n    describe('UK region', () => {\r\n      it('ships if ships_to_uk is true', () => {\r\n        const product = createProduct({ ships_to_uk: true })\r\n        expect(productShipsToRegion(product, 'UK')).toBe(true)\r\n      })\r\n      \r\n      it('ships if ships_to_europe is true (some EU sellers ship to UK)', () => {\r\n        const product = createProduct({ ships_to_europe: true })\r\n        expect(productShipsToRegion(product, 'UK')).toBe(true)\r\n      })\r\n    })\r\n    \r\n    describe('EU region', () => {\r\n      it('ships if ships_to_europe is true', () => {\r\n        const product = createProduct({ ships_to_europe: true })\r\n        expect(productShipsToRegion(product, 'EU')).toBe(true)\r\n      })\r\n      \r\n      it('does not ship if only ships_to_bulgaria', () => {\r\n        const product = createProduct({ ships_to_bulgaria: true })\r\n        expect(productShipsToRegion(product, 'EU')).toBe(false)\r\n      })\r\n    })\r\n    \r\n    describe('US region', () => {\r\n      it('ships if ships_to_usa is true', () => {\r\n        const product = createProduct({ ships_to_usa: true })\r\n        expect(productShipsToRegion(product, 'US')).toBe(true)\r\n      })\r\n      \r\n      it('does not ship if only ships_to_europe', () => {\r\n        const product = createProduct({ ships_to_europe: true })\r\n        expect(productShipsToRegion(product, 'US')).toBe(false)\r\n      })\r\n    })\r\n  })\r\n  \r\n  describe('getShippingFilter', () => {\r\n    it('returns correct filter for BG buyers', () => {\r\n      const filter = getShippingFilter('BG')\r\n      expect(filter).toBe('ships_to_bulgaria.eq.true,ships_to_europe.eq.true,ships_to_worldwide.eq.true')\r\n    })\r\n    \r\n    it('returns correct filter for UK buyers', () => {\r\n      const filter = getShippingFilter('UK')\r\n      expect(filter).toBe('ships_to_uk.eq.true,ships_to_europe.eq.true,ships_to_worldwide.eq.true')\r\n    })\r\n    \r\n    it('returns correct filter for EU buyers', () => {\r\n      const filter = getShippingFilter('EU')\r\n      expect(filter).toBe('ships_to_europe.eq.true,ships_to_worldwide.eq.true')\r\n    })\r\n    \r\n    it('returns correct filter for US buyers', () => {\r\n      const filter = getShippingFilter('US')\r\n      expect(filter).toBe('ships_to_usa.eq.true,ships_to_worldwide.eq.true')\r\n    })\r\n    \r\n    it('returns empty string for WW (no filter)', () => {\r\n      const filter = getShippingFilter('WW')\r\n      expect(filter).toBe('')\r\n    })\r\n  })\r\n  \r\n  describe('parseShippingRegion', () => {\r\n    it('parses valid regions', () => {\r\n      expect(parseShippingRegion('BG')).toBe('BG')\r\n      expect(parseShippingRegion('UK')).toBe('UK')\r\n      expect(parseShippingRegion('EU')).toBe('EU')\r\n      expect(parseShippingRegion('US')).toBe('US')\r\n      expect(parseShippingRegion('WW')).toBe('WW')\r\n    })\r\n    \r\n    it('handles lowercase input', () => {\r\n      expect(parseShippingRegion('bg')).toBe('BG')\r\n      expect(parseShippingRegion('uk')).toBe('UK')\r\n    })\r\n    \r\n    it('maps GB to UK for backward compatibility', () => {\r\n      expect(parseShippingRegion('GB')).toBe('UK')\r\n      expect(parseShippingRegion('gb')).toBe('UK')\r\n    })\r\n    \r\n    it('returns WW for null/undefined', () => {\r\n      expect(parseShippingRegion(null)).toBe('WW')\r\n      expect(parseShippingRegion(undefined)).toBe('WW')\r\n    })\r\n    \r\n    it('returns WW for invalid input', () => {\r\n      expect(parseShippingRegion('invalid')).toBe('WW')\r\n      expect(parseShippingRegion('XX')).toBe('WW')\r\n    })\r\n    \r\n    it('returns WW for empty string', () => {\r\n      expect(parseShippingRegion('')).toBe('WW')\r\n    })\r\n  })\r\n  \r\n  describe('SHIPPING_REGIONS constant', () => {\r\n    it('has correct display names for all regions', () => {\r\n      expect(SHIPPING_REGIONS.BG.en).toBe('Bulgaria')\r\n      expect(SHIPPING_REGIONS.BG.bg).toBe('╨æ╤è╨╗╨│╨░╤Ç╨╕╤Å')\r\n      \r\n      expect(SHIPPING_REGIONS.UK.en).toBe('United Kingdom')\r\n      expect(SHIPPING_REGIONS.UK.bg).toBe('╨Æ╨╡╨╗╨╕╨║╨╛╨▒╤Ç╨╕╤é╨░╨╜╨╕╤Å')\r\n      \r\n      expect(SHIPPING_REGIONS.EU.en).toBe('Europe')\r\n      expect(SHIPPING_REGIONS.EU.bg).toBe('╨ò╨▓╤Ç╨╛╨┐╨░')\r\n      \r\n      expect(SHIPPING_REGIONS.US.en).toBe('United States')\r\n      expect(SHIPPING_REGIONS.US.bg).toBe('╨í╨É╨⌐')\r\n      \r\n      expect(SHIPPING_REGIONS.WW.en).toBe('Worldwide')\r\n      expect(SHIPPING_REGIONS.WW.bg).toBe('╨ƒ╨╛ ╤å╨╡╨╗╨╕╤Å ╤ü╨▓╤Å╤é')\r\n    })\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\stripe-locale.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SupportedLocale' is defined but never used.","line":8,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":23,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SupportedLocale"},"fix":{"range":[188,213],"text":""},"desc":"Remove unused variable \"SupportedLocale\"."}]},{"ruleId":"unicorn/no-useless-undefined","severity":1,"message":"Do not use useless `undefined`.","line":29,"column":30,"nodeType":"Identifier","messageId":"no-useless-undefined","endLine":29,"endColumn":39,"fix":{"range":[892,901],"text":""}},{"ruleId":"unicorn/no-useless-undefined","severity":1,"message":"Do not use useless `undefined`.","line":137,"column":46,"nodeType":"Identifier","messageId":"no-useless-undefined","endLine":137,"endColumn":55,"fix":{"range":[4239,4250],"text":""}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":2,"source":"import { describe, expect, it, vi, beforeEach, afterEach } from 'vitest'\r\nimport {\r\n  normalizeLocale,\r\n  getAppUrl,\r\n  buildLocaleUrl,\r\n  inferLocaleFromRequest,\r\n  inferLocaleFromHeaders,\r\n  type SupportedLocale,\r\n} from '@/lib/stripe-locale'\r\n\r\ndescribe('lib/stripe-locale', () => {\r\n  describe('normalizeLocale', () => {\r\n    it('returns \"bg\" when passed \"bg\"', () => {\r\n      expect(normalizeLocale('bg')).toBe('bg')\r\n    })\r\n\r\n    it('returns \"en\" when passed \"en\"', () => {\r\n      expect(normalizeLocale('en')).toBe('en')\r\n    })\r\n\r\n    it('defaults to \"en\" for unsupported locales', () => {\r\n      expect(normalizeLocale('de')).toBe('en')\r\n      expect(normalizeLocale('fr')).toBe('en')\r\n      expect(normalizeLocale('es')).toBe('en')\r\n    })\r\n\r\n    it('defaults to \"en\" for null/undefined/empty', () => {\r\n      expect(normalizeLocale(null)).toBe('en')\r\n      expect(normalizeLocale(undefined)).toBe('en')\r\n      expect(normalizeLocale('')).toBe('en')\r\n    })\r\n\r\n    it('defaults to \"en\" for non-string values', () => {\r\n      expect(normalizeLocale(123)).toBe('en')\r\n      expect(normalizeLocale({})).toBe('en')\r\n      expect(normalizeLocale([])).toBe('en')\r\n    })\r\n  })\r\n\r\n  describe('getAppUrl', () => {\r\n    const originalEnv = process.env\r\n\r\n    beforeEach(() => {\r\n      vi.resetModules()\r\n      process.env = { ...originalEnv }\r\n    })\r\n\r\n    afterEach(() => {\r\n      process.env = originalEnv\r\n    })\r\n\r\n    it('returns NEXT_PUBLIC_APP_URL when set', () => {\r\n      process.env.NEXT_PUBLIC_APP_URL = 'https://example.com'\r\n      process.env.NEXT_PUBLIC_SITE_URL = 'https://other.com'\r\n      expect(getAppUrl()).toBe('https://example.com')\r\n    })\r\n\r\n    it('falls back to NEXT_PUBLIC_SITE_URL', () => {\r\n      delete process.env.NEXT_PUBLIC_APP_URL\r\n      process.env.NEXT_PUBLIC_SITE_URL = 'https://site.com'\r\n      expect(getAppUrl()).toBe('https://site.com')\r\n    })\r\n\r\n    it('falls back to NEXT_PUBLIC_URL', () => {\r\n      delete process.env.NEXT_PUBLIC_APP_URL\r\n      delete process.env.NEXT_PUBLIC_SITE_URL\r\n      process.env.NEXT_PUBLIC_URL = 'https://url.com'\r\n      expect(getAppUrl()).toBe('https://url.com')\r\n    })\r\n\r\n    it('defaults to localhost:3000', () => {\r\n      delete process.env.NEXT_PUBLIC_APP_URL\r\n      delete process.env.NEXT_PUBLIC_SITE_URL\r\n      delete process.env.NEXT_PUBLIC_URL\r\n      expect(getAppUrl()).toBe('http://localhost:3000')\r\n    })\r\n\r\n    it('strips trailing slash', () => {\r\n      process.env.NEXT_PUBLIC_APP_URL = 'https://example.com/'\r\n      expect(getAppUrl()).toBe('https://example.com')\r\n    })\r\n  })\r\n\r\n  describe('buildLocaleUrl', () => {\r\n    const originalEnv = process.env\r\n\r\n    beforeEach(() => {\r\n      vi.resetModules()\r\n      process.env = { ...originalEnv }\r\n      process.env.NEXT_PUBLIC_APP_URL = 'https://treido.eu'\r\n    })\r\n\r\n    afterEach(() => {\r\n      process.env = originalEnv\r\n    })\r\n\r\n    it('builds URL with bg locale', () => {\r\n      expect(buildLocaleUrl('account/payments', 'bg')).toBe(\r\n        'https://treido.eu/bg/account/payments'\r\n      )\r\n    })\r\n\r\n    it('builds URL with en locale', () => {\r\n      expect(buildLocaleUrl('account/payments', 'en')).toBe(\r\n        'https://treido.eu/en/account/payments'\r\n      )\r\n    })\r\n\r\n    it('normalizes leading slash in path', () => {\r\n      expect(buildLocaleUrl('/account/payments', 'en')).toBe(\r\n        'https://treido.eu/en/account/payments'\r\n      )\r\n    })\r\n\r\n    it('appends query string when provided', () => {\r\n      expect(buildLocaleUrl('account/payments', 'en', 'setup=success')).toBe(\r\n        'https://treido.eu/en/account/payments?setup=success'\r\n      )\r\n    })\r\n\r\n    it('handles complex query strings', () => {\r\n      expect(buildLocaleUrl('checkout/success', 'bg', 'session_id=cs_123&ref=abc')).toBe(\r\n        'https://treido.eu/bg/checkout/success?session_id=cs_123&ref=abc'\r\n      )\r\n    })\r\n\r\n    it('normalizes unknown locale to en', () => {\r\n      expect(buildLocaleUrl('account/plans', 'de')).toBe(\r\n        'https://treido.eu/en/account/plans'\r\n      )\r\n    })\r\n\r\n    it('handles null/undefined locale', () => {\r\n      expect(buildLocaleUrl('account/plans', null)).toBe(\r\n        'https://treido.eu/en/account/plans'\r\n      )\r\n      expect(buildLocaleUrl('account/plans', undefined)).toBe(\r\n        'https://treido.eu/en/account/plans'\r\n      )\r\n    })\r\n  })\r\n\r\n  describe('inferLocaleFromRequest', () => {\r\n    function makeRequest(headers: Record<string, string>): Request {\r\n      return {\r\n        headers: {\r\n          get: (name: string) => headers[name.toLowerCase()] ?? null,\r\n        },\r\n      } as unknown as Request\r\n    }\r\n\r\n    it('prioritizes bodyLocale when provided', () => {\r\n      const req = makeRequest({ 'x-next-intl-locale': 'en', referer: 'https://example.com/bg/page' })\r\n      expect(inferLocaleFromRequest(req, 'bg')).toBe('bg')\r\n    })\r\n\r\n    it('normalizes invalid bodyLocale to en', () => {\r\n      const req = makeRequest({})\r\n      expect(inferLocaleFromRequest(req, 'de')).toBe('en')\r\n    })\r\n\r\n    it('uses x-next-intl-locale header when bodyLocale not provided', () => {\r\n      const req = makeRequest({ 'x-next-intl-locale': 'bg' })\r\n      expect(inferLocaleFromRequest(req)).toBe('bg')\r\n    })\r\n\r\n    it('normalizes invalid x-next-intl-locale header', () => {\r\n      const req = makeRequest({ 'x-next-intl-locale': 'fr' })\r\n      expect(inferLocaleFromRequest(req)).toBe('en')\r\n    })\r\n\r\n    it('extracts locale from referer path', () => {\r\n      const req = makeRequest({ referer: 'https://treido.eu/bg/account/plans' })\r\n      expect(inferLocaleFromRequest(req)).toBe('bg')\r\n    })\r\n\r\n    it('normalizes non-locale referer path segment', () => {\r\n      const req = makeRequest({ referer: 'https://treido.eu/de/some-page' })\r\n      expect(inferLocaleFromRequest(req)).toBe('en')\r\n    })\r\n\r\n    it('ignores invalid referer URL', () => {\r\n      const req = makeRequest({ referer: 'not-a-url' })\r\n      expect(inferLocaleFromRequest(req)).toBe('en')\r\n    })\r\n\r\n    it('defaults to en when no locale info available', () => {\r\n      const req = makeRequest({})\r\n      expect(inferLocaleFromRequest(req)).toBe('en')\r\n    })\r\n\r\n    it('handles referer with root path only', () => {\r\n      const req = makeRequest({ referer: 'https://treido.eu/' })\r\n      expect(inferLocaleFromRequest(req)).toBe('en')\r\n    })\r\n\r\n    it('priority order: bodyLocale > x-next-intl-locale > referer > default', () => {\r\n      // All sources present - bodyLocale wins\r\n      const req1 = makeRequest({\r\n        'x-next-intl-locale': 'en',\r\n        referer: 'https://treido.eu/en/page',\r\n      })\r\n      expect(inferLocaleFromRequest(req1, 'bg')).toBe('bg')\r\n\r\n      // bodyLocale missing - header wins\r\n      const req2 = makeRequest({\r\n        'x-next-intl-locale': 'bg',\r\n        referer: 'https://treido.eu/en/page',\r\n      })\r\n      expect(inferLocaleFromRequest(req2)).toBe('bg')\r\n\r\n      // bodyLocale + header missing - referer wins\r\n      const req3 = makeRequest({\r\n        referer: 'https://treido.eu/bg/page',\r\n      })\r\n      expect(inferLocaleFromRequest(req3)).toBe('bg')\r\n    })\r\n  })\r\n\r\n  describe('inferLocaleFromHeaders', () => {\r\n    function makeHeaders(headers: Record<string, string>): { get: (name: string) => string | null } {\r\n      return {\r\n        get: (name: string) => headers[name.toLowerCase()] ?? null,\r\n      }\r\n    }\r\n\r\n    it('uses x-next-intl-locale header first', () => {\r\n      const headers = makeHeaders({\r\n        'x-next-intl-locale': 'bg',\r\n        referer: 'https://example.com/en/page',\r\n      })\r\n      expect(inferLocaleFromHeaders(headers)).toBe('bg')\r\n    })\r\n\r\n    it('normalizes invalid x-next-intl-locale header', () => {\r\n      const headers = makeHeaders({ 'x-next-intl-locale': 'invalid' })\r\n      expect(inferLocaleFromHeaders(headers)).toBe('en')\r\n    })\r\n\r\n    it('extracts locale from referer when header missing', () => {\r\n      const headers = makeHeaders({ referer: 'https://treido.eu/bg/account' })\r\n      expect(inferLocaleFromHeaders(headers)).toBe('bg')\r\n    })\r\n\r\n    it('ignores invalid referer URL', () => {\r\n      const headers = makeHeaders({ referer: ':::invalid-url:::' })\r\n      expect(inferLocaleFromHeaders(headers)).toBe('en')\r\n    })\r\n\r\n    it('extracts locale from origin when referer missing', () => {\r\n      // Note: origin typically has no path, so this usually won't match\r\n      // But if origin somehow includes a path, it should work\r\n      const headers = makeHeaders({ origin: 'https://treido.eu/bg' })\r\n      expect(inferLocaleFromHeaders(headers)).toBe('bg')\r\n    })\r\n\r\n    it('ignores invalid origin URL', () => {\r\n      const headers = makeHeaders({ origin: 'not a url at all' })\r\n      expect(inferLocaleFromHeaders(headers)).toBe('en')\r\n    })\r\n\r\n    it('defaults to en when no locale info available', () => {\r\n      const headers = makeHeaders({})\r\n      expect(inferLocaleFromHeaders(headers)).toBe('en')\r\n    })\r\n\r\n    it('defaults to en for origin without path', () => {\r\n      // Standard origin header has no path - should fall through to default\r\n      const headers = makeHeaders({ origin: 'https://treido.eu' })\r\n      expect(inferLocaleFromHeaders(headers)).toBe('en')\r\n    })\r\n\r\n    it('priority order: x-next-intl-locale > referer > origin > default', () => {\r\n      // All present - header wins\r\n      const h1 = makeHeaders({\r\n        'x-next-intl-locale': 'bg',\r\n        referer: 'https://treido.eu/en/page',\r\n        origin: 'https://treido.eu/en',\r\n      })\r\n      expect(inferLocaleFromHeaders(h1)).toBe('bg')\r\n\r\n      // Header missing - referer wins\r\n      const h2 = makeHeaders({\r\n        referer: 'https://treido.eu/bg/page',\r\n        origin: 'https://treido.eu/en',\r\n      })\r\n      expect(inferLocaleFromHeaders(h2)).toBe('bg')\r\n\r\n      // Header + referer missing - origin path (if present)\r\n      const h3 = makeHeaders({\r\n        origin: 'https://treido.eu/bg',\r\n      })\r\n      expect(inferLocaleFromHeaders(h3)).toBe('bg')\r\n    })\r\n\r\n    it('handles empty strings gracefully', () => {\r\n      const headers = makeHeaders({\r\n        'x-next-intl-locale': '',\r\n        referer: '',\r\n        origin: '',\r\n      })\r\n      expect(inferLocaleFromHeaders(headers)).toBe('en')\r\n    })\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\supabase-middleware-session.test.ts","messages":[{"ruleId":"unicorn/no-useless-undefined","severity":1,"message":"Do not use useless `undefined`.","line":45,"column":22,"nodeType":"Identifier","messageId":"no-useless-undefined","endLine":45,"endColumn":31,"fix":{"range":[1255,1265],"text":" {}"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { describe, expect, test } from 'vitest'\r\n\r\nimport { updateSession } from '@/lib/supabase/middleware'\r\n\r\nfunction makeNextUrl(url: string) {\r\n  const internal = new URL(url)\r\n\r\n  return {\r\n    clone() {\r\n      return makeNextUrl(internal.toString())\r\n    },\r\n    get pathname() {\r\n      return internal.pathname\r\n    },\r\n    set pathname(value: string) {\r\n      internal.pathname = value\r\n    },\r\n    get search() {\r\n      return internal.search\r\n    },\r\n    get searchParams() {\r\n      return internal.searchParams\r\n    },\r\n    toString() {\r\n      return internal.toString()\r\n    },\r\n  }\r\n}\r\n\r\ndescribe('supabase middleware updateSession', () => {\r\n  test('redirects protected routes to locale-aware login when Supabase env missing', async () => {\r\n    const prevUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n    const prevAnon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n\r\n    // Force the missing-env path (does not create a Supabase client)\r\n    delete process.env.NEXT_PUBLIC_SUPABASE_URL\r\n    delete process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n\r\n    try {\r\n      const request = {\r\n        nextUrl: makeNextUrl('http://localhost:3000/en/account'),\r\n        cookies: {\r\n          getAll: () => [],\r\n          set: () => {},\r\n          get: () => undefined,\r\n        },\r\n        headers: new Headers(),\r\n      }\r\n\r\n      const response = await updateSession(request as any)\r\n      const location = response.headers.get('location')\r\n\r\n      expect(response.status).toBeGreaterThanOrEqual(300)\r\n      expect(location).toContain('/en/auth/login')\r\n      expect(location).toContain('next=%2Fen%2Faccount')\r\n    } finally {\r\n      if (prevUrl !== undefined) process.env.NEXT_PUBLIC_SUPABASE_URL = prevUrl\r\n      else delete process.env.NEXT_PUBLIC_SUPABASE_URL\r\n\r\n      if (prevAnon !== undefined) process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY = prevAnon\r\n      else delete process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n    }\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\url-utils.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'vi' is defined but never used.","line":1,"column":32,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":34,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"vi"},"fix":{"range":[29,33],"text":""},"desc":"Remove unused variable \"vi\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, expect, it, vi } from 'vitest'\r\nimport {\r\n  getAbsoluteProductUrl,\r\n  getProductUrl,\r\n  getProductUrlWithLocale,\r\n  getSellerUrl,\r\n  getSellerUrlWithLocale,\r\n} from '@/lib/url-utils'\r\n\r\ndescribe('lib/url-utils', () => {\r\n  it('prefers /{username}/{slug} when available', () => {\r\n    expect(getProductUrl({ id: '123', username: 'john', slug: 'blue-widget' })).toBe(\r\n      '/john/blue-widget'\r\n    )\r\n  })\r\n\r\n  it('falls back to /{username}/{id} when slug is missing', () => {\r\n    expect(getProductUrl({ id: '123', username: 'john' })).toBe('/john/123')\r\n  })\r\n\r\n  it('handles deprecated storeSlug', () => {\r\n    expect(getProductUrl({ id: '123', storeSlug: 'store', slug: 'item' })).toBe('/store/item')\r\n  })\r\n\r\n  it('returns safe default when missing identifier', () => {\r\n    // Function returns '#' as a safe fallback when no identifiers are provided\r\n    expect(getProductUrl({})).toBe('#')\r\n  })\r\n\r\n  it('adds locale prefix', () => {\r\n    expect(getProductUrlWithLocale({ id: '123', username: 'john' }, 'en')).toBe('/en/john/123')\r\n  })\r\n\r\n  it('builds absolute URL with baseUrl override', () => {\r\n    expect(getAbsoluteProductUrl({ id: '123', username: 'john' }, 'en', 'https://example.com')).toBe(\r\n      'https://example.com/en/john/123'\r\n    )\r\n  })\r\n\r\n  it('builds seller URLs', () => {\r\n    expect(getSellerUrl('john')).toBe('/john')\r\n    expect(getSellerUrlWithLocale('john', 'en')).toBe('/en/john')\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\__tests__\\validations-auth.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\@modal\\(.)account\\plans\\upgrade\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/[locale]/(account)/account/plans/upgrade/upgrade-content' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":5,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":5,"endColumn":96},{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/subscriptions' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":10,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":10,"endColumn":80}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Modal } from \"@/components/shared/modal\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { redirect } from \"@/i18n/routing\"\r\nimport { getLocale, getTranslations } from \"next-intl/server\"\r\nimport { UpgradeContent } from \"@/app/[locale]/(account)/account/plans/upgrade/upgrade-content\"\r\nimport { Suspense } from \"react\"\r\nimport { Loader2 } from \"lucide-react\"\r\nimport { connection } from \"next/server\"\r\nimport { getPlansForUpgrade, PRIVATE_PROFILE_SELECT_FOR_UPGRADE, PROFILE_SELECT_FOR_UPGRADE } from \"@/lib/data/plans\"\r\nimport { createSubscriptionCheckoutSession } from \"@/app/actions/subscriptions\"\r\n\r\n// Generate static params for all locales - required for Next.js 16 Cache Components\r\nasync function UpgradeModalContent() {\r\n  // Ensure this runs dynamically, not during static generation\r\n  await connection()\r\n\r\n  const locale = await getLocale()\r\n  const safeLocale = locale === \"bg\" ? \"bg\" : \"en\"\r\n  const t = await getTranslations({ locale: safeLocale, namespace: \"AccountPlansUpgrade\" })\r\n  const supabase = await createClient()\r\n\r\n  if (!supabase) {\r\n    return redirect({ href: \"/auth/login\", locale: safeLocale })\r\n  }\r\n\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n\r\n  if (!user) {\r\n    return redirect({ href: \"/auth/login\", locale: safeLocale })\r\n  }\r\n\r\n  // Fetch profile info (public surface) + private billing fields\r\n  const [\r\n    { data: profile },\r\n    { data: privateProfile },\r\n  ] = await Promise.all([\r\n    supabase\r\n      .from('profiles')\r\n      .select(PROFILE_SELECT_FOR_UPGRADE)\r\n      .eq('id', user.id)\r\n      .single(),\r\n    supabase\r\n      .from('private_profiles')\r\n      .select(PRIVATE_PROFILE_SELECT_FOR_UPGRADE)\r\n      .eq('id', user.id)\r\n      .maybeSingle(),\r\n  ])\r\n\r\n  // Fetch subscription plans\r\n  const plans = await getPlansForUpgrade()\r\n\r\n  const currentTier = profile?.tier || 'free'\r\n\r\n  const commissionRate = privateProfile?.commission_rate == null ? 0 : Number(privateProfile.commission_rate)\r\n  const seller = profile ? {\r\n    id: profile.id,\r\n    tier: profile.tier || 'free',\r\n    commission_rate: commissionRate,\r\n    stripe_customer_id: privateProfile?.stripe_customer_id ?? null,\r\n  } : null\r\n\r\n  return (\r\n    <Modal\r\n      title={t(\"title\")}\r\n      description={t(\"description\")}\r\n    >\r\n      <UpgradeContent\r\n        locale={safeLocale}\r\n        plans={plans}\r\n        currentTier={currentTier}\r\n        seller={seller}\r\n        actions={{ createSubscriptionCheckoutSession }}\r\n      />\r\n    </Modal>\r\n  )\r\n}\r\n\r\nfunction UpgradeLoadingFallback({ label }: { label: string }) {\r\n  return (\r\n    <Modal ariaLabel={label}>\r\n      <div className=\"flex items-center justify-center py-12\">\r\n        <Loader2 className=\"size-8 animate-spin text-muted-foreground\" />\r\n      </div>\r\n    </Modal>\r\n  )\r\n}\r\n\r\n/**\r\n * Intercepted Upgrade Route\r\n * \r\n * This page is shown as a modal overlay when navigating from within the app.\r\n * When accessed directly (or on refresh), the user sees the full page version.\r\n */\r\nexport default async function InterceptedUpgradePage() {\r\n  const tCommon = await getTranslations(\"Common\")\r\n\r\n  return (\r\n    <Suspense fallback={<UpgradeLoadingFallback label={tCommon(\"loading\")} />}>\r\n      <UpgradeModalContent />\r\n    </Suspense>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\@modal\\default.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account-layout-content.tsx","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `SetStateAction<string>`.","line":45,"column":23,"nodeType":"LogicalExpression","messageId":"unsafeArgument","endLine":45,"endColumn":58}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useState } from \"react\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport { AccountSidebar } from \"./account/_components/account-sidebar\"\r\nimport { AccountHeader } from \"./account/_components/account-header\"\r\nimport { AccountTabBar } from \"./account/_components/account-tab-bar\"\r\nimport type { PlansModalServerActions } from \"./account/_components/plans-modal\"\r\nimport {\r\n  SidebarInset,\r\n  SidebarProvider,\r\n} from \"@/components/layout/sidebar/sidebar\"\r\n\r\ninterface AccountLayoutContentProps {\r\n  children: React.ReactNode\r\n  modal: React.ReactNode\r\n  initialUser?: {\r\n    email?: string\r\n    fullName?: string\r\n  }\r\n  plansModalActions: PlansModalServerActions\r\n}\r\n\r\nexport function AccountLayoutContent({\r\n  children,\r\n  modal,\r\n  initialUser,\r\n  plansModalActions,\r\n}: AccountLayoutContentProps) {\r\n  const [email, setEmail] = useState<string>(initialUser?.email ?? \"\")\r\n  const [fullName, setFullName] = useState<string>(initialUser?.fullName ?? \"\")\r\n\r\n  useEffect(() => {\r\n    async function getUser() {\r\n      try {\r\n        const supabase = createClient()\r\n        const result = await Promise.race([\r\n          supabase.auth.getUser(),\r\n          new Promise<null>((resolve) => setTimeout(() => resolve(null), 1500)),\r\n        ])\r\n\r\n        const user = result && \"data\" in result ? result.data.user : null\r\n        if (user?.email) {\r\n          setEmail(user.email)\r\n          setFullName(user.user_metadata?.full_name || \"\")\r\n        }\r\n      } catch {\r\n        // Best-effort only; server layout already validated auth.\r\n      }\r\n    }\r\n    getUser()\r\n  }, [])\r\n\r\n  return (\r\n    <SidebarProvider\r\n      style={\r\n        {\r\n          \"--sidebar-width\": \"calc(var(--spacing) * 72)\",\r\n          \"--header-height\": \"calc(var(--spacing) * 12)\",\r\n        } as React.CSSProperties\r\n      }\r\n    >\r\n      <AccountSidebar\r\n        variant=\"inset\"\r\n        user={{\r\n          name: fullName,\r\n          email: email,\r\n        }}\r\n        plansModalActions={plansModalActions}\r\n      />\r\n      <SidebarInset>\r\n        <AccountHeader />\r\n        <div className=\"flex flex-1 flex-col bg-background min-h-0\">\r\n          <div className=\"@container/main flex flex-1 flex-col gap-4 px-4 py-4 pb-20 lg:px-6 lg:py-6 lg:pb-6\">\r\n            {children}\r\n          </div>\r\n        </div>\r\n        {/* Mobile Tab Bar */}\r\n        <AccountTabBar />\r\n      </SidebarInset>\r\n      \r\n      {/* Modal Slot - for intercepted routes */}\r\n      {modal}\r\n    </SidebarProvider>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\(settings)\\notifications\\notifications-content.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 36 to the 25 allowed.","line":141,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":141,"endColumn":37},{"ruleId":"sonarjs/no-all-duplicated-branches","severity":1,"message":"This conditional operation returns the same value whether the condition is \"true\" or \"false\".","line":464,"column":16,"nodeType":"ConditionalExpression","messageId":"returnsTheSameValue","endLine":464,"endColumn":49}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Switch } from \"@/components/ui/switch\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { toast } from \"sonner\"\r\nimport { Link, useRouter } from \"@/i18n/routing\"\r\nimport { Bell, CheckCircle, Package, ChatCircle, Star, Users, Tag, CaretRight } from \"@phosphor-icons/react\"\r\nimport { formatDistanceToNow } from \"date-fns\"\r\n\r\ntype NotificationType = \"purchase\" | \"order_status\" | \"message\" | \"review\" | \"system\" | \"promotion\"\r\n\r\ninterface NotificationRow {\r\n  id: string\r\n  type: NotificationType\r\n  title: string\r\n  body: string | null\r\n  data: Record<string, unknown> | null\r\n  order_id: string | null\r\n  product_id: string | null\r\n  conversation_id: string | null\r\n  is_read: boolean\r\n  created_at: string\r\n}\r\n\r\ntype NotificationPreferences = {\r\n  in_app_purchase: boolean\r\n  in_app_order_status: boolean\r\n  in_app_message: boolean\r\n  in_app_review: boolean\r\n  in_app_system: boolean\r\n  in_app_promotion: boolean\r\n  email_purchase: boolean\r\n  email_order_status: boolean\r\n  email_message: boolean\r\n  email_review: boolean\r\n  email_system: boolean\r\n  email_promotion: boolean\r\n  push_enabled: boolean\r\n}\r\n\r\nconst DEFAULT_PREFS: NotificationPreferences = {\r\n  in_app_purchase: true,\r\n  in_app_order_status: true,\r\n  in_app_message: true,\r\n  in_app_review: true,\r\n  in_app_system: true,\r\n  in_app_promotion: true,\r\n  email_purchase: false,\r\n  email_order_status: false,\r\n  email_message: false,\r\n  email_review: false,\r\n  email_system: false,\r\n  email_promotion: false,\r\n  push_enabled: false,\r\n}\r\n\r\nconst getNotificationIcon = (type: NotificationType) => {\r\n  switch (type) {\r\n    case \"purchase\":\r\n      return <Package size={18} weight=\"duotone\" className=\"text-success\" />\r\n    case \"order_status\":\r\n      return <Package size={18} weight=\"duotone\" className=\"text-info\" />\r\n    case \"message\":\r\n      return <ChatCircle size={18} weight=\"duotone\" className=\"text-primary\" />\r\n    case \"review\":\r\n      return <Star size={18} weight=\"duotone\" className=\"text-warning\" />\r\n    case \"system\":\r\n      return <Users size={18} weight=\"duotone\" className=\"text-muted-foreground\" />\r\n    case \"promotion\":\r\n      return <Tag size={18} weight=\"duotone\" className=\"text-destructive\" />\r\n    default:\r\n      return <Bell size={18} weight=\"duotone\" />\r\n  }\r\n}\r\n\r\nconst isInAppEnabled = (prefs: NotificationPreferences, type: NotificationType) => {\r\n  switch (type) {\r\n    case \"purchase\":\r\n      return prefs.in_app_purchase\r\n    case \"order_status\":\r\n      return prefs.in_app_order_status\r\n    case \"message\":\r\n      return prefs.in_app_message\r\n    case \"review\":\r\n      return prefs.in_app_review\r\n    case \"system\":\r\n      return prefs.in_app_system\r\n    case \"promotion\":\r\n      return prefs.in_app_promotion\r\n    default:\r\n      return true\r\n  }\r\n}\r\n\r\nconst getNotificationLink = (notification: NotificationRow): string => {\r\n  if (notification.conversation_id) {\r\n    return `/chat/${notification.conversation_id}`\r\n  }\r\n  if (notification.order_id) {\r\n    if (notification.type === \"purchase\") {\r\n      return `/account/sales`\r\n    }\r\n    return `/account/orders`\r\n  }\r\n  if (notification.product_id) {\r\n    return `/account/selling`\r\n  }\r\n  if (notification.data?.event_type === \"new_follower\") {\r\n    return `/account/following`\r\n  }\r\n  return \"/account\"\r\n}\r\n\r\nconst NotificationToggleRow = ({\r\n  title,\r\n  description,\r\n  checked,\r\n  onCheckedChange,\r\n  disabled,\r\n}: {\r\n  title: string\r\n  description?: string\r\n  checked: boolean\r\n  onCheckedChange: (value: boolean) => void\r\n  disabled?: boolean\r\n}) => {\r\n  return (\r\n    <div className={cn(\"flex items-center gap-3 p-3\", disabled && \"opacity-60\")}> \r\n      <div className=\"flex-1 min-w-0\">\r\n        <div className=\"text-sm font-medium text-foreground\">{title}</div>\r\n        {description && <div className=\"text-xs text-muted-foreground mt-0.5\">{description}</div>}\r\n      </div>\r\n      <Switch checked={checked} onCheckedChange={onCheckedChange} disabled={disabled} />\r\n    </div>\r\n  )\r\n}\r\n\r\nexport function NotificationsContent({\r\n  locale,\r\n  initialNotifications,\r\n}: {\r\n  locale: string\r\n  initialNotifications?: NotificationRow[]\r\n}) {\r\n  const router = useRouter()\r\n  const supabase = useMemo(() => createClient(), [])\r\n\r\n  const [isLoading, setIsLoading] = useState(() => initialNotifications === undefined)\r\n  const [notifications, setNotifications] = useState<NotificationRow[]>(() => initialNotifications ?? [])\r\n  const [prefs, setPrefs] = useState<NotificationPreferences>(DEFAULT_PREFS)\r\n  const initializedRef = useRef(false)\r\n\r\n  const visibleNotifications = useMemo(() => {\r\n    return notifications.filter((n) => isInAppEnabled(prefs, n.type))\r\n  }, [notifications, prefs])\r\n\r\n  const unreadCount = useMemo(() => {\r\n    return visibleNotifications.filter((n) => !n.is_read).length\r\n  }, [visibleNotifications])\r\n\r\n  const fetchAll = useCallback(\r\n    async ({ showSpinner }: { showSpinner: boolean } = { showSpinner: true }) => {\r\n      if (showSpinner) {\r\n        setIsLoading(true)\r\n      }\r\n    try {\r\n      const { data: userData } = await supabase.auth.getUser()\r\n      const user = userData.user\r\n      if (!user) {\r\n        setIsLoading(false)\r\n        return\r\n      }\r\n\r\n      // Preferences (optional)\r\n      try {\r\n        const { data: prefData, error: prefError } = await supabase\r\n          .from(\"notification_preferences\")\r\n          .select(\r\n            \"user_id,in_app_purchase,in_app_order_status,in_app_message,in_app_review,in_app_system,in_app_promotion,email_purchase,email_order_status,email_message,email_review,email_system,email_promotion,push_enabled\"\r\n          )\r\n          .eq(\"user_id\", user.id)\r\n          .maybeSingle()\r\n\r\n        if (!prefError && prefData) {\r\n          setPrefs({\r\n            in_app_purchase: prefData.in_app_purchase ?? true,\r\n            in_app_order_status: prefData.in_app_order_status ?? true,\r\n            in_app_message: prefData.in_app_message ?? true,\r\n            in_app_review: prefData.in_app_review ?? true,\r\n            in_app_system: prefData.in_app_system ?? true,\r\n            in_app_promotion: prefData.in_app_promotion ?? true,\r\n            email_purchase: prefData.email_purchase ?? false,\r\n            email_order_status: prefData.email_order_status ?? false,\r\n            email_message: prefData.email_message ?? false,\r\n            email_review: prefData.email_review ?? false,\r\n            email_system: prefData.email_system ?? false,\r\n            email_promotion: prefData.email_promotion ?? false,\r\n            push_enabled: prefData.push_enabled ?? false,\r\n          })\r\n        }\r\n      } catch {\r\n        // If preferences table isn't present yet, keep defaults.\r\n      }\r\n\r\n      const { data, error } = await supabase\r\n        .from(\"notifications\")\r\n        .select(\r\n          \"id,type,title,body,data,order_id,product_id,conversation_id,is_read,created_at\"\r\n        )\r\n        .eq(\"user_id\", user.id)\r\n        .order(\"created_at\", { ascending: false })\r\n        .limit(50)\r\n\r\n      if (error) throw error\r\n      setNotifications((data ?? []) as NotificationRow[])\r\n    } catch (error) {\r\n      console.error(\"Error loading notifications:\", error)\r\n      toast.error(locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨╖╨░╤Ç╨╡╨╢╨┤╨░╨╜╨╡ ╨╜╨░ ╨╕╨╖╨▓╨╡╤ü╤é╨╕╤Å\" : \"Failed to load notifications\")\r\n    } finally {\r\n      setIsLoading(false)\r\n      initializedRef.current = true\r\n    }\r\n    },\r\n    [locale, supabase]\r\n  )\r\n\r\n  useEffect(() => {\r\n    // If we have SSR-provided notifications, render immediately and refresh quietly.\r\n    if (initialNotifications !== undefined) {\r\n      void fetchAll({ showSpinner: false })\r\n      return\r\n    }\r\n\r\n    void fetchAll({ showSpinner: true })\r\n  }, [fetchAll, initialNotifications])\r\n\r\n  const markAsRead = async (notificationId: string) => {\r\n    try {\r\n      await supabase.rpc(\"mark_notification_read\", { p_notification_id: notificationId })\r\n      setNotifications((prev) => prev.map((n) => (n.id === notificationId ? { ...n, is_read: true } : n)))\r\n    } catch {\r\n      toast.error(locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨╛╤é╨▒╨╡╨╗╤Å╨╖╨▓╨░╨╜╨╡ ╨║╨░╤é╨╛ ╨┐╤Ç╨╛╤ç╨╡╤é╨╡╨╜╨╛\" : \"Failed to mark as read\")\r\n    }\r\n  }\r\n\r\n  const markAllAsRead = async () => {\r\n    try {\r\n      await supabase.rpc(\"mark_all_notifications_read\")\r\n      setNotifications((prev) => prev.map((n) => ({ ...n, is_read: true })))\r\n    } catch {\r\n      toast.error(locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨╛╤é╨▒╨╡╨╗╤Å╨╖╨▓╨░╨╜╨╡\" : \"Failed to mark all as read\")\r\n    }\r\n  }\r\n\r\n  const savePrefs = async (next: NotificationPreferences) => {\r\n    try {\r\n      const { data: userData } = await supabase.auth.getUser()\r\n      const user = userData.user\r\n      if (!user) return\r\n\r\n      await supabase\r\n        .from(\"notification_preferences\")\r\n        .upsert(\r\n          {\r\n            user_id: user.id,\r\n            ...next,\r\n          },\r\n          { onConflict: \"user_id\" }\r\n        )\r\n    } catch (error) {\r\n      console.error(\"Error saving notification prefs:\", error)\r\n      toast.error(locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨╖╨░╨┐╨░╨╖╨▓╨░╨╜╨╡\" : \"Failed to save preferences\")\r\n    }\r\n  }\r\n\r\n  const updatePref = <K extends keyof NotificationPreferences>(key: K, value: boolean) => {\r\n    const next = { ...prefs, [key]: value }\r\n    setPrefs(next)\r\n    // Avoid saving until we have attempted initial load.\r\n    if (initializedRef.current) {\r\n      void savePrefs(next)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* All notifications */}\r\n      <div className=\"rounded-lg border bg-card overflow-hidden\">\r\n        <div className=\"flex items-center justify-between p-4 bg-muted border-b border-border\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <Bell size={20} weight=\"regular\" className=\"text-muted-foreground\" />\r\n            <div className=\"font-semibold text-base text-foreground\">\r\n              {locale === \"bg\" ? \"╨ÿ╨╖╨▓╨╡╤ü╤é╨╕╤Å\" : \"Notifications\"}\r\n            </div>\r\n            {unreadCount > 0 && (\r\n              <span className=\"text-xs bg-destructive text-destructive-foreground px-2 py-0.5 rounded-full\">\r\n                {unreadCount}\r\n              </span>\r\n            )}\r\n          </div>\r\n          {unreadCount > 0 && (\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              className=\"h-8 text-xs text-muted-foreground hover:text-foreground\"\r\n              onClick={() => void markAllAsRead()}\r\n            >\r\n              <CheckCircle size={14} className=\"mr-1\" />\r\n              {locale === \"bg\" ? \"╨₧╤é╨▒╨╡╨╗╨╡╨╢╨╕ ╨▓╤ü╨╕╤ç╨║╨╕\" : \"Mark all\"}\r\n            </Button>\r\n          )}\r\n        </div>\r\n\r\n        {isLoading ? (\r\n          <div className=\"p-4 text-center text-muted-foreground\">\r\n            {locale === \"bg\" ? \"╨ù╨░╤Ç╨╡╨╢╨┤╨░╨╜╨╡...\" : \"Loading...\"}\r\n          </div>\r\n        ) : visibleNotifications.length === 0 ? (\r\n          <div className=\"p-4 text-center\">\r\n            <Bell size={40} weight=\"thin\" className=\"mx-auto mb-2 text-muted-foreground\" />\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              {locale === \"bg\" ? \"╨¥╤Å╨╝╨░ ╨╕╨╖╨▓╨╡╤ü╤é╨╕╤Å\" : \"No notifications\"}\r\n            </p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"divide-y divide-border\">\r\n            {visibleNotifications.map((notification) => (\r\n              <Link\r\n                key={notification.id}\r\n                href={getNotificationLink(notification)}\r\n                onClick={() => {\r\n                  if (!notification.is_read) {\r\n                    void markAsRead(notification.id)\r\n                  }\r\n                }}\r\n                className={cn(\r\n                  \"flex items-start gap-3 p-3 hover:bg-muted\",\r\n                  !notification.is_read && \"bg-selected\"\r\n                )}\r\n              >\r\n                <div className=\"shrink-0 mt-0.5\">{getNotificationIcon(notification.type)}</div>\r\n                <div className=\"flex-1 min-w-0\">\r\n                  <p\r\n                    className={cn(\r\n                      \"text-sm line-clamp-1\",\r\n                      !notification.is_read ? \"font-semibold text-foreground\" : \"text-foreground\"\r\n                    )}\r\n                  >\r\n                    {notification.title}\r\n                  </p>\r\n                  {notification.body && (\r\n                    <p className=\"text-xs text-muted-foreground line-clamp-2 mt-0.5\">{notification.body}</p>\r\n                  )}\r\n                  <p className=\"text-xs text-muted-foreground mt-1\">\r\n                    {formatDistanceToNow(new Date(notification.created_at), { addSuffix: true })}\r\n                  </p>\r\n                </div>\r\n                {!notification.is_read && <div className=\"shrink-0 w-2 h-2 rounded-full bg-primary mt-2\" />}\r\n              </Link>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Preferences */}\r\n      <div className=\"rounded-lg border bg-card overflow-hidden\">\r\n        <div className=\"p-4 bg-muted border-b border-border\">\r\n          <div className=\"text-sm font-semibold text-foreground\">\r\n            {locale === \"bg\" ? \"╨ƒ╤Ç╨╡╨┤╨┐╨╛╤ç╨╕╤é╨░╨╜╨╕╤Å\" : \"Preferences\"}\r\n          </div>\r\n          <div className=\"text-xs text-muted-foreground mt-1\">\r\n            {locale === \"bg\"\r\n              ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨║╨╛╨╕ ╨╕╨╖╨▓╨╡╤ü╤é╨╕╤Å ╨┤╨░ ╨▓╨╕╨╢╨┤╨░╤é╨╡ ╨▓ ╨┐╤Ç╨╕╨╗╨╛╨╢╨╡╨╜╨╕╨╡╤é╨╛ ╨╕ ╨┐╨╛ ╨╕╨╝╨╡╨╣╨╗.\"\r\n              : \"Choose which notifications you want in-app and via email.\"}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"divide-y divide-border\">\r\n          <div className=\"p-3\">\r\n            <div className=\"text-xs font-medium text-muted-foreground\">\r\n              {locale === \"bg\" ? \"╨Æ ╨┐╤Ç╨╕╨╗╨╛╨╢╨╡╨╜╨╕╨╡╤é╨╛\" : \"In-app\"}\r\n            </div>\r\n          </div>\r\n\r\n          <NotificationToggleRow\r\n            title={locale === \"bg\" ? \"╨¥╨╛╨▓╨╕ ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕\" : \"New sales\"}\r\n            description={locale === \"bg\" ? \"╨Ü╨╛╨│╨░╤é╨╛ ╨╜╤Å╨║╨╛╨╣ ╨║╤â╨┐╨╕ ╨▓╨░╤ê ╨┐╤Ç╨╛╨┤╤â╨║╤é\" : \"When someone buys your product\"}\r\n            checked={prefs.in_app_purchase}\r\n            onCheckedChange={(v) => updatePref(\"in_app_purchase\", v)}\r\n          />\r\n          <NotificationToggleRow\r\n            title={locale === \"bg\" ? \"╨í╤é╨░╤é╤â╤ü ╨╜╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨░\" : \"Order status\"}\r\n            description={locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨╝╨╡╨╜╨╕ ╨┐╨╛ ╨┐╨╛╤Ç╤è╤ç╨║╨╕╤é╨╡\" : \"Updates about your orders\"}\r\n            checked={prefs.in_app_order_status}\r\n            onCheckedChange={(v) => updatePref(\"in_app_order_status\", v)}\r\n          />\r\n          <NotificationToggleRow\r\n            title={locale === \"bg\" ? \"╨í╤è╨╛╨▒╤ë╨╡╨╜╨╕╤Å\" : \"Messages\"}\r\n            description={locale === \"bg\" ? \"╨¥╨╛╨▓╨╕ ╤ü╤è╨╛╨▒╤ë╨╡╨╜╨╕╤Å ╨╕ ╤Ç╨░╨╖╨│╨╛╨▓╨╛╤Ç╨╕\" : \"New messages and conversations\"}\r\n            checked={prefs.in_app_message}\r\n            onCheckedChange={(v) => updatePref(\"in_app_message\", v)}\r\n          />\r\n          <NotificationToggleRow\r\n            title={locale === \"bg\" ? \"╨₧╤é╨╖╨╕╨▓╨╕\" : \"Reviews\"}\r\n            description={locale === \"bg\" ? \"╨¥╨╛╨▓╨╕ ╨╛╤é╨╖╨╕╨▓╨╕ ╨╖╨░ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨╕/╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç\" : \"New reviews\"}\r\n            checked={prefs.in_app_review}\r\n            onCheckedChange={(v) => updatePref(\"in_app_review\", v)}\r\n          />\r\n          <NotificationToggleRow\r\n            title={locale === \"bg\" ? \"╨í╨╕╤ü╤é╨╡╨╝╨╜╨╕\" : \"System\"}\r\n            description={locale === \"bg\" ? \"╨Æ╨░╨╢╨╜╨╕ ╤ü╨╕╤ü╤é╨╡╨╝╨╜╨╕ ╨╕╨╖╨▓╨╡╤ü╤é╨╕╤Å\" : \"Important system alerts\"}\r\n            checked={prefs.in_app_system}\r\n            onCheckedChange={(v) => updatePref(\"in_app_system\", v)}\r\n          />\r\n          <NotificationToggleRow\r\n            title={locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨╝╨╛╤å╨╕╨╕\" : \"Promotions\"}\r\n            description={locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨╝╨╛ ╨║╨░╨╝╨┐╨░╨╜╨╕╨╕ ╨╕ ╨╛╤ä╨╡╤Ç╤é╨╕\" : \"Promotions and offers\"}\r\n            checked={prefs.in_app_promotion}\r\n            onCheckedChange={(v) => updatePref(\"in_app_promotion\", v)}\r\n          />\r\n\r\n          <div className=\"p-3\">\r\n            <div className=\"text-xs font-medium text-muted-foreground\">\r\n              {locale === \"bg\" ? \"╨ÿ╨╝╨╡╨╣╨╗\" : \"Email\"}\r\n            </div>\r\n          </div>\r\n\r\n          <NotificationToggleRow\r\n            title={locale === \"bg\" ? \"╨¥╨╛╨▓╨╕ ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕ (╨╕╨╝╨╡╨╣╨╗)\" : \"New sales (email)\"}\r\n            checked={prefs.email_purchase}\r\n            onCheckedChange={(v) => updatePref(\"email_purchase\", v)}\r\n          />\r\n          <NotificationToggleRow\r\n            title={locale === \"bg\" ? \"╨í╤é╨░╤é╤â╤ü ╨╜╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨░ (╨╕╨╝╨╡╨╣╨╗)\" : \"Order status (email)\"}\r\n            checked={prefs.email_order_status}\r\n            onCheckedChange={(v) => updatePref(\"email_order_status\", v)}\r\n          />\r\n          <NotificationToggleRow\r\n            title={locale === \"bg\" ? \"╨í╤è╨╛╨▒╤ë╨╡╨╜╨╕╤Å (╨╕╨╝╨╡╨╣╨╗)\" : \"Messages (email)\"}\r\n            checked={prefs.email_message}\r\n            onCheckedChange={(v) => updatePref(\"email_message\", v)}\r\n          />\r\n          <NotificationToggleRow\r\n            title={locale === \"bg\" ? \"╨₧╤é╨╖╨╕╨▓╨╕ (╨╕╨╝╨╡╨╣╨╗)\" : \"Reviews (email)\"}\r\n            checked={prefs.email_review}\r\n            onCheckedChange={(v) => updatePref(\"email_review\", v)}\r\n          />\r\n          <NotificationToggleRow\r\n            title={locale === \"bg\" ? \"╨í╨╕╤ü╤é╨╡╨╝╨╜╨╕ (╨╕╨╝╨╡╨╣╨╗)\" : \"System (email)\"}\r\n            checked={prefs.email_system}\r\n            onCheckedChange={(v) => updatePref(\"email_system\", v)}\r\n          />\r\n          <NotificationToggleRow\r\n            title={locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨╝╨╛╤å╨╕╨╕ (╨╕╨╝╨╡╨╣╨╗)\" : \"Promotions (email)\"}\r\n            checked={prefs.email_promotion}\r\n            onCheckedChange={(v) => updatePref(\"email_promotion\", v)}\r\n          />\r\n\r\n          <div className=\"p-3\">\r\n            <div className=\"text-xs font-medium text-muted-foreground\">\r\n              {locale === \"bg\" ? \"Push\" : \"Push\"}\r\n            </div>\r\n          </div>\r\n          <NotificationToggleRow\r\n            title={locale === \"bg\" ? \"Push ╨╕╨╖╨▓╨╡╤ü╤é╨╕╤Å\" : \"Push notifications\"}\r\n            description={locale === \"bg\" ? \"╨í╨║╨╛╤Ç╨╛\" : \"Coming soon\"}\r\n            checked={prefs.push_enabled}\r\n            onCheckedChange={() => {}}\r\n            disabled\r\n          />\r\n        </div>\r\n\r\n        <div className=\"p-3 bg-muted border-t border-border\">\r\n          <Button\r\n            variant=\"outline\"\r\n            className=\"w-full\"\r\n            onClick={() => {\r\n              router.push(\"/account/sales\")\r\n            }}\r\n          >\r\n            {locale === \"bg\" ? \"╨Ü╤è╨╝ ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕╤é╨╡\" : \"Go to Sales\"}\r\n            <CaretRight size={14} className=\"ml-1\" />\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\(settings)\\notifications\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\account-addresses-grid.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getLabelIcon' to the outer scope.","line":76,"column":40,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":76,"endColumn":42},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getLabelColor' to the outer scope.","line":89,"column":41,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":89,"endColumn":43},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'formatAddress' to the outer scope.","line":102,"column":48,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":102,"endColumn":50},{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":105,"column":50,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":105,"endColumn":70}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { MapPin, House, Briefcase, Star, Plus, Pencil, Trash, Phone } from \"@phosphor-icons/react\"\r\n\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport {\r\n  Sheet,\r\n  SheetContent,\r\n  SheetDescription,\r\n  SheetHeader,\r\n  SheetTitle,\r\n  SheetTrigger,\r\n} from \"@/components/ui/sheet\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\n\r\ntype UserAddress = {\r\n  id: string\r\n  label: string\r\n  full_name: string\r\n  phone: string | null\r\n  address_line1: string\r\n  address_line2: string | null\r\n  city: string\r\n  state: string | null\r\n  postal_code: string\r\n  country: string\r\n  is_default: boolean\r\n  created_at: string\r\n}\r\n\r\ninterface AccountAddressesGridProps {\r\n  addresses: UserAddress[]\r\n  locale: string\r\n  onEdit: (address: UserAddress) => void\r\n  onDelete: (addressId: string) => void\r\n  onAdd: () => void\r\n  onSetDefault: (addressId: string) => void\r\n  isLoading?: boolean\r\n}\r\n\r\nexport function AccountAddressesGrid({ \r\n  addresses, \r\n  locale, \r\n  onEdit, \r\n  onDelete, \r\n  onAdd,\r\n  onSetDefault,\r\n  isLoading \r\n}: AccountAddressesGridProps) {\r\n  const [openSheetId, setOpenSheetId] = useState<string | null>(null)\r\n\r\n  const t = {\r\n    noAddresses: locale === 'bg' ? '╨¥╤Å╨╝╨░╤é╨╡ ╨╖╨░╨┐╨░╨╖╨╡╨╜╨╕ ╨░╨┤╤Ç╨╡╤ü╨╕' : 'No saved addresses',\r\n    noAddressesDesc: locale === 'bg' ? '╨ö╨╛╨▒╨░╨▓╨╡╤é╨╡ ╨░╨┤╤Ç╨╡╤ü ╨╖╨░ ╨┐╨╛-╨▒╤è╤Ç╨╖╨╛ ╨┐╨╗╨░╤ë╨░╨╜╨╡ ╨┐╤Ç╨╕ ╤ü╨╗╨╡╨┤╨▓╨░╤ë╨░╤é╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨░' : 'Add an address for faster checkout on your next order',\r\n    addFirst: locale === 'bg' ? '╨ö╨╛╨▒╨░╨▓╨╕ ╨┐╤è╤Ç╨▓╨╕╤Å ╨░╨┤╤Ç╨╡╤ü' : 'Add your first address',\r\n    addNew: locale === 'bg' ? '╨ö╨╛╨▒╨░╨▓╨╕ ╨╜╨╛╨▓ ╨░╨┤╤Ç╨╡╤ü' : 'Add new address',\r\n    default: locale === 'bg' ? '╨ƒ╨╛ ╨┐╨╛╨┤╤Ç╨░╨╖╨▒╨╕╤Ç╨░╨╜╨╡' : 'Default',\r\n    setDefault: locale === 'bg' ? '╨¥╨░╨┐╤Ç╨░╨▓╨╕ ╨┐╨╛ ╨┐╨╛╨┤╤Ç╨░╨╖╨▒╨╕╤Ç╨░╨╜╨╡' : 'Set as default',\r\n    edit: locale === 'bg' ? '╨á╨╡╨┤╨░╨║╤é╨╕╤Ç╨░╨╣' : 'Edit',\r\n    delete: locale === 'bg' ? '╨ÿ╨╖╤é╤Ç╨╕╨╣' : 'Delete',\r\n    addressDetails: locale === 'bg' ? '╨ö╨╡╤é╨░╨╣╨╗╨╕ ╨╜╨░ ╨░╨┤╤Ç╨╡╤ü╨░' : 'Address Details',\r\n    deliveryAddress: locale === 'bg' ? '╨É╨┤╤Ç╨╡╤ü ╨╖╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░' : 'Delivery address',\r\n    phone: locale === 'bg' ? '╨ó╨╡╨╗╨╡╤ä╨╛╨╜' : 'Phone',\r\n    actions: locale === 'bg' ? '╨ö╨╡╨╣╤ü╤é╨▓╨╕╤Å' : 'Actions',\r\n  }\r\n\r\n  const getLabelIcon = (label: string) => {\r\n    switch (label.toLowerCase()) {\r\n      case 'home':\r\n      case '╨┤╨╛╨╝':\r\n        return House\r\n      case 'work':\r\n      case '╤Ç╨░╨▒╨╛╤é╨░':\r\n        return Briefcase\r\n      default:\r\n        return MapPin\r\n    }\r\n  }\r\n\r\n  const getLabelColor = (label: string) => {\r\n    switch (label.toLowerCase()) {\r\n      case 'home':\r\n      case '╨┤╨╛╨╝':\r\n        return 'text-success'\r\n      case 'work':\r\n      case '╤Ç╨░╨▒╨╛╤é╨░':\r\n        return 'text-info'\r\n      default:\r\n        return 'text-muted-foreground'\r\n    }\r\n  }\r\n\r\n  const formatAddress = (address: UserAddress) => {\r\n    const parts = [address.address_line1]\r\n    if (address.address_line2) parts.push(address.address_line2)\r\n    parts.push(`${address.city}${address.state ? `, ${address.state}` : ''} ${address.postal_code}`)\r\n    parts.push(address.country)\r\n    return parts\r\n  }\r\n\r\n  // Empty state\r\n  if (addresses.length === 0) {\r\n    return (\r\n      <Card>\r\n        <CardContent className=\"flex flex-col items-center justify-center py-12 text-center\">\r\n          <div className=\"flex size-16 items-center justify-center rounded-full bg-muted mb-4\">\r\n            <MapPin className=\"size-8 text-muted-foreground\" weight=\"duotone\" />\r\n          </div>\r\n          <h3 className=\"font-semibold text-lg\">{t.noAddresses}</h3>\r\n          <p className=\"text-muted-foreground text-sm mt-1 max-w-sm\">\r\n            {t.noAddressesDesc}\r\n          </p>\r\n          <Button onClick={onAdd} className=\"mt-6 gap-2\">\r\n            <Plus className=\"size-4\" weight=\"bold\" />\r\n            {t.addFirst}\r\n          </Button>\r\n        </CardContent>\r\n      </Card>\r\n    )\r\n  }\r\n\r\n  // Mobile card with Sheet\r\n  const MobileAddressCard = ({ address }: { address: UserAddress }) => {\r\n    const LabelIcon = getLabelIcon(address.label)\r\n    const isOpen = openSheetId === address.id\r\n\r\n    return (\r\n      <Sheet open={isOpen} onOpenChange={(open) => setOpenSheetId(open ? address.id : null)}>\r\n        <SheetTrigger asChild>\r\n          <Card className={`cursor-pointer transition-colors hover:bg-hover ${address.is_default ? 'border-selected-border ring-1 ring-border-subtle' : ''}`}>\n            <CardHeader className=\"pb-2\">\r\n              <div className=\"flex items-start justify-between gap-2\">\r\n                <div className=\"flex items-center gap-2 min-w-0\">\r\n                  <LabelIcon className={`size-5 shrink-0 ${getLabelColor(address.label)}`} weight=\"duotone\" />\r\n                  <CardTitle className=\"text-base truncate\">{address.label}</CardTitle>\r\n                </div>\r\n                {address.is_default && (\r\n                  <Badge variant=\"secondary\" className=\"shrink-0 text-xs bg-selected text-primary border-0\">\r\n                    <Star className=\"size-3 mr-1\" weight=\"fill\" />\r\n                    {t.default}\r\n                  </Badge>\r\n                )}\r\n              </div>\r\n            </CardHeader>\r\n            <CardContent className=\"pt-0\">\r\n              <p className=\"font-medium text-sm\">{address.full_name}</p>\r\n              <p className=\"text-sm text-muted-foreground line-clamp-2\">{address.address_line1}, {address.city}</p>\r\n            </CardContent>\r\n          </Card>\r\n        </SheetTrigger>\r\n        <SheetContent side=\"bottom\" className=\"h-auto max-h-(--dialog-h-85vh)\">\r\n          <SheetHeader className=\"text-left\">\r\n            <SheetTitle className=\"flex items-center gap-2\">\r\n              <LabelIcon className={`size-5 ${getLabelColor(address.label)}`} weight=\"duotone\" />\r\n              {address.label}\r\n              {address.is_default && (\r\n                <Badge variant=\"secondary\" className=\"ml-2 text-xs bg-selected text-primary border-0\">\r\n                  <Star className=\"size-3 mr-1\" weight=\"fill\" />\r\n                  {t.default}\r\n                </Badge>\r\n              )}\r\n            </SheetTitle>\r\n            <SheetDescription>{t.addressDetails}</SheetDescription>\r\n          </SheetHeader>\r\n          <ScrollArea className=\"mt-4 max-h-(--dialog-h-50vh)\">\r\n            <div className=\"space-y-4\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-muted-foreground mb-1\">{t.deliveryAddress}</p>\r\n                <div className=\"space-y-1\">\r\n                  <p className=\"font-medium\">{address.full_name}</p>\r\n                  {formatAddress(address).map((line, i) => (\r\n                    <p key={i} className=\"text-muted-foreground\">{line}</p>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n              {address.phone && (\r\n                <div>\r\n                  <p className=\"text-sm font-medium text-muted-foreground mb-1\">{t.phone}</p>\r\n                  <p className=\"flex items-center gap-2\">\r\n                    <Phone className=\"size-4 text-muted-foreground\" />\r\n                    {address.phone}\r\n                  </p>\r\n                </div>\r\n              )}\r\n              <Separator />\r\n              <div className=\"space-y-2\">\r\n                <p className=\"text-sm font-medium text-muted-foreground\">{t.actions}</p>\r\n                <div className=\"flex flex-col gap-2\">\r\n                  {!address.is_default && (\r\n                    <Button \r\n                      variant=\"outline\" \r\n                      className=\"justify-start gap-2\"\r\n                      onClick={() => {\r\n                        onSetDefault(address.id)\r\n                        setOpenSheetId(null)\r\n                      }}\r\n                      disabled={isLoading}\r\n                    >\r\n                      <Star className=\"size-4\" />\r\n                      {t.setDefault}\r\n                    </Button>\r\n                  )}\r\n                  <Button \r\n                    variant=\"outline\" \r\n                    className=\"justify-start gap-2\"\r\n                    onClick={() => {\r\n                      onEdit(address)\r\n                      setOpenSheetId(null)\r\n                    }}\r\n                  >\r\n                    <Pencil className=\"size-4\" />\r\n                    {t.edit}\r\n                  </Button>\r\n                  <Button \r\n                    variant=\"outline\" \r\n                    className=\"justify-start gap-2 text-destructive hover:text-destructive\"\r\n                    onClick={() => {\r\n                      onDelete(address.id)\r\n                      setOpenSheetId(null)\r\n                    }}\r\n                  >\r\n                    <Trash className=\"size-4\" />\r\n                    {t.delete}\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </ScrollArea>\r\n        </SheetContent>\r\n      </Sheet>\r\n    )\r\n  }\r\n\r\n  // Desktop card\r\n  const DesktopAddressCard = ({ address }: { address: UserAddress }) => {\r\n    const LabelIcon = getLabelIcon(address.label)\r\n\r\n    return (\r\n      <Card className={`${address.is_default ? 'border-selected-border ring-1 ring-border-subtle' : ''}`}>\n        <CardHeader className=\"pb-3\">\r\n          <div className=\"flex items-start justify-between\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <LabelIcon className={`size-5 ${getLabelColor(address.label)}`} weight=\"duotone\" />\r\n              <CardTitle className=\"text-base\">{address.label}</CardTitle>\r\n              {address.is_default && (\r\n                <Badge variant=\"secondary\" className=\"text-xs bg-selected text-primary border-0\">\r\n                  <Star className=\"size-3 mr-1\" weight=\"fill\" />\r\n                  {t.default}\r\n                </Badge>\r\n              )}\r\n            </div>\r\n            <div className=\"flex items-center gap-1\">\r\n              <Button \r\n                variant=\"ghost\" \r\n                size=\"icon\" \r\n                className=\"size-8\"\r\n                onClick={() => onEdit(address)}\r\n              >\r\n                <Pencil className=\"size-4\" />\r\n              </Button>\r\n              <Button \r\n                variant=\"ghost\" \r\n                size=\"icon\" \r\n                className=\"size-8 text-destructive hover:text-destructive\"\r\n                onClick={() => onDelete(address.id)}\r\n              >\r\n                <Trash className=\"size-4\" />\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"text-sm space-y-1\">\r\n            <p className=\"font-medium\">{address.full_name}</p>\r\n            {formatAddress(address).map((line, i) => (\r\n              <p key={i} className=\"text-muted-foreground\">{line}</p>\r\n            ))}\r\n            {address.phone && (\r\n              <p className=\"text-muted-foreground pt-1 flex items-center gap-2\">\r\n                <Phone className=\"size-3.5\" />\r\n                {address.phone}\r\n              </p>\r\n            )}\r\n          </div>\r\n          {!address.is_default && (\r\n            <Button \r\n              variant=\"link\" \r\n              className=\"mt-3 h-auto p-0 text-sm text-primary\"\r\n              onClick={() => onSetDefault(address.id)}\r\n              disabled={isLoading}\r\n            >\r\n              {t.setDefault}\r\n            </Button>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n    )\r\n  }\r\n\r\n  // Inline add new card JSX\r\n  const addNewCardJSX = (\r\n    <Card \r\n      className=\"border-dashed cursor-pointer hover:border-hover-border hover:bg-hover transition-colors\"\r\n      onClick={onAdd}\r\n    >\r\n      <CardContent className=\"flex flex-col items-center justify-center h-full min-h-44 py-8\">\r\n        <div className=\"size-12 rounded-full bg-muted flex items-center justify-center mb-3\">\r\n          <Plus className=\"size-6 text-muted-foreground\" />\r\n        </div>\r\n        <p className=\"text-muted-foreground font-medium text-sm\">\r\n          {t.addNew}\r\n        </p>\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Mobile view */}\r\n      <div className=\"grid gap-3 sm:hidden\">\r\n        {addresses.map((address) => (\r\n          <MobileAddressCard key={address.id} address={address} />\r\n        ))}\r\n        {addNewCardJSX}\r\n      </div>\r\n\r\n      {/* Desktop view */}\r\n      <div className=\"hidden sm:grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\r\n        {addresses.map((address) => (\r\n          <DesktopAddressCard key={address.id} address={address} />\r\n        ))}\r\n        {addNewCardJSX}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\account-addresses-stats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\account-badges.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\account-chart.tsx","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | number | Date`.","line":188,"column":39,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":188,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { Area, AreaChart, CartesianGrid, XAxis } from \"recharts\"\r\n\r\nimport { useIsMobile } from \"@/hooks/use-mobile\"\r\nimport {\r\n  Card,\r\n  CardAction,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport {\r\n  ChartConfig,\r\n  ChartContainer,\r\n  ChartTooltip,\r\n  ChartTooltipContent,\r\n} from \"@/components/shared/charts/chart\"\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport {\r\n  ToggleGroup,\r\n  ToggleGroupItem,\r\n} from \"@/components/ui/toggle-group\"\r\n\r\ninterface AccountChartProps {\r\n  locale: string\r\n}\r\n\r\n// Generate sample data - in production, this would come from the database\r\nconst generateChartData = () => {\r\n  const data = []\r\n  const now = new Date()\r\n  for (let i = 90; i >= 0; i--) {\r\n    const date = new Date(now)\r\n    date.setDate(date.getDate() - i)\r\n    data.push({\r\n      date: date.toISOString().split('T')[0],\r\n      orders: Math.floor(Math.random() * 5),\r\n      sales: Math.floor(Math.random() * 3),\r\n    })\r\n  }\r\n  return data\r\n}\r\n\r\nconst chartData = generateChartData()\r\n\r\nconst chartConfig = {\r\n  activity: {\r\n    label: \"Activity\",\r\n  },\r\n  orders: {\r\n    label: \"Orders\",\r\n    color: \"var(--color-chart-1)\",\r\n  },\r\n  sales: {\r\n    label: \"Sales\",\r\n    color: \"var(--color-chart-2)\",\r\n  },\r\n} satisfies ChartConfig\r\n\r\nexport function AccountChart({ locale }: AccountChartProps) {\r\n  const isMobile = useIsMobile()\r\n  const [timeRange, setTimeRange] = React.useState(\"90d\")\r\n  const [activeChart, setActiveChart] = React.useState<\"orders\" | \"sales\">(\"orders\")\r\n\r\n  React.useEffect(() => {\r\n    if (isMobile) {\r\n      setTimeRange(\"7d\")\r\n    }\r\n  }, [isMobile])\r\n\r\n  const filteredData = chartData.filter((item) => {\r\n    if (!item.date) return false\r\n    const date = new Date(item.date)\r\n    const now = new Date()\r\n    let daysToSubtract = 90\r\n    if (timeRange === \"30d\") {\r\n      daysToSubtract = 30\r\n    } else if (timeRange === \"7d\") {\r\n      daysToSubtract = 7\r\n    }\r\n    now.setDate(now.getDate() - daysToSubtract)\r\n    return date >= now\r\n  })\r\n\r\n  const t = {\r\n    title: locale === 'bg' ? '╨ö╨╡╨╣╨╜╨╛╤ü╤é' : 'Activity',\r\n    description: locale === 'bg' ? '╨ƒ╤Ç╨╡╨│╨╗╨╡╨┤ ╨╜╨░ ╨▓╨░╤ê╨░╤é╨░ ╨┤╨╡╨╣╨╜╨╛╤ü╤é' : 'Overview of your activity',\r\n    orders: locale === 'bg' ? '╨ƒ╨╛╤Ç╤è╤ç╨║╨╕' : 'Orders',\r\n    sales: locale === 'bg' ? '╨ƒ╤Ç╨╛╨┤╨░╨╢╨▒╨╕' : 'Sales',\r\n    last90: locale === 'bg' ? '╨ƒ╨╛╤ü╨╗╨╡╨┤╨╜╨╕ 3 ╨╝╨╡╤ü╨╡╤å╨░' : 'Last 3 months',\r\n    last30: locale === 'bg' ? '╨ƒ╨╛╤ü╨╗╨╡╨┤╨╜╨╕ 30 ╨┤╨╜╨╕' : 'Last 30 days',\r\n    last7: locale === 'bg' ? '╨ƒ╨╛╤ü╨╗╨╡╨┤╨╜╨╕ 7 ╨┤╨╜╨╕' : 'Last 7 days',\r\n  }\r\n\r\n  // Hide chart on mobile for cleaner app-like UX\r\n  if (isMobile) {\r\n    return null\r\n  }\r\n\r\n  return (\r\n    <Card className=\"@container/chart\">\r\n      <CardHeader>\r\n        <CardTitle>{t.title}</CardTitle>\r\n        <CardDescription>\r\n          {t.description}\r\n        </CardDescription>\r\n        <CardAction>\r\n          <ToggleGroup\r\n            type=\"single\"\r\n            value={activeChart}\r\n            onValueChange={(v) => v && setActiveChart(v as \"orders\" | \"sales\")}\r\n            variant=\"outline\"\r\n            className=\"hidden *:data-[slot=toggle-group-item]:px-4! @[767px]/chart:flex\"\r\n          >\r\n            <ToggleGroupItem value=\"orders\">{t.orders}</ToggleGroupItem>\r\n            <ToggleGroupItem value=\"sales\">{t.sales}</ToggleGroupItem>\r\n          </ToggleGroup>\r\n          <Select value={timeRange} onValueChange={setTimeRange}>\r\n            <SelectTrigger\r\n              className=\"hidden w-40 **:data-[slot=select-value]:block **:data-[slot=select-value]:truncate @[767px]/chart:flex\"\r\n              aria-label=\"Select time range\"\r\n            >\r\n              <SelectValue placeholder={t.last90} />\r\n            </SelectTrigger>\r\n            <SelectContent className=\"rounded-md\">\r\n              <SelectItem value=\"90d\" className=\"rounded-lg\">\r\n                {t.last90}\r\n              </SelectItem>\r\n              <SelectItem value=\"30d\" className=\"rounded-lg\">\r\n                {t.last30}\r\n              </SelectItem>\r\n              <SelectItem value=\"7d\" className=\"rounded-lg\">\r\n                {t.last7}\r\n              </SelectItem>\r\n            </SelectContent>\r\n          </Select>\r\n        </CardAction>\r\n      </CardHeader>\r\n      <CardContent className=\"px-2 pt-4 sm:px-6 sm:pt-6\">\r\n        <ChartContainer\r\n          config={chartConfig}\r\n          className=\"aspect-auto h-(--chart-h-sm) w-full\"\r\n        >\r\n          <AreaChart data={filteredData}>\r\n            <defs>\r\n              <linearGradient id=\"fillOrders\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                <stop\r\n                  offset=\"5%\"\r\n                  stopColor=\"var(--color-orders)\"\r\n                  stopOpacity={1.0}\r\n                />\r\n                <stop\r\n                  offset=\"95%\"\r\n                  stopColor=\"var(--color-orders)\"\r\n                  stopOpacity={0.1}\r\n                />\r\n              </linearGradient>\r\n              <linearGradient id=\"fillSales\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\r\n                <stop\r\n                  offset=\"5%\"\r\n                  stopColor=\"var(--color-sales)\"\r\n                  stopOpacity={0.8}\r\n                />\r\n                <stop\r\n                  offset=\"95%\"\r\n                  stopColor=\"var(--color-sales)\"\r\n                  stopOpacity={0.1}\r\n                />\r\n              </linearGradient>\r\n            </defs>\r\n            <CartesianGrid vertical={false} />\r\n            <XAxis\r\n              dataKey=\"date\"\r\n              tickLine={false}\r\n              axisLine={false}\r\n              tickMargin={8}\r\n              minTickGap={32}\r\n              tickFormatter={(value) => {\r\n                const date = new Date(value)\r\n                return date.toLocaleDateString(locale === 'bg' ? 'bg-BG' : 'en-US', {\r\n                  month: \"short\",\r\n                  day: \"numeric\",\r\n                })\r\n              }}\r\n            />\r\n            <ChartTooltip\r\n              cursor={false}\r\n              defaultIndex={isMobile ? -1 : 10}\r\n              content={\r\n                <ChartTooltipContent\r\n                  labelFormatter={(value) => {\r\n                    return new Date(value).toLocaleDateString(locale === 'bg' ? 'bg-BG' : 'en-US', {\r\n                      month: \"short\",\r\n                      day: \"numeric\",\r\n                    })\r\n                  }}\r\n                  indicator=\"dot\"\r\n                />\r\n              }\r\n            />\r\n            <Area\r\n              dataKey={activeChart}\r\n              type=\"natural\"\r\n              fill={activeChart === \"orders\" ? \"url(#fillOrders)\" : \"url(#fillSales)\"}\r\n              stroke={activeChart === \"orders\" ? \"var(--color-orders)\" : \"var(--color-sales)\"}\r\n              stackId=\"a\"\r\n            />\r\n          </AreaChart>\r\n        </ChartContainer>\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\account-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\account-hero-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\account-page-header-skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\account-recent-activity.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getStatusColor' to the outer scope.","line":84,"column":50,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":84,"endColumn":52}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { formatDistanceToNow } from \"date-fns\"\r\nimport { bg, enUS } from \"date-fns/locale\"\r\nimport { useEffect, useState } from \"react\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport Image from \"next/image\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { IconChevronRight, IconPackage, IconPhoto, IconShoppingBag } from \"@tabler/icons-react\"\r\n\r\n// Extracted to avoid creating component during render\r\nfunction SectionHeader({ title, href, viewAllText }: { title: string; href: string; viewAllText: string }) {\r\n  return (\r\n    <div className=\"flex items-center justify-between px-1 mb-3\">\r\n      <span className=\"font-semibold text-base text-foreground\">{title}</span>\r\n      <Link\r\n        href={href}\r\n        className=\"text-xs font-medium text-link hover:text-link-hover transition-colors flex items-center gap-0.5\"\r\n      >\r\n        {viewAllText}\r\n        <IconChevronRight className=\"size-3.5\" />\r\n      </Link>\r\n    </div>\r\n  )\r\n}\r\n\r\ninterface RecentOrder {\r\n  id: string\r\n  total_amount: number\r\n  status: string | null\r\n  created_at: string\r\n  order_items?: Array<{\r\n    id: string\r\n    products: { images?: string[] } | { images?: string[] }[] | null\r\n  }>\r\n}\r\n\r\ninterface RecentProduct {\r\n  id: string\r\n  title: string\r\n  price: number\r\n  stock: number\r\n  images?: string[]\r\n  created_at: string\r\n}\r\n\r\ninterface RecentSale {\r\n  id: string\r\n  price_at_purchase: number\r\n  quantity: number\r\n  created_at?: string | null\r\n  product_title?: string | null\r\n  product_image?: string | null\r\n}\r\n\r\ninterface AccountRecentActivityProps {\r\n  orders: RecentOrder[]\r\n  products: RecentProduct[]\r\n  sales: RecentSale[]\r\n  locale: string\r\n}\r\n\r\nexport function AccountRecentActivity({ orders, products, sales, locale }: AccountRecentActivityProps) {\r\n  const dateLocale = locale === 'bg' ? bg : enUS\r\n  const [mounted, setMounted] = useState(false)\r\n\r\n  useEffect(() => {\r\n    setMounted(true)\r\n  }, [])\r\n\r\n  const formatRelative = (value: string, withSuffix: boolean) => {\r\n    if (!mounted) return \"\"\r\n    return formatDistanceToNow(new Date(value), { addSuffix: withSuffix, locale: dateLocale })\r\n  }\r\n\r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat(locale, {\r\n      style: 'currency',\r\n      currency: 'EUR',\r\n      maximumFractionDigits: 2,\r\n    }).format(value)\r\n  }\r\n\r\n  const getStatusColor = (status: string | null) => {\r\n    switch (status) {\r\n      case 'paid':\r\n        return 'bg-success/10 text-success border-transparent'\r\n      case 'pending':\r\n        return 'bg-warning/10 text-warning border-transparent'\r\n      case 'processing':\r\n        return 'bg-selected text-primary border-transparent'\r\n      case 'shipped':\r\n        return 'bg-info/10 text-info border-transparent'\r\n      case 'delivered':\r\n        return 'bg-success/10 text-success border-transparent'\r\n      case 'cancelled':\r\n        return 'bg-destructive-subtle text-destructive border-transparent'\n      default:\r\n        return 'bg-muted text-muted-foreground border-transparent'\r\n    }\r\n  }\r\n\r\n  const getStatusText = (status: string | null) => {\r\n    if (locale === 'bg') {\r\n      switch (status) {\r\n        case 'paid': return '╨ƒ╨╗╨░╤é╨╡╨╜╨░'\r\n        case 'pending': return '╨ÿ╨╖╤ç╨░╨║╨▓╨░╨╜╨╡'\r\n        case 'processing': return '╨₧╨▒╤Ç╨░╨▒╨╛╤é╨║╨░'\r\n        case 'shipped': return '╨ÿ╨╖╨┐╤Ç╨░╤é╨╡╨╜╨░'\r\n        case 'delivered': return '╨ö╨╛╤ü╤é╨░╨▓╨╡╨╜╨░'\r\n        case 'cancelled': return '╨₧╤é╨╝╨╡╨╜╨╡╨╜╨░'\r\n        default: return status || '╨¥╨╡╨╕╨╖╨▓╨╡╤ü╤é╨╡╨╜'\r\n      }\r\n    }\r\n    return status || 'Unknown'\r\n  }\r\n\r\n  const t = {\r\n    recentOrders: locale === 'bg' ? '╨ƒ╨╛╤ü╨╗╨╡╨┤╨╜╨╕ ╨┐╨╛╤Ç╤è╤ç╨║╨╕' : 'Recent Orders',\r\n    myProducts: locale === 'bg' ? '╨£╨╛╨╕╤é╨╡ ╨╛╨▒╤Å╨▓╨╕' : 'My Listings',\r\n    recentSales: locale === 'bg' ? '╨ƒ╨╛╤ü╨╗╨╡╨┤╨╜╨╕ ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕' : 'Recent Sales',\r\n    noOrders: locale === 'bg' ? '╨¥╤Å╨╝╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨╕' : 'No orders yet',\r\n    noProducts: locale === 'bg' ? '╨¥╤Å╨╝╨░ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨╕' : 'No products yet',\r\n    noSales: locale === 'bg' ? '╨¥╤Å╨╝╨░ ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕' : 'No sales yet',\r\n    inStock: locale === 'bg' ? '╨▒╤Ç.' : 'in stock',\r\n    viewAll: locale === 'bg' ? '╨Æ╨╕╨╢ ╨▓╤ü╨╕╤ç╨║╨╕' : 'See all',\r\n    activity: locale === 'bg' ? '╨É╨║╤é╨╕╨▓╨╜╨╛╤ü╤é' : 'Activity',\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Recent Orders Section - Horizontal scroll on mobile */}\r\n      <div>\r\n        <SectionHeader title={t.recentOrders} href=\"/account/orders\" viewAllText={t.viewAll} />\r\n        {orders.length === 0 ? (\r\n          <div className=\"rounded-md bg-card border border-border p-4 text-center\">\r\n            <div className=\"flex size-14 mx-auto items-center justify-center rounded-md bg-muted border border-border mb-3\">\r\n              <IconPackage className=\"size-6 text-muted-foreground\" />\r\n            </div>\r\n            <p className=\"text-sm text-muted-foreground\">{t.noOrders}</p>\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {/* Mobile: Horizontal scroll cards */}\r\n            <div className=\"md:hidden -mx-4 px-4 overflow-x-auto no-scrollbar\">\r\n              <div className=\"flex gap-3 pb-2\" style={{ width: 'max-content' }}>\r\n                {orders.slice(0, 5).map((order) => {\r\n                  const getProductImage = (products: { images?: string[] } | { images?: string[] }[] | null): string | undefined => {\r\n                    if (!products) return undefined\r\n                    if (Array.isArray(products)) return products[0]?.images?.[0]\r\n                    return products.images?.[0]\r\n                  }\r\n                  const firstImage = order.order_items?.find(item => getProductImage(item.products))\r\n                  const firstImageUrl = firstImage ? getProductImage(firstImage.products) : undefined\r\n                  const itemCount = order.order_items?.length || 0\r\n\r\n                  return (\r\n                    <Link\r\n                      key={order.id}\r\n                      href={`/account/orders/${order.id}`}\r\n                      className=\"flex flex-col w-36 rounded-md bg-card border border-border p-3 transition-colors\"\r\n                    >\r\n                      {/* Order Image */}\r\n                      <div className=\"relative w-full aspect-square rounded-md overflow-hidden bg-card border border-border mb-3\">\r\n                        {firstImageUrl ? (\r\n                          <>\r\n                            <Image\r\n                              src={firstImageUrl}\r\n                              alt={`Order #${order.id.slice(0, 4)}`}\r\n                              fill\r\n                              className=\"object-cover\"\r\n                              sizes=\"144px\"\r\n                            />\r\n                            {itemCount > 1 && (\r\n                              <div className=\"absolute top-2 right-2 flex size-6 items-center justify-center rounded-full bg-surface-overlay backdrop-blur-sm text-2xs font-bold text-overlay-text\">\r\n                                +{itemCount - 1}\r\n                              </div>\r\n                            )}\r\n                          </>\r\n                        ) : (\r\n                          <div className=\"flex size-full items-center justify-center\">\r\n                            <IconShoppingBag className=\"size-8 text-muted-foreground\" strokeWidth={1.5} />\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                      {/* Order Info */}\r\n                      <p className=\"text-sm font-bold text-foreground mb-0.5\">\r\n                        {formatCurrency(order.total_amount)}\r\n                      </p>\r\n                      {formatRelative(order.created_at, false) && (\r\n                        <p className=\"text-xs text-muted-foreground mb-2\">\r\n                          {formatRelative(order.created_at, false)}\r\n                        </p>\r\n                      )}\r\n                      <Badge variant=\"outline\" className={`text-2xs font-medium w-fit ${getStatusColor(order.status)}`}>\r\n                        {getStatusText(order.status)}\r\n                      </Badge>\r\n                    </Link>\r\n                  )\r\n                })}\r\n              </div>\r\n             </div>\r\n\r\n             {/* Desktop: List view */}\r\n            <div className=\"hidden md:block rounded-md bg-card border border-border overflow-hidden\">\r\n              <div className=\"divide-y divide-border/50\">\r\n                {orders.slice(0, 3).map((order) => {\r\n                  const getProductImage = (products: { images?: string[] } | { images?: string[] }[] | null): string | undefined => {\r\n                    if (!products) return undefined\r\n                    if (Array.isArray(products)) return products[0]?.images?.[0]\r\n                    return products.images?.[0]\r\n                  }\r\n                  const firstImage = order.order_items?.find(item => getProductImage(item.products))\r\n                  const firstImageUrl = firstImage ? getProductImage(firstImage.products) : undefined\r\n                  const itemCount = order.order_items?.length || 0\r\n\r\n                  return (\r\n                    <Link\r\n                      key={order.id}\r\n                      href={`/account/orders/${order.id}`}\r\n                      className=\"flex items-center gap-3 p-4 hover:bg-hover active:bg-active transition-colors\"\r\n                    >\r\n                      <div className=\"relative size-11 rounded-md overflow-hidden bg-card border border-border shrink-0\">\r\n                        {firstImageUrl ? (\r\n                          <>\r\n                            <Image\r\n                              src={firstImageUrl}\r\n                              alt={`Order #${order.id.slice(0, 4)}`}\r\n                              fill\r\n                              className=\"object-cover\"\r\n                              sizes=\"44px\"\r\n                            />\r\n                            {itemCount > 1 && (\r\n                              <div className=\"absolute -bottom-0.5 -right-0.5 flex size-5 items-center justify-center rounded-full bg-primary text-2xs font-bold text-primary-foreground shadow-sm\">\r\n                                +{itemCount - 1}\r\n                              </div>\r\n                            )}\r\n                          </>\r\n                        ) : (\r\n                          <div className=\"flex size-full items-center justify-center\">\r\n                            <IconPackage className=\"size-5 text-muted-foreground\" strokeWidth={1.5} />\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <p className=\"text-sm font-semibold text-foreground\">\r\n                          {formatCurrency(order.total_amount)}\r\n                        </p>\r\n                        {formatRelative(order.created_at, true) && (\r\n                          <p className=\"text-xs text-muted-foreground mt-0.5\">\r\n                            {formatRelative(order.created_at, true)}\r\n                          </p>\r\n                        )}\r\n                      </div>\r\n                      <Badge variant=\"outline\" className={`text-2xs font-medium shrink-0 ${getStatusColor(order.status)}`}>\r\n                        {getStatusText(order.status)}\r\n                      </Badge>\r\n                    </Link>\r\n                  )\r\n                })}\r\n              </div>\r\n            </div>\r\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {/* My Products Section - Only show if has products */}\r\n      {products.length > 0 && (\r\n        <div>\r\n          <SectionHeader title={t.myProducts} href=\"/account/selling\" viewAllText={t.viewAll} />\r\n\r\n          {/* Mobile: Horizontal scroll cards */}\r\n          <div className=\"md:hidden -mx-4 px-4 overflow-x-auto no-scrollbar\">\r\n            <div className=\"flex gap-3 pb-2\" style={{ width: 'max-content' }}>\r\n              {products.slice(0, 5).map((product) => (\r\n                <Link\r\n                  key={product.id}\r\n                  href={`/product/${product.id}`}\r\n                  className=\"flex flex-col w-36 rounded-md bg-card border border-border p-3 transition-colors\"\r\n                >\r\n                  {/* Product Image */}\r\n                  <div className=\"relative w-full aspect-square rounded-md overflow-hidden bg-card border border-border mb-3\">\r\n                    {product.images?.[0] ? (\r\n                      <Image\r\n                        src={product.images[0]}\r\n                        alt={product.title}\r\n                        fill\r\n                        className=\"object-cover\"\r\n                        sizes=\"144px\"\r\n                      />\r\n                    ) : (\r\n                      <div className=\"flex size-full items-center justify-center\">\r\n                        <IconPhoto className=\"size-8 text-muted-foreground\" strokeWidth={1.5} />\r\n                      </div>\r\n                    )}\r\n                    {/* Stock badge */}\r\n                    <div className=\"absolute top-2 right-2 flex items-center justify-center px-1.5 py-0.5 rounded-full bg-surface-overlay backdrop-blur-sm text-2xs font-medium text-overlay-text\">\r\n                      {product.stock} {t.inStock}\r\n                    </div>\r\n                  </div>\r\n                  {/* Product Info */}\r\n                  <p className=\"text-sm font-semibold text-foreground mb-1 line-clamp-2 leading-tight\">\r\n                    {product.title}\r\n                  </p>\r\n                  <p className=\"text-sm font-bold text-success mt-auto\">\r\n                    {formatCurrency(product.price)}\r\n                  </p>\r\n                </Link>\r\n              ))}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Desktop: List view */}\r\n          <div className=\"hidden md:block rounded-md bg-card border border-border overflow-hidden\">\r\n            <div className=\"divide-y divide-border/50\">\r\n              {products.slice(0, 3).map((product) => (\r\n                <Link\r\n                  key={product.id}\r\n                  href={`/product/${product.id}`}\r\n                  className=\"flex items-center gap-3 p-4 hover:bg-hover active:bg-active transition-colors\"\r\n                >\r\n                  <div className=\"relative size-11 rounded-md overflow-hidden bg-card border border-border shrink-0\">\r\n                    {product.images?.[0] ? (\r\n                      <Image\r\n                        src={product.images[0]}\r\n                        alt={product.title}\r\n                        fill\r\n                        className=\"object-cover\"\r\n                        sizes=\"44px\"\r\n                      />\r\n                    ) : (\r\n                      <div className=\"flex size-full items-center justify-center\">\r\n                        <IconPhoto className=\"size-5 text-muted-foreground\" strokeWidth={1.5} />\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                  <div className=\"flex-1 min-w-0\">\r\n                    <p className=\"text-sm font-semibold text-foreground truncate\">\r\n                      {product.title}\r\n                    </p>\r\n                    <p className=\"text-xs text-muted-foreground mt-0.5\">\r\n                      {product.stock} {t.inStock}\r\n                    </p>\r\n                  </div>\r\n                  <span className=\"text-sm font-bold text-success\">\r\n                    {formatCurrency(product.price)}\r\n                  </span>\r\n                </Link>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Recent Sales Section - Only show if has sales */}\r\n      {sales.length > 0 && (\r\n        <div>\r\n          <SectionHeader title={t.recentSales} href=\"/account/sales\" viewAllText={t.viewAll} />\r\n          <div className=\"rounded-md bg-card border border-border overflow-hidden\">\r\n            <div className=\"divide-y divide-border/50\">\r\n              {sales.slice(0, 3).map((sale, index) => (\r\n                <div key={`${sale.id}-${index}`} className=\"flex items-center gap-3 p-4\">\r\n                  {/* Product Image or Quantity Badge */}\r\n                  <div className=\"relative size-11 rounded-md overflow-hidden bg-success/10 shrink-0\">\r\n                    {sale.product_image ? (\r\n                      <>\r\n                        <Image\r\n                          src={sale.product_image}\r\n                          alt={sale.product_title || 'Product'}\r\n                          fill\r\n                          className=\"object-cover\"\r\n                          sizes=\"44px\"\r\n                        />\r\n                        {/* Quantity badge overlay */}\r\n                        <div className=\"absolute -bottom-0.5 -right-0.5 flex size-5 items-center justify-center rounded-full bg-success text-2xs font-bold text-primary-foreground shadow-sm\">\r\n                          {sale.quantity}\r\n                        </div>\r\n                      </>\r\n                    ) : (\r\n                      <div className=\"flex size-full items-center justify-center\">\r\n                        <span className=\"text-sm font-bold text-success\">x{sale.quantity}</span>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                  <div className=\"flex-1 min-w-0\">\r\n                    <p className=\"text-sm font-semibold text-foreground truncate\">\r\n                      {sale.product_title || `Item #${sale.id.slice(0, 6)}`}\r\n                    </p>\r\n                    {sale.created_at && formatRelative(sale.created_at, true) && (\r\n                      <p className=\"text-xs text-muted-foreground mt-0.5\">\r\n                        {formatRelative(sale.created_at, true)}\r\n                      </p>\r\n                    )}\r\n                  </div>\r\n                  <span className=\"text-sm font-bold text-success\">\r\n                    +{formatCurrency(sale.price_at_purchase * sale.quantity)}\r\n                  </span>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\account-sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\account-stats-cards.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\account-tab-bar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\plan-card.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 28 to the 25 allowed.","line":75,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":75,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Check, User, Crown, Buildings, Rocket, SpinnerGap } from \"@phosphor-icons/react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { useTranslations } from \"next-intl\"\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface Plan {\r\n  id: string\r\n  name: string\r\n  tier: string\r\n  account_type: \"personal\" | \"business\"\r\n  price_monthly: number\r\n  price_yearly: number\r\n  max_listings: number | null\r\n  // Fee structure (all paid by seller from their earnings)\r\n  final_value_fee: number  // % of sale taken when item sells\r\n  insertion_fee: number    // Fee per listing AFTER free allowance\r\n  per_order_fee: number    // Flat fee per transaction (payment processing)\r\n  boosts_included: number\r\n  priority_support: boolean\r\n  analytics_access: string\r\n  badge_type: string | null\r\n  description: string\r\n  description_bg: string\r\n  features: string[]\r\n  // Legacy field for backward compatibility during migration\r\n  commission_rate?: number\r\n}\r\n\r\ninterface PlanCardProps {\r\n  plan: Plan\r\n  locale: string\r\n  billingPeriod: \"monthly\" | \"yearly\"\r\n  isCurrentPlan?: boolean\r\n  isLoading?: boolean\r\n  onSelect?: (plan: Plan) => void\r\n  variant?: \"compact\" | \"full\"\r\n}\r\n\r\n// =============================================================================\r\n// Utility Functions\r\n// =============================================================================\r\n\r\nfunction getPlanIcon(tier: string) {\r\n  switch (tier) {\r\n    case \"basic\":\r\n      return <User weight=\"duotone\" className=\"size-5\" />\r\n    case \"premium\":\r\n      return <Crown weight=\"fill\" className=\"size-5\" />\r\n    case \"business\":\r\n      return <Buildings weight=\"duotone\" className=\"size-5\" />\r\n    default:\r\n      return <Rocket weight=\"duotone\" className=\"size-5\" />\r\n  }\r\n}\r\n\r\nfunction isPremiumPlan(plan: Plan): boolean {\r\n  return plan.tier === \"premium\" || plan.name.toLowerCase().includes(\"pro\")\r\n}\r\n\r\nfunction isBestValuePlan(plan: Plan): boolean {\r\n  return plan.name.toLowerCase().includes(\"pro+\") || plan.name.toLowerCase().includes(\"enterprise\")\r\n}\r\n\r\n// =============================================================================\r\n// Component\r\n// =============================================================================\r\n\r\nexport function PlanCard({\r\n  plan,\r\n  locale,\r\n  billingPeriod,\r\n  isCurrentPlan = false,\r\n  isLoading = false,\r\n  onSelect,\r\n  variant = \"compact\",\r\n}: PlanCardProps) {\r\n  const t = useTranslations(\"Plans\")\r\n  const isPopular = isPremiumPlan(plan) && !isBestValuePlan(plan)\r\n  const isBest = isBestValuePlan(plan)\r\n  const price = billingPeriod === \"monthly\" ? plan.price_monthly : plan.price_yearly\r\n\r\n  const formatPrice = (price: number) => {\r\n    if (price === 0) return t(\"free\")\r\n    // Bulgaria joins Eurozone Jan 2026\r\n    return new Intl.NumberFormat(locale, {\r\n      style: \"currency\",\r\n      currency: \"EUR\",\r\n      minimumFractionDigits: 0,\r\n      maximumFractionDigits: 0,\r\n    }).format(price)\r\n  }\r\n\r\n  const maxFeatures = variant === \"compact\" ? 3 : 6\r\n  const visibleFeatures = plan.features.slice(0, maxFeatures)\r\n  const hiddenCount = plan.features.length - maxFeatures\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"relative flex flex-col rounded-md border bg-card transition-all\",\r\n        // Mobile: large cards for horizontal scroll (shows ~10-15% peek of next card)\r\n        // Using calc to account for container padding (1rem each side) and gap (1rem)\r\n        // Compact: smaller cards for modals, Full: larger cards for pages\r\n        variant === \"compact\" \r\n          ? \"min-w-(--container-2xs) max-w-(--container-xs) w-full shrink-0 snap-center md:w-auto md:min-w-0 md:max-w-none md:shrink md:snap-none\"\r\n          : \"min-w-(--container-dropdown) max-w-(--container-modal-sm) w-full shrink-0 snap-center md:w-auto md:min-w-0 md:max-w-none md:shrink md:snap-none\",\r\n        // Styling based on plan type\n        isPopular && \"border-primary ring-1 ring-primary shadow-md\",\n        isBest && \"border-rating ring-1 ring-rating shadow-md\",\n        isCurrentPlan && \"bg-selected\",\n        // Padding\n        variant === \"compact\" ? \"p-3\" : \"p-3 md:p-4\"\n      )}\n    >\n      {/* Badge */}\r\n      {(isPopular || isBest) && (\r\n        <Badge\r\n          className={cn(\r\n            \"absolute -top-2.5 left-1/2 -translate-x-1/2 text-xs px-2 py-0.5\",\r\n            isPopular && \"bg-primary text-primary-foreground\",\r\n            isBest && \"bg-rating text-primary-foreground\"\r\n          )}\r\n        >\r\n          {isBest ? t(\"bestValue\") : t(\"popular\")}\r\n        </Badge>\r\n      )}\r\n\r\n      {/* Header: Icon + Name */}\r\n      <div className=\"flex items-center gap-3 mb-3\">\r\n        <div\r\n          className={cn(\r\n            \"size-10 rounded-lg flex items-center justify-center shrink-0\",\r\n            isPopular\r\n              ? \"bg-primary text-primary-foreground\"\r\n              : isBest\r\n                ? \"bg-rating text-primary-foreground\"\r\n                : \"bg-muted text-muted-foreground\"\r\n          )}\r\n        >\r\n          {getPlanIcon(plan.tier)}\r\n        </div>\r\n        <div className=\"min-w-0 flex-1\">\r\n          <h3 className=\"font-semibold text-base leading-tight truncate\">{plan.name}</h3>\r\n            {isCurrentPlan && (\r\n              <Badge variant=\"secondary\" className=\"text-2xs mt-0.5 px-1.5 py-0\">\r\n                {t(\"currentPlan\")}\r\n              </Badge>\r\n            )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Price */}\r\n      <div className=\"mb-3\">\r\n        <div className=\"flex items-baseline gap-1\">\r\n          <span className=\"text-2xl font-bold\">{formatPrice(price)}</span>\r\n          {price > 0 && (\r\n            <span className=\"text-muted-foreground text-sm\">\r\n              {billingPeriod === \"monthly\" ? t(\"perMonth\") : t(\"perYear\")}\r\n            </span>\r\n          )}\r\n        </div>\r\n        {/* Description */}\r\n        {variant === \"full\" && (\r\n          <p className=\"text-xs text-muted-foreground mt-1 line-clamp-2\">\r\n            {locale === \"bg\" ? plan.description_bg : plan.description}\r\n          </p>\r\n        )}\r\n      </div>\r\n\r\n      {/* Stats Row - Simple: listings + fee when sold + boosts */}\r\n      <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground mb-3 pb-3 border-b flex-wrap\">\r\n        {/* Free listings count */}\r\n          <span className=\"inline-flex items-center gap-1\">\r\n            <span className=\"font-semibold text-foreground\">\r\n              {plan.max_listings ?? \"Γê₧\"}\r\n            </span>\r\n            {t(\"listings\")}\r\n          </span>\r\n        <span className=\"text-border\">ΓÇó</span>\r\n        {/* Final Value Fee (% per sale) - THE ONLY FEE */}\r\n          <span className=\"inline-flex items-center gap-1\">\r\n            <span className=\"font-semibold text-foreground\">\r\n              {plan.final_value_fee ?? plan.commission_rate}%\r\n            </span>\r\n            {t(\"fvf\")}\r\n          </span>\r\n        {/* Boosts included */}\r\n        {plan.boosts_included > 0 && (\r\n          <>\r\n            <span className=\"text-border\">ΓÇó</span>\r\n              <span className=\"inline-flex items-center gap-1\">\r\n                <span className=\"font-semibold text-foreground\">\r\n                  {plan.boosts_included >= 999 ? \"Γê₧\" : plan.boosts_included}\r\n                </span>\r\n                {t(\"boosts\")}\r\n              </span>\r\n            </>\r\n          )}\r\n        </div>\r\n\r\n      {/* Features */}\r\n      <div className=\"mb-4 flex-1\">\r\n        {variant === \"full\" && (\r\n          <p className=\"text-2xs font-medium text-muted-foreground uppercase tracking-wide mb-2\">\r\n            {t(\"included\")}\r\n          </p>\r\n        )}\r\n        <ul className=\"space-y-1.5\">\r\n          {visibleFeatures.map((feature, i) => (\r\n            <li key={i} className=\"flex items-start gap-2 text-xs\">\r\n              <Check\r\n                weight=\"bold\"\r\n                className={cn(\r\n                  \"size-3.5 shrink-0 mt-0.5\",\r\n                  isPopular ? \"text-primary\" : isBest ? \"text-rating\" : \"text-muted-foreground\"\r\n                )}\r\n              />\r\n              <span className=\"line-clamp-1\">{feature}</span>\r\n            </li>\r\n          ))}\r\n        </ul>\r\n        {hiddenCount > 0 && (\r\n          <p className=\"text-2xs text-muted-foreground mt-1.5 text-center\">\r\n            +{hiddenCount} {t(\"moreFeatures\")}\r\n          </p>\r\n        )}\r\n      </div>\r\n\r\n      {/* CTA Button */}\r\n      <Button\r\n        size=\"sm\"\r\n        variant={isPopular || isBest ? \"default\" : \"outline\"}\n        className={cn(\n          \"w-full\",\n          isPopular && \"bg-primary hover:bg-interactive-hover\",\n          isBest && \"bg-rating hover:bg-rating/90 text-primary-foreground\",\n          isCurrentPlan && \"opacity-50 cursor-not-allowed\"\n        )}\n        disabled={isCurrentPlan || isLoading}\n        onClick={() => onSelect?.(plan)}\n      >\r\n        {isLoading ? (\r\n          <SpinnerGap className=\"size-4 animate-spin\" />\r\n        ) : isCurrentPlan ? (\r\n          t(\"currentPlan\")\r\n        ) : price === 0 ? (\r\n          t(\"getStarted\")\r\n        ) : (\r\n          t(\"upgrade\")\r\n        )}\r\n      </Button>\r\n    </div>\r\n  )\r\n}\r\n\r\n// =============================================================================\r\n// Plans Grid Component (with mobile horizontal scroll)\r\n// =============================================================================\r\n\r\ninterface PlansGridProps {\r\n  plans: Plan[]\r\n  locale: string\r\n  billingPeriod: \"monthly\" | \"yearly\"\r\n  currentTier?: string\r\n  loadingPlanId?: string | null\r\n  onSelectPlan?: (plan: Plan) => void\r\n  variant?: \"compact\" | \"full\"\r\n  className?: string\r\n}\r\n\r\nexport function PlansGrid({\r\n  plans,\r\n  locale,\r\n  billingPeriod,\r\n  currentTier,\r\n  loadingPlanId,\r\n  onSelectPlan,\r\n  variant = \"compact\",\r\n  className,\r\n}: PlansGridProps) {\r\n  const t = useTranslations(\"Plans\")\r\n  if (plans.length === 0) {\r\n    return (\r\n      <div className=\"text-center py-8 text-muted-foreground\">\r\n        {t(\"noPlansAvailable\")}\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        // Mobile: horizontal scroll with snap, negative margin to extend past container padding\r\n        // pt-3 gives space for badges that overflow top\r\n        \"-mx-4 px-4 pt-3 flex gap-4 overflow-x-auto overflow-y-visible pb-4 snap-x snap-mandatory no-scrollbar\",\r\n        // Desktop: reset margins and use grid layout\r\n        plans.length === 2 && \"md:mx-0 md:px-0 md:grid md:grid-cols-2 md:overflow-visible md:pb-0\",\r\n        plans.length >= 3 && \"md:mx-0 md:px-0 md:grid md:grid-cols-3 md:overflow-visible md:pb-0\",\r\n        className\r\n      )}\r\n    >\r\n      {plans.map((plan) => (\r\n        <PlanCard\r\n          key={plan.id}\r\n          plan={plan}\r\n          locale={locale}\r\n          billingPeriod={billingPeriod}\r\n          isCurrentPlan={plan.tier === currentTier}\r\n          isLoading={loadingPlanId === plan.id}\r\n          {...(onSelectPlan ? { onSelect: onSelectPlan } : {})}\r\n          variant={variant}\r\n        />\r\n      ))}\r\n    </div>\r\n  )\r\n}\r\n\r\n// =============================================================================\r\n// Loading Skeleton\r\n// =============================================================================\r\n\r\nexport function PlansGridSkeleton({ count = 3, variant = \"full\" }: { count?: number; variant?: \"compact\" | \"full\" }) {\r\n  return (\r\n    <div className=\"-mx-4 px-4 pt-3 flex gap-4 overflow-x-auto overflow-y-visible pb-4 snap-x snap-mandatory no-scrollbar md:mx-0 md:px-0 md:grid md:grid-cols-3 md:overflow-visible md:pb-0\">\r\n      {[...Array(count)].map((_, i) => (\r\n        <div\r\n          key={i}\r\n          className={cn(\r\n            \"shrink-0 snap-center md:w-auto md:shrink md:snap-none rounded-md border bg-card p-4\",\r\n            variant === \"compact\"\r\n              ? \"min-w-(--container-2xs) max-w-(--container-xs) w-full\"\r\n              : \"min-w-(--container-dropdown) max-w-(--container-modal-sm) w-full\"\r\n          )}\r\n        >\r\n          <div className=\"flex items-center gap-3 mb-3\">\r\n            <div className=\"size-10 rounded-lg bg-muted\" />\r\n            <div className=\"h-5 w-24 bg-muted rounded\" />\r\n          </div>\r\n          <div className=\"h-8 w-20 bg-muted rounded mb-3\" />\r\n          <div className=\"h-4 bg-muted rounded mb-3\" />\r\n          <div className=\"space-y-2 mb-4\">\r\n            {[...Array(3)].map((_, j) => (\r\n              <div key={j} className=\"h-3 bg-muted rounded w-full\" />\r\n            ))}\r\n          </div>\r\n          <div className=\"h-9 bg-muted rounded\" />\r\n        </div>\r\n      ))}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\plans-modal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_source' is defined but never used.","line":114,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":114,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PlansModalTrigger' is defined but never used.","line":324,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":324,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useCallback, useMemo } from \"react\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useRouter } from \"@/i18n/routing\"\r\nimport { \r\n  Crown, \r\n  Buildings, \r\n  User, \r\n  ArrowRight,\r\n  SealCheck,\r\n} from \"@phosphor-icons/react\"\r\nimport { useLocale } from \"next-intl\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogDescription,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\"\r\nimport { Button } from \"@/components/ui/button\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { cn } from \"@/lib/utils\"\n\n// Reuse shared components from plan-card\nimport { PlansGrid, PlansGridSkeleton, type Plan } from \"./plan-card\"\n\r\nexport type PlansModalServerActions = {\r\n  createSubscriptionCheckoutSession: (args: {\r\n    planId: string\r\n    billingPeriod: \"monthly\" | \"yearly\"\r\n    locale?: \"en\" | \"bg\"\r\n  }) => Promise<{ url?: string; error?: string }>\r\n}\r\n\r\ninterface PlansModalProps {\r\n  /** Trigger element - if not provided, use open/onOpenChange for controlled mode */\r\n  trigger?: React.ReactNode\r\n  /** Controlled mode: whether the modal is open */\r\n  open?: boolean\r\n  /** Controlled mode: callback when open state changes */\r\n  onOpenChange?: (open: boolean) => void\r\n  /** Default account type tab to show */\r\n  defaultAccountType?: \"personal\" | \"business\"\r\n  /** Current user's tier (to show \"Current Plan\" badge) */\r\n  currentTier?: string\r\n  /** Title override */\r\n  title?: string\r\n  /** Description override */\r\n  description?: string\r\n  /** Source for analytics (where the modal was opened from) */\r\n  source?: \"header\" | \"account\" | \"sell\" | \"sidebar\" | \"other\"\r\n  actions: PlansModalServerActions\r\n}\r\n\r\n// =============================================================================\r\n// Translations\r\n// =============================================================================\r\n\r\nconst translations = {\n  en: {\r\n    title: \"Choose Your Plan\",\r\n    description: \"Upgrade for lower fees and more listings\",\r\n    personal: \"Personal\",\r\n    business: \"Business\",\r\n    monthly: \"Monthly\",\r\n    yearly: \"Yearly\",\r\n    save: \"Save 17%\",\r\n    viewFullComparison: \"View full comparison\",\r\n    noHiddenFees: \"No hidden fees ΓÇó No per-order charges\",\r\n    upgrade: \"Upgrade\",\r\n  },\r\n  bg: {\r\n    title: \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨┐╨╗╨░╨╜\",\r\n    description: \"╨¥╨░╨┤╨│╤Ç╨░╨┤╨╡╤é╨╡ ╨╖╨░ ╨┐╨╛-╨╜╨╕╤ü╨║╨╕ ╤é╨░╨║╤ü╨╕ ╨╕ ╨┐╨╛╨▓╨╡╤ç╨╡ ╨╛╨▒╤Å╨▓╨╕\",\r\n    personal: \"╨¢╨╕╤ç╨╡╨╜\",\r\n    business: \"╨æ╨╕╨╖╨╜╨╡╤ü\",\r\n    monthly: \"╨£╨╡╤ü╨╡╤ç╨╜╨╛\",\r\n    yearly: \"╨ô╨╛╨┤╨╕╤ê╨╜╨╛\",\r\n    save: \"╨í╨┐╨╡╤ü╤é╨╕ 17%\",\r\n    viewFullComparison: \"╨Æ╨╕╨╢ ╨┐╤è╨╗╨╜╨╛ ╤ü╤Ç╨░╨▓╨╜╨╡╨╜╨╕╨╡\",\r\n    noHiddenFees: \"╨æ╨╡╨╖ ╤ü╨║╤Ç╨╕╤é╨╕ ╤é╨░╨║╤ü╨╕ ΓÇó ╨æ╨╡╨╖ ╤é╨░╨║╤ü╨╕ ╨╜╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨░\",\r\n    upgrade: \"╨¥╨░╨┤╨│╤Ç╨░╨┤╨╕\",\r\n  },\n}\n\nfunction isPlanRecord(value: unknown): value is Plan {\n  if (!value || typeof value !== \"object\") return false\n  const candidate = value as Record<string, unknown>\n  return (\n    typeof candidate.id === \"string\" &&\n    typeof candidate.name === \"string\" &&\n    typeof candidate.tier === \"string\" &&\n    (candidate.account_type === \"personal\" || candidate.account_type === \"business\") &&\n    typeof candidate.price_monthly === \"number\" &&\n    typeof candidate.price_yearly === \"number\" &&\n    Array.isArray(candidate.features)\n  )\n}\n\r\n// =============================================================================\r\n// Main PlansModal Component\r\n// =============================================================================\r\n\r\nexport function PlansModal({\r\n  trigger,\r\n  open: controlledOpen,\r\n  onOpenChange: controlledOnOpenChange,\r\n  defaultAccountType = \"personal\",\r\n  currentTier,\r\n  title,\r\n  description,\r\n  source: _source,\r\n  actions,\n}: PlansModalProps) {\n  const router = useRouter()\n  const locale = useLocale()\n  const localeKey = locale === \"bg\" ? \"bg\" : \"en\"\n  const t = translations[localeKey]\n\r\n  // Internal open state for uncontrolled mode\r\n  const [internalOpen, setInternalOpen] = useState(false)\r\n  const isControlled = controlledOpen !== undefined\r\n  const isOpen = isControlled ? controlledOpen : internalOpen\r\n  const setIsOpen = useMemo(\r\n    () => isControlled ? (controlledOnOpenChange ?? (() => {})) : setInternalOpen,\r\n    [isControlled, controlledOnOpenChange]\r\n  )\r\n\r\n  const [accountType, setAccountType] = useState<\"personal\" | \"business\">(defaultAccountType)\r\n  const [billingPeriod, setBillingPeriod] = useState<\"monthly\" | \"yearly\">(\"monthly\")\r\n  const [plans, setPlans] = useState<Plan[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n  const [subscribingPlan, setSubscribingPlan] = useState<string | null>(null)\r\n\r\n  // Fetch plans when modal opens\r\n  useEffect(() => {\r\n    if (!isOpen) return\r\n\r\n    async function fetchPlans() {\n      setLoading(true)\n      try {\n        const res = await fetch(\"/api/plans\")\n        if (res.ok) {\n          const payload: unknown = await res.json()\n          if (Array.isArray(payload)) {\n            setPlans(payload.filter(isPlanRecord))\n          } else {\n            setPlans([])\n          }\n        }\n      } catch (error) {\n        console.error(\"Failed to fetch plans:\", error)\n      } finally {\n        setLoading(false)\r\n      }\r\n    }\r\n    fetchPlans()\r\n  }, [isOpen])\r\n\r\n  const filteredPlans = plans.filter(p => p.account_type === accountType)\r\n\r\n  const handleSelectPlan = useCallback(async (plan: Plan) => {\r\n    if (plan.tier === currentTier) return\r\n    \r\n    // For free plans, just close modal - they're already on free\r\n    if (plan.price_monthly === 0) {\r\n      setIsOpen(false)\r\n      return\r\n    }\r\n\r\n    setSubscribingPlan(plan.id)\r\n\r\n    try {\r\n      const { url, error } = await actions.createSubscriptionCheckoutSession({\r\n        planId: plan.id,\r\n        billingPeriod,\r\n        locale: locale === \"bg\" ? \"bg\" : \"en\",\r\n      })\r\n\r\n      if (error) {\r\n        throw new Error(error)\r\n      }\r\n\r\n      // Redirect to Stripe\r\n      if (url) {\r\n        window.location.href = url\r\n      } else {\r\n        // No URL returned but no error - unexpected state, redirect to full page\r\n        throw new Error(\"No checkout URL returned\")\r\n      }\r\n    } catch (error) {\r\n      console.error('Checkout error:', error)\r\n      // On error, redirect to full plans page where user can see clearer error\r\n      setIsOpen(false)\r\n      router.push(\"/plans\")\r\n    } finally {\r\n      setSubscribingPlan(null)\r\n    }\r\n  }, [actions, currentTier, billingPeriod, router, setIsOpen, locale])\n\r\n  return (\r\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\r\n      {trigger && <DialogTrigger asChild>{trigger}</DialogTrigger>}\r\n      \r\n      <DialogContent className=\"max-w-lg sm:max-w-2xl max-h-dialog overflow-visible p-0\">\r\n        <div className=\"px-4 pt-4 pb-3 sm:px-6 sm:pt-5\">\r\n          <DialogHeader className=\"text-center sm:text-center space-y-1\">\r\n            <div className=\"flex items-center justify-center\">\r\n              <Badge variant=\"secondary\" className=\"text-2xs px-2 py-0.5\">\r\n                <SealCheck weight=\"fill\" className=\"size-2.5 mr-1 text-primary\" />\r\n                {t.noHiddenFees}\r\n              </Badge>\r\n            </div>\r\n            <DialogTitle className=\"text-lg font-bold\">\r\n              {title || t.title}\r\n            </DialogTitle>\r\n            <DialogDescription className=\"text-xs\">\r\n              {description || t.description}\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n\r\n          {/* Compact Controls Row */}\r\n          <div className=\"flex items-center justify-center gap-2 mt-3\">\r\n            {/* Account Type Toggle */}\r\n            <div className=\"inline-flex p-0.5 rounded-md bg-surface-subtle border text-xs\">\r\n              <button\r\n                onClick={() => setAccountType(\"personal\")}\r\n                className={cn(\r\n                  \"flex items-center gap-1 px-2 py-1 rounded font-medium transition-all\",\r\n                  accountType === \"personal\"\r\n                    ? \"bg-background shadow-sm text-foreground\"\r\n                    : \"text-muted-foreground hover:text-foreground\"\r\n                )}\r\n              >\r\n                <User weight={accountType === \"personal\" ? \"fill\" : \"regular\"} className=\"size-3\" />\r\n                {t.personal}\r\n              </button>\r\n              <button\r\n                onClick={() => setAccountType(\"business\")}\r\n                className={cn(\r\n                  \"flex items-center gap-1 px-2 py-1 rounded font-medium transition-all\",\r\n                  accountType === \"business\"\r\n                    ? \"bg-background shadow-sm text-foreground\"\r\n                    : \"text-muted-foreground hover:text-foreground\"\r\n                )}\r\n              >\r\n                <Buildings weight={accountType === \"business\" ? \"fill\" : \"regular\"} className=\"size-3\" />\r\n                {t.business}\r\n              </button>\r\n            </div>\r\n\r\n            <div className=\"w-px h-5 bg-border\" />\r\n\r\n            {/* Billing Toggle */}\r\n            <div className=\"inline-flex p-0.5 rounded-md bg-surface-subtle border text-xs\">\r\n              <button\r\n                onClick={() => setBillingPeriod(\"monthly\")}\r\n                className={cn(\r\n                  \"px-2 py-1 rounded font-medium transition-all\",\r\n                  billingPeriod === \"monthly\"\r\n                    ? \"bg-background shadow-sm text-foreground\"\r\n                    : \"text-muted-foreground hover:text-foreground\"\r\n                )}\r\n              >\r\n                {t.monthly}\r\n              </button>\r\n              <button\r\n                onClick={() => setBillingPeriod(\"yearly\")}\r\n                className={cn(\r\n                  \"px-2 py-1 rounded font-medium transition-all flex items-center gap-1\",\r\n                  billingPeriod === \"yearly\"\r\n                    ? \"bg-background shadow-sm text-foreground\"\r\n                    : \"text-muted-foreground hover:text-foreground\"\r\n                )}\r\n              >\r\n                {t.yearly}\r\n                <Badge variant=\"secondary\" className=\"text-2xs bg-success/10 text-success border-success/20 px-1 py-0\">\r\n                  {t.save}\r\n                </Badge>\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Plans Grid - pt-3 for badge overflow space */}\r\n        <div className=\"px-4 pb-4 sm:px-6 sm:pb-5 pt-3 overflow-y-visible\">\r\n          {loading ? (\r\n            <PlansGridSkeleton count={filteredPlans.length || 2} variant=\"compact\" />\r\n          ) : (\r\n            <PlansGrid\r\n              plans={filteredPlans}\r\n              locale={locale}\r\n              billingPeriod={billingPeriod}\r\n              {...(currentTier ? { currentTier } : {})}\r\n              loadingPlanId={subscribingPlan}\r\n              onSelectPlan={handleSelectPlan}\r\n              variant=\"compact\"\r\n            />\r\n          )}\r\n\r\n          {/* Full Comparison Link */}\r\n          <div className=\"mt-4 text-center\">\r\n            <Link\r\n              href=\"/plans\"\r\n              onClick={() => setIsOpen(false)}\r\n              className=\"inline-flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground transition-colors group\"\r\n            >\r\n              {t.viewFullComparison}\r\n              <ArrowRight className=\"size-3 transition-transform group-hover:translate-x-0.5\" />\r\n            </Link>\r\n          </div>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n\r\n// =============================================================================\r\n// Convenience Export: Trigger Button\r\n// =============================================================================\r\n\r\nfunction PlansModalTrigger({\r\n  children,\r\n  className,\r\n  variant = \"default\",\r\n  size = \"default\",\r\n  ...props\r\n}: React.ComponentProps<typeof Button> & {\r\n  children?: React.ReactNode\r\n}) {\n  const locale = useLocale()\n  const localeKey = locale === \"bg\" ? \"bg\" : \"en\"\n  const t = translations[localeKey]\n\r\n  return (\r\n    <Button variant={variant} size={size} className={className} {...props}>\r\n      {children || (\r\n        <>\r\n          <Crown weight=\"fill\" className=\"size-4 mr-1.5\" />\r\n          {t.upgrade}\r\n        </>\r\n      )}\r\n    </Button>\r\n  )\r\n}\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\_components\\subscription-benefits-card.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'accountType' is defined but never used.","line":40,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":40,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isActive' is defined but never used.","line":50,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":50,"endColumn":11}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Crown, Lightning, Package, ChartLine, Headset, Medal, Info } from \"@phosphor-icons/react\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Progress } from \"@/components/ui/progress\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from \"@/components/ui/tooltip\"\r\n\r\ninterface SubscriptionBenefitsCardProps {\r\n  locale: string\r\n  tier: string\r\n  accountType: \"personal\" | \"business\"\r\n  // From subscription_plans\r\n  maxListings: number | null\r\n  boostsIncluded: number\r\n  prioritySupport: boolean\r\n  analyticsAccess: string\r\n  badgeType: string | null\r\n  // Current usage\r\n  activeListings: number\r\n  boostsRemaining: number\r\n  boostsResetAt: string | null\r\n  // Subscription status\r\n  expiresAt: string | null\r\n  isActive: boolean\r\n  isCancelled: boolean\r\n}\r\n\r\nexport function SubscriptionBenefitsCard({\r\n  locale,\r\n  tier,\r\n  accountType,\r\n  maxListings,\r\n  boostsIncluded,\r\n  prioritySupport,\r\n  analyticsAccess,\r\n  badgeType,\r\n  activeListings,\r\n  boostsRemaining,\r\n  boostsResetAt,\r\n  expiresAt,\r\n  isActive,\r\n  isCancelled,\r\n}: SubscriptionBenefitsCardProps) {\r\n  const t = {\r\n    planBenefits: locale === \"bg\" ? \"╨ƒ╨╛╨╗╨╖╨╕ ╨╛╤é ╨┐╨╗╨░╨╜╨░\" : \"Plan Benefits\",\r\n    currentPlan: locale === \"bg\" ? \"╨ó╨╡╨║╤â╤ë ╨┐╨╗╨░╨╜\" : \"Current plan\",\r\n    freePlan: locale === \"bg\" ? \"╨æ╨╡╨╖╨┐╨╗╨░╤é╨╡╨╜\" : \"Free\",\r\n    listings: locale === \"bg\" ? \"╨₧╨▒╤Å╨▓╨╕\" : \"Listings\",\r\n    boosts: locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨╝╨╛╤å╨╕╨╕\" : \"Boosts\",\r\n    boostsRemaining: locale === \"bg\" ? \"╨╛╤ü╤é╨░╨▓╨░╤ë╨╕\" : \"remaining\",\r\n    boostsReset: locale === \"bg\" ? \"╨¥╤â╨╗╨╕╤Ç╨░╤é ╤ü╨╡ ╨╜╨░\" : \"Resets on\",\r\n    unlimited: locale === \"bg\" ? \"╨¥╨╡╨╛╨│╤Ç╨░╨╜╨╕╤ç╨╡╨╜\" : \"Unlimited\",\r\n    prioritySupport: locale === \"bg\" ? \"╨ƒ╤Ç╨╕╨╛╤Ç╨╕╤é╨╡╤é╨╜╨░ ╨┐╨╛╨┤╨┤╤Ç╤è╨╢╨║╨░\" : \"Priority support\",\r\n    analytics: locale === \"bg\" ? \"╨É╨╜╨░╨╗╨╕╨╖╨╕\" : \"Analytics\",\r\n    sellerBadge: locale === \"bg\" ? \"╨æ╨░╨┤╨╢ ╨╜╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç\" : \"Seller badge\",\r\n    upgradePlan: locale === \"bg\" ? \"╨¥╨░╨┤╨│╤Ç╨░╨┤╨╡╤é╨╡ ╨┐╨╗╨░╨╜╨░\" : \"Upgrade Plan\",\r\n    managePlan: locale === \"bg\" ? \"╨ú╨┐╤Ç╨░╨▓╨╗╨╡╨╜╨╕╨╡ ╨╜╨░ ╨┐╨╗╨░╨╜╨░\" : \"Manage Plan\",\r\n    expiresOn: locale === \"bg\" ? \"╨ÿ╨╖╤é╨╕╤ç╨░ ╨╜╨░\" : \"Expires on\",\r\n    cancelling: locale === \"bg\" ? \"╨⌐╨╡ ╨▒╤è╨┤╨╡ ╨┐╤Ç╨╡╨║╤Ç╨░╤é╨╡╨╜\" : \"Cancelling\",\r\n  }\r\n\r\n  const isPaidPlan = tier !== \"free\"\r\n  const listingsUsed = maxListings ? Math.min(activeListings, maxListings) : activeListings\r\n  const listingsPercent = maxListings ? (listingsUsed / maxListings) * 100 : 0\r\n  const boostsPercent = boostsIncluded > 0 ? (boostsRemaining / boostsIncluded) * 100 : 0\r\n\r\n  const formatDate = (dateStr: string) => {\r\n    return new Date(dateStr).toLocaleDateString(locale === \"bg\" ? \"bg-BG\" : \"en-US\", {\r\n      month: \"short\",\r\n      day: \"numeric\",\r\n    })\r\n  }\r\n\r\n  const getTierDisplayName = (tier: string) => {\r\n    const names: Record<string, { en: string; bg: string }> = {\r\n      free: { en: \"Free\", bg: \"╨æ╨╡╨╖╨┐╨╗╨░╤é╨╡╨╜\" },\r\n      plus: { en: \"Plus\", bg: \"╨ƒ╨╗╤Ä╤ü\" },\r\n      pro: { en: \"Pro\", bg: \"╨ƒ╤Ç╨╛\" },\r\n      professional: { en: \"Business Pro\", bg: \"╨æ╨╕╨╖╨╜╨╡╤ü ╨ƒ╤Ç╨╛\" },\r\n      enterprise: { en: \"Enterprise\", bg: \"╨ò╨╜╤é╤è╤Ç╨┐╤Ç╨░╨╣╨╖\" },\r\n      business: { en: \"Business\", bg: \"╨æ╨╕╨╖╨╜╨╡╤ü\" },\r\n    }\r\n    return names[tier]?.[locale === \"bg\" ? \"bg\" : \"en\"] || tier\r\n  }\r\n\r\n  const getAnalyticsLabel = (access: string) => {\r\n    const labels: Record<string, { en: string; bg: string }> = {\r\n      none: { en: \"Not included\", bg: \"╨¥╨╡ ╨╡ ╨▓╨║╨╗╤Ä╤ç╨╡╨╜\" },\r\n      basic: { en: \"Basic\", bg: \"╨₧╤ü╨╜╨╛╨▓╨╡╨╜\" },\r\n      full: { en: \"Full\", bg: \"╨ƒ╤è╨╗╨╡╨╜\" },\r\n      export: { en: \"Full + Export\", bg: \"╨ƒ╤è╨╗╨╡╨╜ + ╨ò╨║╤ü╨┐╨╛╤Ç╤é\" },\r\n    }\r\n    return labels[access]?.[locale === \"bg\" ? \"bg\" : \"en\"] || access\r\n  }\r\n\r\n  const getBadgeLabel = (badge: string | null) => {\r\n    if (!badge) return null\r\n    const labels: Record<string, { en: string; bg: string }> = {\r\n      plus: { en: \"Plus Seller\", bg: \"╨ƒ╨╗╤Ä╤ü ╨ƒ╤Ç╨╛╨┤╨░╨▓╨░╤ç\" },\r\n      pro: { en: \"Pro Seller\", bg: \"╨ƒ╤Ç╨╛ ╨ƒ╤Ç╨╛╨┤╨░╨▓╨░╤ç\" },\r\n      business: { en: \"Business\", bg: \"╨æ╨╕╨╖╨╜╨╡╤ü\" },\r\n      business_pro: { en: \"Business Pro\", bg: \"╨æ╨╕╨╖╨╜╨╡╤ü ╨ƒ╤Ç╨╛\" },\r\n      enterprise: { en: \"Enterprise\", bg: \"╨ò╨╜╤é╤è╤Ç╨┐╤Ç╨░╨╣╨╖\" },\r\n    }\r\n    return labels[badge]?.[locale === \"bg\" ? \"bg\" : \"en\"] || badge\r\n  }\r\n\r\n  return (\r\n    <Card className=\"overflow-hidden\">\r\n      <CardContent className=\"p-0\">\r\n        {/* Header with plan name */}\r\n        <div className={cn(\r\n          \"px-4 py-3 flex items-center justify-between\",\r\n          isPaidPlan ? \"bg-selected\" : \"bg-surface-subtle\"\r\n        )}>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Crown \r\n              weight={isPaidPlan ? \"fill\" : \"regular\"} \r\n              className={cn(\"size-5\", isPaidPlan ? \"text-primary\" : \"text-muted-foreground\")} \r\n            />\r\n            <div>\r\n              <span className=\"text-sm text-muted-foreground\">{t.currentPlan}</span>\r\n              <h3 className=\"font-semibold leading-tight\">\r\n                {getTierDisplayName(tier)}\r\n              </h3>\r\n            </div>\r\n          </div>\r\n          {isCancelled && expiresAt && (\r\n            <Badge variant=\"outline\" className=\"text-warning border-warning/50\">\r\n              {t.cancelling}\r\n            </Badge>\r\n          )}\r\n        </div>\r\n\r\n        {/* Benefits grid */}\r\n        <div className=\"p-4 space-y-4\">\r\n          {/* Listings usage */}\r\n          <div className=\"space-y-2\">\r\n            <div className=\"flex items-center justify-between text-sm\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <Package className=\"size-4 text-muted-foreground\" />\r\n                <span>{t.listings}</span>\r\n              </div>\r\n              <span className=\"font-medium\">\r\n                {activeListings} / {maxListings ?? \"Γê₧\"}\r\n              </span>\r\n            </div>\r\n            {maxListings && (\r\n              <Progress \r\n                value={listingsPercent} \r\n                className={cn(\"h-2\", listingsPercent > 90 && \"[&>div]:bg-warning\")}\r\n              />\r\n            )}\r\n          </div>\r\n\r\n          {/* Boosts */}\r\n          {boostsIncluded > 0 && (\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex items-center justify-between text-sm\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Lightning weight=\"fill\" className=\"size-4 text-primary\" />\r\n                  <span>{t.boosts}</span>\r\n                  {boostsResetAt && (\r\n                    <TooltipProvider delayDuration={200}>\r\n                      <Tooltip>\r\n                        <TooltipTrigger asChild>\r\n                          <Info className=\"size-3.5 text-muted-foreground cursor-help\" />\r\n                        </TooltipTrigger>\r\n                        <TooltipContent>\r\n                          <p>{t.boostsReset}: {formatDate(boostsResetAt)}</p>\r\n                        </TooltipContent>\r\n                      </Tooltip>\r\n                    </TooltipProvider>\r\n                  )}\r\n                </div>\r\n                <span className=\"font-medium\">\r\n                  {boostsRemaining} {t.boostsRemaining}\r\n                </span>\r\n              </div>\r\n              <Progress \r\n                value={boostsPercent} \r\n                className=\"h-2 [&>div]:bg-primary\"\r\n              />\r\n            </div>\r\n          )}\r\n\r\n          {/* Other benefits - compact list */}\r\n          <div className=\"pt-2 border-t space-y-2\">\r\n            {/* Priority Support */}\r\n            {prioritySupport && (\r\n              <div className=\"flex items-center gap-2 text-sm\">\r\n                <Headset weight=\"duotone\" className=\"size-4 text-success\" />\r\n                <span>{t.prioritySupport}</span>\r\n                <Badge variant=\"secondary\" className=\"ml-auto text-2xs\">Γ£ô</Badge>\r\n              </div>\r\n            )}\r\n\r\n            {/* Analytics */}\r\n            {analyticsAccess && analyticsAccess !== \"none\" && (\r\n              <div className=\"flex items-center gap-2 text-sm\">\r\n                <ChartLine weight=\"duotone\" className=\"size-4 text-info\" />\r\n                <span>{t.analytics}</span>\r\n                <Badge variant=\"secondary\" className=\"ml-auto text-2xs\">\r\n                  {getAnalyticsLabel(analyticsAccess)}\r\n                </Badge>\r\n              </div>\r\n            )}\r\n\r\n            {/* Seller Badge */}\r\n            {badgeType && (\r\n              <div className=\"flex items-center gap-2 text-sm\">\r\n                <Medal weight=\"duotone\" className=\"size-4 text-verified\" />\r\n                <span>{t.sellerBadge}</span>\r\n                <Badge variant=\"secondary\" className=\"ml-auto text-2xs\">\r\n                  {getBadgeLabel(badgeType)}\r\n                </Badge>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Action button */}\r\n          <div className=\"pt-2\">\r\n            <Button asChild variant={isPaidPlan ? \"outline\" : \"default\"} className=\"w-full\" size=\"sm\">\r\n              <Link href=\"/account/plans\">\r\n                {isPaidPlan ? t.managePlan : t.upgradePlan}\r\n              </Link>\r\n            </Button>\r\n          </div>\r\n\r\n          {/* Expiry notice */}\r\n          {expiresAt && isCancelled && (\r\n            <p className=\"text-xs text-muted-foreground text-center\">\r\n              {t.expiresOn}: {formatDate(expiresAt)}\r\n            </p>\r\n          )}\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\addresses\\_lib\\selects.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\addresses\\addresses-content.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 32 to the 25 allowed.","line":99,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":99,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useMemo, type ChangeEvent } from \"react\"\nimport { useRouter } from \"@/i18n/routing\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogFooter,\r\n    DialogHeader,\r\n    DialogTitle,\r\n} from \"@/components/ui/dialog\"\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport {\r\n    AlertDialog,\r\n    AlertDialogAction,\r\n    AlertDialogCancel,\r\n    AlertDialogContent,\r\n    AlertDialogDescription,\r\n    AlertDialogFooter,\r\n    AlertDialogHeader,\r\n    AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\"\r\nimport { \r\n    Plus, \r\n    SpinnerGap,\r\n    House,\r\n    Briefcase,\r\n    Buildings\r\n} from \"@phosphor-icons/react\"\r\nimport { toast } from \"sonner\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport { AccountAddressesStats } from \"../_components/account-addresses-stats\"\nimport { AccountAddressesGrid } from \"../_components/account-addresses-grid\"\nimport { USER_ADDRESSES_SELECT } from \"./_lib/selects\"\nimport { AddressFormFields } from \"../../../_components/address-form\"\n\r\ninterface Address {\r\n    id: string\r\n    label: string\r\n    full_name: string\r\n    phone: string | null\r\n    address_line1: string\r\n    address_line2: string | null\r\n    city: string\r\n    state: string | null\r\n    postal_code: string\r\n    country: string\r\n    is_default: boolean | null\r\n    created_at: string\r\n}\r\n\r\ninterface AddressFormData {\r\n    label: string\r\n    full_name: string\r\n    phone: string\r\n    address_line1: string\r\n    address_line2: string\r\n    city: string\r\n    state: string\r\n    postal_code: string\r\n    country: string\r\n    is_default: boolean\r\n}\r\n\r\nconst emptyFormData: AddressFormData = {\r\n    label: \"Home\",\r\n    full_name: \"\",\r\n    phone: \"\",\r\n    address_line1: \"\",\r\n    address_line2: \"\",\r\n    city: \"\",\r\n    state: \"\",\r\n    postal_code: \"\",\r\n    country: \"Bulgaria\",\r\n    is_default: false\r\n}\r\n\r\nconst addressLabels = [\r\n    { value: \"Home\", icon: House, label: \"Home\" },\r\n    { value: \"Work\", icon: Briefcase, label: \"Work\" },\r\n    { value: \"Other\", icon: Buildings, label: \"Other\" },\r\n]\r\n\r\ninterface AddressesContentProps {\r\n    locale: string\r\n    initialAddresses: Address[]\r\n}\r\n\r\nexport function AddressesContent({ locale, initialAddresses }: AddressesContentProps) {\r\n    const router = useRouter()\r\n    const [addresses, setAddresses] = useState<Address[]>(initialAddresses)\r\n    const [isDialogOpen, setIsDialogOpen] = useState(false)\r\n    const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false)\r\n    const [editingAddress, setEditingAddress] = useState<Address | null>(null)\r\n    const [deletingAddressId, setDeletingAddressId] = useState<string | null>(null)\r\n    const [isLoading, setIsLoading] = useState(false)\r\n    const [formData, setFormData] = useState<AddressFormData>(emptyFormData)\r\n\r\n    const supabase = createClient()\r\n\r\n    const handleInputChange = (field: keyof AddressFormData, value: string | boolean) => {\n        setFormData(prev => ({ ...prev, [field]: value }))\n    }\n\n    const handleTextChange = (field: keyof AddressFormData) => (event: ChangeEvent<HTMLInputElement>) => {\n        handleInputChange(field, event.target.value)\n    }\n\r\n    const openAddDialog = () => {\r\n        setEditingAddress(null)\r\n        setFormData({\r\n            ...emptyFormData,\r\n            is_default: addresses.length === 0 // First address is default\r\n        })\r\n        setIsDialogOpen(true)\r\n    }\r\n\r\n    const openEditDialog = (address: Address) => {\r\n        setEditingAddress(address)\r\n        setFormData({\r\n            label: address.label,\r\n            full_name: address.full_name,\r\n            phone: address.phone || \"\",\r\n            address_line1: address.address_line1,\r\n            address_line2: address.address_line2 || \"\",\r\n            city: address.city,\r\n            state: address.state || \"\",\r\n            postal_code: address.postal_code,\r\n            country: address.country,\r\n            is_default: address.is_default ?? false\r\n        })\r\n        setIsDialogOpen(true)\r\n    }\r\n\r\n    const handleSave = async () => {\r\n        // Validation\r\n        if (!formData.full_name.trim() || !formData.address_line1.trim() || \r\n            !formData.city.trim() || !formData.postal_code.trim()) {\r\n            toast.error(locale === 'bg' ? '╨£╨╛╨╗╤Å, ╨┐╨╛╨┐╤è╨╗╨╜╨╡╤é╨╡ ╨▓╤ü╨╕╤ç╨║╨╕ ╨╖╨░╨┤╤è╨╗╨╢╨╕╤é╨╡╨╗╨╜╨╕ ╨┐╨╛╨╗╨╡╤é╨░' : 'Please fill in all required fields')\r\n            return\r\n        }\r\n\r\n        setIsLoading(true)\r\n        try {\r\n            if (editingAddress) {\r\n                // Update existing\r\n                const { error } = await supabase\r\n                    .from('user_addresses')\r\n                    .update({\r\n                        label: formData.label,\r\n                        full_name: formData.full_name,\r\n                        phone: formData.phone || null,\r\n                        address_line1: formData.address_line1,\r\n                        address_line2: formData.address_line2 || null,\r\n                        city: formData.city,\r\n                        state: formData.state || null,\r\n                        postal_code: formData.postal_code,\r\n                        country: formData.country,\r\n                        is_default: formData.is_default\r\n                    })\r\n                    .eq('id', editingAddress.id)\r\n\r\n                if (error) throw error\r\n\r\n                toast.success(locale === 'bg' ? '╨É╨┤╤Ç╨╡╤ü╤è╤é ╨╡ ╨╛╨▒╨╜╨╛╨▓╨╡╨╜' : 'Address updated')\r\n            } else {\r\n                // Create new\r\n                const { data: { user } } = await supabase.auth.getUser()\r\n                if (!user) throw new Error('Not authenticated')\r\n\r\n                const { error } = await supabase\r\n                    .from('user_addresses')\r\n                    .insert({\r\n                        user_id: user.id,\r\n                        label: formData.label,\r\n                        full_name: formData.full_name,\r\n                        phone: formData.phone || null,\r\n                        address_line1: formData.address_line1,\r\n                        address_line2: formData.address_line2 || null,\r\n                        city: formData.city,\r\n                        state: formData.state || null,\r\n                        postal_code: formData.postal_code,\r\n                        country: formData.country,\r\n                        is_default: formData.is_default\r\n                    })\r\n\r\n                if (error) throw error\r\n\r\n                toast.success(locale === 'bg' ? '╨É╨┤╤Ç╨╡╤ü╤è╤é ╨╡ ╨┤╨╛╨▒╨░╨▓╨╡╨╜' : 'Address added')\r\n            }\r\n\r\n            setIsDialogOpen(false)\r\n            router.refresh()\r\n            \r\n            // Refetch addresses\r\n            const { data } = await supabase\r\n                .from('user_addresses')\r\n                .select(USER_ADDRESSES_SELECT)\r\n                .order('is_default', { ascending: false })\r\n                .order('created_at', { ascending: false })\r\n            \r\n            if (data) setAddresses(data)\r\n        } catch (error) {\r\n            console.error('Error saving address:', error)\r\n            toast.error(locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨╖╨░╨┐╨░╨╖╨▓╨░╨╜╨╡' : 'Error saving address')\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleDelete = async () => {\r\n        if (!deletingAddressId) return\r\n\r\n        setIsLoading(true)\r\n        try {\r\n            const { error } = await supabase\r\n                .from('user_addresses')\r\n                .delete()\r\n                .eq('id', deletingAddressId)\r\n\r\n            if (error) throw error\r\n\r\n            toast.success(locale === 'bg' ? '╨É╨┤╤Ç╨╡╤ü╤è╤é ╨╡ ╨╕╨╖╤é╤Ç╨╕╤é' : 'Address deleted')\r\n            setIsDeleteDialogOpen(false)\r\n            setDeletingAddressId(null)\r\n            router.refresh()\r\n            \r\n            // Refetch addresses\r\n            const { data } = await supabase\r\n                .from('user_addresses')\r\n                .select(USER_ADDRESSES_SELECT)\r\n                .order('is_default', { ascending: false })\r\n                .order('created_at', { ascending: false })\r\n            \r\n            if (data) setAddresses(data)\r\n        } catch (error) {\r\n            console.error('Error deleting address:', error)\r\n            toast.error(locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨╕╨╖╤é╤Ç╨╕╨▓╨░╨╜╨╡' : 'Error deleting address')\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleSetDefault = async (addressId: string) => {\r\n        setIsLoading(true)\r\n        try {\r\n            const { error } = await supabase\r\n                .from('user_addresses')\r\n                .update({ is_default: true })\r\n                .eq('id', addressId)\r\n\r\n            if (error) throw error\r\n\r\n            toast.success(locale === 'bg' ? '╨É╨┤╤Ç╨╡╤ü╤è╤é ╨┐╨╛ ╨┐╨╛╨┤╤Ç╨░╨╖╨▒╨╕╤Ç╨░╨╜╨╡ ╨╡ ╨┐╤Ç╨╛╨╝╨╡╨╜╨╡╨╜' : 'Default address updated')\r\n            router.refresh()\r\n            \r\n            // Refetch addresses\r\n            const { data } = await supabase\r\n                .from('user_addresses')\r\n                .select(USER_ADDRESSES_SELECT)\r\n                .order('is_default', { ascending: false })\r\n                .order('created_at', { ascending: false })\r\n            \r\n            if (data) setAddresses(data)\r\n        } catch (error) {\r\n            console.error('Error setting default:', error)\r\n            toast.error(locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨┐╤Ç╨╛╨╝╤Å╨╜╨░' : 'Error updating')\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    // Compute stats\r\n    const stats = useMemo(() => {\r\n        const total = addresses.length\r\n        const defaultCount = addresses.filter(a => a.is_default).length\r\n        const homeCount = addresses.filter(a => a.label.toLowerCase() === 'home' || a.label.toLowerCase() === '╨┤╨╛╨╝').length\r\n        const workCount = addresses.filter(a => a.label.toLowerCase() === 'work' || a.label.toLowerCase() === '╤Ç╨░╨▒╨╛╤é╨░').length\r\n        return { total, defaultCount, homeCount, workCount }\r\n    }, [addresses])\r\n\r\n    const handleEdit = (address: Address) => {\r\n        openEditDialog(address)\r\n    }\r\n\r\n    const handleDeleteClick = (addressId: string) => {\r\n        setDeletingAddressId(addressId)\r\n        setIsDeleteDialogOpen(true)\r\n    }\r\n\r\n    const t = {\r\n        addAddress: locale === 'bg' ? '╨ö╨╛╨▒╨░╨▓╨╕' : 'Add',\r\n    }\r\n\r\n    return (\r\n        <div className=\"flex flex-col gap-4\">\r\n            {/* Mobile header with add button */}\r\n            <div className=\"flex items-center justify-between sm:hidden\">\r\n                <AccountAddressesStats stats={stats} locale={locale} />\r\n                <Button onClick={openAddDialog} size=\"sm\" className=\"h-8 gap-1.5\">\r\n                    <Plus className=\"size-4\" weight=\"bold\" />\r\n                    {t.addAddress}\r\n                </Button>\r\n            </div>\r\n\r\n            {/* Desktop stats */}\r\n            <div className=\"hidden sm:block\">\r\n                <AccountAddressesStats stats={stats} locale={locale} />\r\n            </div>\r\n\r\n            {/* Grid */}\r\n            <AccountAddressesGrid\r\n                addresses={addresses.map(addr => ({ ...addr, is_default: addr.is_default ?? false }))}\r\n                locale={locale}\r\n                onEdit={handleEdit}\r\n                onDelete={handleDeleteClick}\r\n                onAdd={openAddDialog}\r\n                onSetDefault={handleSetDefault}\r\n                isLoading={isLoading}\r\n            />\r\n\r\n            {/* Add/Edit Dialog */}\r\n            <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\r\n                <DialogContent className=\"max-w-lg max-h-dialog overflow-y-auto\">\r\n                    <DialogHeader>\r\n                        <DialogTitle>\r\n                            {editingAddress \r\n                                ? (locale === 'bg' ? '╨á╨╡╨┤╨░╨║╤é╨╕╤Ç╨░╨╣ ╨░╨┤╤Ç╨╡╤ü' : 'Edit Address')\r\n                                : (locale === 'bg' ? '╨ö╨╛╨▒╨░╨▓╨╕ ╨╜╨╛╨▓ ╨░╨┤╤Ç╨╡╤ü' : 'Add New Address')}\r\n                        </DialogTitle>\r\n                        <DialogDescription>\r\n                            {locale === 'bg' \r\n                                ? '╨Æ╤è╨▓╨╡╨┤╨╡╤é╨╡ ╨┤╨╡╤é╨░╨╣╨╗╨╕╤é╨╡ ╨╜╨░ ╨░╨┤╤Ç╨╡╤ü╨░ ╨╖╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░'\r\n                                : 'Enter the details for your delivery address'}\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n\r\n                    <div className=\"space-y-4 py-4\">\r\n                        <div className=\"grid grid-cols-2 gap-4\">\r\n                            <div className=\"space-y-2\">\r\n                                <Label>{locale === 'bg' ? '╨ò╤é╨╕╨║╨╡╤é' : 'Label'}</Label>\r\n                                <Select \r\n                                    value={formData.label} \r\n                                    onValueChange={(v) => handleInputChange('label', v)}\r\n                                >\r\n                                    <SelectTrigger>\r\n                                        <SelectValue />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                        {addressLabels.map((label) => (\r\n                                            <SelectItem key={label.value} value={label.value}>\r\n                                                <div className=\"flex items-center gap-2\">\r\n                                                    <label.icon className=\"size-4\" />\r\n                                                    {label.label}\r\n                                                </div>\r\n                                            </SelectItem>\r\n                                        ))}\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <Label>{locale === 'bg' ? '╨ö╤è╤Ç╨╢╨░╨▓╨░' : 'Country'}</Label>\r\n                                <Select \r\n                                    value={formData.country} \r\n                                    onValueChange={(v) => handleInputChange('country', v)}\r\n                                >\r\n                                    <SelectTrigger>\r\n                                        <SelectValue />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                        <SelectItem value=\"Bulgaria\">Bulgaria</SelectItem>\r\n                                        <SelectItem value=\"Romania\">Romania</SelectItem>\r\n                                        <SelectItem value=\"Greece\">Greece</SelectItem>\r\n                                        <SelectItem value=\"Serbia\">Serbia</SelectItem>\r\n                                        <SelectItem value=\"North Macedonia\">North Macedonia</SelectItem>\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\n                            <Label>{locale === 'bg' ? '╨ó╨╡╨╗╨╡╤ä╨╛╨╜' : 'Phone'}</Label>\n                            <Input \n                                value={formData.phone}\n                                onChange={(e) => handleInputChange('phone', e.target.value)}\n                                placeholder=\"+359 88 888 8888\"\n                            />\n                        </div>\n\n                        <AddressFormFields\n                            nameFields={[\n                                {\n                                    id: \"full_name\",\n                                    label: (\n                                        <>\n                                            {locale === 'bg' ? '╨ƒ╤è╨╗╨╜╨╛ ╨╕╨╝╨╡' : 'Full Name'}{\" \"}\n                                            <span className=\"text-destructive\">*</span>\n                                        </>\n                                    ),\n                                    placeholder: locale === 'bg' ? '╨ÿ╨▓╨░╨╜ ╨ÿ╨▓╨░╨╜╨╛╨▓' : 'John Doe',\n                                    value: formData.full_name,\n                                    onChange: handleTextChange('full_name'),\n                                    required: true,\n                                },\n                            ]}\n                            addressLine1={{\n                                id: \"address_line1\",\n                                label: (\n                                    <>\n                                        {locale === 'bg' ? '╨É╨┤╤Ç╨╡╤ü' : 'Address Line 1'}{\" \"}\n                                        <span className=\"text-destructive\">*</span>\n                                    </>\n                                ),\n                                placeholder: locale === 'bg' ? '╤â╨╗. ╨Æ╨╕╤é╨╛╤ê╨░ 1' : 'Street address',\n                                value: formData.address_line1,\n                                onChange: handleTextChange('address_line1'),\n                                required: true,\n                            }}\n                            addressLine2={{\n                                id: \"address_line2\",\n                                label: locale === 'bg' ? '╨É╨┤╤Ç╨╡╤ü 2' : 'Address Line 2',\n                                placeholder: locale === 'bg' ? '╨É╨┐╨░╤Ç╤é╨░╨╝╨╡╨╜╤é, ╨╡╤é╨░╨╢ ╨╕ ╨┤╤Ç.' : 'Apartment, floor, etc.',\n                                value: formData.address_line2,\n                                onChange: handleTextChange('address_line2'),\n                            }}\n                            city={{\n                                id: \"city\",\n                                label: (\n                                    <>\n                                        {locale === 'bg' ? '╨ô╤Ç╨░╨┤' : 'City'}{\" \"}\n                                        <span className=\"text-destructive\">*</span>\n                                    </>\n                                ),\n                                placeholder: locale === 'bg' ? '╨í╨╛╤ä╨╕╤Å' : 'City',\n                                value: formData.city,\n                                onChange: handleTextChange('city'),\n                                required: true,\n                            }}\n                            state={{\n                                id: \"state\",\n                                label: locale === 'bg' ? '╨₧╨▒╨╗╨░╤ü╤é' : 'State',\n                                placeholder: locale === 'bg' ? '╨í╨╛╤ä╨╕╤Å-╨│╤Ç╨░╨┤' : 'State',\n                                value: formData.state,\n                                onChange: handleTextChange('state'),\n                            }}\n                            postalCode={{\n                                id: \"postal_code\",\n                                label: (\n                                    <>\n                                        {locale === 'bg' ? '╨ƒ╨╛╤ë. ╨║╨╛╨┤' : 'Postal Code'}{\" \"}\n                                        <span className=\"text-destructive\">*</span>\n                                    </>\n                                ),\n                                placeholder: \"1000\",\n                                value: formData.postal_code,\n                                onChange: handleTextChange('postal_code'),\n                                required: true,\n                            }}\n                        />\n\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <input\r\n                                type=\"checkbox\"\r\n                                id=\"is_default\"\r\n                                checked={formData.is_default}\r\n                                onChange={(e) => handleInputChange('is_default', e.target.checked)}\r\n                                className=\"rounded border-border\"\r\n                            />\r\n                            <Label htmlFor=\"is_default\" className=\"font-normal cursor-pointer\">\r\n                                {locale === 'bg' ? '╨¥╨░╨┐╤Ç╨░╨▓╨╕ ╨░╨┤╤Ç╨╡╤ü ╨┐╨╛ ╨┐╨╛╨┤╤Ç╨░╨╖╨▒╨╕╤Ç╨░╨╜╨╡' : 'Set as default address'}\r\n                            </Label>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <DialogFooter>\r\n                        <Button variant=\"outline\" onClick={() => setIsDialogOpen(false)}>\r\n                            {locale === 'bg' ? '╨₧╤é╨║╨░╨╖' : 'Cancel'}\r\n                        </Button>\r\n                        <Button onClick={handleSave} disabled={isLoading}>\r\n                            {isLoading && <SpinnerGap className=\"size-4 mr-2 animate-spin\" />}\r\n                            {editingAddress \r\n                                ? (locale === 'bg' ? '╨ù╨░╨┐╨░╨╖╨╕' : 'Save')\r\n                                : (locale === 'bg' ? '╨ö╨╛╨▒╨░╨▓╨╕' : 'Add')}\r\n                        </Button>\r\n                    </DialogFooter>\r\n                </DialogContent>\r\n            </Dialog>\r\n\r\n            {/* Delete Confirmation Dialog */}\r\n            <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\r\n                <AlertDialogContent>\r\n                    <AlertDialogHeader>\r\n                        <AlertDialogTitle>\r\n                            {locale === 'bg' ? '╨ÿ╨╖╤é╤Ç╨╕╨▓╨░╨╜╨╡ ╨╜╨░ ╨░╨┤╤Ç╨╡╤ü' : 'Delete Address'}\r\n                        </AlertDialogTitle>\r\n                        <AlertDialogDescription>\r\n                            {locale === 'bg' \r\n                                ? '╨í╨╕╨│╤â╤Ç╨╜╨╕ ╨╗╨╕ ╤ü╤é╨╡, ╤ç╨╡ ╨╕╤ü╨║╨░╤é╨╡ ╨┤╨░ ╨╕╨╖╤é╤Ç╨╕╨╡╤é╨╡ ╤é╨╛╨╖╨╕ ╨░╨┤╤Ç╨╡╤ü? ╨ó╨╛╨▓╨░ ╨┤╨╡╨╣╤ü╤é╨▓╨╕╨╡ ╨╜╨╡ ╨╝╨╛╨╢╨╡ ╨┤╨░ ╨▒╤è╨┤╨╡ ╨╛╤é╨╝╨╡╨╜╨╡╨╜╨╛.'\r\n                                : 'Are you sure you want to delete this address? This action cannot be undone.'}\r\n                        </AlertDialogDescription>\r\n                    </AlertDialogHeader>\r\n                    <AlertDialogFooter>\r\n                        <AlertDialogCancel>\r\n                            {locale === 'bg' ? '╨₧╤é╨║╨░╨╖' : 'Cancel'}\r\n                        </AlertDialogCancel>\r\n                        <AlertDialogAction \r\n                            onClick={handleDelete}\r\n                            className=\"bg-destructive text-destructive-foreground hover:bg-destructive\"\n                        >\r\n                            {isLoading && <SpinnerGap className=\"size-4 mr-2 animate-spin\" />}\r\n                            {locale === 'bg' ? '╨ÿ╨╖╤é╤Ç╨╕╨╣' : 'Delete'}\r\n                        </AlertDialogAction>\r\n                    </AlertDialogFooter>\r\n                </AlertDialogContent>\r\n            </AlertDialog>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\addresses\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\addresses\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\billing\\billing-content.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 78 to the 25 allowed.","line":133,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":133,"endColumn":31},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `SetStateAction<Invoice[]>`.","line":221,"column":21,"nodeType":"LogicalExpression","messageId":"unsafeArgument","endLine":221,"endColumn":40},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `SetStateAction<Charge[]>`.","line":222,"column":20,"nodeType":"LogicalExpression","messageId":"unsafeArgument","endLine":222,"endColumn":38},{"ruleId":"sonarjs/no-all-duplicated-branches","severity":1,"message":"This conditional operation returns the same value whether the condition is \"true\" or \"false\".","line":237,"column":19,"nodeType":"ConditionalExpression","messageId":"returnsTheSameValue","endLine":237,"endColumn":81}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport Image from \"next/image\"\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\nimport { Skeleton } from \"@/components/ui/skeleton\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport {\r\n  Receipt,\r\n  CreditCard,\r\n  Crown,\r\n  Lightning,\r\n  ArrowUpRight,\r\n  Download,\r\n  ArrowSquareOut,\r\n  CalendarBlank,\r\n  CurrencyCircleDollar,\r\n  CheckCircle,\r\n  Clock,\r\n  XCircle,\r\n  SpinnerGap,\r\n  Sparkle,\r\n  Package,\r\n  Info,\r\n  ArrowRight,\r\n} from \"@phosphor-icons/react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { toast } from \"sonner\"\r\nimport { format, formatDistanceToNow } from \"date-fns\"\r\nimport { bg, enUS } from \"date-fns/locale\"\r\n\r\nexport type BillingContentServerActions = {\r\n  createBillingPortalSession: (args?: {\r\n    locale?: \"en\" | \"bg\"\r\n  }) => Promise<{ url?: string; error?: string }>\r\n}\r\n\r\ninterface SubscriptionPlan {\r\n  id: string\r\n  name: string\r\n  tier: string\r\n  price_monthly: number\r\n  price_yearly: number\r\n  commission_rate: number\r\n  features: string[]\r\n}\r\n\r\ninterface Subscription {\r\n  id: string\r\n  seller_id: string\r\n  plan_type: string\r\n  status: string\r\n  price_paid: number\r\n  billing_period: string\r\n  starts_at: string\r\n  expires_at: string\r\n  stripe_subscription_id: string | null\r\n  subscription_plans?: SubscriptionPlan\r\n}\r\n\r\ninterface Seller {\r\n  id: string\r\n  tier: string\r\n  commission_rate: number\r\n  stripe_customer_id: string | null\r\n  store_name?: string\r\n}\r\n\r\ninterface Boost {\r\n  id: string\r\n  product_id: string\r\n  price_paid: number\r\n  duration_days: number\r\n  starts_at: string\r\n  expires_at: string\r\n  is_active: boolean\r\n  created_at: string\r\n  products?: {\r\n    id: string\r\n    title: string\r\n    images: string[]\r\n  }\r\n}\r\n\r\ninterface Invoice {\r\n  id: string\r\n  number: string | null\r\n  status: string | null\r\n  amount_paid: number\r\n  amount_due: number\r\n  currency: string\r\n  created: number\r\n  hosted_invoice_url: string | null\r\n  invoice_pdf: string | null\r\n  description: string | null\r\n  subscription: string | null\r\n  period_start: number | null\r\n  period_end: number | null\r\n}\r\n\r\ninterface Charge {\r\n  id: string\r\n  amount: number\r\n  currency: string\r\n  status: string\r\n  created: number\r\n  description: string | null\r\n  receipt_url: string | null\r\n  metadata: Record<string, string>\r\n}\r\n\r\ninterface BillingContentProps {\r\n  locale: string\r\n  seller: Seller | null\r\n  subscription: Subscription | null\r\n  boosts: Boost[]\r\n  hasStripeCustomer: boolean\r\n  userEmail: string\r\n  actions: BillingContentServerActions\r\n}\r\n\r\nexport function BillingContent({\r\n  locale,\r\n  seller,\r\n  subscription,\r\n  boosts,\r\n  hasStripeCustomer,\r\n  userEmail,\r\n  actions,\r\n}: BillingContentProps) {\r\n  const [invoices, setInvoices] = useState<Invoice[]>([])\r\n  const [charges, setCharges] = useState<Charge[]>([])\r\n  const [isLoading, setIsLoading] = useState(true)\r\n  const [isPortalLoading, setIsPortalLoading] = useState(false)\r\n\r\n  const dateLocale = locale === 'bg' ? bg : enUS\r\n  const withLocale = (path: string) => `/${locale}${path}`\r\n\r\n  // Translations\r\n  const t = {\r\n    title: locale === 'bg' ? '╨ñ╨░╨║╤é╤â╤Ç╨╕╤Ç╨░╨╜╨╡' : 'Billing',\r\n    subtitle: locale === 'bg'\r\n      ? '╨ú╨┐╤Ç╨░╨▓╨╗╤Å╨▓╨░╨╣╤é╨╡ ╨░╨▒╨╛╨╜╨░╨╝╨╡╨╜╤é╨░ ╤ü╨╕ ╨╕ ╨┐╤Ç╨╡╨│╨╗╨╡╨╢╨┤╨░╨╣╤é╨╡ ╨╕╤ü╤é╨╛╤Ç╨╕╤Å╤é╨░ ╨╜╨░ ╨┐╨╗╨░╤ë╨░╨╜╨╕╤Å╤é╨░'\r\n      : 'Manage your subscription and view payment history',\r\n    currentPlan: locale === 'bg' ? '╨ó╨╡╨║╤â╤ë ╨┐╨╗╨░╨╜' : 'Current Plan',\r\n    freePlan: locale === 'bg' ? '╨æ╨╡╨╖╨┐╨╗╨░╤é╨╡╨╜ ╨┐╨╗╨░╨╜' : 'Free Plan',\r\n    basicPlan: locale === 'bg' ? '╨₧╤ü╨╜╨╛╨▓╨╡╨╜' : 'Basic',\r\n    premiumPlan: locale === 'bg' ? '╨ƒ╤Ç╨╡╨╝╨╕╤â╨╝' : 'Premium',\r\n    businessPlan: locale === 'bg' ? '╨æ╨╕╨╖╨╜╨╡╤ü' : 'Business',\r\n    active: locale === 'bg' ? '╨É╨║╤é╨╕╨▓╨╡╨╜' : 'Active',\r\n    cancelled: locale === 'bg' ? '╨₧╤é╨║╨░╨╖╨░╨╜' : 'Cancelled',\r\n    expired: locale === 'bg' ? '╨ÿ╨╖╤é╨╡╨║╤è╨╗' : 'Expired',\r\n    pending: locale === 'bg' ? '╨Æ ╨╕╨╖╤ç╨░╨║╨▓╨░╨╜╨╡' : 'Pending',\r\n    nextBilling: locale === 'bg' ? '╨í╨╗╨╡╨┤╨▓╨░╤ë╨╛ ╨┐╨╗╨░╤ë╨░╨╜╨╡' : 'Next billing',\r\n    billingPeriod: locale === 'bg' ? '╨ƒ╨╡╤Ç╨╕╨╛╨┤' : 'Period',\r\n    monthly: locale === 'bg' ? '╨£╨╡╤ü╨╡╤ç╨╜╨╛' : 'Monthly',\r\n    yearly: locale === 'bg' ? '╨ô╨╛╨┤╨╕╤ê╨╜╨╛' : 'Yearly',\r\n    commission: locale === 'bg' ? '╨Ü╨╛╨╝╨╕╤ü╨╕╨╛╨╜╨╜╨░' : 'Commission',\r\n    managePlan: locale === 'bg' ? '╨ú╨┐╤Ç╨░╨▓╨╗╨╡╨╜╨╕╨╡ ╨╜╨░ ╨┐╨╗╨░╨╜╨░' : 'Manage Plan',\r\n    upgradePlan: locale === 'bg' ? '╨¥╨░╨┤╨│╤Ç╨░╨┤╨╕ ╨┐╨╗╨░╨╜╨░' : 'Upgrade Plan',\r\n    viewPlans: locale === 'bg' ? '╨Æ╨╕╨╢ ╨┐╨╗╨░╨╜╨╛╨▓╨╡╤é╨╡' : 'View Plans',\r\n    paymentHistory: locale === 'bg' ? '╨ÿ╤ü╤é╨╛╤Ç╨╕╤Å ╨╜╨░ ╨┐╨╗╨░╤ë╨░╨╜╨╕╤Å╤é╨░' : 'Payment History',\r\n    invoices: locale === 'bg' ? '╨ñ╨░╨║╤é╤â╤Ç╨╕' : 'Invoices',\r\n    subscriptions: locale === 'bg' ? '╨É╨▒╨╛╨╜╨░╨╝╨╡╨╜╤é╨╕' : 'Subscriptions',\r\n    boostPurchases: locale === 'bg' ? '╨ƒ╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╜╨╕╤Å' : 'Boost Purchases',\r\n    date: locale === 'bg' ? '╨ö╨░╤é╨░' : 'Date',\r\n    description: locale === 'bg' ? '╨₧╨┐╨╕╤ü╨░╨╜╨╕╨╡' : 'Description',\r\n    amount: locale === 'bg' ? '╨í╤â╨╝╨░' : 'Amount',\r\n    status: locale === 'bg' ? '╨í╤é╨░╤é╤â╤ü' : 'Status',\r\n    actions: locale === 'bg' ? '╨ö╨╡╨╣╤ü╤é╨▓╨╕╤Å' : 'Actions',\r\n    download: locale === 'bg' ? '╨ÿ╨╖╤é╨╡╨│╨╗╨╕' : 'Download',\r\n    view: locale === 'bg' ? '╨ƒ╤Ç╨╡╨│╨╗╨╡╨┤' : 'View',\r\n    paid: locale === 'bg' ? '╨ƒ╨╗╨░╤é╨╡╨╜╨╛' : 'Paid',\r\n    open: locale === 'bg' ? '╨₧╤é╨▓╨╛╤Ç╨╡╨╜╨╛' : 'Open',\r\n    void: locale === 'bg' ? '╨É╨╜╤â╨╗╨╕╤Ç╨░╨╜╨╛' : 'Void',\r\n    draft: locale === 'bg' ? '╨º╨╡╤Ç╨╜╨╛╨▓╨░' : 'Draft',\r\n    noInvoices: locale === 'bg' ? '╨¥╤Å╨╝╨░ ╤ä╨░╨║╤é╤â╤Ç╨╕' : 'No invoices yet',\r\n    noBoosts: locale === 'bg' ? '╨¥╤Å╨╝╨░ ╨┐╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╜╨╕╤Å' : 'No boosts yet',\r\n    boostProduct: locale === 'bg' ? '╨ƒ╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╣ ╨┐╤Ç╨╛╨┤╤â╨║╤é' : 'Boost a Product',\r\n    loadingError: locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨╖╨░╤Ç╨╡╨╢╨┤╨░╨╜╨╡' : 'Error loading data',\r\n    product: locale === 'bg' ? '╨ƒ╤Ç╨╛╨┤╤â╨║╤é' : 'Product',\r\n    duration: locale === 'bg' ? '╨ƒ╤Ç╨╛╨┤╤è╨╗╨╢╨╕╤é╨╡╨╗╨╜╨╛╤ü╤é' : 'Duration',\r\n    days: locale === 'bg' ? '╨┤╨╜╨╕' : 'days',\r\n    expiresIn: locale === 'bg' ? '╨ÿ╨╖╤é╨╕╤ç╨░ ╤ü╨╗╨╡╨┤' : 'Expires in',\r\n    expired2: locale === 'bg' ? '╨ÿ╨╖╤é╨╡╨║╤è╨╗' : 'Expired',\r\n    sellerSubscription: locale === 'bg' ? '╨É╨▒╨╛╨╜╨░╨╝╨╡╨╜╤é ╨╖╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç' : 'Seller subscription',\r\n    listingBoost: locale === 'bg' ? '╨ƒ╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╜╨╡ ╨╜╨░ ╨╛╨▒╤Å╨▓╨░' : 'Listing boost',\r\n    noBillingYet: locale === 'bg'\r\n      ? '╨Æ╤ü╨╡ ╨╛╤ë╨╡ ╨╜╤Å╨╝╨░╤é╨╡ ╨┐╨╗╨░╤ë╨░╨╜╨╕╤Å. ╨Ü╨╛╨│╨░╤é╨╛ ╨╜╨░╨┐╤Ç╨░╨▓╨╕╤é╨╡ ╨┐╨╛╨║╤â╨┐╨║╨░ ╨╕╨╗╨╕ ╨░╨▒╨╛╨╜╨░╨╝╨╡╨╜╤é, ╤ë╨╡ ╨│╨╕ ╨▓╨╕╨┤╨╕╤é╨╡ ╤é╤â╨║.'\r\n      : 'No billing history yet. When you make a purchase or subscription, it will appear here.',\r\n    startSelling: locale === 'bg' ? '╨ù╨░╨┐╨╛╤ç╨╜╨╡╤é╨╡ ╨┤╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤é╨╡' : 'Start Selling',\r\n    becomeSeller: locale === 'bg'\r\n      ? '╨í╤é╨░╨╜╨╡╤é╨╡ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç, ╨╖╨░ ╨┤╨░ ╨┐╨╛╨╗╤â╤ç╨╕╤é╨╡ ╨┤╨╛╤ü╤é╤è╨┐ ╨┤╨╛ ╨┐╨╗╨░╨╜╨╛╨▓╨╡ ╨╕ ╨┐╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╜╨╡'\r\n      : 'Become a seller to access plans and boosts',\r\n  }\r\n\r\n  // Fetch invoices from API\r\n  useEffect(() => {\r\n    async function fetchBillingData() {\r\n      if (!hasStripeCustomer) {\r\n        setIsLoading(false)\r\n        return\r\n      }\r\n\r\n      try {\r\n        const response = await fetch('/api/billing/invoices')\r\n        if (!response.ok) throw new Error('Failed to fetch')\r\n\r\n        const data = await response.json()\r\n        setInvoices(data.invoices || [])\r\n        setCharges(data.charges || [])\r\n      } catch (error) {\r\n        console.error('Error fetching billing data:', error)\r\n        toast.error(t.loadingError)\r\n      } finally {\r\n        setIsLoading(false)\r\n      }\r\n    }\r\n\r\n    fetchBillingData()\r\n  }, [hasStripeCustomer, t.loadingError])\r\n\r\n  // Format currency\r\n  const formatCurrency = (amount: number, currency: string = 'bgn') => {\r\n    // Stripe amounts are in smallest currency unit (stotinki for BGN)\r\n    const value = currency.toLowerCase() === 'bgn' ? amount / 100 : amount / 100\r\n    return new Intl.NumberFormat(locale, {\r\n      style: 'currency',\r\n      currency: currency.toUpperCase(),\r\n    }).format(value)\r\n  }\r\n\r\n  // Format local price (already in major units)\r\n  const formatPrice = (price: number) => {\r\n    return new Intl.NumberFormat(locale, {\r\n      style: 'currency',\r\n      currency: 'BGN',\r\n    }).format(price)\r\n  }\r\n\r\n  // Get plan display name\r\n  const getPlanName = (tier: string) => {\r\n    switch (tier) {\r\n      case 'premium': return t.premiumPlan\r\n      case 'business': return t.businessPlan\r\n      default: return t.basicPlan\r\n    }\r\n  }\r\n\r\n  // Get status badge\r\n  const getStatusBadge = (status: string | null) => {\r\n    switch (status) {\r\n      case 'paid':\r\n      case 'succeeded':\r\n        return (\r\n          <Badge variant=\"secondary\" className=\"bg-success/10 text-success\">\r\n            <CheckCircle className=\"size-3 mr-1\" weight=\"fill\" />\r\n            {t.paid}\r\n          </Badge>\r\n        )\r\n      case 'open':\r\n      case 'pending':\r\n        return (\r\n          <Badge variant=\"secondary\" className=\"bg-warning/10 text-warning\">\r\n            <Clock className=\"size-3 mr-1\" weight=\"fill\" />\r\n            {t.open}\r\n          </Badge>\r\n        )\r\n      case 'void':\r\n      case 'failed':\r\n        return (\r\n          <Badge variant=\"secondary\" className=\"bg-destructive-subtle text-destructive\">\n            <XCircle className=\"size-3 mr-1\" weight=\"fill\" />\r\n            {t.void}\r\n          </Badge>\r\n        )\r\n      default:\r\n        return (\r\n          <Badge variant=\"secondary\">\r\n            {status || t.draft}\r\n          </Badge>\r\n        )\r\n    }\r\n  }\r\n\r\n  // Handle manage subscription portal\r\n  const handleManageSubscription = async () => {\r\n    setIsPortalLoading(true)\r\n    try {\r\n      const { url, error } = await actions.createBillingPortalSession({\r\n        locale: locale === 'bg' ? 'bg' : 'en',\r\n      })\r\n\r\n      if (error) {\r\n        throw new Error(error)\r\n      }\r\n\r\n      if (url) {\r\n        window.location.href = url\r\n      }\r\n    } catch (error) {\r\n      console.error('Portal error:', error)\r\n      toast.error(locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨╛╤é╨▓╨░╤Ç╤Å╨╜╨╡ ╨╜╨░ ╨┐╨╛╤Ç╤é╨░╨╗╨░' : 'Error opening portal')\r\n    } finally {\r\n      setIsPortalLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"grid gap-4\">\r\n      {/* Page Header */}\r\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-semibold tracking-tight\">{t.title}</h1>\r\n          <p className=\"text-muted-foreground text-sm mt-1\">{t.subtitle}</p>\r\n        </div>\r\n        {seller && (\r\n          <div className=\"flex items-center gap-2\">\r\n            <Link href={withLocale(\"/account/payments\")}>\r\n              <Button variant=\"outline\" size=\"sm\" className=\"gap-1.5\">\r\n                <CreditCard className=\"size-4\" />\r\n                {locale === 'bg' ? '╨ƒ╨╗╨░╤ë╨░╨╜╨╕╤Å' : 'Payment Methods'}\r\n              </Button>\r\n            </Link>\r\n            <Link href={withLocale(\"/account/plans\")}>\r\n              <Button size=\"sm\" className=\"gap-1.5\">\r\n                <Crown className=\"size-4\" weight=\"fill\" />\r\n                {t.viewPlans}\r\n              </Button>\r\n            </Link>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Not a Seller State */}\r\n      {!seller && (\r\n        <Card className=\"border-dashed\">\r\n          <CardContent className=\"flex flex-col items-center justify-center py-12 text-center\">\r\n            <div className=\"rounded-full bg-selected p-4 mb-4\">\r\n              <Crown className=\"size-8 text-primary\" weight=\"duotone\" />\r\n            </div>\r\n            <h2 className=\"text-lg font-semibold mb-2\">{t.startSelling}</h2>\r\n            <p className=\"text-muted-foreground text-sm max-w-md mb-4\">\r\n              {t.becomeSeller}\r\n            </p>\r\n            <Link href={withLocale(\"/sell\")}>\r\n              <Button className=\"gap-1.5\">\r\n                {t.startSelling}\r\n                <ArrowRight className=\"size-4\" />\r\n              </Button>\r\n            </Link>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Current Plan Card */}\r\n      {seller && (\r\n        <Card>\r\n          <CardHeader className=\"pb-3\">\r\n            <div className=\"flex items-center justify-between gap-4\">\r\n              <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                <Crown className=\"size-5 text-primary\" weight=\"fill\" />\r\n                {t.currentPlan}\r\n              </CardTitle>\r\n              {subscription && (\r\n                <Badge\r\n                  variant={subscription.status === 'active' ? 'default' : 'secondary'}\r\n                  className={cn(\r\n                    subscription.status === 'active' && 'bg-success'\r\n                  )}\r\n                >\r\n                  {subscription.status === 'active' ? t.active :\r\n                    subscription.status === 'cancelled' ? t.cancelled :\r\n                      subscription.status === 'expired' ? t.expired : t.pending}\r\n                </Badge>\r\n              )}\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-content-auto items-center gap-4\">\n              {/* Plan Info */}\r\n              <div className=\"grid gap-3\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className={cn(\r\n                    \"p-2.5 rounded-md\",\r\n                    seller.tier === 'business' ? \"bg-selected\" :\r\n                      seller.tier === 'premium' ? \"bg-warning/10\" :\r\n                        \"bg-muted\"\r\n                  )}>\r\n                    {seller.tier === 'business' ? (\r\n                      <Sparkle className=\"size-5 text-primary\" weight=\"fill\" />\r\n                    ) : seller.tier === 'premium' ? (\r\n                      <Crown className=\"size-5 text-warning\" weight=\"fill\" />\r\n                    ) : (\r\n                      <Package className=\"size-5 text-muted-foreground\" />\r\n                    )}\r\n                  </div>\r\n                  <div>\r\n                    <p className=\"font-semibold text-lg capitalize\">\r\n                      {getPlanName(seller.tier)}\r\n                    </p>\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      {t.commission}: {seller.commission_rate}%\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Subscription Details */}\r\n                {subscription && (\r\n                  <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 text-sm\">\r\n                    <div className=\"flex items-center gap-1.5 text-muted-foreground\">\r\n                      <CalendarBlank className=\"size-4\" />\r\n                      <span>{t.nextBilling}:</span>\r\n                      <span className=\"text-foreground font-medium\">\r\n                        {format(new Date(subscription.expires_at), 'PP', { locale: dateLocale })}\r\n                      </span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-1.5 text-muted-foreground\">\r\n                      <CurrencyCircleDollar className=\"size-4\" />\r\n                      <span>{t.billingPeriod}:</span>\r\n                      <span className=\"text-foreground font-medium\">\r\n                        {subscription.billing_period === 'yearly' ? t.yearly : t.monthly}\r\n                        {' ΓÇó '}\r\n                        {formatPrice(subscription.price_paid)}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {/* Free Plan Notice */}\r\n                {!subscription && seller.tier === 'basic' && (\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    {locale === 'bg'\r\n                      ? '╨¥╨░╨┤╨│╤Ç╨░╨┤╨╡╤é╨╡ ╨╖╨░ ╨┐╨╛-╨╜╨╕╤ü╨║╨╕ ╤é╨░╨║╤ü╨╕ ╨╕ ╨┐╨╛╨▓╨╡╤ç╨╡ ╤ä╤â╨╜╨║╤å╨╕╨╕'\r\n                      : 'Upgrade for lower fees and more features'}\r\n                  </p>\r\n                )}\r\n              </div>\r\n\r\n              {/* Actions */}\r\n              <div className=\"grid grid-cols-2 sm:flex sm:flex-row gap-2\">\r\n                {subscription?.stripe_subscription_id && (\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    onClick={handleManageSubscription}\r\n                    disabled={isPortalLoading}\r\n                    className=\"gap-1.5\"\r\n                  >\r\n                    {isPortalLoading ? (\r\n                      <SpinnerGap className=\"size-4 animate-spin\" />\r\n                    ) : (\r\n                      <ArrowSquareOut className=\"size-4\" />\r\n                    )}\r\n                    {t.managePlan}\r\n                  </Button>\r\n                )}\r\n                {seller.tier !== 'business' && (\r\n                  <Link href={withLocale(\"/account/plans\")}>\r\n                    <Button className=\"gap-1.5 w-full\">\r\n                      <ArrowUpRight className=\"size-4\" weight=\"bold\" />\r\n                      {t.upgradePlan}\r\n                    </Button>\r\n                  </Link>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Billing History Tabs */}\r\n      {seller && (\r\n        <Tabs defaultValue=\"invoices\" className=\"grid gap-4\">\r\n          <TabsList>\r\n            <TabsTrigger value=\"invoices\" className=\"gap-1.5\">\r\n              <Receipt className=\"size-4\" />\r\n              {t.invoices}\r\n            </TabsTrigger>\r\n            <TabsTrigger value=\"boosts\" className=\"gap-1.5\">\r\n              <Lightning className=\"size-4\" />\r\n              {t.boostPurchases}\r\n            </TabsTrigger>\r\n          </TabsList>\r\n\r\n          {/* Invoices Tab */}\r\n          <TabsContent value=\"invoices\">\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle className=\"text-base\">{t.paymentHistory}</CardTitle>\r\n                <CardDescription>\r\n                  {locale === 'bg'\r\n                    ? '╨Æ╤ü╨╕╤ç╨║╨╕ ╨┐╨╗╨░╤ë╨░╨╜╨╕╤Å ╨╖╨░ ╨░╨▒╨╛╨╜╨░╨╝╨╡╨╜╤é╨╕ ╨╕ ╤â╤ü╨╗╤â╨│╨╕'\r\n                    : 'All payments for subscriptions and services'}\r\n                </CardDescription>\r\n              </CardHeader>\r\n              <CardContent>\r\n                {isLoading ? (\r\n                  <div className=\"grid gap-3\">\r\n                    {[1, 2, 3].map((i) => (\r\n                      <div key={i} className=\"flex items-center gap-4\">\r\n                        <Skeleton className=\"h-10 w-10 rounded shrink-0\" />\r\n                        <div className=\"grid gap-2 flex-1\">\r\n                          <Skeleton className=\"h-4 w-48\" />\r\n                          <Skeleton className=\"h-3 w-32\" />\r\n                        </div>\r\n                        <Skeleton className=\"h-6 w-16 shrink-0\" />\r\n                      </div>\r\n                    ))}\r\n                  </div>\r\n                ) : invoices.length === 0 && charges.length === 0 ? (\r\n                  <div className=\"text-center py-8\">\r\n                    <Receipt className=\"size-12 text-muted-foreground mx-auto mb-3\" />\r\n                    <p className=\"text-muted-foreground\">{t.noInvoices}</p>\r\n                    <p className=\"text-sm text-muted-foreground mt-1\">\r\n                      {t.noBillingYet}\r\n                    </p>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"overflow-x-auto -mx-6 px-6\">\r\n                    <Table>\r\n                      <TableHeader>\r\n                        <TableRow>\r\n                          <TableHead>{t.date}</TableHead>\r\n                          <TableHead>{t.description}</TableHead>\r\n                          <TableHead>{t.amount}</TableHead>\r\n                          <TableHead>{t.status}</TableHead>\r\n                          <TableHead className=\"text-right\">{t.actions}</TableHead>\r\n                        </TableRow>\r\n                      </TableHeader>\r\n                      <TableBody>\r\n                        {invoices.map((invoice) => (\r\n                          <TableRow key={invoice.id}>\r\n                            <TableCell className=\"whitespace-nowrap\">\r\n                              {format(new Date(invoice.created * 1000), 'PP', { locale: dateLocale })}\r\n                            </TableCell>\r\n                            <TableCell>\r\n                              <div className=\"flex items-center gap-2\">\r\n                                <Crown className=\"size-4 text-warning shrink-0\" />\r\n                                <span className=\"truncate max-w-52\">\r\n                                  {invoice.description || t.sellerSubscription}\r\n                                  {invoice.number && (\r\n                                    <span className=\"text-muted-foreground ml-1\">\r\n                                      #{invoice.number}\r\n                                    </span>\r\n                                  )}\r\n                                </span>\r\n                              </div>\r\n                            </TableCell>\r\n                            <TableCell className=\"font-medium\">\r\n                              {formatCurrency(invoice.amount_paid, invoice.currency)}\r\n                            </TableCell>\r\n                            <TableCell>\r\n                              {getStatusBadge(invoice.status)}\r\n                            </TableCell>\r\n                            <TableCell className=\"text-right\">\r\n                              <div className=\"flex items-center justify-end gap-1\">\r\n                                {invoice.hosted_invoice_url && (\r\n                                  <Button\r\n                                    variant=\"ghost\"\r\n                                    size=\"sm\"\r\n                                    asChild\r\n                                  >\r\n                                    <a\r\n                                      href={invoice.hosted_invoice_url}\r\n                                      target=\"_blank\"\r\n                                      rel=\"noopener noreferrer\"\r\n                                    >\r\n                                      <ArrowSquareOut className=\"size-4\" />\r\n                                    </a>\r\n                                  </Button>\r\n                                )}\r\n                                {invoice.invoice_pdf && (\r\n                                  <Button\r\n                                    variant=\"ghost\"\r\n                                    size=\"sm\"\r\n                                    asChild\r\n                                  >\r\n                                    <a\r\n                                      href={invoice.invoice_pdf}\r\n                                      target=\"_blank\"\r\n                                      rel=\"noopener noreferrer\"\r\n                                    >\r\n                                      <Download className=\"size-4\" />\r\n                                    </a>\r\n                                  </Button>\r\n                                )}\r\n                              </div>\r\n                            </TableCell>\r\n                          </TableRow>\r\n                        ))}\r\n                        {/* One-time charges (boosts, etc.) */}\r\n                        {charges.map((charge) => (\r\n                          <TableRow key={charge.id}>\r\n                            <TableCell className=\"whitespace-nowrap\">\r\n                              {format(new Date(charge.created * 1000), 'PP', { locale: dateLocale })}\r\n                            </TableCell>\r\n                            <TableCell>\r\n                              <div className=\"flex items-center gap-2\">\r\n                                <Lightning className=\"size-4 text-primary shrink-0\" />\r\n                                <span className=\"truncate max-w-52\">\r\n                                  {charge.description ||\r\n                                    charge.metadata?.type === 'listing_boost'\r\n                                    ? t.listingBoost\r\n                                    : locale === 'bg' ? '╨ƒ╨╗╨░╤ë╨░╨╜╨╡' : 'Payment'}\r\n                                </span>\r\n                              </div>\r\n                            </TableCell>\r\n                            <TableCell className=\"font-medium\">\r\n                              {formatCurrency(charge.amount, charge.currency)}\r\n                            </TableCell>\r\n                            <TableCell>\r\n                              {getStatusBadge(charge.status)}\r\n                            </TableCell>\r\n                            <TableCell className=\"text-right\">\r\n                              {charge.receipt_url && (\r\n                                <Button\r\n                                  variant=\"ghost\"\r\n                                  size=\"sm\"\r\n                                  asChild\r\n                                >\r\n                                  <a\r\n                                    href={charge.receipt_url}\r\n                                    target=\"_blank\"\r\n                                    rel=\"noopener noreferrer\"\r\n                                  >\r\n                                    <ArrowSquareOut className=\"size-4\" />\r\n                                  </a>\r\n                                </Button>\r\n                              )}\r\n                            </TableCell>\r\n                          </TableRow>\r\n                        ))}\r\n                      </TableBody>\r\n                    </Table>\r\n                  </div>\r\n                )}\r\n              </CardContent>\r\n            </Card>\r\n          </TabsContent>\r\n\r\n          {/* Boosts Tab */}\r\n          <TabsContent value=\"boosts\">\r\n            <Card>\r\n              <CardHeader className=\"flex flex-row items-center justify-between gap-4\">\r\n                <div>\r\n                  <CardTitle className=\"text-base\">{t.boostPurchases}</CardTitle>\r\n                  <CardDescription>\r\n                    {locale === 'bg'\r\n                      ? '╨ÿ╤ü╤é╨╛╤Ç╨╕╤Å ╨╜╨░ ╨┐╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╜╨╕╤é╨╡ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨╕'\r\n                      : 'Boosted products history'}\r\n                  </CardDescription>\r\n                </div>\r\n                <Link href={withLocale(\"/account/selling\")}>\r\n                  <Button size=\"sm\" className=\"gap-1.5\">\r\n                    <Lightning className=\"size-4\" weight=\"fill\" />\r\n                    {t.boostProduct}\r\n                  </Button>\r\n                </Link>\r\n              </CardHeader>\r\n              <CardContent>\r\n                {boosts.length === 0 ? (\r\n                  <div className=\"text-center py-8\">\r\n                    <Lightning className=\"size-12 text-muted-foreground mx-auto mb-3\" />\r\n                    <p className=\"text-muted-foreground\">{t.noBoosts}</p>\r\n                    <p className=\"text-sm text-muted-foreground mt-1\">\r\n                      {locale === 'bg'\r\n                        ? '╨ƒ╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╣╤é╨╡ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨╕╤é╨╡ ╤ü╨╕ ╨╖╨░ ╨┐╨╛╨▓╨╡╤ç╨╡ ╨▓╨╕╨┤╨╕╨╝╨╛╤ü╤é'\r\n                        : 'Boost your products for more visibility'}\r\n                    </p>\r\n                    <Link href={withLocale(\"/account/selling\")} className=\"mt-4 inline-block\">\r\n                      <Button variant=\"outline\" size=\"sm\" className=\"gap-1.5\">\r\n                        <Lightning className=\"size-4\" />\r\n                        {t.boostProduct}\r\n                      </Button>\r\n                    </Link>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"overflow-x-auto -mx-6 px-6\">\r\n                    <Table>\r\n                      <TableHeader>\r\n                        <TableRow>\r\n                          <TableHead>{t.product}</TableHead>\r\n                          <TableHead>{t.duration}</TableHead>\r\n                          <TableHead>{t.amount}</TableHead>\r\n                          <TableHead>{t.status}</TableHead>\r\n                          <TableHead>{t.date}</TableHead>\r\n                        </TableRow>\r\n                      </TableHeader>\r\n                      <TableBody>\r\n                        {boosts.map((boost) => {\r\n                          const isExpired = new Date(boost.expires_at) < new Date()\r\n                          const expiresIn = formatDistanceToNow(new Date(boost.expires_at), {\r\n                            locale: dateLocale,\r\n                            addSuffix: true,\r\n                          })\r\n\r\n                          return (\r\n                            <TableRow key={boost.id}>\r\n                              <TableCell>\r\n                                <div className=\"flex items-center gap-3\">\r\n                                  {boost.products?.images?.[0] && (\r\n                                    <Image\r\n                                      src={boost.products.images[0]}\r\n                                      alt=\"\"\r\n                                      width={40}\r\n                                      height={40}\r\n                                      className=\"size-10 rounded object-cover\"\r\n                                    />\r\n                                  )}\r\n                                  <span className=\"truncate max-w-44 font-medium\">\r\n                                    {boost.products?.title || boost.product_id}\r\n                                  </span>\r\n                                </div>\r\n                              </TableCell>\r\n                              <TableCell>\r\n                                {boost.duration_days} {t.days}\r\n                              </TableCell>\r\n                              <TableCell className=\"font-medium\">\r\n                                {formatPrice(boost.price_paid)}\r\n                              </TableCell>\r\n                              <TableCell>\r\n                                {boost.is_active && !isExpired ? (\r\n                                  <Badge className=\"bg-selected text-primary\">\r\n                                    <Lightning className=\"size-3 mr-1\" weight=\"fill\" />\r\n                                    {locale === 'bg' ? '╨É╨║╤é╨╕╨▓╨╡╨╜' : 'Active'}\r\n                                  </Badge>\r\n                                ) : (\r\n                                  <Badge variant=\"secondary\">\r\n                                    {t.expired2}\r\n                                  </Badge>\r\n                                )}\r\n                              </TableCell>\r\n                              <TableCell className=\"text-muted-foreground\">\r\n                                {format(new Date(boost.created_at), 'PP', { locale: dateLocale })}\r\n                                {boost.is_active && !isExpired && (\r\n                                  <div className=\"text-xs text-primary mt-0.5\">\r\n                                    {t.expiresIn} {expiresIn}\r\n                                  </div>\r\n                                )}\r\n                              </TableCell>\r\n                            </TableRow>\r\n                          )\r\n                        })}\r\n                      </TableBody>\r\n                    </Table>\r\n                  </div>\r\n                )}\r\n              </CardContent>\r\n            </Card>\r\n          </TabsContent>\r\n        </Tabs>\r\n      )}\r\n\r\n      {/* Quick Info */}\r\n      {seller && hasStripeCustomer && (\r\n        <Card className=\"bg-surface-subtle border-dashed\">\r\n          <CardContent className=\"flex items-start gap-4 pt-4\">\r\n            <Info className=\"size-5 text-muted-foreground mt-0.5 shrink-0\" />\r\n            <div className=\"text-sm text-muted-foreground grid gap-1\">\r\n              <p>\r\n                {locale === 'bg'\r\n                  ? '╨ƒ╨╗╨░╤ë╨░╨╜╨╕╤Å╤é╨░ ╤ü╨╡ ╨╛╨▒╤Ç╨░╨▒╨╛╤é╨▓╨░╤é ╤ü╨╕╨│╤â╤Ç╨╜╨╛ ╤ç╤Ç╨╡╨╖ Stripe. ╨ñ╨░╨║╤é╤â╤Ç╨╕╤é╨╡ ╤ü╨╡ ╨│╨╡╨╜╨╡╤Ç╨╕╤Ç╨░╤é ╨░╨▓╤é╨╛╨╝╨░╤é╨╕╤ç╨╜╨╛ ╤ü╨╗╨╡╨┤ ╨▓╤ü╤Å╨║╨╛ ╨┐╨╗╨░╤ë╨░╨╜╨╡.'\r\n                  : 'Payments are processed securely through Stripe. Invoices are automatically generated after each payment.'}\r\n              </p>\r\n              <p>\r\n                {locale === 'bg'\r\n                  ? `╨ÿ╨╝╨╡╨╣╨╗ ╨╖╨░ ╤ä╨░╨║╤é╤â╤Ç╨╕: ${userEmail}`\r\n                  : `Billing email: ${userEmail}`}\r\n              </p>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\billing\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\billing\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\billing\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/subscriptions' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":5,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":5,"endColumn":73}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/lib/supabase/server\"\r\nimport { redirect } from \"@/i18n/routing\"\r\nimport { getTranslations } from \"next-intl/server\"\r\nimport { BillingContent } from \"./billing-content\"\r\nimport { createBillingPortalSession } from \"@/app/actions/subscriptions\"\r\n\r\ninterface BillingPageProps {\r\n  params: Promise<{\r\n    locale: string\r\n  }>\r\n}\r\n\r\nexport default async function BillingPage({ params }: BillingPageProps) {\r\n  const { locale: localeParam } = await params\r\n  const locale = localeParam === \"bg\" ? \"bg\" : \"en\"\r\n  const t = await getTranslations({ locale, namespace: \"Account\" })\r\n  const supabase = await createClient()\r\n\r\n  if (!supabase) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n\r\n  if (!user) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  // Parallel fetch for better performance\r\n  const [\r\n    { data: profile },\r\n    { data: privateProfile },\r\n    { data: subscription },\r\n    { data: boostsRaw },\r\n  ] = await Promise.all([\r\n    // Public profile surface\r\n    supabase\r\n      .from('profiles')\r\n      .select('id, tier')\r\n      .eq('id', user.id)\r\n      .single(),\r\n\r\n    // Private billing fields\r\n    supabase\r\n      .from('private_profiles')\r\n      .select('id, commission_rate, stripe_customer_id')\r\n      .eq('id', user.id)\r\n      .maybeSingle(),\r\n    \r\n    // Fetch active subscription\r\n    supabase\r\n      .from('subscriptions')\r\n      .select('id, seller_id, plan_type, status, price_paid, billing_period, starts_at, expires_at, stripe_subscription_id')\r\n      .eq('seller_id', user.id)\r\n      .eq('status', 'active')\r\n      .order('created_at', { ascending: false })\r\n      .limit(1)\r\n      .single(),\r\n    \r\n    // Fetch recent listing boosts (without join)\r\n    supabase\r\n      .from('listing_boosts')\r\n      .select('id, product_id, price_paid, duration_days, starts_at, expires_at, is_active, created_at')\r\n      .eq('seller_id', user.id)\r\n      .order('created_at', { ascending: false })\r\n      .limit(10),\r\n  ])\r\n\r\n  // Fetch products for boosts separately\r\n  const productIds = [...new Set((boostsRaw || []).map(b => b.product_id))]\r\n  const { data: boostProducts } = productIds.length > 0\r\n    ? await supabase.from('products').select('id, title, images').in('id', productIds)\r\n    : { data: [] }\r\n  \r\n  const productsMap = new Map((boostProducts || []).map(p => [p.id, p]))\r\n  \r\n  // Map boosts with product data\r\n  const boosts = (boostsRaw || []).map(boost => {\r\n    const product = productsMap.get(boost.product_id)\r\n    return {\r\n      ...boost,\r\n      products: product ? { id: product.id, title: product.title, images: product.images || [] } : undefined\r\n    }\r\n  })\r\n\r\n  const hasStripeCustomer = !!privateProfile?.stripe_customer_id\r\n\r\n  // Map profile to seller interface expected by BillingContent\r\n  const commissionRate = privateProfile?.commission_rate == null ? 0 : Number(privateProfile.commission_rate)\r\n  const seller = profile ? {\r\n    id: profile.id,\r\n    tier: profile.tier || 'free',\r\n    commission_rate: commissionRate,\r\n    stripe_customer_id: privateProfile?.stripe_customer_id ?? null,\r\n  } : null\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 md:gap-4\">\r\n      <h1 className=\"sr-only\">{t(\"header.billing\")}</h1>\r\n      <BillingContent\r\n        locale={locale}\r\n        seller={seller}\r\n        subscription={subscription as Parameters<typeof BillingContent>[0]['subscription']}\r\n        boosts={(boosts || []) as Parameters<typeof BillingContent>[0]['boosts']}\r\n        hasStripeCustomer={hasStripeCustomer}\r\n        userEmail={user.email || ''}\r\n        actions={{ createBillingPortalSession }}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\following\\following-content.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\following\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\following\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/seller-follows' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":5,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":5,"endColumn":62}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/lib/supabase/server\"\r\nimport { redirect } from \"@/i18n/routing\"\r\nimport { getTranslations } from \"next-intl/server\"\r\nimport { FollowingContent } from \"./following-content\"\r\nimport { unfollowSeller } from \"@/app/actions/seller-follows\"\r\n\r\ninterface FollowingPageProps {\r\n  params: Promise<{\r\n    locale: string\r\n  }>\r\n}\r\n\r\nexport default async function FollowingPage({ params }: FollowingPageProps) {\r\n  const { locale: localeParam } = await params\r\n  const locale = localeParam === \"bg\" ? \"bg\" : \"en\"\r\n  const t = await getTranslations({ locale, namespace: \"Account\" })\r\n  const supabase = await createClient()\r\n\r\n  if (!supabase) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  const {\r\n    data: { user },\r\n  } = await supabase.auth.getUser()\r\n\r\n  if (!user) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  // Fetch followed sellers (without join - relations not working in types)\r\n  const { data: followedSellers, count } = await supabase\r\n    .from(\"store_followers\")\r\n    .select(\"seller_id, created_at\", { count: \"exact\" })\r\n    .eq(\"follower_id\", user.id)\r\n    .order(\"created_at\", { ascending: false })\r\n\r\n  // Fetch seller IDs\r\n  const sellerIds = (followedSellers || []).map(f => f.seller_id)\r\n\r\n  // Fetch profiles for followed sellers separately\r\n  const { data: profilesData } = sellerIds.length > 0\r\n    ? await supabase\r\n        .from(\"profiles\")\r\n        .select(\"id, username, display_name, full_name, bio, avatar_url, verified\")\r\n        .in(\"id\", sellerIds)\r\n    : { data: [] }\r\n\r\n  // Fetch seller_stats for followed sellers\r\n  const { data: statsData } = sellerIds.length > 0 \r\n    ? await supabase\r\n        .from(\"seller_stats\")\r\n        .select(\"seller_id, follower_count, total_reviews, average_rating, total_listings\")\r\n        .in(\"seller_id\", sellerIds)\r\n    : { data: [] }\r\n\r\n  // Create maps for quick lookup\r\n  const profilesMap = new Map((profilesData || []).map(p => [p.id, p]))\r\n  const statsMap = new Map((statsData || []).map(s => [s.seller_id, s]))\r\n\r\n  // Transform data for component - map profiles to seller shape expected by FollowingContent\r\n  const transformedSellers = (followedSellers || []).map(f => {\r\n    const profile = profilesMap.get(f.seller_id)\r\n    const stats = statsMap.get(f.seller_id)\r\n    \r\n    return {\r\n      seller_id: f.seller_id,\r\n      created_at: f.created_at,\r\n      seller: profile ? {\r\n        id: profile.id,\r\n        store_name: profile.display_name || profile.username || 'Unknown',\r\n        store_slug: profile.username,\r\n        description: profile.bio,\r\n        verified: profile.verified ?? false,\r\n        profile: {\r\n          full_name: profile.full_name,\r\n          avatar_url: profile.avatar_url,\r\n        }\r\n      } : null,\r\n      seller_stats: stats ? {\r\n        follower_count: stats.follower_count,\r\n        total_reviews: stats.total_reviews,\r\n        average_rating: stats.average_rating,\r\n        total_listings: stats.total_listings,\r\n      } : null\r\n    }\r\n  })\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 md:gap-4\">\r\n      <h1 className=\"sr-only\">\r\n        {t(\"header.following\")}\r\n      </h1>\r\n      <FollowingContent\r\n        locale={locale}\r\n        sellers={transformedSellers}\r\n        total={count || 0}\r\n        actions={{ unfollowSeller }}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\orders\\[id]\\_components\\order-detail-content.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 31 to the 25 allowed.","line":150,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":150,"endColumn":35},{"ruleId":"sonarjs/no-all-duplicated-branches","severity":1,"message":"This conditional operation returns the same value whether the condition is \"true\" or \"false\".","line":340,"column":58,"nodeType":"ConditionalExpression","messageId":"returnsTheSameValue","endLine":340,"endColumn":87},{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":375,"column":122,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":375,"endColumn":154}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useMemo, useState, useTransition } from \"react\"\r\nimport Image from \"next/image\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Checkbox } from \"@/components/ui/checkbox\"\r\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\"\r\nimport {\r\n  ArrowLeft,\r\n  Package,\r\n  Truck,\r\n  MapPin,\r\n  Clock,\r\n  CheckCircle,\r\n  XCircle,\r\n  ChatCircle,\r\n  Receipt,\r\n  Copy,\r\n  ArrowSquareOut,\r\n  SpinnerGap,\r\n  Warning,\r\n} from \"@phosphor-icons/react\"\r\nimport { toast } from \"sonner\"\r\nimport { formatDistanceToNow, format } from \"date-fns\"\r\nimport { bg, enUS } from \"date-fns/locale\"\r\nimport { getOrderStatusFromItems, type OrderItemStatus } from \"@/lib/order-status\"\r\nimport { OrderTimeline } from \"./order-timeline\"\r\nimport { BuyerOrderActions, type BuyerOrderActionsServerActions } from \"../../_components/buyer-order-actions\"\r\nimport { useTranslations } from \"next-intl\"\r\n\r\nexport type OrderDetailContentServerActions = BuyerOrderActionsServerActions & {\r\n  requestReturn: (\r\n    orderItemId: string,\r\n    reason: string\r\n  ) => Promise<{ success: boolean; error?: string }>\r\n}\r\n\r\ninterface OrderItem {\r\n  id: string\r\n  order_id: string\r\n  product_id: string\r\n  seller_id: string\r\n  quantity: number\r\n  price_at_purchase: number\r\n  status: OrderItemStatus | null\r\n  seller_received_at: string | null\r\n  tracking_number: string | null\r\n  shipping_carrier: string | null\r\n  shipped_at: string | null\r\n  delivered_at: string | null\r\n  product: {\r\n    id: string\r\n    title: string\r\n    slug: string | null\r\n    images: string[] | null\r\n    price: number\r\n  } | null\r\n  seller: {\r\n    id: string\r\n    store_name: string\r\n    profile?: {\r\n      full_name: string | null\r\n      avatar_url: string | null\r\n    }\r\n  } | null\r\n}\r\n\r\ninterface Order {\r\n  id: string\r\n  user_id: string\r\n  total_amount: number\r\n  status: string | null\r\n  shipping_address: {\r\n    name?: string\r\n    email?: string\r\n    address?: {\r\n      line1?: string\r\n      line2?: string\r\n      city?: string\r\n      state?: string\r\n      postal_code?: string\r\n      country?: string\r\n    }\r\n  } | null\r\n  created_at: string\r\n  stripe_payment_intent_id: string | null\r\n  order_items: OrderItem[]\r\n}\r\n\r\ninterface OrderDetailContentProps {\r\n  locale: string\r\n  order: Order\r\n  existingSellerFeedbackSellerIds?: string[]\r\n  conversationId?: string | null\r\n  actions: OrderDetailContentServerActions\r\n}\r\n\r\nconst STATUS_CONFIG = {\r\n  pending: { label: \"Pending\", labelBg: \"╨ÿ╨╖╤ç╨░╨║╨▓╨░\", color: \"bg-warning\", text: \"text-warning-foreground\", icon: Clock },\r\n  paid: { label: \"Paid\", labelBg: \"╨ƒ╨╗╨░╤é╨╡╨╜╨░\", color: \"bg-info\", text: \"text-info-foreground\", icon: Receipt },\r\n  processing: { label: \"Processing\", labelBg: \"╨₧╨▒╤Ç╨░╨▒╨╛╤é╨▓╨░ ╤ü╨╡\", color: \"bg-primary\", text: \"text-primary-foreground\", icon: Package },\r\n  shipped: { label: \"Shipped\", labelBg: \"╨ÿ╨╖╨┐╤Ç╨░╤é╨╡╨╜╨░\", color: \"bg-primary\", text: \"text-primary-foreground\", icon: Truck },\r\n  delivered: { label: \"Delivered\", labelBg: \"╨ö╨╛╤ü╤é╨░╨▓╨╡╨╜╨░\", color: \"bg-success\", text: \"text-success-foreground\", icon: CheckCircle },\r\n  cancelled: { label: \"Cancelled\", labelBg: \"╨₧╤é╨╝╨╡╨╜╨╡╨╜╨░\", color: \"bg-destructive\", text: \"text-destructive-foreground\", icon: XCircle },\r\n} as const satisfies Record<\r\n  \"pending\" | \"paid\" | \"processing\" | \"shipped\" | \"delivered\" | \"cancelled\",\r\n  { label: string; labelBg: string; color: string; text: string; icon: typeof CheckCircle }\r\n>\r\n\r\ntype OrderStatusKey = keyof typeof STATUS_CONFIG\r\n\r\nconst ORDER_PROGRESS_STATUSES = [\"pending\", \"paid\", \"processing\", \"shipped\", \"delivered\"] as const\r\ntype OrderProgressStatusKey = (typeof ORDER_PROGRESS_STATUSES)[number]\r\n\r\nfunction normalizeProgressStatus(status: OrderStatusKey): OrderProgressStatusKey {\r\n  return status === \"cancelled\" ? \"pending\" : status\r\n}\r\n\r\nfunction isOrderStatusKey(status: string): status is OrderStatusKey {\r\n  return status in STATUS_CONFIG\r\n}\r\n\r\nfunction getStatusConfig(status: string): (typeof STATUS_CONFIG)[OrderStatusKey] {\r\n  return STATUS_CONFIG[isOrderStatusKey(status) ? status : \"pending\"]\r\n}\r\n\r\nconst CARRIERS: Record<string, { name: string; trackingUrl: string }> = {\r\n  speedy: { name: \"Speedy\", trackingUrl: \"https://www.speedy.bg/bg/track-shipment?shipmentNumber=\" },\r\n  econt: { name: \"Econt\", trackingUrl: \"https://www.econt.com/services/track-shipment/\" },\r\n  dhl: { name: \"DHL\", trackingUrl: \"https://www.dhl.com/en/express/tracking.html?AWB=\" },\r\n  ups: { name: \"UPS\", trackingUrl: \"https://www.ups.com/track?loc=en_US&tracknum=\" },\r\n  fedex: { name: \"FedEx\", trackingUrl: \"https://www.fedex.com/fedextrack/?tracknumbers=\" },\r\n  dpd: { name: \"DPD\", trackingUrl: \"https://www.dpd.com/bg/bg/paket-trassen/track-and-trace-system-bg/?parcelNr=\" },\r\n}\r\n\r\nexport function OrderDetailContent({ locale, order, existingSellerFeedbackSellerIds, conversationId, actions }: OrderDetailContentProps) {\r\n  const tCommon = useTranslations(\"Common\")\r\n  const [isReturnDialogOpen, setIsReturnDialogOpen] = useState(false)\r\n  const [returnReason, setReturnReason] = useState(\"\")\r\n  const [selectedItem, setSelectedItem] = useState<OrderItem | null>(null)\r\n  const [isSubmitting, setIsSubmitting] = useState(false)\r\n\r\n  const [isFeedbackDialogOpen, setIsFeedbackDialogOpen] = useState(false)\r\n  const [feedbackSellerId, setFeedbackSellerId] = useState<string | null>(null)\r\n  const [feedbackRating, setFeedbackRating] = useState<number>(5)\r\n  const [feedbackComment, setFeedbackComment] = useState<string>(\"\")\r\n  const [itemAsDescribed, setItemAsDescribed] = useState(true)\r\n  const [shippingSpeed, setShippingSpeed] = useState(true)\r\n  const [communication, setCommunication] = useState(true)\r\n  const [feedbackDismissed, setFeedbackDismissed] = useState(false)\r\n  const [submittedSellerIds, setSubmittedSellerIds] = useState<Set<string>>(new Set())\r\n  const [isSubmittingFeedback, startFeedbackTransition] = useTransition()\r\n\r\n  const dateLocale = locale === \"bg\" ? bg : enUS\r\n  const fallbackStatus = order.status && isOrderStatusKey(order.status) ? order.status : \"pending\"\r\n  const derivedStatus = getOrderStatusFromItems(\r\n    order.order_items.map((item) => item.status),\r\n    fallbackStatus\r\n  )\r\n  const orderStatusKey: OrderStatusKey = isOrderStatusKey(derivedStatus) ? derivedStatus : \"pending\"\r\n  const orderStatus = orderStatusKey\r\n  const statusConfig = STATUS_CONFIG[orderStatusKey]\r\n  const StatusIcon = statusConfig.icon\r\n  const stripePaymentIntentId = order.stripe_payment_intent_id\r\n\r\n  // Format currency\r\n  const formatPrice = (price: number) => {\r\n    return new Intl.NumberFormat(locale === \"bg\" ? \"bg-BG\" : \"en-US\", {\r\n      style: \"currency\",\r\n      currency: \"BGN\",\r\n    }).format(price)\r\n  }\r\n\r\n  // Copy to clipboard\r\n  const copyToClipboard = (text: string, label: string) => {\r\n    navigator.clipboard.writeText(text)\r\n    toast.success(locale === \"bg\" ? `${label} ╨║╨╛╨┐╨╕╤Ç╨░╨╜` : `${label} copied`)\r\n  }\r\n\r\n  // Open tracking URL\r\n  const openTracking = (item: OrderItem) => {\r\n    if (!item.tracking_number || !item.shipping_carrier) return\r\n\r\n    const carrier = CARRIERS[item.shipping_carrier.toLowerCase()]\r\n    if (carrier) {\r\n      window.open(carrier.trackingUrl + item.tracking_number, \"_blank\")\r\n    }\r\n  }\r\n\r\n  // Handle return request\r\n  const handleReturnRequest = async () => {\r\n    if (!selectedItem || !returnReason.trim()) {\r\n      toast.error(locale === \"bg\" ? \"╨£╨╛╨╗╤Å, ╨▓╤è╨▓╨╡╨┤╨╡╤é╨╡ ╨┐╤Ç╨╕╤ç╨╕╨╜╨░\" : \"Please enter a reason\")\r\n      return\r\n    }\r\n\r\n    setIsSubmitting(true)\r\n    const result = await actions.requestReturn(selectedItem.id, returnReason)\r\n    setIsSubmitting(false)\r\n\r\n    if (!result.success) {\r\n      toast.error(result.error || (locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░\" : \"Error\"))\r\n      return\r\n    }\r\n\r\n    toast.success(\r\n      locale === \"bg\"\r\n        ? \"╨ù╨░╤Å╨▓╨║╨░╤é╨░ ╨╖╨░ ╨▓╤Ç╤è╤ë╨░╨╜╨╡ ╨╡ ╨╕╨╖╨┐╤Ç╨░╤é╨╡╨╜╨░\"\r\n        : \"Return request submitted\"\r\n    )\r\n    setIsReturnDialogOpen(false)\r\n    setReturnReason(\"\")\r\n    setSelectedItem(null)\r\n  }\r\n\r\n  // Calculate order totals\r\n  const subtotal = order.order_items.reduce(\r\n    (sum, item) => sum + (item.price_at_purchase * item.quantity),\r\n    0\r\n  )\r\n  const shipping = 0 // Stub: Shipping cost stored in order.shipping_cost when checkout flow includes shipping calculator\r\n  const total = Number(order.total_amount)\r\n\r\n  const shippingAddress = order.shipping_address?.address\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const key = `seller_feedback_prompt_dismissed_order_${order.id}`\r\n      setFeedbackDismissed(localStorage.getItem(key) === \"1\")\r\n    } catch {\r\n      // ignore\r\n    }\r\n  }, [order.id])\r\n\r\n  const pendingFeedbackSellers = useMemo(() => {\r\n    const existing = new Set(existingSellerFeedbackSellerIds || [])\r\n    const map = new Map<string, { sellerId: string; storeName: string }>()\r\n    const nowMs = Date.now()\r\n\r\n    for (const item of order.order_items) {\r\n      if (!item.seller?.id) continue\r\n      const sellerId = item.seller.id\r\n      if (existing.has(sellerId)) continue\r\n      if (submittedSellerIds.has(sellerId)) continue\r\n\r\n      if (!item.delivered_at) continue\r\n      const delivered = new Date(item.delivered_at)\r\n      if (Number.isNaN(delivered.getTime())) continue\r\n\r\n      const threeDaysMs = 3 * 24 * 60 * 60 * 1000\r\n      if (nowMs - delivered.getTime() < threeDaysMs) continue\r\n\r\n      if (!map.has(sellerId)) {\r\n        map.set(sellerId, { sellerId, storeName: item.seller.store_name })\r\n      }\r\n    }\r\n\r\n    return [...map.values()]\r\n  }, [order.order_items, existingSellerFeedbackSellerIds, submittedSellerIds])\r\n\r\n  const shouldShowFeedbackPrompt = pendingFeedbackSellers.length > 0 && !feedbackDismissed\r\n\r\n  const openFeedbackDialog = (sellerId: string) => {\r\n    setFeedbackSellerId(sellerId)\r\n    setFeedbackRating(5)\r\n    setFeedbackComment(\"\")\r\n    setItemAsDescribed(true)\r\n    setShippingSpeed(true)\r\n    setCommunication(true)\r\n    setIsFeedbackDialogOpen(true)\r\n  }\r\n\r\n  const dismissFeedbackPrompt = () => {\r\n    try {\r\n      const key = `seller_feedback_prompt_dismissed_order_${order.id}`\r\n      localStorage.setItem(key, \"1\")\r\n    } catch {\r\n      // ignore\r\n    }\r\n    setFeedbackDismissed(true)\r\n  }\r\n\r\n  const submitFeedback = () => {\r\n    if (!feedbackSellerId) return\r\n    startFeedbackTransition(async () => {\r\n      const result = await actions.submitSellerFeedback({\r\n        sellerId: feedbackSellerId,\r\n        orderId: order.id,\r\n        rating: feedbackRating,\r\n        comment: feedbackComment.trim(),\r\n        itemAsDescribed,\r\n        shippingSpeed,\r\n        communication,\r\n      })\r\n\r\n      if (result.success) {\r\n        toast.success(locale === \"bg\" ? \"╨æ╨╗╨░╨│╨╛╨┤╨░╤Ç╨╕╨╝ ╨╖╨░ ╨╛╨▒╤Ç╨░╤é╨╜╨░╤é╨░ ╨▓╤Ç╤è╨╖╨║╨░\" : \"Thanks for your feedback\")\r\n        setSubmittedSellerIds((prev) => new Set(prev).add(feedbackSellerId))\r\n        setIsFeedbackDialogOpen(false)\r\n        setFeedbackSellerId(null)\r\n      } else {\r\n        toast.error(result.error || (locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░\" : \"Error\"))\r\n      }\r\n    })\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Back Button & Header */}\r\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\r\n        <div className=\"flex items-center gap-3\">\r\n          <Link href=\"/account/orders\">\r\n            <Button variant=\"ghost\" size=\"icon\" className=\"size-8\" aria-label={tCommon(\"back\")}>\r\n              <ArrowLeft className=\"size-4\" />\r\n            </Button>\r\n          </Link>\r\n          <div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <h2 className=\"text-lg font-semibold\">\r\n                {locale === \"bg\" ? \"╨ƒ╨╛╤Ç╤è╤ç╨║╨░\" : \"Order\"} #{order.id.slice(0, 8).toUpperCase()}\r\n              </h2>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"icon\"\r\n                className=\"size-6\"\r\n                onClick={() => copyToClipboard(order.id, locale === \"bg\" ? \"ID\" : \"ID\")}\r\n                aria-label={tCommon(\"copyOrderId\")}\r\n              >\r\n                <Copy className=\"size-3\" />\r\n              </Button>\r\n            </div>\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              {format(new Date(order.created_at), \"PPP\", { locale: dateLocale })}\r\n              {\" ┬╖ \"}\r\n              {formatDistanceToNow(new Date(order.created_at), { addSuffix: true, locale: dateLocale })}\r\n            </p>\r\n          </div>\r\n        </div>\r\n        <Badge variant=\"secondary\" className={`${statusConfig.color} ${statusConfig.text}`}>\r\n          <StatusIcon className=\"size-3.5 mr-1\" weight=\"fill\" />\r\n          {locale === \"bg\" ? statusConfig.labelBg : statusConfig.label}\r\n        </Badge>\r\n      </div>\r\n\r\n      {/* Order Progress */}\r\n      <Card>\r\n        <CardHeader className=\"pb-3\">\r\n          <CardTitle className=\"text-base\">{locale === \"bg\" ? \"╨í╤é╨░╤é╤â╤ü ╨╜╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨░╤é╨░\" : \"Order Status\"}</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex items-center justify-between\">\r\n            {ORDER_PROGRESS_STATUSES.map((status, index, arr) => {\r\n              const config = STATUS_CONFIG[status]\r\n              const Icon = config.icon\r\n              const isActive = arr.indexOf(normalizeProgressStatus(orderStatusKey)) >= index\r\n              const isCurrent = orderStatus === status\r\n\r\n              return (\r\n                <div key={status} className=\"flex items-center flex-1\">\r\n                  <div className=\"flex flex-col items-center flex-1\">\r\n                    <div className={`size-8 rounded-full flex items-center justify-center transition-colors ${isActive ? `${config.color} ${config.text}` : \"bg-muted text-muted-foreground\"\r\n                      }`}>\r\n                      <Icon className=\"size-4\" weight={isCurrent ? \"fill\" : \"regular\"} />\r\n                    </div>\r\n                    <span className={`text-xs mt-1.5 ${isActive ? \"font-medium\" : \"text-muted-foreground\"}`}>\r\n                      {locale === \"bg\" ? config.labelBg : config.label}\r\n                    </span>\r\n                  </div>\r\n                  {index < arr.length - 1 && (\r\n                    <div className={`h-0.5 flex-1 mx-1 transition-colors ${arr.indexOf(normalizeProgressStatus(orderStatusKey)) > index ? \"bg-primary\" : \"bg-muted\"\r\n                      }`} />\r\n                  )}\r\n                </div>\r\n              )\r\n            })}\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Feedback prompt (after delivery + 3 days) */}\r\n      {shouldShowFeedbackPrompt && (\r\n        <Card>\r\n          <CardHeader className=\"pb-3\">\r\n            <div className=\"flex items-start justify-between gap-3\">\r\n              <div>\r\n                <CardTitle className=\"text-base\">\r\n                  {locale === \"bg\" ? \"╨₧╤å╨╡╨╜╨╡╤é╨╡ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨░\" : \"Rate your seller\"}\r\n                </CardTitle>\r\n                <CardDescription>\r\n                  {locale === \"bg\"\r\n                    ? \"╨ƒ╨╛╨╝╨╛╨│╨╜╨╡╤é╨╡ ╨╜╨░ ╨┤╤Ç╤â╨│╨╕ ╨║╤â╨┐╤â╨▓╨░╤ç╨╕ ╤ü ╨╛╨▒╤Ç╨░╤é╨╜╨░ ╨▓╤Ç╤è╨╖╨║╨░.\"\r\n                    : \"Help other buyers with quick feedback.\"}\r\n                </CardDescription>\r\n              </div>\r\n              <Button variant=\"ghost\" size=\"sm\" onClick={dismissFeedbackPrompt}>\r\n                {locale === \"bg\" ? \"╨í╨║╤Ç╨╕╨╣\" : \"Dismiss\"}\r\n              </Button>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent className=\"flex flex-col gap-3\">\r\n            {pendingFeedbackSellers.map((s) => (\r\n              <div key={s.sellerId} className=\"flex items-center justify-between gap-3\">\r\n                <div className=\"min-w-0\">\r\n                  <div className=\"text-sm font-medium truncate\">{s.storeName}</div>\r\n                  <div className=\"text-xs text-muted-foreground\">\r\n                    {locale === \"bg\" ? \"╨₧╤ü╤é╨░╨▓╨╡╤é╨╡ ╨╛╤å╨╡╨╜╨║╨░ ╨╖╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨░╤é╨░\" : \"Leave feedback for this order\"}\r\n                  </div>\r\n                </div>\r\n                <Button size=\"sm\" onClick={() => openFeedbackDialog(s.sellerId)}>\r\n                  {locale === \"bg\" ? \"╨₧╤å╨╡╨╜╨╕\" : \"Review\"}\r\n                </Button>\r\n              </div>\r\n            ))}\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      <div className=\"grid gap-4 lg:grid-cols-3\">\r\n        {/* Order Items */}\r\n        <div className=\"lg:col-span-2 space-y-4\">\r\n          <Card>\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-base\">\r\n                {locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨┤╤â╨║╤é╨╕\" : \"Items\"} ({order.order_items.length})\r\n              </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              {order.order_items.map((item) => {\r\n                const itemStatus = item.status || \"pending\"\r\n                const itemConfig = getStatusConfig(itemStatus)\r\n                const firstImage = item.product?.images?.[0]\r\n\r\n                return (\r\n                  <div key={item.id} className=\"flex gap-4 p-3 rounded-lg border bg-card\">\r\n                    {/* Product Image */}\r\n                    <div className=\"relative size-20 rounded-md overflow-hidden bg-muted shrink-0\">\r\n                      {firstImage ? (\r\n                        <Image\r\n                          src={firstImage}\r\n                          alt={item.product?.title || \"Product\"}\r\n                          fill\r\n                          className=\"object-cover\"\r\n                        />\r\n                      ) : (\r\n                        <div className=\"size-full flex items-center justify-center\">\r\n                          <Package className=\"size-8 text-muted-foreground\" />\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n\r\n                    {/* Product Info */}\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <div className=\"flex items-start justify-between gap-2\">\r\n                        <div>\r\n\r\n                          {/* Seller feedback dialog */}\r\n                          <Dialog open={isFeedbackDialogOpen} onOpenChange={setIsFeedbackDialogOpen}>\r\n                            <DialogContent>\r\n                              <DialogHeader>\r\n                                <DialogTitle>{locale === \"bg\" ? \"╨₧╨▒╤Ç╨░╤é╨╜╨░ ╨▓╤Ç╤è╨╖╨║╨░\" : \"Seller feedback\"}</DialogTitle>\r\n                                <DialogDescription>\r\n                                  {locale === \"bg\"\r\n                                    ? \"╨₧╤å╨╡╨╜╨╡╤é╨╡ ╨║╨░╤ç╨╡╤ü╤é╨▓╨╛╤é╨╛ ╨╜╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨░╤é╨░ ╨╕ ╨║╨╛╨╝╤â╨╜╨╕╨║╨░╤å╨╕╤Å╤é╨░.\"\r\n                                    : \"Rate the order experience and communication.\"}\r\n                                </DialogDescription>\r\n                              </DialogHeader>\r\n\r\n                              <div className=\"space-y-4\">\r\n                                <div className=\"space-y-2\">\r\n                                  <Label>{locale === \"bg\" ? \"╨₧╤å╨╡╨╜╨║╨░\" : \"Rating\"}</Label>\r\n                                  <RadioGroup\r\n                                    value={String(feedbackRating)}\r\n                                    onValueChange={(v) => setFeedbackRating(Number(v))}\r\n                                    className=\"flex flex-wrap gap-3\"\r\n                                  >\r\n                                    {[5, 4, 3, 2, 1].map((r) => (\r\n                                      <div key={r} className=\"flex items-center gap-2\">\r\n                                        <RadioGroupItem value={String(r)} id={`rating-${r}`} />\r\n                                        <Label htmlFor={`rating-${r}`}>{r}</Label>\r\n                                      </div>\r\n                                    ))}\r\n                                  </RadioGroup>\r\n                                </div>\r\n\r\n                                <div className=\"space-y-2\">\r\n                                  <Label>{locale === \"bg\" ? \"╨ö╨╡╤é╨░╨╣╨╗╨╕\" : \"Details\"}</Label>\r\n                                  <div className=\"space-y-2\">\r\n                                    <label className=\"flex items-center gap-2 text-sm\">\r\n                                      <Checkbox checked={itemAsDescribed} onCheckedChange={(v) => setItemAsDescribed(Boolean(v))} />\r\n                                      {locale === \"bg\" ? \"╨₧╨┐╨╕╤ü╨░╨╜╨╕╨╡╤é╨╛ ╨╛╤é╨│╨╛╨▓╨░╤Ç╤Å\" : \"Item as described\"}\r\n                                    </label>\r\n                                    <label className=\"flex items-center gap-2 text-sm\">\r\n                                      <Checkbox checked={shippingSpeed} onCheckedChange={(v) => setShippingSpeed(Boolean(v))} />\r\n                                      {locale === \"bg\" ? \"╨æ╤è╤Ç╨╖╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░\" : \"Fast shipping\"}\r\n                                    </label>\r\n                                    <label className=\"flex items-center gap-2 text-sm\">\r\n                                      <Checkbox checked={communication} onCheckedChange={(v) => setCommunication(Boolean(v))} />\r\n                                      {locale === \"bg\" ? \"╨ö╨╛╨▒╤Ç╨░ ╨║╨╛╨╝╤â╨╜╨╕╨║╨░╤å╨╕╤Å\" : \"Good communication\"}\r\n                                    </label>\r\n                                  </div>\r\n                                </div>\r\n\r\n                                <div className=\"space-y-2\">\r\n                                  <Label htmlFor=\"seller-feedback-comment\">{locale === \"bg\" ? \"╨Ü╨╛╨╝╨╡╨╜╤é╨░╤Ç (╨┐╨╛ ╨╕╨╖╨▒╨╛╤Ç)\" : \"Comment (optional)\"}</Label>\r\n                                  <Textarea\r\n                                    id=\"seller-feedback-comment\"\r\n                                    value={feedbackComment}\r\n                                    onChange={(e) => setFeedbackComment(e.target.value)}\r\n                                    rows={4}\r\n                                  />\r\n                                </div>\r\n                              </div>\r\n\r\n                              <DialogFooter>\r\n                                <Button variant=\"outline\" onClick={() => setIsFeedbackDialogOpen(false)}>\r\n                                  {locale === \"bg\" ? \"╨₧╤é╨║╨░╨╖\" : \"Cancel\"}\r\n                                </Button>\r\n                                <Button onClick={submitFeedback} disabled={isSubmittingFeedback}>\r\n                                  {isSubmittingFeedback ? (\r\n                                    <>\r\n                                      <SpinnerGap className=\"size-4 mr-2 animate-spin\" />\r\n                                      {locale === \"bg\" ? \"╨ÿ╨╖╨┐╤Ç╨░╤ë╨░╨╜╨╡...\" : \"Submitting...\"}\r\n                                    </>\r\n                                  ) : (\r\n                                    locale === \"bg\" ? \"╨ÿ╨╖╨┐╤Ç╨░╤é╨╕\" : \"Submit\"\r\n                                  )}\r\n                                </Button>\r\n                              </DialogFooter>\r\n                            </DialogContent>\r\n                          </Dialog>\r\n                          <Link\r\n                            href={`/product/${item.product?.slug || item.product_id}`}\r\n                            className=\"font-medium hover:underline line-clamp-2\"\r\n                          >\r\n                            {item.product?.title || \"Unknown Product\"}\r\n                          </Link>\r\n                          {item.seller && (\r\n                            <p className=\"text-sm text-muted-foreground\">\r\n                              {locale === \"bg\" ? \"╨₧╤é\" : \"From\"}: {item.seller.store_name}\r\n                            </p>\r\n                          )}\r\n                        </div>\r\n                        <Badge variant=\"outline\" className=\"shrink-0\">\r\n                          {locale === \"bg\" ? itemConfig.labelBg : itemConfig.label}\r\n                        </Badge>\r\n                      </div>\r\n\r\n                      <div className=\"flex items-center justify-between mt-2\">\r\n                        <p className=\"text-sm\">\r\n                          {item.quantity} ├ù {formatPrice(item.price_at_purchase)}\r\n                        </p>\r\n                        <p className=\"font-medium\">\r\n                          {formatPrice(item.quantity * item.price_at_purchase)}\r\n                        </p>\r\n                      </div>\r\n\r\n                      {/* Tracking Info */}\r\n                      {item.tracking_number && (\r\n                        <div className=\"flex items-center gap-2 mt-2 p-2 rounded bg-surface-subtle\">\r\n                          <Truck className=\"size-4 text-muted-foreground\" />\r\n                          <span className=\"text-sm flex-1\">\r\n                            {item.shipping_carrier && CARRIERS[item.shipping_carrier.toLowerCase()]?.name}\r\n                            : {item.tracking_number}\r\n                          </span>\r\n                          <Button\r\n                            variant=\"ghost\"\r\n                            size=\"sm\"\r\n                            className=\"h-7\"\r\n                            onClick={() => openTracking(item)}\r\n                          >\r\n                            <ArrowSquareOut className=\"size-3.5\" />\r\n                            {locale === \"bg\" ? \"╨ƒ╤Ç╨╛╤ü╨╗╨╡╨┤╨╕\" : \"Track\"}\r\n                          </Button>\r\n                        </div>\r\n                      )}\r\n\r\n                      {/* Actions */}\r\n                      <div className=\"flex gap-2 mt-3\">\r\n                        <Link href={`/messages?seller=${item.seller_id}`}>\r\n                          <Button variant=\"outline\" size=\"sm\" className=\"h-7\">\r\n                            <ChatCircle className=\"size-3.5 mr-1\" />\r\n                            {locale === \"bg\" ? \"╨í╤è╨╛╨▒╤ë╨╡╨╜╨╕╨╡\" : \"Message\"}\r\n                          </Button>\r\n                        </Link>\r\n                        {itemStatus === \"delivered\" && (\r\n                          <Button\r\n                            variant=\"outline\"\r\n                            size=\"sm\"\r\n                            className=\"h-7\"\r\n                            onClick={() => {\r\n                              setSelectedItem(item)\r\n                              setIsReturnDialogOpen(true)\r\n                            }}\r\n                          >\r\n                            <Warning className=\"size-3.5 mr-1\" />\r\n                            {locale === \"bg\" ? \"╨Æ╤è╤Ç╨╜╨╕\" : \"Return\"}\r\n                          </Button>\r\n                        )}\r\n                      </div>\r\n                      {(itemStatus === \"shipped\" || itemStatus === \"delivered\") && (\r\n                        <div className=\"mt-2\">\r\n                          <BuyerOrderActions\r\n                            orderItemId={item.id}\r\n                            currentStatus={itemStatus}\r\n                            sellerId={item.seller_id}\r\n                            conversationId={conversationId ?? null}\r\n                            locale={locale}\r\n                            orderId={order.id}\r\n                            actions={actions}\r\n                            mode=\"report-only\"\r\n                          />\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                )\r\n              })}\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        {/* Order Summary & Shipping */}\r\n        <div className=\"space-y-4\">\r\n          {/* Order Summary */}\r\n          <Card>\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-base\">{locale === \"bg\" ? \"╨₧╨▒╨╛╨▒╤ë╨╡╨╜╨╕╨╡\" : \"Summary\"}</CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-3\">\r\n              <div className=\"flex justify-between text-sm\">\r\n                <span className=\"text-muted-foreground\">{locale === \"bg\" ? \"╨£╨╡╨╢╨┤╨╕╨╜╨╜╨░ ╤ü╤â╨╝╨░\" : \"Subtotal\"}</span>\r\n                <span>{formatPrice(subtotal)}</span>\r\n              </div>\r\n              <div className=\"flex justify-between text-sm\">\r\n                <span className=\"text-muted-foreground\">{locale === \"bg\" ? \"╨ö╨╛╤ü╤é╨░╨▓╨║╨░\" : \"Shipping\"}</span>\r\n                <span>{shipping === 0 ? (locale === \"bg\" ? \"╨æ╨╡╨╖╨┐╨╗╨░╤é╨╜╨░\" : \"Free\") : formatPrice(shipping)}</span>\r\n              </div>\r\n              <Separator />\r\n              <div className=\"flex justify-between font-medium\">\r\n                <span>{locale === \"bg\" ? \"╨₧╨▒╤ë╨╛\" : \"Total\"}</span>\r\n                <span>{formatPrice(total)}</span>\r\n              </div>\r\n              {stripePaymentIntentId && (\r\n                <div className=\"flex items-center gap-2 text-xs text-muted-foreground pt-2\">\r\n                  <Receipt className=\"size-3.5\" />\r\n                  <span>Stripe: {stripePaymentIntentId.slice(0, 20)}...</span>\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"icon\"\r\n                    className=\"size-5\"\r\n                    onClick={() => copyToClipboard(stripePaymentIntentId, \"Payment ID\")}\r\n                    aria-label={tCommon(\"copyPaymentId\")}\r\n                  >\r\n                    <Copy className=\"size-3\" />\r\n                  </Button>\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <OrderTimeline\r\n            locale={locale}\r\n            orderCreatedAt={order.created_at}\r\n            orderStatus={order.status}\r\n            orderItems={order.order_items.map((i) => ({\r\n              status: i.status,\r\n              seller_received_at: i.seller_received_at,\r\n              shipped_at: i.shipped_at,\r\n              delivered_at: i.delivered_at,\r\n              tracking_number: i.tracking_number,\r\n              shipping_carrier: i.shipping_carrier,\r\n            }))}\r\n          />\r\n\r\n          {/* Shipping Address */}\r\n          {shippingAddress && (\r\n            <Card>\r\n              <CardHeader className=\"pb-3\">\r\n                <CardTitle className=\"text-base flex items-center gap-2\">\r\n                  <MapPin className=\"size-4\" />\r\n                  {locale === \"bg\" ? \"╨É╨┤╤Ç╨╡╤ü ╨╖╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░\" : \"Shipping Address\"}\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div className=\"text-sm space-y-1\">\r\n                  {order.shipping_address?.name && (\r\n                    <p className=\"font-medium\">{order.shipping_address.name}</p>\r\n                  )}\r\n                  <p>{shippingAddress.line1}</p>\r\n                  {shippingAddress.line2 && <p>{shippingAddress.line2}</p>}\r\n                  <p>\r\n                    {[shippingAddress.city, shippingAddress.state, shippingAddress.postal_code]\r\n                      .filter(Boolean)\r\n                      .join(\", \")}\r\n                  </p>\r\n                  <p>{shippingAddress.country}</p>\r\n                  {order.shipping_address?.email && (\r\n                    <p className=\"text-muted-foreground\">{order.shipping_address.email}</p>\r\n                  )}\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          )}\r\n\r\n          {/* Help */}\r\n          <Card>\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-base\">{locale === \"bg\" ? \"╨¥╤â╨╢╨┤╨░ ╨╛╤é ╨┐╨╛╨╝╨╛╤ë?\" : \"Need Help?\"}</CardTitle>\r\n              <CardDescription>\r\n                {locale === \"bg\"\r\n                  ? \"╨í╨▓╤è╤Ç╨╢╨╡╤é╨╡ ╤ü╨╡ ╤ü ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨░ ╨╕╨╗╨╕ ╨┐╨╛╨┤╨┤╤Ç╤è╨╢╨║╨░╤é╨░\"\r\n                  : \"Contact the seller or support\"}\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-2\">\r\n              <Link href=\"/support\">\r\n                <Button variant=\"outline\" className=\"w-full justify-start\">\r\n                  <ChatCircle className=\"size-4 mr-2\" />\r\n                  {locale === \"bg\" ? \"╨í╨▓╤è╤Ç╨╢╨╡╤é╨╡ ╤ü╨╡ ╤ü ╨┐╨╛╨┤╨┤╤Ç╤è╨╢╨║╨░╤é╨░\" : \"Contact Support\"}\r\n                </Button>\r\n              </Link>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Return Request Dialog */}\r\n      <Dialog open={isReturnDialogOpen} onOpenChange={setIsReturnDialogOpen}>\r\n        <DialogContent className=\"sm:max-w-md\">\r\n          <DialogHeader>\r\n            <DialogTitle>{locale === \"bg\" ? \"╨ù╨░╤Å╨▓╨║╨░ ╨╖╨░ ╨▓╤Ç╤è╤ë╨░╨╜╨╡\" : \"Return Request\"}</DialogTitle>\r\n            <DialogDescription>\r\n              {locale === \"bg\"\r\n                ? \"╨₧╨┐╨╕╤ê╨╡╤é╨╡ ╨╖╨░╤ë╨╛ ╨╕╤ü╨║╨░╤é╨╡ ╨┤╨░ ╨▓╤è╤Ç╨╜╨╡╤é╨╡ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨░\"\r\n                : \"Describe why you want to return this item\"}\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          {selectedItem && (\r\n            <div className=\"flex items-center gap-3 p-3 rounded-lg border bg-surface-subtle\">\r\n              <div className=\"relative size-12 rounded overflow-hidden bg-muted\">\r\n                {selectedItem.product?.images?.[0] ? (\r\n                  <Image\r\n                    src={selectedItem.product.images[0]}\r\n                    alt={selectedItem.product.title || \"Product\"}\r\n                    fill\r\n                    className=\"object-cover\"\r\n                  />\r\n                ) : (\r\n                  <div className=\"size-full flex items-center justify-center\">\r\n                    <Package className=\"size-5 text-muted-foreground\" />\r\n                  </div>\r\n                )}\r\n              </div>\r\n              <div className=\"flex-1 min-w-0\">\r\n                <p className=\"font-medium text-sm line-clamp-1\">{selectedItem.product?.title}</p>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {selectedItem.quantity} ├ù {formatPrice(selectedItem.price_at_purchase)}\r\n                </p>\r\n              </div>\r\n            </div>\r\n          )}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"returnReason\">{locale === \"bg\" ? \"╨ƒ╤Ç╨╕╤ç╨╕╨╜╨░\" : \"Reason\"}</Label>\r\n            <Textarea\r\n              id=\"returnReason\"\r\n              value={returnReason}\r\n              onChange={(e) => setReturnReason(e.target.value)}\r\n              placeholder={locale === \"bg\" ? \"╨₧╨┐╨╕╤ê╨╡╤é╨╡ ╨┐╤Ç╨╛╨▒╨╗╨╡╨╝╨░...\" : \"Describe the issue...\"}\r\n              rows={4}\r\n            />\r\n          </div>\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setIsReturnDialogOpen(false)}>\r\n              {locale === \"bg\" ? \"╨₧╤é╨║╨░╨╖\" : \"Cancel\"}\r\n            </Button>\r\n            <Button onClick={handleReturnRequest} disabled={isSubmitting || !returnReason.trim()}>\r\n              {isSubmitting ? (\r\n                <SpinnerGap className=\"size-4 mr-2 animate-spin\" />\r\n              ) : null}\r\n              {locale === \"bg\" ? \"╨ÿ╨╖╨┐╤Ç╨░╤é╨╕ ╨╖╨░╤Å╨▓╨║╨░\" : \"Submit Request\"}\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\orders\\[id]\\_components\\order-timeline.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\orders\\[id]\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/orders' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":6,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":6,"endColumn":139},{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/seller-feedback' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":7,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":7,"endColumn":69}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/lib/supabase/server\"\r\nimport { notFound } from \"next/navigation\"\r\nimport { redirect } from \"@/i18n/routing\"\r\nimport { setRequestLocale } from \"next-intl/server\"\r\nimport { locales } from \"@/i18n/routing\"\r\nimport { buyerConfirmDelivery, canBuyerRateSeller, reportOrderIssue, requestOrderCancellation, requestReturn } from \"@/app/actions/orders\"\r\nimport { submitSellerFeedback } from \"@/app/actions/seller-feedback\"\r\nimport { OrderDetailContent } from \"./_components/order-detail-content\"\r\nimport type { OrderItemStatus } from \"@/lib/order-status\"\r\n\r\n// Return placeholder param for build validation (required by cacheComponents)\r\n// Actual pages are rendered server-side for authenticated users\r\nexport function generateStaticParams() {\r\n  return locales.map((locale) => ({ locale, id: \"__placeholder__\" }))\r\n}\r\n\r\ninterface OrderDetailPageProps {\r\n  params: Promise<{\r\n    locale: string\r\n    id: string\r\n  }>\r\n}\r\n\r\n// Types matching the OrderDetailContent expectations\r\ninterface OrderItemProduct {\r\n  id: string\r\n  title: string\r\n  slug: string | null\r\n  images: string[] | null\r\n  price: number\r\n}\r\n\r\ninterface OrderItemSeller {\r\n  id: string\r\n  store_name: string\r\n  profile?: {\r\n    full_name: string | null\r\n    avatar_url: string | null\r\n  }\r\n}\r\n\r\ninterface OrderItem {\r\n  id: string\r\n  order_id: string\r\n  product_id: string\r\n  seller_id: string\r\n  quantity: number\r\n  price_at_purchase: number\r\n  status: OrderItemStatus | null\r\n  seller_received_at: string | null\r\n  tracking_number: string | null\r\n  shipping_carrier: string | null\r\n  shipped_at: string | null\r\n  delivered_at: string | null\r\n  product: OrderItemProduct | null\r\n  seller: OrderItemSeller | null\r\n}\r\n\r\ninterface Order {\r\n  id: string\r\n  user_id: string\r\n  total_amount: number\r\n  status: string | null\r\n  shipping_address: {\r\n    name?: string\r\n    email?: string\r\n    address?: {\r\n      line1?: string\r\n      line2?: string\r\n      city?: string\r\n      state?: string\r\n      postal_code?: string\r\n      country?: string\r\n    }\r\n  } | null\r\n  created_at: string\r\n  stripe_payment_intent_id: string | null\r\n  order_items: OrderItem[]\r\n}\r\n\r\nexport default async function OrderDetailPage({ params }: OrderDetailPageProps) {\r\n  const { locale: localeParam, id } = await params\r\n  const locale = localeParam === \"bg\" ? \"bg\" : \"en\"\r\n  \r\n  // Enable static generation for this locale\r\n  setRequestLocale(locale)\r\n  \r\n  const supabase = await createClient()\r\n\r\n  if (!supabase) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  const {\r\n    data: { user },\r\n  } = await supabase.auth.getUser()\r\n\r\n  if (!user) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  // Fetch order\r\n  const { data: orderData, error: orderError } = await supabase\r\n    .from(\"orders\")\r\n    .select(\"id,user_id,total_amount,status,shipping_address,created_at,stripe_payment_intent_id\")\r\n    .eq(\"id\", id)\r\n    .eq(\"user_id\", user.id)\r\n    .single()\r\n\r\n  if (orderError || !orderData) {\r\n    notFound()\r\n  }\r\n\r\n  // Fetch order items - cast to expected shape\r\n  const { data: orderItemsRaw } = await supabase\r\n    .from(\"order_items\")\r\n    .select(\r\n      \"id,order_id,product_id,seller_id,quantity,price_at_purchase,status,seller_received_at,tracking_number,shipping_carrier,shipped_at,delivered_at\"\r\n    )\r\n    .eq(\"order_id\", id)\r\n\r\n  const orderItemsData = (orderItemsRaw || []) as Array<{\r\n    id: string\r\n    order_id: string\r\n    product_id: string\r\n    seller_id: string\r\n    quantity: number\r\n    price_at_purchase: number\r\n    status: OrderItemStatus | null\r\n    seller_received_at: string | null\r\n    tracking_number: string | null\r\n    shipping_carrier: string | null\r\n    shipped_at: string | null\r\n    delivered_at: string | null\r\n  }>\r\n\r\n  // Fetch products for order items\r\n  const productIds = orderItemsData.map((item) => item.product_id)\r\n  const { data: productsRaw } = productIds.length > 0\r\n    ? await supabase\r\n        .from(\"products\")\r\n        .select(\"id, title, slug, images, price\")\r\n        .in(\"id\", productIds)\r\n    : { data: [] }\r\n\r\n  const productsData = (productsRaw || []) as unknown as Array<{\r\n    id: string\r\n    title: string\r\n    slug: string | null\r\n    images: string[] | null\r\n    price: number\r\n  }>\r\n\r\n  // Fetch seller profiles for order items (seller_id references profiles.id)\r\n  const sellerIds = orderItemsData.map((item) => item.seller_id)\r\n  const { data: sellerProfilesRaw } = sellerIds.length > 0\r\n    ? await supabase\r\n        .from(\"profiles\")\r\n        .select(\"id, full_name, avatar_url, business_name\")\r\n        .in(\"id\", sellerIds)\r\n    : { data: [] }\r\n\r\n  const sellerProfilesData = (sellerProfilesRaw || []) as unknown as Array<{\r\n    id: string\r\n    full_name: string | null\r\n    avatar_url: string | null\r\n    business_name: string | null\r\n  }>\r\n\r\n  // Create lookup maps\r\n  const productsMap = new Map(productsData.map((p) => [p.id, p]))\r\n  const sellerProfilesMap = new Map(sellerProfilesData.map((p) => [p.id, p]))\r\n\r\n  // Build order items with relations\r\n  const orderItems: OrderItem[] = orderItemsData.map((item) => {\r\n    const product = productsMap.get(item.product_id)\r\n    const sellerProfile = sellerProfilesMap.get(item.seller_id)\r\n    return {\r\n      id: item.id,\r\n      order_id: item.order_id,\r\n      product_id: item.product_id,\r\n      seller_id: item.seller_id,\r\n      quantity: item.quantity,\r\n      price_at_purchase: item.price_at_purchase,\r\n      status: item.status,\r\n      seller_received_at: item.seller_received_at,\r\n      tracking_number: item.tracking_number,\r\n      shipping_carrier: item.shipping_carrier,\r\n      shipped_at: item.shipped_at,\r\n      delivered_at: item.delivered_at,\r\n      product: product || null,\r\n      seller: sellerProfile ? {\r\n        id: sellerProfile.id,\r\n        store_name: sellerProfile.business_name || sellerProfile.full_name || \"Unknown Seller\",\r\n        profile: {\r\n          full_name: sellerProfile.full_name,\r\n          avatar_url: sellerProfile.avatar_url,\r\n        }\r\n      } : null,\r\n    }\r\n  })\r\n\r\n  // Build final order object with proper typing\r\n  const order: Order = {\r\n    id: orderData.id,\r\n    user_id: orderData.user_id,\r\n    total_amount: orderData.total_amount,\r\n    status: orderData.status,\r\n    shipping_address: orderData.shipping_address as Order[\"shipping_address\"],\r\n    created_at: orderData.created_at,\r\n    stripe_payment_intent_id: orderData.stripe_payment_intent_id,\r\n    order_items: orderItems,\r\n  }\r\n\r\n  const { data: conversation } = await supabase\r\n    .from(\"conversations\")\r\n    .select(\"id\")\r\n    .eq(\"order_id\", id)\r\n    .or(`buyer_id.eq.${user.id},seller_id.eq.${user.id}`)\r\n    .maybeSingle()\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 md:gap-4\">\r\n      <h1 className=\"sr-only\">\r\n        {locale === \"bg\" ? `╨ƒ╨╛╤Ç╤è╤ç╨║╨░ #${id.slice(0, 8)}` : `Order #${id.slice(0, 8)}`}\r\n      </h1>\r\n      <OrderDetailContent \r\n        locale={locale} \r\n        order={order}\r\n        conversationId={conversation?.id ?? null}\r\n        actions={{ \r\n          requestReturn, \r\n          submitSellerFeedback,\r\n          buyerConfirmDelivery,\r\n          canBuyerRateSeller,\r\n          requestOrderCancellation,\r\n          reportOrderIssue,\r\n        }}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\orders\\_components\\account-orders-grid.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'isOrderStatusKey' to the outer scope.","line":89,"column":70,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":89,"endColumn":72},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getStatusColor' to the outer scope.","line":122,"column":55,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":122,"endColumn":57}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport Image from \"next/image\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { formatDistanceToNow } from \"date-fns\"\r\nimport { bg, enUS } from \"date-fns/locale\"\r\nimport { IconChevronRight, IconPackage, IconShoppingBag, IconMessageCircle } from \"@tabler/icons-react\"\r\n\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { BuyerOrderActions, type BuyerOrderActionsServerActions } from \"./buyer-order-actions\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { OrderStatusBadge } from \"@/components/shared/orders/order-status-badge\"\r\nimport type { OrderItemStatus, OrderStatusKey } from \"@/lib/order-status\"\r\nimport { getOrderStatusFromItems } from \"@/lib/order-status\"\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport {\r\n  Sheet,\r\n  SheetContent,\r\n  SheetDescription,\r\n  SheetHeader,\r\n  SheetTitle,\r\n  SheetTrigger,\r\n} from \"@/components/ui/sheet\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\n\r\ntype OrderStatus =\r\n  | \"pending\"\r\n  | \"processing\"\r\n  | \"paid\"\r\n  | \"shipped\"\r\n  | \"delivered\"\r\n  | \"cancelled\"\r\n  | string\r\n\r\ntype OrderProduct = {\r\n  id: string\r\n  title: string | null\r\n  images: string[] | null\r\n  price?: number | null\r\n}\r\n\r\ntype OrderItemRow = {\r\n  id: string\r\n  product_id: string\r\n  seller_id?: string\r\n  quantity: number\r\n  price_at_purchase?: number\r\n  product?: OrderProduct | null\r\n  // New status fields\r\n  status?: OrderItemStatus\r\n  tracking_number?: string | null\r\n  shipping_carrier?: string | null\r\n  shipped_at?: string | null\r\n}\r\n\r\ntype OrderRow = {\r\n  id: string\r\n  created_at: string\r\n  status: OrderStatus | null\r\n  fulfillment_status?: OrderStatus | null\r\n  total_amount: number | string | null\r\n  order_items: OrderItemRow[]\r\n}\r\n\r\nexport type AccountOrdersGridServerActions = BuyerOrderActionsServerActions & {\r\n  getOrderConversation: (\r\n    orderId: string,\r\n    sellerId: string\r\n  ) => Promise<{ conversationId: string | null; error?: string }>\r\n}\r\n\r\ninterface AccountOrdersGridProps {\r\n  orders: OrderRow[]\r\n  locale: string\r\n  actions: AccountOrdersGridServerActions\r\n}\r\n\r\nexport function AccountOrdersGrid({ orders, locale, actions }: AccountOrdersGridProps) {\r\n  const dateLocale = locale === \"bg\" ? bg : enUS\r\n  const [conversationMap, setConversationMap] = useState<Map<string, string>>(new Map())\r\n  const isOrderStatusKey = (value: unknown): value is OrderStatusKey =>\r\n    typeof value === \"string\" &&\r\n    [\"pending\", \"paid\", \"processing\", \"shipped\", \"delivered\", \"cancelled\"].includes(value)\r\n\r\n  // Fetch conversation IDs for each order\r\n  useEffect(() => {\r\n    async function fetchConversations() {\r\n      const map = new Map<string, string>()\r\n      for (const order of orders) {\r\n        try {\r\n          const result = await actions.getOrderConversation(order.id, '')\r\n          if (result.conversationId) {\r\n            map.set(order.id, result.conversationId)\r\n          }\r\n        } catch {\r\n          // Ignore errors\r\n        }\r\n      }\r\n      setConversationMap(map)\r\n    }\r\n\r\n    if (orders.length > 0) {\r\n      fetchConversations()\r\n    }\r\n  }, [actions, orders])\r\n\r\n  const formatCurrency = (value: number) =>\r\n    new Intl.NumberFormat(locale, {\r\n      style: \"currency\",\r\n      currency: locale === \"bg\" ? \"BGN\" : \"EUR\",\r\n      maximumFractionDigits: 2,\r\n    }).format(value)\r\n\r\n  const getStatusColor = (status: OrderStatus | null) => {\r\n    switch (status) {\r\n      case \"paid\":\r\n        return \"bg-success/10 text-success border-success/20\"\r\n      case \"pending\":\r\n        return \"bg-warning/10 text-warning border-warning/20\"\r\n      case \"processing\":\r\n        return \"bg-order-processing/10 text-order-processing border-order-processing/20\"\r\n      case \"shipped\":\r\n        return \"bg-order-shipped/10 text-order-shipped border-order-shipped/20\"\r\n      case \"partially_shipped\":\r\n        return \"bg-order-shipped/10 text-order-shipped border-order-shipped/20\"\r\n      case \"delivered\":\r\n        return \"bg-success/10 text-success border-success/20\"\r\n      case \"cancelled\":\r\n        return \"bg-error/10 text-error border-error/20\"\r\n      default:\r\n        return \"bg-muted text-muted-foreground border-border\"\r\n    }\r\n  }\r\n\r\n  const getStatusText = (status: OrderStatus | null) => {\r\n    if (locale === \"bg\") {\r\n      switch (status) {\r\n        case \"paid\":\r\n          return \"╨ƒ╨╗╨░╤é╨╡╨╜╨░\"\r\n        case \"pending\":\r\n          return \"╨ÿ╨╖╤ç╨░╨║╨▓╨░╨╜╨╡\"\r\n        case \"processing\":\r\n          return \"╨₧╨▒╤Ç╨░╨▒╨╛╤é╨║╨░\"\r\n        case \"shipped\":\r\n          return \"╨ÿ╨╖╨┐╤Ç╨░╤é╨╡╨╜╨░\"\r\n        case \"partially_shipped\":\r\n          return \"╨º╨░╤ü╤é╨╕╤ç╨╜╨╛ ╨╕╨╖╨┐╤Ç╨░╤é╨╡╨╜╨░\"\r\n        case \"delivered\":\r\n          return \"╨ö╨╛╤ü╤é╨░╨▓╨╡╨╜╨░\"\r\n        case \"cancelled\":\r\n          return \"╨₧╤é╨╝╨╡╨╜╨╡╨╜╨░\"\r\n        default:\r\n          return status || \"╨¥╨╡╨╕╨╖╨▓╨╡╤ü╤é╨╡╨╜\"\r\n      }\r\n    }\r\n    if (status === \"partially_shipped\") return \"Partially shipped\"\r\n    return status ? status.charAt(0).toUpperCase() + status.slice(1) : \"Unknown\"\r\n  }\r\n\r\n  const t = {\r\n    order: locale === \"bg\" ? \"╨ƒ╨╛╤Ç╤è╤ç╨║╨░\" : \"Order\",\r\n    items: locale === \"bg\" ? \"╨░╤Ç╤é╨╕╨║╤â╨╗╨░\" : \"items\",\r\n    item: locale === \"bg\" ? \"╨░╤Ç╤é╨╕╨║╤â╨╗\" : \"item\",\r\n    viewOrder: locale === \"bg\" ? \"╨Æ╨╕╨╢ ╨┐╨╛╤Ç╤è╤ç╨║╨░╤é╨░\" : \"View order\",\r\n    orderDetails: locale === \"bg\" ? \"╨ö╨╡╤é╨░╨╣╨╗╨╕ ╨╖╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨░╤é╨░\" : \"Order Details\",\r\n    placed: locale === \"bg\" ? \"╨¥╨░╨┐╤Ç╨░╨▓╨╡╨╜╨░\" : \"Placed\",\r\n    status: locale === \"bg\" ? \"╨í╤é╨░╤é╤â╤ü\" : \"Status\",\r\n    total: locale === \"bg\" ? \"╨₧╨▒╤ë╨╛\" : \"Total\",\r\n    qty: locale === \"bg\" ? \"╨Ü╨╛╨╗╨╕╤ç╨╡╤ü╤é╨▓╨╛\" : \"Qty\",\r\n    viewProduct: locale === \"bg\" ? \"╨Æ╨╕╨╢ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨░\" : \"View product\",\r\n    noOrders: locale === \"bg\" ? \"╨¥╤Å╨╝╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨╕\" : \"No orders found\",\r\n    noOrdersDesc: locale === \"bg\" ? \"╨Ü╨╛╨│╨░╤é╨╛ ╨╜╨░╨┐╤Ç╨░╨▓╨╕╤é╨╡ ╨┐╨╛╤Ç╤è╤ç╨║╨░, ╤é╤Å ╤ë╨╡ ╤ü╨╡ ╨┐╨╛╤Å╨▓╨╕ ╤é╤â╨║.\" : \"When you place an order, it will appear here.\",\r\n    startShopping: locale === \"bg\" ? \"╨Ü╤è╨╝ ╨╝╨░╨│╨░╨╖╨╕╨╜╨░\" : \"Start shopping\",\r\n    moreItems: locale === \"bg\" ? \"╨╛╤ë╨╡\" : \"more\",\r\n  }\r\n\r\n  // Empty state\r\n  if (orders.length === 0) {\r\n    return (\r\n      <Card>\r\n        <CardContent className=\"flex flex-col items-center justify-center py-12 text-center\">\r\n          <div className=\"flex size-16 items-center justify-center rounded-full bg-muted mb-4\">\r\n            <IconShoppingBag className=\"size-8 text-muted-foreground\" />\r\n          </div>\r\n          <h3 className=\"font-semibold text-lg\">{t.noOrders}</h3>\r\n          <p className=\"text-muted-foreground text-sm mt-1 max-w-sm\">\r\n            {t.noOrdersDesc}\r\n          </p>\r\n          <Button asChild className=\"mt-6\">\r\n            <Link href=\"/\">{t.startShopping}</Link>\r\n          </Button>\r\n        </CardContent>\r\n      </Card>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {/* Mobile: Revolut-style order cards */}\r\n      <div className=\"space-y-3 md:hidden\">\r\n        {orders.map((order) => {\r\n          const fallbackStatus = isOrderStatusKey(order.fulfillment_status)\r\n            ? order.fulfillment_status\r\n            : isOrderStatusKey(order.status)\r\n              ? order.status\r\n              : \"pending\"\r\n          const displayStatus = getOrderStatusFromItems(\r\n            order.order_items.map((item) => item.status),\r\n            fallbackStatus\r\n          )\r\n          const itemCount = order.order_items.reduce(\r\n            (sum, i) => sum + Number(i.quantity || 0),\r\n            0\r\n          )\r\n          const orderTotal = Number(order.total_amount || 0)\r\n          const visibleItems = order.order_items.slice(0, 3)\r\n          const remainingCount = order.order_items.length - 3\r\n\r\n          return (\r\n            <Sheet key={order.id}>\r\n              <SheetTrigger asChild>\r\n                <button className=\"active-scale-99 w-full text-left rounded-md bg-card border border-border p-4 transition-colors\">\r\n                  {/* Header: Price + Date */}\r\n                  <div className=\"flex items-center justify-between mb-3\">\r\n                    <p className=\"text-lg font-bold text-foreground tabular-nums\">\r\n                      {formatCurrency(orderTotal)}\r\n                    </p>\r\n                    <span className=\"text-xs text-muted-foreground\">\r\n                      {formatDistanceToNow(new Date(order.created_at), {\r\n                        addSuffix: false,\r\n                        locale: dateLocale,\r\n                      })}\r\n                    </span>\r\n                  </div>\r\n\r\n                  {/* Product Images Row */}\r\n                  <div className=\"flex items-center gap-2 mb-3\">\r\n                    {visibleItems.map((item) => {\r\n                      const image = item.product?.images?.[0]\r\n                      return (\r\n                        <div\r\n                          key={item.id}\r\n                          className=\"relative size-14 rounded-md overflow-hidden bg-card border border-border shrink-0\"\r\n                        >\r\n                          {image ? (\r\n                            <Image\r\n                              src={image}\r\n                              alt=\"\"\r\n                              fill\r\n                              className=\"object-cover\"\r\n                              sizes=\"56px\"\r\n                            />\r\n                          ) : (\r\n                            <div className=\"flex size-full items-center justify-center\">\r\n                              <IconPackage className=\"size-6 text-muted-foreground\" strokeWidth={1.5} />\r\n                            </div>\r\n                          )}\r\n                          {item.quantity > 1 && (\r\n                            <div className=\"absolute -bottom-0.5 -right-0.5 flex size-5 items-center justify-center rounded-full bg-primary text-2xs font-bold text-primary-foreground shadow-sm\">\r\n                              x{item.quantity}\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      )\r\n                    })}\r\n                    {remainingCount > 0 && (\r\n                      <div className=\"flex size-14 items-center justify-center rounded-md bg-surface-subtle text-sm font-medium text-muted-foreground\">\r\n                        +{remainingCount}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n\r\n                  {/* Footer: Status + Item count + View link */}\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <Badge variant=\"outline\" className={`text-2xs font-medium ${getStatusColor(displayStatus)}`}>\r\n                        {getStatusText(displayStatus)}\r\n                      </Badge>\r\n                      <span className=\"text-xs text-muted-foreground\">\r\n                        {itemCount} {itemCount === 1 ? t.item : t.items}\r\n                      </span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-1 text-xs font-medium text-primary\">\r\n                      <span>{t.viewOrder}</span>\r\n                      <IconChevronRight className=\"size-3.5\" />\r\n                    </div>\r\n                  </div>\r\n                </button>\r\n              </SheetTrigger>\r\n              <SheetContent side=\"bottom\" className=\"h-(--dialog-h-85vh) rounded-t-2xl\">\n                <SheetHeader className=\"pb-4 border-b\">\n                  <SheetTitle className=\"flex items-center gap-2\">\n                    <IconPackage className=\"size-5\" />\n                    {t.order} #{order.id.slice(0, 8)}\n                  </SheetTitle>\r\n                  <SheetDescription>\r\n                    <Badge\r\n                      variant=\"outline\"\r\n                      className={getStatusColor(status)}\r\n                    >\r\n                      {getStatusText(status)}\r\n                    </Badge>\r\n                  </SheetDescription>\r\n                </SheetHeader>\r\n                <ScrollArea className=\"flex-1 -mx-6 px-6\">\r\n                  <div className=\"py-4 space-y-4\">\r\n                    {/* Order info */}\r\n                    <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n                      <div>\r\n                        <p className=\"text-muted-foreground\">{t.placed}</p>\r\n                        <p className=\"font-medium\">\r\n                          {new Date(order.created_at).toLocaleDateString(\r\n                            locale,\r\n                            {\r\n                              year: \"numeric\",\r\n                              month: \"long\",\r\n                              day: \"numeric\",\r\n                            }\r\n                          )}\r\n                        </p>\r\n                      </div>\r\n                      <div>\r\n                        <p className=\"text-muted-foreground\">{t.total}</p>\r\n                        <p className=\"font-semibold tabular-nums\">\r\n                          {formatCurrency(orderTotal)}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n\r\n                    <Separator />\r\n\r\n                    {/* Items */}\r\n                    <div className=\"space-y-4\">\r\n                      {order.order_items.map((item) => {\r\n                        const product = item.product\r\n                        const image =\r\n                          product?.images?.[0] || \"/placeholder.svg\"\r\n                        const title =\r\n                          product?.title ||\r\n                          (locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨┤╤â╨║╤é\" : \"Product\")\r\n                        const href = `/product/${item.product_id}`\r\n                        const itemStatus = item.status || 'pending'\r\n\r\n                        return (\r\n                          <div key={item.id} className=\"flex gap-3\">\r\n                            <Link href={href} className=\"shrink-0\">\r\n                              <div className=\"relative size-16 overflow-hidden rounded-lg border bg-muted\">\r\n                                <Image\r\n                                  src={image}\r\n                                  alt={title}\r\n                                  fill\r\n                                  sizes=\"64px\"\r\n                                  className=\"object-contain\"\r\n                                />\r\n                              </div>\r\n                            </Link>\r\n                            <div className=\"min-w-0 flex-1\">\r\n                              <Link\r\n                                href={href}\r\n                                className=\"text-sm font-medium hover:underline line-clamp-2\"\r\n                              >\r\n                                {title}\r\n                              </Link>\r\n                              <div className=\"flex items-center gap-2 mt-1\">\r\n                                <OrderStatusBadge status={itemStatus as OrderItemStatus} size=\"sm\" />\r\n                              </div>\r\n                              <p className=\"text-xs text-muted-foreground mt-1\">\r\n                                {t.qty}: {item.quantity}\r\n                              </p>\r\n                              {item.price_at_purchase && (\r\n                                <p className=\"text-sm font-medium mt-1 tabular-nums\">\r\n                                  {formatCurrency(item.price_at_purchase)}\r\n                                </p>\r\n                              )}\r\n                              {/* Tracking info */}\r\n                              {item.tracking_number && (\r\n                                <p className=\"text-xs text-muted-foreground mt-1\">\r\n                                  ≡ƒôì {item.tracking_number} {item.shipping_carrier && `(${item.shipping_carrier})`}\r\n                                </p>\r\n                              )}\r\n                              {/* Buyer Actions: Confirm Delivery & Rate Seller */}\r\n                              {item.seller_id && (itemStatus === 'shipped' || itemStatus === 'delivered') && (\r\n                                <div className=\"mt-2\">\r\n                                  <BuyerOrderActions\r\n                                    orderItemId={item.id}\r\n                                    currentStatus={itemStatus as OrderItemStatus}\r\n                                    sellerId={item.seller_id}\r\n                                    conversationId={conversationMap.get(order.id) ?? null}\r\n                                    locale={locale}\r\n                                    orderId={order.id}\r\n                                    actions={actions}\r\n                                  />\r\n                                </div>\r\n                              )}\r\n                              {/* Chat link (shown for other statuses) */}\r\n                              {item.seller_id && itemStatus !== 'shipped' && itemStatus !== 'delivered' && conversationMap.get(order.id) && (\r\n                                <Link\r\n                                  href={`/chat/${conversationMap.get(order.id)}`}\r\n                                  className=\"inline-flex items-center gap-1 text-xs text-primary hover:underline mt-2\"\r\n                                >\r\n                                  <IconMessageCircle className=\"size-3\" />\r\n                                  {locale === \"bg\" ? \"╨º╨░╤é ╤ü ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨░\" : \"Chat with seller\"}\r\n                                </Link>\r\n                              )}\r\n                            </div>\r\n                          </div>\r\n                        )\r\n                      })}\r\n                    </div>\r\n                  </div>\r\n                </ScrollArea>\r\n              </SheetContent>\r\n            </Sheet>\r\n          )\r\n        })}\r\n      </div>\r\n\r\n      {/* Desktop: Table-like layout in Card */}\r\n      <Card className=\"hidden shadow-none md:block\">\r\n        <CardHeader className=\"pb-4\">\r\n          <CardTitle className=\"text-base\">{t.order}s</CardTitle>\r\n          <CardDescription>\r\n            {orders.length} {orders.length === 1 ? t.item : t.items}\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent className=\"p-0\">\r\n          <div className=\"divide-y\">\r\n            {orders.map((order) => {\r\n              const fallbackStatus = isOrderStatusKey(order.fulfillment_status)\r\n                ? order.fulfillment_status\r\n                : isOrderStatusKey(order.status)\r\n                  ? order.status\r\n                  : \"pending\"\r\n              const status = getOrderStatusFromItems(\r\n                order.order_items.map((item) => item.status),\r\n                fallbackStatus\r\n              )\r\n              const itemCount = order.order_items.reduce(\r\n                (sum, i) => sum + Number(i.quantity || 0),\r\n                0\r\n              )\r\n              const orderTotal = Number(order.total_amount || 0)\r\n              const visibleItems = order.order_items.slice(0, 4)\r\n              const remainingCount = order.order_items.length - 4\r\n\r\n              return (\r\n                <Sheet key={order.id}>\r\n                  <div className=\"flex items-center gap-4 p-4 hover:bg-hover transition-colors\">\r\n                    {/* Product thumbnails - fixed width for alignment */}\r\n                    <div className=\"w-40 shrink-0\">\r\n                      <div className=\"flex -space-x-2\">\r\n                        {visibleItems.map((item) => {\r\n                          const image =\r\n                            item.product?.images?.[0] || \"/placeholder.svg\"\r\n                          return (\r\n                            <div\r\n                              key={item.id}\r\n                              className=\"relative size-10 rounded-md border-2 border-background bg-muted overflow-hidden ring-1 ring-border\"\r\n                            >\r\n                              <Image\r\n                                src={image}\r\n                                alt=\"\"\r\n                                fill\r\n                                sizes=\"40px\"\r\n                                className=\"object-contain\"\r\n                              />\r\n                            </div>\r\n                          )\r\n                        })}\r\n                        {remainingCount > 0 && (\r\n                          <div className=\"flex size-10 items-center justify-center rounded-md border-2 border-background bg-muted text-xs font-medium text-muted-foreground ring-1 ring-border\">\r\n                            +{remainingCount}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n\r\n                    {/* Order info */}\r\n                    <div className=\"flex-1 min-w-0 grid grid-cols-4 gap-4 items-center\">\r\n                      <div className=\"min-w-0\">\r\n                        <p className=\"text-sm font-medium font-mono\">\r\n                          #{order.id.slice(0, 8)}\r\n                        </p>\r\n                        <p className=\"text-xs text-muted-foreground\">\r\n                          {itemCount} {itemCount === 1 ? t.item : t.items}\r\n                        </p>\r\n                      </div>\r\n                      <div>\r\n                        <Badge\r\n                          variant=\"outline\"\r\n                          className={getStatusColor(status)}\r\n                        >\r\n                          {getStatusText(status)}\r\n                        </Badge>\r\n                      </div>\r\n                      <div className=\"text-sm text-muted-foreground\">\r\n                        {formatDistanceToNow(new Date(order.created_at), {\r\n                          addSuffix: true,\r\n                          locale: dateLocale,\r\n                        })}\r\n                      </div>\r\n                      <div className=\"text-right\">\r\n                        <p className=\"text-sm font-semibold tabular-nums\">\r\n                          {formatCurrency(orderTotal)}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n\r\n                    {/* Action */}\r\n                    <SheetTrigger asChild>\r\n                      <Button variant=\"ghost\" size=\"sm\">\r\n                        {t.viewOrder}\r\n                        <IconChevronRight className=\"size-4 ml-1\" />\r\n                      </Button>\r\n                    </SheetTrigger>\r\n                  </div>\r\n\r\n                  <SheetContent className=\"sm:max-w-lg\">\r\n                    <SheetHeader className=\"pb-4 border-b\">\r\n                      <SheetTitle className=\"flex items-center gap-2\">\r\n                        <IconPackage className=\"size-5\" />\r\n                        {t.order} #{order.id.slice(0, 8)}\r\n                      </SheetTitle>\r\n                      <SheetDescription className=\"flex items-center gap-2\">\r\n                        <Badge\r\n                          variant=\"outline\"\r\n                          className={getStatusColor(status)}\r\n                        >\r\n                          {getStatusText(status)}\r\n                        </Badge>\r\n                        <span className=\"text-muted-foreground\">\r\n                          {new Date(order.created_at).toLocaleDateString(\r\n                            locale,\r\n                            {\r\n                              year: \"numeric\",\r\n                              month: \"long\",\r\n                              day: \"numeric\",\r\n                            }\r\n                          )}\r\n                        </span>\r\n                      </SheetDescription>\r\n                    </SheetHeader>\r\n                    <ScrollArea className=\"flex-1 -mx-6 px-6 h-(--account-orders-sheet-scroll-h)\">\r\n                      <div className=\"py-6 space-y-6\">\r\n                        {/* Summary */}\r\n                        <div className=\"flex items-center justify-between p-4 rounded-lg bg-surface-subtle\">\r\n                          <div>\r\n                            <p className=\"text-sm text-muted-foreground\">\r\n                              {t.total}\r\n                            </p>\r\n                            <p className=\"text-xl font-semibold tabular-nums\">\r\n                              {formatCurrency(orderTotal)}\r\n                            </p>\r\n                          </div>\r\n                          <Badge variant=\"outline\">\r\n                            {itemCount} {itemCount === 1 ? t.item : t.items}\r\n                          </Badge>\r\n                        </div>\r\n\r\n                        {/* Items */}\r\n                        <div className=\"space-y-4\">\r\n                          {order.order_items.map((item) => {\r\n                            const product = item.product\r\n                            const image =\r\n                              product?.images?.[0] || \"/placeholder.svg\"\r\n                            const title =\r\n                              product?.title ||\r\n                              (locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨┤╤â╨║╤é\" : \"Product\")\r\n                            const href = `/product/${item.product_id}`\r\n                            const itemStatus = item.status || 'pending'\r\n\r\n                            return (\r\n                              <div\r\n                                key={item.id}\r\n                                className=\"flex gap-4 p-3 rounded-lg border bg-card\"\r\n                              >\r\n                                <Link href={href} className=\"shrink-0\">\r\n                                  <div className=\"relative size-20 overflow-hidden rounded-lg border bg-muted\">\r\n                                    <Image\r\n                                      src={image}\r\n                                      alt={title}\r\n                                      fill\r\n                                      sizes=\"80px\"\r\n                                      className=\"object-contain\"\r\n                                    />\r\n                                  </div>\r\n                                </Link>\r\n                                <div className=\"min-w-0 flex-1\">\r\n                                  <Link\r\n                                    href={href}\r\n                                    className=\"font-medium hover:underline line-clamp-2\"\r\n                                  >\r\n                                    {title}\r\n                                  </Link>\r\n                                  {/* Item Status */}\r\n                                  <div className=\"flex items-center gap-2 mt-1.5\">\r\n                                    <OrderStatusBadge status={itemStatus as OrderItemStatus} size=\"sm\" />\r\n                                  </div>\r\n                                  <p className=\"text-sm text-muted-foreground mt-1\">\r\n                                    {t.qty}: {item.quantity}\r\n                                  </p>\r\n                                  {item.price_at_purchase && (\r\n                                    <p className=\"text-sm font-semibold mt-2 tabular-nums\">\r\n                                      {formatCurrency(item.price_at_purchase)}\r\n                                    </p>\r\n                                  )}\r\n                                  {/* Tracking info */}\r\n                                  {item.tracking_number && (\r\n                                    <div className=\"text-sm text-muted-foreground mt-2 flex items-center gap-1\">\r\n                                      <span>≡ƒôì</span>\r\n                                      <span className=\"font-mono\">{item.tracking_number}</span>\r\n                                      {item.shipping_carrier && <span>({item.shipping_carrier})</span>}\r\n                                    </div>\r\n                                  )}\r\n                                  {/* Actions */}\r\n                                  <div className=\"flex items-center gap-3 mt-3\">\r\n                                    <Link\r\n                                      href={href}\r\n                                      className=\"inline-flex items-center text-sm text-primary hover:underline\"\r\n                                    >\r\n                                      {t.viewProduct}\r\n                                      <IconChevronRight className=\"size-3 ml-0.5\" />\r\n                                    </Link>\r\n                                    {/* Show chat only if NOT showing buyer actions */}\r\n                                    {item.seller_id && itemStatus !== 'shipped' && itemStatus !== 'delivered' && conversationMap.get(order.id) && (\r\n                                      <Link\r\n                                        href={`/chat/${conversationMap.get(order.id)}`}\r\n                                        className=\"inline-flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground\"\r\n                                      >\r\n                                        <IconMessageCircle className=\"size-4\" />\r\n                                        {locale === \"bg\" ? \"╨º╨░╤é\" : \"Chat\"}\r\n                                      </Link>\r\n                                    )}\r\n                                  </div>\r\n                                  {/* Buyer Actions: Confirm Delivery & Rate Seller */}\r\n                                  {item.seller_id && (itemStatus === 'shipped' || itemStatus === 'delivered') && (\r\n                                    <div className=\"mt-3 pt-3 border-t\">\r\n                                      <BuyerOrderActions\r\n                                        orderItemId={item.id}\r\n                                        currentStatus={itemStatus as OrderItemStatus}\r\n                                        sellerId={item.seller_id}\r\n                                        conversationId={conversationMap.get(order.id) ?? null}\r\n                                        locale={locale}\r\n                                        orderId={order.id}\r\n                                        actions={actions}\r\n                                      />\r\n                                    </div>\r\n                                  )}\r\n                                </div>\r\n                              </div>\r\n                            )\r\n                          })}\r\n                        </div>\r\n                      </div>\r\n                    </ScrollArea>\r\n                  </SheetContent>\r\n                </Sheet>\r\n              )\r\n            })}\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\orders\\_components\\account-orders-stats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\orders\\_components\\account-orders-toolbar.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'applyUrl' and 'status'. Either include them or remove the dependency array.","line":89,"column":6,"nodeType":"ArrayExpression","endLine":89,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [applyUrl, query, status]","fix":{"range":[2746,2753],"text":"[applyUrl, query, status]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\orders\\_components\\buyer-order-actions.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 35 to the 25 allowed.","line":70,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":70,"endColumn":34},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'checkRatingStatus'. Either include it or remove the dependency array.","line":111,"column":6,"nodeType":"ArrayExpression","endLine":111,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [checkRatingStatus, isDelivered, orderItemId]","fix":{"range":[3550,3576],"text":"[checkRatingStatus, isDelivered, orderItemId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useTransition } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\"\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Loader2, Package, CheckCircle, MessageSquare, XCircle, AlertTriangle, Star } from \"lucide-react\"\r\nimport { type OrderItemStatus } from \"@/lib/order-status\"\r\nimport { toast } from \"sonner\"\r\nimport { Link, useRouter } from \"@/i18n/routing\"\r\nimport { StarRatingDialog } from \"@/components/shared/star-rating-dialog\"       \r\n\r\nexport type IssueType =\r\n  | 'not_received'\r\n  | 'wrong_item'\r\n  | 'damaged'\r\n  | 'not_as_described'\r\n  | 'missing_parts'\r\n  | 'other'\r\n\r\nexport type BuyerOrderActionsServerActions = {\r\n  buyerConfirmDelivery: (orderItemId: string) => Promise<{ success: boolean; error?: string }>\r\n  canBuyerRateSeller: (orderItemId: string) => Promise<{ canRate: boolean; hasRated: boolean }>\r\n  requestOrderCancellation: (\r\n    orderItemId: string,\r\n    reason?: string\r\n  ) => Promise<{ success: boolean; error?: string }>\r\n  reportOrderIssue: (\r\n    orderItemId: string,\r\n    issueType: IssueType,\r\n    description: string\r\n  ) => Promise<{ success: boolean; error?: string; conversationId?: string }>\r\n  submitSellerFeedback: (input: {\r\n    sellerId: string\r\n    orderId: string\r\n    rating: number\r\n    comment?: string\r\n    itemAsDescribed: boolean\r\n    shippingSpeed: boolean\r\n    communication: boolean\r\n  }) => Promise<{ success: boolean; error?: string }>\r\n}\r\n\r\ninterface BuyerOrderActionsProps {\r\n  orderItemId: string\r\n  currentStatus: OrderItemStatus\r\n  sellerId: string\r\n  conversationId?: string | null\r\n  locale?: string\r\n  orderId: string\r\n  actions: BuyerOrderActionsServerActions\r\n  mode?: \"full\" | \"report-only\"\r\n}\r\n\r\nexport function BuyerOrderActions({\r\n  orderItemId,\r\n  currentStatus,\r\n  sellerId,\r\n  conversationId,\r\n  locale = 'en',\r\n  orderId,\r\n  actions,\r\n  mode = \"full\",\r\n}: BuyerOrderActionsProps) {\r\n  const router = useRouter()\r\n  const isReportOnly = mode === \"report-only\"\r\n  const [isSubmitting, startTransition] = useTransition()\r\n  const [showRatingDialog, setShowRatingDialog] = useState(false)\r\n  const [showCancelDialog, setShowCancelDialog] = useState(false)\r\n  const [showIssueDialog, setShowIssueDialog] = useState(false)\r\n  const [cancelReason, setCancelReason] = useState(\"\")\r\n  const [issueType, setIssueType] = useState<IssueType | \"\">(\"\")\r\n  const [issueDescription, setIssueDescription] = useState(\"\")\r\n  const [canRate, setCanRate] = useState(false)\r\n  const [hasRated, setHasRated] = useState(false)\r\n\r\n  const isShipped = currentStatus === 'shipped'\r\n  const isDelivered = currentStatus === 'delivered'\r\n  const isPending = currentStatus === 'pending'\r\n  const isProcessing = currentStatus === 'processing'\r\n  const isReceived = currentStatus === 'received'\r\n  const canCancel = isPending || isProcessing || isReceived\r\n\r\n  // Check if can rate when delivered\r\n  async function checkRatingStatus() {\r\n    if (isDelivered && !isReportOnly) {\r\n      const result = await actions.canBuyerRateSeller(orderItemId)\r\n      setCanRate(result.canRate)\r\n      setHasRated(result.hasRated)\r\n    }\r\n  }\r\n\r\n  // Run check on mount for delivered orders\r\n  useEffect(() => {\r\n    checkRatingStatus()\r\n  }, [isDelivered, orderItemId])\r\n\r\n  async function handleConfirmDelivery() {\r\n    startTransition(async () => {\r\n      try {\r\n        const result = await actions.buyerConfirmDelivery(orderItemId)\r\n        if (result.success) {\r\n          toast.success(locale === 'bg' ? '╨ö╨╛╤ü╤é╨░╨▓╨║╨░╤é╨░ ╨╡ ╨┐╨╛╤é╨▓╤è╤Ç╨┤╨╡╨╜╨░!' : 'Delivery confirmed!')\r\n          router.refresh()\r\n          // Ask to rate the seller\r\n          setTimeout(() => {\r\n            setShowRatingDialog(true)\r\n          }, 500)\r\n        } else {\r\n          toast.error(result.error || 'Failed to confirm delivery')\r\n        }\r\n      } catch {\r\n        toast.error('An error occurred')\r\n      }\r\n    })\r\n  }\r\n\r\n  async function handleSubmitRating(rating: number, comment: string) {\r\n    startTransition(async () => {\r\n      try {\r\n        const result = await actions.submitSellerFeedback({\r\n          sellerId,\r\n          orderId,\r\n          rating,\r\n          ...(comment ? { comment } : {}),\r\n          itemAsDescribed: true,\r\n          shippingSpeed: true,\r\n          communication: true,\r\n        })\r\n        \r\n        if (result.success) {\r\n          toast.success(locale === 'bg' ? '╨æ╨╗╨░╨│╨╛╨┤╨░╤Ç╨╕╨╝ ╨╖╨░ ╨╛╤é╨╖╨╕╨▓╨░!' : 'Thank you for your feedback!')\r\n          setShowRatingDialog(false)\r\n          setHasRated(true)\r\n          router.refresh()\r\n        } else {\r\n          toast.error(result.error || 'Failed to submit rating')\r\n        }\r\n      } catch {\r\n        toast.error('An error occurred')\r\n      }\r\n    })\r\n  }\r\n\r\n  async function handleCancelOrder() {\r\n    startTransition(async () => {\r\n      try {\r\n        const result = await actions.requestOrderCancellation(orderItemId, cancelReason || undefined)\r\n        if (result.success) {\r\n          toast.success(locale === 'bg' ? '╨ƒ╨╛╤Ç╤è╤ç╨║╨░╤é╨░ ╨╡ ╨╛╤é╨╝╨╡╨╜╨╡╨╜╨░!' : 'Order cancelled!')\r\n          setShowCancelDialog(false)\r\n          setCancelReason(\"\")\r\n          router.refresh()\r\n        } else {\r\n          toast.error(result.error || 'Failed to cancel order')\r\n        }\r\n      } catch {\r\n        toast.error('An error occurred')\r\n      }\r\n    })\r\n  }\r\n\r\n  async function handleReportIssue() {\r\n    if (!issueType) {\r\n      toast.error(locale === 'bg' ? '╨£╨╛╨╗╤Å, ╨╕╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╤é╨╕╨┐ ╨┐╤Ç╨╛╨▒╨╗╨╡╨╝' : 'Please select an issue type')\r\n      return\r\n    }\r\n    if (issueDescription.length < 10) {\r\n      toast.error(locale === 'bg' ? '╨₧╨┐╨╕╤ü╨░╨╜╨╕╨╡╤é╨╛ ╤é╤Ç╤Å╨▒╨▓╨░ ╨┤╨░ ╨╡ ╨┐╨╛╨╜╨╡ 10 ╤ü╨╕╨╝╨▓╨╛╨╗╨░' : 'Description must be at least 10 characters')\r\n      return\r\n    }\r\n\r\n    startTransition(async () => {\r\n      try {\r\n        const result = await actions.reportOrderIssue(orderItemId, issueType as IssueType, issueDescription)\r\n        if (result.success) {\r\n          toast.success(locale === 'bg' ? '╨ƒ╤Ç╨╛╨▒╨╗╨╡╨╝╤è╤é ╨╡ ╨┤╨╛╨║╨╗╨░╨┤╨▓╨░╨╜!' : 'Issue reported!')\r\n          setShowIssueDialog(false)\r\n          setIssueType(\"\")\r\n          setIssueDescription(\"\")\r\n          // Navigate to conversation if available\r\n          if (result.conversationId) {\r\n            router.push(`/chat/${result.conversationId}`)\r\n          } else {\r\n            router.refresh()\r\n          }\r\n        } else {\r\n          toast.error(result.error || 'Failed to report issue')\r\n        }\r\n      } catch {\r\n        toast.error('An error occurred')\r\n      }\r\n    })\r\n  }\r\n\r\n  const t = {\r\n    confirmDelivery: locale === 'bg' ? '╨ƒ╨╛╤é╨▓╤è╤Ç╨┤╨╕ ╨┐╨╛╨╗╤â╤ç╨░╨▓╨░╨╜╨╡' : 'Confirm Delivery',\r\n    rateSeller: locale === 'bg' ? '╨₧╤å╨╡╨╜╨╕ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨░' : 'Rate Seller',\r\n    ratedSeller: locale === 'bg' ? '╨₧╤å╨╡╨╜╨╡╨╜╨╛' : 'Rated',\r\n    chat: locale === 'bg' ? '╨º╨░╤é' : 'Chat',\r\n    cancelOrder: locale === 'bg' ? '╨₧╤é╨╝╨╡╨╜╨╕ ╨┐╨╛╤Ç╤è╤ç╨║╨░' : 'Cancel Order',\r\n    reportIssue: locale === 'bg' ? '╨ö╨╛╨║╨╗╨░╨┤╨▓╨░╨╣ ╨┐╤Ç╨╛╨▒╨╗╨╡╨╝' : 'Report Issue',\r\n    ratingTitle: locale === 'bg' ? '╨Ü╨░╨║ ╨▒╨╕╤à╤é╨╡ ╨╛╤å╨╡╨╜╨╕╨╗╨╕ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨░?' : 'How would you rate the seller?',\r\n    ratingDescription: locale === 'bg' \r\n      ? '╨Æ╨░╤ê╨░╤é╨░ ╨╛╤å╨╡╨╜╨║╨░ ╨┐╨╛╨╝╨░╨│╨░ ╨╜╨░ ╨┤╤Ç╤â╨│╨╕ ╨║╤â╨┐╤â╨▓╨░╤ç╨╕ ╨┤╨░ ╨╜╨░╨┐╤Ç╨░╨▓╤Å╤é ╨╕╨╜╤ä╨╛╤Ç╨╝╨╕╤Ç╨░╨╜ ╨╕╨╖╨▒╨╛╤Ç.'\r\n      : 'Your rating helps other buyers make informed decisions.',\r\n    commentLabel: locale === 'bg' ? '╨Ü╨╛╨╝╨╡╨╜╤é╨░╤Ç (╨┐╨╛ ╨╕╨╖╨▒╨╛╤Ç)' : 'Comment (optional)',\r\n    commentPlaceholder: locale === 'bg' \r\n      ? '╨í╨┐╨╛╨┤╨╡╨╗╨╡╤é╨╡ ╨╛╨┐╨╕╤é╨░ ╤ü╨╕ ╤ü ╤é╨╛╨╖╨╕ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç...'\r\n      : 'Share your experience with this seller...',\r\n    submitRating: locale === 'bg' ? '╨ÿ╨╖╨┐╤Ç╨░╤é╨╕ ╨╛╤é╨╖╨╕╨▓' : 'Submit Review',\r\n    cancel: locale === 'bg' ? '╨₧╤é╨╝╨╡╨╜╨╕' : 'Cancel',\r\n    cancelTitle: locale === 'bg' ? '╨₧╤é╨╝╨╡╨╜╨╕ ╨┐╨╛╤Ç╤è╤ç╨║╨░' : 'Cancel Order',\r\n    cancelDescription: locale === 'bg' \r\n      ? '╨í╨╕╨│╤â╤Ç╨╜╨╕ ╨╗╨╕ ╤ü╤é╨╡, ╤ç╨╡ ╨╕╤ü╨║╨░╤é╨╡ ╨┤╨░ ╨╛╤é╨╝╨╡╨╜╨╕╤é╨╡ ╤é╨░╨╖╨╕ ╨┐╨╛╤Ç╤è╤ç╨║╨░? ╨ó╨╛╨▓╨░ ╨┤╨╡╨╣╤ü╤é╨▓╨╕╨╡ ╨╜╨╡ ╨╝╨╛╨╢╨╡ ╨┤╨░ ╨▒╤è╨┤╨╡ ╨╛╤é╨╝╨╡╨╜╨╡╨╜╨╛.'\r\n      : 'Are you sure you want to cancel this order? This action cannot be undone.',\r\n    cancelReasonLabel: locale === 'bg' ? '╨ƒ╤Ç╨╕╤ç╨╕╨╜╨░ ╨╖╨░ ╨╛╤é╨╝╤Å╨╜╨░ (╨┐╨╛ ╨╕╨╖╨▒╨╛╤Ç)' : 'Reason for cancellation (optional)',\r\n    cancelReasonPlaceholder: locale === 'bg' ? '╨₧╨┐╨╕╤ê╨╡╤é╨╡ ╨╖╨░╤ë╨╛ ╨╛╤é╨╝╨╡╨╜╤Å╤é╨╡...' : 'Describe why you are cancelling...',\r\n    confirmCancel: locale === 'bg' ? '╨ƒ╨╛╤é╨▓╤è╤Ç╨┤╨╕ ╨╛╤é╨╝╤Å╨╜╨░' : 'Confirm Cancellation',\r\n    issueTitle: locale === 'bg' ? '╨ö╨╛╨║╨╗╨░╨┤╨▓╨░╨╣ ╨┐╤Ç╨╛╨▒╨╗╨╡╨╝' : 'Report an Issue',\r\n    issueDescription: locale === 'bg' \r\n      ? '╨₧╨┐╨╕╤ê╨╡╤é╨╡ ╨┐╤Ç╨╛╨▒╨╗╨╡╨╝╨░ ╤ü ╨┐╨╛╤Ç╤è╤ç╨║╨░╤é╨░ ╤ü╨╕ ╨╕ ╨╜╨╕╨╡ ╤ë╨╡ ╨┐╨╛╨╝╨╛╨│╨╜╨╡╨╝.'\r\n      : 'Describe the issue with your order and we will help.',\r\n    issueTypeLabel: locale === 'bg' ? '╨ó╨╕╨┐ ╨┐╤Ç╨╛╨▒╨╗╨╡╨╝' : 'Issue Type',\r\n    issueTypePlaceholder: locale === 'bg' ? '╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╤é╨╕╨┐ ╨┐╤Ç╨╛╨▒╨╗╨╡╨╝' : 'Select issue type',\r\n    issueDescLabel: locale === 'bg' ? '╨₧╨┐╨╕╤ü╨░╨╜╨╕╨╡' : 'Description',\r\n    issueDescPlaceholder: locale === 'bg' \r\n      ? '╨₧╨┐╨╕╤ê╨╡╤é╨╡ ╨┐╤Ç╨╛╨▒╨╗╨╡╨╝╨░ ╨┐╨╛╨┤╤Ç╨╛╨▒╨╜╨╛ (╨╝╨╕╨╜╨╕╨╝╤â╨╝ 10 ╤ü╨╕╨╝╨▓╨╛╨╗╨░)...'\r\n      : 'Describe the issue in detail (minimum 10 characters)...',\r\n    submitIssue: locale === 'bg' ? '╨ÿ╨╖╨┐╤Ç╨░╤é╨╕ ╨┤╨╛╨║╨╗╨░╨┤' : 'Submit Report',\r\n    issueTypes: {\r\n      not_received: locale === 'bg' ? '╨¥╨╡ ╨╡ ╨┐╨╛╨╗╤â╤ç╨╡╨╜╨╛' : 'Item Not Received',\r\n      wrong_item: locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨╡╨╜ ╨░╤Ç╤é╨╕╨║╤â╨╗' : 'Wrong Item Received',\r\n      damaged: locale === 'bg' ? '╨ƒ╨╛╨▓╤Ç╨╡╨┤╨╡╨╜ ╨░╤Ç╤é╨╕╨║╤â╨╗' : 'Item Damaged',\r\n      not_as_described: locale === 'bg' ? '╨¥╨╡ ╨╛╤é╨│╨╛╨▓╨░╤Ç╤Å ╨╜╨░ ╨╛╨┐╨╕╤ü╨░╨╜╨╕╨╡╤é╨╛' : 'Not As Described',\r\n      missing_parts: locale === 'bg' ? '╨¢╨╕╨┐╤ü╨▓╨░╤ë╨╕ ╤ç╨░╤ü╤é╨╕' : 'Missing Parts',\r\n      other: locale === 'bg' ? '╨ö╤Ç╤â╨│╨╛' : 'Other',\r\n    } as Record<IssueType, string>,\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-wrap items-center gap-2\">\r\n      {/* Chat Link */}\r\n      {conversationId && (\r\n        <Button variant=\"outline\" size=\"sm\" asChild>\r\n          <Link href={`/chat/${conversationId}`}>\r\n            <MessageSquare className=\"h-4 w-4 mr-1.5\" />\r\n            {t.chat}\r\n          </Link>\r\n        </Button>\r\n      )}\r\n\r\n      {/* Cancel Order Button - only for pending/processing orders */}\r\n      {!isReportOnly && canCancel && (\r\n        <Button\r\n          size=\"sm\"\r\n          variant=\"outline\"\r\n          onClick={() => setShowCancelDialog(true)}\r\n          disabled={isSubmitting}\r\n          className=\"text-status-error hover:bg-status-error/10\"\r\n        >\r\n          <XCircle className=\"h-4 w-4 mr-1.5\" />\r\n          {t.cancelOrder}\r\n        </Button>\r\n      )}\r\n\r\n      {/* Report Issue Button - for shipped or delivered orders */}\r\n      {(isShipped || isDelivered) && (\r\n        <Button\r\n          size=\"sm\"\r\n          variant=\"outline\"\r\n          onClick={() => setShowIssueDialog(true)}\r\n          disabled={isSubmitting}\r\n          className=\"text-status-warning hover:bg-status-warning/10\"\r\n        >\r\n          <AlertTriangle className=\"h-4 w-4 mr-1.5\" />\r\n          {t.reportIssue}\r\n        </Button>\r\n      )}\r\n\r\n      {/* Confirm Delivery Button - only for shipped orders */}\r\n      {!isReportOnly && isShipped && (\r\n        <Button\r\n          size=\"sm\"\r\n          onClick={handleConfirmDelivery}\r\n          disabled={isSubmitting}\r\n          className=\"bg-status-success text-badge-fg-on-solid hover:brightness-95\"\r\n        >\r\n          {isSubmitting ? (\r\n            <Loader2 className=\"h-4 w-4 mr-1.5 animate-spin\" />\r\n          ) : (\r\n            <Package className=\"h-4 w-4 mr-1.5\" />\r\n          )}\r\n          {isSubmitting ? '...' : t.confirmDelivery}\r\n        </Button>\r\n      )}\r\n\r\n      {/* Rate Seller Button - only for delivered orders that haven't been rated */}\r\n      {!isReportOnly && isDelivered && canRate && !hasRated && (\r\n        <Button\r\n          size=\"sm\"\r\n          variant=\"outline\"\r\n          onClick={() => setShowRatingDialog(true)}\r\n          disabled={isSubmitting}\r\n        >\r\n          <Star className=\"h-4 w-4 mr-1.5\" />\r\n          {t.rateSeller}\r\n        </Button>\r\n      )}\r\n\r\n      {/* Already Rated Badge */}\r\n      {!isReportOnly && isDelivered && hasRated && (\r\n        <span className=\"inline-flex items-center gap-1 text-sm text-status-success\">\r\n          <CheckCircle className=\"h-4 w-4\" />\r\n          {t.ratedSeller}\r\n        </span>\r\n      )}\r\n\r\n      {/* Cancel Order Dialog */}\r\n      {!isReportOnly && (\r\n        <Dialog open={showCancelDialog} onOpenChange={setShowCancelDialog}>\r\n          <DialogContent className=\"sm:max-w-md\">\r\n            <DialogHeader>\r\n              <DialogTitle className=\"flex items-center gap-2 text-status-error\">\r\n                <XCircle className=\"h-5 w-5\" />\r\n                {t.cancelTitle}\r\n              </DialogTitle>\r\n              <DialogDescription>{t.cancelDescription}</DialogDescription>\r\n            </DialogHeader>\r\n            \r\n            <div className=\"space-y-4 py-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"cancelReason\">{t.cancelReasonLabel}</Label>\r\n                <Textarea\r\n                  id=\"cancelReason\"\r\n                  placeholder={t.cancelReasonPlaceholder}\r\n                  value={cancelReason}\r\n                  onChange={(e) => setCancelReason(e.target.value)}\r\n                  rows={3}\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <DialogFooter>\r\n              <Button \r\n                variant=\"outline\" \r\n                onClick={() => setShowCancelDialog(false)}\r\n                disabled={isSubmitting}\r\n              >\r\n                {t.cancel}\r\n              </Button>\r\n              <Button \r\n                variant=\"destructive\"\r\n                onClick={handleCancelOrder} \r\n                disabled={isSubmitting}\r\n              >\r\n                {isSubmitting ? (\r\n                  <>\r\n                    <Loader2 className=\"h-4 w-4 mr-1.5 animate-spin\" />\r\n                    ...\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <XCircle className=\"h-4 w-4 mr-1.5\" />\r\n                    {t.confirmCancel}\r\n                  </>\r\n                )}\r\n              </Button>\r\n            </DialogFooter>\r\n          </DialogContent>\r\n        </Dialog>\r\n      )}\r\n\r\n      {/* Report Issue Dialog */}\r\n      <Dialog open={showIssueDialog} onOpenChange={setShowIssueDialog}>\r\n        <DialogContent className=\"sm:max-w-md\">\r\n          <DialogHeader>\r\n            <DialogTitle className=\"flex items-center gap-2 text-status-warning\">\r\n              <AlertTriangle className=\"h-5 w-5\" />\r\n              {t.issueTitle}\r\n            </DialogTitle>\r\n            <DialogDescription>{t.issueDescription}</DialogDescription>\r\n          </DialogHeader>\r\n          \r\n          <div className=\"space-y-4 py-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"issueType\">{t.issueTypeLabel}</Label>\r\n              <Select value={issueType} onValueChange={(val) => setIssueType(val as IssueType)}>\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder={t.issueTypePlaceholder} />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {(Object.keys(t.issueTypes) as IssueType[]).map((type) => (\r\n                    <SelectItem key={type} value={type}>\r\n                      {t.issueTypes[type]}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"issueDesc\">{t.issueDescLabel}</Label>\r\n              <Textarea\r\n                id=\"issueDesc\"\r\n                placeholder={t.issueDescPlaceholder}\r\n                value={issueDescription}\r\n                onChange={(e) => setIssueDescription(e.target.value)}\r\n                rows={4}\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <DialogFooter>\r\n            <Button \r\n              variant=\"outline\" \r\n              onClick={() => setShowIssueDialog(false)}\r\n              disabled={isSubmitting}\r\n            >\r\n              {t.cancel}\r\n            </Button>\r\n            <Button \r\n              onClick={handleReportIssue} \r\n              disabled={isSubmitting || !issueType || issueDescription.length < 10}\r\n              className=\"bg-status-warning text-badge-fg-on-solid hover:brightness-95\"\r\n            >\r\n              {isSubmitting ? (\r\n                <>\r\n                  <Loader2 className=\"h-4 w-4 mr-1.5 animate-spin\" />\r\n                  ...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <AlertTriangle className=\"h-4 w-4 mr-1.5\" />\r\n                  {t.submitIssue}\r\n                </>\r\n              )}\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Rating Dialog */}\r\n      {!isReportOnly && (\r\n        <StarRatingDialog\r\n          open={showRatingDialog}\r\n          onOpenChange={setShowRatingDialog}\r\n          onSubmit={handleSubmitRating}\r\n          title={t.ratingTitle}\r\n          description={t.ratingDescription}\r\n          commentLabel={t.commentLabel}\r\n          commentPlaceholder={t.commentPlaceholder}\r\n          submitLabel={t.submitRating}\r\n          cancelLabel={t.cancel}\r\n          locale={locale}\r\n          isLoading={isSubmitting}\r\n        />\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\orders\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\orders\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/orders' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":4,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":10,"endColumn":30},{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/seller-feedback' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":11,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":11,"endColumn":69},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'normalize' to the outer scope.","line":146,"column":37,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":146,"endColumn":39},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'isOpenStatus' to the outer scope.","line":158,"column":53,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":158,"endColumn":55}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Suspense } from \"react\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { redirect } from \"@/i18n/routing\"\r\nimport {\r\n  buyerConfirmDelivery,\r\n  canBuyerRateSeller,\r\n  getOrderConversation,\r\n  reportOrderIssue,\r\n  requestOrderCancellation,\r\n} from \"@/app/actions/orders\"\r\nimport { submitSellerFeedback } from \"@/app/actions/seller-feedback\"\r\nimport { AccountOrdersToolbar } from \"./_components/account-orders-toolbar\"\r\nimport { AccountOrdersStats } from \"./_components/account-orders-stats\"\r\nimport { AccountOrdersGrid } from \"./_components/account-orders-grid\"\r\nimport { Skeleton } from \"@/components/ui/skeleton\"\r\n\r\n// Loading skeletons for Suspense boundaries\r\nfunction StatsCardsSkeleton() {\r\n  return (\r\n    <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-4\">\r\n      {[...Array(4)].map((_, i) => (\r\n        <div key={i} className=\"rounded-lg border border-border p-4 space-y-2\">\r\n          <Skeleton className=\"h-4 w-20\" />\r\n          <Skeleton className=\"h-8 w-16\" />\r\n        </div>\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction OrdersGridSkeleton() {\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {[...Array(3)].map((_, i) => (\r\n        <div key={i} className=\"rounded-lg border border-border p-4 space-y-3\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <Skeleton className=\"h-5 w-32\" />\r\n            <Skeleton className=\"h-6 w-20 rounded-full\" />\r\n          </div>\r\n          <div className=\"flex gap-4\">\r\n            <Skeleton className=\"h-16 w-16 rounded\" />\r\n            <div className=\"flex-1 space-y-2\">\r\n              <Skeleton className=\"h-4 w-3/4\" />\r\n              <Skeleton className=\"h-4 w-1/2\" />\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n\r\ntype OrderStatus =\r\n  | \"pending\"\r\n  | \"processing\"\r\n  | \"paid\"\r\n  | \"shipped\"\r\n  | \"delivered\"\r\n  | \"cancelled\"\r\n  | string\r\n\r\ntype OrderProduct = {\r\n  id: string\r\n  title: string | null\r\n  images: string[] | null\r\n  price?: number | null\r\n}\r\n\r\ntype OrderItemRow = {\r\n  id: string\r\n  product_id: string\r\n  quantity: number\r\n  price_at_purchase?: number\r\n  product?: OrderProduct | null\r\n}\r\n\r\ntype OrderRow = {\r\n  id: string\r\n  created_at: string\r\n  status: OrderStatus | null\r\n  fulfillment_status?: OrderStatus | null\r\n  total_amount: number | string | null\r\n  order_items: OrderItemRow[]\r\n}\r\n\r\ninterface OrdersPageProps {\r\n  params: Promise<{ locale: string }>\r\n  searchParams?: Promise<{ q?: string; status?: string }>\r\n}\r\n\r\nexport default async function OrdersPage({ params, searchParams }: OrdersPageProps) {\r\n  const { locale: localeParam } = await params\r\n  const locale = localeParam === \"bg\" ? \"bg\" : \"en\"\r\n  const sp = (await searchParams) || {}\r\n  const query = (sp.q || \"\").trim()\r\n  const statusFilter = (sp.status || \"all\").trim()\r\n  const supabase = await createClient()\r\n\r\n  if (!supabase) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  const {\r\n    data: { user },\r\n  } = await supabase.auth.getUser()\r\n\r\n  if (!user) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  // Fetch orders from Supabase with full details\r\n  const { data: ordersRaw } = await supabase\r\n    .from(\"orders\")\r\n    .select(`\r\n        id,\r\n        created_at,\r\n        status,\r\n        fulfillment_status,\r\n        total_amount,\r\n        order_items (\r\n          id,\r\n          product_id,\r\n          seller_id,\r\n          quantity,\r\n          price_at_purchase,\r\n          status,\r\n          tracking_number,\r\n          shipping_carrier,\r\n          shipped_at,\r\n          product:products(\r\n            id,\r\n            title,\r\n            images,\r\n            price\r\n          )\r\n        )\r\n    `)\r\n    .eq(\"user_id\", user.id)\r\n    .order(\"created_at\", { ascending: false })\r\n\r\n  const allOrders = ((ordersRaw || []) as unknown as OrderRow[]).map((order) => ({\r\n    ...order,\r\n    order_items: Array.isArray(order.order_items) ? order.order_items : [],\r\n  }))\r\n\r\n  const normalize = (value: string) => value.toLowerCase()\r\n\r\n  const matchesQuery = (order: OrderRow) => {\r\n    if (!query) return true\r\n    const q = normalize(query)\r\n    if (normalize(order.id).includes(q)) return true\r\n    return order.order_items.some((item) => {\r\n      const title = item.product?.title || \"\"\r\n      return normalize(title).includes(q)\r\n    })\r\n  }\r\n\r\n  const isOpenStatus = (status: OrderStatus | null) =>\r\n    status === \"pending\" || status === \"processing\" || status === \"shipped\" || status === \"paid\"\r\n\r\n  const matchesStatus = (order: OrderRow) => {\r\n    const s = (order.status || \"pending\") as OrderStatus\r\n    switch (statusFilter) {\r\n      case \"open\":\r\n        return isOpenStatus(s)\r\n      case \"delivered\":\r\n        return s === \"delivered\"\r\n      case \"cancelled\":\r\n        return s === \"cancelled\"\r\n      case \"all\":\r\n      default:\r\n        return true\r\n    }\r\n  }\r\n\r\n  const filteredOrders = allOrders.filter((o) => matchesStatus(o) && matchesQuery(o))\r\n\r\n  // Calculate stats\r\n  const stats = {\r\n    total: allOrders.length,\r\n    pending: allOrders.filter((o) => isOpenStatus((o.status || \"pending\") as OrderStatus)).length,\r\n    delivered: allOrders.filter((o) => o.status === \"delivered\").length,\r\n    cancelled: allOrders.filter((o) => o.status === \"cancelled\").length,\r\n    totalSpend: allOrders.reduce((sum, o) => sum + Number(o.total_amount || 0), 0),\r\n  }\r\n\r\n  const counts = {\r\n    all: allOrders.length,\r\n    open: stats.pending,\r\n    delivered: stats.delivered,\r\n    cancelled: stats.cancelled,\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 md:gap-4\">\r\n      <h1 className=\"sr-only\">{locale === \"bg\" ? \"╨ƒ╨╛╤Ç╤è╤ç╨║╨╕\" : \"Orders\"}</h1>\r\n\r\n      {/* Stats Cards - Wrapped in Suspense for streaming */}\r\n      <Suspense fallback={<StatsCardsSkeleton />}>\r\n        <AccountOrdersStats stats={stats} locale={locale} />\r\n      </Suspense>\r\n\r\n      {/* Toolbar with Tabs and Search */}\r\n      <AccountOrdersToolbar\r\n        locale={locale}\r\n        initialQuery={query}\r\n        initialStatus={statusFilter}\r\n        counts={counts}\r\n      />\r\n\r\n      {/* Orders Grid - Wrapped in Suspense for streaming */}\r\n      <Suspense fallback={<OrdersGridSkeleton />}>\r\n        <AccountOrdersGrid\r\n          orders={filteredOrders}\r\n          locale={locale}\r\n          actions={{\r\n            getOrderConversation,\r\n            buyerConfirmDelivery,\r\n            canBuyerRateSeller,\r\n            requestOrderCancellation,\r\n            reportOrderIssue,\r\n            submitSellerFeedback,\r\n          }}\r\n        />\r\n      </Suspense>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\payments\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\payments\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/payments' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":5,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":9,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/lib/supabase/server\"\r\nimport { redirect } from \"@/i18n/routing\"\r\nimport { getTranslations, setRequestLocale } from \"next-intl/server\"\r\nimport { PaymentsContent } from \"./payments-content\"\r\nimport {\r\n    createPaymentMethodSetupSession,\r\n    deletePaymentMethod,\r\n    setDefaultPaymentMethod,\r\n} from \"@/app/actions/payments\"\r\n\r\nconst PAYMENT_METHODS_SELECT =\r\n    'id,stripe_payment_method_id,card_brand,card_last4,card_exp_month,card_exp_year,is_default'\r\n\r\nexport default async function PaymentsPage({\r\n    params,\r\n}: {\r\n    params: Promise<{ locale: string }>\r\n}) {\r\n    const { locale } = await params\r\n    setRequestLocale(locale)\r\n    const t = await getTranslations({ locale, namespace: \"Account\" })\r\n    const supabase = await createClient()\r\n    \r\n    if (!supabase) {\r\n        return redirect({ href: \"/auth/login\", locale })\r\n    }\r\n    \r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    \r\n    if (!user) {\r\n        return redirect({ href: \"/auth/login\", locale })\r\n    }\r\n\r\n    // Fetch user payment methods\r\n    const { data: paymentMethodsData } = await supabase\r\n        .from('user_payment_methods')\r\n        .select(PAYMENT_METHODS_SELECT)\r\n        .eq('user_id', user.id)\r\n        .order('is_default', { ascending: false })\r\n        .order('created_at', { ascending: false })\r\n\r\n    // Transform to handle is_default: boolean | null -> boolean\r\n    const paymentMethods = (paymentMethodsData || []).map((pm) => ({\r\n        ...pm,\r\n        is_default: pm.is_default ?? false,\r\n    }))\r\n\r\n    return (\r\n        <div className=\"flex flex-col gap-4 md:gap-4\">\r\n            <h1 className=\"sr-only\">{t(\"header.payments\")}</h1>\r\n            <PaymentsContent\r\n                locale={locale}\r\n                initialPaymentMethods={paymentMethods}\r\n                actions={{\r\n                    createPaymentMethodSetupSession,\r\n                    deletePaymentMethod,\r\n                    setDefaultPaymentMethod,\r\n                }}\r\n            />\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\payments\\payments-content.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getCardBrandDisplay' to the outer scope.","line":176,"column":56,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":176,"endColumn":58},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getCardStyle' to the outer scope.","line":181,"column":105,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":181,"endColumn":107}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { useRouter } from \"@/i18n/routing\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n    AlertDialog,\r\n    AlertDialogAction,\r\n    AlertDialogCancel,\r\n    AlertDialogContent,\r\n    AlertDialogDescription,\r\n    AlertDialogFooter,\r\n    AlertDialogHeader,\r\n    AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\"\r\nimport { \r\n    Plus, \r\n    CreditCard, \r\n    Trash, \r\n    Star,\r\n    SpinnerGap,\r\n    Shield,\r\n    Lock\r\n} from \"@phosphor-icons/react\"\r\nimport { toast } from \"sonner\"\r\n\r\nexport type PaymentsContentServerActions = {\n    createPaymentMethodSetupSession: (input?: { locale?: \"en\" | \"bg\" }) => Promise<{\n        success: boolean\n        url?: string | null | undefined\n        error?: string\n    }>\n    deletePaymentMethod: (input: {\n        paymentMethodId: string\n        dbId: string\n    }) => Promise<{\n        success: boolean\n        error?: string\n    }>\n    setDefaultPaymentMethod: (input: {\n        paymentMethodId: string\n        dbId: string\n    }) => Promise<{\n        success: boolean\n        error?: string\n    }>\n}\n\r\ninterface PaymentMethod {\r\n    id: string\r\n    stripe_payment_method_id: string\r\n    card_brand: string | null\r\n    card_last4: string | null\r\n    card_exp_month: number | null\r\n    card_exp_year: number | null\r\n    is_default: boolean\r\n}\r\n\r\ninterface PaymentsContentProps {\r\n    locale: string\r\n    initialPaymentMethods: PaymentMethod[]\r\n    actions: PaymentsContentServerActions\r\n}\r\n\r\n// Brand icons/colors - using semantic tokens\r\nconst cardBrandStyles = {\r\n    visa: { bg: 'bg-primary', text: 'text-primary-foreground' },\r\n    mastercard: { bg: 'bg-primary', text: 'text-primary-foreground' },\r\n    amex: { bg: 'bg-primary', text: 'text-primary-foreground' },\r\n    discover: { bg: 'bg-primary', text: 'text-primary-foreground' },\r\n    default: { bg: 'bg-muted-foreground', text: 'text-background' }\r\n} as const\r\n\r\nexport function PaymentsContent({\r\n    locale,\r\n    initialPaymentMethods,\r\n    actions,\r\n}: PaymentsContentProps) {\r\n    const router = useRouter()\r\n    const [paymentMethods, setPaymentMethods] = useState<PaymentMethod[]>(initialPaymentMethods)\r\n    const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false)\r\n    const [deletingMethodId, setDeletingMethodId] = useState<string | null>(null)\r\n    const [isLoading, setIsLoading] = useState(false)\r\n    const [isAddingCard, setIsAddingCard] = useState(false)\r\n\r\n    const handleAddCard = async () => {\n        setIsAddingCard(true)\n        try {\n            const result = await actions.createPaymentMethodSetupSession({\n                locale: locale === \"bg\" ? \"bg\" : \"en\",\n            })\n\n            if (!result.success) {\n                throw new Error(result.error || \"Failed to create setup session\")\n            }\n\n            // Redirect to Stripe's hosted payment method collection page\n            if (result.url) {\n                window.location.href = result.url\n            } else {\n                throw new Error(\"Missing setup session URL\")\n            }\n        } catch (error) {\n            console.error('Error adding card:', error)\n            toast.error(locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨┤╨╛╨▒╨░╨▓╤Å╨╜╨╡ ╨╜╨░ ╨║╨░╤Ç╤é╨░' : 'Error adding card')\n        } finally {\r\n            setIsAddingCard(false)\r\n        }\r\n    }\r\n\r\n    const handleDelete = async () => {\r\n        if (!deletingMethodId) return\r\n\r\n        const method = paymentMethods.find(m => m.id === deletingMethodId)\r\n        if (!method) return\r\n\r\n        setIsLoading(true)\n        try {\n            const result = await actions.deletePaymentMethod({\n                paymentMethodId: method.stripe_payment_method_id,\n                dbId: method.id,\n            })\n\n            if (!result.success) {\n                throw new Error(result.error || \"Failed to delete payment method\")\n            }\n\n            toast.success(locale === 'bg' ? '╨Ü╨░╤Ç╤é╨░╤é╨░ ╨╡ ╨┐╤Ç╨╡╨╝╨░╤à╨╜╨░╤é╨░' : 'Card removed')\n            setIsDeleteDialogOpen(false)\n            setDeletingMethodId(null)\n            \r\n            // Update local state\r\n            setPaymentMethods(prev => prev.filter(m => m.id !== deletingMethodId))\r\n            router.refresh()\r\n        } catch (error) {\r\n            console.error('Error deleting payment method:', error)\r\n            toast.error(locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨┐╤Ç╨╡╨╝╨░╤à╨▓╨░╨╜╨╡' : 'Error removing card')\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleSetDefault = async (methodId: string) => {\r\n        setIsLoading(true)\n        try {\n            const method = paymentMethods.find(m => m.id === methodId)\n            if (!method) return\n\n            const result = await actions.setDefaultPaymentMethod({\n                paymentMethodId: method.stripe_payment_method_id,\n                dbId: method.id,\n            })\n\n            if (!result.success) {\n                throw new Error(result.error || \"Failed to set default payment method\")\n            }\n\n            toast.success(locale === 'bg' ? '╨Ü╨░╤Ç╤é╨░╤é╨░ ╨┐╨╛ ╨┐╨╛╨┤╤Ç╨░╨╖╨▒╨╕╤Ç╨░╨╜╨╡ ╨╡ ╨┐╤Ç╨╛╨╝╨╡╨╜╨╡╨╜╨░' : 'Default card updated')\n            \r\n            // Update local state\r\n            setPaymentMethods(prev => prev.map(m => ({\r\n                ...m,\r\n                is_default: m.id === methodId\r\n            })))\r\n            router.refresh()\r\n        } catch (error) {\r\n            console.error('Error setting default:', error)\r\n            toast.error(locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨┐╤Ç╨╛╨╝╤Å╨╜╨░' : 'Error updating')\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    const getCardBrandDisplay = (brand: string | null) => {\r\n        if (!brand) return 'Card'\r\n        return brand.charAt(0).toUpperCase() + brand.slice(1)\r\n    }\r\n\r\n    const getCardStyle = (brand: string | null): (typeof cardBrandStyles)[keyof typeof cardBrandStyles] => {\r\n        const key = brand?.toLowerCase()\r\n        if (key && key in cardBrandStyles) return cardBrandStyles[key as keyof typeof cardBrandStyles]\r\n        return cardBrandStyles.default\r\n    }\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\r\n                <div>\r\n                    <h1 className=\"text-2xl font-semibold\">\r\n                        {locale === 'bg' ? '╨¥╨░╤ç╨╕╨╜╨╕ ╨╜╨░ ╨┐╨╗╨░╤ë╨░╨╜╨╡' : 'Payment Methods'}\r\n                    </h1>\r\n                    <p className=\"text-muted-foreground text-sm mt-1\">\r\n                        {locale === 'bg' \r\n                            ? '╨ú╨┐╤Ç╨░╨▓╨╗╤Å╨▓╨░╨╣╤é╨╡ ╨▓╨░╤ê╨╕╤é╨╡ ╨╖╨░╨┐╨░╨╖╨╡╨╜╨╕ ╨║╨░╤Ç╤é╨╕ ╨╖╨░ ╨▒╤è╤Ç╨╖╨╛ ╨┐╨╗╨░╤ë╨░╨╜╨╡'\r\n                            : 'Manage your saved cards for faster checkout'}\r\n                    </p>\r\n                </div>\r\n                <Button onClick={handleAddCard} disabled={isAddingCard} className=\"gap-2\">\r\n                    {isAddingCard ? (\r\n                        <SpinnerGap className=\"size-4 animate-spin\" />\r\n                    ) : (\r\n                        <Plus className=\"size-4\" weight=\"bold\" />\r\n                    )}\r\n                    {locale === 'bg' ? '╨ö╨╛╨▒╨░╨▓╨╕ ╨║╨░╤Ç╤é╨░' : 'Add Card'}\r\n                </Button>\r\n            </div>\r\n\r\n            {/* Security Notice */}\r\n            <Card className=\"bg-surface-subtle border-muted\">\r\n                <CardContent className=\"flex items-start gap-3 pt-4\">\r\n                    <Shield className=\"size-5 text-primary shrink-0 mt-0.5\" weight=\"fill\" />\r\n                    <div className=\"text-sm\">\r\n                        <p className=\"font-medium\">\r\n                            {locale === 'bg' ? '╨Æ╨░╤ê╨╕╤é╨╡ ╨┤╨░╨╜╨╜╨╕ ╤ü╨░ ╨╖╨░╤ë╨╕╤é╨╡╨╜╨╕' : 'Your data is secure'}\r\n                        </p>\r\n                        <p className=\"text-muted-foreground\">\r\n                            {locale === 'bg' \r\n                                ? '╨Ü╨░╤Ç╤é╨╕╤é╨╡ ╤ü╨╡ ╨╛╨▒╤Ç╨░╨▒╨╛╤é╨▓╨░╤é ╨╛╤é Stripe. ╨¥╨╕╨╡ ╨╜╨╕╨║╨╛╨│╨░ ╨╜╨╡ ╤ü╤è╤à╤Ç╨░╨╜╤Å╨▓╨░╨╝╨╡ ╨┐╤è╨╗╨╜╨╕ ╨╜╨╛╨╝╨╡╤Ç╨░ ╨╜╨░ ╨║╨░╤Ç╤é╨╕.'\r\n                                : 'Cards are processed by Stripe. We never store full card numbers.'}\r\n                        </p>\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {paymentMethods.length === 0 ? (\r\n                <Card className=\"border-dashed\">\r\n                    <CardContent className=\"flex flex-col items-center justify-center py-12\">\r\n                        <CreditCard className=\"size-12 text-muted-foreground mb-4\" />\r\n                        <h3 className=\"text-lg font-medium mb-2\">\r\n                            {locale === 'bg' ? '╨¥╤Å╨╝╨░╤é╨╡ ╨╖╨░╨┐╨░╨╖╨╡╨╜╨╕ ╨║╨░╤Ç╤é╨╕' : 'No saved cards'}\r\n                        </h3>\r\n                        <p className=\"text-muted-foreground text-center mb-4 max-w-sm\">\r\n                            {locale === 'bg' \r\n                                ? '╨ö╨╛╨▒╨░╨▓╨╡╤é╨╡ ╨║╨░╤Ç╤é╨░ ╨╖╨░ ╨┐╨╛-╨▒╤è╤Ç╨╖╨╛ ╨╕ ╤â╨┤╨╛╨▒╨╜╨╛ ╨┐╨╗╨░╤ë╨░╨╜╨╡ ╨┐╤Ç╨╕ ╨┐╨╛╤Ç╤è╤ç╨║╨░'\r\n                                : 'Add a card for faster and easier checkout'}\r\n                        </p>\r\n                        <Button onClick={handleAddCard} disabled={isAddingCard} variant=\"outline\" className=\"gap-2\">\r\n                            {isAddingCard ? (\r\n                                <SpinnerGap className=\"size-4 animate-spin\" />\r\n                            ) : (\r\n                                <Plus className=\"size-4\" />\r\n                            )}\r\n                            {locale === 'bg' ? '╨ö╨╛╨▒╨░╨▓╨╕ ╨┐╤è╤Ç╨▓╨░╤é╨░ ╨║╨░╤Ç╤é╨░' : 'Add your first card'}\r\n                        </Button>\r\n                    </CardContent>\r\n                </Card>\r\n            ) : (\r\n                <div className=\"space-y-4\">\r\n                    {paymentMethods.map((method) => {\r\n                        const style = getCardStyle(method.card_brand)\r\n                        return (\r\n                            <Card key={method.id} className={method.is_default ? 'border-primary' : ''}>\r\n                                <CardContent className=\"flex items-center justify-between py-4\">\r\n                                    <div className=\"flex items-center gap-4\">\r\n                                        <div className={`w-12 h-8 rounded flex items-center justify-center ${style.bg}`}>\r\n                                            <CreditCard className={`size-5 ${style.text}`} weight=\"fill\" />\r\n                                        </div>\r\n                                        <div>\r\n                                            <div className=\"flex items-center gap-2\">\r\n                                                <span className=\"font-medium\">\r\n                                                    {getCardBrandDisplay(method.card_brand)} ΓÇóΓÇóΓÇóΓÇó {method.card_last4}\r\n                                                </span>\r\n                                                {method.is_default && (\r\n                                                    <Badge variant=\"secondary\" className=\"text-xs\">\r\n                                                        <Star className=\"size-3 mr-1\" weight=\"fill\" />\r\n                                                        {locale === 'bg' ? '╨ƒ╨╛ ╨┐╨╛╨┤╤Ç╨░╨╖╨▒╨╕╤Ç╨░╨╜╨╡' : 'Default'}\r\n                                                    </Badge>\r\n                                                )}\r\n                                            </div>\r\n                                            <p className=\"text-sm text-muted-foreground\">\r\n                                                {locale === 'bg' ? '╨ÿ╨╖╤é╨╕╤ç╨░' : 'Expires'} {method.card_exp_month?.toString().padStart(2, '0')}/{method.card_exp_year?.toString().slice(-2)}\r\n                                            </p>\r\n                                        </div>\r\n                                    </div>\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        {!method.is_default && (\r\n                                            <Button \r\n                                                variant=\"ghost\" \r\n                                                size=\"sm\"\r\n                                                onClick={() => handleSetDefault(method.id)}\r\n                                                disabled={isLoading}\r\n                                            >\r\n                                                {locale === 'bg' ? '╨ƒ╨╛ ╨┐╨╛╨┤╤Ç╨░╨╖╨▒╨╕╤Ç╨░╨╜╨╡' : 'Set default'}\r\n                                            </Button>\r\n                                        )}\r\n                                        <Button \r\n                                            variant=\"ghost\" \r\n                                            size=\"icon\"\r\n                                            className=\"text-destructive hover:text-destructive\"\r\n                                            onClick={() => {\r\n                                                setDeletingMethodId(method.id)\r\n                                                setIsDeleteDialogOpen(true)\r\n                                            }}\r\n                                        >\r\n                                            <Trash className=\"size-4\" />\r\n                                        </Button>\r\n                                    </div>\r\n                                </CardContent>\r\n                            </Card>\r\n                        )\r\n                    })}\r\n\r\n                    {/* Add New Card Button */}\r\n                    <Card \r\n                        className=\"border-dashed cursor-pointer hover:border-hover-border transition-colors\"\r\n                        onClick={handleAddCard}\r\n                    >\r\n                        <CardContent className=\"flex items-center justify-center py-6\">\r\n                            <div className=\"flex items-center gap-2 text-muted-foreground\">\r\n                                <Plus className=\"size-5\" />\r\n                                <span className=\"font-medium\">\r\n                                    {locale === 'bg' ? '╨ö╨╛╨▒╨░╨▓╨╕ ╨╜╨╛╨▓╨░ ╨║╨░╤Ç╤é╨░' : 'Add new card'}\r\n                                </span>\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n                </div>\r\n            )}\r\n\r\n            {/* Additional Info */}\r\n            <div className=\"mt-8 flex items-start gap-3 text-sm text-muted-foreground\">\r\n                <Lock className=\"size-4 mt-0.5 shrink-0\" />\r\n                <p>\r\n                    {locale === 'bg' \r\n                        ? '╨Æ╨░╤ê╨╕╤é╨╡ ╨┐╨╗╨░╤ë╨░╨╜╨╕╤Å ╤ü╨╡ ╨╛╨▒╤Ç╨░╨▒╨╛╤é╨▓╨░╤é ╤ü╨╕╨│╤â╤Ç╨╜╨╛ ╨╛╤é Stripe. ╨ù╨░ ╨┤╨░ ╨╜╨░╤â╤ç╨╕╤é╨╡ ╨┐╨╛╨▓╨╡╤ç╨╡, ╨┐╨╛╤ü╨╡╤é╨╡╤é╨╡ ╨╜╨░╤ê╨░╤é╨░ ╤ü╤é╤Ç╨░╨╜╨╕╤å╨░ ╨╖╨░ ╨┐╨╛╨▓╨╡╤Ç╨╕╤é╨╡╨╗╨╜╨╛╤ü╤é.'\r\n                        : 'Your payments are securely processed by Stripe. To learn more, visit our privacy page.'}\r\n                </p>\r\n            </div>\r\n\r\n            {/* Delete Confirmation Dialog */}\r\n            <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\r\n                <AlertDialogContent>\r\n                    <AlertDialogHeader>\r\n                        <AlertDialogTitle>\r\n                            {locale === 'bg' ? '╨ƒ╤Ç╨╡╨╝╨░╤à╨▓╨░╨╜╨╡ ╨╜╨░ ╨║╨░╤Ç╤é╨░' : 'Remove Card'}\r\n                        </AlertDialogTitle>\r\n                        <AlertDialogDescription>\r\n                            {locale === 'bg' \r\n                                ? '╨í╨╕╨│╤â╤Ç╨╜╨╕ ╨╗╨╕ ╤ü╤é╨╡, ╤ç╨╡ ╨╕╤ü╨║╨░╤é╨╡ ╨┤╨░ ╨┐╤Ç╨╡╨╝╨░╤à╨╜╨╡╤é╨╡ ╤é╨░╨╖╨╕ ╨║╨░╤Ç╤é╨░? ╨⌐╨╡ ╤é╤Ç╤Å╨▒╨▓╨░ ╨┤╨░ ╤Å ╨┤╨╛╨▒╨░╨▓╨╕╤é╨╡ ╨╛╤é╨╜╨╛╨▓╨╛, ╨░╨║╨╛ ╨╕╤ü╨║╨░╤é╨╡ ╨┤╨░ ╤Å ╨╕╨╖╨┐╨╛╨╗╨╖╨▓╨░╤é╨╡ ╨╖╨░ ╨┐╨╗╨░╤ë╨░╨╜╨╡.'\r\n                                : 'Are you sure you want to remove this card? You will need to add it again if you want to use it for payments.'}\r\n                        </AlertDialogDescription>\r\n                    </AlertDialogHeader>\r\n                    <AlertDialogFooter>\r\n                        <AlertDialogCancel>\r\n                            {locale === 'bg' ? '╨₧╤é╨║╨░╨╖' : 'Cancel'}\r\n                        </AlertDialogCancel>\r\n                        <AlertDialogAction \r\n                            onClick={handleDelete}\r\n                            className=\"bg-destructive text-destructive-foreground hover:bg-destructive\"\n                        >\r\n                            {isLoading && <SpinnerGap className=\"size-4 mr-2 animate-spin\" />}\r\n                            {locale === 'bg' ? '╨ƒ╤Ç╨╡╨╝╨░╤à╨╜╨╕' : 'Remove'}\r\n                        </AlertDialogAction>\r\n                    </AlertDialogFooter>\r\n                </AlertDialogContent>\r\n            </AlertDialog>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\plans\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\plans\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/subscriptions' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":10,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":15,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/lib/supabase/server\"\r\nimport { redirect } from \"@/i18n/routing\"\r\nimport { getTranslations } from \"next-intl/server\"\r\nimport { PlansContent } from \"./plans-content\"\r\nimport {\r\n  PLANS_SELECT_FOR_PLANS_PAGE,\r\n  PRIVATE_PROFILE_SELECT_FOR_UPGRADE,\r\n  PROFILE_SELECT_FOR_PLANS,\r\n} from \"@/lib/data/plans\"\r\nimport {\r\n  cancelSubscription,\r\n  createBillingPortalSession,\r\n  createSubscriptionCheckoutSession,\r\n  reactivateSubscription,\r\n} from \"@/app/actions/subscriptions\"\r\n\r\ninterface PlansPageProps {\r\n  params: Promise<{\r\n    locale: string\r\n  }>\r\n}\r\n\r\nexport default async function PlansPage({ params }: PlansPageProps) {\r\n  const { locale: localeParam } = await params\r\n  const locale = localeParam === \"bg\" ? \"bg\" : \"en\"\r\n  const supabase = await createClient()\r\n  const t = await getTranslations({ locale, namespace: \"Account\" })\r\n\r\n  if (!supabase) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n\r\n  if (!user) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  // Fetch profile info (public surface) + private billing fields\r\n  const [\r\n    { data: profile },\r\n    { data: privateProfile },\r\n  ] = await Promise.all([\r\n    supabase\r\n      .from('profiles')\r\n      .select(PROFILE_SELECT_FOR_PLANS)\r\n      .eq('id', user.id)\r\n      .single(),\r\n    supabase\r\n      .from('private_profiles')\r\n      .select(PRIVATE_PROFILE_SELECT_FOR_UPGRADE)\r\n      .eq('id', user.id)\r\n      .maybeSingle(),\r\n  ])\r\n\r\n  // Fetch subscription plans (only valid fields)\r\n  const { data: plans } = await supabase\r\n    .from('subscription_plans')\r\n    .select(PLANS_SELECT_FOR_PLANS_PAGE)\r\n    .eq('is_active', true)\r\n    .order('price_monthly', { ascending: true })\r\n\r\n  // Fetch current subscription if exists (include cancelled-but-not-expired)\r\n  const { data: currentSubscription } = await supabase\r\n    .from('subscriptions')\r\n    .select('id, seller_id, plan_type, status, billing_period, expires_at, auto_renew, stripe_subscription_id')\r\n    .eq('seller_id', user.id)\r\n    .in('status', ['active']) // Active subscriptions only\r\n    .order('created_at', { ascending: false })\r\n    .limit(1)\r\n    .single()\r\n\r\n  const currentTier = profile?.tier || 'free'\r\n  const accountType = profile?.account_type || 'personal'\r\n\r\n  // Filter plans by seller's account type (null handled as string comparison)\r\n  const filteredPlans = (plans || []).filter(\r\n    (plan) => plan.account_type === accountType || plan.account_type === null\r\n  )\r\n\r\n  // Map profile to seller interface expected by PlansContent\r\n  const commissionRate = privateProfile?.commission_rate == null ? 0 : Number(privateProfile.commission_rate)\r\n  const seller = profile ? {\r\n    id: profile.id,\r\n    tier: profile.tier || 'free',\r\n    account_type: (accountType === 'business' ? 'business' : 'personal') as 'personal' | 'business',\r\n    commission_rate: commissionRate,\r\n    stripe_customer_id: privateProfile?.stripe_customer_id ?? null,\r\n  } : null\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 md:gap-4\">\r\n      <h1 className=\"sr-only\">{t(\"header.plans\")}</h1>\r\n      <PlansContent\r\n        locale={locale}\r\n        plans={filteredPlans as Parameters<typeof PlansContent>[0]['plans']}    \r\n        currentTier={currentTier}\r\n        seller={seller}\r\n        currentSubscription={currentSubscription as Parameters<typeof PlansContent>[0]['currentSubscription']}\r\n        actions={{\r\n          cancelSubscription,\r\n          reactivateSubscription,\r\n          createBillingPortalSession,\r\n          createSubscriptionCheckoutSession,\r\n        }}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\plans\\plans-content.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 57 to the 25 allowed.","line":128,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":128,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useTransition } from \"react\"\r\nimport { useSearchParams } from \"next/navigation\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n  AlertDialogTrigger,\r\n} from \"@/components/ui/alert-dialog\"\r\nimport { Lightning, X, ArrowsClockwise, CalendarBlank, Warning } from \"@phosphor-icons/react\"\r\nimport { cn } from \"@/lib/utils\"\nimport { toast } from \"sonner\"\nimport { PlansGrid, type Plan } from \"../_components/plan-card\"\n\r\nexport type PlansContentServerActions = {\r\n  cancelSubscription: () => Promise<{ success: boolean; error?: string }>\r\n  reactivateSubscription: () => Promise<{ success: boolean; error?: string }>\r\n  createBillingPortalSession: (args?: {\r\n    locale?: \"en\" | \"bg\"\r\n  }) => Promise<{ url?: string; error?: string }>\r\n  createSubscriptionCheckoutSession: (args: {\r\n    planId: string\r\n    billingPeriod: \"monthly\" | \"yearly\"\r\n    locale?: \"en\" | \"bg\"\r\n  }) => Promise<{ url?: string; error?: string }>\r\n}\r\n\r\ninterface SubscriptionPlan {\r\n  id: string\r\n  tier: string\r\n  name: string\r\n  account_type?: string | null\r\n  price_monthly: number\r\n  price_yearly: number\r\n  // Fee structure (all paid by seller from earnings)\r\n  final_value_fee?: number | null\r\n  insertion_fee?: number | null\r\n  per_order_fee?: number | null\r\n  commission_rate?: number | null\r\n  max_listings?: number | null\r\n  boosts_included?: number | null\r\n  priority_support?: boolean | null\r\n  analytics_access?: string | null\r\n  badge_type?: string | null\r\n  description?: string | null\r\n  description_bg?: string | null\r\n  features: unknown // Json type from DB\r\n  // DB column names\r\n  stripe_price_monthly_id?: string | null\r\n  stripe_price_yearly_id?: string | null\r\n  is_active?: boolean | null\r\n}\r\n\r\ninterface Seller {\r\n  id: string\r\n  tier: string\r\n  account_type?: \"personal\" | \"business\"\r\n  final_value_fee?: number\r\n  insertion_fee?: number\r\n  commission_rate?: number  // Legacy\r\n  [key: string]: unknown\r\n}\r\n\r\ninterface Subscription {\r\n  id: string\r\n  seller_id: string\r\n  plan_type: string\r\n  status: string\r\n  billing_period?: string\r\n  expires_at?: string\r\n  auto_renew?: boolean\r\n  stripe_subscription_id: string | null\r\n  [key: string]: unknown\r\n}\r\n\r\ninterface PlansContentProps {\r\n  locale: string\r\n  plans: SubscriptionPlan[]\r\n  currentTier: string\r\n  seller: Seller | null\r\n  currentSubscription: Subscription | null\r\n  actions: PlansContentServerActions\r\n}\r\n\r\n// Convert SubscriptionPlan to Plan interface for shared component\r\nfunction toPlan(sp: SubscriptionPlan): Plan {\r\n  // Validate account_type is a valid literal type\r\n  const accountType = sp.account_type === \"business\" ? \"business\" : \"personal\"\r\n\r\n  // Parse features from Json to string array\r\n  const features: string[] = Array.isArray(sp.features)\r\n    ? sp.features.filter((f): f is string => typeof f === \"string\")\r\n    : []\r\n\r\n  return {\r\n    id: sp.id,\r\n    name: sp.name,\r\n    tier: sp.tier,\r\n    account_type: accountType,\r\n    price_monthly: sp.price_monthly,\r\n    price_yearly: sp.price_yearly,\r\n    max_listings: sp.max_listings ?? null,\r\n    // Simple fee structure: just % when sold (no insertion or per-order fees)\r\n    final_value_fee: sp.final_value_fee ?? sp.commission_rate ?? 12,\r\n    insertion_fee: 0,  // No longer used\r\n    per_order_fee: 0,  // No longer used\r\n    ...(typeof sp.commission_rate === \"number\" ? { commission_rate: sp.commission_rate } : {}),\r\n    boosts_included: sp.boosts_included ?? 0,\r\n    priority_support: sp.priority_support ?? false,\r\n    analytics_access: sp.analytics_access ?? \"none\",\r\n    badge_type: sp.badge_type ?? null,\r\n    description: sp.description ?? \"\",\r\n    description_bg: sp.description_bg ?? \"\",\r\n    features,\r\n  }\r\n}\r\n\r\nexport function PlansContent({\r\n  locale,\r\n  plans,\r\n  currentTier,\r\n  seller,\r\n  currentSubscription,\r\n  actions,\r\n}: PlansContentProps) {\r\n  const [loadingPlanId, setLoadingPlanId] = useState<string | null>(null)\r\n  const [billingPeriod, setBillingPeriod] = useState<\"monthly\" | \"yearly\">(\"monthly\")\r\n  const [isPending, startTransition] = useTransition()\r\n  const [cancelDialogOpen, setCancelDialogOpen] = useState(false)\r\n  const searchParams = useSearchParams()\r\n\r\n  // Computed: Is this subscription set to cancel at period end?\r\n  const isCancelledButActive = currentSubscription?.status === \"active\" && currentSubscription?.auto_renew === false\r\n  const hasActiveSubscription = currentSubscription?.status === \"active\" && currentTier !== \"free\"\r\n\r\n  // Format expiry date\r\n  const expiryDate = currentSubscription?.expires_at\r\n    ? new Date(currentSubscription.expires_at).toLocaleDateString(locale === \"bg\" ? \"bg-BG\" : \"en-US\", {\r\n      year: \"numeric\",\r\n      month: \"long\",\r\n      day: \"numeric\"\r\n    })\r\n    : null\r\n\r\n  // Show toast notifications based on URL params (from Stripe redirect)\r\n  useEffect(() => {\r\n    if (searchParams.get(\"success\") === \"true\") {\r\n      toast.success(\r\n        locale === \"bg\"\r\n          ? \"╨É╨▒╨╛╨╜╨░╨╝╨╡╨╜╤é╤è╤é ╨╡ ╨░╨║╤é╨╕╨▓╨╕╤Ç╨░╨╜ ╤â╤ü╨┐╨╡╤ê╨╜╨╛!\"\r\n          : \"Subscription activated successfully!\"\r\n      )\r\n      window.history.replaceState({}, \"\", window.location.pathname)\r\n    } else if (searchParams.get(\"canceled\") === \"true\") {\r\n      toast.info(\r\n        locale === \"bg\"\r\n          ? \"╨ƒ╨╗╨░╤ë╨░╨╜╨╡╤é╨╛ ╨▒╨╡╤ê╨╡ ╨╛╤é╨╝╨╡╨╜╨╡╨╜╨╛\"\r\n          : \"Payment was cancelled\"\r\n      )\r\n      window.history.replaceState({}, \"\", window.location.pathname)\r\n    }\r\n  }, [searchParams, locale])\r\n\r\n  // Handle subscription cancellation\r\n  const handleCancelSubscription = () => {\r\n    startTransition(async () => {\r\n      const result = await actions.cancelSubscription()\r\n      if (result.success) {\r\n        toast.success(\r\n          locale === \"bg\"\r\n            ? \"╨É╨▒╨╛╨╜╨░╨╝╨╡╨╜╤é╤è╤é ╤ë╨╡ ╨▒╤è╨┤╨╡ ╨┐╤Ç╨╡╨║╤Ç╨░╤é╨╡╨╜ ╨▓ ╨║╤Ç╨░╤Å ╨╜╨░ ╨┐╨╡╤Ç╨╕╨╛╨┤╨░\"\r\n            : \"Subscription will be cancelled at the end of the billing period\"\r\n        )\r\n        setCancelDialogOpen(false)\r\n      } else {\r\n        toast.error(result.error || (locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░\" : \"Error\"))\r\n      }\r\n    })\r\n  }\r\n\r\n  // Handle subscription reactivation\r\n  const handleReactivate = () => {\r\n    startTransition(async () => {\r\n      const result = await actions.reactivateSubscription()\r\n      if (result.success) {\r\n        toast.success(\r\n          locale === \"bg\"\r\n            ? \"╨É╨▒╨╛╨╜╨░╨╝╨╡╨╜╤é╤è╤é ╨╡ ╨░╨║╤é╨╕╨▓╨╕╤Ç╨░╨╜ ╨╛╤é╨╜╨╛╨▓╨╛!\"\r\n            : \"Subscription reactivated!\"\r\n        )\r\n      } else {\r\n        toast.error(result.error || (locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░\" : \"Error\"))\r\n      }\r\n    })\r\n  }\r\n\r\n  const handleSelectPlan = async (plan: Plan) => {\r\n    if (plan.price_monthly === 0) {\r\n      toast.info(locale === \"bg\" ? \"╨ó╨╛╨▓╨░ ╨╡ ╨▒╨╡╨╖╨┐╨╗╨░╤é╨╡╨╜ ╨┐╨╗╨░╨╜\" : \"This is a free plan\")\r\n      return\r\n    }\r\n\r\n    setLoadingPlanId(plan.id)\r\n\r\n    try {\r\n      const { url, error } = await actions.createSubscriptionCheckoutSession({\r\n        planId: plan.id,\r\n        billingPeriod,\r\n        locale: locale === \"bg\" ? \"bg\" : \"en\",\r\n      })\r\n\r\n      if (error) {\r\n        throw new Error(error)\r\n      }\r\n\r\n      if (url) {\r\n        window.location.href = url\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Checkout error:\", err)\r\n      toast.error(\r\n        locale === \"bg\"\r\n          ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╤ü╤è╨╖╨┤╨░╨▓╨░╨╜╨╡ ╨╜╨░ ╨┐╨╗╨░╤ë╨░╨╜╨╡. ╨£╨╛╨╗╤Å, ╨╛╨┐╨╕╤é╨░╨╣╤é╨╡ ╨╛╤é╨╜╨╛╨▓╨╛.\"\r\n          : \"Error creating payment. Please try again.\"\r\n      )\r\n    } finally {\r\n      setLoadingPlanId(null)\r\n    }\r\n  }\r\n\r\n  const handleManageSubscription = async () => {\r\n    try {\r\n      const { url, error } = await actions.createBillingPortalSession({\r\n        locale: locale === \"bg\" ? \"bg\" : \"en\",\r\n      })\r\n\r\n      if (error) {\r\n        throw new Error(error)\r\n      }\r\n\r\n      if (url) {\r\n        window.location.href = url\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Portal error:\", err)\r\n      toast.error(\r\n        locale === \"bg\"\r\n          ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨╛╤é╨▓╨░╤Ç╤Å╨╜╨╡ ╨╜╨░ ╨┐╨╛╤Ç╤é╨░╨╗╨░. ╨£╨╛╨╗╤Å, ╨╛╨┐╨╕╤é╨░╨╣╤é╨╡ ╨╛╤é╨╜╨╛╨▓╨╛.\"\r\n          : \"Error opening portal. Please try again.\"\r\n      )\r\n    }\r\n  }\r\n\r\n  // Plans are already filtered by account type from server\r\n  // Just map to Plan interface for display\r\n  const mappedPlans = plans.map(toPlan)\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"text-center\">\r\n        <h1 className=\"text-2xl sm:text-3xl font-semibold mb-2\">\r\n          {locale === \"bg\" ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨┐╨╗╨░╨╜ ╨╖╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç\" : \"Choose a Seller Plan\"}\r\n        </h1>\r\n        <p className=\"text-muted-foreground\">\r\n          {locale === \"bg\"\r\n            ? \"╨¥╨░╨┤╨│╤Ç╨░╨┤╨╡╤é╨╡ ╨░╨║╨░╤â╨╜╤é╨░ ╤ü╨╕ ╨╖╨░ ╨┐╨╛-╨╜╨╕╤ü╨║╨╕ ╤é╨░╨║╤ü╨╕ ╨╕ ╨┐╨╛╨▓╨╡╤ç╨╡ ╨▓╤è╨╖╨╝╨╛╨╢╨╜╨╛╤ü╤é╨╕\"\r\n            : \"Upgrade your account for lower fees and more features\"}\r\n        </p>\r\n      </div>\r\n\r\n      {/* Current Subscription Status Card */}\r\n      {seller && hasActiveSubscription && (\r\n        <Card className={cn(\r\n          \"max-w-md mx-auto\",\r\n          isCancelledButActive && \"border-warning/50 bg-warning/5\"\r\n        )}>\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex flex-col gap-3\">\r\n              {/* Plan Badge & Status */}\r\n              <div className=\"flex items-center justify-between\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Badge variant={isCancelledButActive ? \"outline\" : \"secondary\"} className=\"text-sm px-3 py-1\">\r\n                    {locale === \"bg\" ? \"╨ó╨╡╨║╤â╤ë ╨┐╨╗╨░╨╜: \" : \"Current plan: \"}\r\n                    <span className=\"font-semibold capitalize ml-1\">{currentTier}</span>\r\n                  </Badge>\r\n                  {isCancelledButActive && (\r\n                    <Badge variant=\"outline\" className=\"text-warning border-warning/50\">\r\n                      {locale === \"bg\" ? \"╨₧╤é╨╝╨╡╨╜╨╡╨╜\" : \"Cancelling\"}\r\n                    </Badge>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {/* Expiry Info */}\r\n              {expiryDate && (\r\n                <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\r\n                  <CalendarBlank className=\"size-4\" />\r\n                  {isCancelledButActive ? (\r\n                    <span>\r\n                      {locale === \"bg\"\r\n                        ? `╨ö╨╛╤ü╤é╤è╨┐╤è╤é ╨┐╤Ç╨╕╨║╨╗╤Ä╤ç╨▓╨░ ╨╜╨░ ${expiryDate}`\r\n                        : `Access ends on ${expiryDate}`}\r\n                    </span>\r\n                  ) : (\r\n                    <span>\r\n                      {locale === \"bg\"\r\n                        ? `╨í╨╗╨╡╨┤╨▓╨░╤ë╨╛ ╨┐╨╗╨░╤ë╨░╨╜╨╡: ${expiryDate}`\r\n                        : `Next billing: ${expiryDate}`}\r\n                    </span>\r\n                  )}\r\n                </div>\r\n              )}\r\n\r\n              {/* Cancellation Warning */}\r\n              {isCancelledButActive && (\r\n                <div className=\"flex items-start gap-2 p-2 rounded-md bg-warning/10 text-warning text-xs\">\r\n                  <Warning className=\"size-4 shrink-0 mt-0.5\" weight=\"fill\" />\r\n                  <span>\r\n                    {locale === \"bg\"\r\n                      ? \"╨í╨╗╨╡╨┤ ╤é╨░╨╖╨╕ ╨┤╨░╤é╨░ ╤ë╨╡ ╨▒╤è╨┤╨╡╤é╨╡ ╨┐╤Ç╨╡╤à╨▓╤è╤Ç╨╗╨╡╨╜╨╕ ╨║╤è╨╝ ╨▒╨╡╨╖╨┐╨╗╨░╤é╨╜╨╕╤Å ╨┐╨╗╨░╨╜. ╨£╨╛╨╢╨╡╤é╨╡ ╨┤╨░ ╤ü╨╡ ╨░╨▒╨╛╨╜╨╕╤Ç╨░╤é╨╡ ╨╛╤é╨╜╨╛╨▓╨╛ ╨┐╨╛ ╨▓╤ü╤Å╨║╨╛ ╨▓╤Ç╨╡╨╝╨╡.\"\r\n                      : \"After this date, you'll be moved to the free plan. You can resubscribe anytime.\"}\r\n                  </span>\r\n                </div>\r\n              )}\r\n\r\n              {/* Action Buttons */}\r\n              <div className=\"flex items-center gap-2 flex-wrap\">\r\n                {isCancelledButActive ? (\r\n                  // Show Reactivate button if cancelled but not yet expired\r\n                  <Button\r\n                    size=\"sm\"\r\n                    onClick={handleReactivate}\r\n                    disabled={isPending}\r\n                    className=\"gap-1.5\"\r\n                  >\r\n                    <ArrowsClockwise className={cn(\"size-4\", isPending && \"animate-spin\")} />\r\n                    {locale === \"bg\" ? \"╨É╨║╤é╨╕╨▓╨╕╤Ç╨░╨╣ ╨╛╤é╨╜╨╛╨▓╨╛\" : \"Reactivate\"}\r\n                  </Button>\r\n                ) : (\r\n                  // Show Cancel button for active subscriptions\r\n                  <AlertDialog open={cancelDialogOpen} onOpenChange={setCancelDialogOpen}>\r\n                    <AlertDialogTrigger asChild>\r\n                      <Button variant=\"outline\" size=\"sm\" className=\"gap-1.5 text-muted-foreground\">\r\n                        <X className=\"size-4\" />\r\n                        {locale === \"bg\" ? \"╨₧╤é╨╝╨╡╨╜╨╕ ╨░╨▒╨╛╨╜╨░╨╝╨╡╨╜╤é\" : \"Cancel Subscription\"}\r\n                      </Button>\r\n                    </AlertDialogTrigger>\r\n                    <AlertDialogContent>\r\n                      <AlertDialogHeader>\r\n                        <AlertDialogTitle>\r\n                          {locale === \"bg\" ? \"╨₧╤é╨╝╤Å╨╜╨░ ╨╜╨░ ╨░╨▒╨╛╨╜╨░╨╝╨╡╨╜╤é╨░\" : \"Cancel Subscription\"}\r\n                        </AlertDialogTitle>\r\n                        <AlertDialogDescription className=\"space-y-2\">\r\n                          <p>\r\n                            {locale === \"bg\"\r\n                              ? \"╨í╨╕╨│╤â╤Ç╨╜╨╕ ╨╗╨╕ ╤ü╤é╨╡? ╨Æ╨░╤ê╨╕╤Å╤é ╨░╨▒╨╛╨╜╨░╨╝╨╡╨╜╤é ╤ë╨╡ ╨╛╤ü╤é╨░╨╜╨╡ ╨░╨║╤é╨╕╨▓╨╡╨╜ ╨┤╨╛ ╨║╤Ç╨░╤Å ╨╜╨░ ╤é╨╡╨║╤â╤ë╨╕╤Å ╨┐╨╡╤Ç╨╕╨╛╨┤ ╨╖╨░ ╨┐╨╗╨░╤ë╨░╨╜╨╡.\"\r\n                              : \"Are you sure? Your subscription will remain active until the end of the current billing period.\"}\r\n                          </p>\r\n                          {expiryDate && (\r\n                            <p className=\"font-medium\">\r\n                              {locale === \"bg\"\r\n                                ? `╨ö╨╛╤ü╤é╤è╨┐╤è╤é ╨▓╨╕ ╤ë╨╡ ╨╕╨╖╤é╨╡╤ç╨╡ ╨╜╨░ ${expiryDate}`\r\n                                : `Your access will expire on ${expiryDate}`}\r\n                            </p>\r\n                          )}\r\n                          <p className=\"text-xs text-muted-foreground\">\r\n                            {locale === \"bg\"\r\n                              ? \"╨£╨╛╨╢╨╡╤é╨╡ ╨┤╨░ ╤ü╨╡ ╨░╨▒╨╛╨╜╨╕╤Ç╨░╤é╨╡ ╨╛╤é╨╜╨╛╨▓╨╛ ╨┐╨╛ ╨▓╤ü╤Å╨║╨╛ ╨▓╤Ç╨╡╨╝╨╡, ╨╖╨░ ╨┤╨░ ╨▓╤è╨╖╤ü╤é╨░╨╜╨╛╨▓╨╕╤é╨╡ ╨┤╨╛╤ü╤é╤è╨┐╨░ ╤ü╨╕.\"\r\n                              : \"You can resubscribe anytime to restore your access.\"}\r\n                          </p>\r\n                        </AlertDialogDescription>\r\n                      </AlertDialogHeader>\r\n                      <AlertDialogFooter>\r\n                        <AlertDialogCancel>\r\n                          {locale === \"bg\" ? \"╨₧╤é╨║╨░╨╢╨╕\" : \"Keep Subscription\"}\r\n                        </AlertDialogCancel>\r\n                        <AlertDialogAction\r\n                          onClick={handleCancelSubscription}\r\n                          disabled={isPending}\r\n                          className=\"bg-destructive text-destructive-foreground hover:bg-destructive\"\n                        >\r\n                          {isPending\r\n                            ? (locale === \"bg\" ? \"╨₧╨▒╤Ç╨░╨▒╨╛╤é╨║╨░...\" : \"Processing...\")\r\n                            : (locale === \"bg\" ? \"╨ö╨░, ╨╛╤é╨╝╨╡╨╜╨╕\" : \"Yes, Cancel\")}\r\n                        </AlertDialogAction>\r\n                      </AlertDialogFooter>\r\n                    </AlertDialogContent>\r\n                  </AlertDialog>\r\n                )}\r\n\r\n                {/* Stripe Portal for payment method management */}\r\n                {currentSubscription?.stripe_subscription_id && (\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    onClick={handleManageSubscription}\r\n                    className=\"text-xs\"\r\n                  >\r\n                    {locale === \"bg\" ? \"╨£╨╡╤é╨╛╨┤╨╕ ╨╖╨░ ╨┐╨╗╨░╤ë╨░╨╜╨╡\" : \"Payment Methods\"}\r\n                  </Button>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Current Plan Badge for free tier users */}\r\n      {seller && !hasActiveSubscription && (\r\n        <div className=\"flex flex-col items-center gap-3\">\r\n          <Badge variant=\"secondary\" className=\"text-sm px-3 py-1\">\r\n            {locale === \"bg\" ? \"╨ó╨╡╨║╤â╤ë ╨┐╨╗╨░╨╜: \" : \"Current plan: \"}\r\n            <span className=\"font-semibold capitalize ml-1\">{currentTier}</span>\r\n          </Badge>\r\n          <p className=\"text-sm text-muted-foreground text-center max-w-md\">\r\n            {locale === \"bg\"\r\n              ? \"╨¥╨░╨┤╨│╤Ç╨░╨┤╨╡╤é╨╡ ╨┐╨╗╨░╨╜╨░ ╤ü╨╕ ╨╖╨░ ╨┐╨╛-╨╜╨╕╤ü╨║╨╕ ╤é╨░╨║╤ü╨╕ ╨╕ ╨┐╨╛╨▓╨╡╤ç╨╡ ╨╛╨▒╤Å╨▓╨╕\"\r\n              : \"Upgrade your plan for lower fees and more listings\"}\r\n          </p>\r\n        </div>\r\n      )}\r\n\r\n      {/* Billing Period Toggle */}\r\n      <div className=\"flex items-center justify-center\">\r\n        <div className=\"inline-flex items-center gap-2 bg-muted rounded-lg p-1\">\r\n          <button\r\n            className={cn(\r\n              \"px-4 py-2 rounded-md text-sm font-medium transition-colors\",\r\n              billingPeriod === \"monthly\"\r\n                ? \"bg-background text-foreground shadow-sm\"\r\n                : \"text-muted-foreground hover:text-foreground\"\r\n            )}\r\n            onClick={() => setBillingPeriod(\"monthly\")}\r\n          >\r\n            {locale === \"bg\" ? \"╨£╨╡╤ü╨╡╤ç╨╜╨╛\" : \"Monthly\"}\r\n          </button>\r\n          <button\r\n            className={cn(\r\n              \"px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2\",\r\n              billingPeriod === \"yearly\"\r\n                ? \"bg-background text-foreground shadow-sm\"\r\n                : \"text-muted-foreground hover:text-foreground\"\r\n            )}\r\n            onClick={() => setBillingPeriod(\"yearly\")}\r\n          >\r\n            {locale === \"bg\" ? \"╨ô╨╛╨┤╨╕╤ê╨╜╨╛\" : \"Yearly\"}\r\n            <Badge variant=\"secondary\" className=\"text-xs bg-selected text-primary\">\r\n              -17%\r\n            </Badge>\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Plans Grid - Uses shared component */}\r\n      <PlansGrid\r\n        plans={mappedPlans}\r\n        locale={locale}\r\n        billingPeriod={billingPeriod}\r\n        currentTier={currentTier}\r\n        loadingPlanId={loadingPlanId}\r\n        onSelectPlan={handleSelectPlan}\r\n        variant=\"compact\"\r\n      />\r\n\r\n      {/* Boost Section - Compact */}\r\n      <div className=\"mt-6 md:mt-10\">\r\n        <Card className=\"border-border\">\r\n          <CardHeader className=\"p-4 pb-2 md:p-4 md:pb-4\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <div className=\"p-1.5 rounded-md bg-muted\">\r\n                <Lightning className=\"size-4 text-primary\" weight=\"fill\" />\r\n              </div>\r\n              <div>\r\n                <CardTitle className=\"text-base md:text-lg\">\r\n                  {locale === 'bg' ? '╨ƒ╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╣ ╨╛╨▒╤Å╨▓╨╕╤é╨╡ ╤ü╨╕' : 'Boost Your Listings'}\r\n                </CardTitle>\r\n                <CardDescription className=\"text-xs md:text-sm\">\r\n                  {locale === 'bg'\r\n                    ? '╨ƒ╨╛╨║╨░╨╢╨╕ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨╕╤é╨╡ ╤ü╨╕ ╨╜╨░ ╨┐╨╛╨▓╨╡╤ç╨╡ ╤à╨╛╤Ç╨░'\r\n                    : 'Show your products to more people'}\r\n                </CardDescription>\r\n              </div>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent className=\"p-4 pt-2 md:p-4 md:pt-0\">\r\n            {/* Horizontal scroll on mobile */}\r\n            <div className=\"flex gap-3 overflow-x-auto no-scrollbar snap-x snap-mandatory sm:grid sm:grid-cols-3 sm:overflow-visible\">\r\n              <div className=\"border border-border rounded-md p-3 text-center shrink-0 w-24 snap-center sm:w-auto\">\r\n                <p className=\"text-lg font-semibold\">2.99 ╨╗╨▓</p>\r\n                <p className=\"text-xs text-muted-foreground\">{locale === 'bg' ? '7 ╨┤╨╜╨╕' : '7 days'}</p>\r\n              </div>\r\n              <div className=\"border border-primary rounded-md p-3 text-center relative shrink-0 w-24 snap-center sm:w-auto\">\r\n                <Badge className=\"absolute -top-2 left-1/2 -translate-x-1/2 bg-primary text-primary-foreground text-2xs px-1.5 py-0\">\r\n                  {locale === 'bg' ? '╨¥╨░╨╣-╨┤╨╛╨▒╤Ç╨░' : 'Best'}\r\n                </Badge>\r\n                <p className=\"text-lg font-semibold\">4.99 ╨╗╨▓</p>\r\n                <p className=\"text-xs text-muted-foreground\">{locale === 'bg' ? '14 ╨┤╨╜╨╕' : '14 days'}</p>\r\n              </div>\r\n              <div className=\"border border-border rounded-md p-3 text-center shrink-0 w-24 snap-center sm:w-auto\">\r\n                <p className=\"text-lg font-semibold\">8.99 ╨╗╨▓</p>\r\n                <p className=\"text-xs text-muted-foreground\">{locale === 'bg' ? '30 ╨┤╨╜╨╕' : '30 days'}</p>\r\n              </div>\r\n            </div>\r\n            <p className=\"text-2xs md:text-xs text-muted-foreground mt-3 text-center\">\r\n              {locale === 'bg'\r\n                ? '╨ƒ╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╜╨╕╤é╨╡ ╨╛╨▒╤Å╨▓╨╕ ╤ü╨╡ ╨┐╨╛╨║╨░╨╖╨▓╨░╤é ╨▓ ╤ü╨╡╨║╤å╨╕╤Å╤é╨░ \"╨ƒ╤Ç╨╡╨┐╨╛╤Ç╤è╤ç╨░╨╜╨╕\" ╨╕ ╨╕╨╝╨░╤é ╨┐╨╛-╨▓╨╕╤ü╨╛╨║╨╛ ╨┐╨╛╨╖╨╕╤å╨╕╨╛╨╜╨╕╤Ç╨░╨╜╨╡.'\r\n                : 'Boosted listings appear in \"Recommended\" and rank higher in search.'}\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* FAQ or Help */}\r\n      <div className=\"mt-8 text-center\">\r\n        <p className=\"text-sm text-muted-foreground\">\r\n          {locale === 'bg' ? '╨ÿ╨╝╨░╤é╨╡ ╨▓╤è╨┐╤Ç╨╛╤ü╨╕? ' : 'Have questions? '}\r\n          <Link href=\"/customer-service\" className=\"text-link hover:underline\">\r\n            {locale === 'bg' ? '╨í╨▓╤è╤Ç╨╢╨╡╤é╨╡ ╤ü╨╡ ╤ü ╨╜╨░╤ü' : 'Contact us'}\r\n          </Link>\r\n        </p>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\plans\\upgrade\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/subscriptions' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":8,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":8,"endColumn":80}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/lib/supabase/server\"\r\nimport { redirect } from \"@/i18n/routing\"\r\nimport { getTranslations, setRequestLocale } from \"next-intl/server\"\r\nimport { UpgradeContent } from \"./upgrade-content\"\r\nimport { ArrowLeft } from \"@phosphor-icons/react/dist/ssr\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { getPlansForUpgrade, PRIVATE_PROFILE_SELECT_FOR_UPGRADE, PROFILE_SELECT_FOR_UPGRADE } from \"@/lib/data/plans\"\r\nimport { createSubscriptionCheckoutSession } from \"@/app/actions/subscriptions\"\r\n\r\n/**\r\n * Full Upgrade Page\r\n * \r\n * This page is shown when accessing /account/plans/upgrade directly\r\n * (e.g., from a shared link or page refresh).\r\n * \r\n * When navigating from within the app, the intercepted modal version is shown instead.\r\n */\r\nexport default async function UpgradePage({\r\n  params,\r\n}: {\r\n  params: Promise<{ locale: string }>\r\n}) {\r\n  const { locale: localeParam } = await params\r\n  const locale = localeParam === \"bg\" ? \"bg\" : \"en\"\r\n  setRequestLocale(locale)\r\n  const t = await getTranslations({ locale, namespace: \"AccountPlansUpgrade\" })\r\n  const supabase = await createClient()\r\n\r\n  if (!supabase) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n\r\n  if (!user) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  // Fetch profile info (public surface) + private billing fields\r\n  const [\r\n    { data: profile },\r\n    { data: privateProfile },\r\n  ] = await Promise.all([\r\n    supabase\r\n      .from('profiles')\r\n      .select(PROFILE_SELECT_FOR_UPGRADE)\r\n      .eq('id', user.id)\r\n      .single(),\r\n    supabase\r\n      .from('private_profiles')\r\n      .select(PRIVATE_PROFILE_SELECT_FOR_UPGRADE)\r\n      .eq('id', user.id)\r\n      .maybeSingle(),\r\n  ])\r\n\r\n  // Fetch subscription plans\r\n  const plans = await getPlansForUpgrade()\r\n\r\n  const currentTier = profile?.tier || 'free'\r\n\r\n  // Map profile to seller interface expected by UpgradeContent\r\n  const commissionRate = privateProfile?.commission_rate == null ? 0 : Number(privateProfile.commission_rate)\r\n  const seller = profile ? {\r\n    id: profile.id,\r\n    tier: profile.tier || 'free',\r\n    commission_rate: commissionRate,\r\n    stripe_customer_id: privateProfile?.stripe_customer_id ?? null,\r\n  } : null\r\n\r\n  return (\r\n    <div className=\"p-4 lg:p-4 max-w-4xl mx-auto\">\r\n      {/* Back Link */}\r\n      <Link\r\n        href=\"/account/plans\"\r\n        className=\"inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground mb-6 transition-colors\"\r\n      >\r\n        <ArrowLeft className=\"size-4\" />\r\n        {t(\"backToPlans\")}\r\n      </Link>\r\n\r\n      {/* Header */}\r\n      <div className=\"text-center mb-8\">\r\n        <h1 className=\"text-2xl font-semibold mb-2\">\r\n          {t(\"title\")}\r\n        </h1>\r\n        <p className=\"text-muted-foreground\">\r\n          {t(\"description\")}\r\n        </p>\r\n      </div>\r\n\r\n      <UpgradeContent\r\n        locale={locale}\r\n        plans={plans as Parameters<typeof UpgradeContent>[0]['plans']}\r\n        currentTier={currentTier}\r\n        seller={seller}\r\n        actions={{ createSubscriptionCheckoutSession }}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\plans\\upgrade\\upgrade-content.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_seller' is defined but never used.","line":61,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":61,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Check, Crown, Buildings, User, SpinnerGap } from \"@phosphor-icons/react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { toast } from \"sonner\"\r\n\r\nexport type UpgradeContentServerActions = {\r\n  createSubscriptionCheckoutSession: (args: {\r\n    planId: string\r\n    billingPeriod: \"monthly\" | \"yearly\"\r\n    locale?: \"en\" | \"bg\"\r\n  }) => Promise<{ url?: string; error?: string }>\r\n}\r\n\r\ntype Json = string | number | boolean | null | { [key: string]: Json | undefined } | Json[]\r\n\r\ninterface SubscriptionPlan {\r\n  id: string\r\n  tier: string\r\n  name: string\r\n  price_monthly: number\r\n  price_yearly: number\r\n  commission_rate: number\r\n  features: Json // Database returns Json type\r\n  stripe_monthly_price_id?: string | null\r\n  stripe_yearly_price_id?: string | null\r\n  is_active: boolean\r\n  // Optional fields from database\r\n  account_type?: string | null\r\n  analytics_access?: string | null\r\n  badge_type?: string | null\r\n  boosts_included?: number | null\r\n  created_at?: string | null\r\n  currency?: string | null\r\n  [key: string]: unknown\r\n}\r\n\r\ninterface Seller {\r\n  id: string\r\n  tier: string | null\r\n  commission_rate: number | null\r\n  [key: string]: unknown\r\n}\r\n\r\ninterface UpgradeContentProps {\r\n  locale: string\r\n  plans: SubscriptionPlan[]\r\n  currentTier: string\r\n  seller: Seller | null\r\n  actions: UpgradeContentServerActions\r\n}\r\n\r\nexport function UpgradeContent({\r\n  locale,\r\n  plans,\r\n  currentTier,\r\n  seller: _seller,\r\n  actions,\r\n}: UpgradeContentProps) {\r\n  const [loadingPlan, setLoadingPlan] = useState<string | null>(null)\r\n  const [billingPeriod, setBillingPeriod] = useState<'monthly' | 'yearly'>('yearly')\r\n\r\n  const formatPrice = (price: number) => {\r\n    return new Intl.NumberFormat(locale, {\r\n      style: 'currency',\r\n      currency: 'EUR',\r\n      minimumFractionDigits: 2,\r\n    }).format(price)\r\n  }\r\n\r\n  const planIcons: Record<string, React.ReactNode> = {\r\n    basic: <User className=\"size-5\" weight=\"duotone\" />,\r\n    premium: <Crown className=\"size-5\" weight=\"duotone\" />,\r\n    business: <Buildings className=\"size-5\" weight=\"duotone\" />,\r\n  }\r\n\r\n  // Filter to only show upgrade options (plans higher than current)\r\n  const tierOrder = ['basic', 'premium', 'business']\r\n  const currentIndex = tierOrder.indexOf(currentTier)\r\n  const upgradePlans = plans.filter(plan => {\r\n    const planIndex = tierOrder.indexOf(plan.tier)\r\n    return planIndex > currentIndex\r\n  })\r\n\r\n  const handleSubscribe = async (plan: SubscriptionPlan) => {\r\n    if (plan.price_monthly === 0) {\r\n      toast.info(locale === 'bg' ? '╨ó╨╛╨▓╨░ ╨╡ ╨▒╨╡╨╖╨┐╨╗╨░╤é╨╡╨╜ ╨┐╨╗╨░╨╜' : 'This is a free plan')\r\n      return\r\n    }\r\n\r\n    setLoadingPlan(plan.id)\r\n    \r\n    try {\r\n      const { url, error } = await actions.createSubscriptionCheckoutSession({\r\n        planId: plan.id,\r\n        billingPeriod,\r\n        locale: locale === 'bg' ? 'bg' : 'en',\r\n      })\r\n\r\n      if (error) {\r\n        throw new Error(error)\r\n      }\r\n\r\n      if (url) {\r\n        window.location.href = url\r\n      }\r\n    } catch (error) {\r\n      console.error('Checkout error:', error)\r\n      toast.error(\r\n        locale === 'bg' \r\n          ? '╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╤ü╤è╨╖╨┤╨░╨▓╨░╨╜╨╡ ╨╜╨░ ╨┐╨╗╨░╤ë╨░╨╜╨╡. ╨£╨╛╨╗╤Å, ╨╛╨┐╨╕╤é╨░╨╣╤é╨╡ ╨╛╤é╨╜╨╛╨▓╨╛.' \r\n          : 'Error creating payment. Please try again.'\r\n      )\r\n    } finally {\r\n      setLoadingPlan(null)\r\n    }\r\n  }\r\n\r\n  if (upgradePlans.length === 0) {\r\n    return (\r\n      <div className=\"text-center py-8\">\r\n        <Crown className=\"size-12 mx-auto mb-4 text-primary\" weight=\"duotone\" />\r\n        <h3 className=\"text-lg font-semibold mb-2\">\r\n          {locale === 'bg' ? '╨Æ╨╕╨╡ ╤ü╤é╨╡ ╨╜╨░ ╨╜╨░╨╣-╨▓╨╕╤ü╨╛╨║╨╕╤Å ╨┐╨╗╨░╨╜!' : \"You're on the highest plan!\"}\r\n        </h3>\r\n        <p className=\"text-muted-foreground\">\r\n          {locale === 'bg' \r\n            ? '╨Æ╨╡╤ç╨╡ ╤ü╨╡ ╨▓╤è╨╖╨┐╨╛╨╗╨╖╨▓╨░╤é╨╡ ╨╛╤é ╨▓╤ü╨╕╤ç╨║╨╕ ╨┐╤Ç╨╡╨┤╨╕╨╝╤ü╤é╨▓╨░.'\r\n            : \"You're already enjoying all the benefits.\"}\r\n        </p>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Current Plan Info */}\r\n      <div className=\"flex items-center justify-center gap-3 p-3 bg-surface-subtle rounded-lg\">\r\n        <span className=\"text-sm text-muted-foreground\">\r\n          {locale === 'bg' ? '╨ó╨╡╨║╤â╤ë ╨┐╨╗╨░╨╜:' : 'Current plan:'}\r\n        </span>\r\n        <Badge variant=\"secondary\" className=\"capitalize\">\r\n          {planIcons[currentTier]}\r\n          <span className=\"ml-1.5\">{currentTier}</span>\r\n        </Badge>\r\n      </div>\r\n\r\n      {/* Billing Toggle */}\r\n      <div className=\"flex justify-center\">\r\n        <div className=\"inline-flex items-center gap-2 bg-muted rounded-lg p-1\">\r\n          <button\r\n            className={cn(\r\n              \"px-4 py-2 rounded-md text-sm font-medium transition-colors\",\r\n              billingPeriod === 'monthly' \r\n                ? \"bg-background text-foreground shadow-sm\" \r\n                : \"text-muted-foreground hover:text-foreground\"\r\n            )}\r\n            onClick={() => setBillingPeriod('monthly')}\r\n          >\r\n            {locale === 'bg' ? '╨£╨╡╤ü╨╡╤ç╨╜╨╛' : 'Monthly'}\r\n          </button>\r\n          <button\r\n            className={cn(\r\n              \"px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2\",\r\n              billingPeriod === 'yearly' \r\n                ? \"bg-background text-foreground shadow-sm\" \r\n                : \"text-muted-foreground hover:text-foreground\"\r\n            )}\r\n            onClick={() => setBillingPeriod('yearly')}\r\n          >\r\n            {locale === 'bg' ? '╨ô╨╛╨┤╨╕╤ê╨╜╨╛' : 'Yearly'}\r\n            <Badge variant=\"secondary\" className=\"text-xs bg-selected text-primary\">\r\n              -17%\r\n            </Badge>\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Upgrade Plans */}\r\n      <div className={cn(\r\n        \"grid gap-4\",\r\n        upgradePlans.length === 1 ? \"grid-cols-1 max-w-md mx-auto\" : \"grid-cols-1 md:grid-cols-2\"\r\n      )}>\r\n        {upgradePlans.map((plan) => {\r\n          const features = plan.features as string[]\r\n          const isLoading = loadingPlan === plan.id\r\n          const price = billingPeriod === 'monthly' ? plan.price_monthly : plan.price_yearly\r\n          const isRecommended = plan.tier === 'premium'\r\n\r\n          return (\r\n            <Card \r\n              key={plan.id} \r\n              className={cn(\r\n                \"relative\",\r\n                isRecommended && \"border-2 border-primary\"\r\n              )}\r\n            >\r\n              {isRecommended && (\r\n                <div className=\"absolute -top-3 left-1/2 -translate-x-1/2\">\r\n                  <Badge className=\"bg-primary text-primary-foreground\">\r\n                    {locale === 'bg' ? '╨ƒ╤Ç╨╡╨┐╨╛╤Ç╤è╤ç╨░╨╜╨╛' : 'Recommended'}\r\n                  </Badge>\r\n                </div>\r\n              )}\r\n              \r\n              <CardHeader className=\"text-center pb-2\">\r\n                <div className=\"mx-auto mb-2 p-2.5 rounded-full bg-muted text-foreground\">\r\n                  {planIcons[plan.tier]}\r\n                </div>\r\n                <CardTitle className=\"text-lg\">{plan.name}</CardTitle>\r\n              </CardHeader>\r\n\r\n              <CardContent className=\"space-y-4\">\r\n                {/* Price */}\r\n                <div className=\"text-center\">\r\n                  <div className=\"flex items-baseline justify-center gap-1\">\r\n                    <span className=\"text-2xl font-semibold\">{formatPrice(price)}</span>\r\n                    <span className=\"text-muted-foreground text-sm\">\r\n                      /{billingPeriod === 'monthly' \r\n                        ? (locale === 'bg' ? '╨╝╨╡╤ü╨╡╤å' : 'mo')\r\n                        : (locale === 'bg' ? '╨│╨╛╨┤╨╕╨╜╨░' : 'yr')\r\n                      }\r\n                    </span>\r\n                  </div>\r\n                  {billingPeriod === 'yearly' && (\r\n                    <p className=\"text-xs text-muted-foreground mt-1\">\r\n                      <span className=\"line-through\">{formatPrice(plan.price_monthly * 12)}</span>\r\n                      <span className=\"text-primary ml-1\">\r\n                        {locale === 'bg' ? '╤ü╨┐╨╡╤ü╤é╤Å╨▓╨░╤ê' : 'save'} {formatPrice(plan.price_monthly * 12 - plan.price_yearly)}\r\n                      </span>\r\n                    </p>\r\n                  )}\r\n                </div>\r\n\r\n                {/* Commission Rate */}\r\n                <div className=\"bg-muted rounded-md p-2.5 text-center\">\r\n                  <span className=\"text-xl font-semibold text-foreground\">{plan.commission_rate}%</span>\r\n                  <span className=\"text-xs text-muted-foreground ml-1.5\">\r\n                    {locale === 'bg' ? '╨║╨╛╨╝╨╕╤ü╨╕╨╛╨╜' : 'commission'}\r\n                  </span>\r\n                </div>\r\n\r\n                {/* Features (condensed) */}\r\n                <ul className=\"space-y-1.5\">\r\n                  {features.slice(0, 4).map((feature: string, index: number) => (\r\n                    <li key={index} className=\"flex items-start gap-2 text-sm\">\r\n                      <Check className=\"size-4 text-primary mt-0.5 shrink-0\" weight=\"bold\" />\r\n                      <span className=\"line-clamp-1\">{feature}</span>\r\n                    </li>\r\n                  ))}\r\n                  {features.length > 4 && (\r\n                    <li className=\"text-xs text-muted-foreground text-center pt-1\">\r\n                      +{features.length - 4} {locale === 'bg' ? '╨╛╤ë╨╡' : 'more'}\r\n                    </li>\r\n                  )}\r\n                </ul>\r\n\r\n                {/* CTA Button */}\r\n                <Button\r\n                  className=\"w-full bg-primary hover:bg-interactive-hover\"\r\n                  disabled={isLoading}\r\n                  onClick={() => handleSubscribe(plan)}\r\n                >\r\n                  {isLoading ? (\r\n                    <SpinnerGap className=\"size-4 animate-spin\" />\r\n                  ) : (\r\n                    locale === 'bg' ? '╨¥╨░╨┤╨│╤Ç╨░╨┤╨╕ ╤ü╨╡╨│╨░' : 'Upgrade Now'\r\n                  )}\r\n                </Button>\r\n              </CardContent>\r\n            </Card>\r\n          )\r\n        })}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\profile\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\profile\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/profile' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":5,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":12,"endColumn":31},{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/username' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":13,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":21,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/lib/supabase/server\"\r\nimport { redirect } from \"@/i18n/routing\"\r\nimport { getTranslations } from \"next-intl/server\"\r\nimport { ProfileContent } from \"./profile-content\"\r\nimport {\r\n  deleteAvatar,\r\n  setAvatarUrl,\r\n  updateEmail,\r\n  updatePassword,\r\n  updateProfile,\r\n  uploadAvatar,\r\n} from \"@/app/actions/profile\"\r\nimport {\r\n  checkUsernameAvailability,\r\n  downgradeToPersonalAccount,\r\n  getUsernameChangeCooldown,\r\n  setUsername,\r\n  updatePublicProfile,\r\n  upgradeToBusinessAccount,\r\n  uploadBanner,\r\n} from \"@/app/actions/username\"\r\n\r\ninterface ProfilePageProps {\r\n  params: Promise<{\r\n    locale: string\r\n  }>\r\n}\r\n\r\nexport default async function ProfilePage({ params }: ProfilePageProps) {\r\n  const { locale: localeParam } = await params\r\n  const locale = localeParam === \"bg\" ? \"bg\" : \"en\"\r\n  const t = await getTranslations({ locale, namespace: \"Account\" })\r\n  const supabase = await createClient()\r\n\r\n  if (!supabase) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  const {\r\n    data: { user },\r\n  } = await supabase.auth.getUser()\r\n\r\n  if (!user) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  // Fetch profile data (public surface) + private PII fields\r\n  const [\r\n    { data: profileRaw },\r\n    { data: privateProfile },\r\n  ] = await Promise.all([\r\n    supabase\r\n      .from(\"profiles\")\r\n      .select(`\r\n        id,\r\n        full_name,\r\n        avatar_url,\r\n        shipping_region,\r\n        country_code,\r\n        role,\r\n        created_at,\r\n        username,\r\n        display_name,\r\n        bio,\r\n        banner_url,\r\n        location,\r\n        website_url,\r\n        social_links,\r\n        account_type,\r\n        is_seller,\r\n        is_verified_business,\r\n        business_name,\r\n        last_username_change,\r\n        tier\r\n      `)\r\n      .eq(\"id\", user.id)\r\n      .single(),\r\n    supabase\r\n      .from(\"private_profiles\")\r\n      .select(\"email, phone, vat_number\")\r\n      .eq(\"id\", user.id)\r\n      .maybeSingle(),\r\n  ])\r\n\r\n  // Transform social_links from Json to Record<string, string>\r\n  const profileData = profileRaw ? {\r\n    ...profileRaw,\r\n    email: privateProfile?.email ?? user.email ?? \"\",\r\n    phone: privateProfile?.phone ?? null,\r\n    vat_number: privateProfile?.vat_number ?? null,\r\n    social_links: profileRaw.social_links && typeof profileRaw.social_links === 'object' && !Array.isArray(profileRaw.social_links)\r\n      ? profileRaw.social_links as Record<string, string>\r\n      : null,\r\n  } : null\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 md:gap-4\">\r\n      <h1 className=\"sr-only\">{t(\"header.profile\")}</h1>\r\n      <ProfileContent\r\n        locale={locale}\r\n        profile={profileData || {\r\n          id: user.id,\r\n          email: user.email || \"\",\r\n          full_name: null,\r\n          avatar_url: null,\r\n          phone: null,\r\n          shipping_region: null,\r\n          country_code: null,\r\n          role: \"buyer\",\r\n          created_at: user.created_at,\r\n          username: null,\r\n          display_name: null,\r\n          bio: null,\r\n          banner_url: null,\r\n          location: null,\r\n          website_url: null,\r\n          social_links: null,\r\n          account_type: \"personal\",\r\n          is_seller: false,\r\n          is_verified_business: false,\r\n          business_name: null,\r\n          vat_number: null,\r\n          last_username_change: null,\r\n          tier: \"free\",\r\n        }}\r\n        profileActions={{\r\n          updateProfile,\r\n          uploadAvatar,\r\n          deleteAvatar,\r\n          setAvatarUrl,\r\n          updateEmail,\r\n          updatePassword,\r\n        }}\r\n        publicProfileActions={{\r\n          setUsername,\r\n          updatePublicProfile,\r\n          uploadBanner,\r\n          upgradeToBusinessAccount,\r\n          downgradeToPersonalAccount,\r\n          checkUsernameAvailability,\r\n          getUsernameChangeCooldown,\r\n        }}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\profile\\profile-content.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":119,"column":5,"nodeType":"JSXOpeningElement","endLine":127,"endColumn":7},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 49 to the 25 allowed.","line":131,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":131,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef, useTransition } from \"react\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Field, FieldContent, FieldError, FieldLabel } from \"@/components/shared/field\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\"\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\nimport {\r\n  User,\r\n  Camera,\r\n  Envelope,\r\n  Key, \r\n  SpinnerGap,\r\n  Eye,\r\n  EyeSlash,\r\n  CheckCircle,\r\n  Trash,\r\n  MapPin,\r\n  Phone,\r\n  Globe,\r\n  UserCircle,\r\n  GearSix,\r\n} from \"@phosphor-icons/react\"\r\nimport { toast } from \"sonner\"\r\nimport { validatePassword, validateEmail } from \"@/lib/validation/auth\"\r\nimport { PublicProfileEditor, type PublicProfileEditorServerActions } from \"./public-profile-editor\"\r\nimport { UserAvatar } from \"@/components/shared/user-avatar\"\r\n\r\nexport type ProfileContentServerActions = {\r\n  updateProfile: (formData: FormData) => Promise<{ success: boolean; error?: string }>\r\n  uploadAvatar: (formData: FormData) => Promise<{\r\n    success: boolean\r\n    avatarUrl?: string\r\n    error?: string\r\n  }>\r\n  deleteAvatar: () => Promise<{ success: boolean; error?: string }>\r\n  setAvatarUrl: (formData: FormData) => Promise<{\r\n    success: boolean\r\n    avatarUrl?: string\r\n    error?: string\r\n  }>\r\n  updateEmail: (formData: FormData) => Promise<{ success: boolean; error?: string }>\r\n  updatePassword: (formData: FormData) => Promise<{ success: boolean; error?: string }>\r\n}\r\n\r\ninterface ProfileContentProps {\r\n  locale: string\r\n  profile: {\r\n    id: string\r\n    email: string | null\r\n    full_name: string | null\r\n    avatar_url: string | null\r\n    phone: string | null\r\n    shipping_region: string | null\r\n    country_code: string | null\r\n    role: string | null\r\n    created_at: string | null\r\n    // New unified profile fields\r\n    username: string | null\r\n    display_name: string | null\r\n    bio: string | null\r\n    banner_url: string | null\r\n    location: string | null\r\n    website_url: string | null\r\n    social_links: Record<string, string> | null\r\n    account_type: string | null\r\n    is_seller: boolean | null\r\n    is_verified_business: boolean | null\r\n    business_name: string | null\r\n    vat_number: string | null\r\n    last_username_change: string | null\r\n    tier?: string | null\r\n  }\r\n  profileActions: ProfileContentServerActions\r\n  publicProfileActions: PublicProfileEditorServerActions\r\n}\r\n\r\nconst SHIPPING_REGIONS = [\r\n  { value: \"BG\", label: \"Bulgaria\", labelBg: \"╨æ╤è╨╗╨│╨░╤Ç╨╕╤Å\" },\r\n  { value: \"UK\", label: \"United Kingdom\", labelBg: \"╨₧╨▒╨╡╨┤╨╕╨╜╨╡╨╜╨╛ ╨║╤Ç╨░╨╗╤ü╤é╨▓╨╛\" },\r\n  { value: \"EU\", label: \"Europe\", labelBg: \"╨ò╨▓╤Ç╨╛╨┐╨░\" },\r\n  { value: \"US\", label: \"United States\", labelBg: \"╨í╨É╨⌐\" },\r\n  { value: \"WW\", label: \"Worldwide\", labelBg: \"╨ª╨╡╨╗╨╕╤Å╤é ╤ü╨▓╤Å╤é\" },\r\n]\r\n\r\n// Format: boring-avatar:variant:paletteIndex:seed\r\n// Variants: marble, beam, pixel, sunset, ring, bauhaus\r\n// Palettes: 0-5 (see lib/avatar-palettes.ts)\r\nconst PRESET_AVATARS = [\r\n  \"boring-avatar:marble:0:Nova\",\r\n  \"boring-avatar:beam:1:Riley\",\r\n  \"boring-avatar:sunset:2:Kai\",\r\n  \"boring-avatar:bauhaus:3:Zoe\",\r\n  \"boring-avatar:ring:4:Max\",\r\n  \"boring-avatar:pixel:5:Luna\",\r\n  \"boring-avatar:marble:1:Aria\",\r\n  \"boring-avatar:beam:2:Theo\",\r\n]\r\n\r\nfunction AvatarImg({ src, alt, size, className }: { src: string; alt: string; size: number; className?: string }) {\r\n  return (\r\n    <img\r\n      src={src}\r\n      alt={alt}\r\n      width={size}\r\n      height={size}\r\n      loading=\"lazy\"\r\n      decoding=\"async\"\r\n      className={className}\r\n    />\r\n  )\r\n}\r\n\r\nexport function ProfileContent({\r\n  locale,\r\n  profile,\r\n  profileActions,\r\n  publicProfileActions,\r\n}: ProfileContentProps) {\r\n  const tAuth = useTranslations(\"Auth\")\r\n  const [isPending, startTransition] = useTransition()\r\n  const [isChangePasswordOpen, setIsChangePasswordOpen] = useState(false)\r\n  const [isChangeEmailOpen, setIsChangeEmailOpen] = useState(false)\r\n  const [showNewPassword, setShowNewPassword] = useState(false)\r\n  const [avatarPreview, setAvatarPreview] = useState<string | null>(profile.avatar_url)\r\n  const [isUploadingAvatar, setIsUploadingAvatar] = useState(false)\r\n  const fileInputRef = useRef<HTMLInputElement>(null)\r\n  \r\n  const [profileData, setProfileData] = useState({\r\n    full_name: profile.full_name || \"\",\r\n    phone: profile.phone || \"\",\r\n    shipping_region: profile.shipping_region || \"\",\r\n    country_code: profile.country_code || \"\",\r\n  })\r\n\r\n  const [passwordData, setPasswordData] = useState({\r\n    currentPassword: \"\",\r\n    newPassword: \"\",\r\n    confirmPassword: \"\"\r\n  })\r\n  \r\n  const [emailData, setEmailData] = useState({\r\n    newEmail: \"\",\r\n  })\r\n\r\n  // Handle profile update\r\n  const handleProfileUpdate = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    \r\n    const formData = new FormData()\r\n    formData.set(\"full_name\", profileData.full_name)\r\n    formData.set(\"phone\", profileData.phone)\r\n    formData.set(\"shipping_region\", profileData.shipping_region)\r\n    formData.set(\"country_code\", profileData.country_code)\r\n\r\n    startTransition(async () => {\r\n      const result = await profileActions.updateProfile(formData)\r\n      if (result.success) {\r\n        toast.success(locale === \"bg\" ? \"╨ƒ╤Ç╨╛╤ä╨╕╨╗╤è╤é ╨╡ ╨╛╨▒╨╜╨╛╨▓╨╡╨╜ ╤â╤ü╨┐╨╡╤ê╨╜╨╛\" : \"Profile updated successfully\")\r\n      } else {\r\n        toast.error(result.error || (locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨╛╨▒╨╜╨╛╨▓╤Å╨▓╨░╨╜╨╡\" : \"Error updating profile\"))\r\n      }\r\n    })\r\n  }\r\n\r\n  // Handle avatar upload\r\n  const handleAvatarChange = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0]\r\n    if (!file) return\r\n\r\n    // Preview\r\n    const reader = new FileReader()\r\n    reader.onloadend = () => {\r\n      setAvatarPreview(reader.result as string)\r\n    }\r\n    reader.readAsDataURL(file)\r\n\r\n    // Upload\r\n    setIsUploadingAvatar(true)\r\n    const formData = new FormData()\r\n    formData.set(\"avatar\", file)\r\n\r\n    const result = await profileActions.uploadAvatar(formData)\r\n    setIsUploadingAvatar(false)\r\n\r\n    if (result.success) {\r\n      setAvatarPreview(result.avatarUrl || null)\r\n      toast.success(locale === \"bg\" ? \"╨É╨▓╨░╤é╨░╤Ç╤è╤é ╨╡ ╨║╨░╤ç╨╡╨╜ ╤â╤ü╨┐╨╡╤ê╨╜╨╛\" : \"Avatar uploaded successfully\")\r\n    } else {\r\n      setAvatarPreview(profile.avatar_url)\r\n      toast.error(result.error || (locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨║╨░╤ç╨▓╨░╨╜╨╡\" : \"Error uploading avatar\"))\r\n    }\r\n  }\r\n\r\n  // Handle avatar delete\r\n  const handleDeleteAvatar = async () => {\r\n    setIsUploadingAvatar(true)\r\n    const result = await profileActions.deleteAvatar()\r\n    setIsUploadingAvatar(false)\r\n\r\n    if (result.success) {\r\n      setAvatarPreview(null)\r\n      toast.success(locale === \"bg\" ? \"╨É╨▓╨░╤é╨░╤Ç╤è╤é ╨╡ ╨┐╤Ç╨╡╨╝╨░╤à╨╜╨░╤é\" : \"Avatar removed\")\r\n    } else {\r\n      toast.error(result.error || (locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨┐╤Ç╨╡╨╝╨░╤à╨▓╨░╨╜╨╡\" : \"Error removing avatar\"))\r\n    }\r\n  }\r\n\r\n  const handleChoosePresetAvatar = (url: string) => {\r\n    setAvatarPreview(url)\r\n    setIsUploadingAvatar(true)\r\n\r\n    const formData = new FormData()\r\n    formData.set(\"avatar_url\", url)\r\n\r\n    startTransition(async () => {\r\n      const result = await profileActions.setAvatarUrl(formData)\r\n      setIsUploadingAvatar(false)\r\n\r\n      if (result.success) {\r\n        setAvatarPreview(result.avatarUrl || url)\r\n        toast.success(locale === \"bg\" ? \"╨É╨▓╨░╤é╨░╤Ç╤è╤é ╨╡ ╨╛╨▒╨╜╨╛╨▓╨╡╨╜\" : \"Avatar updated\")\r\n      } else {\r\n        setAvatarPreview(profile.avatar_url)\r\n        toast.error(result.error || (locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨╛╨▒╨╜╨╛╨▓╤Å╨▓╨░╨╜╨╡\" : \"Error updating avatar\"))\r\n      }\r\n    })\r\n  }\r\n\r\n  // Handle email change\r\n  const handleChangeEmail = async () => {\r\n    const emailValidation = validateEmail(emailData.newEmail)\r\n    if (!emailValidation.valid) {\r\n      toast.error(tAuth(emailValidation.error as never))\r\n      return\r\n    }\r\n\r\n    const formData = new FormData()\r\n    formData.set(\"email\", emailData.newEmail)\r\n\r\n    startTransition(async () => {\r\n      const result = await profileActions.updateEmail(formData)\r\n      if (result.success) {\r\n        toast.success(\r\n          locale === \"bg\" \r\n            ? \"╨ÿ╨╖╨┐╤Ç╨░╤é╨╡╨╜ ╨╡ ╨╕╨╝╨╡╨╣╨╗ ╨╖╨░ ╨┐╨╛╤é╨▓╤è╤Ç╨╢╨┤╨╡╨╜╨╕╨╡ ╨╜╨░ ╨╜╨╛╨▓╨╕╤Å ╨░╨┤╤Ç╨╡╤ü\" \r\n            : \"A confirmation email has been sent to your new address\"\r\n        )\r\n        setIsChangeEmailOpen(false)\r\n        setEmailData({ newEmail: \"\" })\r\n      } else {\r\n        toast.error(result.error || (locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨┐╤Ç╨╛╨╝╤Å╨╜╨░ ╨╜╨░ ╨╕╨╝╨╡╨╣╨╗╨░\" : \"Error changing email\"))\r\n      }\r\n    })\r\n  }\r\n\r\n  // Handle password change\r\n  const handleChangePassword = async () => {\r\n    const passwordValidation = validatePassword(passwordData.newPassword)\r\n    if (!passwordValidation.valid) {\r\n      toast.error(tAuth(passwordValidation.errors[0] as never))\r\n      return\r\n    }\r\n\r\n    if (passwordData.newPassword !== passwordData.confirmPassword) {\r\n      toast.error(tAuth(\"passwordsDoNotMatch\"))\r\n      return\r\n    }\r\n\r\n    const formData = new FormData()\r\n    formData.set(\"currentPassword\", passwordData.currentPassword)\r\n    formData.set(\"newPassword\", passwordData.newPassword)\r\n    formData.set(\"confirmPassword\", passwordData.confirmPassword)\r\n\r\n    startTransition(async () => {\r\n      const result = await profileActions.updatePassword(formData)\r\n      if (result.success) {\r\n        toast.success(locale === \"bg\" ? \"╨ƒ╨░╤Ç╨╛╨╗╨░╤é╨░ ╨╡ ╨┐╤Ç╨╛╨╝╨╡╨╜╨╡╨╜╨░ ╤â╤ü╨┐╨╡╤ê╨╜╨╛\" : \"Password changed successfully\")\r\n        setIsChangePasswordOpen(false)\r\n        setPasswordData({ currentPassword: \"\", newPassword: \"\", confirmPassword: \"\" })\r\n      } else {\r\n        toast.error(result.error || (locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨┐╤Ç╨╛╨╝╤Å╨╜╨░ ╨╜╨░ ╨┐╨░╤Ç╨╛╨╗╨░╤é╨░\" : \"Error changing password\"))\r\n      }\r\n    })\r\n  }\r\n\r\n  // Password strength indicator\r\n  const getPasswordStrength = (password: string) => {\r\n    if (password.length === 0) return null\r\n    \r\n    const hasUpper = /[A-Z]/.test(password)\r\n    const hasLower = /[a-z]/.test(password)\r\n    const hasNumber = /[0-9]/.test(password)\r\n    const hasSpecial = /[^a-zA-Z0-9]/.test(password)\r\n    \r\n    let score = 0\r\n    if (password.length >= 8) score++\r\n    if (password.length >= 12) score++\r\n    if (hasUpper && hasLower) score++\r\n    if (hasNumber) score++\r\n    if (hasSpecial) score++\r\n    \r\n    if (score <= 2) return { label: locale === \"bg\" ? \"╨í╨╗╨░╨▒╨░\" : \"Weak\", color: \"bg-destructive\", width: \"w-1/4\" }\r\n    if (score === 3) return { label: locale === \"bg\" ? \"╨í╤Ç╨╡╨┤╨╜╨░\" : \"Fair\", color: \"bg-warning\", width: \"w-2/4\" }\r\n    if (score === 4) return { label: locale === \"bg\" ? \"╨ö╨╛╨▒╤Ç╨░\" : \"Good\", color: \"bg-info\", width: \"w-3/4\" }\r\n    return { label: locale === \"bg\" ? \"╨í╨╕╨╗╨╜╨░\" : \"Strong\", color: \"bg-success\", width: \"w-full\" }\r\n  }\r\n\r\n  const passwordStrength = getPasswordStrength(passwordData.newPassword)\r\n  const isPasswordValid = validatePassword(passwordData.newPassword).valid\r\n\r\n  return (\r\n    <Tabs defaultValue=\"account\" className=\"space-y-6\">\r\n      <TabsList className=\"max-w-md\">\r\n        <TabsTrigger value=\"account\" className=\"flex-1 gap-2\">\r\n          <GearSix className=\"size-4\" />\r\n          {locale === \"bg\" ? \"╨É╨║╨░╤â╨╜╤é\" : \"Account\"}\r\n        </TabsTrigger>\r\n        <TabsTrigger value=\"public\" className=\"flex-1 gap-2\">\r\n          <UserCircle className=\"size-4\" />\r\n          {locale === \"bg\" ? \"╨ƒ╤â╨▒╨╗╨╕╤ç╨╡╨╜ ╨┐╤Ç╨╛╤ä╨╕╨╗\" : \"Public Profile\"}\r\n        </TabsTrigger>\r\n      </TabsList>\r\n      \r\n      {/* Public Profile Tab */}\r\n      <TabsContent value=\"public\" className=\"space-y-6 mt-0\">\r\n        <PublicProfileEditor \r\n          locale={locale} \r\n          actions={publicProfileActions}\r\n          profile={{\r\n            id: profile.id,\r\n            username: profile.username,\r\n            display_name: profile.display_name,\r\n            bio: profile.bio,\r\n            banner_url: profile.banner_url,\r\n            location: profile.location,\r\n            website_url: profile.website_url,\r\n            social_links: profile.social_links,\r\n            account_type: profile.account_type === \"business\" ? \"business\" : profile.account_type === \"personal\" ? \"personal\" : null,\r\n            is_seller: profile.is_seller ?? false,\r\n            verified_business: profile.is_verified_business ?? false,\r\n            business_name: profile.business_name,\r\n            vat_number: profile.vat_number,\r\n            last_username_change: profile.last_username_change,\r\n          }} \r\n        />\r\n      </TabsContent>\r\n      \r\n      {/* Account Settings Tab */}\r\n      <TabsContent value=\"account\" className=\"space-y-6 mt-0\">\r\n      {/* Avatar & Basic Info Card */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg\">{locale === \"bg\" ? \"╨ƒ╤Ç╨╛╤ä╨╕╨╗╨╜╨░ ╤ü╨╜╨╕╨╝╨║╨░\" : \"Profile Picture\"}</CardTitle>\r\n          <CardDescription>\r\n            {locale === \"bg\" \r\n              ? \"╨Ü╨░╤ç╨╡╤é╨╡ ╤ü╨╜╨╕╨╝╨║╨░ ╨╖╨░ ╨▓╨░╤ê╨╕╤Å ╨┐╤Ç╨╛╤ä╨╕╨╗. ╨£╨░╨║╤ü╨╕╨╝╨░╨╗╨╡╨╜ ╤Ç╨░╨╖╨╝╨╡╤Ç: 5MB\" \r\n              : \"Upload a picture for your profile. Max size: 5MB\"}\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"relative\">\r\n              <div className=\"size-24 rounded-full overflow-hidden border-2 border-muted\">\r\n                <UserAvatar\r\n                  name={profile.full_name || profile.email || \"User\"}\r\n                  avatarUrl={avatarPreview}\r\n                  className=\"size-24 bg-muted\"\r\n                  fallbackClassName=\"bg-muted text-muted-foreground text-2xl font-bold\"\r\n                />\r\n                {isUploadingAvatar && (\r\n                  <div className=\"absolute inset-0 bg-background/80 flex items-center justify-center rounded-full\">\r\n                    <SpinnerGap className=\"size-6 animate-spin\" />\r\n                  </div>\r\n                )}\r\n              </div>\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => fileInputRef.current?.click()}\r\n                disabled={isUploadingAvatar}\r\n                className=\"absolute -bottom-1 -right-1 size-8 rounded-full bg-primary text-primary-foreground flex items-center justify-center shadow-md hover:bg-interactive-hover transition-colors\"\r\n              >\r\n                <Camera className=\"size-4\" weight=\"fill\" />\r\n              </button>\r\n              <input\r\n                ref={fileInputRef}\r\n                type=\"file\"\r\n                accept=\"image/jpeg,image/png,image/webp,image/gif\"\r\n                onChange={handleAvatarChange}\r\n                className=\"hidden\"\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <p className=\"text-sm font-medium\">{profile.full_name || profile.email}</p>\r\n              <p className=\"text-xs text-muted-foreground capitalize\">{profile.role}</p>\r\n              {avatarPreview && (\r\n                <Button \r\n                  variant=\"outline\" \r\n                  size=\"sm\"\r\n                  onClick={handleDeleteAvatar}\r\n                  disabled={isUploadingAvatar}\r\n                >\r\n                  <Trash className=\"size-4 mr-1.5\" />\r\n                  {locale === \"bg\" ? \"╨ƒ╤Ç╨╡╨╝╨░╤à╨╜╨╕\" : \"Remove\"}\r\n                </Button>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-5\">\r\n            <p className=\"text-sm font-medium\">\r\n              {locale === \"bg\" ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╕ ╨░╨▓╨░╤é╨░╤Ç\" : \"Choose an avatar\"}\r\n            </p>\r\n            <p className=\"text-xs text-muted-foreground mt-1\">\r\n              {locale === \"bg\" ? \"╨æ╤è╤Ç╨╖ ╨╕╨╖╨▒╨╛╤Ç ╨▒╨╡╨╖ ╨║╨░╤ç╨▓╨░╨╜╨╡\" : \"Quick pick without uploading\"}\r\n            </p>\r\n\r\n            <div className=\"mt-3 grid grid-cols-4 sm:grid-cols-8 gap-2\">\r\n              {PRESET_AVATARS.map((url) => (\r\n                <button\r\n                  key={url}\r\n                  type=\"button\"\r\n                  onClick={() => handleChoosePresetAvatar(url)}\r\n                  disabled={isUploadingAvatar}\r\n                  className=\"size-10 rounded-full overflow-hidden border bg-muted hover:bg-hover active:bg-active transition-colors disabled:opacity-50\"\r\n                  aria-label={locale === \"bg\" ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╕ ╤é╨╛╨╖╨╕ ╨░╨▓╨░╤é╨░╤Ç\" : \"Choose this avatar\"}\r\n                >\r\n                  {/* Render UserAvatar for boring-avatar presets, fallback to AvatarImg for legacy URLs */}\r\n                  {url.startsWith(\"boring-avatar:\") ? (\r\n                    <UserAvatar\r\n                      name={profile.full_name || profile.email || \"User\"}\r\n                      avatarUrl={url}\r\n                      size=\"sm\"\r\n                      className=\"size-full\"\r\n                      fallbackClassName=\"bg-muted text-muted-foreground text-xs font-bold\"\r\n                    />\r\n                  ) : (\r\n                    <AvatarImg src={url} alt=\"\" size={40} className=\"size-full object-cover\" />\r\n                  )}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Profile Info Card */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg\">{locale === \"bg\" ? \"╨¢╨╕╤ç╨╜╨░ ╨╕╨╜╤ä╨╛╤Ç╨╝╨░╤å╨╕╤Å\" : \"Personal Information\"}</CardTitle>\r\n          <CardDescription>\r\n            {locale === \"bg\" \r\n              ? \"╨É╨║╤é╤â╨░╨╗╨╕╨╖╨╕╤Ç╨░╨╣╤é╨╡ ╨╕╨╜╤ä╨╛╤Ç╨╝╨░╤å╨╕╤Å╤é╨░ ╨╖╨░ ╨▓╨░╤ê╨╕╤Å ╨┐╤Ç╨╛╤ä╨╕╨╗\" \r\n              : \"Update your profile information\"}\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <form onSubmit={handleProfileUpdate} className=\"space-y-4\">\r\n            <div className=\"grid gap-4 sm:grid-cols-2\">\r\n              <Field>\r\n                <FieldContent>\r\n                  <FieldLabel htmlFor=\"full_name\">\r\n                    <User className=\"size-4 inline mr-1.5\" />\r\n                    {locale === \"bg\" ? \"╨ÿ╨╝╨╡\" : \"Full Name\"}\r\n                  </FieldLabel>\r\n                  <Input\r\n                    id=\"full_name\"\r\n                    name=\"full_name\"\r\n                    value={profileData.full_name}\r\n                    onChange={(e) =>\r\n                      setProfileData((prev) => ({\r\n                        ...prev,\r\n                        full_name: e.target.value,\r\n                      }))\r\n                    }\r\n                    placeholder={locale === \"bg\" ? \"╨Æ╨░╤ê╨╡╤é╨╛ ╨╕╨╝╨╡\" : \"Your name\"}\r\n                  />\r\n                </FieldContent>\r\n              </Field>\r\n              <Field>\r\n                <FieldContent>\r\n                  <FieldLabel htmlFor=\"phone\">\r\n                    <Phone className=\"size-4 inline mr-1.5\" />\r\n                    {locale === \"bg\" ? \"╨ó╨╡╨╗╨╡╤ä╨╛╨╜\" : \"Phone\"}\r\n                  </FieldLabel>\r\n                  <Input\r\n                    id=\"phone\"\r\n                    name=\"phone\"\r\n                    type=\"tel\"\r\n                    value={profileData.phone}\r\n                    onChange={(e) =>\r\n                      setProfileData((prev) => ({ ...prev, phone: e.target.value }))\r\n                    }\r\n                    placeholder=\"+359 888 123 456\"\r\n                  />\r\n                </FieldContent>\r\n              </Field>\r\n            </div>\r\n\r\n            <div className=\"grid gap-4 sm:grid-cols-2\">\r\n              <Field>\r\n                <FieldContent>\r\n                  <FieldLabel htmlFor=\"shipping_region\">\r\n                    <MapPin className=\"size-4 inline mr-1.5\" />\r\n                    {locale === \"bg\" ? \"╨á╨╡╨│╨╕╨╛╨╜ ╨╖╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░\" : \"Shipping Region\"}\r\n                  </FieldLabel>\r\n                  <Select\r\n                    value={profileData.shipping_region}\r\n                    onValueChange={(value) =>\r\n                      setProfileData((prev) => ({ ...prev, shipping_region: value }))\r\n                    }\r\n                  >\r\n                    <SelectTrigger id=\"shipping_region\">\r\n                      <SelectValue\r\n                        placeholder={\r\n                          locale === \"bg\" ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╤Ç╨╡╨│╨╕╨╛╨╜\" : \"Select region\"\r\n                        }\r\n                      />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {SHIPPING_REGIONS.map((region) => (\r\n                        <SelectItem key={region.value} value={region.value}>\r\n                          {locale === \"bg\" ? region.labelBg : region.label}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </FieldContent>\r\n              </Field>\r\n              <Field>\r\n                <FieldContent>\r\n                  <FieldLabel htmlFor=\"country_code\">\r\n                    <Globe className=\"size-4 inline mr-1.5\" />\r\n                    {locale === \"bg\" ? \"╨ö╤è╤Ç╨╢╨░╨▓╨░\" : \"Country Code\"}\r\n                  </FieldLabel>\r\n                  <Input\r\n                    id=\"country_code\"\r\n                    name=\"country_code\"\r\n                    value={profileData.country_code}\r\n                    onChange={(e) =>\r\n                      setProfileData((prev) => ({\r\n                        ...prev,\r\n                        country_code: e.target.value.toUpperCase().slice(0, 2),\r\n                      }))\r\n                    }\r\n                    placeholder=\"BG\"\r\n                    maxLength={2}\r\n                  />\r\n                </FieldContent>\r\n              </Field>\r\n            </div>\r\n\r\n            <Button type=\"submit\" disabled={isPending} className=\"w-full sm:w-auto\">\r\n              {isPending ? (\r\n                <>\r\n                  <SpinnerGap className=\"size-4 mr-2 animate-spin\" />\r\n                  {locale === \"bg\" ? \"╨ù╨░╨┐╨░╨╖╨▓╨░╨╜╨╡...\" : \"Saving...\"}\r\n                </>\r\n              ) : (\r\n                locale === \"bg\" ? \"╨ù╨░╨┐╨░╨╖╨╕ ╨┐╤Ç╨╛╨╝╨╡╨╜╨╕╤é╨╡\" : \"Save Changes\"\r\n              )}\r\n            </Button>\r\n          </form>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Security Card */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg\">{locale === \"bg\" ? \"╨í╨╕╨│╤â╤Ç╨╜╨╛╤ü╤é\" : \"Security\"}</CardTitle>\r\n          <CardDescription>\r\n            {locale === \"bg\" \r\n              ? \"╨ú╨┐╤Ç╨░╨▓╨╗╤Å╨▓╨░╨╣╤é╨╡ ╨╕╨╝╨╡╨╣╨╗╨░ ╨╕ ╨┐╨░╤Ç╨╛╨╗╨░╤é╨░ ╨╜╨░ ╨░╨║╨░╤â╨╜╤é╨░\" \r\n              : \"Manage your account email and password\"}\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-4\">\r\n          {/* Email Row */}\r\n          <button\r\n            onClick={() => setIsChangeEmailOpen(true)}\r\n            className=\"w-full flex items-center gap-3 p-3 rounded-lg border bg-card hover:bg-hover active:bg-active text-left transition-colors\"\r\n          >\r\n            <div className=\"flex size-10 items-center justify-center rounded-full bg-muted\">\r\n              <Envelope className=\"size-5 text-muted-foreground\" />\r\n            </div>\r\n            <div className=\"flex-1 min-w-0\">\r\n              <p className=\"text-sm font-medium\">{locale === \"bg\" ? \"╨ÿ╨╝╨╡╨╣╨╗\" : \"Email\"}</p>\r\n              <p className=\"text-xs text-muted-foreground truncate\">{profile.email}</p>\r\n            </div>\r\n            <div className=\"flex items-center gap-1.5 text-xs text-success\">\r\n              <CheckCircle className=\"size-3.5\" weight=\"fill\" />\r\n              <span className=\"hidden sm:inline\">{locale === \"bg\" ? \"╨ƒ╨╛╤é╨▓╤è╤Ç╨┤╨╡╨╜\" : \"Verified\"}</span>\r\n            </div>\r\n          </button>\r\n\r\n          {/* Password Row */}\r\n          <button\r\n            onClick={() => setIsChangePasswordOpen(true)}\r\n            className=\"w-full flex items-center gap-3 p-3 rounded-lg border bg-card hover:bg-hover active:bg-active text-left transition-colors\"\r\n          >\r\n            <div className=\"flex size-10 items-center justify-center rounded-full bg-muted\">\r\n              <Key className=\"size-5 text-muted-foreground\" />\r\n            </div>\r\n            <div className=\"flex-1 min-w-0\">\r\n              <p className=\"text-sm font-medium\">{locale === \"bg\" ? \"╨ƒ╨░╤Ç╨╛╨╗╨░\" : \"Password\"}</p>\r\n              <p className=\"text-xs text-muted-foreground\">ΓÇóΓÇóΓÇóΓÇóΓÇóΓÇóΓÇóΓÇó</p>\r\n            </div>\r\n            <span className=\"text-xs text-muted-foreground\">\r\n              {locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨╝╨╡╨╜╨╕\" : \"Change\"}\r\n            </span>\r\n          </button>\r\n        </CardContent>\r\n      </Card>\r\n      </TabsContent>\r\n\r\n      {/* Change Email Dialog */}\r\n      <Dialog open={isChangeEmailOpen} onOpenChange={setIsChangeEmailOpen}>\r\n        <DialogContent className=\"sm:max-w-md\">\r\n          <DialogHeader>\r\n            <DialogTitle>{locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨╝╤Å╨╜╨░ ╨╜╨░ ╨╕╨╝╨╡╨╣╨╗\" : \"Change Email\"}</DialogTitle>\r\n            <DialogDescription>\r\n              {locale === \"bg\" \r\n                ? \"╨⌐╨╡ ╨┐╨╛╨╗╤â╤ç╨╕╤é╨╡ ╨╕╨╝╨╡╨╣╨╗ ╨╖╨░ ╨┐╨╛╤é╨▓╤è╤Ç╨╢╨┤╨╡╨╜╨╕╨╡ ╨╜╨░ ╨╜╨╛╨▓╨╕╤Å ╨░╨┤╤Ç╨╡╤ü\" \r\n                : \"You will receive a confirmation email at the new address\"}\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <div className=\"space-y-4\">\r\n            <Field>\r\n              <FieldContent>\r\n                <FieldLabel htmlFor=\"newEmail\">\r\n                  {locale === \"bg\" ? \"╨¥╨╛╨▓ ╨╕╨╝╨╡╨╣╨╗\" : \"New Email\"}\r\n                </FieldLabel>\r\n                <Input\r\n                  id=\"newEmail\"\r\n                  name=\"newEmail\"\r\n                  type=\"email\"\r\n                  value={emailData.newEmail}\r\n                  onChange={(e) => setEmailData({ newEmail: e.target.value })}\r\n                  placeholder=\"new@example.com\"\r\n                />\r\n              </FieldContent>\r\n            </Field>\r\n          </div>\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setIsChangeEmailOpen(false)}>\r\n              {locale === \"bg\" ? \"╨₧╤é╨║╨░╨╖\" : \"Cancel\"}\r\n            </Button>\r\n            <Button onClick={handleChangeEmail} disabled={isPending || !emailData.newEmail}>\r\n              {isPending ? (\r\n                <SpinnerGap className=\"size-4 mr-2 animate-spin\" />\r\n              ) : null}\r\n              {locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨╝╨╡╨╜╨╕\" : \"Change\"}\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Change Password Dialog */}\r\n      <Dialog open={isChangePasswordOpen} onOpenChange={setIsChangePasswordOpen}>\r\n        <DialogContent className=\"sm:max-w-md\">\r\n          <DialogHeader>\r\n            <DialogTitle>{locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨╝╤Å╨╜╨░ ╨╜╨░ ╨┐╨░╤Ç╨╛╨╗╨░\" : \"Change Password\"}</DialogTitle>\r\n            <DialogDescription>\r\n              {locale === \"bg\" \r\n                ? \"╨Æ╤è╨▓╨╡╨┤╨╡╤é╨╡ ╤é╨╡╨║╤â╤ë╨░╤é╨░ ╨╕ ╨╜╨╛╨▓╨░╤é╨░ ╨┐╨░╤Ç╨╛╨╗╨░\" \r\n                : \"Enter your current and new password\"}\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <div className=\"space-y-4\">\r\n            <Field>\r\n              <FieldContent>\r\n                <FieldLabel htmlFor=\"currentPassword\">\r\n                  {locale === \"bg\" ? \"╨ó╨╡╨║╤â╤ë╨░ ╨┐╨░╤Ç╨╛╨╗╨░\" : \"Current Password\"}\r\n                </FieldLabel>\r\n                <Input\r\n                  id=\"currentPassword\"\r\n                  name=\"currentPassword\"\r\n                  type=\"password\"\r\n                  value={passwordData.currentPassword}\r\n                  onChange={(e) =>\r\n                    setPasswordData((prev) => ({\r\n                      ...prev,\r\n                      currentPassword: e.target.value,\r\n                    }))\r\n                  }\r\n                />\r\n              </FieldContent>\r\n            </Field>\r\n            <Field>\r\n              <FieldContent>\r\n                <FieldLabel htmlFor=\"newPassword\">\r\n                  {locale === \"bg\" ? \"╨¥╨╛╨▓╨░ ╨┐╨░╤Ç╨╛╨╗╨░\" : \"New Password\"}\r\n                </FieldLabel>\r\n                <div className=\"relative\">\r\n                  <Input\r\n                    id=\"newPassword\"\r\n                    name=\"newPassword\"\r\n                    type={showNewPassword ? \"text\" : \"password\"}\r\n                    value={passwordData.newPassword}\r\n                    onChange={(e) =>\r\n                      setPasswordData((prev) => ({\r\n                        ...prev,\r\n                        newPassword: e.target.value,\r\n                      }))\r\n                    }\r\n                  />\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => setShowNewPassword(!showNewPassword)}\r\n                    className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\r\n                  >\r\n                    {showNewPassword ? (\r\n                      <EyeSlash className=\"size-4\" />\r\n                    ) : (\r\n                      <Eye className=\"size-4\" />\r\n                    )}\r\n                  </button>\r\n                </div>\r\n                {passwordStrength && (\r\n                  <div className=\"space-y-1\">\r\n                    <div className=\"h-1 w-full bg-muted rounded-full overflow-hidden\">\r\n                      <div\r\n                        className={`h-full ${passwordStrength.color} ${passwordStrength.width} transition-all`}\r\n                      />\r\n                    </div>\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      {passwordStrength.label}\r\n                    </p>\r\n                  </div>\r\n                )}\r\n              </FieldContent>\r\n            </Field>\r\n            <Field\r\n              data-invalid={\r\n                !!passwordData.confirmPassword &&\r\n                passwordData.newPassword !== passwordData.confirmPassword\r\n              }\r\n            >\r\n              <FieldContent>\r\n                <FieldLabel htmlFor=\"confirmPassword\">\r\n                  {locale === \"bg\" ? \"╨ƒ╨╛╤é╨▓╤è╤Ç╨┤╨╕ ╨┐╨░╤Ç╨╛╨╗╨░╤é╨░\" : \"Confirm Password\"}\r\n                </FieldLabel>\r\n                <Input\r\n                  id=\"confirmPassword\"\r\n                  name=\"confirmPassword\"\r\n                  type=\"password\"\r\n                  value={passwordData.confirmPassword}\r\n                  onChange={(e) =>\r\n                    setPasswordData((prev) => ({\r\n                      ...prev,\r\n                      confirmPassword: e.target.value,\r\n                    }))\r\n                  }\r\n                />\r\n                <FieldError className=\"text-xs\">\r\n                  {passwordData.confirmPassword &&\r\n                  passwordData.newPassword !== passwordData.confirmPassword\r\n                    ? locale === \"bg\"\r\n                      ? \"╨ƒ╨░╤Ç╨╛╨╗╨╕╤é╨╡ ╨╜╨╡ ╤ü╤è╨▓╨┐╨░╨┤╨░╤é\"\r\n                      : \"Passwords do not match\"\r\n                    : null}\r\n                </FieldError>\r\n              </FieldContent>\r\n            </Field>\r\n          </div>\r\n          <DialogFooter>\r\n            <Button variant=\"outline\" onClick={() => setIsChangePasswordOpen(false)}>\r\n              {locale === \"bg\" ? \"╨₧╤é╨║╨░╨╖\" : \"Cancel\"}\r\n            </Button>\r\n            <Button \r\n              onClick={handleChangePassword} \r\n              disabled={isPending || !isPasswordValid || passwordData.newPassword !== passwordData.confirmPassword}\r\n            >\r\n              {isPending ? (\r\n                <SpinnerGap className=\"size-4 mr-2 animate-spin\" />\r\n              ) : null}\r\n              {locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨╝╨╡╨╜╨╕\" : \"Change\"}\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </Tabs>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\profile\\public-profile-editor.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 74 to the 25 allowed.","line":99,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":99,"endColumn":36},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'actions'. Either include it or remove the dependency array.","line":150,"column":6,"nodeType":"ArrayExpression","endLine":150,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [actions]","fix":{"range":[4768,4770],"text":"[actions]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useRef, useTransition, useEffect } from \"react\"\r\nimport Image from \"next/image\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\"\r\nimport {\r\n  Alert,\r\n  AlertDescription,\r\n} from \"@/components/ui/alert\"\r\nimport {\r\n  At,\r\n  User,\r\n  Camera,\r\n  Image as ImageIcon,\r\n  MapPin,\r\n  Globe,\r\n  FacebookLogo,\r\n  InstagramLogo,\r\n  TwitterLogo,\r\n  TiktokLogo,\r\n  Storefront,\r\n  CheckCircle,\r\n  SpinnerGap,\r\n  PencilSimple,\r\n  ArrowRight,\r\n  Info,\r\n} from \"@phosphor-icons/react\"\r\nimport { toast } from \"sonner\"\r\n\r\nexport type PublicProfileEditorServerActions = {\r\n  checkUsernameAvailability: (\r\n    username: string\r\n  ) => Promise<{ available: boolean; error?: string }>\r\n  setUsername: (username: string) => Promise<{ success: boolean; error?: string }>\r\n  updatePublicProfile: (data: {\r\n    display_name?: string | null\r\n    bio?: string | null\r\n    location?: string | null\r\n    website_url?: string | null\r\n    social_links?: Record<string, string | null | undefined> | null\r\n  }) => Promise<{ success: boolean; error?: string }>\r\n  uploadBanner: (formData: FormData) => Promise<{\r\n    success: boolean\r\n    bannerUrl?: string\r\n    error?: string\r\n  }>\r\n  upgradeToBusinessAccount: (data: {\r\n    business_name: string\r\n    vat_number?: string | null\r\n    business_address?: Record<string, unknown> | null\r\n    website_url?: string | null\r\n    change_username?: boolean\r\n    new_username?: string\r\n  }) => Promise<{ success: boolean; error?: string }>\r\n  downgradeToPersonalAccount: () => Promise<{ success: boolean; error?: string }>\r\n  getUsernameChangeCooldown: () => Promise<{\r\n    canChange: boolean\r\n    daysRemaining?: number\r\n  }>\r\n}\r\n\r\ninterface PublicProfileEditorProps {\r\n  locale: string\r\n  profile: {\r\n    id: string\r\n    username: string | null\r\n    display_name: string | null\r\n    bio: string | null\r\n    banner_url: string | null\r\n    location: string | null\r\n    website_url: string | null\r\n    social_links: Record<string, string> | null\r\n    account_type: \"personal\" | \"business\" | null\r\n    is_seller: boolean\r\n    verified_business: boolean\r\n    business_name: string | null\r\n    vat_number: string | null\r\n    last_username_change: string | null\r\n  }\r\n  actions: PublicProfileEditorServerActions\r\n}\r\n\r\nexport function PublicProfileEditor({\r\n  locale,\r\n  profile,\r\n  actions,\r\n}: PublicProfileEditorProps) {\r\n  const [isPending, startTransition] = useTransition()\r\n  const bannerInputRef = useRef<HTMLInputElement>(null)\r\n\r\n  // Username state\r\n  const [usernameDialogOpen, setUsernameDialogOpen] = useState(false)\r\n  const [newUsername, setNewUsername] = useState(profile.username || \"\")\r\n  const [usernameAvailable, setUsernameAvailable] = useState<boolean | null>(null)\r\n  const [isCheckingUsername, setIsCheckingUsername] = useState(false)\r\n  const [canChangeUsername, setCanChangeUsername] = useState(true)\r\n  const [daysUntilChange, setDaysUntilChange] = useState<number | undefined>()\r\n\r\n  // Profile data state\r\n  const [profileData, setProfileData] = useState({\r\n    display_name: profile.display_name || \"\",\r\n    bio: profile.bio || \"\",\r\n    location: profile.location || \"\",\r\n    website_url: profile.website_url || \"\",\r\n    social_links: {\r\n      facebook: profile.social_links?.facebook || \"\",\r\n      instagram: profile.social_links?.instagram || \"\",\r\n      twitter: profile.social_links?.twitter || \"\",\r\n      tiktok: profile.social_links?.tiktok || \"\",\r\n    },\r\n  })\r\n\r\n  // Banner state\r\n  const [bannerPreview, setBannerPreview] = useState<string | null>(profile.banner_url)\r\n  const [isUploadingBanner, setIsUploadingBanner] = useState(false)\r\n\r\n  // Business upgrade state\r\n  const [businessDialogOpen, setBusinessDialogOpen] = useState(false)\r\n  const [businessData, setBusinessData] = useState({\r\n    business_name: profile.business_name || \"\",\r\n    vat_number: profile.vat_number || \"\",\r\n    change_username: false,\r\n    new_username: \"\",\r\n  })\r\n\r\n  // Check username change cooldown on mount\r\n  useEffect(() => {\r\n    const checkCooldown = async () => {\r\n      const result = await actions.getUsernameChangeCooldown()\r\n      setCanChangeUsername(result.canChange)\r\n      setDaysUntilChange(result.daysRemaining)\r\n    }\r\n    checkCooldown()\r\n  }, [])\r\n\r\n  // Username availability check\r\n  const handleUsernameCheck = async (username: string) => {\r\n    if (!username || username.length < 3) {\r\n      setUsernameAvailable(null)\r\n      return\r\n    }\r\n\r\n    if (username === profile.username) {\r\n      setUsernameAvailable(null)\r\n      return\r\n    }\r\n\r\n    setIsCheckingUsername(true)\r\n    const result = await actions.checkUsernameAvailability(username)\r\n    setUsernameAvailable(result.available)\r\n    setIsCheckingUsername(false)\r\n  }\r\n\r\n  // Handle username change\r\n  const handleUsernameChange = async () => {\r\n    if (!newUsername || newUsername === profile.username) return\r\n\r\n    startTransition(async () => {\r\n      const result = await actions.setUsername(newUsername)\r\n      if (result.success) {\r\n        toast.success(locale === \"bg\" ? \"╨ƒ╨╛╤é╤Ç╨╡╨▒╨╕╤é╨╡╨╗╤ü╨║╨╛╤é╨╛ ╨╕╨╝╨╡ ╨╡ ╨┐╤Ç╨╛╨╝╨╡╨╜╨╡╨╜╨╛\" : \"Username changed successfully\")\r\n        setUsernameDialogOpen(false)\r\n        // Refresh page to reflect changes\r\n        window.location.reload()\r\n      } else {\r\n        toast.error(result.error)\r\n      }\r\n    })\r\n  }\r\n\r\n  // Handle profile update\r\n  const handleProfileUpdate = async () => {\r\n    startTransition(async () => {\r\n      const result = await actions.updatePublicProfile({\r\n        display_name: profileData.display_name || null,\r\n        bio: profileData.bio || null,\r\n        location: profileData.location || null,\r\n        website_url: profileData.website_url || null,\r\n        social_links: profileData.social_links,\r\n      })\r\n\r\n      if (result.success) {\r\n        toast.success(locale === \"bg\" ? \"╨ƒ╤Ç╨╛╤ä╨╕╨╗╤è╤é ╨╡ ╨╛╨▒╨╜╨╛╨▓╨╡╨╜\" : \"Profile updated successfully\")\r\n      } else {\r\n        toast.error(result.error)\r\n      }\r\n    })\r\n  }\r\n\r\n  // Handle banner upload\r\n  const handleBannerChange = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0]\r\n    if (!file) return\r\n\r\n    // Preview\r\n    const reader = new FileReader()\r\n    reader.onloadend = () => setBannerPreview(reader.result as string)\r\n    reader.readAsDataURL(file)\r\n\r\n    // Upload\r\n    setIsUploadingBanner(true)\r\n    const formData = new FormData()\r\n    formData.set(\"banner\", file)\r\n\r\n    const result = await actions.uploadBanner(formData)\r\n    setIsUploadingBanner(false)\r\n\r\n    if (result.success) {\r\n      setBannerPreview(result.bannerUrl || null)\r\n      toast.success(locale === \"bg\" ? \"╨æ╨░╨╜╨╡╤Ç╤è╤é ╨╡ ╨║╨░╤ç╨╡╨╜\" : \"Banner uploaded successfully\")\r\n    } else {\r\n      setBannerPreview(profile.banner_url)\r\n      toast.error(result.error)\r\n    }\r\n  }\r\n\r\n  // Handle business upgrade\r\n  const handleBusinessUpgrade = async () => {\r\n    startTransition(async () => {\r\n      const result = await actions.upgradeToBusinessAccount({\r\n        business_name: businessData.business_name,\r\n        vat_number: businessData.vat_number || null,\r\n        change_username: businessData.change_username,\r\n        ...(businessData.new_username ? { new_username: businessData.new_username } : {}),\r\n      })\r\n\r\n      if (result.success) {\r\n        toast.success(locale === \"bg\" ? \"╨ƒ╤Ç╨╛╤ä╨╕╨╗╤è╤é ╨╡ ╨╛╨▒╨╜╨╛╨▓╨╡╨╜ ╨┤╨╛ ╨▒╨╕╨╖╨╜╨╡╤ü\" : \"Upgraded to business account\")\r\n        setBusinessDialogOpen(false)\r\n        window.location.reload()\r\n      } else {\r\n        toast.error(result.error)\r\n      }\r\n    })\r\n  }\r\n\r\n  // Handle downgrade to personal\r\n  const handleDowngrade = async () => {\r\n    startTransition(async () => {\r\n      const result = await actions.downgradeToPersonalAccount()\r\n      if (result.success) {\r\n        toast.success(locale === \"bg\" ? \"╨ƒ╤Ç╨╛╤ä╨╕╨╗╤è╤é ╨╡ ╨▓╤è╤Ç╨╜╨░╤é ╨┤╨╛ ╨╗╨╕╤ç╨╡╨╜\" : \"Downgraded to personal account\")\r\n        window.location.reload()\r\n      } else {\r\n        toast.error(result.error)\r\n      }\r\n    })\r\n  }\r\n\r\n  const isBusiness = profile.account_type === \"business\"\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Public Profile Preview Link */}\r\n      {profile.username && (\r\n        <Card className=\"bg-hover border-selected-border\">\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm font-medium\">\r\n                  {locale === \"bg\" ? \"╨ó╨▓╨╛╤Å╤é ╨┐╤â╨▒╨╗╨╕╤ç╨╡╨╜ ╨┐╤Ç╨╛╤ä╨╕╨╗\" : \"Your Public Profile\"}\r\n                </p>\r\n                <p className=\"text-xs text-muted-foreground mt-0.5\">\r\n                  treido.eu/{profile.username}\r\n                </p>\r\n              </div>\r\n              <Link href={`/${profile.username}`}>\r\n                <Button variant=\"outline\" size=\"sm\" className=\"gap-2\">\r\n                  {locale === \"bg\" ? \"╨Æ╨╕╨╢ ╨┐╤Ç╨╛╤ä╨╕╨╗╨░\" : \"View Profile\"}\r\n                  <ArrowRight className=\"size-4\" />\r\n                </Button>\r\n              </Link>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Username Section */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg flex items-center gap-2\">\r\n            <At className=\"size-5\" />\r\n            {locale === \"bg\" ? \"╨ƒ╨╛╤é╤Ç╨╡╨▒╨╕╤é╨╡╨╗╤ü╨║╨╛ ╨╕╨╝╨╡\" : \"Username\"}\r\n          </CardTitle>\r\n          <CardDescription>\r\n            {locale === \"bg\"\r\n              ? \"╨ú╨╜╨╕╨║╨░╨╗╨╜╨╕╤Å╤é ╤é╨╕ ╨╕╨┤╨╡╨╜╤é╨╕╤ä╨╕╨║╨░╤é╨╛╤Ç ╨╖╨░ URL ╨╕ ╤ü╨┐╨╛╨╝╨╡╨╜╨░╨▓╨░╨╜╨╡\"\r\n              : \"Your unique identifier for URLs and mentions\"}\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"flex-1\">\r\n              <div className=\"flex items-center gap-2 text-lg font-medium\">\r\n                <span className=\"text-muted-foreground\">@</span>\r\n                {profile.username || (\r\n                  <span className=\"text-muted-foreground italic\">\r\n                    {locale === \"bg\" ? \"╨¥╨╡ ╨╡ ╨╖╨░╨┤╨░╨┤╨╡╨╜╨╛\" : \"Not set\"}\r\n                  </span>\r\n                )}\r\n              </div>\r\n              {profile.username && (\r\n                <p className=\"text-xs text-muted-foreground mt-1\">\r\n                  treido.eu/u/{profile.username}\r\n                </p>\r\n              )}\r\n            </div>\r\n\r\n            <Dialog open={usernameDialogOpen} onOpenChange={setUsernameDialogOpen}>\r\n              <DialogTrigger asChild>\r\n                <Button variant=\"outline\" size=\"sm\" disabled={!canChangeUsername && !!profile.username}>\r\n                  <PencilSimple className=\"size-4 mr-1.5\" />\r\n                  {profile.username\r\n                    ? (locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨╝╨╡╨╜╨╕\" : \"Change\")\r\n                    : (locale === \"bg\" ? \"╨ù╨░╨┤╨░╨╣\" : \"Set\")\r\n                  }\r\n                </Button>\r\n              </DialogTrigger>\r\n              <DialogContent>\r\n                <DialogHeader>\r\n                  <DialogTitle>\r\n                    {profile.username\r\n                      ? (locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨╝╨╡╨╜╨╕ ╨┐╨╛╤é╤Ç╨╡╨▒╨╕╤é╨╡╨╗╤ü╨║╨╛ ╨╕╨╝╨╡\" : \"Change Username\")\r\n                      : (locale === \"bg\" ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╕ ╨┐╨╛╤é╤Ç╨╡╨▒╨╕╤é╨╡╨╗╤ü╨║╨╛ ╨╕╨╝╨╡\" : \"Choose Username\")\r\n                    }\r\n                  </DialogTitle>\r\n                  <DialogDescription>\r\n                    {locale === \"bg\"\r\n                      ? \"╨ƒ╨╛╤é╤Ç╨╡╨▒╨╕╤é╨╡╨╗╤ü╨║╨╛╤é╨╛ ╨╕╨╝╨╡ ╨╝╨╛╨╢╨╡ ╨┤╨░ ╤ü╨╡ ╨┐╤Ç╨╛╨╝╨╡╨╜╤Å ╨▓╨╡╨┤╨╜╤è╨╢ ╨╜╨░ 14 ╨┤╨╜╨╕\"\r\n                      : \"Username can be changed once every 14 days\"}\r\n                  </DialogDescription>\r\n                </DialogHeader>\r\n\r\n                <div className=\"space-y-4 py-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label>{locale === \"bg\" ? \"╨¥╨╛╨▓╨╛ ╨┐╨╛╤é╤Ç╨╡╨▒╨╕╤é╨╡╨╗╤ü╨║╨╛ ╨╕╨╝╨╡\" : \"New Username\"}</Label>\r\n                    <div className=\"relative\">\r\n                      <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\">@</span>\r\n                      <Input\r\n                        value={newUsername}\r\n                        onChange={(e) => {\r\n                          const val = e.target.value.toLowerCase().replaceAll(/[^a-z0-9_]/g, \"\")\r\n                          setNewUsername(val)\r\n                          handleUsernameCheck(val)\r\n                        }}\r\n                        placeholder=\"your_username\"\r\n                        className=\"pl-7\"\r\n                      />\r\n                      {isCheckingUsername && (\r\n                        <SpinnerGap className=\"absolute right-3 top-1/2 -translate-y-1/2 size-4 animate-spin\" />\r\n                      )}\r\n                      {!isCheckingUsername && usernameAvailable === true && (\r\n                        <CheckCircle className=\"absolute right-3 top-1/2 -translate-y-1/2 size-4 text-success\" weight=\"fill\" />\r\n                      )}\r\n                    </div>\r\n                    {usernameAvailable === false && (\r\n                      <p className=\"text-xs text-destructive\">\r\n                        {locale === \"bg\" ? \"╨ó╨╛╨▓╨░ ╨╕╨╝╨╡ ╨╡ ╨╖╨░╨╡╤é╨╛\" : \"This username is taken\"}\r\n                      </p>\r\n                    )}\r\n                    {newUsername && newUsername.length >= 3 && usernameAvailable === true && (\r\n                      <p className=\"text-xs text-muted-foreground\">\r\n                        treido.eu/u/{newUsername}\r\n                      </p>\r\n                    )}\r\n                  </div>\r\n\r\n                  <Alert>\r\n                    <Info className=\"size-4\" />\r\n                    <AlertDescription className=\"text-xs\">\r\n                      {locale === \"bg\"\r\n                        ? \"╨ƒ╤Ç╨░╨▓╨╕╨╗╨░: 3-30 ╤ü╨╕╨╝╨▓╨╛╨╗╨░, ╤ü╨░╨╝╨╛ ╨╝╨░╨╗╨║╨╕ ╨▒╤â╨║╨▓╨╕, ╤å╨╕╤ä╤Ç╨╕ ╨╕ ╨┤╨╛╨╗╨╜╨░ ╤ç╨╡╤Ç╤é╨░\"\r\n                        : \"Rules: 3-30 chars, lowercase letters, numbers, and underscores only\"}\r\n                    </AlertDescription>\r\n                  </Alert>\r\n                </div>\r\n\r\n                <DialogFooter>\r\n                  <Button variant=\"outline\" onClick={() => setUsernameDialogOpen(false)}>\r\n                    {locale === \"bg\" ? \"╨₧╤é╨║╨░╨╖\" : \"Cancel\"}\r\n                  </Button>\r\n                  <Button\r\n                    onClick={handleUsernameChange}\r\n                    disabled={isPending || !usernameAvailable || !newUsername || newUsername === profile.username}\r\n                  >\r\n                    {isPending && <SpinnerGap className=\"size-4 mr-2 animate-spin\" />}\r\n                    {locale === \"bg\" ? \"╨ù╨░╨┐╨░╨╖╨╕\" : \"Save\"}\r\n                  </Button>\r\n                </DialogFooter>\r\n              </DialogContent>\r\n            </Dialog>\r\n          </div>\r\n\r\n          {!canChangeUsername && daysUntilChange && (\r\n            <p className=\"text-xs text-muted-foreground mt-2\">\r\n              {locale === \"bg\"\r\n                ? `╨£╨╛╨╢╨╡╤ê ╨┤╨░ ╨┐╤Ç╨╛╨╝╨╡╨╜╨╕╤ê ╤ü╨╗╨╡╨┤ ${daysUntilChange} ╨┤╨╜╨╕`\r\n                : `Can change again in ${daysUntilChange} days`}\r\n            </p>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Profile Banner */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg flex items-center gap-2\">\r\n            <ImageIcon className=\"size-5\" />\r\n            {locale === \"bg\" ? \"╨æ╨░╨╜╨╡╤Ç ╨╜╨░ ╨┐╤Ç╨╛╤ä╨╕╨╗╨░\" : \"Profile Banner\"}\r\n          </CardTitle>\r\n          <CardDescription>\r\n            {locale === \"bg\"\r\n              ? \"╨ƒ╤Ç╨╡╨┐╨╛╤Ç╤è╤ç╨╕╤é╨╡╨╗╨╡╨╜ ╤Ç╨░╨╖╨╝╨╡╤Ç: 1200x300 ╨┐╨╕╨║╤ü╨╡╨╗╨░\"\r\n              : \"Recommended size: 1200x300 pixels\"}\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div\r\n            className=\"relative h-32 rounded-lg bg-muted overflow-hidden cursor-pointer group\"\r\n            onClick={() => bannerInputRef.current?.click()}\r\n          >\r\n            {bannerPreview ? (\r\n              <Image src={bannerPreview} alt=\"Banner\" fill sizes=\"100vw\" className=\"object-cover\" />\r\n            ) : (\r\n              <div className=\"absolute inset-0 flex items-center justify-center\">\r\n                <ImageIcon className=\"size-8 text-muted-foreground\" />\r\n              </div>\r\n            )}\r\n            <div className=\"absolute inset-0 bg-surface-overlay opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center\">\r\n              {isUploadingBanner ? (\r\n                <SpinnerGap className=\"size-6 text-overlay-text animate-spin\" />\r\n              ) : (\r\n                <Camera className=\"size-6 text-overlay-text\" />\r\n              )}\r\n            </div>\r\n          </div>\r\n          <input\r\n            ref={bannerInputRef}\r\n            type=\"file\"\r\n            accept=\"image/jpeg,image/png,image/webp\"\r\n            onChange={handleBannerChange}\r\n            className=\"hidden\"\r\n          />\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Public Profile Info */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg flex items-center gap-2\">\r\n            <User className=\"size-5\" />\r\n            {locale === \"bg\" ? \"╨ƒ╤â╨▒╨╗╨╕╤ç╨╜╨░ ╨╕╨╜╤ä╨╛╤Ç╨╝╨░╤å╨╕╤Å\" : \"Public Information\"}\r\n          </CardTitle>\r\n          <CardDescription>\r\n            {locale === \"bg\"\r\n              ? \"╨ó╨░╨╖╨╕ ╨╕╨╜╤ä╨╛╤Ç╨╝╨░╤å╨╕╤Å ╤ü╨╡ ╨┐╨╛╨║╨░╨╖╨▓╨░ ╨╜╨░ ╨┐╤â╨▒╨╗╨╕╤ç╨╜╨╕╤Å ╤é╨╕ ╨┐╤Ç╨╛╤ä╨╕╨╗\"\r\n              : \"This information is visible on your public profile\"}\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-4\">\r\n          <div className=\"space-y-2\">\r\n            <Label>{locale === \"bg\" ? \"╨ƒ╨╛╨║╨░╨╖╨▓╨░╨╜╨╛ ╨╕╨╝╨╡\" : \"Display Name\"}</Label>\r\n            <Input\r\n              value={profileData.display_name}\r\n              onChange={(e) => setProfileData(prev => ({ ...prev, display_name: e.target.value }))}\r\n              placeholder={profile.username || (locale === \"bg\" ? \"╨ó╨▓╨╛╨╡╤é╨╛ ╨╕╨╝╨╡\" : \"Your name\")}\r\n            />\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              {locale === \"bg\" ? \"╨ƒ╨╛╨║╨░╨╖╨▓╨░ ╤ü╨╡ ╨▓╨╝╨╡╤ü╤é╨╛ @username\" : \"Shown instead of @username\"}\r\n            </p>\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <Label>{locale === \"bg\" ? \"╨æ╨╕╨╛╨│╤Ç╨░╤ä╨╕╤Å\" : \"Bio\"}</Label>\r\n            <Textarea\r\n              value={profileData.bio}\r\n              onChange={(e) => setProfileData(prev => ({ ...prev, bio: e.target.value }))}\r\n              placeholder={locale === \"bg\" ? \"╨á╨░╨╖╨║╨░╨╢╨╕ ╨╜╨╡╤ë╨╛ ╨╖╨░ ╤ü╨╡╨▒╨╡ ╤ü╨╕...\" : \"Tell us about yourself...\"}\r\n              rows={3}\r\n              maxLength={500}\r\n            />\r\n            <p className=\"text-xs text-muted-foreground text-right\">\r\n              {profileData.bio.length}/500\r\n            </p>\r\n          </div>\r\n\r\n          <div className=\"space-y-2\">\r\n            <Label className=\"flex items-center gap-1.5\">\r\n              <MapPin className=\"size-4\" />\r\n              {locale === \"bg\" ? \"╨¢╨╛╨║╨░╤å╨╕╤Å\" : \"Location\"}\r\n            </Label>\r\n            <Input\r\n              value={profileData.location}\r\n              onChange={(e) => setProfileData(prev => ({ ...prev, location: e.target.value }))}\r\n              placeholder={locale === \"bg\" ? \"╨í╨╛╤ä╨╕╤Å, ╨æ╤è╨╗╨│╨░╤Ç╨╕╤Å\" : \"Sofia, Bulgaria\"}\r\n            />\r\n          </div>\r\n\r\n          <Separator />\r\n\r\n          {/* Social Links - Only for business accounts */}\r\n          {isBusiness && (\r\n            <>\r\n              <div className=\"space-y-2\">\r\n                <Label className=\"flex items-center gap-1.5\">\r\n                  <Globe className=\"size-4\" />\r\n                  {locale === \"bg\" ? \"╨ú╨╡╨▒╤ü╨░╨╣╤é\" : \"Website\"}\r\n                </Label>\r\n                <Input\r\n                  type=\"url\"\r\n                  value={profileData.website_url}\r\n                  onChange={(e) => setProfileData(prev => ({ ...prev, website_url: e.target.value }))}\r\n                  placeholder=\"https://example.com\"\r\n                />\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-2 gap-3\">\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"flex items-center gap-1.5\">\r\n                    <FacebookLogo className=\"size-4\" />\r\n                    Facebook\r\n                  </Label>\r\n                  <Input\r\n                    value={profileData.social_links.facebook}\r\n                    onChange={(e) => setProfileData(prev => ({\r\n                      ...prev,\r\n                      social_links: { ...prev.social_links, facebook: e.target.value }\r\n                    }))}\r\n                    placeholder=\"facebook.com/...\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"flex items-center gap-1.5\">\r\n                    <InstagramLogo className=\"size-4\" />\r\n                    Instagram\r\n                  </Label>\r\n                  <Input\r\n                    value={profileData.social_links.instagram}\r\n                    onChange={(e) => setProfileData(prev => ({\r\n                      ...prev,\r\n                      social_links: { ...prev.social_links, instagram: e.target.value }\r\n                    }))}\r\n                    placeholder=\"instagram.com/...\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"flex items-center gap-1.5\">\r\n                    <TwitterLogo className=\"size-4\" />\r\n                    Twitter/X\r\n                  </Label>\r\n                  <Input\r\n                    value={profileData.social_links.twitter}\r\n                    onChange={(e) => setProfileData(prev => ({\r\n                      ...prev,\r\n                      social_links: { ...prev.social_links, twitter: e.target.value }\r\n                    }))}\r\n                    placeholder=\"x.com/...\"\r\n                  />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"flex items-center gap-1.5\">\r\n                    <TiktokLogo className=\"size-4\" />\r\n                    TikTok\r\n                  </Label>\r\n                  <Input\r\n                    value={profileData.social_links.tiktok}\r\n                    onChange={(e) => setProfileData(prev => ({\r\n                      ...prev,\r\n                      social_links: { ...prev.social_links, tiktok: e.target.value }\r\n                    }))}\r\n                    placeholder=\"tiktok.com/@...\"\r\n                  />\r\n                </div>\r\n              </div>\r\n            </>\r\n          )}\r\n\r\n          <Button onClick={handleProfileUpdate} disabled={isPending} className=\"w-full\">\r\n            {isPending && <SpinnerGap className=\"size-4 mr-2 animate-spin\" />}\r\n            {locale === \"bg\" ? \"╨ù╨░╨┐╨░╨╖╨╕ ╨┐╤Ç╨╛╨╝╨╡╨╜╨╕╤é╨╡\" : \"Save Changes\"}\r\n          </Button>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Account Type Section */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg flex items-center gap-2\">\r\n            <Storefront className=\"size-5\" />\r\n            {locale === \"bg\" ? \"╨ó╨╕╨┐ ╨░╨║╨░╤â╨╜╤é\" : \"Account Type\"}\r\n          </CardTitle>\r\n          <CardDescription>\r\n            {isBusiness\r\n              ? (locale === \"bg\" ? \"╨æ╨╕╨╖╨╜╨╡╤ü ╨░╨║╨░╤â╨╜╤é ╤ü ╤Ç╨░╨╖╤ê╨╕╤Ç╨╡╨╜╨╕ ╤ä╤â╨╜╨║╤å╨╕╨╕\" : \"Business account with extended features\")\r\n              : (locale === \"bg\" ? \"╨¢╨╕╤ç╨╡╨╜ ╨░╨║╨░╤â╨╜╤é\" : \"Personal account\")\r\n            }\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex items-center justify-between\">\r\n            <div className=\"flex items-center gap-3\">\r\n              <Badge variant={isBusiness ? \"default\" : \"secondary\"} className=\"gap-1\">\r\n                {isBusiness ? <Storefront className=\"size-3\" /> : <User className=\"size-3\" />}\r\n                {isBusiness\r\n                  ? (locale === \"bg\" ? \"╨æ╨╕╨╖╨╜╨╡╤ü\" : \"Business\")\r\n                  : (locale === \"bg\" ? \"╨¢╨╕╤ç╨╡╨╜\" : \"Personal\")\r\n                }\r\n              </Badge>\r\n              {isBusiness && profile.verified_business && (\r\n                <Badge variant=\"outline\" className=\"gap-1 text-info border-info/30 bg-info/10\">\r\n                  <CheckCircle className=\"size-3\" weight=\"fill\" />\r\n                  {locale === \"bg\" ? \"╨Æ╨╡╤Ç╨╕╤ä╨╕╤å╨╕╤Ç╨░╨╜\" : \"Verified\"}\r\n                </Badge>\r\n              )}\r\n            </div>\r\n\r\n            {isBusiness ? (\r\n              <Button variant=\"outline\" size=\"sm\" onClick={handleDowngrade} disabled={isPending}>\r\n                {locale === \"bg\" ? \"╨Æ╤è╤Ç╨╜╨╕ ╨║╤è╨╝ ╨╗╨╕╤ç╨╡╨╜\" : \"Switch to Personal\"}\r\n              </Button>\r\n            ) : (\r\n              <Dialog open={businessDialogOpen} onOpenChange={setBusinessDialogOpen}>\r\n                <DialogTrigger asChild>\r\n                  <Button size=\"sm\" className=\"gap-1\">\r\n                    <Storefront className=\"size-4\" />\r\n                    {locale === \"bg\" ? \"╨¥╨░╨┤╨│╤Ç╨░╨┤╨╕ ╨┤╨╛ ╨▒╨╕╨╖╨╜╨╡╤ü\" : \"Upgrade to Business\"}\r\n                  </Button>\r\n                </DialogTrigger>\r\n                <DialogContent className=\"sm:max-w-md\">\r\n                  <DialogHeader>\r\n                    <DialogTitle>\r\n                      {locale === \"bg\" ? \"╨¥╨░╨┤╨│╤Ç╨░╨┤╨╕ ╨┤╨╛ ╨▒╨╕╨╖╨╜╨╡╤ü ╨░╨║╨░╤â╨╜╤é\" : \"Upgrade to Business Account\"}\r\n                    </DialogTitle>\r\n                    <DialogDescription>\r\n                      {locale === \"bg\"\r\n                        ? \"╨æ╨╕╨╖╨╜╨╡╤ü ╨░╨║╨░╤â╨╜╤é╨╕╤é╨╡ ╨╕╨╝╨░╤é ╨┤╨╛╨┐╤è╨╗╨╜╨╕╤é╨╡╨╗╨╜╨╕ ╤ä╤â╨╜╨║╤å╨╕╨╕\"\r\n                        : \"Business accounts have additional features\"}\r\n                    </DialogDescription>\r\n                  </DialogHeader>\r\n\r\n                  <div className=\"space-y-4 py-4\">\r\n                    <div className=\"space-y-2\">\r\n                      <Label>{locale === \"bg\" ? \"╨ÿ╨╝╨╡ ╨╜╨░ ╨▒╨╕╨╖╨╜╨╡╤ü╨░ *\" : \"Business Name *\"}</Label>\r\n                      <Input\r\n                        value={businessData.business_name}\r\n                        onChange={(e) => setBusinessData(prev => ({ ...prev, business_name: e.target.value }))}\r\n                        placeholder={locale === \"bg\" ? \"╨Æ╨░╤ê╨╕╤Å╤é ╨▒╨╕╨╖╨╜╨╡╤ü\" : \"Your Business\"}\r\n                      />\r\n                    </div>\r\n\r\n                    <div className=\"space-y-2\">\r\n                      <Label>{locale === \"bg\" ? \"╨ö╨ö╨í ╨╜╨╛╨╝╨╡╤Ç (╨┐╨╛ ╨╢╨╡╨╗╨░╨╜╨╕╨╡)\" : \"VAT Number (optional)\"}</Label>\r\n                      <Input\r\n                        value={businessData.vat_number}\r\n                        onChange={(e) => setBusinessData(prev => ({ ...prev, vat_number: e.target.value }))}\r\n                        placeholder=\"BG123456789\"\r\n                      />\r\n                    </div>\r\n\r\n                    <Alert>\r\n                      <Info className=\"size-4\" />\r\n                      <AlertDescription className=\"text-xs\">\r\n                        {locale === \"bg\"\r\n                          ? \"╨æ╨╕╨╖╨╜╨╡╤ü ╨░╨║╨░╤â╨╜╤é╨╕╤é╨╡ ╨┐╨╛╨║╨░╨╖╨▓╨░╤é ╨┤╨╛╨┐╤è╨╗╨╜╨╕╤é╨╡╨╗╨╜╨░ ╨╕╨╜╤ä╨╛╤Ç╨╝╨░╤å╨╕╤Å ╨╜╨░ ╨┐╤Ç╨╛╤ä╨╕╨╗╨░ - ╤ü╨╛╤å╨╕╨░╨╗╨╜╨╕ ╨╝╤Ç╨╡╨╢╨╕, ╤â╨╡╨▒╤ü╨░╨╣╤é ╨╕ ╨┤╤Ç.\"\r\n                          : \"Business accounts display additional profile info - social links, website, etc.\"}\r\n                      </AlertDescription>\r\n                    </Alert>\r\n                  </div>\r\n\r\n                  <DialogFooter>\r\n                    <Button variant=\"outline\" onClick={() => setBusinessDialogOpen(false)}>\r\n                      {locale === \"bg\" ? \"╨₧╤é╨║╨░╨╖\" : \"Cancel\"}\r\n                    </Button>\r\n                    <Button\r\n                      onClick={handleBusinessUpgrade}\r\n                      disabled={isPending || !businessData.business_name}\r\n                    >\r\n                      {isPending && <SpinnerGap className=\"size-4 mr-2 animate-spin\" />}\r\n                      {locale === \"bg\" ? \"╨¥╨░╨┤╨│╤Ç╨░╨┤╨╕\" : \"Upgrade\"}\r\n                    </Button>\r\n                  </DialogFooter>\r\n                </DialogContent>\r\n              </Dialog>\r\n            )}\r\n          </div>\r\n\r\n          {isBusiness && profile.business_name && (\r\n            <div className=\"mt-4 pt-4 border-t\">\r\n              <p className=\"text-sm text-muted-foreground\">\r\n                {locale === \"bg\" ? \"╨ÿ╨╝╨╡ ╨╜╨░ ╨▒╨╕╨╖╨╜╨╡╤ü╨░\" : \"Business Name\"}\r\n              </p>\r\n              <p className=\"font-medium\">{profile.business_name}</p>\r\n              {profile.vat_number && (\r\n                <>\r\n                  <p className=\"text-sm text-muted-foreground mt-2\">\r\n                    {locale === \"bg\" ? \"╨ö╨ö╨í ╨╜╨╛╨╝╨╡╤Ç\" : \"VAT Number\"}\r\n                  </p>\r\n                  <p className=\"font-medium\">{profile.vat_number}</p>\r\n                </>\r\n              )}\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\sales\\_components\\export-sales.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\sales\\_components\\pending-actions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\sales\\_components\\sales-chart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\sales\\_components\\sales-stats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\sales\\_components\\sales-table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\sales\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\sales\\page.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 51 to the 25 allowed.","line":32,"column":31,"nodeType":null,"messageId":"refactorFunction","endLine":32,"endColumn":40},{"ruleId":"prefer-const","severity":2,"message":"'startDate' is never reassigned. Use 'const' instead.","line":78,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":78,"endColumn":16,"fix":{"range":[2384,2410],"text":"const startDate = new Date()"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { createClient } from \"@/lib/supabase/server\"\r\nimport { Link, redirect } from \"@/i18n/routing\"\r\nimport { AppBreadcrumb } from \"@/components/shared/navigation/app-breadcrumb\"\r\nimport { PageShell } from \"@/components/shared/page-shell\"\r\nimport { SalesChart } from \"./_components/sales-chart\"\r\nimport { SalesStats } from \"./_components/sales-stats\"\r\nimport { SalesTable } from \"./_components/sales-table\"\r\nimport { PendingActions } from \"./_components/pending-actions\"\r\nimport { ExportSales } from \"./_components/export-sales\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n  CurrencyCircleDollar,\r\n  ChartLineUp,\r\n  Storefront,\r\n  Plus,\r\n} from \"@phosphor-icons/react/dist/ssr\"\r\n\r\nimport type { SaleItem } from \"./types\"\r\nexport type { SaleItem } from \"./types\"\r\n\r\ninterface SalesPageProps {\r\n  params: Promise<{\r\n    locale: string\r\n  }>\r\n  searchParams: Promise<{\r\n    period?: string\r\n  }>\r\n}\r\n\r\nexport default async function SalesPage({ params, searchParams }: SalesPageProps) {\r\n  const { locale } = await params\r\n  const { period = \"30d\" } = await searchParams\r\n  const supabase = await createClient()\r\n\r\n  if (!supabase) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n\r\n  if (!user) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  // Check if user has a seller profile (has username)\r\n  const [\r\n    { data: profile },\r\n    { data: privateProfile },\r\n  ] = await Promise.all([\r\n    supabase\r\n      .from(\"profiles\")\r\n      .select(\"id,username,display_name,business_name,created_at\")\r\n      .eq(\"id\", user.id)\r\n      .single(),\r\n    supabase\r\n      .from(\"private_profiles\")\r\n      .select(\"commission_rate\")\r\n      .eq(\"id\", user.id)\r\n      .maybeSingle(),\r\n  ])\r\n\r\n  // If no username, redirect to sell page to set one up\r\n  if (!profile || !profile.username) {\r\n    return redirect({ href: \"/sell\", locale })\r\n  }\r\n\r\n  // Map profile to seller format for compatibility\r\n  const seller = {\r\n    ...profile,\r\n    commission_rate: privateProfile?.commission_rate ?? null,\r\n    store_name: profile.display_name || profile.business_name || profile.username,\r\n  }\r\n\r\n  // Calculate date range\r\n  const now = new Date()\r\n  let startDate = new Date()\r\n\r\n  switch (period) {\r\n    case \"7d\":\r\n      startDate.setDate(now.getDate() - 7)\r\n      break\r\n    case \"30d\":\r\n      startDate.setDate(now.getDate() - 30)\r\n      break\r\n    case \"90d\":\r\n      startDate.setDate(now.getDate() - 90)\r\n      break\r\n    case \"1y\":\r\n      startDate.setFullYear(now.getFullYear() - 1)\r\n      break\r\n    default:\r\n      startDate.setDate(now.getDate() - 30)\r\n  }\r\n\r\n  // Fetch sales (order_items where seller_id matches)\r\n  const { data: salesData } = await supabase\r\n    .from(\"order_items\")\r\n    .select(\"id, order_id, product_id, quantity, price_at_purchase, status\")\r\n    .eq(\"seller_id\", user.id)\r\n\r\n  // Pending actions (counts)\r\n  const { count: ordersToShipCount } = await supabase\r\n    .from(\"order_items\")\r\n    .select(\"id\", { count: \"exact\", head: true })\r\n    .eq(\"seller_id\", user.id)\r\n    .is(\"shipped_at\", null)\r\n    .in(\"status\", [\"paid\", \"processing\"])\r\n\r\n  const { count: unreadMessagesCount } = await supabase\r\n    .from(\"conversations\")\r\n    .select(\"id\", { count: \"exact\", head: true })\r\n    .eq(\"seller_id\", user.id)\r\n    .gt(\"seller_unread_count\", 0)\r\n\r\n  const { count: lowStockCount } = await supabase\r\n    .from(\"products\")\r\n    .select(\"id\", { count: \"exact\", head: true })\r\n    .eq(\"seller_id\", user.id)\r\n    .eq(\"status\", \"active\")\r\n    .gt(\"stock\", 0)\r\n    .lte(\"stock\", 2)\r\n\r\n  // Get unique order IDs and product IDs\r\n  const orderIds = [...new Set((salesData || []).map(s => s.order_id))]\r\n  const productIds = [...new Set((salesData || []).map(s => s.product_id))]\r\n\r\n  // Fetch orders with date filter\r\n  const { data: ordersData } = orderIds.length > 0\r\n    ? await supabase\r\n      .from(\"orders\")\r\n      .select(\"id, status, created_at, shipping_address, user_id\")\r\n      .in(\"id\", orderIds)\r\n      .gte(\"created_at\", startDate.toISOString())\r\n      .order(\"created_at\", { ascending: false })\r\n    : { data: [] }\r\n\r\n  // Get buyer profiles for the orders\r\n  const buyerIds = [...new Set((ordersData || []).map(o => o.user_id))]\r\n  const { data: buyersData } = buyerIds.length > 0\r\n    ? await supabase\r\n      .from(\"profiles\")\r\n      .select(\"id, full_name\")\r\n      .in(\"id\", buyerIds)\r\n    : { data: [] }\r\n\r\n  // Fetch products\r\n  const { data: productsData } = productIds.length > 0\r\n    ? await supabase\r\n      .from(\"products\")\r\n      .select(\"id, title, images, price\")\r\n      .in(\"id\", productIds)\r\n    : { data: [] }\r\n\r\n  // Create lookup maps\r\n  const ordersMap = new Map((ordersData || []).map(o => [o.id, o]))\r\n  const buyersMap = new Map((buyersData || []).map(b => [b.id, b]))\r\n  const productsMap = new Map((productsData || []).map(p => [p.id, p]))\r\n\r\n  // Transform the data to match our interface - filter only items with orders in date range\r\n  const sales: SaleItem[] = (salesData || [])\r\n    .filter(item => ordersMap.has(item.order_id))\r\n    .map((item) => {\r\n      const order = ordersMap.get(item.order_id)\r\n      const product = productsMap.get(item.product_id)\r\n      const buyer = order ? buyersMap.get(order.user_id) : null\r\n      const shippingAddress = order?.shipping_address as { city?: string; country?: string; email?: string } | null\r\n      const buyerEmail = typeof shippingAddress?.email === 'string' ? shippingAddress.email : ''\r\n      const buyerFullName = buyer?.full_name ?? null\r\n      const buyerInfo = buyerFullName || buyerEmail ? { email: buyerEmail, full_name: buyerFullName } : null\r\n      return {\r\n        id: item.id,\r\n        order_id: item.order_id,\r\n        product_id: item.product_id,\r\n        quantity: item.quantity,\r\n        price_at_purchase: item.price_at_purchase,\r\n        created_at: order?.created_at || '',\r\n        status: typeof order?.status === 'string' ? order.status : 'pending',\r\n        product: product ? {\r\n          id: product.id,\r\n          title: product.title,\r\n          images: product.images || [],\r\n          price: product.price,\r\n        } : null,\r\n         order: order ? {\r\n           id: order.id,\r\n           status: typeof order.status === 'string' ? order.status : 'pending',\r\n           created_at: order.created_at,\r\n          shipping_address: shippingAddress,\r\n          buyer: buyerInfo,\r\n         } : null,\r\n       }\r\n     })\r\n\r\n  // Calculate stats\r\n  const totalRevenue = sales.reduce((sum, sale) => sum + (Number(sale.price_at_purchase) * sale.quantity), 0)\r\n  const totalSales = sales.length\r\n  const totalUnits = sales.reduce((sum, sale) => sum + sale.quantity, 0)\r\n  const avgOrderValue = totalSales > 0 ? totalRevenue / totalSales : 0\r\n\r\n  // Get previous period for comparison\r\n  const prevStartDate = new Date(startDate)\r\n  prevStartDate.setDate(prevStartDate.getDate() - (now.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24))\r\n\r\n  const { data: prevSalesData } = await supabase\r\n    .from(\"order_items\")\r\n    .select(`\r\n      id,\r\n      quantity,\r\n      price_at_purchase,\r\n      orders!inner (\r\n        created_at\r\n      )\r\n    `)\r\n    .eq(\"seller_id\", user.id)\r\n    .gte(\"orders.created_at\", prevStartDate.toISOString())\r\n    .lt(\"orders.created_at\", startDate.toISOString())\r\n\r\n  const prevTotalRevenue = (prevSalesData || []).reduce((sum, sale) =>\r\n    sum + (Number(sale.price_at_purchase) * sale.quantity), 0)\r\n  const prevTotalSales = (prevSalesData || []).length\r\n\r\n  // Calculate growth percentages\r\n  const revenueGrowth = prevTotalRevenue > 0\r\n    ? ((totalRevenue - prevTotalRevenue) / prevTotalRevenue) * 100\r\n    : totalRevenue > 0 ? 100 : 0\r\n  const salesGrowth = prevTotalSales > 0\r\n    ? ((totalSales - prevTotalSales) / prevTotalSales) * 100\r\n    : totalSales > 0 ? 100 : 0\r\n\r\n  // Commission calculation (based on seller tier)\r\n  const commissionRate = seller.commission_rate == null ? 0 : Number(seller.commission_rate)\r\n  const netRevenue = totalRevenue * (1 - commissionRate / 100)\r\n  const totalCommission = totalRevenue * (commissionRate / 100)\r\n\r\n  // Group sales by date for chart\r\n  const salesByDate = sales.reduce((acc: Record<string, { revenue: number; orders: number }>, sale) => {\r\n    const date = new Date(sale.created_at).toISOString().slice(0, 10)\r\n    if (!acc[date]) {\r\n      acc[date] = { revenue: 0, orders: 0 }\r\n    }\r\n    acc[date].revenue += Number(sale.price_at_purchase) * sale.quantity\r\n    acc[date].orders += 1\r\n    return acc\r\n  }, {})\r\n\r\n  // Fill in missing dates\r\n  const chartData: { date: string; revenue: number; orders: number }[] = []\r\n  const currentDate = new Date(startDate)\r\n  while (currentDate <= now) {\r\n    const dateStr = currentDate.toISOString().slice(0, 10)\r\n    chartData.push({\r\n      date: dateStr,\r\n      revenue: salesByDate[dateStr]?.revenue || 0,\r\n      orders: salesByDate[dateStr]?.orders || 0,\r\n    })\r\n    currentDate.setDate(currentDate.getDate() + 1)\r\n  }\r\n\r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat(locale, {\r\n      style: 'currency',\r\n      currency: 'EUR',\r\n    }).format(value)\r\n  }\r\n\r\n  return (\r\n    <PageShell>\r\n      <div className=\"container py-4 sm:py-6\">\r\n        {/* Breadcrumb */}\r\n        <AppBreadcrumb items={[\r\n          { label: locale === 'bg' ? '╨É╨║╨░╤â╨╜╤é' : 'Account', href: \"/account\" },\r\n          { label: locale === 'bg' ? '╨ƒ╤Ç╨╛╨┤╨░╨╢╨▒╨╕' : 'Sales' }\r\n        ]} />\r\n\r\n        {/* Header */}\r\n        <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mt-4 mb-6\">\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"size-14 sm:size-16 rounded-md bg-muted border border-border flex items-center justify-center\">\r\n              <ChartLineUp weight=\"fill\" className=\"size-7 sm:size-8 text-muted-foreground\" />\r\n            </div>\r\n            <div>\r\n              <h1 className=\"text-xl sm:text-2xl font-bold text-foreground\">\r\n                {locale === 'bg' ? '╨ƒ╤Ç╨╛╨┤╨░╨╢╨▒╨╕' : 'Sales Dashboard'}\r\n              </h1>\r\n              <p className=\"text-sm text-muted-foreground mt-0.5\">\r\n                {locale === 'bg' ? '╨ƒ╤Ç╨╡╨│╨╗╨╡╨┤ ╨╜╨░ ╨┐╤Ç╨╕╤à╨╛╨┤╨╕╤é╨╡ ╨╕ ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕╤é╨╡' : 'Track your revenue and orders'}\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button asChild variant=\"outline\">\r\n              <Link href=\"/account/selling\">\r\n                <Storefront className=\"size-4 mr-2\" />\r\n                {locale === 'bg' ? '╨£╨╛╤Å╤é ╨╝╨░╨│╨░╨╖╨╕╨╜' : 'My Store'}\r\n              </Link>\r\n            </Button>\r\n            <Button asChild>\r\n              <Link href=\"/sell\">\r\n                <Plus weight=\"bold\" className=\"size-4 mr-2\" />\r\n                {locale === 'bg' ? '╨¥╨╛╨▓╨░ ╨╛╨▒╤Å╨▓╨░' : 'New Listing'}\r\n              </Link>\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        <PendingActions\r\n          locale={locale}\r\n          ordersToShipCount={ordersToShipCount ?? 0}\r\n          unreadMessagesCount={unreadMessagesCount ?? 0}\r\n          lowStockCount={lowStockCount ?? 0}\r\n        />\r\n\r\n        {/* Stats Cards */}\r\n        <SalesStats\r\n          locale={locale}\r\n          totalRevenue={totalRevenue}\r\n          netRevenue={netRevenue}\r\n          totalSales={totalSales}\r\n          totalUnits={totalUnits}\r\n          avgOrderValue={avgOrderValue}\r\n          revenueGrowth={revenueGrowth}\r\n          salesGrowth={salesGrowth}\r\n          commissionRate={commissionRate}\r\n          totalCommission={totalCommission}\r\n          formatCurrency={formatCurrency}\r\n        />\r\n\r\n        {/* Chart Section */}\r\n        <Card className=\"mt-6\">\r\n          <CardHeader className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n            <div>\r\n              <CardTitle className=\"text-lg\">\r\n                {locale === 'bg' ? '╨ƒ╤Ç╨╕╤à╨╛╨┤╨╕ ╨▓╤è╨▓ ╨▓╤Ç╨╡╨╝╨╡╤é╨╛' : 'Revenue Over Time'}\r\n              </CardTitle>\r\n              <CardDescription>\r\n                {locale === 'bg' ? '╨ö╨╜╨╡╨▓╨╜╨╕ ╨┐╤Ç╨╕╤à╨╛╨┤╨╕ ╨╖╨░ ╨╕╨╖╨▒╤Ç╨░╨╜╨╕╤Å ╨┐╨╡╤Ç╨╕╨╛╨┤' : 'Daily revenue for the selected period'}\r\n              </CardDescription>\r\n            </div>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Link href={`?period=7d`}>\r\n                <Badge\r\n                  variant={period === \"7d\" ? \"default\" : \"outline\"}\r\n                  className=\"cursor-pointer\"\r\n                >\r\n                  7D\r\n                </Badge>\r\n              </Link>\r\n              <Link href={`?period=30d`}>\r\n                <Badge\r\n                  variant={period === \"30d\" ? \"default\" : \"outline\"}\r\n                  className=\"cursor-pointer\"\r\n                >\r\n                  30D\r\n                </Badge>\r\n              </Link>\r\n              <Link href={`?period=90d`}>\r\n                <Badge\r\n                  variant={period === \"90d\" ? \"default\" : \"outline\"}\r\n                  className=\"cursor-pointer\"\r\n                >\r\n                  90D\r\n                </Badge>\r\n              </Link>\r\n              <Link href={`?period=1y`}>\r\n                <Badge\r\n                  variant={period === \"1y\" ? \"default\" : \"outline\"}\r\n                  className=\"cursor-pointer\"\r\n                >\r\n                  1Y\r\n                </Badge>\r\n              </Link>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <SalesChart data={chartData} locale={locale} />\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Sales Table */}\r\n        <Card className=\"mt-6\">\r\n          <CardHeader>\r\n            <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3\">\r\n              <div>\r\n                <CardTitle className=\"text-lg\">\r\n                  {locale === 'bg' ? '╨ƒ╨╛╤ü╨╗╨╡╨┤╨╜╨╕ ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕' : 'Recent Sales'}\r\n                </CardTitle>\r\n                <CardDescription>\r\n                  {locale === 'bg'\r\n                    ? `${totalSales} ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕ ╨╖╨░ ╨┐╨╛╤ü╨╗╨╡╨┤╨╜╨╕╤é╨╡ ${period === '7d' ? '7 ╨┤╨╜╨╕' : period === '30d' ? '30 ╨┤╨╜╨╕' : period === '90d' ? '90 ╨┤╨╜╨╕' : '╨│╨╛╨┤╨╕╨╜╨░'}`\r\n                    : `${totalSales} sales in the last ${period === '7d' ? '7 days' : period === '30d' ? '30 days' : period === '90d' ? '90 days' : 'year'}`\r\n                  }\r\n                </CardDescription>\r\n              </div>\r\n              <ExportSales\r\n                locale={locale}\r\n                defaultFrom={startDate.toISOString().slice(0, 10)}\r\n                defaultTo={now.toISOString().slice(0, 10)}\r\n              />\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <SalesTable sales={sales} locale={locale} />\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Empty State */}\r\n        {sales.length === 0 && (\r\n          <Card className=\"mt-6\">\r\n            <CardContent className=\"py-16\">\r\n              <div className=\"text-center\">\r\n                <div className=\"size-20 bg-muted rounded-full mx-auto flex items-center justify-center mb-4\">\r\n                  <CurrencyCircleDollar weight=\"duotone\" className=\"size-10 text-muted-foreground\" />\r\n                </div>\r\n                <h3 className=\"text-lg font-semibold text-foreground mb-2\">\r\n                  {locale === 'bg' ? '╨¥╤Å╨╝╨░╤é╨╡ ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕ ╨▓╤ü╨╡ ╨╛╤ë╨╡' : 'No sales yet'}\r\n                </h3>\r\n                <p className=\"text-muted-foreground mb-6 max-w-sm mx-auto\">\r\n                  {locale === 'bg'\r\n                    ? '╨Ü╨╛╨│╨░╤é╨╛ ╨┐╤Ç╨╛╨┤╨░╨┤╨╡╤é╨╡ ╨┐╤Ç╨╛╨┤╤â╨║╤é, ╨▓╨░╤ê╨╕╤é╨╡ ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕ ╤ë╨╡ ╤ü╨╡ ╨┐╨╛╨║╨░╨╖╨▓╨░╤é ╤é╤â╨║'\r\n                    : 'When you sell a product, your sales will appear here'}\r\n                </p>\r\n                <Button asChild>\r\n                  <Link href=\"/sell\">\r\n                    <Plus weight=\"bold\" className=\"size-4 mr-2\" />\r\n                    {locale === 'bg' ? '╨í╤è╨╖╨┤╨░╨╣ ╨╛╨▒╤Å╨▓╨░' : 'Create Listing'}\r\n                  </Link>\r\n                </Button>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        )}\r\n      </div>\r\n    </PageShell>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\sales\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\security\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\security\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\security\\security-content.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_handleResetPassword' is assigned a value but never used.","line":121,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":121,"endColumn":31},{"ruleId":"sonarjs/no-all-duplicated-branches","severity":1,"message":"This conditional operation returns the same value whether the condition is \"true\" or \"false\".","line":237,"column":61,"nodeType":"ConditionalExpression","messageId":"returnsTheSameValue","endLine":237,"endColumn":92}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\nimport { useState } from \"react\"\nimport { useTranslations } from \"next-intl\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport {\r\n    Dialog,\r\n    DialogContent,\r\n    DialogDescription,\r\n    DialogFooter,\r\n    DialogHeader,\r\n    DialogTitle,\r\n} from \"@/components/ui/dialog\"\r\nimport { \r\n    Envelope, \r\n    Key, \r\n    Shield,\r\n    SpinnerGap,\r\n    Eye,\r\n    EyeSlash,\r\n    CheckCircle,\r\n    DeviceMobile\r\n} from \"@phosphor-icons/react\"\r\nimport { toast } from \"sonner\"\nimport { createClient } from \"@/lib/supabase/client\"\nimport { validatePassword, validateEmail } from \"@/lib/validation/auth\"\n\r\ninterface SecurityContentProps {\r\n    locale: string\r\n    userEmail: string\r\n}\r\n\r\nexport function SecurityContent({ locale, userEmail }: SecurityContentProps) {\n    const tAuth = useTranslations(\"Auth\")\n    const [isChangePasswordOpen, setIsChangePasswordOpen] = useState(false)\n    const [isChangeEmailOpen, setIsChangeEmailOpen] = useState(false)\n    const [isLoading, setIsLoading] = useState(false)\n    const [showNewPassword, setShowNewPassword] = useState(false)\n    \r\n    const [passwordData, setPasswordData] = useState({\r\n        currentPassword: \"\",\r\n        newPassword: \"\",\r\n        confirmPassword: \"\"\r\n    })\r\n    \r\n    const [emailData, setEmailData] = useState({\r\n        newEmail: \"\",\r\n        password: \"\"\r\n    })\r\n\r\n    const supabase = createClient()\r\n\r\n    const handleChangePassword = async () => {\n        // Validate password with Zod\n        const passwordValidation = validatePassword(passwordData.newPassword)\n        if (!passwordValidation.valid) {\n            toast.error(tAuth(passwordValidation.errors[0] as never))\n            return\n        }\n\n        if (passwordData.newPassword !== passwordData.confirmPassword) {\n            toast.error(tAuth(\"passwordsDoNotMatch\"))\n            return\n        }\n\r\n        setIsLoading(true)\r\n        try {\r\n            const { error } = await supabase.auth.updateUser({\r\n                password: passwordData.newPassword\r\n            })\r\n\r\n            if (error) throw error\r\n\r\n            toast.success(locale === 'bg' ? '╨ƒ╨░╤Ç╨╛╨╗╨░╤é╨░ ╨╡ ╨┐╤Ç╨╛╨╝╨╡╨╜╨╡╨╜╨░ ╤â╤ü╨┐╨╡╤ê╨╜╨╛' : 'Password changed successfully')\r\n            setIsChangePasswordOpen(false)\r\n            setPasswordData({ currentPassword: \"\", newPassword: \"\", confirmPassword: \"\" })\r\n        } catch (error) {\r\n            console.error('Error changing password:', error)\r\n            const message = error instanceof Error ? error.message : (locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨┐╤Ç╨╛╨╝╤Å╨╜╨░ ╨╜╨░ ╨┐╨░╤Ç╨╛╨╗╨░╤é╨░' : 'Error changing password')\r\n            toast.error(message)\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    const handleChangeEmail = async () => {\n        // Validate email with Zod\n        const emailValidation = validateEmail(emailData.newEmail)\n        if (!emailValidation.valid) {\n            toast.error(tAuth(emailValidation.error as never))\n            return\n        }\n\r\n        setIsLoading(true)\r\n        try {\r\n            const { error } = await supabase.auth.updateUser({\r\n                email: emailData.newEmail\r\n            })\r\n\r\n            if (error) throw error\r\n\r\n            toast.success(\r\n                locale === 'bg' \r\n                    ? '╨ÿ╨╖╨┐╤Ç╨░╤é╨╡╨╜ ╨╡ ╨╕╨╝╨╡╨╣╨╗ ╨╖╨░ ╨┐╨╛╤é╨▓╤è╤Ç╨╢╨┤╨╡╨╜╨╕╨╡ ╨╜╨░ ╨╜╨╛╨▓╨╕╤Å ╨░╨┤╤Ç╨╡╤ü' \r\n                    : 'A confirmation email has been sent to your new address'\r\n            )\r\n            setIsChangeEmailOpen(false)\r\n            setEmailData({ newEmail: \"\", password: \"\" })\r\n        } catch (error) {\r\n            console.error('Error changing email:', error)\r\n            const message = error instanceof Error ? error.message : (locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨┐╤Ç╨╛╨╝╤Å╨╜╨░ ╨╜╨░ ╨╕╨╝╨╡╨╣╨╗╨░' : 'Error changing email')\r\n            toast.error(message)\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    // Reset password via email - can be exposed in UI later\r\n    const _handleResetPassword = async () => {\r\n        setIsLoading(true)\r\n        try {\r\n            const { error } = await supabase.auth.resetPasswordForEmail(userEmail, {\r\n                redirectTo: `${window.location.origin}/auth/reset-password`\r\n            })\r\n\r\n            if (error) throw error\r\n\r\n            toast.success(\r\n                locale === 'bg' \r\n                    ? '╨ÿ╨╖╨┐╤Ç╨░╤é╨╡╨╜ ╨╡ ╨╕╨╝╨╡╨╣╨╗ ╤ü ╨╕╨╜╤ü╤é╤Ç╤â╨║╤å╨╕╨╕ ╨╖╨░ ╨╜╤â╨╗╨╕╤Ç╨░╨╜╨╡ ╨╜╨░ ╨┐╨░╤Ç╨╛╨╗╨░╤é╨░' \r\n                    : 'Password reset email sent'\r\n            )\r\n        } catch (error) {\r\n            console.error('Error sending reset email:', error)\r\n            const message = error instanceof Error ? error.message : (locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨╕╨╖╨┐╤Ç╨░╤ë╨░╨╜╨╡ ╨╜╨░ ╨╕╨╝╨╡╨╣╨╗' : 'Error sending email')\r\n            toast.error(message)\r\n        } finally {\r\n            setIsLoading(false)\r\n        }\r\n    }\r\n\r\n    // Password strength indicator - uses validation rules\r\n    const getPasswordStrength = (password: string) => {\r\n        if (password.length === 0) return null\r\n        \r\n        const hasLetter = /[a-zA-Z]/.test(password)\r\n        const hasNumber = /[0-9]/.test(password)\r\n        const hasSpecial = /[^a-zA-Z0-9]/.test(password)\r\n        \r\n        // Calculate strength based on criteria met\r\n        let score = 0\r\n        if (password.length >= 8) score++\r\n        if (password.length >= 12) score++\r\n        if (hasLetter) score++\r\n        if (hasNumber) score++\r\n        if (hasSpecial) score++\r\n        \r\n        if (score <= 2) return { label: locale === 'bg' ? '╨í╨╗╨░╨▒╨░' : 'Weak', color: 'text-destructive', width: 'w-1/4' }\r\n        if (score === 3) return { label: locale === 'bg' ? '╨í╤Ç╨╡╨┤╨╜╨░' : 'Fair', color: 'text-warning', width: 'w-2/4' }\r\n        if (score === 4) return { label: locale === 'bg' ? '╨ö╨╛╨▒╤Ç╨░' : 'Good', color: 'text-info', width: 'w-3/4' }\r\n        return { label: locale === 'bg' ? '╨í╨╕╨╗╨╜╨░' : 'Strong', color: 'text-success', width: 'w-full' }\r\n    }\r\n\r\n    // Get password validation errors for display\n    const passwordErrors = passwordData.newPassword.length > 0 \n        ? validatePassword(passwordData.newPassword).errors \n        : []\n\r\n    const passwordStrength = getPasswordStrength(passwordData.newPassword)\r\n    \r\n    // Check if password meets minimum requirements for submit button\n    const isPasswordValid = validatePassword(passwordData.newPassword).valid\n\r\n    return (\r\n        <div className=\"space-y-4\">\r\n            {/* Mobile: Clean list-based UI */}\r\n            <div className=\"rounded-lg border bg-card divide-y\">\r\n                {/* Email Row */}\r\n                <button\r\n                    onClick={() => setIsChangeEmailOpen(true)}\r\n                    className=\"w-full flex items-center gap-3 p-3 text-left active:bg-active transition-colors\"\r\n                >\r\n                    <div className=\"flex size-10 items-center justify-center rounded-full bg-muted\">\r\n                        <Envelope className=\"size-5 text-muted-foreground\" />\r\n                    </div>\r\n                    <div className=\"flex-1 min-w-0\">\r\n                        <p className=\"text-sm font-medium\">{locale === 'bg' ? '╨ÿ╨╝╨╡╨╣╨╗' : 'Email'}</p>\r\n                        <p className=\"text-xs text-muted-foreground truncate\">{userEmail}</p>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-1.5 text-xs text-success\">\r\n                        <CheckCircle className=\"size-3.5\" weight=\"fill\" />\r\n                        <span className=\"hidden sm:inline\">{locale === 'bg' ? '╨ƒ╨╛╤é╨▓╤è╤Ç╨┤╨╡╨╜' : 'Verified'}</span>\r\n                    </div>\r\n                </button>\r\n\r\n                {/* Password Row */}\r\n                <div\r\n                    onClick={() => setIsChangePasswordOpen(true)}\r\n                    onKeyDown={(e) => {\r\n                        if (e.key === \"Enter\" || e.key === \" \") {\r\n                            e.preventDefault()\r\n                            setIsChangePasswordOpen(true)\r\n                        }\r\n                    }}\r\n                    role=\"button\"\r\n                    tabIndex={0}\r\n                    className=\"w-full flex items-center gap-3 p-3 text-left active:bg-active transition-colors\"\r\n                >\r\n                    <div className=\"flex size-10 items-center justify-center rounded-full bg-muted\">\r\n                        <Key className=\"size-5 text-muted-foreground\" />\r\n                    </div>\r\n                    <div className=\"flex-1 min-w-0\">\r\n                        <p className=\"text-sm font-medium\">{locale === 'bg' ? '╨ƒ╨░╤Ç╨╛╨╗╨░' : 'Password'}</p>\r\n                        <p className=\"text-xs text-muted-foreground\">ΓÇóΓÇóΓÇóΓÇóΓÇóΓÇóΓÇóΓÇó</p>\r\n                    </div>\r\n                    <Button \r\n                        variant=\"ghost\" \r\n                        size=\"sm\" \r\n                        className=\"h-7 text-xs\"\r\n                        onClick={(e) => {\r\n                            e.stopPropagation()\r\n                            setIsChangePasswordOpen(true)\r\n                        }}\r\n                    >\r\n                        {locale === 'bg' ? '╨ƒ╤Ç╨╛╨╝╨╡╨╜╨╕' : 'Change'}\r\n                    </Button>\r\n                </div>\r\n\r\n                {/* 2FA Row */}\r\n                <div className=\"flex items-center gap-3 p-3\">\r\n                    <div className=\"flex size-10 items-center justify-center rounded-full bg-muted\">\r\n                        <DeviceMobile className=\"size-5 text-muted-foreground\" />\r\n                    </div>\r\n                    <div className=\"flex-1 min-w-0\">\r\n                        <p className=\"text-sm font-medium\">{locale === 'bg' ? '2FA' : '2FA'}</p>\r\n                        <p className=\"text-xs text-muted-foreground\">\r\n                            {locale === 'bg' ? '╨¥╨╡ ╨╡ ╨░╨║╤é╨╕╨▓╨╕╤Ç╨░╨╜╨░' : 'Not enabled'}\r\n                        </p>\r\n                    </div>\r\n                    <Button variant=\"outline\" size=\"sm\" className=\"h-7 text-xs\" disabled>\r\n                        {locale === 'bg' ? '╨í╨║╨╛╤Ç╨╛' : 'Soon'}\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Security Tips - Simplified */}\r\n            <div className=\"rounded-lg border bg-surface-subtle p-3\">\r\n                <div className=\"flex items-center gap-2 mb-2\">\r\n                    <Shield className=\"size-4 text-primary\" weight=\"fill\" />\r\n                    <span className=\"text-sm font-medium\">{locale === 'bg' ? '╨í╤è╨▓╨╡╤é╨╕' : 'Tips'}</span>\r\n                </div>\r\n                <ul className=\"space-y-1.5 text-xs text-muted-foreground\">\r\n                    <li className=\"flex items-start gap-2\">\r\n                        <CheckCircle className=\"size-3 text-success mt-0.5 shrink-0\" />\r\n                        {locale === 'bg' \r\n                            ? '╨ÿ╨╖╨┐╨╛╨╗╨╖╨▓╨░╨╣╤é╨╡ ╤â╨╜╨╕╨║╨░╨╗╨╜╨░ ╨┐╨░╤Ç╨╛╨╗╨░'\r\n                            : 'Use a unique password'}\r\n                    </li>\r\n                    <li className=\"flex items-start gap-2\">\r\n                        <CheckCircle className=\"size-3 text-success mt-0.5 shrink-0\" />\r\n                        {locale === 'bg' \r\n                            ? '╨¥╨╕╨║╨╛╨│╨░ ╨╜╨╡ ╤ü╨┐╨╛╨┤╨╡╨╗╤Å╨╣╤é╨╡ ╨┐╨░╤Ç╨╛╨╗╨░╤é╨░ ╤ü╨╕'\r\n                            : 'Never share your password'}\r\n                    </li>\r\n                </ul>\r\n            </div>\r\n\r\n            {/* Change Password Dialog */}\r\n            <Dialog open={isChangePasswordOpen} onOpenChange={setIsChangePasswordOpen}>\r\n                <DialogContent>\r\n                    <DialogHeader>\r\n                        <DialogTitle>\r\n                            {locale === 'bg' ? '╨ƒ╤Ç╨╛╨╝╤Å╨╜╨░ ╨╜╨░ ╨┐╨░╤Ç╨╛╨╗╨░╤é╨░' : 'Change Password'}\r\n                        </DialogTitle>\r\n                        <DialogDescription>\r\n                            {locale === 'bg' \r\n                                ? '╨Æ╤è╨▓╨╡╨┤╨╡╤é╨╡ ╨╜╨╛╨▓╨░╤é╨░ ╤ü╨╕ ╨┐╨░╤Ç╨╛╨╗╨░'\r\n                                : 'Enter your new password'}\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n\r\n                    <div className=\"space-y-4 py-4\">\r\n                        <div className=\"space-y-2\">\r\n                            <Label>{locale === 'bg' ? '╨¥╨╛╨▓╨░ ╨┐╨░╤Ç╨╛╨╗╨░' : 'New Password'}</Label>\r\n                            <div className=\"relative\">\r\n                                <Input \r\n                                    type={showNewPassword ? \"text\" : \"password\"}\r\n                                    value={passwordData.newPassword}\r\n                                    onChange={(e) => setPasswordData(prev => ({ ...prev, newPassword: e.target.value }))}\r\n                                    placeholder=\"ΓÇóΓÇóΓÇóΓÇóΓÇóΓÇóΓÇóΓÇó\"\r\n                                />\r\n                                <Button\r\n                                    type=\"button\"\r\n                                    variant=\"ghost\"\r\n                                    size=\"icon\"\r\n                                    className=\"absolute right-0 top-0 h-full px-3\"\r\n                                    onClick={() => setShowNewPassword(!showNewPassword)}\r\n                                >\r\n                                    {showNewPassword ? <EyeSlash className=\"size-4\" /> : <Eye className=\"size-4\" />}\r\n                                </Button>\r\n                            </div>\r\n                            {passwordStrength && (\r\n                                <div className=\"space-y-1\">\r\n                                    <div className=\"h-1 bg-muted rounded-full overflow-hidden\">\r\n                                        <div className={`h-full bg-current ${passwordStrength.color} ${passwordStrength.width} transition-all`} />\r\n                                    </div>\r\n                                    <p className={`text-xs ${passwordStrength.color}`}>\r\n                                        {passwordStrength.label}\r\n                                    </p>\r\n                                </div>\r\n                            )}\r\n                            {passwordErrors.length > 0 && (\n                                <ul className=\"text-xs text-destructive space-y-0.5 mt-1\">\n                                    {passwordErrors.map((error, i) => (\n                                        <li key={i}>ΓÇó {tAuth(error as never)}</li>\n                                    ))}\n                                </ul>\n                            )}\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label>{locale === 'bg' ? '╨ƒ╨╛╤é╨▓╤è╤Ç╨┤╨╕ ╨┐╨░╤Ç╨╛╨╗╨░╤é╨░' : 'Confirm Password'}</Label>\r\n                            <Input \r\n                                type=\"password\"\r\n                                value={passwordData.confirmPassword}\r\n                                onChange={(e) => setPasswordData(prev => ({ ...prev, confirmPassword: e.target.value }))}\r\n                                placeholder=\"ΓÇóΓÇóΓÇóΓÇóΓÇóΓÇóΓÇóΓÇó\"\r\n                            />\r\n                            {passwordData.confirmPassword && passwordData.newPassword !== passwordData.confirmPassword && (\n                                <p className=\"text-xs text-destructive\">\n                                    {tAuth(\"passwordsDoNotMatch\")}\n                                </p>\n                            )}\n                        </div>\r\n                    </div>\r\n\r\n                    <DialogFooter>\r\n                        <Button variant=\"outline\" onClick={() => setIsChangePasswordOpen(false)}>\r\n                            {locale === 'bg' ? '╨₧╤é╨║╨░╨╖' : 'Cancel'}\r\n                        </Button>\r\n                        <Button \r\n                            onClick={handleChangePassword} \r\n                            disabled={isLoading || passwordData.newPassword !== passwordData.confirmPassword || !isPasswordValid}\r\n                        >\r\n                            {isLoading && <SpinnerGap className=\"size-4 mr-2 animate-spin\" />}\r\n                            {locale === 'bg' ? '╨ƒ╤Ç╨╛╨╝╨╡╨╜╨╕ ╨┐╨░╤Ç╨╛╨╗╨░╤é╨░' : 'Change Password'}\r\n                        </Button>\r\n                    </DialogFooter>\r\n                </DialogContent>\r\n            </Dialog>\r\n\r\n            {/* Change Email Dialog */}\r\n            <Dialog open={isChangeEmailOpen} onOpenChange={setIsChangeEmailOpen}>\r\n                <DialogContent>\r\n                    <DialogHeader>\r\n                        <DialogTitle>\r\n                            {locale === 'bg' ? '╨ƒ╤Ç╨╛╨╝╤Å╨╜╨░ ╨╜╨░ ╨╕╨╝╨╡╨╣╨╗' : 'Change Email'}\r\n                        </DialogTitle>\r\n                        <DialogDescription>\r\n                            {locale === 'bg' \r\n                                ? '╨Æ╤è╨▓╨╡╨┤╨╡╤é╨╡ ╨╜╨╛╨▓╨╕╤Å ╤ü╨╕ ╨╕╨╝╨╡╨╣╨╗ ╨░╨┤╤Ç╨╡╤ü. ╨⌐╨╡ ╨┐╨╛╨╗╤â╤ç╨╕╤é╨╡ ╨╕╨╝╨╡╨╣╨╗ ╨╖╨░ ╨┐╨╛╤é╨▓╤è╤Ç╨╢╨┤╨╡╨╜╨╕╨╡.'\r\n                                : 'Enter your new email address. You will receive a confirmation email.'}\r\n                        </DialogDescription>\r\n                    </DialogHeader>\r\n\r\n                    <div className=\"space-y-4 py-4\">\r\n                        <div className=\"space-y-2\">\r\n                            <Label>{locale === 'bg' ? '╨ó╨╡╨║╤â╤ë ╨╕╨╝╨╡╨╣╨╗' : 'Current Email'}</Label>\r\n                            <Input value={userEmail} disabled />\r\n                        </div>\r\n\r\n                        <div className=\"space-y-2\">\r\n                            <Label>{locale === 'bg' ? '╨¥╨╛╨▓ ╨╕╨╝╨╡╨╣╨╗' : 'New Email'}</Label>\r\n                            <Input \r\n                                type=\"email\"\r\n                                value={emailData.newEmail}\r\n                                onChange={(e) => setEmailData(prev => ({ ...prev, newEmail: e.target.value }))}\r\n                                placeholder=\"new@example.com\"\r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    <DialogFooter>\r\n                        <Button variant=\"outline\" onClick={() => setIsChangeEmailOpen(false)}>\r\n                            {locale === 'bg' ? '╨₧╤é╨║╨░╨╖' : 'Cancel'}\r\n                        </Button>\r\n                        <Button \r\n                            onClick={handleChangeEmail} \r\n                            disabled={isLoading || !validateEmail(emailData.newEmail).valid}\n                        >\r\n                            {isLoading && <SpinnerGap className=\"size-4 mr-2 animate-spin\" />}\r\n                            {locale === 'bg' ? '╨ƒ╤Ç╨╛╨╝╨╡╨╜╨╕ ╨╕╨╝╨╡╨╣╨╗╨░' : 'Change Email'}\r\n                        </Button>\r\n                    </DialogFooter>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\selling\\[id]\\edit\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\selling\\edit\\edit-product-client.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 50 to the 25 allowed.","line":64,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":64,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport { useRouter } from \"@/i18n/routing\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport Image from \"next/image\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport { AppBreadcrumb } from \"@/components/shared/navigation/app-breadcrumb\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Switch } from \"@/components/ui/switch\"\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport { Skeleton } from \"@/components/ui/skeleton\"\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport { BULGARIAN_CITIES } from \"@/lib/bulgarian-cities\"\r\nimport { useToast } from \"@/hooks/use-toast\"\r\nimport { BoostDialog } from \"@/components/shared/seller/boost-dialog\"\r\nimport {\r\n  ArrowLeft,\r\n  Package,\r\n  Tag,\r\n  CurrencyCircleDollar,\r\n  Percent,\r\n  FloppyDisk,\r\n  Lightning,\r\n} from \"@phosphor-icons/react\"\r\n\r\ninterface Product {\r\n  id: string\r\n  title: string\r\n  description: string | null\r\n  price: number\r\n  list_price: number | null\r\n  is_on_sale?: boolean | null\r\n  sale_percent?: number | null\r\n  sale_end_date?: string | null\r\n  seller_city?: string | null\r\n  stock: number\r\n  images: string[] | null\r\n  is_boosted: boolean | null\r\n  boost_expires_at: string | null\r\n  is_featured: boolean | null\r\n  ships_to_bulgaria: boolean | null\r\n  ships_to_europe: boolean | null\r\n  ships_to_usa: boolean | null\r\n  ships_to_worldwide: boolean | null\r\n  [key: string]: unknown // Allow other DB fields\r\n}\r\n\r\ninterface EditProductClientProps {\r\n  productId: string\r\n  locale: string\r\n}\r\n\r\nexport function EditProductClient({ productId, locale }: EditProductClientProps) {\r\n  const router = useRouter()\r\n  const { toast } = useToast()\r\n\r\n  const [isLoading, setIsLoading] = useState(true)\r\n  const [isSaving, setIsSaving] = useState(false)\r\n  const [product, setProduct] = useState<Product | null>(null)\r\n\r\n  // Form state\r\n  const [title, setTitle] = useState(\"\")\r\n  const [description, setDescription] = useState(\"\")\r\n  const [price, setPrice] = useState(\"\")\r\n  const [stock, setStock] = useState(\"\")\r\n\r\n  // Discount state\r\n  const [isOnSale, setIsOnSale] = useState(false)\r\n  const [originalPrice, setOriginalPrice] = useState(\"\")\r\n  const [saleEndDateLocal, setSaleEndDateLocal] = useState(\"\")\r\n\r\n  // Boost state\r\n  // Shipping state\r\n  const [shipsBulgaria, setShipsBulgaria] = useState(true)\r\n  const [shipsEurope, setShipsEurope] = useState(false)\r\n  const [shipsUSA, setShipsUSA] = useState(false)\r\n  const [shipsWorldwide, setShipsWorldwide] = useState(false)\r\n  const [sellerCity, setSellerCity] = useState<string>(\"\")\r\n\r\n  useEffect(() => {\r\n    async function fetchProduct() {\r\n      const supabase = createClient()\r\n\r\n      // Check auth\r\n      const { data: { user } } = await supabase.auth.getUser()\r\n      if (!user) {\r\n        router.push(\"/auth/login\")\r\n        return\r\n      }\r\n\r\n      // Fetch product\r\n      const { data, error } = await supabase\r\n        .from(\"products\")\r\n        .select(\r\n          \"id,title,description,price,list_price,is_on_sale,sale_percent,sale_end_date,seller_city,stock,images,is_boosted,boost_expires_at,is_featured,ships_to_bulgaria,ships_to_europe,ships_to_usa,ships_to_worldwide\"\r\n        )\r\n        .eq(\"id\", productId)\r\n        .eq(\"seller_id\", user.id)\r\n        .single()\r\n\r\n      if (error || !data) {\r\n        toast({\r\n          title: locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨║╨░' : 'Error',\r\n          description: locale === 'bg' ? '╨ƒ╤Ç╨╛╨┤╤â╨║╤é╤è╤é ╨╜╨╡ ╨╡ ╨╜╨░╨╝╨╡╤Ç╨╡╨╜' : 'Product not found',\r\n          variant: 'destructive'\r\n        })\r\n        router.push(\"/account/selling\")\r\n        return\r\n      }\r\n\r\n      setProduct(data)\r\n      setTitle(data.title)\r\n      setDescription(data.description || \"\")\r\n      setPrice(String(data.price))\r\n      setStock(String(data.stock))\r\n      setShipsBulgaria(data.ships_to_bulgaria ?? true)\r\n      setShipsEurope(data.ships_to_europe ?? false)\r\n      setShipsUSA(data.ships_to_usa ?? false)\r\n      setShipsWorldwide(data.ships_to_worldwide ?? false)\r\n      setSellerCity((data.seller_city as string | null) || \"\")\r\n\r\n      // Truth semantics: prefer explicit sale fields; fall back to legacy list_price > price.\r\n      const truthOnSale = Boolean(data.is_on_sale) && (Number(data.sale_percent) || 0) > 0\r\n      const legacyOnSale = Boolean(data.list_price && data.list_price > data.price)\r\n\r\n      if (truthOnSale || legacyOnSale) {\r\n        setIsOnSale(true)\r\n        if (data.list_price && data.list_price > data.price) {\r\n          setOriginalPrice(String(data.list_price))\r\n        } else {\r\n          setOriginalPrice(\"\")\r\n        }\r\n      }\r\n\r\n      if (data.sale_end_date) {\r\n        const d = new Date(data.sale_end_date)\r\n        if (!Number.isNaN(d.getTime())) {\r\n          // Convert to datetime-local value in local time.\r\n          const tzOffsetMs = d.getTimezoneOffset() * 60 * 1000\r\n          const local = new Date(d.getTime() - tzOffsetMs)\r\n          setSaleEndDateLocal(local.toISOString().slice(0, 16))\r\n        }\r\n      } else {\r\n        setSaleEndDateLocal(\"\")\r\n      }\r\n\r\n      setIsLoading(false)\r\n    }\r\n\r\n    fetchProduct()\r\n  }, [productId, router, locale, toast])\r\n\r\n  const calculateDiscount = () => {\r\n    if (!isOnSale || !originalPrice || !price) return 0\r\n    const orig = Number.parseFloat(originalPrice)\r\n    const current = Number.parseFloat(price)\r\n    if (orig <= 0 || current >= orig) return 0\r\n    return Math.round(((orig - current) / orig) * 100)\r\n  }\r\n\r\n  const getSaleEndDateIso = (): string | null => {\r\n    if (!saleEndDateLocal) return null\r\n    const d = new Date(saleEndDateLocal)\r\n    if (Number.isNaN(d.getTime())) return null\r\n    return d.toISOString()\r\n  }\r\n\r\n  const handleSave = async () => {\r\n    if (!product) return\r\n\r\n    setIsSaving(true)\r\n    const supabase = createClient()\r\n\r\n    const updateData: Record<string, unknown> = {\r\n      title,\r\n      description: description || null,\r\n      price: Number.parseFloat(price),\r\n      stock: Number.parseInt(stock),\r\n      ships_to_bulgaria: shipsBulgaria,\r\n      ships_to_europe: shipsEurope,\r\n      ships_to_usa: shipsUSA,\r\n      ships_to_worldwide: shipsWorldwide,\r\n      seller_city: sellerCity || null,\r\n    }\r\n\r\n    // Handle discount pricing\r\n    if (isOnSale && originalPrice) {\r\n      updateData.list_price = Number.parseFloat(originalPrice)\r\n      updateData.is_on_sale = true\r\n      updateData.sale_percent = calculateDiscount()\r\n      updateData.sale_end_date = getSaleEndDateIso()\r\n    } else {\r\n      updateData.list_price = null\r\n      updateData.is_on_sale = false\r\n      updateData.sale_percent = 0\r\n      updateData.sale_end_date = null\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from(\"products\")\r\n      .update(updateData)\r\n      .eq(\"id\", productId)\r\n\r\n    if (error) {\r\n      toast({\r\n        title: locale === 'bg' ? '╨ô╤Ç╨╡╤ê╨║╨░' : 'Error',\r\n        description: locale === 'bg' ? '╨¥╨╡╤â╤ü╨┐╨╡╤ê╨╜╨╛ ╨╖╨░╨┐╨░╨╖╨▓╨░╨╜╨╡' : 'Failed to save changes',\r\n        variant: 'destructive'\r\n      })\r\n    } else {\r\n      toast({\r\n        title: locale === 'bg' ? '╨ú╤ü╨┐╨╡╤à!' : 'Success!',\r\n        description: locale === 'bg' ? '╨ƒ╤Ç╨╛╨╝╨╡╨╜╨╕╤é╨╡ ╤ü╨░ ╨╖╨░╨┐╨░╨╖╨╡╨╜╨╕' : 'Changes saved successfully',\r\n      })\r\n      router.push(\"/account/selling\")\r\n    }\r\n\r\n    setIsSaving(false)\r\n  }\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"py-4 sm:py-6\">\r\n        <Skeleton className=\"h-8 w-64 mb-4\" />\r\n        <Skeleton className=\"h-(--spacing-scroll-xl) w-full\" />\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"py-4 sm:py-6\">\r\n      {/* Breadcrumb */}\r\n      <AppBreadcrumb items={[\r\n        { label: locale === 'bg' ? '╨É╨║╨░╤â╨╜╤é' : 'Account', href: '/account' },\r\n        { label: locale === 'bg' ? '╨£╨╛╤Å╤é ╨╝╨░╨│╨░╨╖╨╕╨╜' : 'My Store', href: '/account/selling' },\r\n        { label: locale === 'bg' ? '╨á╨╡╨┤╨░╨║╤é╨╕╤Ç╨░╨╜╨╡' : 'Edit Product' }\r\n      ]} />\r\n\r\n      {/* Header */}\r\n      <div className=\"flex items-center gap-4 mt-4 mb-6\">\r\n        <Button variant=\"ghost\" size=\"icon\" asChild>\r\n          <Link href=\"/account/selling\">\r\n            <ArrowLeft className=\"size-5\" />\r\n          </Link>\r\n        </Button>\r\n        <div>\r\n          <h1 className=\"text-xl sm:text-2xl font-bold text-foreground\">\r\n            {locale === 'bg' ? '╨á╨╡╨┤╨░╨║╤é╨╕╤Ç╨░╨╜╨╡ ╨╜╨░ ╨┐╤Ç╨╛╨┤╤â╨║╤é' : 'Edit Product'}\r\n          </h1>\r\n          <p className=\"text-sm text-muted-foreground mt-0.5\">\r\n            {locale === 'bg' ? '╨ƒ╤Ç╨╛╨╝╨╡╨╜╨╡╤é╨╡ ╨┤╨╡╤é╨░╨╣╨╗╨╕, ╤å╨╡╨╜╨░ ╨╕ ╨╜╨░╤ü╤é╤Ç╨╛╨╣╨║╨╕' : 'Update details, pricing, and settings'}\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"grid lg:grid-cols-3 gap-4\">\r\n        {/* Main Form */}\r\n        <div className=\"lg:col-span-2 space-y-6\">\r\n          {/* Basic Info */}\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                <Package className=\"size-5\" />\r\n                {locale === 'bg' ? '╨₧╤ü╨╜╨╛╨▓╨╜╨░ ╨╕╨╜╤ä╨╛╤Ç╨╝╨░╤å╨╕╤Å' : 'Basic Information'}\r\n              </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"title\">{locale === 'bg' ? '╨ù╨░╨│╨╗╨░╨▓╨╕╨╡' : 'Title'}</Label>\r\n                <Input\r\n                  id=\"title\"\r\n                  value={title}\r\n                  onChange={(e) => setTitle(e.target.value)}\r\n                  placeholder={locale === 'bg' ? '╨ÿ╨╝╨╡ ╨╜╨░ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨░' : 'Product name'}\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"description\">{locale === 'bg' ? '╨₧╨┐╨╕╤ü╨░╨╜╨╕╨╡' : 'Description'}</Label>\r\n                <Textarea\r\n                  id=\"description\"\r\n                  value={description}\r\n                  onChange={(e) => setDescription(e.target.value)}\r\n                  placeholder={locale === 'bg' ? '╨₧╨┐╨╕╤ü╨░╨╜╨╕╨╡ ╨╜╨░ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨░' : 'Product description'}\r\n                  rows={4}\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"stock\">{locale === 'bg' ? '╨Ü╨╛╨╗╨╕╤ç╨╡╤ü╤é╨▓╨╛ ╨▓ ╤ü╨║╨╗╨░╨┤' : 'Stock Quantity'}</Label>\r\n                <Input\r\n                  id=\"stock\"\r\n                  type=\"number\"\r\n                  min=\"0\"\r\n                  value={stock}\r\n                  onChange={(e) => setStock(e.target.value)}\r\n                />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Pricing & Discount */}\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"text-lg flex items-center gap-2\">\r\n                <CurrencyCircleDollar className=\"size-5\" />\r\n                {locale === 'bg' ? '╨ª╨╡╨╜╨░ ╨╕ ╨╜╨░╨╝╨░╨╗╨╡╨╜╨╕╨╡' : 'Pricing & Discount'}\r\n              </CardTitle>\r\n              <CardDescription>\r\n                {locale === 'bg'\r\n                  ? '╨ù╨░╨┤╨░╨╣╤é╨╡ ╤Ç╨╡╨┤╨╛╨▓╨╜╨░ ╤å╨╡╨╜╨░ ╨╕╨╗╨╕ ╨░╨║╤é╨╕╨▓╨╕╤Ç╨░╨╣╤é╨╡ ╨╜╨░╨╝╨░╨╗╨╡╨╜╨╕╨╡'\r\n                  : 'Set regular price or enable a sale discount'}\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-6\">\r\n              {/* Regular Price */}\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"price\">\r\n                  {isOnSale\r\n                    ? (locale === 'bg' ? '╨ª╨╡╨╜╨░ ╤ü ╨╜╨░╨╝╨░╨╗╨╡╨╜╨╕╨╡' : 'Sale Price')\r\n                    : (locale === 'bg' ? '╨ª╨╡╨╜╨░' : 'Price')\r\n                  } (╨╗╨▓)\r\n                </Label>\r\n                <Input\r\n                  id=\"price\"\r\n                  type=\"number\"\r\n                  min=\"0\"\r\n                  step=\"0.01\"\r\n                  value={price}\r\n                  onChange={(e) => setPrice(e.target.value)}\r\n                  className={isOnSale ? \"border-success focus:ring-success\" : \"\"}\r\n                />\r\n              </div>\r\n\r\n              <Separator />\r\n\r\n              {/* Sale Toggle */}\r\n              <div className=\"flex items-center justify-between p-4 bg-muted rounded-lg\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className=\"size-10 rounded-full bg-destructive-subtle flex items-center justify-center\">\r\n                    <Percent className=\"size-5 text-deal\" />\r\n                  </div>\r\n                  <div>\r\n                    <Label htmlFor=\"sale-toggle\" className=\"text-base font-medium cursor-pointer\">\r\n                      {locale === 'bg' ? '╨Æ╨║╨╗╤Ä╤ç╨╕ ╨╜╨░╨╝╨░╨╗╨╡╨╜╨╕╨╡' : 'Enable Sale'}\r\n                    </Label>\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      {locale === 'bg'\r\n                        ? '╨ƒ╨╛╨║╨░╨╖╨▓╨░ ╨╖╨░╤ç╨╡╤Ç╨║╨╜╨░╤é╨░ ╨╛╤Ç╨╕╨│╨╕╨╜╨░╨╗╨╜╨░ ╤å╨╡╨╜╨░'\r\n                        : 'Shows strikethrough original price'}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n                <Switch\r\n                  id=\"sale-toggle\"\r\n                  checked={isOnSale}\r\n                  onCheckedChange={setIsOnSale}\r\n                />\r\n              </div>\r\n\r\n              {/* Original Price (visible when sale is on) */}\r\n              {isOnSale && (\r\n                <div className=\"space-y-4 p-4 bg-destructive-subtle border border-destructive rounded-lg\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"originalPrice\" className=\"text-deal font-medium\">\r\n                      {locale === 'bg' ? '╨₧╤Ç╨╕╨│╨╕╨╜╨░╨╗╨╜╨░ ╤å╨╡╨╜╨░' : 'Original Price'} (╨╗╨▓)\r\n                    </Label>\r\n                    <Input\r\n                      id=\"originalPrice\"\r\n                      type=\"number\"\r\n                      min=\"0\"\r\n                      step=\"0.01\"\r\n                      value={originalPrice}\r\n                      onChange={(e) => setOriginalPrice(e.target.value)}\r\n                      placeholder={locale === 'bg' ? '╨ª╨╡╨╜╨░ ╨┐╤Ç╨╡╨┤╨╕ ╨╜╨░╨╝╨░╨╗╨╡╨╜╨╕╨╡' : 'Price before discount'}\r\n                    />\r\n                  </div>\r\n\r\n                  {calculateDiscount() > 0 && (\r\n                    <div className=\"flex items-center gap-2 p-3 bg-destructive-subtle rounded-md\">\r\n                      <Tag className=\"size-4 text-deal\" weight=\"fill\" />\r\n                      <span className=\"text-sm font-medium text-deal\">\r\n                        {locale === 'bg'\r\n                          ? `╨Ü╤â╨┐╤â╨▓╨░╤ç╨╕╤é╨╡ ╤ë╨╡ ╨▓╨╕╨┤╤Å╤é ${calculateDiscount()}% ╨╜╨░╨╝╨░╨╗╨╡╨╜╨╕╨╡`\r\n                          : `Buyers will see ${calculateDiscount()}% off`\r\n                        }\r\n                      </span>\r\n                    </div>\r\n                  )}\r\n\r\n                  <div className=\"space-y-2\">\r\n                    <Label htmlFor=\"saleEndDate\" className=\"text-deal font-medium\">\r\n                      {locale === 'bg' ? '╨Ü╤Ç╨░╨╣ ╨╜╨░ ╨╛╤ä╨╡╤Ç╤é╨░╤é╨░ (╨┐╨╛ ╨╕╨╖╨▒╨╛╤Ç)' : 'Sale end date (optional)'}\r\n                    </Label>\r\n                    <Input\r\n                      id=\"saleEndDate\"\r\n                      type=\"datetime-local\"\r\n                      value={saleEndDateLocal}\r\n                      onChange={(e) => setSaleEndDateLocal(e.target.value)}\r\n                    />\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Shipping Destinations */}\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"text-lg\">\r\n                {locale === 'bg' ? '╨ö╨╛╤ü╤é╨░╨▓╨║╨░ ╨┤╨╛' : 'Ships To'}\r\n              </CardTitle>\r\n              <CardDescription>\r\n                {locale === 'bg'\r\n                  ? '╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╤Ç╨╡╨│╨╕╨╛╨╜╨╕ ╨╖╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░'\r\n                  : 'Select shipping destinations'}\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              {shipsBulgaria && (\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"text-sm font-medium\">\r\n                    {locale === 'bg' ? '╨ô╤Ç╨░╨┤ (╨╖╨░ ╨¥╨░╨▒╨╗╨╕╨╖╨╛)' : 'City (for Near Me)'}\r\n                  </Label>\r\n                  <Select value={sellerCity} onValueChange={setSellerCity}>\r\n                    <SelectTrigger className=\"h-11 rounded-lg\">\r\n                      <SelectValue placeholder={locale === 'bg' ? '╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨│╤Ç╨░╨┤...' : 'Select city...'} />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {BULGARIAN_CITIES.map((city) => (\r\n                        <SelectItem key={city.value} value={city.value} className=\"font-medium\">\r\n                          {locale === 'bg' ? city.labelBg : city.label}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                    {locale === 'bg' ? '╨ô╤Ç╨░╨┤╤è╤é, ╨╛╤é ╨║╨╛╨╣╤é╨╛ ╨╕╨╖╨┐╤Ç╨░╤ë╨░╤é╨╡ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨░' : 'The city you ship the item from'}\r\n                  </p>\r\n                </div>\r\n              )}\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <div className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <span className=\"text-lg\">≡ƒçº≡ƒç¼</span>\r\n                    <span className=\"text-sm font-medium\">{locale === 'bg' ? '╨æ╤è╨╗╨│╨░╤Ç╨╕╤Å' : 'Bulgaria'}</span>\r\n                  </div>\r\n                  <Switch checked={shipsBulgaria} onCheckedChange={setShipsBulgaria} />\r\n                </div>\r\n                <div className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <span className=\"text-lg\">≡ƒç¬≡ƒç║</span>\r\n                    <span className=\"text-sm font-medium\">{locale === 'bg' ? '╨ò╨▓╤Ç╨╛╨┐╨░' : 'Europe'}</span>\r\n                  </div>\r\n                  <Switch checked={shipsEurope} onCheckedChange={setShipsEurope} />\r\n                </div>\r\n                <div className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <span className=\"text-lg\">≡ƒç║≡ƒç╕</span>\r\n                    <span className=\"text-sm font-medium\">{locale === 'bg' ? '╨í╨É╨⌐' : 'USA'}</span>\r\n                  </div>\r\n                  <Switch checked={shipsUSA} onCheckedChange={setShipsUSA} />\r\n                </div>\r\n                <div className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <span className=\"text-lg\">≡ƒîì</span>\r\n                    <span className=\"text-sm font-medium\">{locale === 'bg' ? '╨ƒ╨╛ ╤å╨╡╨╗╨╕╤Å ╤ü╨▓╤Å╤é' : 'Worldwide'}</span>\r\n                  </div>\r\n                  <Switch checked={shipsWorldwide} onCheckedChange={setShipsWorldwide} />\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        {/* Sidebar */}\r\n        <div className=\"space-y-6\">\r\n          {/* Product Preview */}\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"text-base\">{locale === 'bg' ? '╨ƒ╤Ç╨╡╨│╨╗╨╡╨┤' : 'Preview'}</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"relative aspect-square rounded-lg overflow-hidden bg-muted mb-4\">\r\n                {product?.images?.[0] ? (\r\n                  <Image\r\n                    src={product.images[0]}\r\n                    alt={title}\r\n                    fill\r\n                    className=\"object-cover\"\r\n                  />\r\n                ) : (\r\n                  <div className=\"w-full h-full flex items-center justify-center\">\r\n                    <Package className=\"size-12 text-muted-foreground\" />\r\n                  </div>\r\n                )}\r\n                {isOnSale && calculateDiscount() > 0 && (\r\n                  <div className=\"absolute top-2 left-2 bg-deal text-deal-foreground text-xs font-bold px-2 py-1 rounded\">\r\n                    -{calculateDiscount()}%\r\n                  </div>\r\n                )}\r\n              </div>\r\n              <h3 className=\"font-medium text-sm line-clamp-2\">{title}</h3>\r\n              <div className=\"mt-2\">\r\n                {isOnSale && originalPrice ? (\r\n                  <div className=\"flex items-baseline gap-2\">\r\n                    <span className=\"text-lg font-bold text-deal\">{Number.parseFloat(price || \"0\").toFixed(2)} ╨╗╨▓</span>\r\n                    <span className=\"text-sm text-muted-foreground line-through\">{Number.parseFloat(originalPrice).toFixed(2)} ╨╗╨▓</span>\r\n                  </div>\r\n                ) : (\r\n                  <span className=\"text-lg font-bold\">{Number.parseFloat(price || \"0\").toFixed(2)} ╨╗╨▓</span>\r\n                )}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Boost Option */}\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"text-base flex items-center gap-2\">\r\n                <Lightning className=\"size-5 text-primary\" weight=\"fill\" />\r\n                {locale === 'bg' ? '╨ƒ╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╣' : 'Boost Listing'}\r\n              </CardTitle>\r\n              <CardDescription>\r\n                {locale === 'bg'\r\n                  ? '╨ƒ╨╛╨║╨░╨╖╨▓╨░ ╤ü╨╡ ╨╜╨░ ╨╜╨░╤ç╨░╨╗╨╜╨░ ╤ü╤é╤Ç╨░╨╜╨╕╤å╨░'\r\n                  : 'Featured on homepage'}\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent>\r\n              {product ? (\r\n                <BoostDialog\r\n                  product={{\r\n                    id: product.id,\r\n                    title: product.title,\r\n                    ...(product.is_boosted != null ? { is_boosted: product.is_boosted } : {}),\r\n                    boost_expires_at: product.boost_expires_at,\r\n                  }}\r\n                  locale={locale}\r\n                />\r\n              ) : null}\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Save Button */}\r\n          <Button\r\n            onClick={handleSave}\r\n            disabled={isSaving}\r\n            className=\"w-full gap-2\"\r\n            size=\"lg\"\r\n          >\r\n            <FloppyDisk className=\"size-5\" />\r\n            {isSaving\r\n              ? (locale === 'bg' ? '╨ù╨░╨┐╨░╨╖╨▓╨░╨╜╨╡...' : 'Saving...')\r\n              : (locale === 'bg' ? '╨ù╨░╨┐╨░╨╖╨╕ ╨┐╤Ç╨╛╨╝╨╡╨╜╨╕╤é╨╡' : 'Save Changes')\r\n            }\r\n          </Button>\r\n\r\n          <Button variant=\"outline\" className=\"w-full\" asChild>\r\n            <Link href={`/product/${productId}`}>\r\n              {locale === 'bg' ? '╨Æ╨╕╨╢ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨░' : 'View Product'}\r\n            </Link>\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\selling\\edit\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\selling\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\selling\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/products' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":3,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":8,"endColumn":32},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 30 to the 25 allowed.","line":53,"column":31,"nodeType":null,"messageId":"refactorFunction","endLine":53,"endColumn":42}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/lib/supabase/server\"\r\nimport { Link, redirect } from \"@/i18n/routing\"\r\nimport {\r\n  bulkUpdateProductStatus,\r\n  clearProductDiscount,\r\n  deleteProduct,\r\n  setProductDiscountPrice,\r\n} from \"@/app/actions/products\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n  Plus,\r\n  Package,\r\n  Storefront,\r\n  CurrencyCircleDollar,\r\n  ShoppingCart,\r\n  Warning,\r\n  Star,\r\n  ChartLineUp,\r\n} from \"@phosphor-icons/react/dist/ssr\"\r\nimport { SellingProductsList } from \"./selling-products-list\"\r\n\r\ninterface SellingPageProps {\r\n  params: Promise<{\r\n    locale: string\r\n  }>\r\n}\r\n\r\ninterface Product {\r\n  id: string\r\n  title: string\r\n  description: string | null\r\n  price: number\r\n  list_price: number | null\r\n  is_on_sale: boolean | null\r\n  sale_percent: number | null\r\n  sale_end_date: string | null\r\n  stock: number\r\n  images: string[]\r\n  rating: number | null\r\n  review_count: number | null\r\n  created_at: string\r\n  is_boosted: boolean\r\n  boost_expires_at: string | null\r\n  status?: 'active' | 'draft' | 'archived' | 'out_of_stock'\r\n  category?: {\r\n    name: string\r\n    slug: string\r\n  } | null\r\n}\r\n\r\nexport default async function SellingPage({ params }: SellingPageProps) {\r\n  const { locale } = await params\r\n  const supabase = await createClient()\r\n\r\n  if (!supabase) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n\r\n  if (!user) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  // Check if user has a seller profile (has username)\r\n  const { data: profile } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"id,username,display_name,business_name,verified,created_at\")\r\n    .eq(\"id\", user.id)\r\n    .single()\r\n\r\n  // If no username, redirect to sell page to set one up\r\n  if (!profile || !profile.username) {\r\n    return redirect({ href: \"/sell\", locale })\r\n  }\r\n\r\n  // Map profile to seller format for compatibility\r\n  const seller = {\r\n    ...profile,\r\n    store_name: profile.display_name || profile.business_name || profile.username,\r\n  }\r\n\r\n  // Fetch seller's products\r\n  const { data: products } = await supabase\r\n    .from(\"products\")\r\n    .select(`\r\n      id,\r\n      title,\r\n      description,\r\n      price,\r\n      list_price,\r\n      is_on_sale,\r\n      sale_percent,\r\n      sale_end_date,\r\n      stock,\r\n      images,\r\n      rating,\r\n      review_count,\r\n      created_at,\r\n      is_boosted,\r\n      boost_expires_at,\r\n      status,\r\n      category:categories(name, slug)\r\n    `)\r\n    .eq(\"seller_id\", user.id)\r\n    .order(\"created_at\", { ascending: false })\r\n\r\n  const sellerProducts = (products || []) as unknown as Product[]\r\n\r\n  // Calculate stats\r\n  const totalProducts = sellerProducts.length\r\n  const lowStockProducts = sellerProducts.filter(p => p.stock < 5).length\r\n  const totalValue = sellerProducts.reduce((sum, p) => sum + (Number(p.price) * p.stock), 0)\r\n\r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat(locale, {\r\n      style: 'currency',\r\n      currency: 'EUR',\r\n    }).format(value)\r\n  }\r\n\r\n  const t = {\r\n    products: locale === 'bg' ? '╨┐╤Ç╨╛╨┤╤â╨║╤é╨░' : 'products',\r\n    value: locale === 'bg' ? '╤ü╤é╨╛╨╣╨╜╨╛╤ü╤é' : 'value',\r\n    lowStock: locale === 'bg' ? '╨╜╨╕╤ü╤è╨║ ╤ü╨║╨╗╨░╨┤' : 'low stock',\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 md:gap-4\">\r\n      <h1 className=\"sr-only\">{locale === 'bg' ? '╨£╨╛╤Å╤é ╨╝╨░╨│╨░╨╖╨╕╨╜' : 'My Store'}</h1>\r\n\r\n      {/* Mobile: Revolut-style header with stats pills */}\r\n      <div className=\"sm:hidden\">\r\n        {/* Store info + Add button */}\r\n        <div className=\"flex items-center justify-between mb-4\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"size-11 rounded-full bg-muted border border-border flex items-center justify-center\">\r\n              <Storefront weight=\"fill\" className=\"size-5 text-muted-foreground\" />\r\n            </div>\r\n            <div>\r\n              <div className=\"flex items-center gap-1.5\">\r\n                <span className=\"font-semibold\">{seller.store_name}</span>\r\n                {seller.verified && (\r\n                  <Star weight=\"fill\" className=\"size-3.5 text-success\" />\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <Button asChild size=\"sm\" className=\"h-9 gap-1.5 rounded-full px-4\">\r\n            <Link href=\"/sell\">\r\n              <Plus weight=\"bold\" className=\"size-4\" />\r\n              {locale === 'bg' ? '╨ö╨╛╨▒╨░╨▓╨╕' : 'Add'}\r\n            </Link>\r\n          </Button>\r\n        </div>\r\n\r\n        {/* Revolut-style stats pills */}\r\n        <div className=\"flex items-center gap-3 text-sm\">\r\n          <div className=\"flex items-center gap-2 px-3 py-1.5 rounded-full bg-background border border-border/60\">\r\n            <Package weight=\"duotone\" className=\"size-4 text-primary\" />\r\n            <span className=\"font-semibold\">{totalProducts}</span>\r\n            <span className=\"text-muted-foreground\">{t.products}</span>\r\n          </div>\r\n          {lowStockProducts > 0 && (\r\n            <div className=\"flex items-center gap-2 px-3 py-1.5 rounded-full bg-warning/10 border border-warning/20\">\r\n              <span className=\"size-2 rounded-full bg-warning animate-pulse\" />\r\n              <span className=\"font-semibold text-warning\">{lowStockProducts}</span>\r\n              <span className=\"text-warning/70\">{t.lowStock}</span>\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Desktop: Full header */}\r\n      <div className=\"hidden sm:flex sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n        <div className=\"flex items-center gap-4\">\r\n          <div className=\"size-14 rounded-md bg-muted border border-border flex items-center justify-center\">\r\n            <Storefront weight=\"fill\" className=\"size-7 text-muted-foreground\" />\r\n          </div>\r\n          <div>\r\n            <div className=\"flex items-center gap-2 flex-wrap\">\r\n              <h2 className=\"text-xl font-bold text-foreground\">{seller.store_name}</h2>\r\n              {seller.verified && (\r\n                <Badge variant=\"secondary\" className=\"bg-success/10 text-success border-0\">\r\n                  <Star weight=\"fill\" className=\"size-3 mr-1\" />\r\n                  {locale === 'bg' ? '╨ƒ╨╛╤é╨▓╤è╤Ç╨┤╨╡╨╜' : 'Verified'}\r\n                </Badge>\r\n              )}\r\n            </div>\r\n            <p className=\"text-sm text-muted-foreground mt-0.5\">\r\n              {locale === 'bg' ? '╨º╨╗╨╡╨╜ ╨╛╤é' : 'Member since'} {new Date(seller.created_at).toLocaleDateString(locale)}\r\n            </p>\r\n          </div>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <Button asChild variant=\"outline\" className=\"gap-2 rounded-full\">\r\n            <Link href=\"/account/sales\">\r\n              <ChartLineUp weight=\"bold\" className=\"size-4\" />\r\n              {locale === 'bg' ? '╨ƒ╤Ç╨╛╨┤╨░╨╢╨▒╨╕' : 'Sales'}\r\n            </Link>\r\n          </Button>\r\n          <Button asChild className=\"gap-2 rounded-full\">\r\n            <Link href=\"/sell\">\r\n              <Plus weight=\"bold\" className=\"size-4\" />\r\n              {locale === 'bg' ? '╨¥╨╛╨▓╨░ ╨╛╨▒╤Å╨▓╨░' : 'New Listing'}\r\n            </Link>\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Desktop: Stats Grid - using account tokens */}\r\n      <div className=\"hidden sm:grid grid-cols-2 gap-3 @xl/main:grid-cols-4\">\r\n        <Card className=\"@container/card\">\r\n          <CardHeader className=\"p-4\">\r\n            <CardDescription className=\"flex items-center gap-1.5\">\r\n              <Package weight=\"duotone\" className=\"size-4 shrink-0 text-muted-foreground\" />\r\n              <span className=\"truncate\">{locale === 'bg' ? '╨ƒ╤Ç╨╛╨┤╤â╨║╤é╨╕' : 'Products'}</span>\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl font-semibold tabular-nums @[250px]/card:text-3xl\">\r\n              {totalProducts.toLocaleString()}\r\n            </CardTitle>\r\n            <div className=\"pt-1\">\r\n              <Badge variant=\"outline\" className=\"text-info border-border/60 bg-info/10\">\r\n                {locale === 'bg' ? '╨É╨║╤é╨╕╨▓╨╜╨╕' : 'Active'}\r\n              </Badge>\r\n            </div>\r\n          </CardHeader>\r\n        </Card>\r\n\r\n        <Card className=\"@container/card\">\r\n          <CardHeader className=\"p-4\">\r\n            <CardDescription className=\"flex items-center gap-1.5\">\r\n              <CurrencyCircleDollar weight=\"duotone\" className=\"size-4 shrink-0 text-success\" />\r\n              <span className=\"truncate\">{locale === 'bg' ? '╨í╤é╨╛╨╣╨╜╨╛╤ü╤é' : 'Value'}</span>\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl font-semibold tabular-nums text-success @[250px]/card:text-3xl\">\r\n              {formatCurrency(totalValue)}\r\n            </CardTitle>\r\n            <div className=\"pt-1\">\r\n              <Badge variant=\"outline\" className=\"text-success border-success/20 bg-success/10\">\r\n                {locale === 'bg' ? '╨ÿ╨╜╨▓╨╡╨╜╤é╨░╤Ç' : 'Inventory'}\r\n              </Badge>\r\n            </div>\r\n          </CardHeader>\r\n        </Card>\r\n\r\n        <Card className=\"@container/card\">\r\n          <CardHeader className=\"p-4\">\r\n            <CardDescription className=\"flex items-center gap-1.5\">\r\n              <ShoppingCart weight=\"duotone\" className=\"size-4 shrink-0\" />\r\n              <span className=\"truncate\">{locale === 'bg' ? '╨ƒ╨╛╤Ç╤è╤ç╨║╨╕' : 'Orders'}</span>\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl font-semibold tabular-nums @[250px]/card:text-3xl\">\r\n              0\r\n            </CardTitle>\r\n            <div className=\"pt-1\">\r\n              <Badge variant=\"outline\" className=\"text-muted-foreground border-border\">\r\n                {locale === 'bg' ? '╨ó╨╛╨╖╨╕ ╨╝╨╡╤ü╨╡╤å' : 'This month'}\r\n              </Badge>\r\n            </div>\r\n          </CardHeader>\r\n        </Card>\r\n\r\n        <Card className={`@container/card ${lowStockProducts > 0 ? \"border-warning/20\" : \"\"}`}>\r\n          <CardHeader className=\"p-4\">\r\n            <CardDescription className=\"flex items-center gap-1.5\">\r\n              <Warning weight=\"duotone\" className=\"size-4 shrink-0\" />\r\n              <span className=\"truncate\">{locale === 'bg' ? '╨¥╨╕╤ü╤è╨║ ╤ü╨║╨╗╨░╨┤' : 'Low Stock'}</span>\r\n            </CardDescription>\r\n            <CardTitle className={`text-2xl font-semibold tabular-nums @[250px]/card:text-3xl ${lowStockProducts > 0 ? 'text-warning' : ''}`}>\r\n              {lowStockProducts.toLocaleString()}\r\n            </CardTitle>\r\n            <div className=\"pt-1\">\r\n              {lowStockProducts > 0 ? (\r\n                <Badge variant=\"outline\" className=\"text-warning border-warning/20 bg-warning/10\">\r\n                  {locale === 'bg' ? '╨Æ╨╜╨╕╨╝╨░╨╜╨╕╨╡' : 'Attention'}\r\n                </Badge>\r\n              ) : (\r\n                <Badge variant=\"outline\" className=\"text-muted-foreground border-border\">\r\n                  {locale === 'bg' ? '╨Æ╤ü╨╕╤ç╨║╨╛ ╨╡ ╨₧╨Ü' : 'All good'}\r\n                </Badge>\r\n              )}\r\n            </div>\r\n          </CardHeader>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Products List - No card wrapper on mobile */}\r\n      <div className=\"sm:hidden mt-4\">\r\n        <div className=\"flex items-center justify-between px-1 mb-3\">\r\n          <span className=\"font-semibold text-base text-foreground\">\r\n            {locale === 'bg' ? '╨Æ╨░╤ê╨╕╤é╨╡ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨╕' : 'Your Products'}\r\n          </span>\r\n        </div>\r\n        <SellingProductsList\r\n          products={sellerProducts}\r\n          locale={locale}\r\n          actions={{\r\n            deleteProduct,\r\n            bulkUpdateProductStatus,\r\n            setProductDiscountPrice,\r\n            clearProductDiscount,\r\n          }}\r\n        />\r\n      </div>\r\n\r\n      {/* Desktop: Products in Card */}\r\n      <Card className=\"hidden sm:block shadow-none\">\r\n        <CardHeader className=\"pb-3\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <CardTitle className=\"text-base\">\r\n                {locale === 'bg' ? '╨Æ╨░╤ê╨╕╤é╨╡ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨╕' : 'Your Products'}\r\n              </CardTitle>\r\n              <CardDescription>\r\n                {locale === 'bg' ? '╨ú╨┐╤Ç╨░╨▓╨╗╤Å╨▓╨░╨╣╤é╨╡ ╨▓╨░╤ê╨╕╤é╨╡ ╨╛╨▒╤Å╨▓╨╕' : 'Manage your product listings'}\r\n              </CardDescription>\r\n            </div>\r\n            <Button asChild variant=\"outline\" size=\"sm\" className=\"rounded-full\">\r\n              <Link href=\"/sell\">\r\n                <Plus weight=\"bold\" className=\"size-4 mr-2\" />\r\n                {locale === 'bg' ? '╨ö╨╛╨▒╨░╨▓╨╕' : 'Add'}\r\n              </Link>\r\n            </Button>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent className=\"p-0\">\r\n          <SellingProductsList\r\n            products={sellerProducts}\r\n            locale={locale}\r\n            actions={{\r\n              deleteProduct,\r\n              bulkUpdateProductStatus,\r\n              setProductDiscountPrice,\r\n              clearProductDiscount,\r\n            }}\r\n          />\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\selling\\selling-products-list.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_isPending' is assigned a value but never used.","line":98,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":98,"endColumn":20},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'isBoostActive' to the outer scope.","line":330,"column":44,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":330,"endColumn":46},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'isBoostExpired' to the outer scope.","line":336,"column":45,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":336,"endColumn":47},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getBoostTimeLeft' to the outer scope.","line":342,"column":47,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":342,"endColumn":49},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getBoostDaysLeft' is assigned a value but never used.","line":362,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":362,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useRef, useTransition } from \"react\"\r\nimport { useSearchParams, useRouter } from \"next/navigation\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport Image from \"next/image\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport {\r\n  Plus,\r\n  Package,\r\n  Eye,\r\n  Pencil,\r\n  Star,\r\n  Tag,\r\n  Lightning,\r\n  Trash,\r\n  Pause,\r\n  Play,\r\n} from \"@phosphor-icons/react\"\r\nimport { BoostDialog } from \"@/components/shared/seller/boost-dialog\"\r\nimport { toast } from \"sonner\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n  AlertDialogTrigger,\r\n} from \"@/components/ui/alert-dialog\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\"\r\n\r\nexport type SellingProductsListServerActions = {\r\n  deleteProduct: (productId: string) => Promise<{ success: boolean; error?: string }>\r\n  bulkUpdateProductStatus: (\r\n    productIds: string[],\r\n    status: \"active\" | \"draft\" | \"archived\" | \"out_of_stock\"\r\n  ) => Promise<{ success: boolean; error?: string }>\r\n  setProductDiscountPrice: (\r\n    productId: string,\r\n    newPrice: number\r\n  ) => Promise<{ success: boolean; error?: string }>\r\n  clearProductDiscount: (productId: string) => Promise<{ success: boolean; error?: string }>\r\n}\r\n\r\n\r\ninterface Product {\r\n  id: string\r\n  title: string\r\n  description: string | null\r\n  price: number\r\n  list_price: number | null\r\n  is_on_sale: boolean | null\r\n  sale_percent: number | null\r\n  sale_end_date: string | null\r\n  stock: number\r\n  images: string[]\r\n  rating: number | null\r\n  review_count: number | null\r\n  created_at: string\r\n  is_boosted: boolean\r\n  boost_expires_at: string | null\r\n  status?: 'active' | 'draft' | 'archived' | 'out_of_stock'\r\n  category?: {\r\n    name: string\r\n    slug: string\r\n  } | null\r\n}\r\n\r\ninterface SellingProductsListProps {\r\n  products: Product[]\r\n  locale: string\r\n  actions: SellingProductsListServerActions\r\n}\r\n\r\nexport function SellingProductsList({ products, locale, actions }: SellingProductsListProps) {\r\n  const searchParams = useSearchParams()\r\n  const router = useRouter()\r\n  const tBoost = useTranslations(\"Boost\")\r\n  const t = useTranslations(\"SellingProducts\")\r\n  const [productsList, setProductsList] = useState(products)\r\n  const boostActivationTimerRef = useRef<number | null>(null)\r\n  const boostActivationProductIdRef = useRef<string | null>(null)\r\n  const boostActivationAttemptsRef = useRef(0)\r\n  const [_isPending, startTransition] = useTransition()\r\n  const [deletingId, setDeletingId] = useState<string | null>(null)\r\n  const [togglingId, setTogglingId] = useState<string | null>(null)\r\n  const [discountProductId, setDiscountProductId] = useState<string | null>(null)\r\n  const [discountPrice, setDiscountPrice] = useState<string>(\"\")\r\n  const [discountingId, setDiscountingId] = useState<string | null>(null)\r\n\r\n  const activeDiscountProduct = discountProductId\r\n    ? productsList.find((p) => p.id === discountProductId) || null\r\n    : null\r\n\r\n  useEffect(() => {\r\n    setProductsList(products)\r\n  }, [products])\r\n\r\n  useEffect(() => {\r\n    return () => {\r\n      if (boostActivationTimerRef.current != null) {\r\n        window.clearInterval(boostActivationTimerRef.current)\r\n        boostActivationTimerRef.current = null\r\n      }\r\n    }\r\n  }, [])\r\n\r\n  // Handle delete product\r\n  const handleDelete = async (productId: string) => {\r\n    setDeletingId(productId)\r\n    startTransition(async () => {\r\n      const result = await actions.deleteProduct(productId)\r\n      if (result.success) {\r\n        toast.success(t('deleteSuccess'))\r\n        setProductsList(prev => prev.filter(p => p.id !== productId))\r\n        router.refresh()\r\n      } else {\r\n        toast.error(result.error || t('deleteError'))\r\n      }\r\n      setDeletingId(null)\r\n    })\r\n  }\r\n\r\n  // Handle pause/unpause (draft/active toggle)\r\n  const handleToggleStatus = async (productId: string, currentStatus?: string) => {\r\n    setTogglingId(productId)\r\n    const newStatus = currentStatus === 'active' ? 'draft' : 'active'\r\n    startTransition(async () => {\r\n      const result = await actions.bulkUpdateProductStatus([productId], newStatus)\r\n      if (result.success) {\r\n        toast.success(\r\n          newStatus === 'draft' ? t('pauseSuccess') : t('activateSuccess')      \r\n        )\r\n        setProductsList(prev => prev.map(p =>\r\n          p.id === productId ? { ...p, status: newStatus } : p\r\n        ))\r\n        router.refresh()\r\n      } else {\r\n        toast.error(result.error || t('updateError'))\r\n      }\r\n      setTogglingId(null)\r\n    })\r\n  }\r\n\r\n  // Handle boost success/cancel URL params\r\n  useEffect(() => {\r\n    const isSuccess = searchParams.get('boost_success') === 'true'\r\n    const isCanceled = searchParams.get('boost_canceled') === 'true'\r\n\r\n    if (!isSuccess && !isCanceled) return\r\n\r\n    const productId = searchParams.get(\"product_id\")\r\n\r\n    if (isSuccess) {\r\n      toast.success(tBoost('paymentSuccess'))\r\n    } else if (isCanceled) {\r\n      toast.info(tBoost('paymentCanceled'))\r\n    }\r\n\r\n    // Clean up URL (avoid double-toasts on refresh)\r\n    window.history.replaceState({}, '', window.location.pathname)\r\n\r\n    if (!isSuccess || !productId) return\r\n\r\n    // Poll for webhook activation (best-effort) by refreshing server props a few times.\r\n    boostActivationProductIdRef.current = productId\r\n    boostActivationAttemptsRef.current = 0\r\n\r\n    if (boostActivationTimerRef.current != null) {\r\n      window.clearInterval(boostActivationTimerRef.current)\r\n      boostActivationTimerRef.current = null\r\n    }\r\n\r\n    boostActivationTimerRef.current = window.setInterval(() => {\r\n      boostActivationAttemptsRef.current += 1\r\n      router.refresh()\r\n\r\n      if (boostActivationAttemptsRef.current >= 6) {\r\n        window.clearInterval(boostActivationTimerRef.current as number)\r\n        boostActivationTimerRef.current = null\r\n        boostActivationProductIdRef.current = null\r\n        toast.info(tBoost(\"activationTakingLonger\"))\r\n      }\r\n    }, 1500)\r\n  }, [searchParams, router, tBoost])\r\n\r\n  useEffect(() => {\r\n    const productId = boostActivationProductIdRef.current\r\n    if (!productId) return\r\n\r\n    const target = productsList.find((p) => p.id === productId)\r\n    const isActive = Boolean(target?.is_boosted) && !!target?.boost_expires_at && new Date(target.boost_expires_at).getTime() > Date.now()\r\n\r\n    if (!isActive) return\r\n\r\n    if (boostActivationTimerRef.current != null) {\r\n      window.clearInterval(boostActivationTimerRef.current)\r\n      boostActivationTimerRef.current = null\r\n    }\r\n\r\n    boostActivationProductIdRef.current = null\r\n    toast.success(tBoost(\"activationComplete\"))\r\n  }, [productsList, tBoost])\r\n\r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat(locale, {\r\n      style: 'currency',\r\n      currency: 'EUR',\r\n    }).format(value)\r\n  }\r\n\r\n  const getSalePercentForDisplay = (product: Product) => {\r\n    const percent = Number(product.sale_percent || 0)\r\n    if (percent > 0) return Math.round(percent)\r\n\r\n    if (product.list_price && product.list_price > product.price) {\r\n      return Math.round(((product.list_price - product.price) / product.list_price) * 100)\r\n    }\r\n    return 0\r\n  }\r\n\r\n  const isSaleActive = (product: Product) => {\r\n    const truth = Boolean(product.is_on_sale) && (Number(product.sale_percent) || 0) > 0\r\n    if (!truth) return false\r\n    if (!product.sale_end_date) return true\r\n    const d = new Date(product.sale_end_date)\r\n    if (Number.isNaN(d.getTime())) return true\r\n    return d.getTime() > Date.now()\r\n  }\r\n\r\n  const openDiscountDialog = (product: Product) => {\r\n    setDiscountProductId(product.id)\r\n    setDiscountPrice(String(Number(product.price)))\r\n  }\r\n\r\n  const closeDiscountDialog = () => {\r\n    setDiscountProductId(null)\r\n    setDiscountPrice(\"\")\r\n  }\r\n\r\n  const handleApplyDiscount = async () => {\r\n    if (!activeDiscountProduct) return\r\n\r\n    const newPrice = Number(discountPrice)\r\n    if (!Number.isFinite(newPrice) || newPrice <= 0) {\r\n      toast.error(t('invalidPrice'))\r\n      return\r\n    }\r\n\r\n    const base = (activeDiscountProduct.list_price && activeDiscountProduct.list_price > activeDiscountProduct.price)\r\n      ? Number(activeDiscountProduct.list_price)\r\n      : Number(activeDiscountProduct.price)\r\n\r\n    if (!(newPrice < base)) {\r\n      toast.error(t('priceMustBeLower'))\r\n      return\r\n    }\r\n\r\n    setDiscountingId(activeDiscountProduct.id)\r\n    startTransition(async () => {\r\n      const result = await actions.setProductDiscountPrice(activeDiscountProduct.id, newPrice)\r\n      if (result.success) {\r\n        toast.success(t('discountSaved'))\r\n\r\n        setProductsList((prev) =>\r\n          prev.map((p) => {\r\n            if (p.id !== activeDiscountProduct.id) return p\r\n\r\n            const wasDiscounted = p.list_price != null && Number(p.list_price) > Number(p.price)\r\n            const nextListPrice = wasDiscounted ? Number(p.list_price) : Number(p.price)\r\n            return {\r\n              ...p,\r\n              price: newPrice,\r\n              list_price: nextListPrice,\r\n            }\r\n          })\r\n        )\r\n        router.refresh()\r\n        closeDiscountDialog()\r\n      } else {\r\n        toast.error(result.error || t('discountSaveError'))\r\n      }\r\n      setDiscountingId(null)\r\n    })\r\n  }\r\n\r\n  const handleClearDiscount = async () => {\r\n    if (!activeDiscountProduct) return\r\n\r\n    setDiscountingId(activeDiscountProduct.id)\r\n    startTransition(async () => {\r\n      const result = await actions.clearProductDiscount(activeDiscountProduct.id)\r\n      if (result.success) {\r\n        toast.success(t('discountRemoved'))\r\n        setProductsList((prev) =>\r\n          prev.map((p) => {\r\n            if (p.id !== activeDiscountProduct.id) return p\r\n            if (p.list_price == null) return p\r\n            return {\r\n              ...p,\r\n              price: Number(p.list_price),\r\n              list_price: null,\r\n            }\r\n          })\r\n        )\r\n        router.refresh()\r\n        closeDiscountDialog()\r\n      } else {\r\n        toast.error(result.error || t('discountRemoveError'))\r\n      }\r\n      setDiscountingId(null)\r\n    })\r\n  }\r\n\r\n  // Check if boost is active (not expired)\r\n  const isBoostActive = (product: Product) => {\r\n    if (!product.is_boosted || !product.boost_expires_at) return false\r\n    return new Date(product.boost_expires_at) > new Date()\r\n  }\r\n\r\n  // Check if there was a boost that has now expired (allow re-boost)\r\n  const isBoostExpired = (product: Product) => {\r\n    if (!product.is_boosted || !product.boost_expires_at) return false\r\n    return new Date(product.boost_expires_at) <= new Date()\r\n  }\r\n\r\n  // Get days and hours left for active boost\r\n  const getBoostTimeLeft = (product: Product) => {\r\n    if (!product.boost_expires_at) return null\r\n    const expiresAt = new Date(product.boost_expires_at)\r\n    const now = new Date()\r\n    const diffMs = expiresAt.getTime() - now.getTime()\r\n    if (diffMs <= 0) return null\r\n    const days = Math.floor(diffMs / (1000 * 60 * 60 * 24))\r\n    const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))\r\n    return { days, hours }\r\n  }\r\n\r\n  // Format boost expiration date for display\r\n  const formatBoostExpiry = (dateStr: string) => {\r\n    return new Intl.DateTimeFormat(locale, { \r\n      dateStyle: 'short', \r\n      timeStyle: 'short' \r\n    }).format(new Date(dateStr))\r\n  }\r\n\r\n  // Legacy helper for backwards compatibility\r\n  const getBoostDaysLeft = (product: Product) => {\r\n    const timeLeft = getBoostTimeLeft(product)\r\n    return timeLeft?.days ?? 0\r\n  }\r\n\r\n  if (productsList.length === 0) {\r\n    return (\r\n      <div className=\"text-center py-12 sm:py-16\">\r\n        <div className=\"size-16 sm:size-20 rounded-full mx-auto flex items-center justify-center mb-4 bg-muted border border-border\">\r\n          <Package weight=\"duotone\" className=\"size-8 sm:size-10 text-muted-foreground\" />\r\n        </div>\r\n        <h3 className=\"text-lg font-semibold text-foreground mb-2\">\r\n          {t('noProductsTitle')}\r\n        </h3>\r\n        <p className=\"text-muted-foreground mb-6 max-w-sm mx-auto\">\r\n          {t('noProductsDesc')}\r\n        </p>\r\n        <Button asChild className=\"rounded-full\">\r\n          <Link href=\"/sell\">\r\n            <Plus weight=\"bold\" className=\"size-4 mr-2\" />\r\n            {t('createListing')}\r\n          </Link>\r\n        </Button>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {/* Mobile: Card-style list */}\r\n      <div className=\"space-y-3 md:hidden\">\r\n        {productsList.map((product) => {\r\n          const boosted = isBoostActive(product)\r\n          const boostExpired = isBoostExpired(product)\r\n          const timeLeft = getBoostTimeLeft(product)\r\n          const saleActive = isSaleActive(product)\r\n          const salePercent = getSalePercentForDisplay(product)\r\n\r\n          return (\r\n            <div\r\n              key={product.id}\r\n              className={`flex items-start gap-3 p-3 rounded-md bg-card border border-border ${boosted ? 'ring-2 ring-selected-border border-selected-border' : ''\r\n                }`}\r\n            >\r\n              {/* Product Image */}\r\n              <div className=\"relative size-20 rounded-md overflow-hidden bg-card border border-border shrink-0\">\r\n                {product.images?.[0] && product.images[0].startsWith('http') ? (\r\n                  <Image\r\n                    src={product.images[0]}\r\n                    alt={product.title}\r\n                    fill\r\n                    className=\"object-cover\"\r\n                    sizes=\"80px\"\r\n                  />\r\n                ) : (\r\n                  <div className=\"w-full h-full flex items-center justify-center\">\r\n                    <Package className=\"size-8 text-muted-foreground\" weight=\"duotone\" />\r\n                  </div>\r\n                )}\r\n                {boosted && (\r\n                  <div className=\"absolute top-1.5 left-1.5\">\r\n                    <Badge className=\"bg-primary text-primary-foreground text-2xs px-1.5 py-0.5 gap-0.5 shadow-sm\">\r\n                      <Lightning className=\"size-2.5\" weight=\"fill\" />\r\n                    </Badge>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {/* Product Info */}\r\n              <div className=\"flex-1 min-w-0\">\r\n                <div className=\"flex items-start justify-between gap-2\">\r\n                  <div className=\"min-w-0 flex-1\">\r\n                    <Link\r\n                      href={`/product/${product.id}`}\r\n                      className=\"font-medium text-foreground hover:text-primary line-clamp-1 text-sm\"\r\n                    >\r\n                      {product.title}\r\n                    </Link>\r\n                    <div className=\"flex items-center gap-2 mt-1\">\r\n                      <span className={`text-sm font-semibold ${saleActive ? 'text-deal' : 'text-foreground'}`}>\r\n                        {formatCurrency(Number(product.price))}\r\n                      </span>\r\n                      {saleActive && salePercent > 0 && (\r\n                        <Badge variant=\"secondary\" className=\"bg-destructive-subtle text-deal border-0 text-2xs px-1.5 py-0\">\r\n                          <Tag weight=\"fill\" className=\"size-2.5 mr-0.5\" />\r\n                          -{salePercent}%\r\n                        </Badge>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2 mt-1.5 text-xs text-muted-foreground\">\r\n                      <span className={product.stock < 5 && product.stock > 0 ? \"text-warning font-medium\" : product.stock === 0 ? \"text-destructive font-medium\" : \"\"}>\r\n                        {product.stock === 0\r\n                          ? t('outOfStock')\r\n                          : t('inStock', { count: product.stock })\r\n                        }\r\n                      </span>\r\n                      {boosted && timeLeft && (\r\n                        <Badge variant=\"secondary\" className=\"bg-selected text-primary border-0 text-2xs px-1.5 py-0\">\r\n                          <Lightning weight=\"fill\" className=\"size-2.5 mr-0.5\" />\r\n                          {tBoost('timeLeft', { days: timeLeft.days, hours: timeLeft.hours })}\r\n                        </Badge>\r\n                      )}\r\n                      {boostExpired && (\r\n                        <Badge variant=\"secondary\" className=\"bg-muted text-muted-foreground border-0 text-2xs px-1.5 py-0\">\r\n                          {tBoost('boostExpired')}\r\n                        </Badge>\r\n                      )}\r\n                    </div>\r\n                    {/* Rating */}\r\n                    <div className=\"flex items-center gap-1 mt-1.5\">\r\n                      <div className=\"flex text-rating\">\r\n                        {[...Array(5)].map((_, i) => (\r\n                          <Star\r\n                            key={i}\r\n                            size={10}\r\n                            weight={i < Math.floor(product.rating || 0) ? \"fill\" : \"regular\"}\r\n                            className=\"text-rating\"\r\n                          />\r\n                        ))}\r\n                      </div>\r\n                      <span className=\"text-2xs text-muted-foreground\">\r\n                        ({product.review_count || 0})\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Mobile Actions */}\r\n                  <div className=\"flex flex-col gap-1.5 shrink-0\">\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"icon\"\r\n                      className=\"size-8\"\r\n                      onClick={() => openDiscountDialog(product)}\r\n                      title={t('discountTooltip')}\r\n                    >\r\n                      <Tag className=\"size-4\" weight=\"bold\" />\r\n                    </Button>\r\n                    {/* Show boost dialog if not currently boosted OR if boost expired (re-boost) */}\r\n                    {(!boosted) && (\r\n                      <BoostDialog\r\n                        product={product}\r\n                        locale={locale}\r\n                        trigger={\r\n                          <Button\r\n                            variant=\"ghost\"\r\n                            size=\"icon\"\r\n                            className={`size-8 ${boostExpired ? 'text-muted-foreground hover:text-primary' : 'text-primary'} hover:bg-hover`}\r\n                            title={boostExpired ? tBoost('reboost') : tBoost('trigger')}\r\n                          >\r\n                            <Lightning className=\"size-4\" weight=\"bold\" />\r\n                          </Button>\r\n                        }\r\n                      />\r\n                    )}\r\n                    {/* Pause/Unpause button */}\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"icon\"\r\n                      className=\"size-8\"\r\n                      onClick={() => handleToggleStatus(product.id, product.status)}\r\n                      disabled={togglingId === product.id}\r\n                    >\r\n                      {product.status === 'draft' ? (\r\n                        <Play className=\"size-4 text-success\" weight=\"fill\" />\r\n                      ) : (\r\n                        <Pause className=\"size-4 text-warning\" weight=\"fill\" />\r\n                      )}\r\n                    </Button>\r\n                    <Button asChild variant=\"ghost\" size=\"icon\" className=\"size-8\">\r\n                      <Link href={`/account/selling/${product.id}/edit`}>\n                        <Pencil className=\"size-4\" />\r\n                      </Link>\r\n                    </Button>\r\n                    {/* Delete button */}\r\n                    <AlertDialog>\r\n                      <AlertDialogTrigger asChild>\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"icon\"\r\n                          className=\"size-8 text-destructive hover:bg-destructive-subtle\"\n                          disabled={deletingId === product.id}\r\n                        >\r\n                          <Trash className=\"size-4\" />\r\n                        </Button>\r\n                      </AlertDialogTrigger>\r\n                      <AlertDialogContent>\r\n                        <AlertDialogHeader>\r\n                          <AlertDialogTitle>\r\n                            {t('deleteDialogTitle')}\r\n                          </AlertDialogTitle>\r\n                          <AlertDialogDescription>\r\n                            {t('deleteDialogDesc', { title: product.title })}\r\n                          </AlertDialogDescription>\r\n                        </AlertDialogHeader>\r\n                        <AlertDialogFooter>\r\n                          <AlertDialogCancel>\r\n                            {t('cancelButton')}\r\n                          </AlertDialogCancel>\r\n                          <AlertDialogAction\r\n                            onClick={() => handleDelete(product.id)}\r\n                            className=\"bg-destructive text-destructive-foreground hover:bg-destructive\"\n                          >\r\n                            {t('deleteButton')}\r\n                          </AlertDialogAction>\r\n                        </AlertDialogFooter>\r\n                      </AlertDialogContent>\r\n                    </AlertDialog>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )\r\n        })}\r\n      </div>\r\n\r\n      {/* Desktop: Table-like list */}\r\n      <div className=\"hidden md:block divide-y divide-border\">\r\n        {productsList.map((product) => {\r\n          const boosted = isBoostActive(product)\r\n          const boostExpired = isBoostExpired(product)\r\n          const timeLeft = getBoostTimeLeft(product)\r\n          const saleActive = isSaleActive(product)\r\n          const salePercent = getSalePercentForDisplay(product)\r\n\r\n          return (\r\n            <div\r\n              key={product.id}\r\n              className={`flex items-center gap-4 p-4 hover:bg-hover transition-colors ${boosted ? 'bg-selected' : ''\r\n                }`}\r\n            >\r\n              {/* Product Image */}\r\n              <div className=\"relative size-16 rounded-md overflow-hidden bg-card border border-border shrink-0\">\r\n                {product.images?.[0] && product.images[0].startsWith('http') ? (\r\n                  <Image\r\n                    src={product.images[0]}\r\n                    alt={product.title}\r\n                    fill\r\n                    className=\"object-cover\"\r\n                    sizes=\"64px\"\r\n                  />\r\n                ) : (\r\n                  <div className=\"w-full h-full flex items-center justify-center\">\r\n                    <Package className=\"size-6 text-muted-foreground\" weight=\"duotone\" />\r\n                  </div>\r\n                )}\r\n                {boosted && (\r\n                  <div className=\"absolute top-1 left-1\">\r\n                    <Badge className=\"bg-primary text-primary-foreground text-2xs px-1 py-0 gap-0.5\">\r\n                      <Lightning className=\"size-2.5\" weight=\"fill\" />\r\n                    </Badge>\r\n                  </div>\r\n                )}\r\n              </div>\r\n\r\n              {/* Product Info */}\r\n              <div className=\"flex-1 min-w-0\">\r\n                <div className=\"flex items-center gap-2 flex-wrap\">\r\n                  <Link\r\n                    href={`/product/${product.id}`}\r\n                    className=\"font-medium text-foreground hover:text-primary line-clamp-1\"\r\n                  >\r\n                    {product.title}\r\n                  </Link>\r\n                  {saleActive && salePercent > 0 && (\r\n                    <Badge variant=\"secondary\" className=\"bg-destructive-subtle text-deal border-0 text-xs shrink-0\">\r\n                      <Tag weight=\"fill\" className=\"size-3 mr-0.5\" />\r\n                      -{salePercent}%\r\n                    </Badge>\r\n                  )}\r\n                  {boosted && timeLeft && (\r\n                    <Badge variant=\"secondary\" className=\"bg-selected text-primary border-0 text-xs shrink-0\" title={product.boost_expires_at ? tBoost('boostActiveUntil', { date: formatBoostExpiry(product.boost_expires_at) }) : undefined}>\r\n                      <Lightning weight=\"fill\" className=\"size-3 mr-0.5\" />\r\n                      {tBoost('timeLeft', { days: timeLeft.days, hours: timeLeft.hours })}\r\n                    </Badge>\r\n                  )}\r\n                  {boostExpired && (\r\n                    <Badge variant=\"secondary\" className=\"bg-muted text-muted-foreground border-0 text-xs shrink-0\">\r\n                      {tBoost('boostExpired')}\r\n                    </Badge>\r\n                  )}\r\n                </div>\r\n                <div className=\"flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-muted-foreground mt-1\">\r\n                  <div className=\"flex items-baseline gap-1.5\">\r\n                    <span className={`font-semibold ${saleActive ? 'text-deal' : 'text-foreground'}`}>\r\n                      {formatCurrency(Number(product.price))}\r\n                    </span>\r\n                    {product.list_price && product.list_price > product.price && (\r\n                      <span className=\"text-muted-foreground line-through text-xs\">\r\n                        {formatCurrency(Number(product.list_price))}\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                  <span className={product.stock < 5 && product.stock > 0 ? \"text-warning font-medium\" : product.stock === 0 ? \"text-destructive font-medium\" : \"\"}>\r\n                    {product.stock === 0\r\n                      ? t('outOfStock')\r\n                      : t('inStock', { count: product.stock })\r\n                    }\r\n                  </span>\r\n                  {product.category && (\r\n                    <span className=\"text-muted-foreground\">{product.category.name}</span>\r\n                  )}\r\n                </div>\r\n                {/* Rating */}\r\n                <div className=\"flex items-center gap-1 mt-1.5\">\r\n                  <div className=\"flex text-rating\">\r\n                    {[...Array(5)].map((_, i) => (\r\n                      <Star\r\n                        key={i}\r\n                        size={12}\r\n                        weight={i < Math.floor(product.rating || 0) ? \"fill\" : \"regular\"}\r\n                        className=\"text-rating\"\r\n                      />\r\n                    ))}\r\n                  </div>\r\n                  <span className=\"text-xs text-muted-foreground\">\r\n                    ({product.review_count || 0})\r\n                  </span>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Actions */}\r\n              <div className=\"flex items-center gap-2 shrink-0\">\r\n                {/* Boost/Reboost Button - show if not currently active (includes expired) */}\r\n                {!boosted && (\r\n                  <BoostDialog\r\n                    product={product}\r\n                    locale={locale}\r\n                    trigger={\r\n                      <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        className={`gap-1.5 ${boostExpired ? 'text-muted-foreground border-border hover:text-primary hover:border-selected-border' : 'text-primary border-selected-border'} hover:bg-hover h-9 px-3 rounded-full`}\r\n                      >\r\n                        <Lightning className=\"size-4\" weight=\"bold\" />\r\n                        {boostExpired ? tBoost('reboost') : tBoost('trigger')}\r\n                      </Button>\r\n                    }\r\n                  />\r\n                )}\r\n                {/* Discount Button */}\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"icon\"\r\n                  className=\"size-9\"\r\n                  onClick={() => openDiscountDialog(product)}\r\n                  title={t('discountTooltip')}\r\n                >\r\n                  <Tag className=\"size-4\" weight=\"bold\" />\r\n                </Button>\r\n                {/* Pause/Unpause Button */}\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"icon\"\r\n                  className=\"size-9\"\r\n                  onClick={() => handleToggleStatus(product.id, product.status)}\r\n                  disabled={togglingId === product.id}\r\n                  title={product.status === 'draft'\r\n                    ? t('activateTooltip')\r\n                    : t('pauseTooltip')\r\n                  }\r\n                >\r\n                  {product.status === 'draft' ? (\r\n                    <Play className=\"size-4 text-success\" weight=\"fill\" />\r\n                  ) : (\r\n                    <Pause className=\"size-4 text-warning\" weight=\"fill\" />\r\n                  )}\r\n                </Button>\r\n                <Button asChild variant=\"ghost\" size=\"icon\" className=\"size-9\">\r\n                  <Link href={`/product/${product.id}`}>\r\n                    <Eye className=\"size-4\" />\r\n                    <span className=\"sr-only\">{t('viewSrOnly')}</span>\r\n                  </Link>\r\n                </Button>\r\n                <Button asChild variant=\"ghost\" size=\"icon\" className=\"size-9\">\r\n                  <Link href={`/account/selling/${product.id}/edit`}>\n                    <Pencil className=\"size-4\" />\r\n                    <span className=\"sr-only\">{t('editSrOnly')}</span>\r\n                  </Link>\r\n                </Button>\r\n                {/* Delete Button */}\r\n                <AlertDialog>\r\n                  <AlertDialogTrigger asChild>\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"icon\"\r\n                      className=\"size-9 text-destructive hover:bg-destructive-subtle\"\n                      disabled={deletingId === product.id}\r\n                    >\r\n                      <Trash className=\"size-4\" />\r\n                      <span className=\"sr-only\">{t('deleteSrOnly')}</span>\r\n                    </Button>\r\n                  </AlertDialogTrigger>\r\n                  <AlertDialogContent>\r\n                    <AlertDialogHeader>\r\n                      <AlertDialogTitle>\r\n                        {t('deleteDialogTitle')}\r\n                      </AlertDialogTitle>\r\n                      <AlertDialogDescription>\r\n                        {t('deleteDialogDesc', { title: product.title })}\r\n                      </AlertDialogDescription>\r\n                    </AlertDialogHeader>\r\n                    <AlertDialogFooter>\r\n                      <AlertDialogCancel>\r\n                        {t('cancelButton')}\r\n                      </AlertDialogCancel>\r\n                      <AlertDialogAction\r\n                        onClick={() => handleDelete(product.id)}\r\n                        className=\"bg-destructive text-destructive-foreground hover:bg-destructive\"\n                      >\r\n                        {t('deleteButton')}\r\n                      </AlertDialogAction>\r\n                    </AlertDialogFooter>\r\n                  </AlertDialogContent>\r\n                </AlertDialog>\r\n              </div>\r\n            </div>\r\n          )\r\n        })}\r\n      </div>\r\n\r\n      {/* Discount Dialog */}\r\n      <Dialog open={!!discountProductId} onOpenChange={(open) => { if (!open) closeDiscountDialog() }}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>{t('setDiscountTitle')}</DialogTitle>\r\n            <DialogDescription>\r\n              {activeDiscountProduct\r\n                ? t('setDiscountDesc', { title: activeDiscountProduct.title })\r\n                : t('setDiscountDescGeneric')}\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n\r\n          {activeDiscountProduct && (\r\n            <div className=\"space-y-4\">\r\n              <div className=\"text-sm text-muted-foreground\">\r\n                <span className=\"font-medium text-foreground\">\r\n                  {t('currentPriceLabel')}\r\n                </span>{\" \"}\r\n                {formatCurrency(Number(activeDiscountProduct.price))}\r\n                {activeDiscountProduct.list_price && Number(activeDiscountProduct.list_price) > Number(activeDiscountProduct.price) && (\r\n                  <>\r\n                    {\" \"}┬╖{\" \"}\r\n                    <span className=\"line-through\">\r\n                      {formatCurrency(Number(activeDiscountProduct.list_price))}\r\n                    </span>\r\n                  </>\r\n                )}\r\n              </div>\r\n\r\n              <div className=\"space-y-2\">\r\n                <Label htmlFor=\"discount-price\">{t('newPriceLabel')}</Label>\r\n                <Input\r\n                  id=\"discount-price\"\r\n                  inputMode=\"decimal\"\r\n                  value={discountPrice}\r\n                  onChange={(e) => setDiscountPrice(e.target.value)}\r\n                  placeholder={t('newPricePlaceholder')}\r\n                />\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          <DialogFooter className=\"gap-2 sm:gap-0\">\r\n            {activeDiscountProduct?.list_price && Number(activeDiscountProduct.list_price) > Number(activeDiscountProduct.price) ? (\r\n              <Button\r\n                type=\"button\"\r\n                variant=\"outline\"\r\n                onClick={handleClearDiscount}\r\n                disabled={discountingId === activeDiscountProduct.id}\r\n              >\r\n                {t('removeDiscountButton')}\r\n              </Button>\r\n            ) : null}\r\n            <Button type=\"button\" variant=\"outline\" onClick={closeDiscountDialog}>\r\n              {t('cancelButton')}\r\n            </Button>\r\n            <Button\r\n              type=\"button\"\r\n              onClick={handleApplyDiscount}\r\n              disabled={!!activeDiscountProduct && discountingId === activeDiscountProduct.id}\r\n            >\r\n              {t('saveButton')}\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\settings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\wishlist\\_components\\account-wishlist-grid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\wishlist\\_components\\account-wishlist-stats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\wishlist\\_components\\account-wishlist-toolbar.tsx","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 9 times.","line":238,"column":37,"nodeType":"Literal","endLine":238,"endColumn":51}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'applyUrl', 'categoryFilter', and 'stockFilter'. Either include them or remove the dependency array.","line":122,"column":6,"nodeType":"ArrayExpression","endLine":122,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [applyUrl, categoryFilter, query, stockFilter]","fix":{"range":[3984,3991],"text":"[applyUrl, categoryFilter, query, stockFilter]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useMemo, useRef, useState, useTransition } from \"react\"\r\nimport { usePathname, useRouter } from \"@/i18n/routing\"\r\nimport { useSearchParams } from \"next/navigation\"\r\nimport { IconSearch, IconX, IconFilter, IconCheck, IconPackage, IconPackageOff, IconChevronDown } from \"@tabler/icons-react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\n\r\nexport type WishlistCategory = {\r\n  id: string\r\n  name: string\r\n  slug: string\r\n  count: number\r\n}\r\n\r\ntype StockFilter = \"all\" | \"in-stock\" | \"out-of-stock\"\r\n\r\ninterface AccountWishlistToolbarProps {\r\n  locale: string\r\n  categories: WishlistCategory[]\r\n  initialCategoryFilter: string | null\r\n  initialSearchQuery: string\r\n  initialStockFilter: string\r\n  totalItems: number\r\n  filteredCount: number\r\n  className?: string\r\n}\r\n\r\nexport function AccountWishlistToolbar({\r\n  locale,\r\n  categories,\r\n  initialCategoryFilter,\r\n  initialSearchQuery,\r\n  initialStockFilter,\r\n  totalItems,\r\n  filteredCount,\r\n  className,\r\n}: AccountWishlistToolbarProps) {\r\n  const router = useRouter()\r\n  const pathname = usePathname()\r\n  const searchParams = useSearchParams()\r\n  const [isPending, startTransition] = useTransition()\r\n\r\n  const [query, setQuery] = useState(initialSearchQuery)\r\n  const [categoryFilter, setCategoryFilter] = useState<string | null>(initialCategoryFilter)\r\n  const [stockFilter, setStockFilter] = useState<StockFilter>(\r\n    (initialStockFilter as StockFilter) || \"all\"\r\n  )\r\n\r\n  const didMount = useRef(false)\r\n\r\n  const labels = useMemo(\r\n    () => ({\r\n      all: locale === \"bg\" ? \"╨Æ╤ü╨╕╤ç╨║╨╕\" : \"All\",\r\n      allCategories: locale === \"bg\" ? \"╨Æ╤ü╨╕╤ç╨║╨╕ ╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╨╕\" : \"All Categories\",\r\n      search: locale === \"bg\" ? \"╨ó╤è╤Ç╤ü╨╡╨╜╨╡\" : \"Search\",\r\n      searchPlaceholder: locale === \"bg\" ? \"╨ó╤è╤Ç╤ü╨╕ ╨▓ ╨╗╤Ä╨▒╨╕╨╝╨╕...\" : \"Search wishlist...\",\r\n      filter: locale === \"bg\" ? \"╨ñ╨╕╨╗╤é╤è╤Ç\" : \"Filter\",\r\n      category: locale === \"bg\" ? \"╨Ü╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å\" : \"Category\",\r\n      stock: locale === \"bg\" ? \"╨¥╨░╨╗╨╕╤ç╨╜╨╛╤ü╤é\" : \"Stock\",\r\n      inStock: locale === \"bg\" ? \"╨¥╨░╨╗╨╕╤ç╨╜╨╕\" : \"In Stock\",\r\n      outOfStock: locale === \"bg\" ? \"╨ÿ╨╖╤ç╨╡╤Ç╨┐╨░╨╜╨╕\" : \"Out of Stock\",\r\n      items: locale === \"bg\" ? \"╨░╤Ç╤é╨╕╨║╤â╨╗╨░\" : \"items\",\r\n      clearFilters: locale === \"bg\" ? \"╨ÿ╨╖╤ç╨╕╤ü╤é╨╕\" : \"Clear\",\r\n    }),\r\n    [locale]\r\n  )\r\n\r\n  const buildUrl = (next: { q?: string | null; category?: string | null; stock?: StockFilter | null }) => {\r\n    const params = new URLSearchParams(searchParams?.toString() || \"\")\r\n\r\n    // Handle search query\r\n    if (next.q === null) params.delete(\"q\")\r\n    else if (typeof next.q === \"string\") {\r\n      const trimmed = next.q.trim()\r\n      if (!trimmed) params.delete(\"q\")\r\n      else params.set(\"q\", trimmed)\r\n    }\r\n\r\n    // Handle category filter\r\n    if (next.category === null) params.delete(\"category\")\r\n    else if (next.category) params.set(\"category\", next.category)\r\n\r\n    // Handle stock filter\r\n    if (next.stock === null || next.stock === \"all\") params.delete(\"stock\")\r\n    else if (next.stock) params.set(\"stock\", next.stock)\r\n\r\n    const qs = params.toString()\r\n    return qs ? `${pathname}?${qs}` : pathname\r\n  }\r\n\r\n  const applyUrl = (next: { q?: string | null; category?: string | null; stock?: StockFilter | null }) => {\r\n    const url = buildUrl(next)\r\n    startTransition(() => {\r\n      router.replace(url, { scroll: false })\r\n    })\r\n  }\r\n\r\n  // Debounced search\r\n  useEffect(() => {\r\n    if (!didMount.current) {\r\n      didMount.current = true\r\n      return\r\n    }\r\n\r\n    const handle = window.setTimeout(() => {\r\n      applyUrl({ q: query, category: categoryFilter, stock: stockFilter })\r\n    }, 300)\r\n\r\n    return () => window.clearTimeout(handle)\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [query])\r\n\r\n  // Sync with URL params\r\n  useEffect(() => {\r\n    setCategoryFilter(initialCategoryFilter)\r\n  }, [initialCategoryFilter])\r\n\r\n  useEffect(() => {\r\n    setStockFilter((initialStockFilter as StockFilter) || \"all\")\r\n  }, [initialStockFilter])\r\n\r\n  const hasActiveFilters = categoryFilter || stockFilter !== \"all\" || query.trim()\r\n  const selectedCategory = categories.find(c => c.slug === categoryFilter)\r\n\r\n  const clearAllFilters = () => {\r\n    setQuery(\"\")\r\n    setCategoryFilter(null)\r\n    setStockFilter(\"all\")\r\n    applyUrl({ q: null, category: null, stock: null })\r\n  }\r\n\r\n  return (\r\n    <div className={cn(\"flex flex-col gap-3\", className)}>\r\n      {/* Mobile: Compact horizontal scrollable category chips + filter dropdown */}\r\n      <div className=\"flex flex-col gap-3 sm:hidden\">\r\n        {/* Search bar */}\r\n        <div className=\"relative\">\r\n          <IconSearch className=\"absolute left-3 top-1/2 -translate-y-1/2 size-4 text-muted-foreground\" />\r\n          <Input\r\n            value={query}\r\n            onChange={(e) => setQuery(e.target.value)}\r\n            placeholder={labels.searchPlaceholder}\r\n            className=\"pl-9 pr-9 h-10 rounded-full bg-surface-subtle border-border/40\"\r\n            aria-label={labels.search}\r\n          />\r\n          {query && (\r\n            <button\r\n              onClick={() => {\r\n                setQuery(\"\")\r\n                applyUrl({ q: null, category: categoryFilter, stock: stockFilter })\r\n              }}\r\n              className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\r\n            >\r\n              <IconX className=\"size-4\" />\r\n            </button>\r\n          )}\r\n          {isPending && (\r\n            <div className=\"absolute right-3 top-1/2 -translate-y-1/2 size-4 animate-spin rounded-full border-2 border-border border-t-transparent\" />\r\n          )}\r\n        </div>\r\n\r\n        {/* Category chips + Stock filter */}\r\n        <div className=\"flex items-center gap-2 overflow-x-auto no-scrollbar -mx-4 px-4\">\r\n          {/* All button */}\r\n          <button\r\n            onClick={() => {\r\n              setCategoryFilter(null)\r\n              applyUrl({ q: query, category: null, stock: stockFilter })\r\n            }}\r\n              className={cn(\r\n                \"flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium transition-all shrink-0\",\r\n                !categoryFilter\r\n                  ? \"bg-foreground text-background shadow-sm\"\r\n                  : \"bg-background border border-border/60 text-foreground hover:bg-hover\"\r\n              )}\r\n            >\r\n              {labels.all}\r\n              <span className={cn(\r\n                \"text-xs tabular-nums\",\r\n                !categoryFilter ? \"text-background/80\" : \"text-muted-foreground\"\r\n              )}>\r\n                {totalItems}\r\n              </span>\r\n            </button>\r\n\r\n          {/* Category chips */}\r\n          {categories.map((cat) => (\r\n            <button\r\n              key={cat.slug}\r\n              onClick={() => {\r\n                const newCat = categoryFilter === cat.slug ? null : cat.slug\r\n                setCategoryFilter(newCat)\r\n                applyUrl({ q: query, category: newCat, stock: stockFilter })\r\n              }}\r\n              className={cn(\r\n                \"flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium transition-all shrink-0\",\r\n                categoryFilter === cat.slug\r\n                  ? \"bg-foreground text-background shadow-sm\"\r\n                  : \"bg-background border border-border/60 text-foreground hover:bg-hover\"\r\n              )}\r\n            >\r\n              {cat.name}\r\n              <span className={cn(\r\n                \"text-xs tabular-nums\",\r\n                categoryFilter === cat.slug ? \"text-background/80\" : \"text-muted-foreground\"\r\n              )}>\r\n                {cat.count}\r\n              </span>\r\n            </button>\r\n          ))}\r\n\r\n          {/* Stock filter dropdown */}\r\n          <DropdownMenu>\r\n            <DropdownMenuTrigger asChild>\r\n              <button\r\n                className={cn(\r\n                  \"flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium transition-all shrink-0\",\r\n                  stockFilter !== \"all\"\r\n                    ? stockFilter === \"in-stock\"\r\n                      ? \"bg-success text-primary-foreground shadow-sm\"\r\n                      : \"bg-warning text-foreground shadow-sm\"\r\n                    : \"bg-background border border-border/60 text-foreground hover:bg-hover\"\r\n                )}\r\n              >\r\n                {stockFilter === \"in-stock\" ? (\r\n                  <IconPackage className=\"size-3.5\" />\r\n                ) : stockFilter === \"out-of-stock\" ? (\r\n                  <IconPackageOff className=\"size-3.5\" />\r\n                ) : (\r\n                  <IconFilter className=\"size-3.5\" />\r\n                )}\r\n                {stockFilter === \"all\" ? labels.stock : stockFilter === \"in-stock\" ? labels.inStock : labels.outOfStock}\r\n                <IconChevronDown className=\"size-3\" />\r\n              </button>\r\n            </DropdownMenuTrigger>\r\n            <DropdownMenuContent align=\"end\" className=\"w-40\">\r\n              <DropdownMenuItem\r\n                onClick={() => {\r\n                  setStockFilter(\"all\")\r\n                  applyUrl({ q: query, category: categoryFilter, stock: \"all\" })\r\n                }}\r\n              >\r\n                <span className=\"flex-1\">{labels.all}</span>\r\n                {stockFilter === \"all\" && <IconCheck className=\"size-4 text-primary\" />}\r\n              </DropdownMenuItem>\r\n              <DropdownMenuSeparator />\r\n              <DropdownMenuItem\r\n                onClick={() => {\r\n                  setStockFilter(\"in-stock\")\r\n                  applyUrl({ q: query, category: categoryFilter, stock: \"in-stock\" })\r\n                }}\r\n              >\r\n                <IconPackage className=\"size-4 mr-2 text-success\" />\r\n                <span className=\"flex-1\">{labels.inStock}</span>\r\n                {stockFilter === \"in-stock\" && <IconCheck className=\"size-4 text-primary\" />}\r\n              </DropdownMenuItem>\r\n              <DropdownMenuItem\r\n                onClick={() => {\r\n                  setStockFilter(\"out-of-stock\")\r\n                  applyUrl({ q: query, category: categoryFilter, stock: \"out-of-stock\" })\r\n                }}\r\n              >\r\n                <IconPackageOff className=\"size-4 mr-2 text-warning\" />\r\n                <span className=\"flex-1\">{labels.outOfStock}</span>\r\n                {stockFilter === \"out-of-stock\" && <IconCheck className=\"size-4 text-primary\" />}\r\n              </DropdownMenuItem>\r\n            </DropdownMenuContent>\r\n          </DropdownMenu>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Desktop: Full toolbar with search, category dropdown, and stock filter */}\r\n      <div className=\"hidden sm:flex items-center gap-3\">\r\n        {/* Search */}\r\n        <div className=\"relative flex-1 max-w-sm\">\r\n          <IconSearch className=\"absolute left-3 top-1/2 -translate-y-1/2 size-4 text-muted-foreground\" />\r\n          <Input\r\n            value={query}\r\n            onChange={(e) => setQuery(e.target.value)}\r\n            placeholder={labels.searchPlaceholder}\r\n            className=\"pl-9 pr-9\"\r\n            aria-label={labels.search}\r\n          />\r\n          {query && (\r\n            <button\r\n              onClick={() => {\r\n                setQuery(\"\")\r\n                applyUrl({ q: null, category: categoryFilter, stock: stockFilter })\r\n              }}\r\n              className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\r\n            >\r\n              <IconX className=\"size-4\" />\r\n            </button>\r\n          )}\r\n          {isPending && !query && (\r\n            <div className=\"absolute right-3 top-1/2 -translate-y-1/2 size-4 animate-spin rounded-full border-2 border-border border-t-transparent\" />\r\n          )}\r\n        </div>\r\n\r\n        {/* Category dropdown */}\r\n        <DropdownMenu>\r\n          <DropdownMenuTrigger asChild>\r\n            <Button variant=\"outline\" className=\"gap-2\">\r\n              {selectedCategory ? (\r\n                <>\r\n                  {selectedCategory.name}\r\n                  <Badge variant=\"secondary\" className=\"ml-1\">\r\n                    {selectedCategory.count}\r\n                  </Badge>\r\n                </>\r\n              ) : (\r\n                labels.allCategories\r\n              )}\r\n              <IconChevronDown className=\"size-4\" />\r\n            </Button>\r\n          </DropdownMenuTrigger>\r\n          <DropdownMenuContent align=\"start\" className=\"w-56\">\r\n            <DropdownMenuItem\r\n              onClick={() => {\r\n                setCategoryFilter(null)\r\n                applyUrl({ q: query, category: null, stock: stockFilter })\r\n              }}\r\n            >\r\n              <span className=\"flex-1\">{labels.allCategories}</span>\r\n              <span className=\"text-muted-foreground text-xs tabular-nums\">{totalItems}</span>\r\n              {!categoryFilter && <IconCheck className=\"size-4 ml-2 text-primary\" />}\r\n            </DropdownMenuItem>\r\n            {categories.length > 0 && <DropdownMenuSeparator />}\r\n            {categories.map((cat) => (\r\n              <DropdownMenuItem\r\n                key={cat.slug}\r\n                onClick={() => {\r\n                  setCategoryFilter(cat.slug)\r\n                  applyUrl({ q: query, category: cat.slug, stock: stockFilter })\r\n                }}\r\n              >\r\n                <span className=\"flex-1\">{cat.name}</span>\r\n                <span className=\"text-muted-foreground text-xs tabular-nums\">{cat.count}</span>\r\n                {categoryFilter === cat.slug && <IconCheck className=\"size-4 ml-2 text-primary\" />}\r\n              </DropdownMenuItem>\r\n            ))}\r\n          </DropdownMenuContent>\r\n        </DropdownMenu>\r\n\r\n        {/* Stock filter */}\r\n        <DropdownMenu>\r\n          <DropdownMenuTrigger asChild>\r\n            <Button\r\n              variant={stockFilter !== \"all\" ? \"default\" : \"outline\"}\r\n              className={cn(\r\n                \"gap-2\",\r\n                stockFilter === \"in-stock\" && \"bg-success hover:bg-success/90\",\r\n                stockFilter === \"out-of-stock\" && \"bg-warning hover:bg-warning/90\"\r\n              )}\r\n            >\r\n              {stockFilter === \"in-stock\" ? (\r\n                <IconPackage className=\"size-4\" />\r\n              ) : stockFilter === \"out-of-stock\" ? (\r\n                <IconPackageOff className=\"size-4\" />\r\n              ) : (\r\n                <IconFilter className=\"size-4\" />\r\n              )}\r\n              {stockFilter === \"all\" ? labels.stock : stockFilter === \"in-stock\" ? labels.inStock : labels.outOfStock}\r\n              <IconChevronDown className=\"size-4\" />\r\n            </Button>\r\n          </DropdownMenuTrigger>\r\n          <DropdownMenuContent align=\"end\" className=\"w-44\">\r\n            <DropdownMenuItem\r\n              onClick={() => {\r\n                setStockFilter(\"all\")\r\n                applyUrl({ q: query, category: categoryFilter, stock: \"all\" })\r\n              }}\r\n            >\r\n              <span className=\"flex-1\">{labels.all}</span>\r\n              {stockFilter === \"all\" && <IconCheck className=\"size-4 text-primary\" />}\r\n            </DropdownMenuItem>\r\n            <DropdownMenuSeparator />\r\n            <DropdownMenuItem\r\n              onClick={() => {\r\n                setStockFilter(\"in-stock\")\r\n                applyUrl({ q: query, category: categoryFilter, stock: \"in-stock\" })\r\n              }}\r\n            >\r\n              <IconPackage className=\"size-4 mr-2 text-success\" />\r\n              <span className=\"flex-1\">{labels.inStock}</span>\r\n              {stockFilter === \"in-stock\" && <IconCheck className=\"size-4 text-primary\" />}\r\n            </DropdownMenuItem>\r\n            <DropdownMenuItem\r\n              onClick={() => {\r\n                setStockFilter(\"out-of-stock\")\r\n                applyUrl({ q: query, category: categoryFilter, stock: \"out-of-stock\" })\r\n              }}\r\n            >\r\n              <IconPackageOff className=\"size-4 mr-2 text-warning\" />\r\n              <span className=\"flex-1\">{labels.outOfStock}</span>\r\n              {stockFilter === \"out-of-stock\" && <IconCheck className=\"size-4 text-primary\" />}\r\n            </DropdownMenuItem>\r\n          </DropdownMenuContent>\r\n        </DropdownMenu>\r\n\r\n        {/* Clear filters */}\r\n        {hasActiveFilters && (\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={clearAllFilters}\r\n            className=\"text-muted-foreground hover:text-foreground\"\r\n          >\r\n            <IconX className=\"size-4 mr-1\" />\r\n            {labels.clearFilters}\r\n          </Button>\r\n        )}\r\n      </div>\r\n\r\n      {/* Active filters summary (mobile) */}\r\n      {hasActiveFilters && (\r\n        <div className=\"flex items-center gap-2 sm:hidden flex-wrap\">\r\n          <span className=\"text-xs text-muted-foreground\">{labels.filter}:</span>\r\n            {selectedCategory && (\r\n              <Badge\r\n                variant=\"secondary\"\r\n                className=\"gap-1 bg-selected text-primary\"\r\n              >\r\n                {selectedCategory.name}\r\n                <button\r\n                  onClick={() => {\r\n                    setCategoryFilter(null)\r\n                  applyUrl({ q: query, category: null, stock: stockFilter })\r\n                }}\r\n                className=\"hover:text-foreground\"\r\n              >\r\n                <IconX className=\"size-3\" />\r\n              </button>\r\n            </Badge>\r\n          )}\r\n          {stockFilter !== \"all\" && (\r\n            <Badge\r\n              variant=\"secondary\"\r\n              className={cn(\r\n                \"gap-1\",\r\n                stockFilter === \"in-stock\"\r\n                  ? \"bg-success/10 text-success\"\r\n                  : \"bg-warning/10 text-warning\"\r\n              )}\r\n            >\r\n              {stockFilter === \"in-stock\" ? labels.inStock : labels.outOfStock}\r\n              <button\r\n                onClick={() => {\r\n                  setStockFilter(\"all\")\r\n                  applyUrl({ q: query, category: categoryFilter, stock: \"all\" })\r\n                }}\r\n              >\r\n                <IconX className=\"size-3\" />\r\n              </button>\r\n            </Badge>\r\n          )}\r\n          {/* Result count */}\r\n          {filteredCount !== totalItems && (\r\n            <span className=\"text-xs text-muted-foreground\">\r\n              {filteredCount} {locale === \"bg\" ? \"╨╛╤é\" : \"of\"} {totalItems}\r\n            </span>\r\n          )}\r\n          <button\r\n            onClick={clearAllFilters}\r\n            className=\"text-xs text-muted-foreground hover:text-foreground ml-auto\"\r\n          >\r\n            {labels.clearFilters}\r\n          </button>\r\n        </div>\r\n      )}\r\n\r\n      {/* Desktop: Result count when filtering */}\r\n      {hasActiveFilters && filteredCount !== totalItems && (\r\n        <div className=\"hidden sm:flex items-center text-sm text-muted-foreground\">\r\n          {locale === \"bg\" \r\n            ? `╨ƒ╨╛╨║╨░╨╖╨░╨╜╨╕ ${filteredCount} ╨╛╤é ${totalItems} ╨░╤Ç╤é╨╕╨║╤â╨╗╨░`\r\n            : `Showing ${filteredCount} of ${totalItems} items`\r\n          }\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\wishlist\\_components\\share-wishlist-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\wishlist\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\wishlist\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\account\\wishlist\\wishlist-content.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(account)\\layout.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/subscriptions' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":8,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":8,"endColumn":81}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/lib/supabase/server\";\r\nimport { redirect, routing } from \"@/i18n/routing\";\r\nimport { getTranslations, setRequestLocale } from \"next-intl/server\";\r\nimport { Suspense } from \"react\";\r\nimport { Skeleton } from \"@/components/ui/skeleton\";\r\nimport { AccountLayoutContent } from \"./account-layout-content\";\r\nimport { headers } from \"next/headers\";\nimport { createSubscriptionCheckoutSession } from \"@/app/actions/subscriptions\";\nimport { connection } from \"next/server\";\nimport { CommerceProviders } from \"../_providers/commerce-providers\";\nimport type { Metadata } from \"next\";\n\r\n// Generate static params for all supported locales\r\nexport function generateStaticParams() {\r\n    return routing.locales.map((locale) => ({ locale }));\r\n}\r\n\r\nexport async function generateMetadata({\r\n    params,\r\n}: {\r\n    params: Promise<{ locale: string }>;\r\n}): Promise<Metadata> {\r\n    const { locale } = await params;\r\n    setRequestLocale(locale);\r\n    const t = await getTranslations({ locale, namespace: \"Account\" });\r\n\r\n    return {\r\n        title: t(\"title\"),\r\n    };\r\n}\r\n\r\nfunction AccountLayoutSkeleton() {\r\n    return (\r\n        <div className=\"flex min-h-svh w-full\">\r\n            {/* Sidebar skeleton */}\r\n            <div className=\"hidden lg:flex w-72 flex-col border-r bg-sidebar\">\r\n                <div className=\"p-4 space-y-4\">\r\n                    <Skeleton className=\"h-10 w-full\" />\r\n                    <Skeleton className=\"h-8 w-full\" />\r\n                    <Skeleton className=\"h-8 w-full\" />\r\n                    <Skeleton className=\"h-8 w-full\" />\r\n                    <Skeleton className=\"h-8 w-full\" />\r\n                </div>\r\n            </div>\r\n            {/* Main content skeleton */}\r\n            <div className=\"flex-1 flex flex-col\">\r\n                <div className=\"h-12 border-b flex items-center px-4 gap-2\">\r\n                    <Skeleton className=\"h-6 w-6\" />\r\n                    <Skeleton className=\"h-4 w-32\" />\r\n                </div>\r\n                <main className=\"flex-1 p-4\">\r\n                    <div className=\"space-y-4\">\r\n                        <Skeleton className=\"h-8 w-64\" />\r\n                        <Skeleton className=\"h-4 w-full\" />\r\n                        <Skeleton className=\"h-4 w-11/12\" />\r\n                        <Skeleton className=\"h-4 w-10/12\" />\r\n                    </div>\r\n                </main>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n\r\nasync function AccountLayoutGate({\r\n    children,\r\n    modal,\r\n    locale,\r\n}: {\r\n    children: React.ReactNode;\r\n    modal: React.ReactNode;\r\n    locale: string;\r\n}) {\r\n    // Mark route as dynamic without using route segment config (incompatible with cacheComponents).\r\n    await connection();\r\n\r\n    const pathname = (await headers()).get(\"x-pathname\") || `/${locale}/account`;\r\n\r\n    // Check auth on server side\r\n    let user: unknown = null;\r\n    try {\r\n        const supabase = await createClient();\r\n        const { data, error } = await supabase.auth.getUser();\r\n        user = error ? null : data.user;\r\n    } catch {\r\n        user = null;\r\n    }\r\n\r\n    if (!user) {\r\n        redirect({ href: { pathname: \"/auth/login\", query: { next: pathname } }, locale });\r\n    }\r\n\r\n    const userEmail = (user as { email?: string } | null)?.email ?? \"\";\r\n    const userFullName = (user as { user_metadata?: { full_name?: string } } | null)?.user_metadata?.full_name ?? \"\";\r\n\r\n    return (\r\n        <AccountLayoutContent\r\n            modal={modal}\r\n            initialUser={{ email: userEmail, fullName: userFullName }}\r\n            plansModalActions={{ createSubscriptionCheckoutSession }}\r\n        >\r\n            {children}\r\n        </AccountLayoutContent>\r\n    );\r\n}\r\n\r\n/**\r\n * Account Layout\r\n * \r\n * Modern dashboard-style layout for account management using shadcn sidebar:\r\n * - Collapsible sidebar navigation with icons\r\n * - Clean header with breadcrumbs\r\n * - Mobile-optimized with bottom tab bar\r\n * - Supports modal overlays via @modal parallel route\r\n * \r\n * Used for: Account settings, orders, plans, messages, etc.\r\n */\r\nexport default async function AccountLayout({\r\n    children,\r\n    modal,\r\n    params,\r\n}: {\r\n    children: React.ReactNode;\r\n    modal: React.ReactNode;\r\n    params: Promise<{ locale: string }>;\r\n}) {\r\n    const { locale } = await params;\r\n    \r\n    // Enable static rendering\r\n    setRequestLocale(locale);\r\n\r\n    return (\n        <Suspense fallback={<AccountLayoutSkeleton />}>\n            <CommerceProviders>\n                <AccountLayoutGate modal={modal} locale={locale}>\n                    {children}\n                </AccountLayoutGate>\n            </CommerceProviders>\n        </Suspense>\n    );\n}\n\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\_components\\admin-recent-activity.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getStatusColor' to the outer scope.","line":60,"column":50,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":60,"endColumn":52},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getRoleBadge' to the outer scope.","line":98,"column":46,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":98,"endColumn":48}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { formatDistanceToNow } from \"date-fns\"\r\nimport { bg, enUS } from \"date-fns/locale\"\r\nimport { useLocale, useTranslations } from \"next-intl\"\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\n\r\ninterface RecentUser {\r\n  id: string\r\n  email: string | null\r\n  full_name: string | null\r\n  role: string | null\r\n  created_at: string\r\n}\r\n\r\ninterface RecentProduct {\r\n  id: string\r\n  title: string\r\n  price: number\r\n  created_at: string\r\n  seller_id: string\r\n}\r\n\r\ninterface RecentOrder {\r\n  id: string\r\n  total_amount: number\r\n  status: string | null\r\n  created_at: string\r\n  user_id: string\r\n}\r\n\r\ninterface AdminRecentActivityProps {\r\n  users: RecentUser[]\r\n  products: RecentProduct[]\r\n  orders: RecentOrder[]\r\n}\r\n\r\nexport function AdminRecentActivity({ users, products, orders }: AdminRecentActivityProps) {\r\n  const t = useTranslations(\"AdminDashboard\")\r\n  const locale = useLocale()\r\n  const dateLocale = locale === \"bg\" ? bg : enUS\r\n\r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat(locale, {\r\n      style: \"currency\",\r\n      currency: \"BGN\",\r\n      maximumFractionDigits: 2,\r\n    }).format(value)\r\n  }\r\n\r\n  const getStatusColor = (status: string | null) => {\r\n    switch (status) {\r\n      case \"paid\":\r\n        return \"bg-success/10 text-success border-success/20\"\r\n      case \"pending\":\r\n        return \"bg-warning/10 text-warning border-warning/20\"\r\n      case \"processing\":\r\n        return \"bg-order-processing/10 text-order-processing border-order-processing/20\"\r\n      case \"shipped\":\r\n        return \"bg-order-shipped/10 text-order-shipped border-order-shipped/20\"\r\n      case \"delivered\":\r\n        return \"bg-success/10 text-success border-success/20\"\r\n      case \"cancelled\":\r\n        return \"bg-destructive-subtle text-destructive border-destructive/20\"\n      default:\r\n        return \"bg-muted text-muted-foreground border-border\"\r\n    }\r\n  }\r\n\r\n  const getStatusLabel = (status: string | null) => {\r\n    switch (status) {\r\n      case \"paid\":\r\n        return t(\"status.paid\")\r\n      case \"pending\":\r\n        return t(\"status.pending\")\r\n      case \"processing\":\r\n        return t(\"status.processing\")\r\n      case \"shipped\":\r\n        return t(\"status.shipped\")\r\n      case \"delivered\":\r\n        return t(\"status.delivered\")\r\n      case \"cancelled\":\r\n        return t(\"status.cancelled\")\r\n      default:\r\n        return t(\"status.unknown\")\r\n    }\r\n  }\r\n\r\n  const getRoleBadge = (role: string | null) => {\r\n    switch (role) {\r\n      case \"admin\":\r\n        return \"bg-destructive-subtle text-destructive border-destructive/20\"\n      case \"seller\":\r\n        return \"bg-selected text-primary border-selected-border\"\r\n      default:\r\n        return \"bg-muted text-muted-foreground border-border\"\r\n    }\r\n  }\r\n\r\n  const getRoleLabel = (role: string | null) => {\r\n    switch (role) {\r\n      case \"admin\":\r\n        return t(\"roles.admin\")\r\n      case \"seller\":\r\n        return t(\"roles.seller\")\r\n      default:\r\n        return t(\"roles.buyer\")\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"grid gap-4 px-4 lg:px-6 md:grid-cols-2 lg:grid-cols-3\">\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-base\">{t(\"recent.usersTitle\")}</CardTitle>\r\n          <CardDescription>{t(\"recent.usersDescription\")}</CardDescription>\r\n        </CardHeader>\r\n        <CardContent className=\"p-0\">\r\n          <ScrollArea className=\"h-(--spacing-scroll-md)\">\r\n            <div className=\"divide-y\">\r\n              {users.length === 0 ? (\r\n                <p className=\"p-4 text-sm text-muted-foreground\">{t(\"recent.emptyUsers\")}</p>\r\n              ) : (\r\n                users.map((user) => (\r\n                  <div key={user.id} className=\"flex items-center gap-3 p-4\">\r\n                    <Avatar className=\"size-8\">\r\n                      <AvatarFallback className=\"text-xs\">\r\n                        {(user.email || t(\"recent.fallbacks.unknown\")).slice(0, 2).toUpperCase()}\r\n                      </AvatarFallback>\r\n                    </Avatar>\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <p className=\"text-sm font-medium truncate\">\r\n                        {user.full_name || user.email || t(\"recent.fallbacks.unknown\")}\r\n                      </p>\r\n                      <p className=\"text-xs text-muted-foreground\">\r\n                        {formatDistanceToNow(new Date(user.created_at), { addSuffix: true, locale: dateLocale })}\r\n                      </p>\r\n                    </div>\r\n                    <Badge variant=\"outline\" className={getRoleBadge(user.role)}>\r\n                      {getRoleLabel(user.role)}\r\n                    </Badge>\r\n                  </div>\r\n                ))\r\n              )}\r\n            </div>\r\n          </ScrollArea>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-base\">{t(\"recent.productsTitle\")}</CardTitle>\r\n          <CardDescription>{t(\"recent.productsDescription\")}</CardDescription>\r\n        </CardHeader>\r\n        <CardContent className=\"p-0\">\r\n          <ScrollArea className=\"h-(--spacing-scroll-md)\">\r\n            <div className=\"divide-y\">\r\n              {products.length === 0 ? (\r\n                <p className=\"p-4 text-sm text-muted-foreground\">{t(\"recent.emptyProducts\")}</p>\r\n              ) : (\r\n                products.map((product) => (\r\n                  <div key={product.id} className=\"flex items-center gap-3 p-4\">\r\n                    <div className=\"flex size-8 items-center justify-center rounded-md bg-muted text-xs font-medium\">\r\n                      {product.title.slice(0, 2).toUpperCase()}\r\n                    </div>\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <p className=\"text-sm font-medium truncate\">{product.title}</p>\r\n                      <p className=\"text-xs text-muted-foreground\">\r\n                        {formatDistanceToNow(new Date(product.created_at), { addSuffix: true, locale: dateLocale })}\r\n                      </p>\r\n                    </div>\r\n                    <span className=\"text-sm font-medium text-success\">{formatCurrency(product.price)}</span>\r\n                  </div>\r\n                ))\r\n              )}\r\n            </div>\r\n          </ScrollArea>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-base\">{t(\"recent.ordersTitle\")}</CardTitle>\r\n          <CardDescription>{t(\"recent.ordersDescription\")}</CardDescription>\r\n        </CardHeader>\r\n        <CardContent className=\"p-0\">\r\n          <ScrollArea className=\"h-(--spacing-scroll-md)\">\r\n            <div className=\"divide-y\">\r\n              {orders.length === 0 ? (\r\n                <p className=\"p-4 text-sm text-muted-foreground\">{t(\"recent.emptyOrders\")}</p>\r\n              ) : (\r\n                orders.map((order) => (\r\n                  <div key={order.id} className=\"flex items-center gap-3 p-4\">\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <p className=\"text-sm font-medium font-mono\">#{order.id.slice(0, 8)}</p>\r\n                      <p className=\"text-xs text-muted-foreground\">\r\n                        {formatDistanceToNow(new Date(order.created_at), { addSuffix: true, locale: dateLocale })}\r\n                      </p>\r\n                    </div>\r\n                    <Badge variant=\"outline\" className={getStatusColor(order.status)}>\r\n                      {getStatusLabel(order.status)}\r\n                    </Badge>\r\n                    <span className=\"text-sm font-medium tabular-nums\">{formatCurrency(order.total_amount)}</span>\r\n                  </div>\r\n                ))\r\n              )}\r\n            </div>\r\n          </ScrollArea>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\_components\\admin-sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\_components\\admin-stats-cards.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/[locale]/_lib/format-currency' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":7,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":7,"endColumn":69}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { IconTrendingUp, IconUsers, IconBox, IconShoppingCart, IconCurrencyDollar, IconBuildingStore } from \"@tabler/icons-react\"\nimport { useLocale, useTranslations } from \"next-intl\"\n\nimport { Badge } from \"@/components/ui/badge\"\nimport { formatCurrency } from \"@/app/[locale]/_lib/format-currency\"\nimport {\r\n  Card,\r\n  CardAction,\r\n  CardDescription,\r\n  CardFooter,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\n\r\ninterface AdminStatsProps {\r\n  totals: {\r\n    users: number\r\n    products: number\r\n    orders: number\r\n    sellers: number\r\n    revenue: number\r\n  }\r\n}\r\n\r\nexport function AdminStatsCards({ totals }: AdminStatsProps) {\r\n  const t = useTranslations(\"AdminDashboard\")\r\n  const locale = useLocale()\r\n\r\n  return (\r\n    <div className=\"grid grid-cols-1 gap-4 px-4 lg:px-6 @xl/main:grid-cols-2 @5xl/main:grid-cols-5\">\r\n      <Card className=\"@container/card\">\r\n        <CardHeader>\r\n          <CardDescription className=\"flex items-center gap-2\">\r\n            <IconUsers className=\"size-4\" />\r\n            {t(\"stats.users.label\")}\r\n          </CardDescription>\r\n          <CardTitle className=\"text-2xl font-semibold tabular-nums @[250px]/card:text-3xl\">\r\n            {totals.users.toLocaleString(locale)}\r\n          </CardTitle>\r\n          <CardAction>\r\n            <Badge variant=\"outline\" className=\"border-success bg-muted text-success\">\r\n              <IconTrendingUp className=\"size-3\" />\r\n              {t(\"stats.users.badge\")}\r\n            </Badge>\r\n          </CardAction>\r\n        </CardHeader>\r\n        <CardFooter className=\"flex-col items-start gap-1.5 text-sm\">\r\n          <div className=\"text-muted-foreground\">{t(\"stats.users.footer\")}</div>\r\n        </CardFooter>\r\n      </Card>\r\n\r\n      <Card className=\"@container/card\">\r\n        <CardHeader>\r\n          <CardDescription className=\"flex items-center gap-2\">\r\n            <IconBuildingStore className=\"size-4\" />\r\n            {t(\"stats.sellers.label\")}\r\n          </CardDescription>\r\n          <CardTitle className=\"text-2xl font-semibold tabular-nums @[250px]/card:text-3xl\">\r\n            {totals.sellers.toLocaleString(locale)}\r\n          </CardTitle>\r\n          <CardAction>\r\n            <Badge variant=\"outline\" className=\"border-info bg-muted text-info\">\r\n              <IconTrendingUp className=\"size-3\" />\r\n              {t(\"stats.sellers.badge\")}\r\n            </Badge>\r\n          </CardAction>\r\n        </CardHeader>\r\n        <CardFooter className=\"flex-col items-start gap-1.5 text-sm\">\r\n          <div className=\"text-muted-foreground\">{t(\"stats.sellers.footer\")}</div>\r\n        </CardFooter>\r\n      </Card>\r\n\r\n      <Card className=\"@container/card\">\r\n        <CardHeader>\r\n          <CardDescription className=\"flex items-center gap-2\">\r\n            <IconBox className=\"size-4\" />\r\n            {t(\"stats.products.label\")}\r\n          </CardDescription>\r\n          <CardTitle className=\"text-2xl font-semibold tabular-nums @[250px]/card:text-3xl\">\r\n            {totals.products.toLocaleString(locale)}\r\n          </CardTitle>\r\n          <CardAction>\r\n            <Badge variant=\"outline\" className=\"border-selected-border bg-selected text-primary\">\r\n              {t(\"stats.products.badge\")}\r\n            </Badge>\r\n          </CardAction>\r\n        </CardHeader>\r\n        <CardFooter className=\"flex-col items-start gap-1.5 text-sm\">\r\n          <div className=\"text-muted-foreground\">{t(\"stats.products.footer\")}</div>\r\n        </CardFooter>\r\n      </Card>\r\n\r\n      <Card className=\"@container/card\">\r\n        <CardHeader>\r\n          <CardDescription className=\"flex items-center gap-2\">\r\n            <IconShoppingCart className=\"size-4\" />\r\n            {t(\"stats.orders.label\")}\r\n          </CardDescription>\r\n          <CardTitle className=\"text-2xl font-semibold tabular-nums @[250px]/card:text-3xl\">\r\n            {totals.orders.toLocaleString(locale)}\r\n          </CardTitle>\r\n          <CardAction>\r\n            <Badge variant=\"outline\" className=\"border-warning bg-muted text-warning\">\r\n              {t(\"stats.orders.badge\")}\r\n            </Badge>\r\n          </CardAction>\r\n        </CardHeader>\r\n        <CardFooter className=\"flex-col items-start gap-1.5 text-sm\">\r\n          <div className=\"text-muted-foreground\">{t(\"stats.orders.footer\")}</div>\r\n        </CardFooter>\r\n      </Card>\r\n\r\n      <Card className=\"@container/card\">\r\n        <CardHeader>\r\n          <CardDescription className=\"flex items-center gap-2\">\r\n            <IconCurrencyDollar className=\"size-4\" />\r\n            {t(\"stats.revenue.label\")}\r\n          </CardDescription>\r\n          <CardTitle className=\"text-2xl font-semibold tabular-nums @[250px]/card:text-3xl\">\r\n            {formatCurrency(totals.revenue, { locale, maximumFractionDigits: 0 })}\n          </CardTitle>\r\n          <CardAction>\r\n            <Badge variant=\"outline\" className=\"border-success bg-muted text-success\">\r\n              <IconTrendingUp className=\"size-3\" />\r\n              {t(\"stats.revenue.badge\")}\r\n            </Badge>\r\n          </CardAction>\r\n        </CardHeader>\r\n        <CardFooter className=\"flex-col items-start gap-1.5 text-sm\">\r\n          <div className=\"text-muted-foreground\">{t(\"stats.revenue.footer\")}</div>\r\n        </CardFooter>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\docs\\_components\\docs-content.tsx","messages":[{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":106,"column":34,"nodeType":"Identifier","messageId":"method","endLine":106,"endColumn":41,"fix":{"range":[1955,1955],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":107,"column":62,"nodeType":"Identifier","messageId":"method","endLine":107,"endColumn":69,"fix":{"range":[2088,2088],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":110,"column":6,"nodeType":"Identifier","messageId":"method","endLine":110,"endColumn":13,"fix":{"range":[2156,2156],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":111,"column":6,"nodeType":"Identifier","messageId":"method","endLine":111,"endColumn":13,"fix":{"range":[2192,2192],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":112,"column":6,"nodeType":"Identifier","messageId":"method","endLine":112,"endColumn":13,"fix":{"range":[2223,2223],"text":"All"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":5,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { useState } from \"react\"\r\nimport { useLocale, useTranslations } from \"next-intl\"\r\nimport ReactMarkdown from \"react-markdown\"\r\nimport remarkGfm from \"remark-gfm\"\r\nimport {\r\n  IconFileText,\r\n  IconPlus,\r\n  IconSearch,\r\n  IconEdit,\r\n  IconTrash,\r\n  IconX,\r\n} from \"@tabler/icons-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogTitle,\r\n  DialogDescription,\r\n} from \"@/components/ui/dialog\"\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport { toast } from \"sonner\"\r\n\r\ninterface AdminDoc {\r\n  id: string\r\n  title: string\r\n  slug: string\r\n  content: string | null\r\n  category: string\r\n  status: string\r\n  author_id: string | null\r\n  locale: string\r\n  created_at: string | null\r\n  updated_at: string | null\r\n}\r\n\r\nconst CATEGORIES = [\r\n  \"product\",\r\n  \"policies\",\r\n  \"payments\",\r\n  \"plans\",\r\n  \"roadmap\",\r\n  \"ops\",\r\n  \"guides\",\r\n  \"legal\",\r\n  \"general\",\r\n] as const\r\n\r\nconst CYRILLIC_TO_LATIN: Record<string, string> = {\r\n  ╨░: \"a\",\r\n  ╨▒: \"b\",\r\n  ╨▓: \"v\",\r\n  ╨│: \"g\",\r\n  ╨┤: \"d\",\r\n  ╨╡: \"e\",\r\n  ╨╢: \"zh\",\r\n  ╨╖: \"z\",\r\n  ╨╕: \"i\",\r\n  ╨╣: \"y\",\r\n  ╨║: \"k\",\r\n  ╨╗: \"l\",\r\n  ╨╝: \"m\",\r\n  ╨╜: \"n\",\r\n  ╨╛: \"o\",\r\n  ╨┐: \"p\",\r\n  ╤Ç: \"r\",\r\n  ╤ü: \"s\",\r\n  ╤é: \"t\",\r\n  ╤â: \"u\",\r\n  ╤ä: \"f\",\r\n  ╤à: \"h\",\r\n  ╤å: \"ts\",\r\n  ╤ç: \"ch\",\r\n  ╤ê: \"sh\",\r\n  ╤ë: \"sht\",\r\n  ╤è: \"a\",\r\n  ╤î: \"y\",\r\n  ╤Ä: \"yu\",\r\n  ╤Å: \"ya\",\r\n  ╤¥: \"i\",\r\n}\r\n\r\nfunction slugifyTitle(title: string) {\r\n  const lowered = title.trim().toLowerCase()\r\n  const transliterated = lowered.replace(/[\\u0400-\\u04FF]/g, (char) => CYRILLIC_TO_LATIN[char] ?? char)\r\n  const withoutDiacritics = transliterated.normalize(\"NFKD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n\r\n  return withoutDiacritics\r\n    .replace(/[^a-z0-9\\s-]/g, \" \")\r\n    .replace(/[\\s_-]+/g, \"-\")\r\n    .replace(/^-+|-+$/g, \"\")\r\n}\r\n\r\nfunction makeUniqueSlug(baseSlug: string, existingSlugs: Set<string>) {\r\n  const fallback = baseSlug || `doc-${Date.now()}`\r\n  let slug = fallback\r\n  let i = 2\r\n  while (existingSlugs.has(slug)) {\r\n    slug = `${fallback}-${i}`\r\n    i += 1\r\n  }\r\n  return slug\r\n}\r\n\r\nconst STATUS_COLORS: Record<string, string> = {\r\n  draft: \"bg-admin-draft-bg text-admin-draft\",\r\n  published: \"bg-admin-published-bg text-admin-published\",\r\n  archived: \"bg-muted text-muted-foreground\",\r\n}\r\n\r\nconst STATUSES = [\"draft\", \"published\", \"archived\"] as const\r\n\r\nexport function AdminDocsContent({ initialDocs }: { initialDocs: AdminDoc[] }) {\r\n  const locale = useLocale()\r\n  const [docs, setDocs] = useState(initialDocs)\r\n  const [search, setSearch] = useState(\"\")\r\n  const [categoryFilter, setCategoryFilter] = useState<string>(\"all\")\r\n  const [selectedDoc, setSelectedDoc] = useState<AdminDoc | null>(null)\r\n  const [isEditing, setIsEditing] = useState(false)\r\n  const [isCreating, setIsCreating] = useState(false)\r\n  const [isSeeding, setIsSeeding] = useState(false)\r\n\r\n  const t = useTranslations(\"AdminDocs\")\r\n  \r\n  const supabase = createClient()\r\n\r\n  const getCategoryLabel = (value: string) =>\r\n    (CATEGORIES as readonly string[]).includes(value)\r\n      ? t(`categories.${value}`)\r\n      : value\r\n\r\n  const getStatusLabel = (value: string) =>\r\n    (STATUSES as readonly string[]).includes(value)\r\n      ? t(`status.${value}`)\r\n      : value\r\n\r\n  const loadDocs = async () => {\r\n    const { data } = await supabase\r\n      .from(\"admin_docs\")\r\n      .select(\"id, title, slug, content, category, status, author_id, locale, created_at, updated_at\")\r\n      .eq(\"locale\", locale)\r\n      .order(\"category\")\r\n      .order(\"title\")\r\n\r\n    return data || []\r\n  }\r\n\r\n  const filteredDocs = docs.filter((doc) => {\r\n    const matchesSearch = doc.title.toLowerCase().includes(search.toLowerCase())\r\n    const matchesCategory = categoryFilter === \"all\" || doc.category === categoryFilter\r\n    return matchesSearch && matchesCategory\r\n  })\r\n\r\n  const handleSave = async (doc: Partial<AdminDoc> & { id?: string }) => {\r\n    if (doc.id) {\r\n      // Update - build object conditionally to satisfy exactOptionalPropertyTypes\r\n      const updateData: Record<string, string | null> = {\r\n        updated_at: new Date().toISOString(),\r\n      }\r\n      if (doc.title !== undefined) updateData.title = doc.title\r\n      if (doc.content !== undefined) updateData.content = doc.content\r\n      if (doc.category !== undefined) updateData.category = doc.category\r\n      if (doc.status !== undefined) updateData.status = doc.status\r\n      \r\n      const { error } = await supabase\r\n        .from(\"admin_docs\")\r\n        .update(updateData)\r\n        .eq(\"id\", doc.id)\r\n      \r\n      if (error) {\r\n        toast.error(t(\"toasts.updateFailed\"))\r\n        return\r\n      }\r\n      \r\n      setDocs(docs.map((d) => (d.id === doc.id ? { ...d, ...doc } : d)))\r\n      toast.success(t(\"toasts.updated\"))\r\n    } else {\r\n      // Create\r\n      if (!doc.title) {\r\n        toast.error(t(\"toasts.titleRequired\"))\r\n        return\r\n      }\r\n      const baseSlug = slugifyTitle(doc.title)\r\n      const existingSlugs = new Set(docs.map((d) => d.slug))\r\n      const slug = makeUniqueSlug(baseSlug, existingSlugs)\r\n      const { data, error } = await supabase\r\n        .from(\"admin_docs\")\r\n        .insert({\r\n          title: doc.title,\r\n          slug,\r\n          content: doc.content ?? null,\r\n          category: doc.category || \"general\",\r\n          status: doc.status || \"draft\",\r\n          locale,\r\n        })\r\n        .select(\"id, title, slug, content, category, status, author_id, locale, created_at, updated_at\")\r\n        .single()\r\n      \r\n      if (error) {\r\n        toast.error(t(\"toasts.createFailed\"))\r\n        return\r\n      }\r\n      \r\n      if (data) {\r\n        setDocs([...docs, data])\r\n        toast.success(t(\"toasts.created\"))\r\n      }\r\n    }\r\n    \r\n    setSelectedDoc(null)\r\n    setIsEditing(false)\r\n    setIsCreating(false)\r\n  }\r\n\r\n  const handleDelete = async (id: string) => {\r\n    const { error } = await supabase.from(\"admin_docs\").delete().eq(\"id\", id)\r\n    \r\n    if (error) {\r\n      toast.error(t(\"toasts.deleteFailed\"))\r\n      return\r\n    }\r\n    \r\n    setDocs(docs.filter((d) => d.id !== id))\r\n    setSelectedDoc(null)\r\n    toast.success(t(\"toasts.deleted\"))\r\n  }\r\n\r\n  const handleSeedTemplates = async () => {\r\n    setIsSeeding(true)\r\n    try {\r\n      const response = await fetch(\"/api/admin/docs/seed\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ locale }),\r\n      })\r\n      const payload: unknown = await response.json()\r\n\r\n      if (!response.ok) {\r\n        toast.error(t(\"toasts.seedFailed\"))\r\n        return\r\n      }\r\n\r\n      const inserted =\r\n        typeof payload === \"object\" && payload && \"inserted\" in payload\r\n          ? Number((payload as { inserted: unknown }).inserted)\r\n          : 0\r\n\r\n      const refreshedDocs = await loadDocs()\r\n      setDocs(refreshedDocs)\r\n      toast.success(inserted > 0 ? t(\"toasts.seeded\", { count: inserted }) : t(\"toasts.noNewTemplates\"))\r\n    } catch {\r\n      toast.error(t(\"toasts.seedFailed\"))\r\n    } finally {\r\n      setIsSeeding(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      {/* Filters */}\r\n      <div className=\"flex flex-wrap gap-2\">\r\n        <div className=\"relative flex-1 basis-52 min-w-0 max-w-sm\">\r\n          <IconSearch className=\"absolute left-3 top-1/2 -translate-y-1/2 size-4 text-muted-foreground\" />\r\n          <Input\r\n            placeholder={t(\"filters.searchPlaceholder\")}\r\n            value={search}\r\n            onChange={(e) => setSearch(e.target.value)}\r\n            className=\"pl-9\"\r\n          />\r\n        </div>\r\n        <Select value={categoryFilter} onValueChange={setCategoryFilter}>\r\n          <SelectTrigger className=\"w-40\">\r\n            <SelectValue placeholder={t(\"filters.categoryPlaceholder\")} />\r\n          </SelectTrigger>\r\n          <SelectContent>\r\n            <SelectItem value=\"all\">{t(\"filters.allCategories\")}</SelectItem>\r\n            {CATEGORIES.map((category) => (\r\n              <SelectItem key={category} value={category}>\r\n                {t(`categories.${category}`)}\r\n              </SelectItem>\r\n            ))}\r\n          </SelectContent>\r\n        </Select>\r\n        <Button\r\n          variant=\"outline\"\r\n          onClick={handleSeedTemplates}\r\n          disabled={isSeeding}\r\n        >\r\n          {t(\"buttons.seedTemplates\")}\r\n        </Button>\r\n        <Button onClick={() => { setIsCreating(true); setSelectedDoc(null) }}>\r\n          <IconPlus className=\"size-4 mr-2\" />\r\n          {t(\"buttons.newDoc\")}\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Table */}\r\n      <div className=\"rounded-lg border\">\r\n        <Table>\r\n          <TableHeader>\r\n            <TableRow>\r\n              <TableHead>{t(\"table.title\")}</TableHead>\r\n              <TableHead>{t(\"table.category\")}</TableHead>\r\n              <TableHead>{t(\"table.status\")}</TableHead>\r\n              <TableHead>{t(\"table.updated\")}</TableHead>\r\n              <TableHead className=\"w-28\">{t(\"table.actions\")}</TableHead>\r\n            </TableRow>\r\n          </TableHeader>\r\n          <TableBody>\r\n            {filteredDocs.length === 0 ? (\r\n              <TableRow>\r\n                <TableCell colSpan={5} className=\"text-center py-8 text-muted-foreground\">\r\n                  {t(\"table.empty\")}\r\n                </TableCell>\r\n              </TableRow>\r\n            ) : (\r\n              filteredDocs.map((doc) => (\r\n                <TableRow \r\n                  key={doc.id} \r\n                  className=\"cursor-pointer hover:bg-hover\"\r\n                  onClick={() => { setSelectedDoc(doc); setIsEditing(false) }}\r\n                >\r\n                  <TableCell className=\"font-medium\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <IconFileText className=\"size-4 text-muted-foreground\" />\r\n                      {doc.title}\r\n                    </div>\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    <Badge variant=\"outline\" className=\"capitalize\">\r\n                      {getCategoryLabel(doc.category)}\r\n                    </Badge>\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    <Badge className={STATUS_COLORS[doc.status] || \"\"}>\r\n                      {getStatusLabel(doc.status)}\r\n                    </Badge>\r\n                  </TableCell>\r\n                  <TableCell className=\"text-muted-foreground\">\r\n                    {doc.updated_at\r\n                      ? new Date(doc.updated_at).toLocaleDateString(locale)\r\n                      : t(\"viewer.emptyDate\")}\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    <div className=\"flex gap-1\">\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"icon\"\r\n                        aria-label={t(\"aria.edit\")}\r\n                        title={t(\"aria.edit\")}\r\n                        onClick={(e) => {\r\n                          e.stopPropagation()\r\n                          setSelectedDoc(doc)\r\n                          setIsEditing(true)\r\n                        }}\r\n                      >\r\n                        <IconEdit className=\"size-4\" />\r\n                      </Button>\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"icon\"\r\n                        aria-label={t(\"aria.delete\")}\r\n                        title={t(\"aria.delete\")}\r\n                        onClick={(e) => {\r\n                          e.stopPropagation()\r\n                          if (confirm(t(\"actions.confirmDelete\"))) {\r\n                            handleDelete(doc.id)\r\n                          }\r\n                        }}\r\n                      >\r\n                        <IconTrash className=\"size-4\" />\r\n                      </Button>\r\n                    </div>\r\n                  </TableCell>\r\n                </TableRow>\r\n              ))\r\n            )}\r\n          </TableBody>\r\n        </Table>\r\n      </div>\r\n\r\n      {/* Full-screen Document Modal */}\r\n      <Dialog \r\n        open={!!selectedDoc || isCreating} \r\n        onOpenChange={(open) => {\r\n          if (!open) {\r\n            setSelectedDoc(null)\r\n            setIsEditing(false)\r\n            setIsCreating(false)\r\n          }\r\n        }}\r\n      >\r\n        <DialogContent \r\n          className=\"w-dialog sm:max-w-(--width-modal-lg) max-h-dialog p-0 gap-0 flex flex-col\"\r\n          showCloseButton={false}\r\n        >\r\n          {(selectedDoc || isCreating) && (\r\n            <DocEditor\r\n              doc={selectedDoc}\r\n              isEditing={isEditing || isCreating}\r\n              onSave={handleSave}\r\n              onEdit={() => setIsEditing(true)}\r\n              onCancel={() => {\r\n                setIsEditing(false)\r\n                setIsCreating(false)\r\n                setSelectedDoc(null)\r\n              }}\r\n              onClose={() => {\r\n                setSelectedDoc(null)\r\n                setIsEditing(false)\r\n                setIsCreating(false)\r\n              }}\r\n            />\r\n          )}\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction DocEditor({\r\n  doc,\r\n  isEditing,\r\n  onSave,\r\n  onEdit,\r\n  onCancel,\r\n  onClose,\r\n}: {\r\n  doc: AdminDoc | null\r\n  isEditing: boolean\r\n  onSave: (doc: Partial<AdminDoc> & { id?: string }) => void\r\n  onEdit: () => void\r\n  onCancel: () => void\r\n  onClose: () => void\r\n}) {\r\n  const activeLocale = useLocale()\r\n  const [title, setTitle] = useState(doc?.title || \"\")\r\n  const [content, setContent] = useState(doc?.content || \"\")\r\n  const [category, setCategory] = useState(doc?.category || \"general\")\r\n  const [status, setStatus] = useState(doc?.status || \"draft\")\r\n  const t = useTranslations(\"AdminDocs\")\r\n\r\n  const getCategoryLabel = (value: string) =>\r\n    (CATEGORIES as readonly string[]).includes(value)\r\n      ? t(`categories.${value}`)\r\n      : value\r\n\r\n  const getStatusLabel = (value: string) =>\r\n    (STATUSES as readonly string[]).includes(value)\r\n      ? t(`status.${value}`)\r\n      : value\r\n\r\n  // Reset form when doc changes\r\n  React.useEffect(() => {\r\n    setTitle(doc?.title || \"\")\r\n    setContent(doc?.content || \"\")\r\n    setCategory(doc?.category || \"general\")\r\n    setStatus(doc?.status || \"draft\")\r\n  }, [doc])\r\n\r\n  const handleSubmit = () => {\r\n    if (!title.trim()) {\r\n      toast.error(t(\"toasts.titleRequired\"))\r\n      return\r\n    }\r\n    onSave({\r\n      ...(doc?.id ? { id: doc.id } : {}),\r\n      title,\r\n      content,\r\n      category,\r\n      status,\r\n    })\r\n  }\r\n\r\n  if (!isEditing && doc) {\r\n    // View mode - full screen document viewer\r\n    return (\r\n      <div className=\"flex flex-col min-h-0 h-full\">\r\n        {/* Header */}\r\n        <div className=\"flex items-center justify-between px-4 sm:px-6 py-3 border-b bg-background shrink-0\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              onClick={onClose}\r\n              aria-label={t(\"aria.close\")}\r\n              title={t(\"aria.close\")}\r\n              className=\"shrink-0 size-8\"\r\n            >\r\n              <IconX className=\"size-5\" />\r\n            </Button>\r\n            <div className=\"min-w-0\">\r\n              <DialogTitle className=\"text-base font-semibold truncate\">\r\n                {doc.title}\r\n              </DialogTitle>\r\n              <DialogDescription className=\"sr-only\">\r\n                {t(\"viewer.srDescription\")}\r\n              </DialogDescription>\r\n            </div>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Badge variant=\"outline\" className=\"capitalize hidden sm:inline-flex\">\r\n              {getCategoryLabel(doc.category)}\r\n            </Badge>\r\n            <Badge className={STATUS_COLORS[doc.status] || \"\"}>\r\n              {getStatusLabel(doc.status)}\r\n            </Badge>\r\n            <Button variant=\"outline\" size=\"sm\" onClick={onEdit}>\r\n              <IconEdit className=\"size-4 mr-2\" />\r\n              {t(\"actions.edit\")}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"flex-1 min-h-0 overflow-y-auto p-4 sm:p-8\">\r\n          <div className=\"mx-auto w-full\">\r\n            <ReactMarkdown \r\n              remarkPlugins={[remarkGfm]}\r\n              components={{\r\n                h1: ({ children }) => <h1 className=\"text-2xl font-bold mb-4 mt-6 first:mt-0\">{children}</h1>,\r\n                h2: ({ children }) => <h2 className=\"text-xl font-semibold mb-3 mt-5 pb-2 border-b\">{children}</h2>,\r\n                h3: ({ children }) => <h3 className=\"text-lg font-semibold mb-2 mt-4\">{children}</h3>,\r\n                h4: ({ children }) => <h4 className=\"text-base font-semibold mb-2 mt-3\">{children}</h4>,\r\n                p: ({ children }) => <p className=\"mb-3 text-sm leading-relaxed\">{children}</p>,\r\n                ul: ({ children }) => <ul className=\"list-disc pl-5 mb-3 text-sm space-y-1\">{children}</ul>,\r\n                ol: ({ children }) => <ol className=\"list-decimal pl-5 mb-3 text-sm space-y-1\">{children}</ol>,\r\n                li: ({ children }) => <li className=\"text-sm\">{children}</li>,\r\n                strong: ({ children }) => <strong className=\"font-semibold\">{children}</strong>,\r\n                hr: () => <hr className=\"my-6 border-border\" />,\r\n                a: ({ children, href }) => (\r\n                  <a\r\n                    href={href}\r\n                    className=\"text-link underline underline-offset-4 hover:text-link-hover\"\r\n                    target={href?.startsWith(\"http\") ? \"_blank\" : undefined}\r\n                    rel={href?.startsWith(\"http\") ? \"noreferrer\" : undefined}\r\n                  >\r\n                    {children}\r\n                  </a>\r\n                ),\r\n                blockquote: ({ children }) => (\r\n                  <blockquote className=\"border-l-4 border-selected-border pl-4 italic text-muted-foreground my-3\">\r\n                    {children}\r\n                  </blockquote>\r\n                ),\r\n                pre: ({ children }) => (\r\n                  <pre className=\"my-4 overflow-x-auto rounded-md border border-border bg-muted p-3 text-xs leading-relaxed\">\r\n                    {children}\r\n                  </pre>\r\n                ),\r\n                code: ({ className, children, ...props }) => {\r\n                  const isBlock = typeof className === \"string\" && className.startsWith(\"language-\")\r\n\r\n                  if (!isBlock) {\r\n                    return (\r\n                      <code\r\n                        className=\"bg-muted px-1.5 py-0.5 rounded text-xs font-mono\"\r\n                        {...props}\r\n                      >\r\n                        {children}\r\n                      </code>\r\n                    )\r\n                  }\r\n\r\n                  return (\r\n                    <code\r\n                      className={className ? `${className} block font-mono` : \"block font-mono\"}\r\n                      {...props}\r\n                    >\r\n                      {children}\r\n                    </code>\r\n                  )\r\n                },\r\n                table: ({ children }) => (\r\n                  <div className=\"my-4 rounded-md border border-border\">\r\n                    <Table className=\"whitespace-normal\">\r\n                      {children}\r\n                    </Table>\r\n                  </div>\r\n                ),\r\n                thead: ({ children }) => <TableHeader className=\"bg-surface-subtle\">{children}</TableHeader>,\r\n                tbody: ({ children }) => <TableBody>{children}</TableBody>,\r\n                tr: ({ children }) => <TableRow className=\"hover:bg-hover\">{children}</TableRow>,\r\n                th: ({ children }) => <TableHead className=\"whitespace-normal align-top\">{children}</TableHead>,\r\n                td: ({ children }) => <TableCell className=\"whitespace-normal align-top\">{children}</TableCell>,\r\n              }}\r\n            >\r\n              {doc.content || t(\"viewer.noContent\")}\r\n            </ReactMarkdown>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Footer */}\r\n        <div className=\"px-4 sm:px-6 py-3 border-t bg-surface-subtle text-xs text-muted-foreground shrink-0\">\r\n          {t(\"viewer.lastUpdatedLabel\")}{\" \"}\r\n          {doc.updated_at\r\n            ? new Date(doc.updated_at).toLocaleString(activeLocale)\r\n            : t(\"viewer.emptyDate\")}\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Edit/Create mode - full screen editor\r\n  return (\r\n    <div className=\"flex flex-col min-h-0 h-full\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between px-4 sm:px-6 py-3 border-b bg-background shrink-0\">\r\n        <div className=\"flex items-center gap-3\">\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"icon\"\r\n            onClick={onCancel}\r\n            aria-label={t(\"aria.close\")}\r\n            title={t(\"aria.close\")}\r\n            className=\"shrink-0 size-8\"\r\n          >\r\n            <IconX className=\"size-5\" />\r\n          </Button>\r\n          <div>\r\n            <DialogTitle className=\"text-base font-semibold\">\r\n              {doc ? t(\"editor.titleEdit\") : t(\"editor.titleNew\")}\r\n            </DialogTitle>\r\n            <DialogDescription className=\"text-xs text-muted-foreground hidden sm:block\">\r\n              {doc ? t(\"editor.descriptionEdit\") : t(\"editor.descriptionNew\")}\r\n            </DialogDescription>\r\n          </div>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <Select value={status} onValueChange={setStatus}>\r\n            <SelectTrigger className=\"w-28 h-8 text-xs\">\r\n              <SelectValue />\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              <SelectItem value=\"draft\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <div className=\"size-2 rounded-full bg-admin-draft\" />\r\n                  {t(\"status.draft\")}\r\n                </div>\r\n              </SelectItem>\r\n              <SelectItem value=\"published\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <div className=\"size-2 rounded-full bg-admin-published\" />\r\n                  {t(\"status.published\")}\r\n                </div>\r\n              </SelectItem>\r\n              <SelectItem value=\"archived\">\r\n                <div className=\"flex items-center gap-2\">\r\n                  <div className=\"size-2 rounded-full bg-muted-foreground\" />\r\n                  {t(\"status.archived\")}\r\n                </div>\r\n              </SelectItem>\r\n            </SelectContent>\r\n          </Select>\r\n          <Button variant=\"outline\" size=\"sm\" onClick={onCancel}>\r\n            {t(\"actions.cancel\")}\r\n          </Button>\r\n          <Button size=\"sm\" onClick={handleSubmit}>\r\n            {doc ? t(\"actions.save\") : t(\"actions.create\")}\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Editor Content */}\r\n      <div className=\"flex-1 min-h-0 overflow-y-auto p-4 sm:p-6\">\r\n        <div className=\"mx-auto w-full space-y-6\">\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\r\n            <div className=\"sm:col-span-2 space-y-2\">\r\n              <Label htmlFor=\"title\">{t(\"editor.titleLabel\")}</Label>\r\n              <Input\r\n                id=\"title\"\r\n                value={title}\r\n                onChange={(e) => setTitle(e.target.value)}\r\n                placeholder={t(\"editor.titlePlaceholder\")}\r\n                className=\"text-lg font-medium\"\r\n              />\r\n            </div>\r\n            \r\n            <div className=\"space-y-2\">\r\n              <Label>{t(\"editor.categoryLabel\")}</Label>\r\n              <Select value={category} onValueChange={setCategory}>\r\n                <SelectTrigger>\r\n                  <SelectValue />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {CATEGORIES.map((cat) => (\r\n                    <SelectItem key={cat} value={cat}>\r\n                      {t(`categories.${cat}`)}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          </div>\r\n          \r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"content\">{t(\"editor.contentLabel\")}</Label>\r\n            <Textarea\r\n              id=\"content\"\r\n              value={content}\r\n              onChange={(e) => setContent(e.target.value)}\r\n              placeholder={t(\"editor.contentPlaceholder\")}\r\n              className=\"min-h-96 font-mono text-sm resize-none\"\r\n            />\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\docs\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\notes\\_components\\notes-content.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'locale' is assigned a value but never used.","line":40,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":40,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { useState } from \"react\"\r\nimport {\r\n  IconPlus,\r\n  IconPin,\r\n  IconPinFilled,\r\n  IconTrash,\r\n  IconEdit,\r\n} from \"@tabler/icons-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogFooter,\r\n} from \"@/components/ui/dialog\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { useLocale, useTranslations } from \"next-intl\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport { toast } from \"sonner\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\ninterface AdminNote {\r\n  id: string\r\n  title: string\r\n  content: string | null\r\n  is_pinned: boolean | null\r\n  author_id: string | null\r\n  created_at: string | null\r\n  updated_at: string | null\r\n}\r\n\r\nexport function AdminNotesContent({ initialNotes }: { initialNotes: AdminNote[] }) {\r\n  const locale = useLocale()\r\n  const t = useTranslations(\"AdminNotes\")\r\n  const [notes, setNotes] = useState(initialNotes)\r\n  const [editingNote, setEditingNote] = useState<AdminNote | null>(null)\r\n  const [isDialogOpen, setIsDialogOpen] = useState(false)\r\n  \r\n  const supabase = createClient()\r\n\r\n  const sortedNotes = [...notes].sort((a, b) => {\r\n    if (a.is_pinned !== b.is_pinned) return (b.is_pinned ? 1 : 0) - (a.is_pinned ? 1 : 0)\r\n    return new Date(b.created_at || 0).getTime() - new Date(a.created_at || 0).getTime()\r\n  })\r\n\r\n  const handleTogglePin = async (note: AdminNote) => {\r\n    const { error } = await supabase\r\n      .from(\"admin_notes\")\r\n      .update({ is_pinned: !note.is_pinned, updated_at: new Date().toISOString() })\r\n      .eq(\"id\", note.id)\r\n    \r\n    if (error) {\r\n      toast.error(t(\"toasts.updateFailed\"))\r\n      return\r\n    }\r\n    \r\n    setNotes(notes.map((n) => (n.id === note.id ? { ...n, is_pinned: !n.is_pinned } : n)))\r\n  }\r\n\r\n  const handleSave = async (note: Partial<AdminNote> & { id?: string }) => {\r\n    if (note.id) {\r\n      // Update - build object conditionally to satisfy exactOptionalPropertyTypes\r\n      const updateData: Record<string, string | null> = {\r\n        updated_at: new Date().toISOString(),\r\n      }\r\n      if (note.title !== undefined) updateData.title = note.title\r\n      if (note.content !== undefined) updateData.content = note.content\r\n      \r\n      const { error } = await supabase\r\n        .from(\"admin_notes\")\r\n        .update(updateData)\r\n        .eq(\"id\", note.id)\r\n      \r\n      if (error) {\r\n        toast.error(t(\"toasts.updateFailed\"))\r\n        return\r\n      }\r\n      \r\n      setNotes(notes.map((n) => (n.id === note.id ? { ...n, ...note } : n)))\r\n      toast.success(t(\"toasts.updated\"))\r\n    } else {\r\n      // Create\r\n      if (!note.title) {\r\n        toast.error(t(\"toasts.titleRequired\"))\r\n        return\r\n      }\r\n      const { data, error } = await supabase\r\n        .from(\"admin_notes\")\r\n        .insert({\r\n          title: note.title,\r\n          content: note.content ?? null,\r\n        })\r\n        .select(\"id, title, content, is_pinned, author_id, created_at, updated_at\")\r\n        .single()\r\n      \r\n      if (error) {\r\n        toast.error(t(\"toasts.createFailed\"))\r\n        return\r\n      }\r\n      \r\n      if (data) {\r\n        setNotes([data, ...notes])\r\n        toast.success(t(\"toasts.created\"))\r\n      }\r\n    }\r\n    \r\n    setIsDialogOpen(false)\r\n    setEditingNote(null)\r\n  }\r\n\r\n  const handleDelete = async (id: string) => {\r\n    const { error } = await supabase.from(\"admin_notes\").delete().eq(\"id\", id)\r\n    \r\n    if (error) {\r\n      toast.error(t(\"toasts.deleteFailed\"))\r\n      return\r\n    }\r\n    \r\n    setNotes(notes.filter((n) => n.id !== id))\r\n    toast.success(t(\"toasts.deleted\"))\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"flex justify-between items-center\">\r\n        <div className=\"text-sm text-muted-foreground\">\r\n          {t(\"summary\", {\r\n            count: notes.length,\r\n            pinned: notes.filter((n) => n.is_pinned).length,\r\n          })}\r\n        </div>\r\n        <Button onClick={() => { setEditingNote(null); setIsDialogOpen(true) }}>\r\n          <IconPlus className=\"size-4 mr-2\" />\r\n          {t(\"buttons.newNote\")}\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Notes Grid */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n        {sortedNotes.length === 0 ? (\r\n          <div className=\"col-span-full text-center py-12 text-muted-foreground\">\r\n            {t(\"empty\")}\r\n          </div>\r\n        ) : (\r\n          sortedNotes.map((note) => (\r\n            <NoteCard\r\n              key={note.id}\r\n              note={note}\r\n              onTogglePin={() => handleTogglePin(note)}\r\n              onEdit={() => { setEditingNote(note); setIsDialogOpen(true) }}\r\n              onDelete={() => {\r\n                if (confirm(t(\"confirm.deleteNote\"))) {\r\n                  handleDelete(note.id)\r\n                }\r\n              }}\r\n            />\r\n          ))\r\n        )}\r\n      </div>\r\n\r\n      {/* Edit/Create Dialog */}\r\n      <NoteDialog\r\n        note={editingNote}\r\n        open={isDialogOpen}\r\n        onOpenChange={setIsDialogOpen}\r\n        onSave={handleSave}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction NoteCard({\r\n  note,\r\n  onTogglePin,\r\n  onEdit,\r\n  onDelete,\r\n}: {\r\n  note: AdminNote\r\n  onTogglePin: () => void\r\n  onEdit: () => void\r\n  onDelete: () => void\r\n}) {\r\n  const t = useTranslations(\"AdminNotes\")\r\n  const locale = useLocale()\r\n\r\n  return (\r\n    <Card className={cn(\"group\", note.is_pinned && \"border-selected-border bg-hover\")}>\r\n      <CardHeader className=\"p-4 pb-2\">\r\n        <div className=\"flex items-start justify-between gap-2\">\r\n          <CardTitle className=\"text-base leading-tight\">{note.title}</CardTitle>\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"icon\"\r\n            className=\"size-7 shrink-0\"\r\n            onClick={onTogglePin}\r\n          >\r\n            {note.is_pinned ? (\r\n              <IconPinFilled className=\"size-4 text-primary\" />\r\n            ) : (\r\n              <IconPin className=\"size-4\" />\r\n            )}\r\n          </Button>\r\n        </div>\r\n      </CardHeader>\r\n      <CardContent className=\"p-4 pt-0\">\r\n        {note.content && (\r\n          <p className=\"text-sm text-muted-foreground line-clamp-4 whitespace-pre-wrap\">\r\n            {note.content}\r\n          </p>\r\n        )}\r\n        <div className=\"flex items-center justify-between mt-3 pt-3 border-t\">\r\n          <span className=\"text-xs text-muted-foreground\">\r\n            {note.updated_at ? new Date(note.updated_at).toLocaleDateString(locale) : t(\"dateEmpty\")}\r\n          </span>\r\n          <div className=\"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n            <Button variant=\"ghost\" size=\"icon\" className=\"size-7\" onClick={onEdit}>\r\n              <IconEdit className=\"size-3.5\" />\r\n            </Button>\r\n            <Button variant=\"ghost\" size=\"icon\" className=\"size-7\" onClick={onDelete}>\r\n              <IconTrash className=\"size-3.5\" />\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n}\r\n\r\nfunction NoteDialog({\r\n  note,\r\n  open,\r\n  onOpenChange,\r\n  onSave,\r\n}: {\r\n  note: AdminNote | null\r\n  open: boolean\r\n  onOpenChange: (open: boolean) => void\r\n  onSave: (note: Partial<AdminNote> & { id?: string }) => void\r\n}) {\r\n  const [title, setTitle] = useState(note?.title || \"\")\r\n  const [content, setContent] = useState(note?.content || \"\")\r\n  const t = useTranslations(\"AdminNotes\")\r\n\r\n  React.useEffect(() => {\r\n    if (open) {\r\n      setTitle(note?.title || \"\")\r\n      setContent(note?.content || \"\")\r\n    }\r\n  }, [open, note])\r\n\r\n  const handleSubmit = () => {\r\n    if (!title.trim()) {\r\n      toast.error(t(\"toasts.titleRequired\"))\r\n      return\r\n    }\r\n    onSave({\r\n      ...(note?.id ? { id: note.id } : {}),\r\n      title,\r\n      content: content || null,\r\n    })\r\n  }\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent>\r\n        <DialogHeader>\r\n          <DialogTitle>{note ? t(\"dialog.titleEdit\") : t(\"dialog.titleNew\")}</DialogTitle>\r\n        </DialogHeader>\r\n        <div className=\"space-y-4\">\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"title\">{t(\"labels.title\")}</Label>\r\n            <Input\r\n              id=\"title\"\r\n              value={title}\r\n              onChange={(e) => setTitle(e.target.value)}\r\n              placeholder={t(\"placeholders.title\")}\r\n            />\r\n          </div>\r\n          \r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"content\">{t(\"labels.content\")}</Label>\r\n            <Textarea\r\n              id=\"content\"\r\n              value={content}\r\n              onChange={(e) => setContent(e.target.value)}\r\n              placeholder={t(\"placeholders.content\")}\r\n              rows={8}\r\n            />\r\n          </div>\r\n        </div>\r\n        <DialogFooter>\r\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)}>\r\n            {t(\"buttons.cancel\")}\r\n          </Button>\r\n          <Button onClick={handleSubmit}>\r\n            {note ? t(\"buttons.saveChanges\") : t(\"buttons.createNote\")}\r\n          </Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\notes\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\orders\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\orders\\page.tsx","messages":[{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":57,"column":19,"nodeType":"CallExpression","messageId":"array-from","endLine":57,"endColumn":92,"fix":{"range":[1295,1368],"text":"[...new Set((orders || []).map((o) => o.user_id).filter(Boolean))]"}},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getStatusColor' to the outer scope.","line":98,"column":50,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":98,"endColumn":52}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { createAdminClient } from \"@/lib/supabase/server\"\r\nimport { formatDistanceToNow } from \"date-fns\"\r\nimport { bg, enUS } from \"date-fns/locale\"\r\nimport { getLocale, getTranslations } from \"next-intl/server\"\r\nimport { connection } from \"next/server\"\r\n\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\n\r\n// Type for admin order with profile info\r\ninterface AdminOrder {\r\n  id: string\r\n  total_amount: number\r\n  status: string | null\r\n  created_at: string\r\n  user_id: string\r\n  profiles: { email: string | null; full_name: string | null } | null\r\n}\r\n\r\nasync function getOrders(): Promise<AdminOrder[]> {\r\n  const adminClient = createAdminClient()\r\n  \r\n  const { data: orders, error } = await adminClient\r\n    .from('orders')\r\n    .select(`\r\n      id,\r\n      total_amount,\r\n      status,\r\n      created_at,\r\n      user_id,\r\n      profiles (\r\n        full_name\r\n      )\r\n    `)\r\n    .order('created_at', { ascending: false })\r\n    .limit(100)\r\n  \r\n  if (error) {\r\n    console.error('Failed to fetch orders:', error)\r\n    return []\r\n  }\r\n\r\n  const userIds = Array.from(new Set((orders || []).map((o) => o.user_id).filter(Boolean)))\r\n\r\n  const { data: privateProfiles } = userIds.length\r\n    ? await adminClient\r\n        .from('private_profiles')\r\n        .select('id, email')\r\n        .in('id', userIds)\r\n    : { data: [] as Array<{ id: string; email: string | null }> }\r\n\r\n  const emailById = new Map((privateProfiles || []).map((p) => [p.id, p.email]))\r\n\r\n  return (orders || []).map((order) => {\r\n    const profile = Array.isArray(order.profiles) ? (order.profiles.at(0) ?? null) : order.profiles\r\n\r\n    return {\r\n      ...order,\r\n      profiles: {\r\n        full_name: profile?.full_name ?? null,\r\n        email: emailById.get(order.user_id) ?? null,\r\n      },\r\n    }\r\n  }) as AdminOrder[]\r\n}\r\n\r\nexport default async function AdminOrdersPage() {\r\n  // Mark route as dynamic without using route segment config (incompatible with cacheComponents).\r\n  await connection()\r\n\r\n  const orders = await getOrders()\r\n  const t = await getTranslations(\"AdminOrders\")\r\n  const locale = await getLocale()\r\n  const dateLocale = locale === \"bg\" ? bg : enUS\r\n  \r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat(locale, {\r\n      style: 'currency',\r\n      currency: 'BGN',\r\n      maximumFractionDigits: 2,\r\n    }).format(value)\r\n  }\r\n\r\n  const getStatusColor = (status: string | null) => {\r\n    switch (status) {\r\n      case 'paid':\r\n        return 'bg-muted text-success border-success'\r\n      case 'pending':\r\n        return 'bg-muted text-order-pending border-order-pending'\r\n      case 'processing':\r\n        return 'bg-muted text-order-processing border-order-processing'\r\n      case 'shipped':\r\n        return 'bg-muted text-order-shipped border-order-shipped'\r\n      case 'delivered':\r\n        return 'bg-muted text-order-delivered border-order-delivered'\r\n      case 'cancelled':\r\n        return 'bg-muted text-order-cancelled border-order-cancelled'\r\n      default:\r\n        return 'bg-muted text-muted-foreground border-border'\r\n    }\r\n  }\r\n\r\n  const getStatusLabel = (status: string | null) => {\r\n    switch (status) {\r\n      case 'paid':\r\n        return t('status.paid')\r\n      case 'pending':\r\n        return t('status.pending')\r\n      case 'processing':\r\n        return t('status.processing')\r\n      case 'shipped':\r\n        return t('status.shipped')\r\n      case 'delivered':\r\n        return t('status.delivered')\r\n      case 'cancelled':\r\n        return t('status.cancelled')\r\n      default:\r\n        return t('status.unknown')\r\n    }\r\n  }\r\n\r\n  // Calculate totals\r\n  const totalRevenue = orders\r\n    .filter(o => o.status === 'paid' || o.status === 'delivered')\r\n    .reduce((sum, o) => sum + Number(o.total_amount || 0), 0)\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6 px-4 lg:px-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold tracking-tight\">{t('page.title')}</h1>\r\n          <p className=\"text-muted-foreground\">\r\n            {t('page.description')}\r\n          </p>\r\n        </div>\r\n        <div className=\"flex gap-4\">\r\n          <Badge variant=\"outline\" className=\"text-base\">\r\n            {t('summary.orders', { count: orders.length })}\r\n          </Badge>\r\n          <Badge variant=\"outline\" className=\"text-base bg-success/10 text-success border-success/25\">\r\n            {t('summary.revenue', { amount: formatCurrency(totalRevenue) })}\r\n          </Badge>\r\n        </div>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>{t('table.title')}</CardTitle>\r\n          <CardDescription>{t('table.description')}</CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <Table>\r\n            <TableHeader>\r\n              <TableRow>\r\n                <TableHead>{t('table.headers.orderId')}</TableHead>\r\n                <TableHead>{t('table.headers.customer')}</TableHead>\r\n                <TableHead>{t('table.headers.amount')}</TableHead>\r\n                <TableHead>{t('table.headers.status')}</TableHead>\r\n                <TableHead>{t('table.headers.date')}</TableHead>\r\n              </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n              {orders.map((order) => (\r\n                <TableRow key={order.id}>\r\n                  <TableCell className=\"font-mono text-sm\">\r\n                    #{order.id.slice(0, 8)}\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    <div>\r\n                      <p className=\"font-medium\">\r\n                        {order.profiles?.full_name || t('fallbacks.noName')}\r\n                      </p>\r\n                      <p className=\"text-sm text-muted-foreground\">\r\n                        {order.profiles?.email}\r\n                      </p>\r\n                    </div>\r\n                  </TableCell>\r\n                  <TableCell className=\"font-medium tabular-nums\">\r\n                    {formatCurrency(order.total_amount)}\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    <Badge variant=\"outline\" className={getStatusColor(order.status)}>\r\n                      {getStatusLabel(order.status)}\r\n                    </Badge>\r\n                  </TableCell>\r\n                  <TableCell className=\"text-muted-foreground\">\r\n                    {formatDistanceToNow(new Date(order.created_at), { addSuffix: true, locale: dateLocale })}\r\n                  </TableCell>\r\n                </TableRow>\r\n              ))}\r\n            </TableBody>\r\n          </Table>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\products\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\products\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\sellers\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\sellers\\page.tsx","messages":[{"ruleId":"sonarjs/no-gratuitous-expressions","severity":1,"message":"This always evaluates to truthy. Consider refactoring this code.","line":66,"column":36,"nodeType":"Identifier","endLine":66,"endColumn":41},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getTierBadge' to the outer scope.","line":113,"column":46,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":113,"endColumn":48}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createAdminClient, createClient } from \"@/lib/supabase/server\"\r\nimport { formatDistanceToNow } from \"date-fns\"\r\nimport { bg, enUS } from \"date-fns/locale\"\r\nimport { getLocale, getTranslations } from \"next-intl/server\"\r\nimport { Suspense } from \"react\"\r\nimport { connection } from \"next/server\"\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport { IconCheck, IconX } from \"@tabler/icons-react\"\r\n\r\n// Define seller type to avoid 'any'\r\ninterface Seller {\r\n  id: string\r\n  store_name: string | null\r\n  description: string | null\r\n  verified: boolean | null\r\n  tier: string | null\r\n  is_verified_business: boolean | null\r\n  business_name: string | null\r\n  commission_rate: number | null\r\n  country_code: string | null\r\n  created_at: string\r\n  profiles: {\r\n    email: string | null\r\n    full_name: string | null\r\n  }\r\n}\r\n\r\nasync function getSellers(): Promise<Seller[]> {\r\n  const adminClient = createAdminClient()\r\n  \r\n  const { data: profiles, error } = await adminClient\r\n    .from('profiles')\r\n    .select(`\r\n      id,\r\n      username,\r\n      display_name,\r\n      bio,\r\n      verified,\r\n      tier,\r\n      is_verified_business,\r\n      business_name,\r\n      country_code,\r\n      created_at,\r\n      full_name\r\n    `)\r\n    .eq('is_seller', true)\r\n    .order('created_at', { ascending: false })\r\n  \r\n  if (error) {\r\n    const message =\r\n      typeof error === 'object' && error && 'message' in error\r\n        ? String((error as { message?: unknown }).message)\r\n        : ''\r\n\r\n    if (!message.includes('During prerendering, fetch() rejects when the prerender is complete')) {\r\n      console.error('Failed to fetch sellers:', error)\r\n    }\r\n    return []\r\n  }\r\n  \r\n  const ids = (profiles || []).map((p) => p.id)\r\n  const { data: privateProfiles } = ids.length\r\n    ? await adminClient\r\n        .from('private_profiles')\r\n        .select('id, email, commission_rate')\r\n        .in('id', ids)\r\n    : { data: [] }\r\n\r\n  const privateById = new Map((privateProfiles || []).map((p) => [p.id, p]))\r\n\r\n  // Map profiles to expected seller format\r\n  return (profiles || []).map(profile => ({\r\n    id: profile.id,\r\n    store_name: profile.display_name || profile.business_name || profile.username || null,\r\n    description: profile.bio,\r\n    verified: profile.verified,\r\n    tier: profile.tier,\r\n    is_verified_business: profile.is_verified_business,\r\n    business_name: profile.business_name,\r\n    commission_rate: privateById.get(profile.id)?.commission_rate ?? null,\r\n    country_code: profile.country_code,\r\n    created_at: profile.created_at,\r\n    profiles: {\r\n      email: privateById.get(profile.id)?.email ?? null,\r\n      full_name: profile.full_name,\r\n    }\r\n  }))\r\n}\r\n\r\nasync function AdminSellersContent() {\r\n  await (await createClient()).auth.getUser()\r\n\r\n  const sellers = await getSellers()\r\n  const t = await getTranslations(\"AdminSellers\")\r\n  const locale = await getLocale()\r\n  const dateLocale = locale === \"bg\" ? bg : enUS\r\n  \r\n  const getTierBadge = (tier: string | null) => {\r\n    switch (tier) {\r\n      case 'business':\r\n        return 'border-selected-border bg-selected text-primary'\r\n      case 'premium':\r\n        return 'border-warning/20 bg-warning/10 text-warning'\r\n      default:\r\n        return 'border-border bg-muted text-muted-foreground'\r\n    }\r\n  }\r\n\r\n  const getTierLabel = (tier: string | null) => {\r\n    switch (tier) {\r\n      case 'business':\r\n        return t('tiers.business')\r\n      case 'premium':\r\n        return t('tiers.premium')\r\n      default:\r\n        return t('tiers.basic')\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6 px-4 lg:px-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold tracking-tight\">{t('page.title')}</h1>\r\n          <p className=\"text-muted-foreground\">\r\n            {t('page.description')}\r\n          </p>\r\n        </div>\r\n        <Badge variant=\"outline\" className=\"text-base\">\r\n          {t('summary', { count: sellers.length })}\r\n        </Badge>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>{t('table.title')}</CardTitle>\r\n          <CardDescription>\r\n            {t('table.description')}\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <Table>\r\n            <TableHeader>\r\n              <TableRow>\r\n                <TableHead>{t('table.headers.store')}</TableHead>\r\n                <TableHead>{t('table.headers.owner')}</TableHead>\r\n                <TableHead>{t('table.headers.tier')}</TableHead>\r\n                <TableHead>{t('table.headers.verified')}</TableHead>\r\n                <TableHead>{t('table.headers.commission')}</TableHead>\r\n                <TableHead>{t('table.headers.country')}</TableHead>\r\n                <TableHead>{t('table.headers.joined')}</TableHead>\r\n              </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n              {sellers.map((seller) => (\r\n                <TableRow key={seller.id}>\r\n                  <TableCell>\r\n                    <div>\r\n                      <p className=\"font-medium\">{seller.store_name || t(\"fallbacks.unknownStore\")}</p>\r\n                      {seller.business_name && (\r\n                        <p className=\"text-sm text-muted-foreground\">\r\n                          {seller.business_name}\r\n                        </p>\r\n                      )}\r\n                    </div>\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    <div>\r\n                      <p className=\"font-medium\">\r\n                        {seller.profiles.full_name || t('fallbacks.noName')}\r\n                      </p>\r\n                      <p className=\"text-sm text-muted-foreground\">\r\n                        {seller.profiles.email}\r\n                      </p>\r\n                    </div>\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    <Badge variant=\"outline\" className={getTierBadge(seller.tier)}>\r\n                      {getTierLabel(seller.tier)}\r\n                    </Badge>\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    <div className=\"flex gap-2\">\r\n                      {seller.verified ? (\r\n                        <Badge variant=\"outline\" className=\"border-success/20 bg-success/10 text-success\">\r\n                          <IconCheck className=\"size-3 mr-1\" />\r\n                          {t('badges.verified')}\r\n                        </Badge>\r\n                      ) : (\r\n                        <Badge variant=\"outline\" className=\"border-border bg-muted text-muted-foreground\">\r\n                          <IconX className=\"size-3 mr-1\" />\r\n                          {t('badges.notVerified')}\r\n                        </Badge>\r\n                      )}\r\n                    </div>\r\n                  </TableCell>\r\n                  <TableCell className=\"tabular-nums\">\r\n                    {seller.commission_rate}%\r\n                  </TableCell>\r\n                  <TableCell className=\"text-muted-foreground\">\r\n                    {seller.country_code || t('fallbacks.country')}\r\n                  </TableCell>\r\n                  <TableCell className=\"text-muted-foreground\">\r\n                    {formatDistanceToNow(new Date(seller.created_at), { addSuffix: true, locale: dateLocale })}\r\n                  </TableCell>\r\n                </TableRow>\r\n              ))}\r\n            </TableBody>\r\n          </Table>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n\r\nasync function AdminSellersFallback() {\r\n  const t = await getTranslations(\"AdminSellers\")\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6 px-4 lg:px-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold tracking-tight\">{t(\"page.title\")}</h1>\r\n          <p className=\"text-muted-foreground\">{t(\"page.description\")}</p>\r\n        </div>\r\n        <Badge variant=\"outline\" className=\"text-base\">{t(\"loading\")}</Badge>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>{t(\"table.title\")}</CardTitle>\r\n          <CardDescription>{t(\"table.description\")}</CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"text-sm text-muted-foreground\">{t(\"loading\")}</div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default async function AdminSellersPage() {\r\n  await connection()\r\n\r\n  return (\r\n    <Suspense fallback={<AdminSellersFallback />}>\r\n      <AdminSellersContent />\r\n    </Suspense>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\tasks\\_components\\tasks-content.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'IconGripVertical' is defined but never used.","line":7,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":19,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"IconGripVertical"},"fix":{"range":[102,123],"text":""},"desc":"Remove unused variable \"IconGripVertical\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { useState } from \"react\"\r\nimport {\r\n  IconPlus,\r\n  IconGripVertical,\r\n  IconTrash,\r\n  IconEdit,\r\n  IconCalendar,\r\n} from \"@tabler/icons-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogFooter,\r\n} from \"@/components/ui/dialog\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport { toast } from \"sonner\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\ninterface AdminTask {\r\n  id: string\r\n  title: string\r\n  description: string | null\r\n  status: string\r\n  priority: string\r\n  due_date: string | null\r\n  assigned_to: string | null\r\n  created_by: string | null\r\n  created_at: string | null\r\n  updated_at: string | null\r\n}\r\n\r\nconst STATUS_COLUMNS = [\r\n  { id: \"todo\", labelKey: \"columns.todo\", color: \"bg-muted\" },\r\n  { id: \"in_progress\", labelKey: \"columns.in_progress\", color: \"bg-admin-in-progress-bg\" },\r\n  { id: \"review\", labelKey: \"columns.review\", color: \"bg-admin-review-bg\" },\r\n  { id: \"done\", labelKey: \"columns.done\", color: \"bg-admin-published-bg\" },\r\n]\r\n\r\nconst PRIORITY_COLORS: Record<string, string> = {\r\n  urgent: \"bg-admin-urgent text-badge-fg-on-solid\",\r\n  high: \"bg-admin-high text-badge-fg-on-solid\",\r\n  medium: \"bg-admin-medium text-foreground\",\r\n  low: \"bg-muted text-muted-foreground\",\r\n}\r\n\r\nconst PRIORITY_ORDER: Record<string, number> = {\r\n  urgent: 4,\r\n  high: 3,\r\n  medium: 2,\r\n  low: 1,\r\n}\r\n\r\nexport function AdminTasksContent({ initialTasks }: { initialTasks: AdminTask[] }) {\r\n  const t = useTranslations(\"AdminTasks\")\r\n  const [tasks, setTasks] = useState(initialTasks)\r\n  const [editingTask, setEditingTask] = useState<AdminTask | null>(null)\r\n  const [isDialogOpen, setIsDialogOpen] = useState(false)\r\n  \r\n  const supabase = createClient()\r\n\r\n  const columns = STATUS_COLUMNS.map((col) => ({\r\n    ...col,\r\n    label: t(col.labelKey),\r\n  }))\r\n\r\n  const tasksByStatus = columns.reduce((acc, col) => {\r\n    acc[col.id] = tasks\r\n      .filter((t) => t.status === col.id)\r\n      .sort((a, b) => (PRIORITY_ORDER[b.priority] ?? 0) - (PRIORITY_ORDER[a.priority] ?? 0))\r\n    return acc\r\n  }, {} as Record<string, AdminTask[]>)\r\n\r\n  const handleStatusChange = async (taskId: string, newStatus: string) => {\r\n    const { error } = await supabase\r\n      .from(\"admin_tasks\")\r\n      .update({ status: newStatus, updated_at: new Date().toISOString() })\r\n      .eq(\"id\", taskId)\r\n    \r\n    if (error) {\r\n      toast.error(t(\"toasts.updateFailed\"))\r\n      return\r\n    }\r\n    \r\n    setTasks(tasks.map((t) => (t.id === taskId ? { ...t, status: newStatus } : t)))\r\n  }\r\n\r\n  const handleSave = async (task: Partial<AdminTask> & { id?: string }) => {\r\n    if (task.id) {\r\n      // Update - build object conditionally to satisfy exactOptionalPropertyTypes\r\n      const updateData: Record<string, string | null> = {\r\n        updated_at: new Date().toISOString(),\r\n      }\r\n      if (task.title !== undefined) updateData.title = task.title\r\n      if (task.description !== undefined) updateData.description = task.description\r\n      if (task.priority !== undefined) updateData.priority = task.priority\r\n      if (task.due_date !== undefined) updateData.due_date = task.due_date\r\n      \r\n      const { error } = await supabase\r\n        .from(\"admin_tasks\")\r\n        .update(updateData)\r\n        .eq(\"id\", task.id)\r\n      \r\n      if (error) {\r\n        toast.error(t(\"toasts.updateFailed\"))\r\n        return\r\n      }\r\n      \r\n      setTasks(tasks.map((t) => (t.id === task.id ? { ...t, ...task } : t)))\r\n      toast.success(t(\"toasts.updated\"))\r\n    } else {\r\n      // Create\r\n      if (!task.title) {\r\n        toast.error(t(\"toasts.titleRequired\"))\r\n        return\r\n      }\r\n      const { data, error } = await supabase\r\n        .from(\"admin_tasks\")\r\n        .insert({\r\n          title: task.title,\r\n          description: task.description ?? null,\r\n          priority: task.priority || \"medium\",\r\n          status: \"todo\",\r\n          due_date: task.due_date ?? null,\r\n        })\r\n        .select(\"id, title, description, status, priority, due_date, assigned_to, created_by, created_at, updated_at\")\r\n        .single()\r\n      \r\n      if (error) {\r\n        toast.error(t(\"toasts.createFailed\"))\r\n        return\r\n      }\r\n      \r\n      if (data) {\r\n        setTasks([data, ...tasks])\r\n        toast.success(t(\"toasts.created\"))\r\n      }\r\n    }\r\n    \r\n    setIsDialogOpen(false)\r\n    setEditingTask(null)\r\n  }\r\n\r\n  const handleDelete = async (id: string) => {\r\n    const { error } = await supabase.from(\"admin_tasks\").delete().eq(\"id\", id)\r\n    \r\n    if (error) {\r\n      toast.error(t(\"toasts.deleteFailed\"))\r\n      return\r\n    }\r\n    \r\n    setTasks(tasks.filter((t) => t.id !== id))\r\n    toast.success(t(\"toasts.deleted\"))\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-4\">\r\n      <div className=\"flex justify-between items-center\">\r\n        <div className=\"text-sm text-muted-foreground\">\r\n          {t(\"summary\", {\r\n            total: tasks.length,\r\n            completed: tasks.filter((t) => t.status === \"done\").length,\r\n          })}\r\n        </div>\r\n        <Button onClick={() => { setEditingTask(null); setIsDialogOpen(true) }}>\r\n          <IconPlus className=\"size-4 mr-2\" />\r\n          {t(\"buttons.newTask\")}\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Kanban Board */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n        {columns.map((column) => (\r\n          <div key={column.id} className=\"space-y-2\">\r\n            <div className={cn(\"rounded-lg px-3 py-2 font-medium text-sm\", column.color)}>\r\n              {column.label}\r\n              <span className=\"ml-2 text-muted-foreground\">\r\n                ({tasksByStatus[column.id]?.length || 0})\r\n              </span>\r\n            </div>\r\n            <div className=\"space-y-2 min-h-52\">\r\n              {tasksByStatus[column.id]?.map((task) => (\r\n                <TaskCard\r\n                  key={task.id}\r\n                  task={task}\r\n                  statusOptions={columns}\r\n                  onStatusChange={handleStatusChange}\r\n                  onEdit={() => { setEditingTask(task); setIsDialogOpen(true) }}\r\n                  onDelete={() => {\r\n                    if (confirm(t(\"confirm.deleteTask\"))) {\r\n                      handleDelete(task.id)\r\n                    }\r\n                  }}\r\n                />\r\n              ))}\r\n            </div>\r\n          </div>\r\n        ))}\r\n      </div>\r\n\r\n      {/* Edit/Create Dialog */}\r\n      <TaskDialog\r\n        task={editingTask}\r\n        open={isDialogOpen}\r\n        onOpenChange={setIsDialogOpen}\r\n        onSave={handleSave}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction TaskCard({\r\n  task,\r\n  statusOptions,\r\n  onStatusChange,\r\n  onEdit,\r\n  onDelete,\r\n}: {\r\n  task: AdminTask\r\n  statusOptions: { id: string; label: string }[]\r\n  onStatusChange: (id: string, status: string) => void\r\n  onEdit: () => void\r\n  onDelete: () => void\r\n}) {\r\n  const t = useTranslations(\"AdminTasks\")\r\n\r\n  return (\r\n    <Card className=\"group\">\r\n      <CardHeader className=\"p-3 pb-0\">\r\n        <div className=\"flex items-start justify-between gap-2\">\r\n          <h4 className=\"font-medium text-sm leading-tight\">{task.title}</h4>\r\n          <Badge className={cn(\"text-xs shrink-0\", PRIORITY_COLORS[task.priority])}>\r\n            {t(`priority.${task.priority}`)}\r\n          </Badge>\r\n        </div>\r\n      </CardHeader>\r\n      <CardContent className=\"p-3 pt-2\">\r\n        {task.description && (\r\n          <p className=\"text-xs text-muted-foreground line-clamp-2 mb-2\">\r\n            {task.description}\r\n          </p>\r\n        )}\r\n        {task.due_date && (\r\n          <div className=\"flex items-center gap-1 text-xs text-muted-foreground mb-2\">\r\n            <IconCalendar className=\"size-3\" />\r\n            {new Date(task.due_date).toLocaleDateString()}\r\n          </div>\r\n        )}\r\n        <div className=\"flex items-center justify-between\">\r\n          <Select\r\n            value={task.status}\r\n            onValueChange={(value) => onStatusChange(task.id, value)}\r\n          >\r\n            <SelectTrigger className=\"h-7 text-xs w-auto\">\r\n              <SelectValue />\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              {statusOptions.map((col) => (\r\n                <SelectItem key={col.id} value={col.id}>\r\n                  {col.label}\r\n                </SelectItem>\r\n              ))}\r\n            </SelectContent>\r\n          </Select>\r\n          <div className=\"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n            <Button variant=\"ghost\" size=\"icon\" className=\"size-7\" onClick={onEdit}>\r\n              <IconEdit className=\"size-3.5\" />\r\n            </Button>\r\n            <Button variant=\"ghost\" size=\"icon\" className=\"size-7\" onClick={onDelete}>\r\n              <IconTrash className=\"size-3.5\" />\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n}\r\n\r\nfunction TaskDialog({\r\n  task,\r\n  open,\r\n  onOpenChange,\r\n  onSave,\r\n}: {\r\n  task: AdminTask | null\r\n  open: boolean\r\n  onOpenChange: (open: boolean) => void\r\n  onSave: (task: Partial<AdminTask> & { id?: string }) => void\r\n}) {\r\n  const [title, setTitle] = useState(task?.title || \"\")\r\n  const [description, setDescription] = useState(task?.description || \"\")\r\n  const [priority, setPriority] = useState(task?.priority || \"medium\")\r\n  const [dueDate, setDueDate] = useState(task?.due_date || \"\")\r\n  const t = useTranslations(\"AdminTasks\")\r\n\r\n  React.useEffect(() => {\r\n    if (open) {\r\n      setTitle(task?.title || \"\")\r\n      setDescription(task?.description || \"\")\r\n      setPriority(task?.priority || \"medium\")\r\n      setDueDate(task?.due_date || \"\")\r\n    }\r\n  }, [open, task])\r\n\r\n  const handleSubmit = () => {\r\n    if (!title.trim()) {\r\n      toast.error(t(\"toasts.titleRequired\"))\r\n      return\r\n    }\r\n    onSave({\r\n      ...(task?.id ? { id: task.id } : {}),\r\n      title,\r\n      description: description || null,\r\n      priority,\r\n      due_date: dueDate || null,\r\n    })\r\n  }\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent>\r\n        <DialogHeader>\r\n          <DialogTitle>{task ? t(\"dialog.titleEdit\") : t(\"dialog.titleNew\")}</DialogTitle>\r\n        </DialogHeader>\r\n        <div className=\"space-y-4\">\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"title\">{t(\"labels.title\")}</Label>\r\n            <Input\r\n              id=\"title\"\r\n              value={title}\r\n              onChange={(e) => setTitle(e.target.value)}\r\n              placeholder={t(\"placeholders.title\")}\r\n            />\r\n          </div>\r\n          \r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"description\">{t(\"labels.description\")}</Label>\r\n            <Textarea\r\n              id=\"description\"\r\n              value={description}\r\n              onChange={(e) => setDescription(e.target.value)}\r\n              placeholder={t(\"placeholders.description\")}\r\n              rows={3}\r\n            />\r\n          </div>\r\n          \r\n          <div className=\"grid grid-cols-2 gap-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label>{t(\"labels.priority\")}</Label>\r\n              <Select value={priority} onValueChange={setPriority}>\r\n                <SelectTrigger>\r\n                  <SelectValue />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"urgent\">{t(\"priority.urgent\")}</SelectItem>\r\n                  <SelectItem value=\"high\">{t(\"priority.high\")}</SelectItem>\r\n                  <SelectItem value=\"medium\">{t(\"priority.medium\")}</SelectItem>\r\n                  <SelectItem value=\"low\">{t(\"priority.low\")}</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n            \r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"due_date\">{t(\"labels.dueDate\")}</Label>\r\n              <Input\r\n                id=\"due_date\"\r\n                type=\"date\"\r\n                value={dueDate}\r\n                onChange={(e) => setDueDate(e.target.value)}\r\n              />\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <DialogFooter>\r\n          <Button variant=\"outline\" onClick={() => onOpenChange(false)}>\r\n            {t(\"buttons.cancel\")}\r\n          </Button>\r\n          <Button onClick={handleSubmit}>\r\n            {task ? t(\"buttons.saveChanges\") : t(\"buttons.createTask\")}\r\n          </Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\tasks\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\users\\loading.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":2,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardHeader"},"fix":{"range":[79,91],"text":""},"desc":"Remove unused variable \"CardHeader\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Skeleton } from \"@/components/ui/skeleton\"\r\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\"\r\n\r\nexport default function AdminUsersLoading() {\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6\">\r\n      {/* Header */}\r\n      <div className=\"px-4 lg:px-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n        <div className=\"space-y-2\">\r\n          <Skeleton className=\"h-8 w-24\" />\r\n          <Skeleton className=\"h-4 w-48\" />\r\n        </div>\r\n        <Skeleton className=\"h-9 w-28\" />\r\n      </div>\r\n\r\n      {/* Stats */}\r\n      <div className=\"grid gap-4 px-4 lg:px-6 sm:grid-cols-4\">\r\n        {[1, 2, 3, 4].map((i) => (\r\n          <Card key={i}>\r\n            <CardContent className=\"p-4\">\r\n              <Skeleton className=\"h-4 w-24 mb-2\" />\r\n              <Skeleton className=\"h-7 w-12\" />\r\n            </CardContent>\r\n          </Card>\r\n        ))}\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <div className=\"px-4 lg:px-6 flex flex-col sm:flex-row gap-3\">\r\n        <Skeleton className=\"h-10 flex-1\" />\r\n        <div className=\"flex gap-2\">\r\n          <Skeleton className=\"h-10 w-28\" />\r\n          <Skeleton className=\"h-10 w-28\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Users Table */}\r\n      <div className=\"px-4 lg:px-6\">\r\n        <Card>\r\n          <CardContent className=\"p-0\">\r\n            <div className=\"grid grid-cols-6 gap-4 p-4 border-b bg-surface-subtle\">\r\n              <Skeleton className=\"h-4 w-16 col-span-2\" />\r\n              <Skeleton className=\"h-4 w-16\" />\r\n              <Skeleton className=\"h-4 w-16\" />\r\n              <Skeleton className=\"h-4 w-16\" />\r\n              <Skeleton className=\"h-4 w-16\" />\r\n            </div>\r\n            {[1, 2, 3, 4, 5, 6, 7, 8].map((i) => (\r\n              <div key={i} className=\"grid grid-cols-6 gap-4 p-4 border-b last:border-0 items-center\">\r\n                <div className=\"col-span-2 flex items-center gap-3\">\r\n                  <Skeleton className=\"size-10 rounded-full\" />\r\n                  <div className=\"space-y-1\">\r\n                    <Skeleton className=\"h-4 w-32\" />\r\n                    <Skeleton className=\"h-3 w-40\" />\r\n                  </div>\r\n                </div>\r\n                <Skeleton className=\"h-5 w-16 rounded-full\" />\r\n                <Skeleton className=\"h-4 w-24\" />\r\n                <Skeleton className=\"h-5 w-16 rounded-full\" />\r\n                <Skeleton className=\"h-8 w-8 rounded\" />\r\n              </div>\r\n            ))}\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Pagination */}\r\n      <div className=\"px-4 lg:px-6 flex justify-center gap-2\">\r\n        <Skeleton className=\"h-9 w-9 rounded\" />\r\n        <Skeleton className=\"h-9 w-9 rounded\" />\r\n        <Skeleton className=\"h-9 w-9 rounded\" />\r\n        <Skeleton className=\"h-9 w-9 rounded\" />\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(admin)\\admin\\users\\page.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getRoleBadge' to the outer scope.","line":57,"column":46,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":57,"endColumn":48}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createAdminClient, createClient } from \"@/lib/supabase/server\"\r\nimport { getTranslations } from \"next-intl/server\"\r\nimport { formatDistanceToNow } from \"date-fns\"\r\nimport { bg, enUS } from \"date-fns/locale\"\r\nimport { getLocale } from \"next-intl/server\"\r\nimport { Suspense } from \"react\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\"\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\"\r\n\r\nasync function getUsers() {\r\n  const adminClient = createAdminClient()\r\n\r\n  const { data: users, error } = await adminClient\r\n    .from(\"profiles\")\r\n    .select(\"id, full_name, role, created_at\")\r\n    .order(\"created_at\", { ascending: false })\r\n    .limit(100)\r\n\r\n  if (error) {\r\n    if (!error.message.includes(\"During prerendering, fetch() rejects when the prerender is complete\")) {\r\n      console.error(\"Failed to fetch users:\", error.message)\r\n    }\r\n    return []\r\n  }\r\n\r\n  const ids = (users || []).map((u) => u.id).filter(Boolean)\r\n\r\n  const { data: privateProfiles } = ids.length\r\n    ? await adminClient\r\n        .from(\"private_profiles\")\r\n        .select(\"id, email, phone\")\r\n        .in(\"id\", ids)\r\n    : { data: [] as Array<{ id: string; email: string | null; phone: string | null }> }\r\n\r\n  const privateById = new Map((privateProfiles || []).map((p) => [p.id, p]))\r\n\r\n  return (users || []).map((u) => {\r\n    const priv = privateById.get(u.id)\r\n    return {\r\n      ...u,\r\n      email: priv?.email ?? null,\r\n      phone: priv?.phone ?? null,\r\n    }\r\n  })\r\n}\r\n\r\nasync function AdminUsersContent() {\r\n  await (await createClient()).auth.getUser()\r\n\r\n  const users = await getUsers()\r\n  const t = await getTranslations(\"AdminUsers\")\r\n  const locale = await getLocale()\r\n  const dateLocale = locale === \"bg\" ? bg : enUS\r\n\r\n  const getRoleBadge = (role: string | null) => {\r\n    switch (role) {\r\n      case \"admin\":\r\n        return \"border-foreground/20 bg-foreground/10 text-foreground\"\r\n      case \"seller\":\r\n        return \"border-selected-border bg-selected text-primary\"\r\n      default:\r\n        return \"border-border bg-muted text-muted-foreground\"\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6 px-4 lg:px-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold tracking-tight\">{t(\"page.title\")}</h1>\r\n          <p className=\"text-muted-foreground\">{t(\"page.description\")}</p>\r\n        </div>\r\n        <Badge variant=\"outline\" className=\"text-base\">\r\n          {t(\"summary\", { count: users.length })}\r\n        </Badge>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>{t(\"table.title\")}</CardTitle>\r\n          <CardDescription>{t(\"table.description\")}</CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <Table>\r\n            <TableHeader>\r\n              <TableRow>\r\n                <TableHead>{t(\"table.headers.user\")}</TableHead>\r\n                <TableHead>{t(\"table.headers.role\")}</TableHead>\r\n                <TableHead>{t(\"table.headers.phone\")}</TableHead>\r\n                <TableHead>{t(\"table.headers.joined\")}</TableHead>\r\n              </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n              {users.map((user) => (\r\n                <TableRow key={user.id}>\r\n                  <TableCell>\r\n                    <div className=\"flex items-center gap-3\">\r\n                      <Avatar className=\"size-8\">\r\n                        <AvatarFallback className=\"text-xs\">\r\n                          {(user.email || t(\"fallbacks.unknown\")).slice(0, 2).toUpperCase()}\r\n                        </AvatarFallback>\r\n                      </Avatar>\r\n                      <div>\r\n                        <p className=\"font-medium\">{user.full_name || t(\"fallbacks.noName\")}</p>\r\n                        <p className=\"text-sm text-muted-foreground\">{user.email}</p>\r\n                      </div>\r\n                    </div>\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    <Badge variant=\"outline\" className={getRoleBadge(user.role)}>\r\n                      {t(`roles.${user.role || \"buyer\"}`)}\r\n                    </Badge>\r\n                  </TableCell>\r\n                  <TableCell className=\"text-muted-foreground\">{user.phone || t(\"fallbacks.noPhone\")}</TableCell>\r\n                  <TableCell className=\"text-muted-foreground\">\r\n                    {formatDistanceToNow(new Date(user.created_at), { addSuffix: true, locale: dateLocale })}\r\n                  </TableCell>\r\n                </TableRow>\r\n              ))}\r\n            </TableBody>\r\n          </Table>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n\r\nasync function AdminUsersFallback() {\r\n  const t = await getTranslations(\"AdminUsers\")\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6 px-4 lg:px-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold tracking-tight\">{t(\"page.title\")}</h1>\r\n          <p className=\"text-muted-foreground\">{t(\"page.description\")}</p>\r\n        </div>\r\n        <Badge variant=\"outline\" className=\"text-base\">{t(\"loading\")}</Badge>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>{t(\"table.title\")}</CardTitle>\r\n          <CardDescription>{t(\"table.description\")}</CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"text-sm text-muted-foreground\">{t(\"loading\")}</div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n\r\nexport default async function AdminUsersPage() {\r\n  const { connection } = await import(\"next/server\")\r\n  // Mark route as dynamic - admin routes need auth\r\n  await connection()\r\n  \r\n  return (\r\n    <Suspense fallback={<AdminUsersFallback />}>\r\n      <AdminUsersContent />\r\n    </Suspense>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\_actions\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\_components\\forgot-password-form.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Envelope' is defined but never used.","line":4,"column":28,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":36,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Envelope"},"fix":{"range":[81,91],"text":""},"desc":"Remove unused variable \"Envelope\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":11,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Button"},"fix":{"range":[427,474],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useActionState } from \"react\"\r\nimport { ArrowLeft, Check, Envelope } from \"@phosphor-icons/react\"\r\nimport { useTranslations } from \"next-intl\"\r\n\r\nimport { AuthCard } from \"@/components/auth/auth-card\"\r\nimport { SubmitButton } from \"@/components/auth/submit-button\"\r\nimport { Field, FieldContent, FieldError, FieldLabel } from \"@/components/shared/field\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\ntype AuthActionState = {\r\n  error?: string\r\n  fieldErrors?: Record<string, string>\r\n  success?: boolean\r\n}\r\n\r\ntype RequestPasswordResetAction = (locale: string, prevState: AuthActionState, formData: FormData) => Promise<AuthActionState>\r\n\r\nexport function ForgotPasswordForm({\r\n  locale,\r\n  requestPasswordResetAction,\r\n}: {\r\n  locale: string\r\n  requestPasswordResetAction: RequestPasswordResetAction\r\n}) {\r\n  const t = useTranslations(\"Auth\")\r\n  const initialState: AuthActionState = { fieldErrors: {}, success: false }\r\n  const [state, formAction] = useActionState(requestPasswordResetAction.bind(null, locale), initialState)\r\n\r\n  if (state?.success) {\n    return (\n      <div className=\"min-h-dvh flex items-center justify-center p-4\">\n        <div className=\"w-full max-w-sm text-center\">\n          <div className=\"flex flex-col items-center gap-4 mb-6\">\n            <div className=\"size-16 bg-primary-subtle rounded-full flex items-center justify-center\">\n              <Check className=\"size-8 text-primary\" weight=\"bold\" />\n            </div>\n            <h1 className=\"text-2xl font-bold text-foreground\">{t(\"checkYourEmailTitle\")}</h1>\n            <p className=\"text-sm text-muted-foreground\">\n              {t(\"resetLinkSent\")}\n            </p>\n          </div>\r\n          <Link href=\"/auth/login\" className=\"inline-flex items-center gap-2 text-sm text-primary hover:underline\">\r\n            <ArrowLeft className=\"size-4\" />\r\n            {t(\"backToLogin\")}\r\n          </Link>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const footer = (\r\n    <Link href=\"/auth/login\" className=\"inline-flex items-center gap-2 text-sm text-primary hover:underline\">\r\n      <ArrowLeft className=\"size-4\" />\r\n      {t(\"backToLogin\")}\r\n    </Link>\r\n  )\r\n\r\n  return (\r\n    <AuthCard\r\n      title={t(\"forgotPasswordTitle\")}\r\n      description={t(\"forgotPasswordDescription\")}\r\n      footer={footer}\r\n      showLogo={true}\r\n    >\r\n      <form action={formAction} className=\"space-y-4\">\n        {state?.error && (\n          <div className=\"rounded-xl border border-destructive bg-destructive-subtle p-3 text-sm text-destructive\">\n            {t(state.error as never)}\n          </div>\n        )}\n\r\n        <Field data-invalid={!!state?.fieldErrors?.email}>\r\n          <FieldContent>\r\n            <FieldLabel htmlFor=\"email\">{t(\"emailAddress\")}</FieldLabel>\r\n            <Input\r\n              id=\"email\"\r\n              name=\"email\"\r\n              type=\"email\"\r\n              autoComplete=\"email\"\r\n              required\r\n              placeholder={t(\"emailPlaceholder\")}\r\n              aria-invalid={!!state?.fieldErrors?.email}\r\n              aria-describedby={state?.fieldErrors?.email ? \"email-error\" : undefined}\n              className={cn(\n                state?.fieldErrors?.email &&\n                  \"border-destructive\",\n              )}\n            />\n            <FieldError id=\"email-error\">\n              {state?.fieldErrors?.email ? t(state.fieldErrors.email as never) : null}\n            </FieldError>\n          </FieldContent>\n        </Field>\n\r\n        <SubmitButton label={t(\"sendResetLink\")} pendingLabel={t(\"sending\")} />\r\n      </form>\r\n    </AuthCard>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\_components\\login-form.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\_components\\sign-up-form.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\_components\\welcome-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\auth\\error\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\auth\\forgot-password\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\auth\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\auth\\login\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\auth\\reset-password\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\auth\\reset-password\\reset-password-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\auth\\sign-up-success\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\auth\\sign-up-success\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\auth\\sign-up-success\\sign-up-success-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\auth\\sign-up\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\auth\\welcome\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(auth)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\business-activity-feed.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'formatCurrency' to the outer scope.","line":58,"column":42,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":58,"endColumn":44},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'transformToActivityItems' is defined but never used.","line":191,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":191,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { formatDistanceToNow } from \"date-fns\"\r\nimport {\r\n  IconShoppingCart,\r\n  IconBox,\r\n  IconUser,\r\n  IconStar,\r\n  IconArrowRight,\r\n  IconCheck,\r\n} from \"@tabler/icons-react\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\ntype ActivityType = \"order\" | \"product\" | \"review\" | \"customer\" | \"milestone\"\r\n\r\ninterface ActivityItem {\r\n  id: string\r\n  type: ActivityType\r\n  title: string\r\n  description: string\r\n  timestamp: string\r\n  href?: string\r\n  meta?: {\r\n    amount?: number\r\n    status?: string\r\n    image?: string\r\n    rating?: number\r\n  }\r\n}\r\n\r\ninterface BusinessActivityFeedProps {\r\n  activities: ActivityItem[]\r\n  className?: string\r\n}\r\n\r\nconst activityIcons: Record<ActivityType, React.ElementType> = {\r\n  order: IconShoppingCart,\r\n  product: IconBox,\r\n  review: IconStar,\r\n  customer: IconUser,\r\n  milestone: IconCheck,\r\n}\r\n\r\nconst activityColors: Record<ActivityType, string> = {\r\n  order: \"bg-info/10 text-info\",\r\n  product: \"bg-selected text-primary\",\r\n  review: \"bg-warning/10 text-warning\",\r\n  customer: \"bg-success/10 text-success\",\r\n  milestone: \"bg-selected text-primary\",\r\n}\r\n\r\nexport function BusinessActivityFeed({ activities, className }: BusinessActivityFeedProps) {\r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat('en-US', {\r\n      style: 'currency',\r\n      currency: 'BGN',\r\n      maximumFractionDigits: 2,\r\n    }).format(value)\r\n  }\r\n\r\n  if (activities.length === 0) {\r\n    return (\r\n      <Card className={className}>\r\n        <CardHeader className=\"pb-3\">\r\n          <CardTitle className=\"text-base\">Recent Activity</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex flex-col items-center justify-center py-8 text-center\">\r\n            <div className=\"flex size-10 items-center justify-center rounded-full bg-muted mb-2\">\r\n              <IconShoppingCart className=\"size-5 text-muted-foreground\" />\r\n            </div>\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              No recent activity yet\r\n            </p>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <Card className={className}>\r\n      <CardHeader className=\"pb-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <CardTitle className=\"text-base\">Recent Activity</CardTitle>\r\n          <Button variant=\"ghost\" size=\"sm\" asChild>\r\n            <Link href=\"/dashboard/analytics\">\r\n              View all\r\n              <IconArrowRight className=\"ml-1 size-3\" />\r\n            </Link>\r\n          </Button>\r\n        </div>\r\n      </CardHeader>\r\n      <CardContent className=\"p-0\">\r\n        <ScrollArea className=\"h-80\">\r\n          <div className=\"space-y-0\">\r\n            {activities.map((activity, index) => {\r\n              const Icon = activityIcons[activity.type]\r\n              const iconColor = activityColors[activity.type]\r\n\r\n              return (\r\n                <div\r\n                  key={activity.id}\r\n                  className={cn(\r\n                    \"flex items-start gap-3 px-6 py-3 hover:bg-hover active:bg-active transition-colors\",\r\n                    index !== activities.length - 1 && \"border-b\"\r\n                  )}\r\n                >\r\n                  {/* Icon */}\r\n                  <div className={cn(\r\n                    \"flex size-8 items-center justify-center rounded-full shrink-0 mt-0.5\",\r\n                    iconColor\r\n                  )}>\r\n                    <Icon className=\"size-4\" />\r\n                  </div>\r\n\r\n                  {/* Content */}\r\n                  <div className=\"flex-1 min-w-0 space-y-1\">\r\n                    <div className=\"flex items-start justify-between gap-2\">\r\n                      <div>\r\n                        <p className=\"text-sm font-medium leading-tight\">\r\n                          {activity.title}\r\n                        </p>\r\n                        <p className=\"text-xs text-muted-foreground\">\r\n                          {activity.description}\r\n                        </p>\r\n                      </div>\r\n                      {activity.meta?.amount && (\r\n                        <span className=\"text-sm font-semibold tabular-nums text-success shrink-0\">\r\n                          +{formatCurrency(activity.meta.amount)}\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n\r\n                    {/* Meta info */}\r\n                    <div className=\"flex items-center gap-2 flex-wrap\">\r\n                      {activity.meta?.status && (\r\n                        <Badge variant=\"outline\" className=\"text-2xs h-5 px-1.5\">\r\n                          {activity.meta.status}\r\n                        </Badge>\r\n                      )}\r\n                      {(() => {\r\n                        const rating = activity.meta?.rating\r\n                        if (typeof rating !== \"number\") return null\r\n\r\n                        return (\r\n                          <div className=\"flex items-center gap-0.5 text-rating\">\r\n                            {Array.from({ length: 5 }).map((_, i) => (\r\n                              <IconStar\r\n                                key={i}\r\n                                className={cn(\r\n                                  \"size-3\",\r\n                                  i < rating ? \"fill-current\" : \"opacity-30\"\r\n                                )}\r\n                              />\r\n                            ))}\r\n                          </div>\r\n                        )\r\n                      })()}\r\n                      <span className=\"text-2xs text-muted-foreground\">\r\n                        {formatDistanceToNow(new Date(activity.timestamp), { addSuffix: true })}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {/* Thumbnail if available */}\r\n                  {activity.meta?.image && (\r\n                    <Avatar className=\"size-10 rounded-md shrink-0\">\r\n                      <AvatarImage src={activity.meta.image} className=\"object-cover\" />\r\n                      <AvatarFallback className=\"rounded-md\">\r\n                        <IconBox className=\"size-4\" />\r\n                      </AvatarFallback>\r\n                    </Avatar>\r\n                  )}\r\n                </div>\r\n              )\r\n            })}\r\n          </div>\r\n        </ScrollArea>\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n}\r\n\r\n// Helper function to transform orders/products into activity items\r\nfunction transformToActivityItems(\r\n  orders: Array<{\r\n    id: string\r\n    created_at: string\r\n    quantity: number\r\n    price_at_time: number\r\n    product?: { title: string; images?: string[] | null } | { title: string; images?: string[] | null }[] | null\r\n  }>,\r\n  products: Array<{\r\n    id: string\r\n    title: string\r\n    created_at: string\r\n    images?: string[] | null\r\n    status?: string | null\r\n  }>\r\n): ActivityItem[] {\r\n  const activities: ActivityItem[] = []\r\n\r\n  // Transform orders\r\n  for (const order of orders) {\r\n    const product = Array.isArray(order.product) ? order.product[0] : order.product\r\n    activities.push({\r\n      id: `order-${order.id}`,\r\n      type: \"order\",\r\n      title: \"New order received\",\r\n      description: product?.title || \"Order item\",\r\n      timestamp: order.created_at,\r\n      href: `/dashboard/orders/${order.id}`,\r\n      meta: {\r\n        amount: Number(order.price_at_time) * order.quantity,\r\n        status: \"Unfulfilled\",\r\n        ...(product?.images?.[0] ? { image: product.images[0] } : {}),\r\n      },\r\n    })\r\n  }\r\n\r\n  // Transform products\r\n  for (const product of products) {\r\n    activities.push({\r\n      id: `product-${product.id}`,\r\n      type: \"product\",\r\n      title: \"Product listed\",\r\n      description: product.title,\r\n      timestamp: product.created_at,\r\n      href: `/dashboard/products/${product.id}`,\r\n      meta: {\r\n        status: product.status || \"Active\",\r\n        ...(product.images?.[0] ? { image: product.images[0] } : {}),\r\n      },\r\n    })\r\n  }\r\n\r\n  // Sort by timestamp (newest first)\r\n  activities.sort((a, b) =>\r\n    new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()\r\n  )\r\n\r\n  return activities.slice(0, 10)\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\business-command-palette.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\business-empty-state.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\business-header.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_subscriptionTier' is assigned a value but never used.","line":27,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":38}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { usePathname } from \"@/i18n/routing\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport { SidebarTrigger } from \"@/components/layout/sidebar/sidebar\"\r\nimport { Badge } from \"@/components/ui/badge\"\nimport { BusinessCommandPalette } from \"./business-command-palette\"\nimport { BusinessNotifications } from \"./business-notifications\"\nimport { BUSINESS_PAGE_TITLES, type BusinessRoute } from \"../dashboard/_lib/routes\"\nimport {\r\n  IconPlus,\r\n  IconExternalLink,\r\n} from \"@tabler/icons-react\"\r\n\r\ninterface BusinessHeaderProps {\r\n  storeName?: string\r\n  isVerified?: boolean\r\n  subscriptionTier?: string\r\n  hasDashboardAccess?: boolean\r\n}\r\n\r\nexport function BusinessHeader({\n  storeName,\r\n  isVerified,\r\n  subscriptionTier: _subscriptionTier = 'free',\r\n  hasDashboardAccess = false\r\n}: BusinessHeaderProps) {\r\n  const pathname = usePathname()\r\n\r\n  const normalizedPath = pathname || \"/dashboard\"\r\n\r\n  // Get page title based on current route\r\n  const getPageTitle = () => {\r\n    // Check for exact match first\r\n    if (normalizedPath in BUSINESS_PAGE_TITLES) {\n      return BUSINESS_PAGE_TITLES[normalizedPath as BusinessRoute]\n    }\n    // Check for partial match (e.g., /dashboard/orders/123)\n    for (const [route, title] of Object.entries(BUSINESS_PAGE_TITLES)) {\n      if (normalizedPath.startsWith(route) && route !== \"/dashboard\") {\n        return title\n      }\r\n    }\r\n    return BUSINESS_PAGE_TITLES[\"/dashboard\"]\n  }\n\r\n  return (\r\n    <header className=\"flex h-(--header-height) shrink-0 items-center gap-2 border-b transition-[width,height] ease-linear group-has-data-[collapsible=icon]/sidebar-wrapper:h-(--header-height)\">\r\n      <div className=\"flex w-full items-center gap-2 px-4 lg:gap-3 lg:px-6\">\r\n        <SidebarTrigger className=\"-ml-1\" />\r\n        <Separator\r\n          orientation=\"vertical\"\r\n          className=\"mx-1 data-[orientation=vertical]:h-4\"\r\n        />\r\n\r\n        {/* Page Title */}\r\n        <div className=\"flex items-center gap-2\">\r\n          <h1 className=\"text-base font-semibold\">{getPageTitle()}</h1>\r\n          {isVerified && normalizedPath === '/dashboard' && (\r\n            <Badge variant=\"outline\" className=\"text-2xs h-5 bg-success/10 text-success border-success/30\">\r\n              Verified\r\n            </Badge>\r\n          )}\r\n          {!hasDashboardAccess && (\r\n            <Link href=\"/dashboard/upgrade\">\r\n              <Badge\r\n                variant=\"outline\"\r\n                className=\"text-2xs h-5 bg-warning/10 text-warning border-warning/30 hover:bg-warning/20 cursor-pointer\"\r\n              >\r\n                Upgrade to unlock\r\n              </Badge>\r\n            </Link>\r\n          )}\r\n        </div>\r\n\r\n        {/* Command Palette Search - Shopify Style */}\r\n        <div className=\"hidden md:flex flex-1 max-w-md mx-auto justify-center\">\r\n          <BusinessCommandPalette {...(storeName ? { storeName } : {})} />\r\n        </div>\r\n\r\n        {/* Right Actions */}\r\n        <div className=\"ml-auto flex items-center gap-1\">\r\n          {/* Add Product - Primary Action */}\r\n          <Button\r\n            variant=\"default\"\r\n            size=\"sm\"\r\n            asChild\r\n            className=\"hidden sm:flex h-8 px-3\"\r\n          >\r\n            <Link href=\"/dashboard/products?add=true\">\r\n              <IconPlus className=\"size-4 mr-1\" />\r\n              Add product\r\n            </Link>\r\n          </Button>\r\n\r\n          {/* View Store */}\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            asChild\r\n            className=\"hidden sm:flex h-8 text-muted-foreground hover:text-foreground\"\r\n          >\r\n            <a href=\"/\" target=\"_blank\" rel=\"noopener noreferrer\">\r\n              <IconExternalLink className=\"size-4 mr-1\" />\r\n              View store\r\n            </a>\r\n          </Button>\r\n\r\n          {/* Notifications */}\r\n          <BusinessNotifications />\r\n        </div>\r\n      </div>\r\n    </header>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\business-live-activity.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\business-notifications.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\business-performance-score.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'calculatePerformanceScore' is defined but never used.","line":217,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":217,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport {\r\n  IconTrendingUp,\r\n  IconTrendingDown,\r\n  IconMinus,\r\n  IconChartBar,\r\n  IconArrowRight,\r\n  IconInfoCircle,\r\n} from \"@tabler/icons-react\"\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\"\r\nimport { Progress } from \"@/components/ui/progress\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from \"@/components/ui/tooltip\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\ninterface PerformanceMetric {\r\n  id: string\r\n  label: string\r\n  value: number\r\n  target: number\r\n  unit?: string\r\n  trend?: \"up\" | \"down\" | \"neutral\"\r\n  trendValue?: number\r\n  description?: string\r\n}\r\n\r\ninterface BusinessPerformanceScoreProps {\r\n  overallScore: number\r\n  metrics: PerformanceMetric[]\r\n  className?: string\r\n}\r\n\r\nconst getTrendIcon = (trend?: \"up\" | \"down\" | \"neutral\") => {\r\n  switch (trend) {\r\n    case \"up\":\r\n      return IconTrendingUp\r\n    case \"down\":\r\n      return IconTrendingDown\r\n    default:\r\n      return IconMinus\r\n  }\r\n}\r\n\r\nconst getTrendColor = (trend?: \"up\" | \"down\" | \"neutral\") => {\r\n  switch (trend) {\r\n    case \"up\":\r\n      return \"text-success\"\r\n    case \"down\":\r\n      return \"text-destructive\"\r\n    default:\r\n      return \"text-muted-foreground\"\r\n  }\r\n}\r\n\r\nconst getScoreColor = (score: number) => {\r\n  if (score >= 80) return \"text-success\"\r\n  if (score >= 60) return \"text-warning\"\r\n  return \"text-destructive\"\r\n}\r\n\r\nconst getScoreLabel = (score: number) => {\r\n  if (score >= 90) return \"Excellent\"\r\n  if (score >= 80) return \"Great\"\r\n  if (score >= 70) return \"Good\"\r\n  if (score >= 60) return \"Fair\"\r\n  return \"Needs Work\"\r\n}\r\n\r\nexport function BusinessPerformanceScore({\r\n  overallScore,\r\n  metrics,\r\n  className,\r\n}: BusinessPerformanceScoreProps) {\r\n  return (\r\n    <Card className={className}>\r\n      <CardHeader className=\"pb-3\">\r\n        <div className=\"flex items-start justify-between\">\r\n          <div>\r\n            <CardTitle className=\"text-base flex items-center gap-2\">\r\n              <IconChartBar className=\"size-4\" />\r\n              Store Performance\r\n            </CardTitle>\r\n            <CardDescription className=\"mt-0.5\">\r\n              How your store is performing\r\n            </CardDescription>\r\n          </div>\r\n          <Button variant=\"ghost\" size=\"sm\" asChild>\r\n            <Link href=\"/dashboard/analytics\">\r\n              Details\r\n              <IconArrowRight className=\"ml-1 size-3\" />\r\n            </Link>\r\n          </Button>\r\n        </div>\r\n      </CardHeader>\r\n      <CardContent>\r\n        {/* Overall Score Circle */}\r\n        <div className=\"flex items-center gap-4 mb-6\">\r\n          <div className=\"relative\">\r\n            <svg className=\"size-24 -rotate-90\" viewBox=\"0 0 100 100\">\r\n              <circle\r\n                cx=\"50\"\r\n                cy=\"50\"\r\n                r=\"42\"\r\n                stroke=\"currentColor\"\r\n                strokeWidth=\"8\"\r\n                fill=\"none\"\r\n                className=\"text-muted\"\r\n              />\r\n              <circle\r\n                cx=\"50\"\r\n                cy=\"50\"\r\n                r=\"42\"\r\n                stroke=\"currentColor\"\r\n                strokeWidth=\"8\"\r\n                fill=\"none\"\r\n                strokeDasharray={`${overallScore * 2.64} 264`}\r\n                strokeLinecap=\"round\"\r\n                className={getScoreColor(overallScore)}\r\n              />\r\n            </svg>\r\n            <div className=\"absolute inset-0 flex flex-col items-center justify-center\">\r\n              <span className={cn(\"text-2xl font-bold\", getScoreColor(overallScore))}>\r\n                {overallScore}\r\n              </span>\r\n              <span className=\"text-2xs text-muted-foreground uppercase\">\r\n                Score\r\n              </span>\r\n            </div>\r\n          </div>\r\n          <div>\r\n            <Badge\r\n              variant=\"outline\"\r\n              className={cn(\r\n                \"mb-1\",\r\n                overallScore >= 80\r\n                  ? \"bg-success/10 text-success border-success/20\"\r\n                  : overallScore >= 60\r\n                    ? \"bg-warning/10 text-warning border-warning/20\"\r\n                    : \"bg-destructive-subtle text-destructive border-destructive/20\"\n              )}\r\n            >\r\n              {getScoreLabel(overallScore)}\r\n            </Badge>\r\n            <p className=\"text-sm text-muted-foreground max-w-44\">\r\n              {overallScore >= 80\r\n                ? \"Your store is performing well! Keep it up.\"\r\n                : overallScore >= 60\r\n                  ? \"Your store is doing okay. Room for improvement.\"\r\n                  : \"Focus on improving these metrics.\"\r\n              }\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Individual Metrics */}\r\n        <div className=\"space-y-4\">\r\n          {metrics.map((metric) => {\r\n            const progress = Math.min((metric.value / metric.target) * 100, 100)\r\n            const TrendIcon = getTrendIcon(metric.trend)\r\n\r\n            return (\r\n              <div key={metric.id} className=\"space-y-1.5\">\r\n                <div className=\"flex items-center justify-between text-sm\">\r\n                  <div className=\"flex items-center gap-1\">\r\n                    <span className=\"font-medium\">{metric.label}</span>\r\n                    {metric.description && (\r\n                      <TooltipProvider>\r\n                        <Tooltip>\r\n                          <TooltipTrigger>\r\n                            <IconInfoCircle className=\"size-3.5 text-muted-foreground\" />\r\n                          </TooltipTrigger>\r\n                          <TooltipContent>\r\n                            <p className=\"max-w-52 text-xs\">{metric.description}</p>\r\n                          </TooltipContent>\r\n                        </Tooltip>\r\n                      </TooltipProvider>\r\n                    )}\r\n                  </div>\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <span className=\"tabular-nums\">\r\n                      {metric.value}{metric.unit}\r\n                    </span>\r\n                    {metric.trend && metric.trendValue !== undefined && (\r\n                      <span className={cn(\"flex items-center text-xs\", getTrendColor(metric.trend))}>\r\n                        <TrendIcon className=\"size-3\" />\r\n                        {metric.trendValue > 0 ? \"+\" : \"\"}{metric.trendValue}%\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <Progress\r\n                    value={progress}\r\n                    className=\"h-1.5 flex-1\"\r\n                  />\r\n                  <span className=\"text-xs text-muted-foreground tabular-nums w-12 text-right\">\r\n                    /{metric.target}{metric.unit}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n            )\r\n          })}\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n}\r\n\r\n// Calculate performance score from metrics\r\nfunction calculatePerformanceScore(stats: {\r\n  orders: number\r\n  products: number\r\n  views: number\r\n  rating: number\r\n  revenue: number\r\n}) {\r\n  const metrics: PerformanceMetric[] = [\r\n    {\r\n      id: \"conversion\",\r\n      label: \"Conversion Rate\",\r\n      value: stats.orders > 0 && stats.views > 0\r\n        ? Number(((stats.orders / stats.views) * 100).toFixed(1))\r\n        : 0,\r\n      target: 3,\r\n      unit: \"%\",\r\n      trend: \"up\",\r\n      trendValue: 12,\r\n      description: \"Percentage of visitors who made a purchase\",\r\n    },\r\n    {\r\n      id: \"rating\",\r\n      label: \"Customer Rating\",\r\n      value: stats.rating || 0,\r\n      target: 5,\r\n      trend: \"neutral\",\r\n      description: \"Average rating from customer reviews\",\r\n    },\r\n    {\r\n      id: \"listings\",\r\n      label: \"Active Listings\",\r\n      value: stats.products,\r\n      target: 20,\r\n      trend: \"up\",\r\n      trendValue: 5,\r\n      description: \"Number of products listed in your store\",\r\n    },\r\n    {\r\n      id: \"orders\",\r\n      label: \"Orders (30d)\",\r\n      value: stats.orders,\r\n      target: 50,\r\n      trend: stats.orders > 10 ? \"up\" : \"neutral\",\r\n      trendValue: stats.orders > 10 ? 8 : 0,\r\n      description: \"Number of orders in the last 30 days\",\r\n    },\r\n  ]\r\n\r\n  // Calculate overall score (weighted average)\r\n  const weights = { conversion: 30, rating: 25, listings: 20, orders: 25 }\r\n  let totalScore = 0\r\n\r\n  for (const metric of metrics) {\r\n    const progress = Math.min((metric.value / metric.target) * 100, 100)\r\n    const weight = weights[metric.id as keyof typeof weights] || 25\r\n    totalScore += (progress * weight) / 100\r\n  }\r\n\r\n  return {\r\n    overallScore: Math.round(totalScore),\r\n    metrics,\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\business-quick-actions.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'IconBox' is defined but never used.","line":4,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":10,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"IconBox"},"fix":{"range":[59,71],"text":""},"desc":"Remove unused variable \"IconBox\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'IconSettings' is defined but never used.","line":8,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":15,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"IconSettings"},"fix":{"range":[125,142],"text":""},"desc":"Remove unused variable \"IconSettings\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Link } from \"@/i18n/routing\"\r\nimport {\r\n  IconPlus,\r\n  IconBox,\r\n  IconShoppingCart,\r\n  IconPackage,\r\n  IconChartBar,\r\n  IconSettings,\r\n} from \"@tabler/icons-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\n\r\nconst quickActions = [\r\n  {\r\n    title: \"Add product\",\r\n    description: \"Create a new listing\",\r\n    href: \"/dashboard/products?add=true\",\r\n    icon: IconPlus,\r\n    variant: \"default\" as const,\r\n  },\r\n  {\r\n    title: \"View orders\",\r\n    description: \"Manage customer orders\",\r\n    href: \"/dashboard/orders\",\r\n    icon: IconShoppingCart,\r\n    variant: \"outline\" as const,\r\n  },\r\n  {\r\n    title: \"Check inventory\",\r\n    description: \"Monitor stock levels\",\r\n    href: \"/dashboard/inventory\",\r\n    icon: IconPackage,\r\n    variant: \"outline\" as const,\r\n  },\r\n  {\r\n    title: \"Analytics\",\r\n    description: \"View performance\",\r\n    href: \"/dashboard/analytics\",\r\n    icon: IconChartBar,\r\n    variant: \"outline\" as const,\r\n  },\r\n]\r\n\r\nexport function BusinessQuickActions() {\r\n  return (\r\n    <div className=\"px-4 lg:px-6\">\r\n      <div className=\"flex flex-col gap-3\">\r\n        <h2 className=\"text-lg font-semibold\">Quick actions</h2>\r\n        <div className=\"flex flex-wrap gap-2\">\r\n          {quickActions.map((action) => (\r\n            <Button\r\n              key={action.href}\r\n              variant={action.variant}\r\n              size=\"sm\"\r\n              asChild\r\n              className=\"h-9\"\r\n            >\r\n              <Link href={action.href}>\r\n                <action.icon className=\"size-4 mr-1.5\" />\r\n                {action.title}\r\n              </Link>\r\n            </Button>\r\n          ))}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\business-recent-activity.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/[locale]/_lib/format-currency' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":12,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":12,"endColumn":69},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getStatusColor' to the outer scope.","line":45,"column":50,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":45,"endColumn":52}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { formatDistanceToNow } from \"date-fns\"\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\nimport Image from \"next/image\"\nimport { formatCurrency } from \"@/app/[locale]/_lib/format-currency\"\n\r\ninterface RecentProduct {\r\n  id: string\r\n  title: string\r\n  price: number\r\n  created_at: string\r\n  images: string[] | null\r\n  status: string | null\r\n}\r\n\r\ninterface RecentOrder {\r\n  id: string\r\n  quantity: number\r\n  price_at_purchase: number\r\n  order_id: string\r\n  product: {\r\n    id: string\r\n    title: string\r\n    images: string[] | null\r\n  } | null\r\n  order: {\r\n    id: string\r\n    created_at: string\r\n  } | null\r\n}\r\n\r\ninterface BusinessRecentActivityProps {\r\n  products: RecentProduct[]\r\n  orders: RecentOrder[]\r\n}\r\n\r\nexport function BusinessRecentActivity({ products, orders }: BusinessRecentActivityProps) {\r\n  const getStatusColor = (status: string | null) => {\r\n    switch (status) {\r\n      case 'active':\r\n        return 'bg-success/10 text-success border-success/20'\r\n      case 'draft':\r\n        return 'bg-muted text-foreground border-border'\r\n      case 'sold':\r\n        return 'bg-info/10 text-info border-info/20'\r\n      default:\r\n        return 'bg-muted text-foreground border-border'\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"grid gap-4 px-4 lg:px-6 md:grid-cols-2\">\r\n      {/* Recent Products */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-base\">Recent Products</CardTitle>\r\n          <CardDescription>Your latest listings this week</CardDescription>\r\n        </CardHeader>\r\n        <CardContent className=\"p-0\">\r\n          <ScrollArea className=\"h-(--spacing-scroll-md)\">\r\n            <div className=\"divide-y\">\r\n              {products.length === 0 ? (\r\n                <p className=\"p-4 text-sm text-muted-foreground\">No recent products</p>\r\n              ) : (\r\n                products.map((product) => (\r\n                  <div key={product.id} className=\"flex items-center gap-3 p-4\">\r\n                    <div className=\"relative size-10 rounded-md overflow-hidden bg-muted flex-shrink-0\">\r\n                      {product.images?.[0] ? (\r\n                        <Image\r\n                          src={product.images[0]}\r\n                          alt={product.title}\r\n                          fill\r\n                          className=\"object-cover\"\r\n                        />\r\n                      ) : (\r\n                        <div className=\"flex size-full items-center justify-center text-xs font-medium text-muted-foreground\">\r\n                          {product.title.slice(0, 2).toUpperCase()}\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"flex-1 min-w-0\">\r\n                      <p className=\"text-sm font-medium truncate\">\r\n                        {product.title}\r\n                      </p>\r\n                      <p className=\"text-xs text-muted-foreground\">\r\n                        {formatDistanceToNow(new Date(product.created_at), { addSuffix: true })}\r\n                      </p>\r\n                    </div>\r\n                    <div className=\"flex flex-col items-end gap-1\">\r\n                      <span className=\"text-sm font-medium text-success\">\r\n                        {formatCurrency(product.price, { locale: \"en-US\", maximumFractionDigits: 2 })}\n                      </span>\r\n                      <Badge variant=\"outline\" className={`text-xs ${getStatusColor(product.status)}`}>\r\n                        {product.status || 'active'}\r\n                      </Badge>\r\n                    </div>\r\n                  </div>\r\n                ))\r\n              )}\r\n            </div>\r\n          </ScrollArea>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Recent Orders */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-base\">Recent Orders</CardTitle>\r\n          <CardDescription>Latest orders you've received</CardDescription>\r\n        </CardHeader>\r\n        <CardContent className=\"p-0\">\r\n          <ScrollArea className=\"h-(--spacing-scroll-md)\">\r\n            <div className=\"divide-y\">\r\n              {orders.length === 0 ? (\r\n                <p className=\"p-4 text-sm text-muted-foreground\">No recent orders</p>\r\n              ) : (\r\n                orders.map((order) => {\r\n                  // Handle both array and single object from Supabase\r\n                  const product = Array.isArray(order.product) ? order.product[0] : order.product\r\n                  return (\r\n                    <div key={order.id} className=\"flex items-center gap-3 p-4\">\r\n                      <div className=\"relative size-10 rounded-md overflow-hidden bg-muted flex-shrink-0\">\r\n                        {product?.images?.[0] ? (\r\n                          <Image\r\n                            src={product.images[0]}\r\n                            alt={product.title}\r\n                            fill\r\n                            className=\"object-cover\"\r\n                          />\r\n                        ) : (\r\n                          <div className=\"flex size-full items-center justify-center text-xs font-medium text-muted-foreground\">\r\n                            ?\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <p className=\"text-sm font-medium truncate\">\r\n                          {product?.title || 'Unknown Product'}\r\n                        </p>\r\n                        <p className=\"text-xs text-muted-foreground\">\r\n                          Qty: {order.quantity} ΓÇó {order.order?.created_at ? formatDistanceToNow(new Date(order.order.created_at), { addSuffix: true }) : ''}\r\n                        </p>\r\n                      </div>\r\n                      <div className=\"text-sm font-medium tabular-nums\">\r\n                        {formatCurrency(order.price_at_purchase * order.quantity, { locale: \"en-US\", maximumFractionDigits: 2 })}\n                      </div>\r\n                    </div>\r\n                  )\r\n                })\r\n              )}\r\n            </div>\r\n          </ScrollArea>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\business-setup-guide.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\business-sidebar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_subscriptionName' is assigned a value but never used.","line":135,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":135,"endColumn":38}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { usePathname } from \"@/i18n/routing\"\r\nimport {\r\n  IconDashboard,\r\n  IconBox,\r\n  IconShoppingCart,\r\n  IconPackage,\r\n  IconChartBar,\r\n  IconReceipt,\r\n  IconSettings,\r\n  IconHome,\r\n  IconUsers,\r\n  IconBuildingStore,\r\n  IconTag,\r\n  IconSpeakerphone,\r\n} from \"@tabler/icons-react\"\r\n\r\nimport { NavUser } from \"@/components/layout/nav-user\"\r\nimport {\r\n  Sidebar,\r\n  SidebarContent,\r\n  SidebarFooter,\r\n  SidebarHeader,\r\n  SidebarMenu,\r\n  SidebarMenuButton,\r\n  SidebarMenuItem,\r\n  SidebarGroup,\r\n  SidebarGroupLabel,\r\n  SidebarGroupContent,\r\n} from \"@/components/layout/sidebar/sidebar\"\r\nimport { Badge } from \"@/components/ui/badge\"\nimport { cn } from \"@/lib/utils\"\nimport { BUSINESS_NAV, type BusinessRoute } from \"../dashboard/_lib/routes\"\n\nconst NAV_ICONS: Record<BusinessRoute, React.ElementType> = {\n  \"/dashboard\": IconDashboard,\n  \"/dashboard/orders\": IconShoppingCart,\n  \"/dashboard/products\": IconBox,\n  \"/dashboard/inventory\": IconPackage,\n  \"/dashboard/customers\": IconUsers,\n  \"/dashboard/discounts\": IconTag,\n  \"/dashboard/marketing\": IconSpeakerphone,\n  \"/dashboard/analytics\": IconChartBar,\n  \"/dashboard/accounting\": IconReceipt,\n  \"/dashboard/settings\": IconSettings,\n}\n\nconst withIcons = (items: { title: string; url: BusinessRoute }[]) =>\n  items.map((item) => ({\n    ...item,\n    icon: NAV_ICONS[item.url],\n  }))\n\n// Shopify-style nav structure with grouped sections\nconst salesChannelNav = withIcons(BUSINESS_NAV.salesChannel).map((item) => ({\n  ...item,\n  ...(item.url === \"/dashboard/orders\" ? { badge: 0 } : {}),\n}))\n\nconst productsNav = withIcons(BUSINESS_NAV.products)\nconst customersNav = withIcons(BUSINESS_NAV.customers)\nconst marketingNav = withIcons(BUSINESS_NAV.marketing)\nconst analyticsNav = withIcons(BUSINESS_NAV.analytics)\nconst settingsNav = withIcons(BUSINESS_NAV.settings)\n\r\ninterface BusinessSidebarProps extends React.ComponentProps<typeof Sidebar> {\r\n  user: {\r\n    name: string\r\n    email: string\r\n    avatar: string\r\n  }\r\n  storeName?: string\r\n  pendingOrdersCount?: number\r\n  subscriptionTier?: string\r\n  subscriptionName?: string\r\n  hasDashboardAccess?: boolean\r\n}\r\n\r\nfunction NavItem({\r\n  item,\r\n  isActive\r\n}: {\r\n  item: { title: string; url: string; icon: React.ElementType; badge?: number }\r\n  isActive: boolean\r\n}) {\r\n  const Icon = item.icon\r\n  return (\r\n    <SidebarMenuItem>\r\n      <SidebarMenuButton\r\n        asChild\r\n        isActive={isActive}\r\n        className={cn(\r\n          \"h-8 px-2 text-sm font-normal transition-colors\",\r\n          isActive && \"bg-accent font-medium\"\r\n        )}\r\n      >\r\n        <Link href={item.url}>\r\n          <Icon className=\"size-4\" />\r\n          <span className=\"flex-1\">{item.title}</span>\r\n          {item.badge !== undefined && item.badge > 0 && (\r\n            <Badge\r\n              variant=\"secondary\"\r\n              className=\"h-5 min-w-5 px-1.5 text-2xs font-semibold bg-primary text-primary-foreground\"\r\n            >\r\n              {item.badge > 99 ? '99+' : item.badge}\r\n            </Badge>\r\n          )}\r\n        </Link>\r\n      </SidebarMenuButton>\r\n    </SidebarMenuItem>\r\n  )\r\n}\r\n\r\n// Subscription tier badge colors\r\nconst tierColors: Record<string, string> = {\r\n  professional: 'bg-info text-info-foreground',\r\n  enterprise: 'bg-warning text-warning-foreground',\r\n  free: 'bg-muted text-muted-foreground',\r\n}\r\n\r\nconst tierLabels: Record<string, string> = {\r\n  professional: 'Pro',\r\n  enterprise: 'Enterprise',\r\n  free: 'Free',\r\n}\r\n\r\nexport function BusinessSidebar({\r\n  user,\r\n  storeName,\r\n  pendingOrdersCount = 0,\r\n  subscriptionTier = 'free',\r\n  subscriptionName: _subscriptionName = 'Business Free',\r\n  hasDashboardAccess = false,\r\n  ...props\r\n}: BusinessSidebarProps) {\r\n  const pathname = usePathname()\r\n\r\n  const normalizedPath = pathname || \"/dashboard\"\r\n\r\n  const isActive = (url: string) => {\r\n    if (url === '/dashboard') {\r\n      return normalizedPath === '/dashboard' || normalizedPath === ''\r\n    }\r\n    return normalizedPath.startsWith(url)\r\n  }\r\n\r\n  // Update orders badge with pending count\r\n  const salesChannelNavWithBadges = salesChannelNav.map((item) => ({\r\n    ...item,\r\n    ...(item.title === \"Orders\" && pendingOrdersCount > 0\r\n      ? { badge: pendingOrdersCount }\r\n      : {}),\r\n  }))\r\n\r\n  // Get tier display info\r\n  const tierColor = tierColors[subscriptionTier] || tierColors.free\r\n  const tierLabel = tierLabels[subscriptionTier] || 'Free'\r\n\r\n  return (\r\n    <Sidebar collapsible=\"offcanvas\" {...props}>\r\n      <SidebarHeader>\r\n        <SidebarMenu>\r\n          <SidebarMenuItem>\r\n            <SidebarMenuButton\r\n              asChild\r\n              className=\"h-12 px-2\"\r\n            >\r\n              <Link href=\"/dashboard\" className=\"flex items-center gap-2\">\r\n                <div className=\"flex size-8 items-center justify-center rounded-lg bg-primary text-primary-foreground\">\r\n                  <IconBuildingStore className=\"size-4\" />\r\n                </div>\r\n                <div className=\"flex flex-col min-w-0 flex-1\">\r\n                  <span className=\"text-sm font-semibold truncate\">\r\n                    {storeName || 'My Store'}\r\n                  </span>\r\n                  <div className=\"flex items-center gap-1.5\">\r\n                    <Badge\r\n                      className={cn(\r\n                        \"h-4 px-1.5 text-2xs font-semibold border-0\",\r\n                        tierColor\r\n                      )}\r\n                    >\r\n                      {tierLabel}\r\n                    </Badge>\r\n                    {!hasDashboardAccess && (\r\n                      <Link\r\n                        href=\"/dashboard/upgrade\"\r\n                        className=\"text-2xs text-primary hover:underline\"\r\n                        onClick={(e) => e.stopPropagation()}\r\n                      >\r\n                        Upgrade\r\n                      </Link>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </Link>\r\n            </SidebarMenuButton>\r\n          </SidebarMenuItem>\r\n        </SidebarMenu>\r\n      </SidebarHeader>\r\n\r\n      <SidebarContent className=\"gap-0\">\r\n        {/* Main Sales Section */}\r\n        <SidebarGroup className=\"py-2\">\r\n          <SidebarGroupContent>\r\n            <SidebarMenu className=\"gap-0.5\">\r\n              {salesChannelNavWithBadges.map((item) => (\r\n                <NavItem\r\n                  key={item.url}\r\n                  item={item}\r\n                  isActive={isActive(item.url)}\r\n                />\r\n              ))}\r\n            </SidebarMenu>\r\n          </SidebarGroupContent>\r\n        </SidebarGroup>\r\n\r\n        {/* Products Section */}\r\n        <SidebarGroup className=\"py-2\">\r\n          <SidebarGroupLabel className=\"h-7 px-2 text-xs font-medium text-muted-foreground\">\r\n            Products\r\n          </SidebarGroupLabel>\r\n          <SidebarGroupContent>\r\n            <SidebarMenu className=\"gap-0.5\">\r\n              {productsNav.map((item) => (\r\n                <NavItem\r\n                  key={item.url}\r\n                  item={item}\r\n                  isActive={isActive(item.url)}\r\n                />\r\n              ))}\r\n            </SidebarMenu>\r\n          </SidebarGroupContent>\r\n        </SidebarGroup>\r\n\r\n        {/* Customers Section */}\r\n        <SidebarGroup className=\"py-2\">\r\n          <SidebarGroupLabel className=\"h-7 px-2 text-xs font-medium text-muted-foreground\">\r\n            Customers\r\n          </SidebarGroupLabel>\r\n          <SidebarGroupContent>\r\n            <SidebarMenu className=\"gap-0.5\">\r\n              {customersNav.map((item) => (\r\n                <NavItem\r\n                  key={item.url}\r\n                  item={item}\r\n                  isActive={isActive(item.url)}\r\n                />\r\n              ))}\r\n            </SidebarMenu>\r\n          </SidebarGroupContent>\r\n        </SidebarGroup>\r\n\r\n        {/* Marketing Section */}\r\n        <SidebarGroup className=\"py-2\">\r\n          <SidebarGroupLabel className=\"h-7 px-2 text-xs font-medium text-muted-foreground\">\r\n            Marketing\r\n          </SidebarGroupLabel>\r\n          <SidebarGroupContent>\r\n            <SidebarMenu className=\"gap-0.5\">\r\n              {marketingNav.map((item) => (\r\n                <NavItem\r\n                  key={item.url}\r\n                  item={item}\r\n                  isActive={isActive(item.url)}\r\n                />\r\n              ))}\r\n            </SidebarMenu>\r\n          </SidebarGroupContent>\r\n        </SidebarGroup>\r\n\r\n        {/* Analytics Section */}\r\n        <SidebarGroup className=\"py-2\">\r\n          <SidebarGroupLabel className=\"h-7 px-2 text-xs font-medium text-muted-foreground\">\r\n            Analytics\r\n          </SidebarGroupLabel>\r\n          <SidebarGroupContent>\r\n            <SidebarMenu className=\"gap-0.5\">\r\n              {analyticsNav.map((item) => (\r\n                <NavItem\r\n                  key={item.url}\r\n                  item={item}\r\n                  isActive={isActive(item.url)}\r\n                />\r\n              ))}\r\n            </SidebarMenu>\r\n          </SidebarGroupContent>\r\n        </SidebarGroup>\r\n\r\n        {/* Settings - at bottom */}\r\n        <SidebarGroup className=\"mt-auto py-2\">\r\n          <SidebarGroupContent>\r\n            <SidebarMenu className=\"gap-0.5\">\r\n              {settingsNav.map((item) => (\r\n                <NavItem\r\n                  key={item.url}\r\n                  item={item}\r\n                  isActive={isActive(item.url)}\r\n                />\r\n              ))}\r\n              <SidebarMenuItem>\r\n                <SidebarMenuButton\r\n                  asChild\r\n                  className=\"h-8 px-2 text-sm font-normal text-muted-foreground hover:text-foreground\"\r\n                >\r\n                  <Link href=\"/\">\r\n                    <IconHome className=\"size-4\" />\r\n                    <span>Back to Store</span>\r\n                  </Link>\r\n                </SidebarMenuButton>\r\n              </SidebarMenuItem>\r\n            </SidebarMenu>\r\n          </SidebarGroupContent>\r\n        </SidebarGroup>\r\n      </SidebarContent>\r\n\r\n      <SidebarFooter>\r\n        <NavUser user={user} />\r\n      </SidebarFooter>\r\n    </Sidebar>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\business-stats-cards.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/[locale]/_lib/format-currency' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":4,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":4,"endColumn":69}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { IconTrendingUp, IconBox, IconShoppingCart, IconCurrencyDollar, IconEye, IconStar } from \"@tabler/icons-react\"\n\nimport { Badge } from \"@/components/ui/badge\"\nimport { formatCurrency } from \"@/app/[locale]/_lib/format-currency\"\nimport {\r\n  Card,\r\n  CardAction,\r\n  CardDescription,\r\n  CardFooter,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\n\r\ninterface BusinessStatsProps {\r\n  totals: {\r\n    products: number\r\n    orders: number\r\n    revenue: number\r\n    views: number\r\n    rating: number\r\n    totalReviews: number\r\n  }\r\n}\r\n\r\nexport function BusinessStatsCards({ totals }: BusinessStatsProps) {\r\n  return (\r\n    <div className=\"grid grid-cols-2 gap-2 sm:gap-4 px-4 lg:px-6 @xl/main:grid-cols-2 @5xl/main:grid-cols-5\">\r\n      <Card className=\"@container/card\">\r\n        <CardHeader>\r\n          <CardDescription className=\"flex items-center gap-2\">\r\n            <IconCurrencyDollar className=\"size-4\" />\r\n            Revenue (30d)\r\n          </CardDescription>\r\n          <CardTitle className=\"text-2xl font-semibold tabular-nums @[250px]/card:text-3xl\">\r\n            {formatCurrency(totals.revenue, { locale: \"en-US\", maximumFractionDigits: 0 })}\n          </CardTitle>\r\n          <CardAction>\r\n            <Badge variant=\"outline\" className=\"border-success/20 bg-success/10 text-success\">\r\n              <IconTrendingUp className=\"size-3\" />\r\n              Sales\r\n            </Badge>\r\n          </CardAction>\r\n        </CardHeader>\r\n        <CardFooter className=\"flex-col items-start gap-1.5 text-sm\">\r\n          <div className=\"text-muted-foreground\">\r\n            Last 30 days earnings\r\n          </div>\r\n        </CardFooter>\r\n      </Card>\r\n\r\n      <Card className=\"@container/card\">\r\n        <CardHeader>\r\n          <CardDescription className=\"flex items-center gap-2\">\r\n            <IconShoppingCart className=\"size-4\" />\r\n            Orders (30d)\r\n          </CardDescription>\r\n          <CardTitle className=\"text-2xl font-semibold tabular-nums @[250px]/card:text-3xl\">\r\n            {totals.orders.toLocaleString()}\r\n          </CardTitle>\r\n          <CardAction>\r\n            <Badge variant=\"outline\" className=\"border-info/20 bg-info/10 text-info\">\r\n              <IconTrendingUp className=\"size-3\" />\r\n              Active\r\n            </Badge>\r\n          </CardAction>\r\n        </CardHeader>\r\n        <CardFooter className=\"flex-col items-start gap-1.5 text-sm\">\r\n          <div className=\"text-muted-foreground\">\r\n            Orders received\r\n          </div>\r\n        </CardFooter>\r\n      </Card>\r\n\r\n      <Card className=\"@container/card\">\r\n        <CardHeader>\r\n          <CardDescription className=\"flex items-center gap-2\">\r\n            <IconBox className=\"size-4\" />\r\n            Products\r\n          </CardDescription>\r\n          <CardTitle className=\"text-2xl font-semibold tabular-nums @[250px]/card:text-3xl\">\r\n            {totals.products.toLocaleString()}\r\n          </CardTitle>\r\n          <CardAction>\r\n            <Badge variant=\"outline\" className=\"border-selected-border bg-selected text-primary\">\r\n              Listed\r\n            </Badge>\r\n          </CardAction>\r\n        </CardHeader>\r\n        <CardFooter className=\"flex-col items-start gap-1.5 text-sm\">\r\n          <div className=\"text-muted-foreground\">\r\n            Active listings\r\n          </div>\r\n        </CardFooter>\r\n      </Card>\r\n\r\n      <Card className=\"@container/card\">\r\n        <CardHeader>\r\n          <CardDescription className=\"flex items-center gap-2\">\r\n            <IconEye className=\"size-4\" />\r\n            Views\r\n          </CardDescription>\r\n          <CardTitle className=\"text-2xl font-semibold tabular-nums @[250px]/card:text-3xl\">\r\n            {totals.views.toLocaleString()}\r\n          </CardTitle>\r\n          <CardAction>\r\n            <Badge variant=\"outline\" className=\"border-warning/20 bg-warning/10 text-warning\">\r\n              Total\r\n            </Badge>\r\n          </CardAction>\r\n        </CardHeader>\r\n        <CardFooter className=\"flex-col items-start gap-1.5 text-sm\">\r\n          <div className=\"text-muted-foreground\">\r\n            Product views\r\n          </div>\r\n        </CardFooter>\r\n      </Card>\r\n\r\n      <Card className=\"@container/card\">\r\n        <CardHeader>\r\n          <CardDescription className=\"flex items-center gap-2\">\r\n            <IconStar className=\"size-4\" />\r\n            Rating\r\n          </CardDescription>\r\n          <CardTitle className=\"text-2xl font-semibold tabular-nums @[250px]/card:text-3xl\">\r\n            {totals.rating.toFixed(1)}\r\n          </CardTitle>\r\n          <CardAction>\r\n            <Badge variant=\"outline\" className=\"border-warning/20 bg-warning/10 text-warning\">\r\n              {totals.totalReviews} reviews\r\n            </Badge>\r\n          </CardAction>\r\n        </CardHeader>\r\n        <CardFooter className=\"flex-col items-start gap-1.5 text-sm\">\r\n          <div className=\"text-muted-foreground\">\r\n            Average rating\r\n          </div>\r\n        </CardFooter>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\business-task-cards.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\order-detail-view.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_sellerId' is defined but never used.","line":130,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":130,"endColumn":22},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getProduct' to the outer scope.","line":136,"column":61,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":136,"endColumn":63},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'formatCurrency' to the outer scope.","line":155,"column":42,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":155,"endColumn":44},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'formatAddress' to the outer scope.","line":183,"column":67,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":183,"endColumn":69}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport Image from \"next/image\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useRouter } from \"@/i18n/routing\"\r\nimport { toast } from \"sonner\"\r\nimport { format } from \"date-fns\"\r\nimport {\r\n  IconArrowLeft,\r\n  IconPackage,\r\n  IconTruck,\r\n  IconCheck,\r\n  IconX,\r\n  IconRefresh,\r\n  IconMessage,\r\n  IconPrinter,\r\n  IconMail,\r\n  IconPhone,\r\n  IconMapPin,\r\n  IconClock,\r\n  IconChevronDown,\r\n  IconCopy,\r\n} from \"@tabler/icons-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\n// Type definitions - aligned with actual database schema\r\ninterface OrderProduct {\r\n  id: string\r\n  title: string\r\n  images: string[] | null\r\n  sku: string | null\r\n  price: number\r\n}\r\n\r\ninterface OrderItem {\r\n  id: string\r\n  quantity: number\r\n  price_at_time: number // Maps to price_at_purchase in DB\r\n  status?: string | null\r\n  tracking_number?: string | null\r\n  shipping_carrier?: string | null\r\n  product: OrderProduct | OrderProduct[] | null\r\n}\r\n\r\ninterface OrderCustomer {\r\n  id: string\r\n  email: string | null\r\n  full_name: string | null\r\n  phone: string | null\r\n}\r\n\r\ninterface Order {\r\n  id: string\r\n  status: string | null\r\n  created_at: string\r\n  total_amount?: number\r\n  shipping_address: Record<string, unknown> | null\r\n  user: OrderCustomer | OrderCustomer[] | null\r\n}\r\n\r\ninterface OrderDetailViewProps {\r\n  order: Order\r\n  items: OrderItem[]\r\n  subtotal: number\r\n  sellerId: string\r\n}\r\n\r\nconst STATUS_CONFIG = {\r\n  pending: {\r\n    label: \"Unfulfilled\",\r\n    color: \"bg-muted text-foreground border-border\",\r\n    icon: IconPackage,\r\n    nextStatus: \"processing\",\r\n  },\r\n  paid: {\r\n    label: \"Paid\",\r\n    color: \"bg-success/10 text-success border-success/20\",\r\n    icon: IconCheck,\r\n    nextStatus: \"processing\",\r\n  },\r\n  processing: {\r\n    label: \"Processing\",\r\n    color: \"bg-selected text-primary border-selected-border\",\r\n    icon: IconRefresh,\r\n    nextStatus: \"shipped\",\r\n  },\r\n  shipped: {\r\n    label: \"Shipped\",\r\n    color: \"bg-muted text-foreground border-border\",\r\n    icon: IconTruck,\r\n    nextStatus: \"delivered\",\r\n  },\r\n  delivered: {\r\n    label: \"Delivered\",\r\n    color: \"bg-success/10 text-success border-success/20\",\r\n    icon: IconCheck,\r\n    nextStatus: undefined,\r\n  },\r\n  cancelled: {\r\n    label: \"Cancelled\",\r\n    color: \"bg-destructive-subtle text-destructive border-destructive/20\",\n    icon: IconX,\r\n    nextStatus: undefined,\r\n  },\r\n} as const\r\n\r\ntype StatusKey = keyof typeof STATUS_CONFIG\r\n\r\nfunction getStatusConfig(status: string): (typeof STATUS_CONFIG)[StatusKey] {\r\n  if (status in STATUS_CONFIG) return STATUS_CONFIG[status as StatusKey]\r\n  return STATUS_CONFIG.pending\r\n}\r\n\r\nexport function OrderDetailView({\r\n  order,\r\n  items,\r\n  subtotal,\r\n  sellerId: _sellerId,\r\n}: OrderDetailViewProps) {\r\n  const router = useRouter()\r\n  const [isLoading, setIsLoading] = React.useState(false)\r\n\r\n  // Helper to get nested data\r\n  const getProduct = (item: OrderItem): OrderProduct | null => {\r\n    if (!item.product) return null\r\n    return Array.isArray(item.product) ? (item.product.at(0) ?? null) : item.product\r\n  }\r\n\r\n  const getCustomer = (): OrderCustomer | null => {\r\n    if (!order.user) return null\r\n    return Array.isArray(order.user) ? (order.user.at(0) ?? null) : order.user\r\n  }\r\n\r\n  const customer = getCustomer()\n  const status = order.status || \"pending\"\n  const statusConfig = getStatusConfig(status)\n  const StatusIcon = statusConfig.icon\n  const nextStatus = statusConfig.nextStatus\n\r\n  const shippingCost = 0 // Shipping cost not stored in orders table yet\r\n  const total = order.total_amount || (subtotal + shippingCost)\r\n\r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat('bg-BG', {\r\n      style: 'currency',\r\n      currency: 'BGN',\r\n      maximumFractionDigits: 2,\r\n    }).format(value)\r\n  }\r\n\r\n  const handleStatusUpdate = async (newStatus: string) => {\r\n    setIsLoading(true)\r\n    // Stub: Use updateOrderItemStatus action when order_item_id is available in this component\r\n    // Currently the order-status-actions component handles this for individual items\r\n    toast.success(`Order marked as ${newStatus}`)\r\n    setIsLoading(false)\r\n    router.refresh()\r\n  }\r\n\r\n  const handleContactCustomer = () => {\r\n    if (customer) {\r\n      router.push(`/messages?user=${customer.id}`)\r\n    }\r\n  }\r\n\r\n  const copyOrderId = () => {\r\n    navigator.clipboard.writeText(order.id)\r\n    toast.success(\"Order ID copied\")\r\n  }\r\n\r\n  const formatAddress = (address: Record<string, unknown> | null) => {\r\n    if (!address) return null\r\n    const parts = [\r\n      address.street as string,\r\n      address.city as string,\r\n      address.state as string,\r\n      address.postal_code as string,\r\n      address.country as string,\r\n    ].filter(Boolean)\r\n    return parts.join(\", \")\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6 px-4 lg:px-6\">\r\n      {/* Header */}\r\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between\">\r\n        <div className=\"flex items-start gap-3\">\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"icon\"\r\n            className=\"shrink-0 -ml-2\"\r\n            onClick={() => router.push('/dashboard/orders')}\r\n          >\r\n            <IconArrowLeft className=\"size-4\" />\r\n          </Button>\r\n          <div>\r\n            <div className=\"flex items-center gap-2 flex-wrap\">\r\n              <h1 className=\"text-xl font-bold tracking-tight\">\r\n                Order #{order.id.slice(0, 8)}\r\n              </h1>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"icon\"\r\n                className=\"size-6\"\r\n                onClick={copyOrderId}\r\n              >\r\n                <IconCopy className=\"size-3.5\" />\r\n              </Button>\r\n              <Badge\r\n                variant=\"outline\"\r\n                className={cn(\"gap-1\", statusConfig.color)}\r\n              >\r\n                <StatusIcon className=\"size-3\" />\r\n                {statusConfig.label}\r\n              </Badge>\r\n            </div>\r\n            <p className=\"text-sm text-muted-foreground mt-1\">\r\n              {format(new Date(order.created_at), \"MMMM d, yyyy 'at' h:mm a\")}\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Actions */}\r\n        <div className=\"flex items-center gap-2 flex-wrap\">\r\n          {nextStatus && (\n            <Button\n              onClick={() => handleStatusUpdate(nextStatus)}\n              disabled={isLoading}\n              size=\"sm\"\n            >\n              {nextStatus === \"processing\" && \"Start Processing\"}\n              {nextStatus === \"shipped\" && \"Mark as Shipped\"}\n              {nextStatus === \"delivered\" && \"Mark as Delivered\"}\n            </Button>\n          )}\n          <DropdownMenu>\r\n            <DropdownMenuTrigger asChild>\r\n              <Button variant=\"outline\" size=\"sm\">\r\n                More actions\r\n                <IconChevronDown className=\"size-3.5 ml-1\" />\r\n              </Button>\r\n            </DropdownMenuTrigger>\r\n            <DropdownMenuContent align=\"end\" className=\"w-48\">\r\n              <DropdownMenuItem onClick={handleContactCustomer}>\r\n                <IconMessage className=\"size-4 mr-2\" />\r\n                Contact Customer\r\n              </DropdownMenuItem>\r\n              <DropdownMenuItem>\r\n                <IconPrinter className=\"size-4 mr-2\" />\r\n                Print Packing Slip\r\n              </DropdownMenuItem>\r\n              <DropdownMenuSeparator />\r\n              <DropdownMenuItem\r\n                onClick={() => handleStatusUpdate(\"cancelled\")}\r\n                className=\"text-destructive focus:bg-destructive-subtle focus:text-destructive\"\n                disabled={status === \"cancelled\" || status === \"delivered\"}\r\n              >\r\n                <IconX className=\"size-4 mr-2\" />\r\n                Cancel Order\r\n              </DropdownMenuItem>\r\n            </DropdownMenuContent>\r\n          </DropdownMenu>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Main Content - Two Column Layout */}\r\n      <div className=\"grid gap-4 lg:grid-cols-3\">\r\n        {/* Left Column - Order Items */}\r\n        <div className=\"lg:col-span-2 space-y-4\">\r\n          {/* Order Items Card */}\r\n          <Card>\r\n            <CardHeader className=\"pb-3\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <CardTitle className=\"text-base\">Items</CardTitle>\r\n                <Badge variant=\"secondary\">\r\n                  {items.length} {items.length === 1 ? \"item\" : \"items\"}\r\n                </Badge>\r\n              </div>\r\n            </CardHeader>\r\n            <CardContent className=\"p-0\">\r\n              <div className=\"divide-y\">\r\n                {items.map((item) => {\r\n                  const product = getProduct(item)\r\n                  return (\r\n                    <div key={item.id} className=\"flex items-center gap-4 p-4\">\r\n                      <div className=\"relative size-14 rounded-lg overflow-hidden bg-muted shrink-0\">\r\n                        {product?.images?.[0] ? (\r\n                          <Image\r\n                            src={product.images[0]}\r\n                            alt={product?.title || \"Product\"}\r\n                            fill\r\n                            className=\"object-cover\"\r\n                          />\r\n                        ) : (\r\n                          <div className=\"flex size-full items-center justify-center\">\r\n                            <IconPackage className=\"size-5 text-muted-foreground\" />\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <Link\r\n                          href={`/products/${product?.id}`}\r\n                          className=\"font-medium text-sm hover:underline\"\r\n                        >\r\n                          {product?.title || \"Unknown Product\"}\r\n                        </Link>\r\n                        {product?.sku && (\r\n                          <p className=\"text-xs text-muted-foreground font-mono mt-0.5\">\r\n                            SKU: {product.sku}\r\n                          </p>\r\n                        )}\r\n                      </div>\r\n                      <div className=\"text-right\">\r\n                        <p className=\"text-sm font-medium tabular-nums\">\r\n                          {formatCurrency(item.price_at_time)}\r\n                        </p>\r\n                        <p className=\"text-xs text-muted-foreground\">\r\n                          ├ù {item.quantity}\r\n                        </p>\r\n                      </div>\r\n                      <div className=\"text-right w-24\">\r\n                        <p className=\"font-medium tabular-nums\">\r\n                          {formatCurrency(item.price_at_time * item.quantity)}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n                  )\r\n                })}\r\n              </div>\r\n\r\n              {/* Order Summary */}\r\n              <div className=\"border-t p-4 space-y-2\">\r\n                <div className=\"flex justify-between text-sm\">\r\n                  <span className=\"text-muted-foreground\">Subtotal</span>\r\n                  <span className=\"tabular-nums\">{formatCurrency(subtotal)}</span>\r\n                </div>\r\n                <div className=\"flex justify-between text-sm\">\r\n                  <span className=\"text-muted-foreground\">Shipping</span>\r\n                  <span className=\"tabular-nums\">\r\n                    {shippingCost > 0 ? formatCurrency(shippingCost) : \"Free\"}\r\n                  </span>\r\n                </div>\r\n                <Separator />\r\n                <div className=\"flex justify-between font-medium\">\r\n                  <span>Total</span>\r\n                  <span className=\"tabular-nums\">{formatCurrency(total)}</span>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Timeline Card */}\r\n          <Card>\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-base\">Timeline</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex gap-3\">\r\n                  <div className=\"flex flex-col items-center\">\r\n                    <div className={cn(\r\n                      \"flex size-8 items-center justify-center rounded-full\",\r\n                      statusConfig.color\r\n                    )}>\r\n                      <StatusIcon className=\"size-4\" />\r\n                    </div>\r\n                    <div className=\"w-px h-full bg-border\" />\r\n                  </div>\r\n                  <div className=\"pb-4\">\r\n                    <p className=\"font-medium text-sm\">{statusConfig.label}</p>\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      {format(new Date(order.created_at), \"MMM d, yyyy 'at' h:mm a\")}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"flex gap-3\">\r\n                  <div className=\"flex flex-col items-center\">\r\n                    <div className=\"flex size-8 items-center justify-center rounded-full bg-muted\">\r\n                      <IconClock className=\"size-4 text-muted-foreground\" />\r\n                    </div>\r\n                  </div>\r\n                  <div>\r\n                    <p className=\"font-medium text-sm\">Order placed</p>\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      {format(new Date(order.created_at), \"MMM d, yyyy 'at' h:mm a\")}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n\r\n        {/* Right Column - Customer & Shipping Info */}\r\n        <div className=\"space-y-4\">\r\n          {/* Customer Card */}\r\n          <Card>\r\n            <CardHeader className=\"pb-3\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <CardTitle className=\"text-base\">Customer</CardTitle>\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={handleContactCustomer}\r\n                >\r\n                  <IconMessage className=\"size-4 mr-1\" />\r\n                  Contact\r\n                </Button>\r\n              </div>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-3\">\r\n              <div>\r\n                <p className=\"font-medium\">{customer?.full_name || \"Guest Customer\"}</p>\r\n              </div>\r\n              {customer?.email && (\r\n                <div className=\"flex items-center gap-2 text-sm\">\r\n                  <IconMail className=\"size-4 text-muted-foreground\" />\r\n                  <a href={`mailto:${customer.email}`} className=\"text-primary hover:underline\">\r\n                    {customer.email}\r\n                  </a>\r\n                </div>\r\n              )}\r\n              {customer?.phone && (\r\n                <div className=\"flex items-center gap-2 text-sm\">\r\n                  <IconPhone className=\"size-4 text-muted-foreground\" />\r\n                  <a href={`tel:${customer.phone}`} className=\"hover:underline\">\r\n                    {customer.phone}\r\n                  </a>\r\n                </div>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Shipping Address Card */}\r\n          <Card>\r\n            <CardHeader className=\"pb-3\">\r\n              <CardTitle className=\"text-base\">Shipping Address</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              {order.shipping_address ? (\r\n                <div className=\"flex gap-2 text-sm\">\r\n                  <IconMapPin className=\"size-4 text-muted-foreground shrink-0 mt-0.5\" />\r\n                  <p className=\"text-muted-foreground\">\r\n                    {formatAddress(order.shipping_address)}\r\n                  </p>\r\n                </div>\r\n              ) : (\r\n                <p className=\"text-sm text-muted-foreground\">No shipping address provided</p>\r\n              )}\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\orders-table.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_total' is defined but never used.","line":137,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":137,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_sellerId' is defined but never used.","line":138,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":138,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_setOrders' is assigned a value but never used.","line":141,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":141,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_isLoading' is assigned a value but never used.","line":148,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":148,"endColumn":20},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'getCustomer' to the outer scope.","line":161,"column":67,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":161,"endColumn":69},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'formatCurrency' to the outer scope.","line":269,"column":42,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":269,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport Image from \"next/image\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useRouter } from \"@/i18n/routing\"\r\nimport { toast } from \"sonner\"\r\nimport { format } from \"date-fns\"\r\nimport {\r\n  IconSearch,\r\n  IconChevronDown,\r\n  IconDotsVertical,\r\n  IconTruck,\r\n  IconCheck,\r\n  IconX,\r\n  IconRefresh,\r\n  IconPackage,\r\n  IconDownload,\r\n  IconSelector,\r\n  IconChevronUp,\r\n  IconEye,\r\n  IconMessage,\r\n  IconPrinter,\r\n} from \"@tabler/icons-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Checkbox } from \"@/components/ui/checkbox\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport {\r\n  Tabs,\r\n  TabsList,\r\n  TabsTrigger,\r\n} from \"@/components/ui/tabs\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\n// Order type definitions\r\ninterface OrderCustomer {\r\n  id: string\r\n  email?: string | null\r\n  full_name: string | null\r\n}\r\n\r\ninterface OrderProduct {\r\n  id: string\r\n  title: string\r\n  images: string[] | null\r\n  sku: string | null\r\n}\r\n\r\ninterface Order {\r\n  id: string\r\n  status: string | null\r\n  created_at: string\r\n  shipping_address: Record<string, unknown> | null\r\n  user: OrderCustomer | OrderCustomer[] | null\r\n}\r\n\r\ninterface OrderItem {\r\n  id: string\r\n  quantity: number\r\n  price_at_purchase: number\r\n  order_id: string\r\n  product_id: string\r\n  seller_id: string\r\n  order: Order | Order[] | null\r\n  product: OrderProduct | OrderProduct[] | null\r\n  user?: { id: string; email?: string | null; full_name: string | null } | null\r\n}\r\n\r\ninterface OrdersTableProps {\r\n  initialOrders: OrderItem[]\r\n  total: number\r\n  sellerId: string\r\n}\r\n\r\ntype OrderStatus = \"all\" | \"pending\" | \"processing\" | \"shipped\" | \"delivered\" | \"cancelled\"\r\ntype SortField = \"created_at\" | \"total\" | \"customer\"\r\ntype SortOrder = \"asc\" | \"desc\"\r\n\r\nconst STATUS_CONFIG = {\r\n  pending: {\r\n    label: \"Unfulfilled\",\r\n    color: \"bg-muted text-foreground border-border\",\r\n    icon: IconPackage\r\n  },\r\n  processing: {\r\n    label: \"In Progress\",\r\n    color: \"bg-selected text-primary border-selected-border\",\r\n    icon: IconRefresh\r\n  },\r\n  shipped: {\r\n    label: \"Shipped\",\r\n    color: \"bg-muted text-foreground border-border\",\r\n    icon: IconTruck\r\n  },\r\n  delivered: {\r\n    label: \"Delivered\",\r\n    color: \"bg-success/10 text-success border-success/20\",\r\n    icon: IconCheck\r\n  },\r\n  cancelled: {\r\n    label: \"Cancelled\",\r\n    color: \"bg-destructive-subtle text-destructive border-destructive/20\",\n    icon: IconX\r\n  },\r\n  paid: {\r\n    label: \"Paid\",\r\n    color: \"bg-success/10 text-success border-success/20\",\r\n    icon: IconCheck\r\n  },\r\n} as const\r\n\r\ntype StatusKey = keyof typeof STATUS_CONFIG\r\n\r\nfunction getStatusConfig(status: string): (typeof STATUS_CONFIG)[StatusKey] {\r\n  if (status in STATUS_CONFIG) return STATUS_CONFIG[status as StatusKey]\r\n  return STATUS_CONFIG.pending\r\n}\r\n\r\nexport function OrdersTable({\r\n  initialOrders,\r\n  total: _total,\r\n  sellerId: _sellerId,\r\n}: OrdersTableProps) {\r\n  const router = useRouter()\r\n  const [orders, _setOrders] = React.useState<OrderItem[]>(initialOrders)\r\n  const [selectedIds, setSelectedIds] = React.useState<Set<string>>(new Set())\r\n  const [isAllSelected, setIsAllSelected] = React.useState(false)\r\n  const [searchQuery, setSearchQuery] = React.useState(\"\")\r\n  const [statusFilter, setStatusFilter] = React.useState<OrderStatus>(\"all\")\r\n  const [sortField, setSortField] = React.useState<SortField>(\"created_at\")\r\n  const [sortOrder, setSortOrder] = React.useState<SortOrder>(\"desc\")\r\n  const [_isLoading, _setIsLoading] = React.useState(false)\r\n\r\n  // Helper to extract order data from potentially nested structure\r\n  const getOrder = (item: OrderItem): Order | null => {\r\n    if (!item.order) return null\r\n    return Array.isArray(item.order) ? (item.order.at(0) ?? null) : item.order\r\n  }\r\n\r\n  const getProduct = (item: OrderItem): OrderProduct | null => {\r\n    if (!item.product) return null\r\n    return Array.isArray(item.product) ? (item.product.at(0) ?? null) : item.product\r\n  }\r\n\r\n  const getCustomer = (order: Order | null): OrderCustomer | null => {\r\n    if (!order?.user) return null\r\n    return Array.isArray(order.user) ? (order.user.at(0) ?? null) : order.user\r\n  }\r\n\r\n  // Count orders by status\r\n  const statusCounts = React.useMemo(() => {\r\n    const counts: Record<string, number> = { all: orders.length }\r\n    orders.forEach((item) => {\r\n      const order = getOrder(item)\r\n      const status = order?.status || \"pending\"\r\n      counts[status] = (counts[status] || 0) + 1\r\n    })\r\n    return counts\r\n  }, [orders])\r\n\r\n  // Filter and sort orders\r\n  const filteredOrders = React.useMemo(() => {\r\n    let result = [...orders]\r\n\r\n    // Status filter\r\n    if (statusFilter !== \"all\") {\r\n      result = result.filter((item) => {\r\n        const order = getOrder(item)\r\n        return (order?.status || \"pending\") === statusFilter\r\n      })\r\n    }\r\n\r\n    // Search filter\r\n    if (searchQuery) {\r\n      const query = searchQuery.toLowerCase()\r\n      result = result.filter((item) => {\r\n        const order = getOrder(item)\r\n        const product = getProduct(item)\r\n        const customer = getCustomer(order)\r\n        return (\r\n          order?.id?.toLowerCase().includes(query) ||\r\n          product?.title?.toLowerCase().includes(query) ||\r\n          customer?.full_name?.toLowerCase().includes(query) ||\r\n          (typeof customer?.email === \"string\" && customer.email.toLowerCase().includes(query))\r\n        )\r\n      })\r\n    }\r\n\r\n    // Sort\r\n    result.sort((a, b) => {\r\n      let comparison = 0\r\n      const orderA = getOrder(a)\r\n      const orderB = getOrder(b)\r\n\r\n      switch (sortField) {\r\n        case \"created_at\":\r\n          const timeA = orderA?.created_at ? new Date(orderA.created_at).getTime() : 0\r\n          const timeB = orderB?.created_at ? new Date(orderB.created_at).getTime() : 0\r\n          comparison = timeA - timeB\r\n          break\r\n        case \"total\":\r\n          comparison = (a.price_at_purchase * a.quantity) - (b.price_at_purchase * b.quantity)\r\n          break\r\n        case \"customer\":\r\n          const custA = getCustomer(orderA)?.full_name || \"\"\r\n          const custB = getCustomer(orderB)?.full_name || \"\"\r\n          comparison = custA.localeCompare(custB)\r\n          break\r\n      }\r\n      return sortOrder === \"asc\" ? comparison : -comparison\r\n    })\r\n\r\n    return result\r\n  }, [orders, searchQuery, statusFilter, sortField, sortOrder])\r\n\r\n  const toggleSelectAll = () => {\r\n    if (isAllSelected) {\r\n      setSelectedIds(new Set())\r\n      setIsAllSelected(false)\r\n    } else {\r\n      setSelectedIds(new Set(filteredOrders.map((o) => o.id)))\r\n      setIsAllSelected(true)\r\n    }\r\n  }\r\n\r\n  const toggleSelect = (id: string) => {\r\n    const newSelected = new Set(selectedIds)\r\n    if (newSelected.has(id)) {\r\n      newSelected.delete(id)\r\n    } else {\r\n      newSelected.add(id)\r\n    }\r\n    setSelectedIds(newSelected)\r\n    setIsAllSelected(newSelected.size === filteredOrders.length)\r\n  }\r\n\r\n  const handleSort = (field: SortField) => {\r\n    if (sortField === field) {\r\n      setSortOrder(sortOrder === \"asc\" ? \"desc\" : \"asc\")\r\n    } else {\r\n      setSortField(field)\r\n      setSortOrder(\"desc\")\r\n    }\r\n  }\r\n\r\n  const getSortIcon = (field: SortField) => {\r\n    if (sortField !== field) return <IconSelector className=\"size-3.5 text-muted-foreground\" />\r\n    return sortOrder === \"asc\"\r\n      ? <IconChevronUp className=\"size-3.5\" />\r\n      : <IconChevronDown className=\"size-3.5\" />\r\n  }\r\n\r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat('bg-BG', {\r\n      style: 'currency',\r\n      currency: 'BGN',\r\n      maximumFractionDigits: 2,\r\n    }).format(value)\r\n  }\r\n\r\n  const handleBulkStatusUpdate = async (newStatus: string) => {\r\n    _setIsLoading(true)\r\n    // Stub: Need bulkUpdateOrderItemsStatus action in app/actions/orders.ts\r\n    // Would iterate selectedIds and call updateOrderItemStatus for each\r\n    toast.success(`${selectedIds.size} order(s) updated to ${newStatus}`)\r\n    setSelectedIds(new Set())\r\n    setIsAllSelected(false)\r\n    _setIsLoading(false)\r\n    router.refresh()\r\n  }\r\n\r\n  const handleContactCustomer = (item: OrderItem) => {\r\n    const order = getOrder(item)\r\n    const customer = getCustomer(order)\r\n    if (customer) {\r\n      // Navigate to chat with customer\r\n      router.push(`/messages?user=${customer.id}`)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6 px-4 lg:px-6\">\r\n      {/* Header */}\r\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold tracking-tight\">Orders</h1>\r\n          <p className=\"text-muted-foreground\">\r\n            Manage and fulfill customer orders\r\n          </p>\r\n        </div>\r\n        <div className=\"flex items-center gap-2\">\r\n          <Button variant=\"outline\" size=\"sm\">\r\n            <IconDownload className=\"size-4 mr-1.5\" />\r\n            Export\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Status Tabs - Professional Underline Style */}\r\n      <Tabs value={statusFilter} onValueChange={(v) => setStatusFilter(v as OrderStatus)} className=\"w-full\">\r\n        <TabsList>\r\n          <TabsTrigger value=\"all\">\r\n            All\r\n            <Badge variant=\"secondary\" className=\"ml-1.5 h-5 px-1.5 text-2xs\">\r\n              {statusCounts.all || 0}\r\n            </Badge>\r\n          </TabsTrigger>\r\n          <TabsTrigger value=\"pending\">\r\n            Unfulfilled\r\n            {(statusCounts.pending || 0) > 0 && (\r\n              <Badge variant=\"secondary\" className=\"ml-1.5 h-5 px-1.5 text-2xs\">\r\n                {statusCounts.pending}\r\n              </Badge>\r\n            )}\r\n          </TabsTrigger>\r\n          <TabsTrigger value=\"processing\">\r\n            In Progress\r\n            {(statusCounts.processing || 0) > 0 && (\r\n              <Badge variant=\"secondary\" className=\"ml-1.5 h-5 px-1.5 text-2xs\">\r\n                {statusCounts.processing}\r\n              </Badge>\r\n            )}\r\n          </TabsTrigger>\r\n          <TabsTrigger value=\"shipped\">\r\n            Shipped\r\n            {(statusCounts.shipped || 0) > 0 && (\r\n              <Badge variant=\"secondary\" className=\"ml-1.5 h-5 px-1.5 text-2xs\">\r\n                {statusCounts.shipped}\r\n              </Badge>\r\n            )}\r\n          </TabsTrigger>\r\n          <TabsTrigger value=\"delivered\">\r\n            Delivered\r\n            {(statusCounts.delivered || 0) > 0 && (\r\n              <Badge variant=\"secondary\" className=\"ml-1.5 h-5 px-1.5 text-2xs\">\r\n                {statusCounts.delivered}\r\n              </Badge>\r\n            )}\r\n          </TabsTrigger>\r\n        </TabsList>\r\n      </Tabs>\r\n\r\n      {/* Search and Filters Bar */}\r\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center\">\r\n        <div className=\"relative flex-1 max-w-sm\">\r\n          <IconSearch className=\"absolute left-3 top-1/2 -translate-y-1/2 size-4 text-muted-foreground\" />\r\n          <Input\r\n            placeholder=\"Search orders...\"\r\n            value={searchQuery}\r\n            onChange={(e) => setSearchQuery(e.target.value)}\r\n            className=\"pl-9 h-9\"\r\n          />\r\n        </div>\r\n\r\n        {/* Bulk Actions */}\r\n        {selectedIds.size > 0 && (\r\n          <div className=\"flex items-center gap-2 px-3 py-1.5 bg-muted rounded-lg\">\r\n            <span className=\"text-sm font-medium\">{selectedIds.size} selected</span>\r\n            <DropdownMenu>\r\n              <DropdownMenuTrigger asChild>\r\n                <Button variant=\"ghost\" size=\"sm\" className=\"h-7\">\r\n                  Actions <IconChevronDown className=\"ml-1 size-3.5\" />\r\n                </Button>\r\n              </DropdownMenuTrigger>\r\n              <DropdownMenuContent align=\"start\">\r\n                <DropdownMenuItem onClick={() => handleBulkStatusUpdate(\"processing\")}>\r\n                  <IconRefresh className=\"size-4 mr-2\" />\r\n                  Mark as Processing\r\n                </DropdownMenuItem>\r\n                <DropdownMenuItem onClick={() => handleBulkStatusUpdate(\"shipped\")}>\r\n                  <IconTruck className=\"size-4 mr-2\" />\r\n                  Mark as Shipped\r\n                </DropdownMenuItem>\r\n                <DropdownMenuItem onClick={() => handleBulkStatusUpdate(\"delivered\")}>\r\n                  <IconCheck className=\"size-4 mr-2\" />\r\n                  Mark as Delivered\r\n                </DropdownMenuItem>\r\n                <DropdownMenuSeparator />\r\n                <DropdownMenuItem\r\n                  onClick={() => handleBulkStatusUpdate(\"cancelled\")}\r\n                  className=\"text-destructive focus:bg-destructive-subtle focus:text-destructive\"\n                >\r\n                  <IconX className=\"size-4 mr-2\" />\r\n                  Cancel Orders\r\n                </DropdownMenuItem>\r\n              </DropdownMenuContent>\r\n            </DropdownMenu>\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              className=\"h-7\"\r\n              onClick={() => {\r\n                setSelectedIds(new Set())\r\n                setIsAllSelected(false)\r\n              }}\r\n            >\r\n              <IconX className=\"size-3.5\" />\r\n            </Button>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Orders Table */}\r\n      <div className=\"rounded-lg border bg-card\">\r\n        {filteredOrders.length === 0 ? (\r\n          <div className=\"flex flex-col items-center justify-center py-16 text-center\">\r\n            <IconPackage className=\"size-12 text-muted-foreground mb-4\" />\r\n            <h3 className=\"text-lg font-medium\">No orders found</h3>\r\n            <p className=\"text-muted-foreground max-w-sm\">\r\n              {searchQuery || statusFilter !== \"all\"\r\n                ? \"Try adjusting your search or filters\"\r\n                : \"Orders will appear here when customers purchase your products\"}\r\n            </p>\r\n          </div>\r\n        ) : (\r\n          <Table>\r\n            <TableHeader>\r\n              <TableRow className=\"hover:bg-transparent\">\r\n                <TableHead className=\"w-10\">\r\n                  <Checkbox\r\n                    checked={isAllSelected}\r\n                    onCheckedChange={toggleSelectAll}\r\n                    aria-label=\"Select all\"\r\n                  />\r\n                </TableHead>\r\n                <TableHead className=\"w-24\">Order</TableHead>\r\n                <TableHead\r\n                  className=\"cursor-pointer select-none\"\r\n                  onClick={() => handleSort(\"created_at\")}\r\n                >\r\n                  <div className=\"flex items-center gap-1\">\r\n                    Date\r\n                    {getSortIcon(\"created_at\")}\r\n                  </div>\r\n                </TableHead>\r\n                <TableHead\r\n                  className=\"cursor-pointer select-none\"\r\n                  onClick={() => handleSort(\"customer\")}\r\n                >\r\n                  <div className=\"flex items-center gap-1\">\r\n                    Customer\r\n                    {getSortIcon(\"customer\")}\r\n                  </div>\r\n                </TableHead>\r\n                <TableHead>Product</TableHead>\r\n                <TableHead className=\"text-center\">Qty</TableHead>\r\n                <TableHead\r\n                  className=\"cursor-pointer select-none text-right\"\r\n                  onClick={() => handleSort(\"total\")}\r\n                >\r\n                  <div className=\"flex items-center justify-end gap-1\">\r\n                    Total\r\n                    {getSortIcon(\"total\")}\r\n                  </div>\r\n                </TableHead>\r\n                <TableHead>Status</TableHead>\r\n                <TableHead className=\"w-10\"></TableHead>\r\n              </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n              {filteredOrders.map((item) => {\r\n                const order = getOrder(item)\r\n                const product = getProduct(item)\r\n                const customer = getCustomer(order)\r\n                const status = order?.status || \"pending\"\r\n                const statusConfig = getStatusConfig(status)\r\n                const StatusIcon = statusConfig.icon\r\n                const firstImage = product?.images?.[0]\r\n\r\n                return (\r\n                  <TableRow\r\n                    key={item.id}\r\n                    className={cn(\r\n                      \"group\",\r\n                      selectedIds.has(item.id) && \"bg-selected\"\r\n                    )}\r\n                  >\r\n                    <TableCell>\r\n                      <Checkbox\r\n                        checked={selectedIds.has(item.id)}\r\n                        onCheckedChange={() => toggleSelect(item.id)}\r\n                        aria-label={`Select order ${order?.id}`}\r\n                      />\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Link\r\n                        href={`/dashboard/orders/${order?.id}`}\r\n                        className=\"font-mono text-sm font-medium text-primary hover:underline\"\r\n                      >\r\n                        #{order?.id?.slice(0, 8)}\r\n                      </Link>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"flex flex-col\">\r\n                        <span className=\"text-sm\">\r\n                          {order?.created_at ? format(new Date(order.created_at), \"MMM d\") : \"-\"}\r\n                        </span>\r\n                        <span className=\"text-xs text-muted-foreground\">\r\n                          {order?.created_at ? format(new Date(order.created_at), \"h:mm a\") : \"\"}\r\n                        </span>\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"flex flex-col\">\r\n                        <span className=\"font-medium text-sm truncate max-w-40\">\r\n                          {customer?.full_name || \"Guest\"}\r\n                        </span>\r\n                        {customer?.email ? (\r\n                          <span className=\"text-xs text-muted-foreground truncate max-w-40\">\r\n                            {customer.email}\r\n                          </span>\r\n                        ) : null}\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"flex items-center gap-3\">\r\n                        <div className=\"relative size-10 rounded-md overflow-hidden bg-muted shrink-0\">\r\n                          {firstImage ? (\r\n                            <Image\r\n                              src={firstImage}\r\n                              alt={product?.title || \"Product\"}\r\n                              fill\r\n                              className=\"object-cover\"\r\n                            />\r\n                          ) : (\r\n                            <div className=\"flex size-full items-center justify-center\">\r\n                              <IconPackage className=\"size-4 text-muted-foreground\" />\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                        <div className=\"min-w-0\">\r\n                          <p className=\"text-sm font-medium truncate max-w-48\">\r\n                            {product?.title || \"Unknown Product\"}\r\n                          </p>\r\n                          {product?.sku && (\r\n                            <p className=\"text-xs text-muted-foreground font-mono\">\r\n                              {product.sku}\r\n                            </p>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell className=\"text-center tabular-nums\">\r\n                      {item.quantity}\r\n                    </TableCell>\r\n                    <TableCell className=\"text-right font-medium tabular-nums\">\r\n                      {formatCurrency(item.price_at_purchase * item.quantity)}\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <Badge\r\n                        variant=\"outline\"\r\n                        className={cn(\"gap-1\", statusConfig.color)}\r\n                      >\r\n                        <StatusIcon className=\"size-3\" />\r\n                        {statusConfig.label}\r\n                      </Badge>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <DropdownMenu>\r\n                        <DropdownMenuTrigger asChild>\r\n                          <Button\r\n                            variant=\"ghost\"\r\n                            size=\"icon\"\r\n                            className=\"size-8 opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                          >\r\n                            <IconDotsVertical className=\"size-4\" />\r\n                          </Button>\r\n                        </DropdownMenuTrigger>\r\n                        <DropdownMenuContent align=\"end\" className=\"w-48\">\r\n                          <DropdownMenuItem asChild>\r\n                            <Link href={`/dashboard/orders/${order?.id}`}>\r\n                              <IconEye className=\"size-4 mr-2\" />\r\n                              View Details\r\n                            </Link>\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem onClick={() => handleContactCustomer(item)}>\r\n                            <IconMessage className=\"size-4 mr-2\" />\r\n                            Contact Customer\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem>\r\n                            <IconPrinter className=\"size-4 mr-2\" />\r\n                            Print Packing Slip\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuSeparator />\r\n                          <DropdownMenuItem\r\n                            onClick={() => handleBulkStatusUpdate(\"processing\")}\r\n                            disabled={status === \"processing\"}\r\n                          >\r\n                            <IconRefresh className=\"size-4 mr-2\" />\r\n                            Mark Processing\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem\r\n                            onClick={() => handleBulkStatusUpdate(\"shipped\")}\r\n                            disabled={status === \"shipped\"}\r\n                          >\r\n                            <IconTruck className=\"size-4 mr-2\" />\r\n                            Mark Shipped\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem\r\n                            onClick={() => handleBulkStatusUpdate(\"delivered\")}\r\n                            disabled={status === \"delivered\"}\r\n                          >\r\n                            <IconCheck className=\"size-4 mr-2\" />\r\n                            Mark Delivered\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuSeparator />\r\n                          <DropdownMenuItem className=\"text-destructive focus:bg-destructive-subtle focus:text-destructive\">\n                            <IconX className=\"size-4 mr-2\" />\r\n                            Cancel Order\r\n                          </DropdownMenuItem>\r\n                        </DropdownMenuContent>\r\n                      </DropdownMenu>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                )\r\n              })}\r\n            </TableBody>\r\n          </Table>\r\n        )}\r\n      </div>\r\n\r\n      {/* Summary Footer */}\r\n      {filteredOrders.length > 0 && (\r\n        <div className=\"flex items-center justify-between text-sm text-muted-foreground\">\r\n          <span>\r\n            Showing {filteredOrders.length} of {orders.length} orders\r\n          </span>\r\n          <span className=\"font-medium text-foreground\">\r\n            Total: {formatCurrency(\r\n              filteredOrders.reduce((sum, item) => sum + (item.price_at_purchase * item.quantity), 0)\r\n            )}\r\n          </span>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\product-form-modal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\_components\\products-table.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_sellerId' is defined but never used.","line":128,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":128,"endColumn":22},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'formatPrice' to the outer scope.","line":379,"column":39,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":379,"endColumn":41}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport Image from \"next/image\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useRouter } from \"@/i18n/routing\"\r\nimport { toast } from \"sonner\"\r\nimport {\r\n  IconPlus,\r\n  IconPencil,\r\n  IconTrash,\r\n  IconExternalLink,\r\n  IconPackage,\r\n  IconSearch,\r\n  IconChevronDown,\r\n  IconChevronUp,\r\n  IconSelector,\r\n  IconCopy,\r\n  IconDownload,\r\n  IconDotsVertical,\r\n  IconX,\r\n  IconRefresh,\r\n} from \"@tabler/icons-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Checkbox } from \"@/components/ui/checkbox\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport { ProductFormModal, type ProductFormData } from \"./product-form-modal\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nexport type ProductsTableServerActions = {\r\n  createProduct: (input: ProductFormData) => Promise<{\r\n    success: boolean\r\n    data?: { id: string }\r\n    error?: string\r\n  }>\r\n  updateProduct: (productId: string, input: Partial<ProductFormData>) => Promise<{\r\n    success: boolean\r\n    error?: string\r\n  }>\r\n  deleteProduct: (productId: string) => Promise<{\r\n    success: boolean\r\n    error?: string\r\n  }>\r\n  bulkDeleteProducts: (productIds: string[]) => Promise<{\r\n    success: boolean\r\n    data?: { deleted: number }\r\n    error?: string\r\n  }>\r\n  bulkUpdateProductStatus: (\r\n    productIds: string[],\r\n    status: \"active\" | \"draft\" | \"archived\" | \"out_of_stock\"\r\n  ) => Promise<{\r\n    success: boolean\r\n    data?: { updated: number }\r\n    error?: string\r\n  }>\r\n  duplicateProduct: (productId: string) => Promise<{\r\n    success: boolean\r\n    data?: { id: string }\r\n    error?: string\r\n  }>\r\n}\r\n\r\ninterface Product {\r\n  id: string\r\n  title: string\r\n  price: number\r\n  list_price: number | null\r\n  cost_price?: number | null\r\n  sku?: string | null\r\n  barcode?: string | null\r\n  stock: number\r\n  variant_count?: number | null\r\n  track_inventory?: boolean | null\r\n  status?: string | null\r\n  weight?: number | null\r\n  weight_unit?: string | null\r\n  condition?: string | null\r\n  images: string[] | null\r\n  rating: number | null\r\n  review_count: number | null\r\n  created_at: string\r\n  updated_at?: string | null\r\n  category_id?: string | null\r\n  category?: { id: string; name: string; slug: string } | { id: string; name: string; slug: string }[] | null\r\n}\r\n\r\ninterface Category {\r\n  id: string\r\n  name: string\r\n  slug: string\r\n  parent_id: string | null\r\n  display_order?: number | null\r\n  children?: Category[]\r\n}\r\n\r\ninterface ProductsTableProps {\r\n  initialProducts: Product[]\r\n  categories: Category[]\r\n  total: number\r\n  sellerId: string\r\n  actions: ProductsTableServerActions\r\n}\r\n\r\ntype SortField = \"title\" | \"price\" | \"stock\" | \"created_at\" | \"sku\" | \"status\"\r\ntype SortOrder = \"asc\" | \"desc\"\r\ntype StatusFilter = \"all\" | \"active\" | \"draft\" | \"archived\" | \"out_of_stock\"\r\n\r\nexport function ProductsTable({\r\n  initialProducts,\r\n  categories,\r\n  total,\r\n  sellerId: _sellerId,\r\n  actions,\r\n}: ProductsTableProps) {\r\n  const router = useRouter()\r\n  const [products, setProducts] = React.useState<Product[]>(initialProducts)\r\n  const [selectedIds, setSelectedIds] = React.useState<Set<string>>(new Set())\r\n  const [isAllSelected, setIsAllSelected] = React.useState(false)\r\n  const [searchQuery, setSearchQuery] = React.useState(\"\")\r\n  const [statusFilter, setStatusFilter] = React.useState<StatusFilter>(\"all\")\r\n  const [sortField, setSortField] = React.useState<SortField>(\"created_at\")\r\n  const [sortOrder, setSortOrder] = React.useState<SortOrder>(\"desc\")\r\n  const [isModalOpen, setIsModalOpen] = React.useState(false)\r\n  const [editingProduct, setEditingProduct] = React.useState<Product | null>(null)\r\n  const [isLoading, setIsLoading] = React.useState(false)\r\n\r\n  // Count products by status\r\n  const statusCounts = React.useMemo(() => {\r\n    const counts = { all: products.length, active: 0, draft: 0, archived: 0, out_of_stock: 0 }\r\n    products.forEach((p) => {\r\n      const status = (p.status || \"draft\") as keyof typeof counts\r\n      if (status in counts) counts[status]++\r\n    })\r\n    return counts\r\n  }, [products])\r\n\r\n  // Filter and sort products\r\n  const filteredProducts = React.useMemo(() => {\r\n    let result = [...products]\r\n\r\n    // Status filter\r\n    if (statusFilter !== \"all\") {\r\n      result = result.filter((p) => (p.status || \"draft\") === statusFilter)\r\n    }\r\n\r\n    // Search filter\r\n    if (searchQuery) {\r\n      const query = searchQuery.toLowerCase()\r\n      result = result.filter((p) =>\r\n        p.title.toLowerCase().includes(query) ||\r\n        (p.variant_count ? false : (p.sku && p.sku.toLowerCase().includes(query))) ||\r\n        (p.barcode && p.barcode.toLowerCase().includes(query))\r\n      )\r\n    }\r\n\r\n    result.sort((a, b) => {\r\n      let comparison = 0\r\n      switch (sortField) {\r\n        case \"title\":\r\n          comparison = a.title.localeCompare(b.title)\r\n          break\r\n        case \"price\":\r\n          comparison = a.price - b.price\r\n          break\r\n        case \"stock\":\r\n          comparison = a.stock - b.stock\r\n          break\r\n        case \"created_at\":\r\n          comparison = new Date(a.created_at).getTime() - new Date(b.created_at).getTime()\r\n          break\r\n        case \"sku\":\r\n          comparison = (a.variant_count ? \"\" : (a.sku || \"\")).localeCompare(\r\n            b.variant_count ? \"\" : (b.sku || \"\")\r\n          )\r\n          break\r\n        case \"status\":\r\n          comparison = (a.status || \"draft\").localeCompare(b.status || \"draft\")\r\n          break\r\n      }\r\n      return sortOrder === \"asc\" ? comparison : -comparison\r\n    })\r\n\r\n    return result\r\n  }, [products, searchQuery, statusFilter, sortField, sortOrder])\r\n\r\n  const toggleSelectAll = () => {\r\n    if (isAllSelected) {\r\n      setSelectedIds(new Set())\r\n      setIsAllSelected(false)\r\n    } else {\r\n      setSelectedIds(new Set(filteredProducts.map((p) => p.id)))\r\n      setIsAllSelected(true)\r\n    }\r\n  }\r\n\r\n  const toggleSelect = (id: string) => {\r\n    const newSelected = new Set(selectedIds)\r\n    if (newSelected.has(id)) {\r\n      newSelected.delete(id)\r\n    } else {\r\n      newSelected.add(id)\r\n    }\r\n    setSelectedIds(newSelected)\r\n    setIsAllSelected(newSelected.size === filteredProducts.length)\r\n  }\r\n\r\n  const handleSort = (field: SortField) => {\r\n    if (sortField === field) {\r\n      setSortOrder(sortOrder === \"asc\" ? \"desc\" : \"asc\")\r\n    } else {\r\n      setSortField(field)\r\n      setSortOrder(\"asc\")\r\n    }\r\n  }\r\n\r\n  const handleAddProduct = () => {\r\n    setEditingProduct(null)\r\n    setIsModalOpen(true)\r\n  }\r\n\r\n  const handleEditProduct = (product: Product) => {\r\n    setEditingProduct(product)\r\n    setIsModalOpen(true)\r\n  }\r\n\r\n  const handleProductSubmit = async (data: ProductFormData) => {\r\n    setIsLoading(true)\r\n    try {\r\n      if (editingProduct) {\r\n        const result = await actions.updateProduct(editingProduct.id, data)\r\n        if (result.success) {\r\n          toast.success(\"Product updated\")\r\n          setProducts((prev) =>\r\n            prev.map((p) =>\r\n              p.id === editingProduct.id\r\n                ? {\r\n                  ...p,\r\n                  title: data.title,\r\n                  price: data.price,\r\n                  list_price: data.compareAtPrice || null,\r\n                  cost_price: data.costPrice || null,\r\n                  sku: data.sku || null,\r\n                  barcode: data.barcode || null,\r\n                  stock: data.stock,\r\n                  track_inventory: data.trackInventory ?? true,\r\n                  status: data.status || \"draft\",\r\n                  weight: data.weight || null,\r\n                  weight_unit: data.weightUnit || \"kg\",\r\n                  condition: data.condition || \"new\",\r\n                  images: data.images,\r\n                  category_id: data.categoryId || null,\r\n                  updated_at: new Date().toISOString()\r\n                }\r\n                : p\r\n            )\r\n          )\r\n          router.refresh()\r\n        } else {\r\n          toast.error(result.error || \"Failed to update\")\r\n          throw new Error(result.error)\r\n        }\r\n      } else {\r\n        const result = await actions.createProduct(data)\r\n        if (result.success && result.data) {\r\n          toast.success(\"Product created\")\r\n          const newProduct: Product = {\r\n            id: result.data.id,\r\n            title: data.title,\r\n            price: data.price,\r\n            list_price: data.compareAtPrice || null,\r\n            cost_price: data.costPrice || null,\r\n            sku: data.sku || null,\r\n            barcode: data.barcode || null,\r\n            stock: data.stock,\r\n            track_inventory: data.trackInventory ?? true,\r\n            status: data.status || \"draft\",\r\n            weight: data.weight || null,\r\n            weight_unit: data.weightUnit || \"kg\",\r\n            condition: data.condition || \"new\",\r\n            images: data.images,\r\n            rating: null,\r\n            review_count: null,\r\n            created_at: new Date().toISOString(),\r\n            category_id: data.categoryId || null,\r\n          }\r\n          setProducts((prev) => [newProduct, ...prev])\r\n          router.refresh()\r\n        } else {\r\n          toast.error(result.error || \"Failed to create\")\r\n          throw new Error(result.error)\r\n        }\r\n      }\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleBulkDelete = async () => {\r\n    if (!confirm(`Delete ${selectedIds.size} product(s)?`)) return\r\n    setIsLoading(true)\r\n    try {\r\n      const result = await actions.bulkDeleteProducts([...selectedIds])\r\n      if (result.success) {\r\n        toast.success(`${selectedIds.size} deleted`)\r\n        setProducts((prev) => prev.filter((p) => !selectedIds.has(p.id)))  \r\n        setSelectedIds(new Set())\r\n        setIsAllSelected(false)\r\n        router.refresh()\r\n      }\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleBulkStatusUpdate = async (newStatus: \"active\" | \"draft\" | \"archived\" | \"out_of_stock\") => {\r\n    setIsLoading(true)\r\n    try {\r\n      const result = await actions.bulkUpdateProductStatus([...selectedIds], newStatus)\r\n      if (result.success) {\r\n        toast.success(`${selectedIds.size} product(s) set to ${newStatus}`)\r\n        setProducts((prev) => prev.map((p) =>\r\n          selectedIds.has(p.id) ? { ...p, status: newStatus } : p\r\n        ))\r\n        setSelectedIds(new Set())\r\n        setIsAllSelected(false)\r\n        router.refresh()\r\n      } else {\r\n        toast.error(result.error || \"Failed to update status\")\r\n      }\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleDuplicate = async (productId: string) => {\r\n    setIsLoading(true)\r\n    try {\r\n      const result = await actions.duplicateProduct(productId)\r\n      if (result.success) {\r\n        toast.success(\"Product duplicated\")\r\n        router.refresh()\r\n      }\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleDelete = async (productId: string) => {\r\n    if (!confirm(\"Delete this product?\")) return\r\n    setIsLoading(true)\r\n    try {\r\n      const result = await actions.deleteProduct(productId)\r\n      if (result.success) {\r\n        toast.success(\"Product deleted\")\r\n        setProducts((prev) => prev.filter((p) => p.id !== productId))      \r\n        router.refresh()\r\n      }\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }\r\n\r\n  const formatPrice = (value: number) => `${value.toFixed(2)} ╨╗╨▓`\r\n\r\n  const SortHeader = ({ field, children, className }: { field: SortField; children: React.ReactNode; className?: string }) => (\r\n    <button\r\n      onClick={() => handleSort(field)}\r\n      className={cn(\"flex items-center gap-1 hover:text-foreground transition-colors text-xs font-medium\", className)}\r\n    >\r\n      {children}\r\n      {sortField === field ? (\r\n        sortOrder === \"asc\" ? <IconChevronUp className=\"size-3\" /> : <IconChevronDown className=\"size-3\" />\r\n      ) : (\r\n        <IconSelector className=\"size-3 opacity-40\" />\r\n      )}\r\n    </button>\r\n  )\r\n\r\n  const getCategoryName = (product: Product) => {\r\n    if (Array.isArray(product.category)) {\r\n      return product.category[0]?.name || \"ΓÇö\"\r\n    }\r\n    return product.category?.name || \"ΓÇö\"\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <div className=\"flex flex-col h-full\">\r\n        {/* Shopify-style Header */}\r\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between px-4 lg:px-6 py-4 border-b bg-background\">\r\n          <div className=\"space-y-1\">\r\n            <div className=\"flex items-center gap-3 flex-wrap\">\r\n              <h1 className=\"text-xl font-semibold\">Products</h1>\r\n              {/* Product status badges */}\r\n              <div className=\"flex items-center gap-2 flex-wrap\">\r\n                <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-muted\">\r\n                  <span className=\"tabular-nums\">{total}</span>\r\n                  <span className=\"opacity-70\">total</span>\r\n                </span>\r\n                {statusCounts.active > 0 && (\r\n                  <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-success/10 text-success border border-success/20\">\r\n                    <span className=\"tabular-nums\">{statusCounts.active}</span>\r\n                    <span className=\"opacity-70\">active</span>\r\n                  </span>\r\n                )}\r\n                {statusCounts.draft > 0 && (\r\n                  <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-warning/10 text-warning border border-warning/20\">\r\n                    <span className=\"tabular-nums\">{statusCounts.draft}</span>\r\n                    <span className=\"opacity-70\">draft</span>\r\n                  </span>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button variant=\"outline\" size=\"sm\">\r\n              <IconDownload className=\"size-4 mr-1.5\" />\r\n              Export\r\n            </Button>\r\n            <Button size=\"sm\" onClick={handleAddProduct}>\r\n              <IconPlus className=\"size-4 mr-1.5\" />\r\n              Add product\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Status Tabs */}\r\n        <div className=\"px-4 lg:px-6 border-b bg-background\">\r\n          <div className=\"flex gap-1 -mb-px\">\r\n            {([\r\n              { value: \"all\", label: \"All\" },\r\n              { value: \"active\", label: \"Active\" },\r\n              { value: \"draft\", label: \"Draft\" },\r\n              { value: \"archived\", label: \"Archived\" },\r\n              { value: \"out_of_stock\", label: \"Out of Stock\" },\r\n            ] as const).map((tab) => (\r\n              <button\r\n                key={tab.value}\r\n                onClick={() => setStatusFilter(tab.value)}\r\n                className={cn(\r\n                  \"px-3 py-2.5 text-sm font-medium border-b-2 transition-colors\",\r\n                  statusFilter === tab.value\r\n                    ? \"border-primary text-foreground\"\r\n                    : \"border-transparent text-muted-foreground hover:text-foreground hover:border-border\"\r\n                )}\r\n              >\r\n                {tab.label}\r\n                  <span className={cn(\r\n                  \"ml-1.5 text-xs px-1.5 py-0.5 rounded-full\",\r\n                  statusFilter === tab.value\r\n                    ? \"bg-selected text-primary\"\r\n                    : \"bg-muted text-muted-foreground\"\r\n                )}>\r\n                  {statusCounts[tab.value]}\r\n                </span>\r\n              </button>\r\n            ))}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Filters */}\r\n        <div className=\"px-4 lg:px-6 py-3 border-b bg-surface-subtle space-y-3\">\r\n          {/* Search */}\r\n          <div className=\"flex items-center gap-2\">\r\n            <div className=\"relative flex-1 max-w-sm\">\r\n              <IconSearch className=\"absolute left-2.5 top-1/2 -translate-y-1/2 size-4 text-muted-foreground\" />\r\n              <Input\r\n                placeholder=\"Search by name, SKU, or barcode...\"\r\n                value={searchQuery}\r\n                onChange={(e) => setSearchQuery(e.target.value)}\r\n                className=\"pl-8 h-8 text-sm\"\r\n              />\r\n              {searchQuery && (\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"icon\"\r\n                  className=\"absolute right-0.5 top-1/2 -translate-y-1/2 size-7\"\r\n                  onClick={() => setSearchQuery(\"\")}\r\n                >\r\n                  <IconX className=\"size-3\" />\r\n                </Button>\r\n              )}\r\n            </div>\r\n            {searchQuery && (\r\n              <Button variant=\"ghost\" size=\"sm\" onClick={() => setSearchQuery(\"\")} className=\"h-8 text-xs\">\r\n                <IconRefresh className=\"size-3 mr-1\" />\r\n                Clear\r\n              </Button>\r\n            )}\r\n          </div>\r\n\r\n          {/* Bulk Actions */}\r\n          {selectedIds.size > 0 && (\r\n            <div className=\"flex items-center gap-3 py-2 px-3 rounded-md bg-background border flex-wrap\">\r\n              <span className=\"text-sm font-medium\">{selectedIds.size} selected</span>\r\n              <div className=\"flex items-center gap-1.5 ml-2\">\r\n                <DropdownMenu>\r\n                  <DropdownMenuTrigger asChild>\r\n                    <Button variant=\"outline\" size=\"sm\" className=\"h-7 text-xs\" disabled={isLoading}>\r\n                      Set Status\r\n                      <IconChevronDown className=\"size-3 ml-1\" />\r\n                    </Button>\r\n                  </DropdownMenuTrigger>\r\n                  <DropdownMenuContent align=\"start\">\r\n                    <DropdownMenuItem onClick={() => handleBulkStatusUpdate(\"active\")}>\r\n                      <span className=\"size-2 rounded-full bg-success mr-2\" />\r\n                      Active\r\n                    </DropdownMenuItem>\r\n                    <DropdownMenuItem onClick={() => handleBulkStatusUpdate(\"draft\")}>\r\n                      <span className=\"size-2 rounded-full bg-muted mr-2\" />\r\n                      Draft\r\n                    </DropdownMenuItem>\r\n                    <DropdownMenuItem onClick={() => handleBulkStatusUpdate(\"archived\")}>\r\n                      <span className=\"size-2 rounded-full bg-destructive mr-2\" />\r\n                      Archived\r\n                    </DropdownMenuItem>\r\n                    <DropdownMenuItem onClick={() => handleBulkStatusUpdate(\"out_of_stock\")}>\r\n                      <span className=\"size-2 rounded-full bg-warning mr-2\" />\r\n                      Out of Stock\r\n                    </DropdownMenuItem>\r\n                  </DropdownMenuContent>\r\n                </DropdownMenu>\r\n                <Button variant=\"outline\" size=\"sm\" className=\"h-7 text-xs text-destructive hover:text-destructive\" onClick={handleBulkDelete} disabled={isLoading}>\n                  <IconTrash className=\"size-3 mr-1\" />\r\n                  Delete\r\n                </Button>\r\n              </div>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"h-7 text-xs ml-auto\"\r\n                onClick={() => { setSelectedIds(new Set()); setIsAllSelected(false) }}\r\n              >\r\n                Clear\r\n              </Button>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Table */}\r\n        <div className=\"flex-1 overflow-auto\">\r\n          {filteredProducts.length === 0 ? (\r\n            <div className=\"flex flex-col items-center justify-center py-20 text-center\">\r\n              <IconPackage className=\"size-12 text-muted-foreground mb-4\" />\r\n              <h3 className=\"font-medium mb-1\">\r\n                {searchQuery ? \"No products found\" : \"No products yet\"}\r\n              </h3>\r\n              <p className=\"text-sm text-muted-foreground mb-4\">\r\n                {searchQuery ? \"Try a different search\" : \"Add your first product to get started\"}\r\n              </p>\r\n              {!searchQuery && (\r\n                <Button size=\"sm\" onClick={handleAddProduct}>\r\n                  <IconPlus className=\"size-4 mr-1.5\" />\r\n                  Add product\r\n                </Button>\r\n              )}\r\n            </div>\r\n          ) : (\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow className=\"hover:bg-transparent bg-surface-subtle\">\r\n                  <TableHead className=\"w-10 pl-4\">\r\n                    <Checkbox checked={isAllSelected} onCheckedChange={toggleSelectAll} />\r\n                  </TableHead>\r\n                  <TableHead className=\"min-w-(--container-3xs)\">\r\n                    <SortHeader field=\"title\">Product</SortHeader>\r\n                  </TableHead>\r\n                  <TableHead className=\"w-24\">\r\n                    <SortHeader field=\"sku\">SKU</SortHeader>\r\n                  </TableHead>\r\n                  <TableHead className=\"w-24\">\r\n                    <SortHeader field=\"status\">Status</SortHeader>\r\n                  </TableHead>\r\n                  <TableHead className=\"w-28\">\r\n                    <SortHeader field=\"stock\">Inventory</SortHeader>\r\n                  </TableHead>\r\n                  <TableHead className=\"w-24\">\r\n                    <SortHeader field=\"price\">Price</SortHeader>\r\n                  </TableHead>\r\n                  <TableHead className=\"w-24\">Rating</TableHead>\r\n                  <TableHead className=\"w-10 pr-4\"></TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {filteredProducts.map((product) => (\r\n                  <TableRow\r\n                    key={product.id}\r\n                    className={cn(\r\n                      \"group cursor-pointer\",\r\n                      selectedIds.has(product.id) && \"bg-selected\"\r\n                    )}\r\n                    onClick={() => handleEditProduct(product)}\r\n                  >\r\n                    <TableCell className=\"pl-4\" onClick={(e) => e.stopPropagation()}>\r\n                      <Checkbox\r\n                        checked={selectedIds.has(product.id)}\r\n                        onCheckedChange={() => toggleSelect(product.id)}\r\n                      />\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"flex items-center gap-3\">\r\n                        {/* Image */}\r\n                        <div className=\"relative size-10 rounded-md overflow-hidden bg-muted shrink-0 border\">\r\n                          {product.images?.[0] ? (\r\n                            <Image\r\n                              src={product.images[0]}\r\n                              alt={product.title}\r\n                              fill\r\n                              className=\"object-cover\"\r\n                            />\r\n                          ) : (\r\n                            <div className=\"flex size-full items-center justify-center\">\r\n                              <IconPackage className=\"size-4 text-muted-foreground\" />\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                        {/* Title + Category */}\r\n                        <div className=\"min-w-0 flex-1\">\r\n                          <p className=\"font-medium text-sm truncate group-hover:text-primary transition-colors\">\r\n                            {product.title}\r\n                          </p>\r\n                          <p className=\"text-xs text-muted-foreground\">\r\n                            {getCategoryName(product)}\r\n                          </p>\r\n                        </div>\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <span className=\"text-xs text-muted-foreground font-mono\">\r\n                        {product.variant_count ? \"ΓÇö\" : (product.sku || \"ΓÇö\")}\r\n                      </span>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <span className={cn(\r\n                        \"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium\",\r\n                        product.status === \"active\" && \"bg-success/10 text-success border border-success/20\",\r\n                        product.status === \"draft\" && \"bg-muted text-muted-foreground border border-border\",\r\n                        product.status === \"archived\" && \"bg-destructive-subtle text-destructive border border-destructive/20\",\n                        product.status === \"out_of_stock\" && \"bg-warning/10 text-warning border border-warning/20\",\r\n                        !product.status && \"bg-muted text-muted-foreground border border-border\"\r\n                      )}>\r\n                        {product.status === \"out_of_stock\" ? \"Out of Stock\" :\r\n                          product.status ? product.status.charAt(0).toUpperCase() + product.status.slice(1) : \"Draft\"}\r\n                      </span>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <span className={cn(\r\n                        \"text-sm tabular-nums\",\r\n                        product.stock === 0 && \"text-destructive font-medium\",\r\n                        product.stock > 0 && product.stock <= 5 && \"text-warning\",\r\n                      )}>\r\n                        {product.stock === 0 ? \"Out of stock\" : `${product.stock} in stock`}\r\n                      </span>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"text-sm\">\r\n                        <span className=\"font-medium\">{formatPrice(product.price)}</span>\r\n                        {product.list_price && product.list_price > product.price && (\r\n                          <span className=\"text-xs text-muted-foreground line-through ml-1.5\">\r\n                            {formatPrice(product.list_price)}\r\n                          </span>\r\n                        )}\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell>\r\n                      <div className=\"text-sm text-muted-foreground\">\r\n                        {product.rating ? (\r\n                          <span>Γ¡É {product.rating.toFixed(1)} ({product.review_count || 0})</span>\r\n                        ) : (\r\n                          <span className=\"text-xs\">No reviews</span>\r\n                        )}\r\n                      </div>\r\n                    </TableCell>\r\n                    <TableCell className=\"pr-4\" onClick={(e) => e.stopPropagation()}>\r\n                      <DropdownMenu>\r\n                        <DropdownMenuTrigger asChild>\r\n                          <Button\r\n                            variant=\"ghost\"\r\n                            size=\"icon\"\r\n                            className=\"size-8 opacity-0 group-hover:opacity-100 transition-opacity\"\r\n                          >\r\n                            <IconDotsVertical className=\"size-4\" />\r\n                          </Button>\r\n                        </DropdownMenuTrigger>\r\n                        <DropdownMenuContent align=\"end\" className=\"w-40\">\r\n                          <DropdownMenuItem onClick={() => handleEditProduct(product)}>\r\n                            <IconPencil className=\"size-4 mr-2\" />\r\n                            Edit\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem asChild>\r\n                            <Link href={`/product/${product.id}`} target=\"_blank\">\r\n                              <IconExternalLink className=\"size-4 mr-2\" />\r\n                              View\r\n                            </Link>\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuItem onClick={() => handleDuplicate(product.id)} disabled={isLoading}>\r\n                            <IconCopy className=\"size-4 mr-2\" />\r\n                            Duplicate\r\n                          </DropdownMenuItem>\r\n                          <DropdownMenuSeparator />\r\n                          <DropdownMenuItem\r\n                            className=\"text-destructive\"\r\n                            onClick={() => handleDelete(product.id)}\r\n                            disabled={isLoading}\r\n                          >\r\n                            <IconTrash className=\"size-4 mr-2\" />\r\n                            Delete\r\n                          </DropdownMenuItem>\r\n                        </DropdownMenuContent>\r\n                      </DropdownMenu>\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ))}\r\n              </TableBody>\r\n            </Table>\r\n          )}\r\n        </div>\r\n\r\n        {/* Footer */}\r\n        {filteredProducts.length > 0 && (\r\n          <div className=\"px-4 lg:px-6 py-3 border-t bg-surface-subtle text-xs text-muted-foreground\">\r\n            Showing {filteredProducts.length} of {total} products\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <ProductFormModal\r\n        open={isModalOpen}\r\n        onOpenChange={setIsModalOpen}\r\n        product={editingProduct}\r\n        categories={categories}\r\n        onSubmit={handleProductSubmit}\r\n      />\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\_lib\\categories.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\_lib\\routes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\accounting\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\accounting\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_stats' is assigned a value but never used.","line":77,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":77,"endColumn":15},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'formatCurrency' to the outer scope.","line":79,"column":42,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":79,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { requireDashboardAccess, getBusinessDashboardStats } from \"@/lib/auth/business\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport { \r\n  IconReceipt, \r\n  IconCurrencyDollar, \r\n  IconPercentage, \r\n  IconCalculator,\r\n  IconDownload,\r\n  IconFileSpreadsheet,\r\n} from \"@tabler/icons-react\"\r\n\r\nasync function getAccountingData(sellerId: string) {\r\n  const supabase = await createClient()\r\n  \r\n  // Get profile's commission rate and financial info\r\n  const [\r\n    { data: seller },\r\n    { data: privateProfile },\r\n  ] = await Promise.all([\r\n    supabase\r\n      .from('profiles')\r\n      .select('tier')\r\n      .eq('id', sellerId)\r\n      .single(),\r\n    supabase\r\n      .from('private_profiles')\r\n      .select('commission_rate')\r\n      .eq('id', sellerId)\r\n      .maybeSingle(),\r\n  ])\r\n  \r\n  // Get completed orders with revenue (order_items doesn't have created_at, join orders)\r\n  const { data: completedOrders } = await supabase\r\n    .from('order_items')\r\n    .select('quantity, price_at_purchase, order:orders(created_at)')\r\n    .eq('seller_id', sellerId)\r\n\r\n  const totalSales = completedOrders?.reduce((sum, item) => \r\n    sum + (Number(item.price_at_purchase) * item.quantity), 0) || 0\r\n  \r\n  const commissionRate = Number(privateProfile?.commission_rate ?? 0)\r\n  const totalCommission = totalSales * (commissionRate / 100)\r\n  const netEarnings = totalSales - totalCommission\r\n  \r\n  return {\r\n    totalSales,\r\n    commissionRate,\r\n    totalCommission,\r\n    netEarnings,\r\n    tier: seller?.tier || 'basic',\r\n    ordersCount: completedOrders?.length || 0,\r\n  }\r\n}\r\n\r\nexport default async function BusinessAccountingPage() {\r\n  // Requires paid business subscription\r\n  const businessSeller = await requireDashboardAccess()\r\n  const accountingData = await getAccountingData(businessSeller.id)\r\n  // Note: Stats are available if needed for additional visualizations\r\n  const _stats = await getBusinessDashboardStats(businessSeller.id)\r\n  \r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat('en-US', {\r\n      style: 'currency',\r\n      currency: 'BGN',\r\n      maximumFractionDigits: 2,\r\n    }).format(value)\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6 px-4 lg:px-6\">\r\n      {/* Shopify-style Header */}\r\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between\">\r\n        <div className=\"space-y-1\">\r\n          <div className=\"flex items-center gap-3 flex-wrap\">\r\n            <h1 className=\"text-2xl font-bold tracking-tight\">Finances</h1>\r\n            {/* Key financial metrics as badges */}\r\n            <div className=\"flex items-center gap-2 flex-wrap\">\r\n              <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border border-success/20 bg-success/10 text-success\">\r\n                <IconCurrencyDollar className=\"size-3\" />\r\n                <span className=\"tabular-nums\">{formatCurrency(accountingData.netEarnings)}</span>\r\n                <span className=\"opacity-70\">net</span>\r\n              </span>\r\n              <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-muted\">\r\n                <IconReceipt className=\"size-3\" />\r\n                <span className=\"tabular-nums\">{accountingData.ordersCount}</span>\r\n                <span className=\"opacity-70\">orders</span>\r\n              </span>\r\n              <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border border-warning/20 bg-warning/10 text-warning\">\r\n                <IconPercentage className=\"size-3\" />\r\n                <span className=\"tabular-nums\">{accountingData.commissionRate}%</span>\r\n                <span className=\"opacity-70\">fee</span>\r\n              </span>\r\n            </div>\r\n          </div>\r\n          <p className=\"text-muted-foreground text-sm\">\r\n            {accountingData.tier.charAt(0).toUpperCase() + accountingData.tier.slice(1)} tier ┬╖ {formatCurrency(accountingData.totalSales)} gross sales\r\n          </p>\r\n        </div>\r\n        <div className=\"flex gap-2\">\r\n          <Button variant=\"outline\" size=\"sm\">\r\n            <IconDownload className=\"size-4 mr-2\" />\r\n            Export\r\n          </Button>\r\n          <Button variant=\"outline\" size=\"sm\">\r\n            <IconFileSpreadsheet className=\"size-4 mr-2\" />\r\n            Tax Report\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Financial Summary Cards */}\r\n      <div className=\"grid gap-4 md:grid-cols-4\">\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconCurrencyDollar className=\"size-4\" />\r\n              Total Sales\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums\">\r\n              {formatCurrency(accountingData.totalSales)}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Gross revenue from {accountingData.ordersCount} orders\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconPercentage className=\"size-4\" />\r\n              Commission Rate\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums\">\r\n              {accountingData.commissionRate}%\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <Badge variant=\"outline\" className=\"text-xs\">\r\n              {accountingData.tier} tier\r\n            </Badge>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconCalculator className=\"size-4\" />\r\n              Total Commission\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums text-destructive\">\r\n              -{formatCurrency(accountingData.totalCommission)}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Platform fees\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconReceipt className=\"size-4\" />\r\n              Net Earnings\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums text-success\">\r\n              {formatCurrency(accountingData.netEarnings)}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Your take-home amount\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Commission Breakdown */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Commission Breakdown</CardTitle>\r\n          <CardDescription>\r\n            Understand how your fees are calculated\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <Table>\r\n            <TableHeader>\r\n              <TableRow>\r\n                <TableHead>Fee Type</TableHead>\r\n                <TableHead>Description</TableHead>\r\n                <TableHead>Rate</TableHead>\r\n                <TableHead className=\"text-right\">Amount</TableHead>\r\n              </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n              <TableRow>\r\n                <TableCell className=\"font-medium\">Base Commission</TableCell>\r\n                <TableCell className=\"text-muted-foreground\">\r\n                  Platform fee on each sale\r\n                </TableCell>\r\n                <TableCell>{accountingData.commissionRate}%</TableCell>\r\n                <TableCell className=\"text-right tabular-nums\">\r\n                  {formatCurrency(accountingData.totalCommission)}\r\n                </TableCell>\r\n              </TableRow>\r\n              <TableRow>\r\n                <TableCell className=\"font-medium\">Payment Processing</TableCell>\r\n                <TableCell className=\"text-muted-foreground\">\r\n                  Stripe processing fees (included)\r\n                </TableCell>\r\n                <TableCell>Included</TableCell>\r\n                <TableCell className=\"text-right tabular-nums text-muted-foreground\">\r\n                  {formatCurrency(0)}\r\n                </TableCell>\r\n              </TableRow>\r\n              <TableRow>\r\n                <TableCell className=\"font-medium\">Listing Fees</TableCell>\r\n                <TableCell className=\"text-muted-foreground\">\r\n                  Free for business accounts\r\n                </TableCell>\r\n                <TableCell>Free</TableCell>\r\n                <TableCell className=\"text-right tabular-nums text-muted-foreground\">\r\n                  {formatCurrency(0)}\r\n                </TableCell>\r\n              </TableRow>\r\n              <TableRow className=\"bg-surface-subtle\">\r\n                <TableCell className=\"font-bold\">Total Fees</TableCell>\r\n                <TableCell></TableCell>\r\n                <TableCell></TableCell>\r\n                <TableCell className=\"text-right font-bold tabular-nums\">\r\n                  {formatCurrency(accountingData.totalCommission)}\r\n                </TableCell>\r\n              </TableRow>\r\n            </TableBody>\r\n          </Table>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Payout Summary */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Earnings Summary</CardTitle>\r\n          <CardDescription>\r\n            Your financial overview\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"space-y-4\">\r\n            <div className=\"flex items-center justify-between py-2 border-b\">\r\n              <span className=\"text-muted-foreground\">Gross Sales</span>\r\n              <span className=\"font-medium tabular-nums\">{formatCurrency(accountingData.totalSales)}</span>\r\n            </div>\r\n            <div className=\"flex items-center justify-between py-2 border-b\">\r\n              <span className=\"text-muted-foreground\">Commission ({accountingData.commissionRate}%)</span>\r\n              <span className=\"font-medium tabular-nums text-destructive\">-{formatCurrency(accountingData.totalCommission)}</span>\r\n            </div>\r\n            <div className=\"flex items-center justify-between py-2\">\r\n              <span className=\"font-bold\">Net Earnings</span>\r\n              <span className=\"font-bold text-xl tabular-nums text-success\">{formatCurrency(accountingData.netEarnings)}</span>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Business Information */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Business Information</CardTitle>\r\n          <CardDescription>\r\n            Your business details for invoicing\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"grid gap-4 md:grid-cols-2\">\r\n            <div>\r\n              <p className=\"text-sm text-muted-foreground\">Business Name</p>\r\n              <p className=\"font-medium\">{businessSeller.business_name || businessSeller.store_name}</p>\r\n            </div>\r\n            <div>\r\n              <p className=\"text-sm text-muted-foreground\">Account Type</p>\r\n              <Badge variant=\"outline\" className=\"mt-1\">\r\n                {businessSeller.account_type === 'business' ? 'Business Account' : 'Personal Account'}\r\n              </Badge>\r\n            </div>\r\n            <div>\r\n              <p className=\"text-sm text-muted-foreground\">Verification Status</p>\r\n              <Badge \r\n                variant=\"outline\" \r\n                className={businessSeller.is_verified_business \r\n                  ? 'mt-1 border-success/20 bg-success/10 text-success' \r\n                  : 'mt-1'\r\n                }\r\n              >\r\n                {businessSeller.is_verified_business ? 'Verified Business' : 'Not Verified'}\r\n              </Badge>\r\n            </div>\r\n            <div>\r\n              <p className=\"text-sm text-muted-foreground\">Subscription Tier</p>\r\n              <Badge variant=\"outline\" className=\"mt-1\">\r\n                {businessSeller.tier}\r\n              </Badge>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\analytics\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\analytics\\page.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'formatCurrency' to the outer scope.","line":18,"column":42,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":18,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { requireDashboardAccess, getBusinessDashboardStats } from \"@/lib/auth/business\"\r\nimport { ChartAreaInteractive } from \"@/components/shared/charts/chart-area-interactive\"\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { IconChartBar, IconTrendingUp, IconCurrencyDollar, IconEye, IconShoppingCart } from \"@tabler/icons-react\"\r\n\r\nexport default async function BusinessAnalyticsPage() {\r\n  // Requires paid business subscription\r\n  const businessSeller = await requireDashboardAccess()\r\n  const stats = await getBusinessDashboardStats(businessSeller.id)\r\n  \r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat('en-US', {\r\n      style: 'currency',\r\n      currency: 'BGN',\r\n      maximumFractionDigits: 2,\r\n    }).format(value)\r\n  }\r\n\r\n  // Calculate average order value\r\n  const avgOrderValue = stats.totals.orders > 0 \r\n    ? stats.totals.revenue / stats.totals.orders \r\n    : 0\r\n\r\n  // Calculate conversion rate (orders / views * 100)\r\n  const conversionRate = stats.totals.views > 0 \r\n    ? (stats.totals.orders / stats.totals.views * 100) \r\n    : 0\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6 px-4 lg:px-6\">\r\n      {/* Shopify-style Header with Key Metrics */}\r\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between\">\r\n        <div className=\"space-y-1\">\r\n          <div className=\"flex items-center gap-3 flex-wrap\">\r\n            <h1 className=\"text-2xl font-bold tracking-tight\">Analytics</h1>\r\n            {/* Key metrics as compact badges */}\r\n            <div className=\"flex items-center gap-2 flex-wrap\">\r\n              <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border border-success/20 bg-success/10 text-success\">\r\n                <IconCurrencyDollar className=\"size-3\" />\r\n                <span className=\"tabular-nums\">{formatCurrency(stats.totals.revenue)}</span>\r\n                <span className=\"opacity-70\">revenue</span>\r\n              </span>\r\n              <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border border-info/20 bg-info/10 text-info\">\r\n                <IconEye className=\"size-3\" />\r\n                <span className=\"tabular-nums\">{stats.totals.views.toLocaleString()}</span>\r\n                <span className=\"opacity-70\">views</span>\r\n              </span>\r\n              <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border border-selected-border bg-selected text-primary\">\r\n                <IconTrendingUp className=\"size-3\" />\r\n                <span className=\"tabular-nums\">{conversionRate.toFixed(1)}%</span>\r\n                <span className=\"opacity-70\">conversion</span>\r\n              </span>\r\n            </div>\r\n          </div>\r\n          <p className=\"text-muted-foreground text-sm\">\r\n            Last 30 days ┬╖ Avg order {formatCurrency(avgOrderValue)}\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Key Metrics Cards */}\r\n      <div className=\"grid gap-4 md:grid-cols-4\">\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconCurrencyDollar className=\"size-4\" />\r\n              Total Revenue\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums\">\r\n              {formatCurrency(stats.totals.revenue)}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Last 30 days\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconShoppingCart className=\"size-4\" />\r\n              Avg Order Value\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums\">\r\n              {formatCurrency(avgOrderValue)}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Per transaction\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconEye className=\"size-4\" />\r\n              Total Views\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums\">\r\n              {stats.totals.views.toLocaleString()}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Product page visits\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconTrendingUp className=\"size-4\" />\r\n              Conversion Rate\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums\">\r\n              {conversionRate.toFixed(2)}%\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Views to orders\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Revenue Chart */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Sales Overview</CardTitle>\r\n          <CardDescription>\r\n            Track your revenue trends over time\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <ChartAreaInteractive />\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Performance Summary */}\r\n      <div className=\"grid gap-4 md:grid-cols-2\">\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle className=\"text-base\">Store Performance</CardTitle>\r\n            <CardDescription>Key metrics summary</CardDescription>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"space-y-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <span className=\"text-muted-foreground\">Total Products</span>\r\n                <span className=\"font-medium\">{stats.totals.products}</span>\r\n              </div>\r\n              <div className=\"flex items-center justify-between\">\r\n                <span className=\"text-muted-foreground\">Total Orders</span>\r\n                <span className=\"font-medium\">{stats.totals.orders}</span>\r\n              </div>\r\n              <div className=\"flex items-center justify-between\">\r\n                <span className=\"text-muted-foreground\">Total Revenue</span>\r\n                <span className=\"font-medium text-success\">{formatCurrency(stats.totals.revenue)}</span>\r\n              </div>\r\n              <div className=\"flex items-center justify-between\">\r\n                <span className=\"text-muted-foreground\">Store Rating</span>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <span className=\"font-medium\">{stats.totals.rating.toFixed(1)}</span>\r\n                  <Badge variant=\"outline\" className=\"text-xs\">\r\n                    {stats.totals.totalReviews} reviews\r\n                  </Badge>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle className=\"text-base\">Tips to Improve</CardTitle>\r\n            <CardDescription>Suggestions for better performance</CardDescription>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"space-y-3\">\r\n              {stats.totals.products < 10 && (\r\n                <div className=\"flex items-start gap-3 p-3 rounded-lg bg-surface-subtle\">\r\n                  <IconChartBar className=\"size-5 text-info mt-0.5\" />\r\n                  <div>\r\n                    <p className=\"font-medium text-sm\">Add more products</p>\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      Stores with 10+ products get more visibility\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              )}\r\n              {stats.totals.views < 100 && (\r\n                <div className=\"flex items-start gap-3 p-3 rounded-lg bg-surface-subtle\">\r\n                  <IconEye className=\"size-5 text-primary mt-0.5\" />\r\n                  <div>\r\n                    <p className=\"font-medium text-sm\">Boost your listings</p>\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      Boosted products appear higher in search results\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              )}\r\n              {conversionRate < 2 && (\r\n                <div className=\"flex items-start gap-3 p-3 rounded-lg bg-surface-subtle\">\r\n                  <IconTrendingUp className=\"size-5 text-success mt-0.5\" />\r\n                  <div>\r\n                    <p className=\"font-medium text-sm\">Improve product photos</p>\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                      High-quality images can increase conversion by 30%\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\customers\\loading.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":2,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardHeader"},"fix":{"range":[79,91],"text":""},"desc":"Remove unused variable \"CardHeader\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Skeleton } from \"@/components/ui/skeleton\"\r\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\"\r\n\r\nexport default function DashboardCustomersLoading() {\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6\">\r\n      {/* Header */}\r\n      <div className=\"px-4 lg:px-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n        <div className=\"space-y-2\">\r\n          <Skeleton className=\"h-8 w-32\" />\r\n          <Skeleton className=\"h-4 w-64\" />\r\n        </div>\r\n        <Skeleton className=\"h-9 w-32\" />\r\n      </div>\r\n\r\n      {/* Stats Cards */}\r\n      <div className=\"grid gap-4 px-4 lg:px-6 sm:grid-cols-2 lg:grid-cols-4\">\r\n        {[1, 2, 3, 4].map((i) => (\r\n          <Card key={i}>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center gap-3\">\r\n                <Skeleton className=\"size-10 rounded-full\" />\r\n                <div className=\"space-y-1.5\">\r\n                  <Skeleton className=\"h-4 w-24\" />\r\n                  <Skeleton className=\"h-6 w-12\" />\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        ))}\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <div className=\"px-4 lg:px-6 flex flex-col sm:flex-row gap-3\">\r\n        <Skeleton className=\"h-10 flex-1\" />\r\n        <div className=\"flex gap-2\">\r\n          <Skeleton className=\"h-10 w-28\" />\r\n          <Skeleton className=\"h-10 w-28\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Customers Table */}\r\n      <div className=\"px-4 lg:px-6\">\r\n        <Card>\r\n          <CardContent className=\"p-0\">\r\n            <div className=\"hidden md:block\">\r\n              <div className=\"grid grid-cols-6 gap-4 p-4 border-b bg-surface-subtle\">\r\n                <Skeleton className=\"h-4 w-24 col-span-2\" />\r\n                <Skeleton className=\"h-4 w-16\" />\r\n                <Skeleton className=\"h-4 w-20\" />\r\n                <Skeleton className=\"h-4 w-20\" />\r\n                <Skeleton className=\"h-4 w-16\" />\r\n              </div>\r\n              {[1, 2, 3, 4, 5, 6].map((i) => (\r\n                <div key={i} className=\"grid grid-cols-6 gap-4 p-4 border-b last:border-0 items-center\">\r\n                  <div className=\"col-span-2 flex items-center gap-3\">\r\n                    <Skeleton className=\"size-10 rounded-full\" />\r\n                    <div className=\"space-y-1.5\">\r\n                      <Skeleton className=\"h-4 w-32\" />\r\n                      <Skeleton className=\"h-3 w-40\" />\r\n                    </div>\r\n                  </div>\r\n                  <Skeleton className=\"h-4 w-8\" />\r\n                  <Skeleton className=\"h-4 w-20\" />\r\n                  <Skeleton className=\"h-4 w-24\" />\r\n                  <Skeleton className=\"h-8 w-8 rounded\" />\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\customers\\page.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'formatCurrency' to the outer scope.","line":36,"column":42,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":36,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { requireDashboardAccess, getBusinessCustomers } from \"@/lib/auth/business\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { format } from \"date-fns\"\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { UserAvatar } from \"@/components/shared/user-avatar\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport { BusinessEmptyState } from \"../../_components/business-empty-state\"\r\nimport {\r\n  IconUsers,\r\n  IconMessage,\r\n  IconTrendingUp,\r\n  IconShoppingCart,\r\n  IconCurrencyDollar,\r\n} from \"@tabler/icons-react\"\r\n\r\nexport default async function BusinessCustomersPage() {\r\n  // Requires paid business subscription\r\n  const businessSeller = await requireDashboardAccess()\r\n  const { customers, total } = await getBusinessCustomers(businessSeller.id)\r\n\r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat('en-US', {\r\n      style: 'currency',\r\n      currency: 'BGN',\r\n      maximumFractionDigits: 2,\r\n    }).format(value)\r\n  }\r\n\r\n  // Calculate summary stats\r\n  const totalRevenue = customers.reduce((sum, c) => sum + c.total_spent, 0)\r\n  const avgOrderValue = total > 0 ? totalRevenue / customers.reduce((sum, c) => sum + c.total_orders, 0) : 0\r\n  const repeatCustomers = customers.filter(c => c.total_orders > 1).length\r\n\r\n  if (total === 0) {\r\n    return <BusinessEmptyState type=\"customers\" />\r\n  }\r\n\r\n  const returnRate = total > 0 ? Math.round((repeatCustomers / total) * 100) : 0\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6 px-4 lg:px-6\">\r\n      {/* Shopify-style Header */}\r\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between\">\r\n        <div className=\"space-y-1\">\r\n          <div className=\"flex items-center gap-3 flex-wrap\">\r\n            <h1 className=\"text-2xl font-bold tracking-tight\">Customers</h1>\r\n            {/* Customer metrics as badges */}\r\n            <div className=\"flex items-center gap-2 flex-wrap\">\r\n              <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border border-info/20 bg-info/10 text-info\">\r\n                <IconUsers className=\"size-3\" />\r\n                <span className=\"tabular-nums\">{total.toLocaleString()}</span>\r\n                <span className=\"opacity-70\">total</span>\r\n              </span>\r\n              <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border border-success/20 bg-success/10 text-success\">\r\n                <IconTrendingUp className=\"size-3\" />\r\n                <span className=\"tabular-nums\">{repeatCustomers}</span>\r\n                <span className=\"opacity-70\">repeat ({returnRate}%)</span>\r\n              </span>\r\n              <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border border-selected-border bg-selected text-primary\">\r\n                <IconCurrencyDollar className=\"size-3\" />\r\n                <span className=\"tabular-nums\">{formatCurrency(totalRevenue)}</span>\r\n                <span className=\"opacity-70\">lifetime</span>\r\n              </span>\r\n            </div>\r\n          </div>\r\n          <p className=\"text-muted-foreground text-sm\">\r\n            Avg order value {formatCurrency(avgOrderValue)} ┬╖ {customers.reduce((sum, c) => sum + c.total_orders, 0)} total orders\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Customer Summary Cards */}\r\n      <div className=\"grid gap-4 md:grid-cols-4\">\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconUsers className=\"size-4\" />\r\n              Total Customers\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums\">\r\n              {total.toLocaleString()}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Unique buyers\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconTrendingUp className=\"size-4 text-success\" />\r\n              Repeat Customers\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums text-success\">\r\n              {repeatCustomers.toLocaleString()}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              {returnRate}% return rate\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconCurrencyDollar className=\"size-4\" />\r\n              Total Revenue\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums\">\r\n              {formatCurrency(totalRevenue)}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              From all customers\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconShoppingCart className=\"size-4\" />\r\n              Avg Order Value\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums\">\r\n              {formatCurrency(avgOrderValue)}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Per transaction\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Customers Table */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg\">All Customers</CardTitle>\r\n          <CardDescription>\r\n            Customers who have purchased from your store\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <Table>\r\n            <TableHeader>\r\n              <TableRow>\r\n                <TableHead>Customer</TableHead>\r\n                <TableHead>Orders</TableHead>\r\n                <TableHead>Total Spent</TableHead>\r\n                <TableHead>Last Order</TableHead>\r\n                <TableHead className=\"text-right\">Actions</TableHead>\r\n              </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n              {customers.map((customer) => (\r\n                <TableRow key={customer.id}>\r\n                  <TableCell>\r\n                    <div className=\"flex items-center gap-3\">\r\n                      <UserAvatar\r\n                        name={customer.full_name || \"Customer\"}\r\n                        avatarUrl={customer.avatar_url ?? null}\r\n                        className=\"size-8\"\r\n                        fallbackClassName=\"text-xs\"\r\n                      />\r\n                      <div>\r\n                        <p className=\"font-medium text-sm\">\r\n                          {customer.full_name || \"Anonymous\"}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    <Badge variant=\"secondary\" className=\"font-normal\">\r\n                      {customer.total_orders} order{customer.total_orders !== 1 ? 's' : ''}\r\n                    </Badge>\r\n                  </TableCell>\r\n                  <TableCell className=\"font-medium tabular-nums\">\r\n                    {formatCurrency(customer.total_spent)}\r\n                  </TableCell>\r\n                  <TableCell className=\"text-muted-foreground text-sm\">\r\n                    {format(new Date(customer.last_order), \"MMM d, yyyy\")}\r\n                  </TableCell>\r\n                  <TableCell className=\"text-right\">\r\n                    <div className=\"flex items-center justify-end gap-1\">\r\n                      <Button variant=\"ghost\" size=\"icon\" className=\"size-8\" asChild>\r\n                        <Link href={`/messages?user=${customer.id}`}>\r\n                          <IconMessage className=\"size-4\" />\r\n                        </Link>\r\n                      </Button>\r\n                    </div>\r\n                  </TableCell>\r\n                </TableRow>\r\n              ))}\r\n            </TableBody>\r\n          </Table>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\discounts\\loading.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":2,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardHeader"},"fix":{"range":[79,91],"text":""},"desc":"Remove unused variable \"CardHeader\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Skeleton } from \"@/components/ui/skeleton\"\r\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\"\r\n\r\nexport default function DashboardDiscountsLoading() {\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6\">\r\n      {/* Header */}\r\n      <div className=\"px-4 lg:px-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n        <div className=\"space-y-2\">\r\n          <Skeleton className=\"h-8 w-32\" />\r\n          <Skeleton className=\"h-4 w-64\" />\r\n        </div>\r\n        <Skeleton className=\"h-9 w-40\" />\r\n      </div>\r\n\r\n      {/* Stats Cards */}\r\n      <div className=\"grid gap-4 px-4 lg:px-6 sm:grid-cols-3\">\r\n        {[1, 2, 3].map((i) => (\r\n          <Card key={i}>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center gap-3\">\r\n                <Skeleton className=\"size-10 rounded-full\" />\r\n                <div className=\"space-y-1.5\">\r\n                  <Skeleton className=\"h-4 w-28\" />\r\n                  <Skeleton className=\"h-6 w-12\" />\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        ))}\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <div className=\"px-4 lg:px-6 flex flex-col sm:flex-row gap-3\">\r\n        <Skeleton className=\"h-10 flex-1\" />\r\n        <div className=\"flex gap-2\">\r\n          <Skeleton className=\"h-10 w-28\" />\r\n          <Skeleton className=\"h-10 w-28\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Discounts List */}\r\n      <div className=\"px-4 lg:px-6\">\r\n        <Card>\r\n          <CardContent className=\"p-0 divide-y\">\r\n            {[1, 2, 3, 4, 5].map((i) => (\r\n              <div key={i} className=\"p-4 flex items-center gap-4\">\r\n                <Skeleton className=\"size-12 rounded-lg\" />\r\n                <div className=\"flex-1 space-y-2\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <Skeleton className=\"h-5 w-32\" />\r\n                    <Skeleton className=\"h-5 w-16 rounded-full\" />\r\n                  </div>\r\n                  <Skeleton className=\"h-4 w-48\" />\r\n                  <div className=\"flex gap-4\">\r\n                    <Skeleton className=\"h-3 w-24\" />\r\n                    <Skeleton className=\"h-3 w-20\" />\r\n                  </div>\r\n                </div>\r\n                <div className=\"flex gap-2\">\r\n                  <Skeleton className=\"h-8 w-8 rounded\" />\r\n                  <Skeleton className=\"h-8 w-8 rounded\" />\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\discounts\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_sellerId' is defined but never used.","line":34,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":46},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'formatCurrency' to the outer scope.","line":59,"column":42,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":59,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { requireDashboardAccess } from \"@/lib/auth/business\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { format } from \"date-fns\"\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport { BusinessEmptyState } from \"../../_components/business-empty-state\"\r\nimport {\r\n  IconTag,\r\n  IconPlus,\r\n  IconPercentage,\r\n  IconCurrencyDollar,\r\n  IconUsers,\r\n  IconCopy,\r\n  IconPencil,\r\n  IconTrash,\r\n} from \"@tabler/icons-react\"\r\n\r\n// Placeholder function - would need actual discounts table\r\nasync function getBusinessDiscounts(_sellerId: string) {\r\n  // This is a placeholder - you'd need to create a discounts table\r\n  // For now, return empty to demonstrate the UI\r\n  return {\r\n    discounts: [] as Array<{\r\n      id: string\r\n      code: string\r\n      type: 'percentage' | 'fixed'\r\n      value: number\r\n      min_order_value: number | null\r\n      usage_limit: number | null\r\n      usage_count: number\r\n      starts_at: string\r\n      ends_at: string | null\r\n      status: 'active' | 'expired' | 'scheduled' | 'disabled'\r\n    }>,\r\n    total: 0,\r\n  }\r\n}\r\n\r\nexport default async function BusinessDiscountsPage() {\r\n  // Requires paid business subscription\r\n  const businessSeller = await requireDashboardAccess()\r\n  const { discounts, total } = await getBusinessDiscounts(businessSeller.id)\r\n\r\n  const formatCurrency = (value: number) => {\r\n    return new Intl.NumberFormat('en-US', {\r\n      style: 'currency',\r\n      currency: 'BGN',\r\n      maximumFractionDigits: 2,\r\n    }).format(value)\r\n  }\r\n\r\n  const getStatusBadge = (status: string) => {\r\n    switch (status) {\r\n      case 'active':\r\n        return <Badge variant=\"outline\" className=\"bg-success/10 text-success border-success/20\">Active</Badge>\r\n      case 'scheduled':\r\n        return <Badge variant=\"outline\" className=\"bg-selected text-primary border-selected-border\">Scheduled</Badge>\r\n      case 'expired':\r\n        return <Badge variant=\"outline\" className=\"bg-muted text-muted-foreground border-border\">Expired</Badge>\r\n      case 'disabled':\n        return <Badge variant=\"outline\" className=\"bg-destructive-subtle text-destructive border-destructive/20\">Disabled</Badge>\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>\n    }\n  }\n\r\n  if (total === 0) {\r\n    return <BusinessEmptyState type=\"discounts\" />\r\n  }\r\n\r\n  // Calculate summary stats\r\n  const activeDiscounts = discounts.filter(d => d.status === 'active').length\r\n  const totalUsage = discounts.reduce((sum, d) => sum + d.usage_count, 0)\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6 px-4 lg:px-6\">\r\n      {/* Shopify-style Header */}\r\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between\">\r\n        <div className=\"space-y-1\">\r\n          <div className=\"flex items-center gap-3 flex-wrap\">\r\n            <h1 className=\"text-2xl font-bold tracking-tight\">Discounts</h1>\r\n            {/* Discount metrics as badges */}\r\n            <div className=\"flex items-center gap-2 flex-wrap\">\r\n              <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-muted\">\r\n                <IconTag className=\"size-3\" />\r\n                <span className=\"tabular-nums\">{total}</span>\r\n                <span className=\"opacity-70\">codes</span>\r\n              </span>\r\n              <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-success/10 text-success border border-success/20\">\r\n                <span className=\"tabular-nums\">{activeDiscounts}</span>\r\n                <span className=\"opacity-70\">active</span>\r\n              </span>\r\n              <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-selected text-primary border border-selected-border\">\r\n                <IconUsers className=\"size-3\" />\r\n                <span className=\"tabular-nums\">{totalUsage}</span>\r\n                <span className=\"opacity-70\">uses</span>\r\n              </span>\r\n            </div>\r\n          </div>\r\n          <p className=\"text-muted-foreground text-sm\">\r\n            Create and manage promotional codes\r\n          </p>\r\n        </div>\r\n        <Button asChild>\r\n          <Link href=\"/dashboard/discounts/new\">\r\n            <IconPlus className=\"size-4 mr-2\" />\r\n            Create discount\r\n          </Link>\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Discount Summary Cards */}\r\n      <div className=\"grid gap-4 md:grid-cols-4\">\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconTag className=\"size-4\" />\r\n              Total Discounts\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums\">\r\n              {total.toLocaleString()}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Discount codes created\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconPercentage className=\"size-4 text-success\" />\r\n              Active\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums text-success\">\r\n              {activeDiscounts.toLocaleString()}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Currently active codes\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconUsers className=\"size-4\" />\r\n              Total Uses\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums\">\r\n              {totalUsage.toLocaleString()}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Times discounts used\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardDescription className=\"flex items-center gap-2\">\r\n              <IconCurrencyDollar className=\"size-4\" />\r\n              Revenue Impact\r\n            </CardDescription>\r\n            <CardTitle className=\"text-2xl tabular-nums\">\r\n              --\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Coming soon\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Discounts Table */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg\">All Discounts</CardTitle>\r\n          <CardDescription>\r\n            Manage your discount codes and promotions\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <Table>\r\n            <TableHeader>\r\n              <TableRow>\r\n                <TableHead>Code</TableHead>\r\n                <TableHead>Type</TableHead>\r\n                <TableHead>Value</TableHead>\r\n                <TableHead>Usage</TableHead>\r\n                <TableHead>Status</TableHead>\r\n                <TableHead>Expires</TableHead>\r\n                <TableHead className=\"text-right\">Actions</TableHead>\r\n              </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n              {discounts.map((discount) => (\r\n                <TableRow key={discount.id}>\r\n                  <TableCell>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <code className=\"text-sm font-mono bg-muted px-2 py-0.5 rounded\">\r\n                        {discount.code}\r\n                      </code>\r\n                      <Button variant=\"ghost\" size=\"icon\" className=\"size-6\">\r\n                        <IconCopy className=\"size-3\" />\r\n                      </Button>\r\n                    </div>\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    <div className=\"flex items-center gap-1\">\r\n                      {discount.type === 'percentage' ? (\r\n                        <IconPercentage className=\"size-3.5 text-muted-foreground\" />\r\n                      ) : (\r\n                        <IconCurrencyDollar className=\"size-3.5 text-muted-foreground\" />\r\n                      )}\r\n                      <span className=\"capitalize\">{discount.type}</span>\r\n                    </div>\r\n                  </TableCell>\r\n                  <TableCell className=\"font-medium\">\r\n                    {discount.type === 'percentage'\r\n                      ? `${discount.value}%`\r\n                      : formatCurrency(discount.value)\r\n                    }\r\n                  </TableCell>\r\n                  <TableCell>\r\n                    {discount.usage_count}\r\n                    {discount.usage_limit && (\r\n                      <span className=\"text-muted-foreground\">/{discount.usage_limit}</span>\r\n                    )}\r\n                  </TableCell>\r\n                  <TableCell>{getStatusBadge(discount.status)}</TableCell>\r\n                  <TableCell className=\"text-muted-foreground text-sm\">\r\n                    {discount.ends_at\r\n                      ? format(new Date(discount.ends_at), \"MMM d, yyyy\")\r\n                      : \"No expiry\"\r\n                    }\r\n                  </TableCell>\r\n                  <TableCell className=\"text-right\">\r\n                    <div className=\"flex items-center justify-end gap-1\">\r\n                      <Button variant=\"ghost\" size=\"icon\" className=\"size-8\">\r\n                        <IconPencil className=\"size-4\" />\r\n                      </Button>\r\n                      <Button variant=\"ghost\" size=\"icon\" className=\"size-8 text-destructive\">\r\n                        <IconTrash className=\"size-4\" />\r\n                      </Button>\r\n                    </div>\r\n                  </TableCell>\r\n                </TableRow>\r\n              ))}\r\n            </TableBody>\r\n          </Table>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\inventory\\_components\\inventory-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\inventory\\_lib\\format-currency.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\inventory\\loading.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":2,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardHeader"},"fix":{"range":[79,91],"text":""},"desc":"Remove unused variable \"CardHeader\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Skeleton } from \"@/components/ui/skeleton\"\r\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\"\r\n\r\nexport default function DashboardInventoryLoading() {\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6\">\r\n      {/* Header */}\r\n      <div className=\"px-4 lg:px-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n        <div className=\"space-y-2\">\r\n          <Skeleton className=\"h-8 w-32\" />\r\n          <Skeleton className=\"h-4 w-64\" />\r\n        </div>\r\n        <div className=\"flex gap-2\">\r\n          <Skeleton className=\"h-9 w-28\" />\r\n          <Skeleton className=\"h-9 w-32\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Alerts */}\r\n      <div className=\"px-4 lg:px-6 grid gap-4 sm:grid-cols-3\">\r\n        {[1, 2, 3].map((i) => (\r\n          <Card key={i}>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center gap-3\">\r\n                <Skeleton className=\"size-10 rounded-full\" />\r\n                <div className=\"space-y-1.5\">\r\n                  <Skeleton className=\"h-4 w-24\" />\r\n                  <Skeleton className=\"h-6 w-8\" />\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        ))}\r\n      </div>\r\n\r\n      {/* Filters */}\r\n      <div className=\"px-4 lg:px-6 flex flex-col sm:flex-row gap-3\">\r\n        <Skeleton className=\"h-10 flex-1\" />\r\n        <div className=\"flex gap-2\">\r\n          <Skeleton className=\"h-10 w-28\" />\r\n          <Skeleton className=\"h-10 w-32\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Inventory Table */}\r\n      <div className=\"px-4 lg:px-6\">\r\n        <Card>\r\n          <CardContent className=\"p-0\">\r\n            <div className=\"hidden md:block\">\r\n              <div className=\"grid grid-cols-6 gap-4 p-4 border-b bg-surface-subtle\">\r\n                <Skeleton className=\"h-4 w-20 col-span-2\" />\r\n                <Skeleton className=\"h-4 w-12\" />\r\n                <Skeleton className=\"h-4 w-20\" />\r\n                <Skeleton className=\"h-4 w-16\" />\r\n                <Skeleton className=\"h-4 w-16\" />\r\n              </div>\r\n              {[1, 2, 3, 4, 5, 6].map((i) => (\r\n                <div key={i} className=\"grid grid-cols-6 gap-4 p-4 border-b last:border-0 items-center\">\r\n                  <div className=\"col-span-2 flex items-center gap-3\">\r\n                    <Skeleton className=\"size-10 rounded\" />\r\n                    <Skeleton className=\"h-4 w-40\" />\r\n                  </div>\r\n                  <Skeleton className=\"h-4 w-12\" />\r\n                  <Skeleton className=\"h-2 w-full rounded-full\" />\r\n                  <Skeleton className=\"h-5 w-16 rounded-full\" />\r\n                  <Skeleton className=\"h-8 w-20 rounded\" />\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\inventory\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\marketing\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\marketing\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_businessSeller' is assigned a value but never used.","line":69,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":69,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { requireDashboardAccess } from \"@/lib/auth/business\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n  IconBrandFacebook,\r\n  IconBrandGoogle,\r\n  IconMail,\r\n  IconTag,\r\n  IconRocket,\r\n  IconChartBar,\r\n  IconArrowRight,\r\n  IconPlus,\r\n} from \"@tabler/icons-react\"\r\n\r\nconst marketingChannels = [\r\n  {\r\n    id: \"email\",\r\n    name: \"Email Marketing\",\r\n    description: \"Send targeted emails to your customers\",\r\n    icon: IconMail,\r\n    status: \"available\",\r\n    action: \"Set up\",\r\n  },\r\n  {\r\n    id: \"facebook\",\r\n    name: \"Facebook & Instagram\",\r\n    description: \"Reach customers on Meta platforms\",\r\n    icon: IconBrandFacebook,\r\n    status: \"coming-soon\",\r\n    action: \"Coming soon\",\r\n  },\r\n  {\r\n    id: \"google\",\r\n    name: \"Google Ads\",\r\n    description: \"Advertise on Google Search and Shopping\",\r\n    icon: IconBrandGoogle,\r\n    status: \"coming-soon\",\r\n    action: \"Coming soon\",\r\n  },\r\n]\r\n\r\nconst quickCampaigns = [\r\n  {\r\n    id: \"sale\",\r\n    name: \"Flash Sale\",\r\n    description: \"Create a limited-time discount\",\r\n    icon: IconTag,\r\n    href: \"/dashboard/discounts/new\",\r\n  },\r\n  {\r\n    id: \"launch\",\r\n    name: \"Product Launch\",\r\n    description: \"Announce a new product\",\r\n    icon: IconRocket,\r\n    href: \"/dashboard/products?add=true\",\r\n  },\r\n]\r\n\r\nexport default async function BusinessMarketingPage() {\r\n  // Requires paid business subscription\r\n  const _businessSeller = await requireDashboardAccess()\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6 px-4 lg:px-6\">\r\n      {/* Shopify-style Header */}\r\n      <div className=\"flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between\">\r\n        <div className=\"space-y-1\">\r\n          <div className=\"flex items-center gap-3 flex-wrap\">\r\n            <h1 className=\"text-2xl font-bold tracking-tight\">Marketing</h1>\r\n            <span className=\"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-info/10 text-info\">\r\n              <IconRocket className=\"size-3\" />\r\n              Grow your business\r\n            </span>\r\n          </div>\r\n          <p className=\"text-muted-foreground text-sm\">\r\n            Promote your store and reach more customers\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Quick Campaigns */}\r\n      <div>\r\n        <h2 className=\"text-lg font-semibold mb-3\">Quick campaigns</h2>\r\n        <div className=\"grid gap-3 sm:grid-cols-2 lg:grid-cols-3\">\r\n          {quickCampaigns.map((campaign) => {\r\n            const Icon = campaign.icon\r\n            return (\r\n              <Link key={campaign.id} href={campaign.href}>\r\n                <Card className=\"h-full hover:shadow-md transition-shadow cursor-pointer group\">\r\n                  <CardContent className=\"p-4\">\r\n                    <div className=\"flex items-start gap-3\">\r\n                      <div className=\"flex size-10 items-center justify-center rounded-lg bg-selected shrink-0\">\r\n                        <Icon className=\"size-5 text-primary\" />\r\n                      </div>\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <h3 className=\"font-medium text-sm\">{campaign.name}</h3>\r\n                        <p className=\"text-xs text-muted-foreground mt-0.5\">\r\n                          {campaign.description}\r\n                        </p>\r\n                      </div>\r\n                      <IconArrowRight className=\"size-4 text-muted-foreground opacity-0 group-hover:opacity-100 transition-opacity shrink-0\" />\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              </Link>\r\n            )\r\n          })}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Marketing Channels */}\r\n      <div>\r\n        <h2 className=\"text-lg font-semibold mb-3\">Marketing channels</h2>\r\n        <div className=\"grid gap-4 md:grid-cols-3\">\r\n          {marketingChannels.map((channel) => {\r\n            const Icon = channel.icon\r\n            const isAvailable = channel.status === \"available\"\r\n\r\n            return (\r\n              <Card key={channel.id} className={!isAvailable ? \"opacity-75\" : \"\"}>\r\n                <CardHeader className=\"pb-3\">\r\n                  <div className=\"flex items-start justify-between\">\r\n                    <div className=\"flex size-10 items-center justify-center rounded-lg bg-muted\">\r\n                      <Icon className=\"size-5\" />\r\n                    </div>\r\n                    {!isAvailable && (\r\n                      <Badge variant=\"secondary\" className=\"text-2xs\">\r\n                        Coming Soon\r\n                      </Badge>\r\n                    )}\r\n                  </div>\r\n                  <CardTitle className=\"text-base mt-3\">{channel.name}</CardTitle>\r\n                  <CardDescription className=\"text-sm\">\r\n                    {channel.description}\r\n                  </CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"pt-0\">\r\n                  <Button\r\n                    variant={isAvailable ? \"default\" : \"outline\"}\r\n                    size=\"sm\"\r\n                    className=\"w-full\"\r\n                    disabled={!isAvailable}\r\n                  >\r\n                    {channel.action}\r\n                  </Button>\r\n                </CardContent>\r\n              </Card>\r\n            )\r\n          })}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Marketing Performance - Placeholder */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg flex items-center gap-2\">\r\n            <IconChartBar className=\"size-5\" />\r\n            Marketing Performance\r\n          </CardTitle>\r\n          <CardDescription>\r\n            Track the performance of your marketing campaigns\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex flex-col items-center justify-center py-12 text-center\">\r\n            <div className=\"flex size-12 items-center justify-center rounded-full bg-muted mb-3\">\r\n              <IconChartBar className=\"size-6 text-muted-foreground\" />\r\n            </div>\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              No marketing campaigns yet. Create a campaign to start tracking performance.\r\n            </p>\r\n            <Button variant=\"outline\" size=\"sm\" className=\"mt-4\" asChild>\r\n              <Link href=\"/dashboard/discounts/new\">\r\n                <IconPlus className=\"size-4 mr-1.5\" />\r\n                Create first campaign\r\n              </Link>\r\n            </Button>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\orders\\[orderId]\\page.tsx","messages":[{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":45,"column":22,"nodeType":"CallExpression","messageId":"array-from","endLine":45,"endColumn":95,"fix":{"range":[1358,1431],"text":"[...new Set(orderItems.map((i) => i.product?.id).filter(Boolean))]"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { requireDashboardAccess } from \"@/lib/auth/business\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { notFound } from \"next/navigation\"\r\nimport { setRequestLocale } from \"next-intl/server\"\r\nimport { locales } from \"@/i18n/routing\"\r\nimport { OrderDetailView } from \"../../../_components/order-detail-view\"\r\n\r\n// Return placeholder param for build validation (required by cacheComponents)\r\n// Actual pages are rendered server-side for authenticated sellers\r\nexport function generateStaticParams() {\r\n  return locales.map((locale) => ({ locale, orderId: \"__placeholder__\" }))\r\n}\r\n\r\ninterface OrderDetailPageProps {\r\n  params: Promise<{ locale: string; orderId: string }>\r\n}\r\n\r\nasync function getOrderDetails(orderId: string, sellerId: string) {\r\n  const supabase = await createClient()\r\n  \r\n  // Get order items for this order that belong to this seller\r\n  const { data: orderItems, error: itemsError } = await supabase\r\n    .from('order_items')\r\n    .select(`\r\n      id,\r\n      quantity,\r\n      price_at_purchase,\r\n      status,\r\n      tracking_number,\r\n      shipping_carrier,\r\n      product:products(\r\n        id,\r\n        title,\r\n        images,\r\n        price\r\n      )\r\n    `)\r\n    .eq('seller_id', sellerId)\r\n    .eq('order_id', orderId)\r\n  \r\n  if (itemsError || !orderItems?.length) {\r\n    return null\r\n  }\r\n\r\n  const productIds = Array.from(new Set(orderItems.map((i) => i.product?.id).filter(Boolean)))\r\n  const { data: privateRows } = productIds.length\r\n    ? await supabase\r\n        .from('product_private')\r\n        .select('product_id, sku')\r\n        .eq('seller_id', sellerId)\r\n        .in('product_id', productIds)\r\n    : { data: [] as Array<{ product_id: string; sku: string | null }> }\r\n\r\n  const skuByProductId = new Map((privateRows || []).map((r) => [r.product_id, r.sku]))\r\n  \r\n  // Get order details\r\n  const { data: order, error: orderError } = await supabase\r\n    .from('orders')\r\n    .select(`\r\n      id,\r\n      status,\r\n      created_at,\r\n      total_amount,\r\n      shipping_address,\r\n      user:profiles(\r\n        id,\r\n        full_name\r\n      )\r\n    `)\r\n    .eq('id', orderId)\r\n    .single()\r\n  \r\n  if (orderError || !order) {\r\n    return null\r\n  }\r\n  \r\n  // Cast to correct types\r\n  const typedItems = orderItems as unknown as Array<{\r\n    id: string\r\n    quantity: number\r\n    price_at_purchase: number\r\n    status: string | null\r\n    tracking_number: string | null\r\n    shipping_carrier: string | null\r\n    product: { id: string; title: string; images: string[] | null; price: number } | null\r\n  }>\r\n\r\n  const shippingAddress = order.shipping_address as Record<string, unknown> | null\r\n  const email = typeof shippingAddress?.email === 'string' ? shippingAddress.email : null\r\n  const phone = typeof shippingAddress?.phone === 'string' ? shippingAddress.phone : null\r\n  const nameFromShipping = typeof shippingAddress?.name === 'string' ? shippingAddress.name : null\r\n\r\n  const baseUser = Array.isArray(order.user) ? (order.user.at(0) ?? null) : order.user\r\n  const typedOrderUser = baseUser\r\n    ? {\r\n        id: baseUser.id,\r\n        email,\r\n        full_name: baseUser.full_name ?? nameFromShipping,\r\n        phone,\r\n      }\r\n    : null\r\n\r\n  const typedOrder = {\r\n    ...order,\r\n    shipping_address: shippingAddress,\r\n    user: typedOrderUser,\r\n  } as unknown as {\r\n    id: string\r\n    status: string | null\r\n    created_at: string\r\n    total_amount: number\r\n    shipping_address: Record<string, unknown> | null\r\n    user: { id: string; email: string | null; full_name: string | null; phone: string | null } | null\r\n  }\r\n  \r\n  return {\r\n    order: typedOrder,\r\n    items: typedItems.map(item => ({\r\n      id: item.id,\r\n      quantity: item.quantity,\r\n      price_at_time: item.price_at_purchase, // Map to expected interface name\r\n      status: item.status,\r\n      tracking_number: item.tracking_number,\r\n      shipping_carrier: item.shipping_carrier,\r\n      product: item.product ? { ...item.product, sku: skuByProductId.get(item.product.id) ?? null } : null,\r\n    })),\r\n    subtotal: typedItems.reduce((sum, item) => sum + (item.price_at_purchase * item.quantity), 0),\r\n  }\r\n}\r\n\r\nexport default async function OrderDetailPage({ params }: OrderDetailPageProps) {\r\n  const { locale: localeParam, orderId } = await params\r\n  const locale = localeParam === \"bg\" ? \"bg\" : \"en\"\r\n  \r\n  // Enable static generation for this locale\r\n  setRequestLocale(locale)\r\n  \r\n  // Requires paid business subscription\r\n  const businessSeller = await requireDashboardAccess()\r\n  const orderData = await getOrderDetails(orderId, businessSeller.id)\r\n  \r\n  if (!orderData) {\r\n    notFound()\r\n  }\r\n  \r\n  return (\r\n    <OrderDetailView \r\n      order={orderData.order}\r\n      items={orderData.items}\r\n      subtotal={orderData.subtotal}\r\n      sellerId={businessSeller.id}\r\n    />\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\orders\\loading.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":2,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardHeader"},"fix":{"range":[79,91],"text":""},"desc":"Remove unused variable \"CardHeader\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Skeleton } from \"@/components/ui/skeleton\"\r\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\"\r\n\r\nexport default function DashboardOrdersLoading() {\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6\">\r\n      {/* Header */}\r\n      <div className=\"px-4 lg:px-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n        <div className=\"space-y-2\">\r\n          <Skeleton className=\"h-8 w-28\" />\r\n          <Skeleton className=\"h-4 w-64\" />\r\n        </div>\r\n        <div className=\"flex gap-2\">\r\n          <Skeleton className=\"h-9 w-28\" />\r\n          <Skeleton className=\"h-9 w-32\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Stats Cards */}\r\n      <div className=\"grid gap-4 px-4 lg:px-6 sm:grid-cols-2 lg:grid-cols-4\">\r\n        {[1, 2, 3, 4].map((i) => (\r\n          <Card key={i}>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center gap-3\">\r\n                <Skeleton className=\"size-10 rounded-full\" />\r\n                <div className=\"space-y-1.5\">\r\n                  <Skeleton className=\"h-4 w-20\" />\r\n                  <Skeleton className=\"h-6 w-12\" />\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        ))}\r\n      </div>\r\n\r\n      {/* Filters & Search */}\r\n      <div className=\"px-4 lg:px-6 flex flex-col sm:flex-row gap-3\">\r\n        <Skeleton className=\"h-10 flex-1\" />\r\n        <div className=\"flex gap-2\">\r\n          <Skeleton className=\"h-10 w-28\" />\r\n          <Skeleton className=\"h-10 w-28\" />\r\n          <Skeleton className=\"h-10 w-32\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Orders Table */}\r\n      <div className=\"px-4 lg:px-6\">\r\n        <Card>\r\n          <CardContent className=\"p-0\">\r\n            {/* Mobile View */}\r\n            <div className=\"md:hidden divide-y\">\r\n              {[1, 2, 3, 4, 5].map((i) => (\r\n                <div key={i} className=\"p-4 space-y-3\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <Skeleton className=\"h-5 w-28\" />\r\n                    <Skeleton className=\"h-5 w-20 rounded-full\" />\r\n                  </div>\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <Skeleton className=\"size-12 rounded\" />\r\n                    <div className=\"flex-1 space-y-1.5\">\r\n                      <Skeleton className=\"h-4 w-40\" />\r\n                      <Skeleton className=\"h-3 w-24\" />\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <Skeleton className=\"h-4 w-20\" />\r\n                    <Skeleton className=\"h-5 w-16\" />\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n\r\n            {/* Desktop Table */}\r\n            <div className=\"hidden md:block\">\r\n              <div className=\"grid grid-cols-7 gap-4 p-4 border-b bg-surface-subtle\">\r\n                <Skeleton className=\"h-4 w-16\" />\r\n                <Skeleton className=\"h-4 w-20 col-span-2\" />\r\n                <Skeleton className=\"h-4 w-20\" />\r\n                <Skeleton className=\"h-4 w-16\" />\r\n                <Skeleton className=\"h-4 w-16\" />\r\n                <Skeleton className=\"h-4 w-16\" />\r\n              </div>\r\n              {[1, 2, 3, 4, 5, 6].map((i) => (\r\n                <div key={i} className=\"grid grid-cols-7 gap-4 p-4 border-b last:border-0 items-center\">\r\n                  <Skeleton className=\"h-4 w-24\" />\r\n                  <div className=\"col-span-2 flex items-center gap-3\">\r\n                    <Skeleton className=\"size-10 rounded\" />\r\n                    <div className=\"space-y-1.5\">\r\n                      <Skeleton className=\"h-4 w-32\" />\r\n                      <Skeleton className=\"h-3 w-20\" />\r\n                    </div>\r\n                  </div>\r\n                  <Skeleton className=\"h-4 w-28\" />\r\n                  <Skeleton className=\"h-4 w-16\" />\r\n                  <Skeleton className=\"h-5 w-20 rounded-full\" />\r\n                  <Skeleton className=\"h-8 w-8 rounded\" />\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Pagination */}\r\n      <div className=\"px-4 lg:px-6 flex justify-center gap-2\">\r\n        <Skeleton className=\"h-9 w-9 rounded\" />\r\n        <Skeleton className=\"h-9 w-9 rounded\" />\r\n        <Skeleton className=\"h-9 w-9 rounded\" />\r\n        <Skeleton className=\"h-9 w-9 rounded\" />\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\orders\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\products\\[productId]\\edit\\_components\\product-edit-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\products\\[productId]\\edit\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\products\\loading.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardHeader' is defined but never used.","line":2,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":2,"endColumn":39,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CardHeader"},"fix":{"range":[79,91],"text":""},"desc":"Remove unused variable \"CardHeader\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Skeleton } from \"@/components/ui/skeleton\"\r\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\"\r\n\r\nexport default function DashboardProductsLoading() {\r\n  return (\r\n    <div className=\"flex flex-col gap-4 py-4 md:gap-4 md:py-6\">\r\n      {/* Header */}\r\n      <div className=\"px-4 lg:px-6 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n        <div className=\"space-y-2\">\r\n          <Skeleton className=\"h-8 w-28\" />\r\n          <Skeleton className=\"h-4 w-64\" />\r\n        </div>\r\n        <Skeleton className=\"h-9 w-36\" />\r\n      </div>\r\n\r\n      {/* Stats Cards */}\r\n      <div className=\"grid gap-4 px-4 lg:px-6 sm:grid-cols-2 lg:grid-cols-4\">\r\n        {[1, 2, 3, 4].map((i) => (\r\n          <Card key={i}>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center gap-3\">\r\n                <Skeleton className=\"size-10 rounded-full\" />\r\n                <div className=\"space-y-1.5\">\r\n                  <Skeleton className=\"h-4 w-24\" />\r\n                  <Skeleton className=\"h-6 w-12\" />\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        ))}\r\n      </div>\r\n\r\n      {/* Filters & Search */}\r\n      <div className=\"px-4 lg:px-6 flex flex-col sm:flex-row gap-3\">\r\n        <Skeleton className=\"h-10 flex-1\" />\r\n        <div className=\"flex gap-2\">\r\n          <Skeleton className=\"h-10 w-32\" />\r\n          <Skeleton className=\"h-10 w-28\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Products Grid/Table */}\r\n      <div className=\"px-4 lg:px-6\">\r\n        <Card>\r\n          <CardContent className=\"p-0\">\r\n            {/* Mobile View */}\r\n            <div className=\"md:hidden divide-y\">\r\n              {[1, 2, 3, 4].map((i) => (\r\n                <div key={i} className=\"p-4 flex gap-3\">\r\n                  <Skeleton className=\"size-20 rounded-lg shrink-0\" />\r\n                  <div className=\"flex-1 space-y-2\">\r\n                    <Skeleton className=\"h-4 w-full\" />\r\n                    <Skeleton className=\"h-4 w-3/4\" />\r\n                    <div className=\"flex gap-2\">\r\n                      <Skeleton className=\"h-5 w-16 rounded-full\" />\r\n                      <Skeleton className=\"h-5 w-14\" />\r\n                    </div>\r\n                    <div className=\"flex gap-2\">\r\n                      <Skeleton className=\"h-3 w-16\" />\r\n                      <Skeleton className=\"h-3 w-20\" />\r\n                    </div>\r\n                  </div>\r\n                  <Skeleton className=\"h-8 w-8 rounded\" />\r\n                </div>\r\n              ))}\r\n            </div>\r\n\r\n            {/* Desktop Table */}\r\n            <div className=\"hidden md:block\">\r\n              <div className=\"grid grid-cols-7 gap-4 p-4 border-b bg-surface-subtle\">\r\n                <Skeleton className=\"h-4 w-16 col-span-2\" />\r\n                <Skeleton className=\"h-4 w-20\" />\r\n                <Skeleton className=\"h-4 w-16\" />\r\n                <Skeleton className=\"h-4 w-16\" />\r\n                <Skeleton className=\"h-4 w-16\" />\r\n                <Skeleton className=\"h-4 w-16\" />\r\n              </div>\r\n              {[1, 2, 3, 4, 5, 6].map((i) => (\r\n                <div key={i} className=\"grid grid-cols-7 gap-4 p-4 border-b last:border-0 items-center\">\r\n                  <div className=\"col-span-2 flex items-center gap-3\">\r\n                    <Skeleton className=\"size-12 rounded\" />\r\n                    <div className=\"space-y-1.5\">\r\n                      <Skeleton className=\"h-4 w-40\" />\r\n                      <Skeleton className=\"h-3 w-24\" />\r\n                    </div>\r\n                  </div>\r\n                  <Skeleton className=\"h-4 w-24\" />\r\n                  <Skeleton className=\"h-4 w-16\" />\r\n                  <Skeleton className=\"h-4 w-12\" />\r\n                  <Skeleton className=\"h-5 w-16 rounded-full\" />\r\n                  <div className=\"flex gap-2\">\r\n                    <Skeleton className=\"h-8 w-8 rounded\" />\r\n                    <Skeleton className=\"h-8 w-8 rounded\" />\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Pagination */}\r\n      <div className=\"px-4 lg:px-6 flex justify-center gap-2\">\r\n        <Skeleton className=\"h-9 w-9 rounded\" />\r\n        <Skeleton className=\"h-9 w-9 rounded\" />\r\n        <Skeleton className=\"h-9 w-9 rounded\" />\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\products\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/products' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":2,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":9,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { requireDashboardAccess, getBusinessProducts } from \"@/lib/auth/business\"\r\nimport {\r\n  bulkDeleteProducts,\r\n  bulkUpdateProductStatus,\r\n  createProduct,\r\n  deleteProduct,\r\n  duplicateProduct,\r\n  updateProduct,\r\n} from \"@/app/actions/products\"\r\nimport { ProductsTable } from \"../../_components/products-table\"\r\nimport { getBusinessDashboardCategories } from \"../_lib/categories\"\r\n\r\nexport default async function BusinessProductsPage() {\r\n  // Requires paid business subscription\r\n  const businessSeller = await requireDashboardAccess()\r\n  const { products, total } = await getBusinessProducts(businessSeller.id)\r\n  const categories = await getBusinessDashboardCategories()\r\n  \r\n  return (\r\n    <ProductsTable \r\n      initialProducts={products}\r\n      categories={categories}\r\n      total={total}\r\n      sellerId={businessSeller.id}\r\n      actions={{\r\n        createProduct,\r\n        updateProduct,\r\n        deleteProduct,\r\n        bulkDeleteProducts,\r\n        bulkUpdateProductStatus,\r\n        duplicateProduct,\r\n      }}\r\n    />\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\settings\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\settings\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\upgrade\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(business)\\dashboard\\upgrade\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_plans' is assigned a value but never used.","line":186,"column":17,"nodeType":"Identifier","messageId":"unusedVar","endLine":186,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { requireBusinessSeller, getActiveSubscription, DASHBOARD_ALLOWED_TIERS } from \"@/lib/auth/business\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { Link, redirect } from \"@/i18n/routing\"\r\nimport { Suspense } from \"react\"\r\nimport { connection } from \"next/server\"\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n  CardFooter,\r\n} from \"@/components/ui/card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n  IconRocket,\r\n  IconChartBar,\r\n  IconUsers,\r\n  IconShoppingCart,\r\n  IconCheck,\r\n  IconX,\r\n  IconCrown,\r\n  IconBuildingStore,\r\n  IconArrowRight,\r\n  IconSparkles,\r\n} from \"@tabler/icons-react\"\r\n\r\n// Translations\r\nconst translations = {\r\n  en: {\r\n    title: \"Unlock Your Business Dashboard\",\r\n    subtitle: \"Get access to powerful tools to grow your business\",\r\n    currentPlan: \"Your Current Plan\",\r\n    freeTier: \"Business Free\",\r\n    upgradeTo: \"Upgrade to unlock\",\r\n    features: \"What you'll get\",\r\n    upgradeNow: \"Upgrade Now\",\r\n    viewPlans: \"View All Plans\",\r\n    perMonth: \"/month\",\r\n    perYear: \"/year\",\r\n    saveYearly: \"Save 17% with yearly\",\r\n    dashboardFeatures: [\r\n      \"Real-time analytics dashboard\",\r\n      \"Advanced inventory management\",\r\n      \"Customer relationship tools\",\r\n      \"Marketing & promotions\",\r\n      \"Discount code management\",\r\n      \"Accounting & reports\",\r\n      \"Priority business support\",\r\n      \"Bulk listing tools\",\r\n      \"API access\",\r\n    ],\r\n    freeFeatures: [\r\n      \"100 active listings\",\r\n      \"1.5% seller fee\",\r\n      \"Buyer Protection: 3% + Γé¼0.35 (cap Γé¼12)\",\r\n      \"Basic analytics\",\r\n      \"Verified Business badge\",\r\n      \"Invoice support\",\r\n    ],\r\n    proFeatures: [\r\n      \"2,000 active listings\",\r\n      \"1% seller fee\",\r\n      \"Buyer Protection: 2.5% + Γé¼0.25 (cap Γé¼10)\",\r\n      \"Full analytics dashboard\",\r\n      \"/dashboard access\",\r\n      \"20 boosts/month (24h)\",\r\n      \"Team accounts (up to 3)\",\r\n      \"Priority support\",\r\n      \"Bulk listing tools\",\r\n    ],\r\n    enterpriseFeatures: [\r\n      \"UNLIMITED listings\",\r\n      \"0.5% seller fee\",\r\n      \"Buyer Protection: 2% + Γé¼0.20 (cap Γé¼8)\",\r\n      \"Enterprise analytics suite\",\r\n      \"/dashboard full access\",\r\n      \"50 boosts/month (24h)\",\r\n      \"Unlimited team accounts\",\r\n      \"API access\",\r\n      \"Dedicated account manager\",\r\n      \"Custom integrations\",\r\n    ],\r\n    recommended: \"Recommended\",\r\n    bestValue: \"Best Value\",\r\n    mostPopular: \"Most Popular\",\r\n    whyUpgrade: \"Why upgrade to Business Pro?\",\r\n    whyUpgradeDesc: \"Access the full power of your business dashboard with advanced tools designed to help you scale.\",\r\n  },\r\n  bg: {\r\n    title: \"╨₧╤é╨║╨╗╤Ä╤ç╨╡╤é╨╡ ╨▒╨╕╨╖╨╜╨╡╤ü ╤é╨░╨▒╨╗╨╛╤é╨╛\",\r\n    subtitle: \"╨ƒ╨╛╨╗╤â╤ç╨╡╤é╨╡ ╨┤╨╛╤ü╤é╤è╨┐ ╨┤╨╛ ╨╝╨╛╤ë╨╜╨╕ ╨╕╨╜╤ü╤é╤Ç╤â╨╝╨╡╨╜╤é╨╕ ╨╖╨░ ╤Ç╨░╨╖╨▓╨╕╤é╨╕╨╡ ╨╜╨░ ╨▒╨╕╨╖╨╜╨╡╤ü╨░\",\r\n    currentPlan: \"╨Æ╨░╤ê╨╕╤Å╤é ╤é╨╡╨║╤â╤ë ╨┐╨╗╨░╨╜\",\r\n    freeTier: \"╨æ╨╕╨╖╨╜╨╡╤ü ╨æ╨╡╨╖╨┐╨╗╨░╤é╨╡╨╜\",\r\n    upgradeTo: \"╨¥╨░╨┤╨│╤Ç╨░╨┤╨╡╤é╨╡ ╨╖╨░ ╨┤╨╛╤ü╤é╤è╨┐\",\r\n    features: \"╨Ü╨░╨║╨▓╨╛ ╤ë╨╡ ╨┐╨╛╨╗╤â╤ç╨╕╤é╨╡\",\r\n    upgradeNow: \"╨¥╨░╨┤╨│╤Ç╨░╨┤╨╡╤é╨╡ ╤ü╨╡╨│╨░\",\r\n    viewPlans: \"╨Æ╨╕╨╢╤é╨╡ ╨▓╤ü╨╕╤ç╨║╨╕ ╨┐╨╗╨░╨╜╨╛╨▓╨╡\",\r\n    perMonth: \"/╨╝╨╡╤ü╨╡╤å\",\r\n    perYear: \"/╨│╨╛╨┤╨╕╨╜╨░\",\r\n    saveYearly: \"╨í╨┐╨╡╤ü╤é╨╡╤é╨╡ 17% ╤ü ╨│╨╛╨┤╨╕╤ê╨╡╨╜ ╨┐╨╗╨░╨╜\",\r\n    dashboardFeatures: [\r\n      \"╨É╨╜╨░╨╗╨╕╤é╨╕╨║╨░ ╨▓ ╤Ç╨╡╨░╨╗╨╜╨╛ ╨▓╤Ç╨╡╨╝╨╡\",\r\n      \"╨á╨░╨╖╤ê╨╕╤Ç╨╡╨╜╨╛ ╤â╨┐╤Ç╨░╨▓╨╗╨╡╨╜╨╕╨╡ ╨╜╨░ ╨╕╨╜╨▓╨╡╨╜╤é╨░╤Ç╨░\",\r\n      \"╨ÿ╨╜╤ü╤é╤Ç╤â╨╝╨╡╨╜╤é╨╕ ╨╖╨░ ╨║╨╗╨╕╨╡╨╜╤é╨╕\",\r\n      \"╨£╨░╤Ç╨║╨╡╤é╨╕╨╜╨│ ╨╕ ╨┐╤Ç╨╛╨╝╨╛╤å╨╕╨╕\",\r\n      \"╨ú╨┐╤Ç╨░╨▓╨╗╨╡╨╜╨╕╨╡ ╨╜╨░ ╨║╨╛╨┤╨╛╨▓╨╡ ╨╖╨░ ╨╛╤é╤ü╤é╤è╨┐╨║╨░\",\r\n      \"╨í╤ç╨╡╤é╨╛╨▓╨╛╨┤╤ü╤é╨▓╨╛ ╨╕ ╨╛╤é╤ç╨╡╤é╨╕\",\r\n      \"╨ƒ╤Ç╨╕╨╛╤Ç╨╕╤é╨╡╤é╨╜╨░ ╨▒╨╕╨╖╨╜╨╡╤ü ╨┐╨╛╨┤╨┤╤Ç╤è╨╢╨║╨░\",\r\n      \"╨£╨░╤ü╨╛╨▓╨╛ ╨║╨░╤ç╨▓╨░╨╜╨╡ ╨╜╨░ ╨╛╨▒╤Å╨▓╨╕\",\r\n      \"API ╨┤╨╛╤ü╤é╤è╨┐\",\r\n    ],\r\n    freeFeatures: [\r\n      \"100 ╨░╨║╤é╨╕╨▓╨╜╨╕ ╨╛╨▒╤Å╨▓╨╕\",\r\n      \"1.5% ╤é╨░╨║╤ü╨░ ╨╖╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨░\",\r\n      \"╨ù╨░╤ë╨╕╤é╨░ ╨╜╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨░: 3% + Γé¼0.35 (╨╗╨╕╨╝╨╕╤é Γé¼12)\",\r\n      \"╨æ╨░╨╖╨╛╨▓╨░ ╨░╨╜╨░╨╗╨╕╤é╨╕╨║╨░\",\r\n      \"╨æ╨░╨┤╨╢ ΓÇ₧╨Æ╨╡╤Ç╨╕╤ä╨╕╤å╨╕╤Ç╨░╨╜ ╨▒╨╕╨╖╨╜╨╡╤üΓÇ£\",\r\n      \"╨ƒ╨╛╨┤╨┤╤Ç╤è╨╢╨║╨░ ╨╖╨░ ╤ä╨░╨║╤é╤â╤Ç╨╕\",\r\n    ],\r\n    proFeatures: [\r\n      \"2,000 ╨░╨║╤é╨╕╨▓╨╜╨╕ ╨╛╨▒╤Å╨▓╨╕\",\r\n      \"1% ╤é╨░╨║╤ü╨░ ╨╖╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨░\",\r\n      \"╨ù╨░╤ë╨╕╤é╨░ ╨╜╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨░: 2.5% + Γé¼0.25 (╨╗╨╕╨╝╨╕╤é Γé¼10)\",\r\n      \"╨ƒ╤è╨╗╨╜╨╛ ╨░╨╜╨░╨╗╨╕╤é╨╕╤ç╨╜╨╛ ╤é╨░╨▒╨╗╨╛\",\r\n      \"╨ö╨╛╤ü╤é╤è╨┐ ╨┤╨╛ /dashboard\",\r\n      \"20 ╨┐╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╜╨╕╤Å/╨╝╨╡╤ü╨╡╤å (24╤ç)\",\r\n      \"╨ò╨║╨╕╨┐╨╜╨╕ ╨░╨║╨░╤â╨╜╤é╨╕ (╨┤╨╛ 3)\",\r\n      \"╨ƒ╤Ç╨╕╨╛╤Ç╨╕╤é╨╡╤é╨╜╨░ ╨┐╨╛╨┤╨┤╤Ç╤è╨╢╨║╨░\",\r\n      \"╨£╨░╤ü╨╛╨▓╨╛ ╨║╨░╤ç╨▓╨░╨╜╨╡ ╨╜╨░ ╨╛╨▒╤Å╨▓╨╕\",\r\n    ],\r\n    enterpriseFeatures: [\r\n      \"╨¥╨ò╨₧╨ô╨á╨É╨¥╨ÿ╨º╨ò╨¥╨ÿ ╨╛╨▒╤Å╨▓╨╕\",\r\n      \"0.5% ╤é╨░╨║╤ü╨░ ╨╖╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨░\",\r\n      \"╨ù╨░╤ë╨╕╤é╨░ ╨╜╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨░: 2% + Γé¼0.20 (╨╗╨╕╨╝╨╕╤é Γé¼8)\",\r\n      \"Enterprise ╨░╨╜╨░╨╗╨╕╤é╨╕╨║╨░\",\r\n      \"╨ƒ╤è╨╗╨╡╨╜ ╨┤╨╛╤ü╤é╤è╨┐ ╨┤╨╛ /dashboard\",\r\n      \"50 ╨┐╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╜╨╕╤Å/╨╝╨╡╤ü╨╡╤å (24╤ç)\",\r\n      \"╨¥╨╡╨╛╨│╤Ç╨░╨╜╨╕╤ç╨╡╨╜╨╕ ╨╡╨║╨╕╨┐╨╜╨╕ ╨░╨║╨░╤â╨╜╤é╨╕\",\r\n      \"API ╨┤╨╛╤ü╤é╤è╨┐\",\r\n      \"╨¢╨╕╤ç╨╡╨╜ ╨╝╨╡╨╜╨╕╨┤╨╢╤è╤Ç\",\r\n      \"╨ƒ╨╡╤Ç╤ü╨╛╨╜╨░╨╗╨╕╨╖╨╕╤Ç╨░╨╜╨╕ ╨╕╨╜╤é╨╡╨│╤Ç╨░╤å╨╕╨╕\",\r\n    ],\r\n    recommended: \"╨ƒ╤Ç╨╡╨┐╨╛╤Ç╤è╤ç╨░╨╜\",\r\n    bestValue: \"╨¥╨░╨╣-╨┤╨╛╨▒╤Ç╨░ ╤ü╤é╨╛╨╣╨╜╨╛╤ü╤é\",\r\n    mostPopular: \"╨¥╨░╨╣-╨┐╨╛╨┐╤â╨╗╤Å╤Ç╨╡╨╜\",\r\n    whyUpgrade: \"╨ù╨░╤ë╨╛ ╨┤╨░ ╨╜╨░╨┤╨│╤Ç╨░╨┤╨╕╤é╨╡ ╨┤╨╛ Business Pro?\",\r\n    whyUpgradeDesc: \"╨ƒ╨╛╨╗╤â╤ç╨╡╤é╨╡ ╨┤╨╛╤ü╤é╤è╨┐ ╨┤╨╛ ╨┐╤è╨╗╨╜╨░╤é╨░ ╨╝╨╛╤ë╨╜╨╛╤ü╤é ╨╜╨░ ╨▒╨╕╨╖╨╜╨╡╤ü ╤é╨░╨▒╨╗╨╛╤é╨╛ ╤ü ╤Ç╨░╨╖╤ê╨╕╤Ç╨╡╨╜╨╕ ╨╕╨╜╤ü╤é╤Ç╤â╨╝╨╡╨╜╤é╨╕, ╨┐╤Ç╨╛╨╡╨║╤é╨╕╤Ç╨░╨╜╨╕ ╨┤╨░ ╨▓╨╕ ╨┐╨╛╨╝╨╛╨│╨╜╨░╤é ╨┤╨░ ╤Ç╨░╤ü╤é╨╡╤é╨╡.\",\r\n  },\r\n}\r\n\r\ninterface UpgradePageProps {\r\n  params: Promise<{ locale: string }>\r\n}\r\n\r\nexport default function DashboardUpgradePage(props: UpgradePageProps) {\r\n  return (\r\n    <Suspense fallback={null}>\r\n      <DashboardUpgradePageInner {...props} />\r\n    </Suspense>\r\n  )\r\n}\r\n\r\nasync function DashboardUpgradePageInner({ params }: UpgradePageProps) {\r\n  // Mark route as dynamic without using route segment config (incompatible with cacheComponents).\r\n  await connection()\r\n\r\n  const { locale } = await params\r\n  const t = translations[locale as keyof typeof translations] || translations.en\r\n\r\n  // Get the business seller (they must be a business account to see this page)\r\n  const businessSeller = await requireBusinessSeller(\"/account\")\r\n\r\n  // Check if they already have dashboard access\r\n  const subscription = await getActiveSubscription(businessSeller.id)\r\n  const hasAccess = subscription && DASHBOARD_ALLOWED_TIERS.includes(subscription.plan_tier as 'professional' | 'enterprise')\r\n\r\n  // If they already have access, redirect to dashboard\r\n  if (hasAccess) {\r\n    redirect({ href: \"/dashboard\", locale })\r\n  }\r\n\r\n  // Fetch business plans for display\r\n  const supabase = await createClient()\r\n  const { data: _plans } = await supabase\r\n    .from('subscription_plans')\r\n    .select('id')\r\n    .eq('account_type', 'business')\r\n    .eq('is_active', true)\r\n    .in('tier', ['professional', 'enterprise'])\r\n    .order('price_monthly', { ascending: true })\r\n\r\n  return (\r\n    <div className=\"container flex flex-col gap-4 py-6\">\r\n      {/* Header */}\r\n      <div className=\"text-center space-y-2\">\r\n        <div className=\"flex items-center justify-center gap-2 mb-4\">\r\n          <div className=\"p-3 rounded-full bg-warning\">\r\n            <IconCrown className=\"size-8 text-warning-foreground\" />\r\n          </div>\r\n        </div>\r\n        <h1 className=\"text-3xl font-bold tracking-tight\">{t.title}</h1>\r\n        <p className=\"text-muted-foreground text-lg max-w-2xl mx-auto\">\r\n          {t.subtitle}\r\n        </p>\r\n      </div>\r\n\r\n      {/* Current Plan Notice */}\r\n      <Card className=\"border border-warning/20 bg-warning/10\">\r\n        <CardContent className=\"p-4 flex items-center gap-4\">\r\n          <div className=\"p-2 rounded-full bg-warning/10\">\r\n            <IconBuildingStore className=\"size-5 text-warning\" />\r\n          </div>\r\n          <div className=\"flex-1\">\r\n            <p className=\"font-medium\">{t.currentPlan}: <span className=\"text-warning\">{t.freeTier}</span></p>\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              {businessSeller.store_name} ΓÇó {t.upgradeTo}\r\n            </p>\r\n          </div>\r\n          <Badge variant=\"outline\" className=\"border-warning/30 text-warning\">\r\n            {businessSeller.tier || 'free'}\r\n          </Badge>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Plans Grid */}\r\n      <div className=\"grid gap-4 lg:grid-cols-2\">\r\n        {/* Business Pro Plan */}\r\n        <Card className=\"relative border-2 border-primary shadow-sm\">\r\n          <div className=\"absolute -top-3 left-1/2 -translate-x-1/2\">\r\n            <Badge className=\"bg-primary text-primary-foreground px-3 py-1\">\r\n              <IconSparkles className=\"size-3 mr-1\" />\r\n              {t.mostPopular}\r\n            </Badge>\r\n          </div>\r\n          <CardHeader className=\"pt-8\">\r\n            <CardTitle className=\"flex items-center gap-2\">\r\n              <IconRocket className=\"size-5 text-primary\" />\r\n              Business Pro\r\n            </CardTitle>\r\n            <CardDescription>\r\n              {locale === 'bg' ? '╨ƒ╤Ç╨╛╤ä╨╡╤ü╨╕╨╛╨╜╨░╨╗╨╜╨╕ ╨╕╨╜╤ü╤é╤Ç╤â╨╝╨╡╨╜╤é╨╕ ╨╖╨░ ╤Ç╨░╤ü╤é╤Å╤ë╨╕ ╨▒╨╕╨╖╨╜╨╡╤ü╨╕' : 'Professional tools for growing businesses'}\r\n            </CardDescription>\r\n          </CardHeader>\r\n          <CardContent className=\"space-y-6\">\r\n            <div className=\"flex items-baseline gap-1\">\r\n              <span className=\"text-4xl font-bold\">Γé¼49.99</span>\r\n              <span className=\"text-muted-foreground\">{t.perMonth}</span>\r\n            </div>\r\n            <p className=\"text-xs text-muted-foreground\">{t.saveYearly}</p>\r\n\r\n            <div className=\"space-y-3\">\r\n              {t.proFeatures.map((feature, i) => (\r\n                <div key={i} className=\"flex items-start gap-2\">\r\n                  <IconCheck className=\"size-5 text-success shrink-0 mt-0.5\" />\r\n                  <span className=\"text-sm\">{feature}</span>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n          <CardFooter>\r\n            <Button asChild className=\"w-full\" size=\"lg\">\r\n              <Link href=\"/plans?type=business&highlight=professional\">\r\n                {t.upgradeNow}\r\n                <IconArrowRight className=\"ml-2 size-4\" />\r\n              </Link>\r\n            </Button>\r\n          </CardFooter>\r\n        </Card>\r\n\r\n        {/* Business Enterprise Plan */}\r\n        <Card className=\"relative\">\r\n          <div className=\"absolute -top-3 left-1/2 -translate-x-1/2\">\r\n            <Badge variant=\"secondary\" className=\"px-3 py-1\">\r\n              {t.bestValue}\r\n            </Badge>\r\n          </div>\r\n          <CardHeader className=\"pt-8\">\r\n            <CardTitle className=\"flex items-center gap-2\">\r\n              <IconCrown className=\"size-5 text-warning\" />\r\n              Business Enterprise\r\n            </CardTitle>\r\n            <CardDescription>\r\n              {locale === 'bg' ? '╨ù╨░ ╨╝╨░╤Ç╨║╨╕ ╨╕ ╨▓╨╕╤ü╨╛╨║╨╛╨╛╨▒╨╡╨╝╨╜╨╕ ╨▒╨╕╨╖╨╜╨╡╤ü╨╕' : 'For brands and high-volume businesses'}\r\n            </CardDescription>\r\n          </CardHeader>\r\n          <CardContent className=\"space-y-6\">\r\n            <div className=\"flex items-baseline gap-1\">\r\n              <span className=\"text-4xl font-bold\">Γé¼99.99</span>\r\n              <span className=\"text-muted-foreground\">{t.perMonth}</span>\r\n            </div>\r\n            <p className=\"text-xs text-muted-foreground\">{t.saveYearly}</p>\r\n\r\n            <div className=\"space-y-3\">\r\n              {t.enterpriseFeatures.map((feature, i) => (\r\n                <div key={i} className=\"flex items-start gap-2\">\r\n                  <IconCheck className=\"size-5 text-success shrink-0 mt-0.5\" />\r\n                  <span className=\"text-sm\">{feature}</span>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n          <CardFooter>\r\n            <Button asChild variant=\"outline\" className=\"w-full\" size=\"lg\">\r\n              <Link href=\"/plans?type=business&highlight=enterprise\">\r\n                {t.upgradeNow}\r\n                <IconArrowRight className=\"ml-2 size-4\" />\r\n              </Link>\r\n            </Button>\r\n          </CardFooter>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Dashboard Features Preview */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center gap-2\">\r\n            <IconChartBar className=\"size-5\" />\r\n            {t.whyUpgrade}\r\n          </CardTitle>\r\n          <CardDescription>{t.whyUpgradeDesc}</CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"grid gap-4 sm:grid-cols-2 lg:grid-cols-3\">\r\n            {t.dashboardFeatures.map((feature, i) => (\r\n              <div key={i} className=\"flex items-center gap-2 p-3 rounded-lg bg-surface-subtle\">\r\n                <IconCheck className=\"size-4 text-success shrink-0\" />\r\n                <span className=\"text-sm\">{feature}</span>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </CardContent>\r\n        <CardFooter className=\"justify-center\">\r\n          <Button asChild variant=\"link\">\r\n            <Link href=\"/plans\">\r\n              {t.viewPlans}\r\n              <IconArrowRight className=\"ml-1 size-4\" />\r\n            </Link>\r\n          </Button>\r\n        </CardFooter>\r\n      </Card>\r\n\r\n      {/* Comparison: Free vs Pro */}\r\n      <div className=\"grid gap-4 lg:grid-cols-2\">\r\n        {/* Free Plan */}\r\n        <Card className=\"border-muted\">\r\n          <CardHeader>\r\n            <CardTitle className=\"text-lg flex items-center gap-2\">\r\n              <IconBuildingStore className=\"size-5 text-muted-foreground\" />\r\n              {t.freeTier}\r\n              <Badge variant=\"outline\" className=\"ml-auto\">Current</Badge>\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"space-y-2\">\r\n              {t.freeFeatures.map((feature, i) => (\r\n                <div key={i} className=\"flex items-center gap-2 text-sm text-muted-foreground\">\r\n                  <IconCheck className=\"size-4 text-muted-foreground shrink-0\" />\r\n                  {feature}\r\n                </div>\r\n              ))}\r\n              <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\r\n                <IconX className=\"size-4 text-destructive shrink-0\" />\r\n                {locale === 'bg' ? '╨æ╨╡╨╖ ╨┤╨╛╤ü╤é╤è╨┐ ╨┤╨╛ ╤é╨░╨▒╨╗╨╛╤é╨╛' : 'No dashboard access'}\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* What you're missing */}\r\n        <Card className=\"border-selected-border bg-selected\">\r\n          <CardHeader>\r\n            <CardTitle className=\"text-lg flex items-center gap-2\">\r\n              <IconRocket className=\"size-5 text-primary\" />\r\n              {locale === 'bg' ? '╨Ü╨░╨║╨▓╨╛ ╨┐╤Ç╨╛╨┐╤â╤ü╨║╨░╤é╨╡' : \"What you're missing\"}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex items-center gap-2 text-sm\">\r\n                <IconChartBar className=\"size-4 text-primary shrink-0\" />\r\n                {locale === 'bg' ? '╨ƒ╤è╨╗╨╜╨╛ ╨░╨╜╨░╨╗╨╕╤é╨╕╤ç╨╜╨╛ ╤é╨░╨▒╨╗╨╛' : 'Full analytics dashboard'}\r\n              </div>\r\n              <div className=\"flex items-center gap-2 text-sm\">\r\n                <IconUsers className=\"size-4 text-primary shrink-0\" />\r\n                {locale === 'bg' ? '╨ú╨┐╤Ç╨░╨▓╨╗╨╡╨╜╨╕╨╡ ╨╜╨░ ╨║╨╗╨╕╨╡╨╜╤é╨╕' : 'Customer management'}\r\n              </div>\r\n              <div className=\"flex items-center gap-2 text-sm\">\r\n                <IconShoppingCart className=\"size-4 text-primary shrink-0\" />\r\n                {locale === 'bg' ? '╨á╨░╨╖╤ê╨╕╤Ç╨╡╨╜╨╛ ╤â╨┐╤Ç╨░╨▓╨╗╨╡╨╜╨╕╨╡ ╨╜╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨╕' : 'Advanced order management'}\r\n              </div>\r\n              <div className=\"flex items-center gap-2 text-sm\">\r\n                <IconSparkles className=\"size-4 text-primary shrink-0\" />\r\n                {locale === 'bg' ? '╨£╨░╤Ç╨║╨╡╤é╨╕╨╜╨│ ╨╕ ╨┐╤Ç╨╛╨╝╨╛╤å╨╕╨╕' : 'Marketing & promotions'}\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(chat)\\_actions\\report-conversation.ts","messages":[{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":66,"column":49,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":66,"endColumn":68}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { revalidateTag } from \"next/cache\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\n\r\nexport type ReportReason = \r\n  | \"spam\"\r\n  | \"harassment\" \r\n  | \"scam\"\r\n  | \"inappropriate\"\r\n  | \"other\"\r\n\r\nexport interface ReportConversationResult {\r\n  success: boolean\r\n  error: string | null\r\n}\r\n\r\n/**\r\n * Report a conversation for inappropriate content\r\n * Creates a notification for admins to review\r\n */\r\nexport async function reportConversation(\r\n  conversationId: string,\r\n  reason: ReportReason,\r\n  description?: string\r\n): Promise<ReportConversationResult> {\r\n  const supabase = await createClient()\r\n  if (!supabase) {\r\n    return { success: false, error: \"Not authenticated\" }\r\n  }\r\n\r\n  const { data: userData } = await supabase.auth.getUser()\r\n  if (!userData.user) {\r\n    return { success: false, error: \"Not authenticated\" }\r\n  }\r\n\r\n  try {\r\n    // Verify user is part of this conversation\r\n    const { data: conversation, error: convError } = await supabase\r\n      .from(\"conversations\")\r\n      .select(\"id, buyer_id, seller_id\")\r\n      .eq(\"id\", conversationId)\r\n      .single()\r\n\r\n    if (convError || !conversation) {\r\n      return { success: false, error: \"Conversation not found\" }\r\n    }\r\n\r\n    const userId = userData.user.id\r\n    if (conversation.buyer_id !== userId && conversation.seller_id !== userId) {\r\n      return { success: false, error: \"Not authorized to report this conversation\" }\r\n    }\r\n\r\n    // Determine who is being reported (the other party)\r\n    const reportedUserId = conversation.buyer_id === userId \r\n      ? conversation.seller_id \r\n      : conversation.buyer_id\r\n\r\n    // Create admin notification for review\r\n    const { error: notifError } = await supabase\r\n      .from(\"notifications\")\r\n      .insert({\r\n        user_id: userData.user.id, // Placeholder - in production, this would go to admin users\r\n        type: \"system\",\r\n        title: \"Conversation Reported\",\r\n        body: `Reason: ${reason}${description ? ` - ${description}` : \"\"}`,\r\n        data: {\r\n          type: \"conversation_report\",\r\n          conversation_id: conversationId,\r\n          reporter_id: userId,\r\n          reported_user_id: reportedUserId,\r\n          reason,\r\n          description: description || null\r\n        },\r\n        conversation_id: conversationId\r\n      })\r\n\r\n    if (notifError) {\r\n      console.error(\"Error creating report notification:\", notifError)\r\n      return { success: false, error: \"Failed to submit report\" }\r\n    }\r\n\r\n    revalidateTag(\"conversations\", \"max\")\r\n    \r\n    return { success: true, error: null }\r\n  } catch (err) {\r\n    console.error(\"Error reporting conversation:\", err)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(chat)\\_components\\chat-interface.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 40 to the 25 allowed.","line":60,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":60,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | undefined`.","line":177,"column":25,"nodeType":"LogicalExpression","messageId":"unsafeArgument","endLine":177,"endColumn":55},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | undefined`.","line":183,"column":29,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":183,"endColumn":37},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 37 to the 25 allowed.","line":496,"column":55,"nodeType":null,"messageId":"refactorFunction","endLine":496,"endColumn":57},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_isFirstInGroup' is assigned a value but never used.","line":532,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":532,"endColumn":36}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useRef } from \"react\"\r\nimport { format, isToday, isYesterday, isSameDay } from \"date-fns\"\r\nimport { useTranslations, useLocale } from \"next-intl\"\r\nimport { bg, enUS } from \"date-fns/locale\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { UserAvatar } from \"@/components/shared/user-avatar\"\r\nimport { useMessages, type Message } from \"@/components/providers/message-context\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport { Skeleton } from \"@/components/ui/skeleton\"\r\nimport {\r\n  PaperPlaneTilt,\r\n  ArrowLeft,\r\n  X,\r\n  Archive,\r\n  CircleNotch,\r\n  Checks,\r\n  Check,\r\n  Phone,\r\n  VideoCamera,\r\n  Info,\r\n  Image as ImageIcon,\r\n  Heart,\r\n  Package,\r\n  ProhibitInset,\r\n  Flag,\r\n  ChatCircle,\r\n} from \"@phosphor-icons/react\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport { useToast } from \"@/hooks/use-toast\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport Image from \"next/image\"\r\n\r\nexport type ChatInterfaceServerActions = {\r\n  blockUser: (\r\n    userId: string,\r\n    reason?: string\r\n  ) => Promise<{ success: boolean; error: string | null }>\r\n  reportConversation: (\r\n    conversationId: string,\r\n    reason: \"spam\" | \"harassment\" | \"scam\" | \"inappropriate\" | \"other\",\r\n    description?: string\r\n  ) => Promise<{ success: boolean; error: string | null }>\r\n}\r\n\r\ninterface ChatInterfaceProps {\r\n  className?: string\r\n  onBack?: () => void\r\n  showHeader?: boolean\r\n  actions: ChatInterfaceServerActions\r\n}\r\n\r\nexport function ChatInterface({\r\n  className,\r\n  onBack,\r\n  showHeader = true,\r\n  actions,\r\n}: ChatInterfaceProps) {\r\n  const t = useTranslations(\"Messages\")\r\n  const locale = useLocale()\r\n  const dateLocale = locale === \"bg\" ? bg : enUS\r\n  const supabase = createClient()\r\n  const messagesContainerRef = useRef<HTMLDivElement>(null)\r\n  const inputRef = useRef<HTMLTextAreaElement>(null)\r\n  const fileInputRef = useRef<HTMLInputElement>(null)\r\n\r\n  const {\r\n    currentConversation,\r\n    messages,\r\n    isLoadingMessages,\r\n    isOtherUserTyping,\r\n    sendMessage,\r\n    sendTypingIndicator,\r\n    closeConversation,\r\n    error,\r\n  } = useMessages()\r\n\r\n  const { toast } = useToast()\r\n  const [inputValue, setInputValue] = useState(\"\")\r\n  const [isSending, setIsSending] = useState(false)\r\n  const [isUploadingImage, setIsUploadingImage] = useState(false)\r\n  const [isBlocking, setIsBlocking] = useState(false)\r\n  const [isReporting, setIsReporting] = useState(false)\r\n  const [currentUserId, setCurrentUserId] = useState<string | null>(null)\r\n\r\n  // Get current user\r\n  useEffect(() => {\r\n    const getUser = async () => {\r\n      const { data } = await supabase.auth.getUser()\r\n      if (data.user) {\r\n        setCurrentUserId(data.user.id)\r\n      }\r\n    }\r\n    getUser()\r\n  }, [supabase])\r\n\r\n  // Scroll to bottom when messages change\r\n  useEffect(() => {\r\n    const container = messagesContainerRef.current\r\n    if (container) {\r\n      container.scrollTop = container.scrollHeight\r\n    }\r\n  }, [messages])\r\n\r\n  // Auto-resize textarea and send typing indicator\r\n  const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\r\n    setInputValue(e.target.value)\r\n    // Auto-resize\r\n    e.target.style.height = \"auto\"\r\n    e.target.style.height = Math.min(e.target.scrollHeight, 120) + \"px\"\r\n    // Send typing indicator (throttled in context)\r\n    if (e.target.value.trim()) {\r\n      sendTypingIndicator()\r\n    }\r\n  }\r\n\r\n  const handleSend = async () => {\r\n    if (!inputValue.trim() || isSending) return\r\n\r\n    setIsSending(true)\r\n    try {\r\n      await sendMessage(inputValue.trim())\r\n      setInputValue(\"\")\r\n      // Reset textarea height\r\n      if (inputRef.current) {\r\n        inputRef.current.style.height = \"auto\"\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Error sending message:\", err)\r\n    } finally {\r\n      setIsSending(false)\r\n    }\r\n  }\r\n\r\n  const handleKeyDown = (e: React.KeyboardEvent) => {\r\n    if (e.key === \"Enter\" && !e.shiftKey) {\r\n      e.preventDefault()\r\n      handleSend()\r\n    }\r\n  }\r\n\r\n  // Handle image upload\r\n  const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0]\r\n    if (!file) return\r\n\r\n    // Validate file\r\n    if (!file.type.startsWith(\"image/\")) {\r\n      console.error(\"File must be an image\")\r\n      return\r\n    }\r\n\r\n    if (file.size > 5 * 1024 * 1024) {\r\n      console.error(\"Image too large (max 5MB)\")\r\n      return\r\n    }\r\n\r\n    setIsUploadingImage(true)\r\n    try {\r\n      const formData = new FormData()\r\n      formData.append(\"file\", file)\r\n\r\n      const response = await fetch(\"/api/upload-chat-image\", {\r\n        method: \"POST\",\r\n        body: formData,\r\n      })\r\n\r\n      if (!response.ok) {\r\n        const error = await response.json()\r\n        throw new Error(error.error || \"Upload failed\")\r\n      }\r\n\r\n      const data = await response.json()\r\n\r\n      // Send message with image attachment\r\n      await sendMessage(\"\", data.url)\r\n    } catch (err) {\r\n      console.error(\"Error uploading image:\", err)\r\n    } finally {\r\n      setIsUploadingImage(false)\r\n      // Reset file input\r\n      if (fileInputRef.current) {\r\n        fileInputRef.current.value = \"\"\r\n      }\r\n    }\r\n  }\r\n\r\n  // Handle blocking user\r\n  const handleBlockUser = async () => {\r\n    if (!currentConversation) return\r\n\r\n    // Determine who to block (the other party)\r\n    const userToBlock =\r\n      currentUserId === currentConversation.buyer_id\r\n        ? currentConversation.seller_id\r\n        : currentConversation.buyer_id\r\n\r\n    setIsBlocking(true)\r\n    try {\r\n      const result = await actions.blockUser(userToBlock)\r\n      if (result.success) {\r\n        toast({\r\n          title: locale === \"bg\" ? \"╨ƒ╨╛╤é╤Ç╨╡╨▒╨╕╤é╨╡╨╗╤Å╤é ╨╡ ╨▒╨╗╨╛╨║╨╕╤Ç╨░╨╜\" : \"User blocked\",\r\n          description:\r\n            locale === \"bg\"\r\n              ? \"╨ó╨╛╨╖╨╕ ╨┐╨╛╤é╤Ç╨╡╨▒╨╕╤é╨╡╨╗ ╨▓╨╡╤ç╨╡ ╨╜╨╡ ╨╝╨╛╨╢╨╡ ╨┤╨░ ╨▓╨╕ ╨╕╨╖╨┐╤Ç╨░╤ë╨░ ╤ü╤è╨╛╨▒╤ë╨╡╨╜╨╕╤Å\"\r\n              : \"This user can no longer message you\",\r\n        })\r\n        // Close the conversation\r\n        await closeConversation(currentConversation.id)\r\n      } else {\r\n        throw new Error(result.error || \"Failed to block user\")\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Error blocking user:\", err)\r\n      toast({\r\n        title: locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░\" : \"Error\",\r\n        description:\r\n          locale === \"bg\" ? \"╨¥╨╡╤â╤ü╨┐╨╡╤ê╨╜╨╛ ╨▒╨╗╨╛╨║╨╕╤Ç╨░╨╜╨╡ ╨╜╨░ ╨┐╨╛╤é╤Ç╨╡╨▒╨╕╤é╨╡╨╗╤Å\" : \"Failed to block user\",\r\n        variant: \"destructive\",\r\n      })\r\n    } finally {\r\n      setIsBlocking(false)\r\n    }\r\n  }\r\n\r\n  // Handle reporting conversation\r\n  const handleReportConversation = async () => {\r\n    if (!currentConversation) return\r\n\r\n    setIsReporting(true)\r\n    try {\r\n      const result = await actions.reportConversation(\r\n        currentConversation.id,\r\n        \"inappropriate\"\r\n      )\r\n      if (result.success) {\r\n        toast({\r\n          title: locale === \"bg\" ? \"╨ö╨╛╨║╨╗╨░╨┤╤è╤é ╨╡ ╨╕╨╖╨┐╤Ç╨░╤é╨╡╨╜\" : \"Report submitted\",\r\n          description:\r\n            locale === \"bg\"\r\n              ? \"╨æ╨╗╨░╨│╨╛╨┤╨░╤Ç╨╕╨╝ ╨▓╨╕ ╨╖╨░ ╤ü╨╕╨│╨╜╨░╨╗╨░. ╨⌐╨╡ ╨│╨╛ ╨┐╤Ç╨╡╨│╨╗╨╡╨┤╨░╨╝╨╡.\"\r\n              : \"Thank you for your report. We will review it.\",\r\n        })\r\n      } else {\r\n        throw new Error(result.error || \"Failed to report\")\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Error reporting conversation:\", err)\r\n      toast({\r\n        title: locale === \"bg\" ? \"╨ô╤Ç╨╡╤ê╨║╨░\" : \"Error\",\r\n        description:\r\n          locale === \"bg\" ? \"╨¥╨╡╤â╤ü╨┐╨╡╤ê╨╜╨╛ ╨╕╨╖╨┐╤Ç╨░╤ë╨░╨╜╨╡ ╨╜╨░ ╨┤╨╛╨║╨╗╨░╨┤╨░\" : \"Failed to submit report\",\r\n        variant: \"destructive\",\r\n      })\r\n    } finally {\r\n      setIsReporting(false)\r\n    }\r\n  }\r\n\r\n  // No conversation selected state - Instagram style\r\n  if (!currentConversation) {\r\n    return (\r\n      <div\r\n        className={cn(\r\n          \"flex flex-col items-center justify-center h-full bg-background\",\r\n          className\r\n        )}\r\n      >\r\n        <div className=\"flex flex-col items-center gap-4 p-4 text-center max-w-sm\">\r\n          <div className=\"flex size-20 items-center justify-center rounded-full border-2 border-border\">\r\n            <ChatCircle\r\n              size={40}\r\n              weight=\"regular\"\r\n              className=\"text-muted-foreground\"\r\n            />\r\n          </div>\r\n          <div>\r\n            <h3 className=\"text-lg font-semibold text-foreground mb-1\">\r\n              {t(\"selectConversation\")}\r\n            </h3>\r\n            <p className=\"text-sm text-muted-foreground\">\r\n              {locale === \"bg\" ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╤ç╨░╤é, ╨╖╨░ ╨┤╨░ ╨╖╨░╨┐╨╛╤ç╨╜╨╡╤é╨╡\" : \"Choose a chat to get started\"}\r\n            </p>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Get other party info based on whether current user is buyer or seller\r\n  const isBuyer = currentUserId === currentConversation.buyer_id\r\n  const otherProfile = isBuyer\r\n    ? currentConversation.seller_profile\r\n    : currentConversation.buyer_profile\r\n\r\n  // Fall back to legacy fields if new profile fields not available\r\n  // Type guard for seller_profile which has business_name\r\n  const sellerProfile = currentConversation.seller_profile\r\n  const displayName = isBuyer\r\n    ? (sellerProfile?.business_name || otherProfile?.display_name || otherProfile?.full_name || currentConversation.seller?.business_name || t(\"unknownUser\"))\r\n    : (otherProfile?.display_name || otherProfile?.full_name || currentConversation.buyer?.full_name || t(\"unknownUser\"))\r\n\r\n  const avatarUrl = otherProfile?.avatar_url ||\r\n    (isBuyer ? currentConversation.seller?.profile?.avatar_url : currentConversation.buyer?.avatar_url)\r\n\r\n  // Check if conversation is closed\r\n  const isClosed = currentConversation.status !== \"open\"\r\n\r\n  // Format date separator\r\n  const formatDateSeparator = (date: Date) => {\r\n    if (isToday(date)) return locale === \"bg\" ? \"╨ö╨╜╨╡╤ü\" : \"Today\"\r\n    if (isYesterday(date)) return locale === \"bg\" ? \"╨Æ╤ç╨╡╤Ç╨░\" : \"Yesterday\"\r\n    return format(date, \"d MMM yyyy\", { locale: dateLocale })\r\n  }\r\n\r\n  // Group messages by date and add separators\r\n  const messagesWithSeparators: Array<\r\n    { type: \"separator\"; date: Date } | { type: \"message\"; message: Message }\r\n  > = []\r\n  let lastDate: Date | null = null\r\n\r\n  messages.forEach((message) => {\r\n    const msgDate = new Date(message.created_at)\r\n    if (!lastDate || !isSameDay(lastDate, msgDate)) {\r\n      messagesWithSeparators.push({ type: \"separator\", date: msgDate })\r\n      lastDate = msgDate\r\n    }\r\n    messagesWithSeparators.push({ type: \"message\", message })\r\n  })\r\n\r\n  return (\r\n    <div className={cn(\"flex h-full flex-col bg-background overflow-hidden\", className)}>\r\n      {/* Header - Compact mobile style with safe area */}\r\n      {showHeader && (\r\n        <div className=\"shrink-0 border-b border-border px-2 py-2 pt-safe-max-xs bg-background\">\r\n          <div className=\"flex items-center gap-2\">\r\n            {/* Back button (mobile) */}\r\n            {onBack && (\r\n              <button\r\n                onClick={onBack}\r\n                className=\"flex items-center justify-center size-9 rounded-full hover:bg-hover active:bg-active transition-colors lg:hidden\"\r\n              >\r\n                <ArrowLeft size={22} weight=\"regular\" className=\"text-foreground\" />\r\n              </button>\r\n            )}\r\n\r\n            {/* Avatar - smaller on mobile */}\r\n            <Link href={`/seller/${currentConversation.seller_id}`} className=\"shrink-0\">\r\n              <UserAvatar\r\n                name={displayName}\r\n                avatarUrl={avatarUrl ?? null}\r\n                className=\"size-10\"\r\n                fallbackClassName=\"bg-primary text-primary-foreground text-sm font-semibold\"\r\n              />\r\n            </Link>\r\n\r\n            {/* Name and status - tighter */}\r\n            <div className=\"flex-1 min-w-0\">\r\n              <h2 className=\"font-semibold text-sm text-foreground truncate leading-tight\">\r\n                {displayName}\r\n              </h2>\r\n              {currentConversation.product ? (\r\n                <Link\r\n                  href={`/product/${currentConversation.product.id}`}\r\n                  className=\"text-xs text-muted-foreground hover:text-foreground transition-colors truncate block leading-tight\"\r\n                >\r\n                  {currentConversation.product.title}\r\n                </Link>\r\n              ) : (\r\n                <p className=\"text-xs text-muted-foreground leading-tight\">\r\n                  {isClosed\r\n                    ? locale === \"bg\"\r\n                      ? \"╨ù╨░╤é╨▓╨╛╤Ç╨╡╨╜ ╤ç╨░╤é\"\r\n                      : \"Chat closed\"\r\n                    : locale === \"bg\"\r\n                      ? \"╨É╨║╤é╨╕╨▓╨╡╨╜\"\r\n                      : \"Active\"}\r\n                </p>\r\n              )}\r\n            </div>\r\n\r\n            {/* Action buttons - compact */}\r\n            <div className=\"flex items-center\">\r\n              <button className=\"flex items-center justify-center size-9 rounded-full hover:bg-muted transition-colors\">\r\n                <Phone size={20} weight=\"regular\" className=\"text-foreground\" />\r\n              </button>\r\n              <button className=\"flex items-center justify-center size-9 rounded-full hover:bg-muted transition-colors\">\r\n                <VideoCamera size={20} weight=\"regular\" className=\"text-foreground\" />\r\n              </button>\r\n              <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                  <button className=\"flex items-center justify-center size-9 rounded-full hover:bg-muted transition-colors\">\r\n                    <Info size={22} weight=\"regular\" className=\"text-foreground\" />\r\n                  </button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent align=\"end\" className=\"w-48\">\r\n                  {!isClosed && (\r\n                    <DropdownMenuItem onClick={() => closeConversation(currentConversation.id)}>\r\n                      <X size={16} weight=\"regular\" className=\"mr-2\" />\r\n                      {t(\"closeConversation\")}\r\n                    </DropdownMenuItem>\r\n                  )}\r\n                  <DropdownMenuItem>\r\n                    <Archive size={16} weight=\"regular\" className=\"mr-2\" />\r\n                    {t(\"archiveConversation\")}\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuSeparator />\r\n                  <DropdownMenuItem onClick={handleReportConversation} disabled={isReporting}>\r\n                    <Flag size={16} weight=\"regular\" className=\"mr-2\" />\r\n                    {isReporting\r\n                      ? locale === \"bg\"\r\n                        ? \"╨ÿ╨╖╨┐╤Ç╨░╤ë╨░╨╜╨╡...\"\r\n                        : \"Reporting...\"\r\n                      : locale === \"bg\"\r\n                        ? \"╨ö╨╛╨║╨╗╨░╨┤╨▓╨░╨╣ ╤Ç╨░╨╖╨│╨╛╨▓╨╛╤Ç\"\r\n                        : \"Report conversation\"}\r\n                  </DropdownMenuItem>\r\n                  <DropdownMenuItem\r\n                    onClick={handleBlockUser}\r\n                    disabled={isBlocking}\r\n                    className=\"text-destructive focus:text-destructive focus:bg-destructive-subtle\"\n                  >\r\n                    <ProhibitInset size={16} weight=\"regular\" className=\"mr-2\" />\r\n                    {isBlocking\r\n                      ? locale === \"bg\"\r\n                        ? \"╨æ╨╗╨╛╨║╨╕╤Ç╨░╨╜╨╡...\"\r\n                        : \"Blocking...\"\r\n                      : locale === \"bg\"\r\n                        ? \"╨æ╨╗╨╛╨║╨╕╤Ç╨░╨╣ ╨┐╨╛╤é╤Ç╨╡╨▒╨╕╤é╨╡╨╗╤Å\"\r\n                        : \"Block user\"}\r\n                  </DropdownMenuItem>\r\n                </DropdownMenuContent>\r\n              </DropdownMenu>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Messages area - proper mobile padding */}\r\n      <div\r\n        ref={messagesContainerRef}\r\n        className=\"flex-1 min-h-0 overflow-y-auto overscroll-contain px-3 py-3\"\r\n      >\r\n        {isLoadingMessages ? (\r\n          <div className=\"space-y-4\">\r\n            {[1, 2, 3, 4].map((i) => (\r\n              <div\r\n                key={i}\r\n                className={cn(\"flex items-end gap-2\", i % 2 === 0 && \"justify-end\")}\r\n              >\r\n                {i % 2 !== 0 && <Skeleton className=\"size-7 rounded-full shrink-0\" />}\r\n                <Skeleton\r\n                  className={cn(\r\n                    \"h-12 rounded-md\",\r\n                    i % 2 === 0 ? \"w-40 rounded-br-md\" : \"w-48 rounded-bl-md\"\r\n                  )}\r\n                />\r\n              </div>\r\n            ))}\r\n          </div>\r\n        ) : messages.length === 0 ? (\r\n          <div className=\"flex flex-col items-center justify-center h-full text-center\">\r\n            {/* Profile card for new conversations */}\r\n            <div className=\"flex flex-col items-center gap-3 mb-6\">\r\n              <UserAvatar\r\n                name={displayName}\r\n                avatarUrl={avatarUrl ?? null}\r\n                className=\"size-24\"\r\n                fallbackClassName=\"bg-primary text-primary-foreground text-2xl font-bold\"\r\n              />\r\n              <div>\r\n                <h3 className=\"text-lg font-semibold text-foreground\">{displayName}</h3>\r\n                {currentConversation.product && (\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    {currentConversation.product.title}\r\n                  </p>\r\n                )}\r\n              </div>\r\n            </div>\r\n            <p className=\"text-sm text-muted-foreground max-w-xs\">\r\n              {locale === \"bg\"\r\n                ? \"╨ù╨░╨┐╨╛╤ç╨╜╨╡╤é╨╡ ╤Ç╨░╨╖╨│╨╛╨▓╨╛╤Ç╨░. ╨í╤è╨╛╨▒╤ë╨╡╨╜╨╕╤Å╤é╨░ ╨╕╨╖╤ç╨╡╨╖╨▓╨░╤é ╤ü╨╗╨╡╨┤ ╨║╨░╤é╨╛ ╨┐╨╛╤Ç╤è╤ç╨║╨░╤é╨░ ╨▒╤è╨┤╨╡ ╨┤╨╛╤ü╤é╨░╨▓╨╡╨╜╨░.\"\r\n                : \"Start the conversation. Messages disappear after the order is delivered.\"}\r\n            </p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-1\">\r\n            {messagesWithSeparators.map((item, index) => {\r\n              if (item.type === \"separator\") {\r\n                // Check if next item is an order notification - if so, skip separator (it renders below the banner)\r\n                const nextItem = messagesWithSeparators[index + 1]\r\n                if (nextItem?.type === \"message\") {\r\n                  const isNextOrderNotification =\r\n                    nextItem.message.message_type === \"system\" &&\r\n                    (nextItem.message.content.includes(\"New Order\") ||\r\n                      nextItem.message.content.includes(\"╨¥╨╛╨▓╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨░\"))\r\n                  if (isNextOrderNotification) {\r\n                    return null // Separator will be rendered below the order banner\r\n                  }\r\n                }\r\n\r\n                return (\r\n                  <div key={`sep-${index}`} className=\"flex items-center justify-center py-4\">\r\n                    <span className=\"text-xs text-muted-foreground bg-muted px-3 py-1 rounded-full\">\r\n                      {formatDateSeparator(item.date)}\r\n                    </span>\r\n                  </div>\r\n                )\r\n              }\r\n\r\n              const message = item.message\r\n              const isOwn = message.sender_id === currentUserId\r\n              const isSystemMessage = message.message_type === \"system\"\r\n\r\n              // Check if this is the last message in a group from same sender\r\n              const nextItem = messagesWithSeparators[index + 1]\r\n              const isLastInGroup =\r\n                !nextItem ||\r\n                nextItem.type === \"separator\" ||\r\n                nextItem.message.sender_id !== message.sender_id\r\n\r\n              // Check previous item for avatar display\r\n              const prevItem = messagesWithSeparators[index - 1]\r\n              const _isFirstInGroup =\r\n                !prevItem ||\r\n                prevItem.type === \"separator\" ||\r\n                prevItem.message.sender_id !== message.sender_id\r\n\r\n              // System messages render as notification banners\r\n              if (isSystemMessage) {\r\n                // Parse order notification data from message content\r\n                const isOrderNotification =\r\n                  message.content.includes(\"New Order\") || message.content.includes(\"╨¥╨╛╨▓╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨░\")\r\n                const productImage = currentConversation?.product?.images?.[0]\r\n\r\n                // Extract order details from message - Price: $20.00 format\r\n                const priceMatch = message.content.match(\r\n                  /Price:\\s*\\$?([\\d,.]+)|╨ª╨╡╨╜╨░:\\s*\\$?([\\d,.]+)/\r\n                )\r\n                const price = priceMatch ? priceMatch[1] || priceMatch[2] : null\r\n                const quantityMatch = message.content.match(\r\n                  /Quantity:\\s*(\\d+)|╨Ü╨╛╨╗╨╕╤ç╨╡╤ü╤é╨▓╨╛:\\s*(\\d+)/\r\n                )\r\n                const quantity = quantityMatch ? quantityMatch[1] || quantityMatch[2] : \"1\"\r\n\r\n                // Check if previous item was a date separator (to render it below the banner)\r\n                const hadDateSeparator = prevItem?.type === \"separator\"\r\n                const separatorDate = hadDateSeparator ? prevItem.date : null\r\n\r\n                // Order notification banner\r\n                if (isOrderNotification && currentConversation?.product) {\r\n                  return (\r\n                    <div key={message.id} className=\"mt-2\">\r\n                      {/* Minimal order notification card */}\r\n                      <div className=\"flex items-stretch gap-0 rounded-lg border border-border bg-card overflow-hidden\">\r\n                        {/* Product image - clickable */}\r\n                        {productImage ? (\r\n                          <Link href={`/product/${currentConversation.product.id}`} className=\"shrink-0\">\r\n                            <div className=\"relative w-16 h-full min-h-16 bg-muted\">\r\n                              <Image\r\n                                src={productImage}\r\n                                alt={currentConversation.product.title}\r\n                                fill\r\n                                className=\"object-cover\"\r\n                              />\r\n                            </div>\r\n                          </Link>\r\n                        ) : (\r\n                          <div className=\"flex items-center justify-center w-16 bg-muted shrink-0\">\r\n                            <Package size={24} weight=\"regular\" className=\"text-muted-foreground\" />\r\n                          </div>\r\n                        )}\r\n\r\n                        {/* Order info */}\r\n                        <div className=\"flex-1 min-w-0 px-3 py-2\">\r\n                          {/* Header row */}\r\n                          <div className=\"flex items-center gap-1.5\">\r\n                            <Package size={12} weight=\"fill\" className=\"text-primary shrink-0\" />\r\n                            <span className=\"text-xs font-medium text-primary\">\r\n                              {locale === \"bg\" ? \"╨ƒ╨╛╤Ç╤è╤ç╨║╨░\" : \"Order\"}\r\n                            </span>\r\n                            <span className=\"text-2xs text-muted-foreground ml-auto\">\r\n                              {format(new Date(message.created_at), \"MMM d, HH:mm\", { locale: dateLocale })}\r\n                            </span>\r\n                          </div>\r\n\r\n                          {/* Product title */}\r\n                          <p className=\"text-sm font-medium text-foreground truncate mt-0.5\">\r\n                            {currentConversation.product.title}\r\n                          </p>\r\n\r\n                          {/* Price & quantity row */}\r\n                          <div className=\"flex items-center gap-2 mt-1\">\r\n                            {price && (\r\n                              <span className=\"text-xs font-medium text-foreground\">${price}</span>\r\n                            )}\r\n                            {quantity !== \"1\" && (\r\n                              <span className=\"text-xs text-muted-foreground\">├ù {quantity}</span>\r\n                            )}\r\n                            <span className=\"inline-flex items-center gap-1 text-2xs text-warning ml-auto\">\r\n                              <span className=\"size-1.5 rounded-full bg-warning animate-pulse\" />\r\n                              {locale === \"bg\" ? \"╨ÿ╨╖╤ç╨░╨║╨▓╨░\" : \"Pending\"}\r\n                            </span>\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n\r\n                      {/* Date separator BELOW the order banner */}\r\n                      {separatorDate && (\r\n                        <div className=\"flex items-center justify-center py-3\">\r\n                          <span className=\"text-xs text-muted-foreground bg-muted px-3 py-1 rounded-full\">\r\n                            {formatDateSeparator(separatorDate)}\r\n                          </span>\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  )\r\n                }\r\n\r\n                // Generic system message (status updates, etc.)\r\n                return (\r\n                  <div key={message.id} className=\"flex justify-center my-3\">\r\n                    <div className=\"inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-surface-subtle border border-border/50\">\r\n                      <span className=\"text-xs text-muted-foreground\">\r\n                        {message.content.replaceAll('**', \"\").replaceAll('_', \"\").split(\"\\n\")[0]}\r\n                      </span>\r\n                      <span className=\"text-2xs text-muted-foreground\">\r\n                        {format(new Date(message.created_at), \"HH:mm\")}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                )\r\n              }\r\n\r\n              return (\r\n                <div\r\n                  key={message.id}\r\n                  className={cn(\r\n                    \"flex items-end gap-2\",\r\n                    isOwn && \"justify-end\",\r\n                    !isLastInGroup && \"mb-0.5\"\r\n                  )}\r\n                >\r\n                  {/* Avatar - only show for received messages and last in group */}\r\n                  {!isOwn && (\r\n                    <div className=\"shrink-0 w-7\">\r\n                      {isLastInGroup && (\r\n                        <UserAvatar\r\n                          name={displayName}\r\n                          avatarUrl={avatarUrl ?? null}\r\n                          className=\"size-7\"\r\n                          fallbackClassName=\"bg-primary text-primary-foreground text-2xs font-semibold\"\r\n                        />\r\n                      )}\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Message bubble */}\r\n                  <div\r\n                    className={cn(\r\n                      \"max-w-(--chat-message-max-w) relative group\",\r\n                      message.message_type === \"image\" ? \"p-1\" : \"px-3 py-1.5\",\r\n                      isOwn\r\n                        ? \"bg-primary text-primary-foreground rounded-2xl rounded-br-md\"\r\n                        : \"bg-muted rounded-2xl rounded-bl-md\"\r\n                    )}\r\n                  >\r\n                    {/* Message content - image or text */}\r\n                    {message.message_type === \"image\" && message.attachment_url ? (\r\n                      <a\r\n                        href={message.attachment_url}\r\n                        target=\"_blank\"\r\n                        rel=\"noopener noreferrer\"\r\n                        className=\"block\"\r\n                      >\r\n                        <Image\r\n                          src={message.attachment_url}\r\n                          alt=\"Shared image\"\r\n                          width={240}\r\n                          height={240}\r\n                          className=\"rounded-xl max-w-60 w-auto h-auto object-cover cursor-pointer hover:opacity-95 transition-opacity\"\r\n                          unoptimized\r\n                        />\r\n                      </a>\r\n                    ) : (\r\n                      <p className=\"text-sm leading-snug whitespace-pre-wrap break-words\">\r\n                        {message.content}\r\n                      </p>\r\n                    )}\r\n\r\n                    {/* Time - show on last message in group */}\r\n                    {isLastInGroup && (\r\n                      <div\r\n                        className={cn(\r\n                          \"flex items-center gap-1 mt-1\",\r\n                          isOwn ? \"justify-end\" : \"justify-start\"\r\n                        )}\r\n                      >\r\n                        <span\r\n                          className={cn(\r\n                            \"text-2xs\",\r\n                            isOwn ? \"text-foreground\" : \"text-muted-foreground\"\r\n                          )}\r\n                        >\r\n                          {format(new Date(message.created_at), \"HH:mm\")}\r\n                        </span>\r\n                        {isOwn &&\r\n                          (message.is_read ? (\r\n                            <Checks size={12} weight=\"bold\" className=\"text-foreground\" />\r\n                          ) : (\r\n                            <Check size={12} weight=\"regular\" className=\"text-foreground\" />\r\n                          ))}\r\n                      </div>\r\n                    )}\r\n\r\n                    {/* Like reaction button - appears on hover */}\r\n                    <button\r\n                      className={cn(\r\n                        \"absolute top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity\",\r\n                        \"flex items-center justify-center size-7 rounded-full bg-background border border-border shadow-sm hover:bg-accent\",\r\n                        isOwn ? \"-left-9\" : \"-right-9\"\r\n                      )}\r\n                    >\r\n                      <Heart size={14} weight=\"regular\" className=\"text-muted-foreground\" />\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              )\r\n            })}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Typing indicator - fixed height to prevent layout shift */}\r\n      <div className=\"h-6 px-4 flex items-center\">\r\n        {isOtherUserTyping && !isClosed && (\r\n          <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\r\n            <div className=\"flex gap-1\">\r\n              <span\r\n                className=\"size-1.5 rounded-full bg-muted animate-bounce\"\r\n                style={{ animationDelay: \"0ms\" }}\r\n              />\r\n              <span\r\n                className=\"size-1.5 rounded-full bg-muted animate-bounce\"\r\n                style={{ animationDelay: \"150ms\" }}\r\n              />\r\n              <span\r\n                className=\"size-1.5 rounded-full bg-muted animate-bounce\"\r\n                style={{ animationDelay: \"300ms\" }}\r\n              />\r\n            </div>\r\n            <span>\r\n              {displayName} {locale === \"bg\" ? \"╨┐╨╕╤ê╨╡...\" : \"is typing...\"}\r\n            </span>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Input area - with safe area for mobile */}\r\n      <div className=\"shrink-0 border-t border-border px-2 py-2 bg-background pb-safe-max-xs\">\r\n        {isClosed ? (\r\n          <div className=\"flex items-center justify-center py-2 px-4 rounded-full bg-muted\">\r\n            <p className=\"text-sm text-muted-foreground\">{t(\"conversationClosed\")}</p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"flex items-end gap-1.5\">\r\n            {/* Hidden file input for image upload */}\r\n            <input\r\n              ref={fileInputRef}\r\n              type=\"file\"\r\n              accept=\"image/*\"\r\n              onChange={handleImageUpload}\r\n              className=\"hidden\"\r\n            />\r\n\r\n            {/* Image upload button */}\r\n            <button\r\n              onClick={() => fileInputRef.current?.click()}\r\n              disabled={isUploadingImage || isSending}\r\n              className=\"flex items-center justify-center size-10 rounded-full hover:bg-hover active:bg-active transition-colors shrink-0 disabled:opacity-50\"\r\n            >\r\n              {isUploadingImage ? (\r\n                <CircleNotch size={22} weight=\"regular\" className=\"text-primary animate-spin\" />\r\n              ) : (\r\n                <ImageIcon size={22} weight=\"regular\" className=\"text-primary\" />\r\n              )}\r\n            </button>\r\n\r\n            {/* Input container - using ring pattern from shadcn */}\r\n            <div className=\"flex-1 flex items-end gap-2 px-3 py-2 rounded-full bg-surface-subtle ring-1 ring-border focus-within:ring-2 focus-within:ring-ring transition-shadow min-h-10\">\r\n              <textarea\r\n                ref={inputRef}\r\n                value={inputValue}\r\n                onChange={handleInputChange}\r\n                onKeyDown={handleKeyDown}\r\n                placeholder={t(\"typeMessage\")}\r\n                disabled={isSending || isUploadingImage}\r\n                rows={1}\r\n                className=\"no-focus-ring flex-1 bg-transparent text-base placeholder:text-muted-foreground resize-none outline-none min-h-5 max-h-24 py-0 leading-5\"\r\n              />\r\n            </div>\r\n\r\n            {/* Send button */}\r\n            <button\r\n              onClick={handleSend}\r\n              disabled={isSending || isUploadingImage || !inputValue.trim()}\r\n              className={cn(\r\n                \"flex items-center justify-center size-10 rounded-full transition-colors shrink-0 disabled:opacity-50\",\r\n                inputValue.trim()\r\n                  ? \"bg-primary text-primary-foreground hover:bg-interactive-hover\"\r\n                  : \"bg-muted text-muted-foreground\"\r\n              )}\r\n            >\r\n              {isSending ? (\r\n                <CircleNotch size={18} weight=\"regular\" className=\"animate-spin\" />\r\n              ) : (\r\n                <PaperPlaneTilt size={18} weight=\"fill\" />\r\n              )}\r\n            </button>\r\n          </div>\r\n        )}\r\n\r\n        {error && <p className=\"text-xs text-destructive mt-2 text-center\">{error}</p>}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(chat)\\_components\\chat-skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(chat)\\_components\\conversation-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(chat)\\_components\\conversation-page-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(chat)\\_components\\messages-page-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(chat)\\chat\\[conversationId]\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(chat)\\chat\\[conversationId]\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/blocked-users' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":6,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":6,"endColumn":56}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { notFound } from \"next/navigation\"\r\nimport { getTranslations, setRequestLocale } from \"next-intl/server\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { validateLocale, routing } from \"@/i18n/routing\"\r\nimport { ConversationPageClient } from \"../../_components/conversation-page-client\"\r\nimport { blockUser } from \"@/app/actions/blocked-users\"\r\nimport { reportConversation } from \"../../_actions/report-conversation\"\r\nimport { AuthGateCard } from \"@/components/shared/auth/auth-gate-card\"\r\n\r\n// Generate static params for build validation (required by cacheComponents)\r\n// Actual pages are rendered server-side for authenticated users\r\nexport function generateStaticParams() {\r\n  return routing.locales.map((locale) => ({ locale, conversationId: \"__placeholder__\" }))\r\n}\r\n\r\n/**\r\n * Generate SEO-friendly metadata for conversation pages\r\n * Title includes the other party's name for context\r\n */\r\nexport async function generateMetadata({\r\n  params,\r\n}: {\r\n  params: Promise<{ locale: string; conversationId: string }>\r\n}) {\r\n  const { locale, conversationId } = await params\r\n  const t = await getTranslations({ locale, namespace: \"Messages\" })\r\n  const supabase = await createClient()\r\n\r\n  if (!supabase) {\r\n    return {\r\n      title: t(\"pageTitle\"),\r\n      description: t(\"pageDescription\"),\r\n    }\r\n  }\r\n\r\n  // Fetch conversation details for metadata\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  \r\n  if (!user) {\r\n    return {\r\n      title: t(\"pageTitle\"),\r\n      description: t(\"pageDescription\"),\r\n    }\r\n  }\r\n\r\n  // Get conversation with product info\r\n  const { data: conversation } = await supabase\r\n    .from(\"conversations\")\r\n    .select(`\r\n      id,\r\n      buyer_id,\r\n      seller_id,\r\n      product:products(title)\r\n    `)\r\n    .eq(\"id\", conversationId)\r\n    .single()\r\n\r\n  if (!conversation) {\r\n    return {\r\n      title: t(\"pageTitle\"),\r\n      description: t(\"pageDescription\"),\r\n    }\r\n  }\r\n\r\n  // Get the other party's profile\r\n  const otherPartyId = conversation.buyer_id === user.id \r\n    ? conversation.seller_id \r\n    : conversation.buyer_id\r\n\r\n  const { data: profile } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"display_name, full_name, business_name\")\r\n    .eq(\"id\", otherPartyId)\r\n    .single()\r\n\r\n  const otherName = profile?.business_name || profile?.display_name || profile?.full_name || t(\"unknownUser\")\r\n  const productTitle = conversation.product?.title\r\n\r\n  return {\r\n    title: productTitle \r\n      ? t(\"conversationWithProductTitle\", { name: otherName, product: productTitle })\r\n      : t(\"conversationTitle\", { name: otherName }),\r\n    description: t(\"conversationDescription\", { name: otherName }),\r\n    robots: {\r\n      index: false, // Private conversations shouldn't be indexed\r\n      follow: false,\r\n    },\r\n  }\r\n}\r\n\r\n/**\r\n * Conversation Page - Server Component\r\n * \r\n * This page displays a specific conversation using the proper App Router\r\n * dynamic segment pattern: /chat/[conversationId]\r\n * \r\n * - Server-side auth validation\r\n * - Server-side conversation access check\r\n * - Proper metadata generation\r\n * - SEO-friendly URLs\r\n */\r\nexport default async function ConversationPage({\r\n  params,\r\n}: {\r\n  params: Promise<{ locale: string; conversationId: string }>\r\n}) {\r\n  const { locale: localeParam, conversationId } = await params\r\n  const locale = validateLocale(localeParam)\r\n\r\n  // Enable static rendering\r\n  setRequestLocale(locale)\r\n\r\n  const supabase = await createClient()\r\n\r\n  const { data: { user } } = await (supabase\r\n    ? supabase.auth.getUser()\r\n    : Promise.resolve({ data: { user: null } }))\r\n\r\n  if (!user) {\r\n    const t = await getTranslations({ locale, namespace: \"Drawers\" })\r\n    return (\r\n      <div className=\"flex w-full flex-1 items-center justify-center px-inset py-8\">\r\n        <AuthGateCard\r\n          title={t(\"signInPrompt\")}\r\n          description={t(\"signInDescription\")}\r\n          nextPath={`/chat/${conversationId}`}\r\n        />\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Validate conversation exists and user has access\r\n  const { data: conversation, error } = await supabase\r\n    .from(\"conversations\")\r\n    .select(\"id, buyer_id, seller_id\")\r\n    .eq(\"id\", conversationId)\r\n    .single()\r\n\r\n  if (error || !conversation) {\r\n    notFound()\r\n  }\r\n\r\n  // Check user is part of this conversation\r\n  const isParticipant = conversation.buyer_id === user.id || conversation.seller_id === user.id\r\n\r\n  if (!isParticipant) {\r\n    notFound()\r\n  }\r\n\r\n  return (\r\n    <ConversationPageClient \r\n      conversationId={conversationId}\r\n      actions={{ blockUser, reportConversation }}\r\n    />\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(chat)\\chat\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(chat)\\chat\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/blocked-users' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":5,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":5,"endColumn":56}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { getTranslations } from \"next-intl/server\"\r\nimport { redirect } from \"@/i18n/routing\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { MessagesPageClient } from \"../_components/messages-page-client\"\r\nimport { blockUser } from \"@/app/actions/blocked-users\"\r\nimport { reportConversation } from \"../_actions/report-conversation\"\r\nimport { AuthGateCard } from \"@/components/shared/auth/auth-gate-card\"\r\n\r\nexport async function generateMetadata({\r\n  params\r\n}: {\r\n  params: Promise<{ locale: string }>\r\n}) {\r\n  const { locale } = await params\r\n  const t = await getTranslations({ locale, namespace: \"Messages\" })\r\n\r\n  return {\r\n    title: t(\"pageTitle\"),\r\n    description: t(\"pageDescription\")\r\n  }\r\n}\r\n\r\nexport default async function MessagesPage({\r\n  params,\r\n  searchParams,\r\n}: {\r\n  params: Promise<{ locale: string }>\r\n  searchParams: Promise<{ conversation?: string; seller?: string; product?: string }>\r\n}) {\r\n  const { locale } = await params\r\n  const { conversation, seller, product } = await searchParams\r\n  const supabase = await createClient()\r\n\r\n  const { data: { user } } = await (supabase\r\n    ? supabase.auth.getUser()\r\n    : Promise.resolve({ data: { user: null } }))\r\n\r\n  if (!user) {\r\n    const t = await getTranslations({ locale, namespace: \"Drawers\" })\r\n    return (\r\n      <div className=\"flex w-full flex-1 items-center justify-center px-inset py-8\">\r\n        <AuthGateCard title={t(\"signInPrompt\")} description={t(\"signInDescription\")} nextPath=\"/chat\" />\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Handle legacy URL format: /chat?conversation=xxx -> /chat/xxx\r\n  // This ensures old links continue to work and get redirected to the new format\r\n  if (conversation) {\r\n    return redirect({ href: `/chat/${conversation}`, locale })\r\n  }\r\n\r\n  return (\r\n    <MessagesPageClient \r\n      actions={{ blockUser, reportConversation }} \r\n      initialSellerId={seller}\r\n      initialProductId={product}\r\n    />\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(chat)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\_actions\\checkout.ts","messages":[{"ruleId":"sonarjs/no-all-duplicated-branches","severity":1,"message":"This conditional operation returns the same value whether the condition is \"true\" or \"false\".","line":60,"column":11,"nodeType":"ConditionalExpression","messageId":"returnsTheSameValue","endLine":62,"endColumn":17},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 35 to the 25 allowed.","line":74,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":74,"endColumn":44},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":169,"column":21,"nodeType":"CallExpression","messageId":"array-from","endLine":169,"endColumn":56,"fix":{"range":[5842,5877],"text":"[...itemsBySeller.entries()]"}},{"ruleId":"prefer-const","severity":2,"message":"'userId' is never reassigned. Use 'const' instead.","line":312,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":312,"endColumn":11},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 29 to the 25 allowed.","line":356,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":356,"endColumn":43}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use server\"\r\n\r\nimport { stripe } from \"@/lib/stripe\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { getFeesForSeller, calculateTransactionFees } from \"@/lib/stripe-connect\"\r\nimport { getTranslations } from \"next-intl/server\"\r\nimport type { CartItem } from \"@/components/providers/cart-context\"\r\nimport { ensureOrderConversations } from \"@/lib/order-conversations\"\r\nimport type { Json } from \"@/lib/supabase/database.types\"\r\nimport type Stripe from \"stripe\"\r\n\r\ntype SellerInfo = {\r\n  sellerId: string\r\n  stripeAccountId: string | null\r\n  chargesEnabled: boolean\r\n}\r\n\r\nconst MAX_CHECKOUT_QUANTITY = 99\r\n\r\nfunction isValidQuantity(value: unknown): value is number {\r\n  return typeof value === \"number\"\r\n    && Number.isFinite(value)\r\n    && Number.isSafeInteger(value)\r\n    && value > 0\r\n    && value <= MAX_CHECKOUT_QUANTITY\r\n}\r\n\r\nexport type CreateCheckoutSessionResult =\r\n  | { ok: true; url: string }\r\n  | { ok: false; error: string }\r\n\r\ntype SessionItem = { id: string; variantId?: string | null; qty: number; price: number }\r\n\r\nfunction parseSessionItemsJson(itemsJson: string | undefined): SessionItem[] | null {\r\n  if (!itemsJson) return null\r\n\r\n  let parsed: unknown\r\n  try {\r\n    parsed = JSON.parse(itemsJson) as unknown\r\n  } catch {\r\n    return null\r\n  }\r\n\r\n  if (!Array.isArray(parsed) || parsed.length === 0) return null\r\n\r\n  const items: SessionItem[] = []\r\n\r\n  for (const rawItem of parsed) {\r\n    if (!rawItem || typeof rawItem !== \"object\") return null\r\n    const record = rawItem as Record<string, unknown>\r\n\r\n    const id = typeof record.id === \"string\" ? record.id : \"\"\r\n    const qty = typeof record.qty === \"number\" ? record.qty : Number.NaN\r\n    const price = typeof record.price === \"number\" ? record.price : Number.NaN\r\n\r\n    const variantIdRaw = record.variantId\r\n    const variantId =\r\n      typeof variantIdRaw === \"string\"\r\n        ? variantIdRaw\r\n        : variantIdRaw === null\r\n          ? null\r\n          : null\r\n\r\n    if (!id) return null\r\n    if (!Number.isFinite(qty) || !Number.isSafeInteger(qty) || qty <= 0 || qty > MAX_CHECKOUT_QUANTITY) return null\r\n    if (!Number.isFinite(price) || price <= 0) return null\r\n\r\n    items.push({ id, variantId, qty, price })\r\n  }\r\n\r\n  return items\r\n}\r\n\r\nexport async function createCheckoutSession(\r\n  items: CartItem[],\r\n  locale?: \"en\" | \"bg\"\r\n): Promise<CreateCheckoutSessionResult> {\r\n  if (!process.env.STRIPE_SECRET_KEY) {\r\n    console.error(\"STRIPE_SECRET_KEY is missing\")\r\n    return { ok: false, error: \"Stripe configuration is missing. Please check your server logs.\" }\r\n  }\r\n\r\n  // Validate items before proceeding\r\n  if (!items || items.length === 0) {\r\n    return { ok: false, error: \"No items in cart\" }\r\n  }\r\n\r\n  // Validate each item has required fields\r\n  for (const item of items) {\r\n    if (!item.id || !item.title || typeof item.price !== \"number\" || !Number.isFinite(item.price) || item.price <= 0 || !isValidQuantity(item.quantity)) {\r\n      console.error(\"Invalid cart item:\", item)\r\n      return { ok: false, error: \"Invalid cart item data. Please refresh and try again.\" }\r\n    }\r\n  }\r\n\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    const userId = user?.id\r\n\r\n    // Orders are owned by a user_id (uuid) and are created by webhook/verify flows.\r\n    // Prevent guest checkout sessions that would be impossible to convert into a valid order.\r\n    if (!userId) {\r\n      return { ok: false, error: \"Please sign in to checkout.\" }\r\n    }\r\n\r\n    const productIds = items.map((item) => item.id).filter(Boolean)\r\n\r\n    // Get products with seller info\r\n    const { data: products, error: productsError } = await supabase\r\n      .from(\"products\")\r\n      .select(\"id, seller_id, title\")\r\n      .in(\"id\", productIds)\r\n\r\n    if (productsError || !products) {\r\n      return { ok: false, error: \"Failed to load product information\" }\r\n    }\r\n\r\n    // Check for own products\r\n    if (userId) {\r\n      const ownProducts = products.filter((p) => p.seller_id === userId)\r\n      if (ownProducts.length > 0) {\r\n        const ownProductTitles = ownProducts.map((p) => p.title).join(\", \")\r\n        return { ok: false, error: `You cannot purchase your own products: ${ownProductTitles}` }\r\n      }\r\n    }\r\n\r\n    // Get unique seller IDs\r\n    const sellerIds = [...new Set(products.map((p) => p.seller_id).filter(Boolean))]\r\n\r\n    // Get seller payout status for Connect payments\r\n    const { data: payoutStatuses } = await supabase\r\n      .from(\"seller_payout_status\")\r\n      .select(\"seller_id, stripe_connect_account_id, charges_enabled\")\r\n      .in(\"seller_id\", sellerIds)\r\n\r\n    const sellerMap = new Map<string, SellerInfo>()\r\n    for (const sellerId of sellerIds) {\r\n      const status = payoutStatuses?.find((s) => s.seller_id === sellerId)\r\n      sellerMap.set(sellerId, {\r\n        sellerId,\r\n        stripeAccountId: status?.stripe_connect_account_id ?? null,\r\n        chargesEnabled: status?.charges_enabled ?? false,\r\n      })\r\n    }\r\n\r\n    // Group items by seller\r\n    const itemsBySeller = new Map<string, CartItem[]>()\r\n    for (const item of items) {\r\n      const product = products.find((p) => p.id === item.id)\r\n      if (product?.seller_id) {\r\n        const existing = itemsBySeller.get(product.seller_id) || []\r\n        existing.push(item)\r\n        itemsBySeller.set(product.seller_id, existing)\r\n      }\r\n    }\r\n\r\n    // For now, we only support single-seller checkout with Connect\r\n    // Multi-seller checkout would require separate payment intents\r\n    if (itemsBySeller.size > 1) {\r\n      return { ok: false, error: \"Please checkout items from one seller at a time. Multi-seller checkout coming soon.\" }\r\n    }\r\n\r\n    if (itemsBySeller.size === 0) {\r\n      return { ok: false, error: \"No products found for checkout\" }\r\n    }\r\n\r\n    const entries = Array.from(itemsBySeller.entries())\r\n    const firstEntry = entries[0]\r\n    if (!firstEntry) {\r\n      return { ok: false, error: \"No products found for checkout\" }\r\n    }\r\n\r\n    const [sellerId, sellerItems] = firstEntry\r\n    const sellerInfo = sellerMap.get(sellerId)\r\n\r\n    const baseUrl = (process.env.NEXT_PUBLIC_SITE_URL || process.env.NEXT_PUBLIC_URL || \"http://localhost:3000\").replace(/\\/$/, \"\")\r\n    const safeLocale = locale === \"bg\" ? \"bg\" : \"en\"\r\n    const t = await getTranslations({ locale: safeLocale, namespace: \"CheckoutPage\" })\r\n\r\n    // Calculate fees based on seller's subscription tier\r\n    const fees = await getFeesForSeller(sellerId)\r\n    \r\n    // Calculate total item price for fee calculation\r\n    const itemTotalEur = sellerItems.reduce((sum: number, item: CartItem) => sum + item.price * item.quantity, 0)\r\n    \r\n    // Calculate transaction fees using the new buyer protection model\r\n    const feeBreakdown = calculateTransactionFees(itemTotalEur, fees)\r\n    \r\n    // Convert buyer protection fee to cents for Stripe\r\n    const buyerProtectionFeeCents = Math.round(feeBreakdown.buyerProtectionFee * 100)\r\n    \r\n    // Calculate total application fee (seller fee + buyer protection)\r\n    const applicationFeeCents = Math.round(feeBreakdown.platformRevenue * 100)\r\n\r\n    const lineItems: Stripe.Checkout.SessionCreateParams.LineItem[] = sellerItems.map((item: CartItem) => ({\r\n      price_data: {\r\n        currency: \"eur\",\r\n        product_data: {\r\n          name: item.title,\r\n          images: [\r\n            item.image.startsWith(\"http\")\r\n              ? item.image\r\n              : `${baseUrl}${item.image}`,\r\n          ],\r\n          metadata: {\r\n            product_id: item.id,\r\n            ...(item.variantId ? { variant_id: item.variantId } : {}),\r\n          },\r\n        },\r\n        unit_amount: Math.round(item.price * 100),\r\n      },\r\n      quantity: item.quantity,\r\n    }))\r\n    \r\n    // Add buyer protection fee as a separate line item (visible to buyer)\r\n    if (buyerProtectionFeeCents > 0) {\r\n      lineItems.push({\r\n        price_data: {\r\n          currency: \"eur\",\r\n          product_data: {\r\n            name: t(\"buyerProtection\"),\r\n            description: t(\"buyerProtectionDescription\"),\r\n          },\r\n          unit_amount: buyerProtectionFeeCents,\r\n        },\r\n        quantity: 1,\r\n      })\r\n    }\r\n\r\n    const sessionParams: Stripe.Checkout.SessionCreateParams = {\r\n      payment_method_types: [\"card\"],\r\n      line_items: lineItems,\r\n      mode: \"payment\",\r\n      client_reference_id: userId,\r\n      metadata: {\r\n        user_id: userId,\r\n        seller_id: sellerId,\r\n        items_json: JSON.stringify(items.map((i) => ({ id: i.id, variantId: i.variantId ?? null, qty: i.quantity, price: i.price }))),\r\n        buyer_protection_fee: feeBreakdown.buyerProtectionFee.toFixed(2),\r\n        seller_fee: feeBreakdown.sellerFee.toFixed(2),\r\n      },\r\n      success_url: `${baseUrl}/${safeLocale}/checkout/success?session_id={CHECKOUT_SESSION_ID}`,\r\n      cancel_url: `${baseUrl}/${safeLocale}/cart`,\r\n    }\r\n\r\n    // Add Connect destination charges if seller has completed onboarding\r\n    if (sellerInfo?.stripeAccountId && sellerInfo.chargesEnabled) {\r\n      sessionParams.payment_intent_data = {\r\n        application_fee_amount: applicationFeeCents,\r\n        transfer_data: {\r\n          destination: sellerInfo.stripeAccountId,\r\n        },\r\n      }\r\n    } else {\r\n      // Seller hasn't set up payouts - funds go to platform\r\n      // TODO: Consider blocking checkout or warning buyer\r\n      console.warn(`Seller ${sellerId} has not completed payout setup. Funds will go to platform.`)\r\n    }\r\n\r\n    const session = await stripe.checkout.sessions.create(sessionParams)\r\n\r\n    if (!session.url) {\r\n      return { ok: false, error: \"Failed to start checkout session\" }\r\n    }\r\n\r\n    return { ok: true, url: session.url }\r\n  } catch (error) {\r\n    console.error(\"Error creating checkout session:\", error)\r\n    // Return more specific error messages for debugging\r\n    if (error instanceof Error) {\r\n      // Check for common Stripe errors\r\n      if (error.message.includes(\"API key\")) {\r\n        return { ok: false, error: \"Stripe API key configuration error. Please contact support.\" }\r\n      }\r\n      if (error.message.includes(\"Invalid\")) {\r\n        return { ok: false, error: `Stripe validation error: ${error.message}` }\r\n      }\r\n      // In development, show the actual error; in production, show generic message\r\n      if (process.env.NODE_ENV === \"development\") {\r\n        return { ok: false, error: `Checkout error: ${error.message}` }\r\n      }\r\n    }\r\n    return { ok: false, error: \"Failed to create checkout session. Please try again.\" }\r\n  }\r\n}\r\n\r\nexport type CheckoutFeeQuoteResult =\r\n  | { ok: true; buyerProtectionFee: number }\r\n  | { ok: false }\r\n\r\nexport async function getCheckoutFeeQuote(items: CartItem[]): Promise<CheckoutFeeQuoteResult> {\r\n  // Validate items before proceeding (client may call this as items change)\r\n  if (!items || items.length === 0) {\r\n    return { ok: false }\r\n  }\r\n\r\n  for (const item of items) {\r\n    if (!item.id || !item.title || typeof item.price !== \"number\" || !Number.isFinite(item.price) || item.price <= 0 || !isValidQuantity(item.quantity)) {\r\n      return { ok: false }\r\n    }\r\n  }\r\n\r\n  try {\r\n    const supabase = await createClient()\r\n    let userId: string | undefined\r\n\r\n    const {\r\n      data: { user },\r\n    } = await supabase.auth.getUser()\r\n    userId = user?.id\r\n\r\n    const productIds = items.map((item) => item.id).filter(Boolean)\r\n\r\n    const { data: products, error: productsError } = await supabase\r\n      .from(\"products\")\r\n      .select(\"id, seller_id, title\")\r\n      .in(\"id\", productIds)\r\n\r\n    if (productsError || !products) {\r\n      return { ok: false }\r\n    }\r\n\r\n    if (userId) {\r\n      const ownsAny = products.some((p) => p.seller_id === userId)\r\n      if (ownsAny) {\r\n        return { ok: false }\r\n      }\r\n    }\r\n\r\n    const sellerIds = [...new Set(products.map((p) => p.seller_id).filter(Boolean))]\r\n    if (sellerIds.length !== 1) {\r\n      return { ok: false }\r\n    }\r\n\r\n    const sellerId = sellerIds[0]\r\n    if (!sellerId) {\r\n      return { ok: false }\r\n    }\r\n\r\n    const fees = await getFeesForSeller(sellerId)\r\n    const itemTotalEur = items.reduce((sum: number, item: CartItem) => sum + item.price * item.quantity, 0)\r\n    const feeBreakdown = calculateTransactionFees(itemTotalEur, fees)\r\n\r\n    return { ok: true, buyerProtectionFee: feeBreakdown.buyerProtectionFee }\r\n  } catch {\r\n    return { ok: false }\r\n  }\r\n}\r\n\r\nexport type VerifyAndCreateOrderResult =\r\n  | { ok: true; orderId: string; message?: string }\r\n  | { ok: false; error: string }\r\n\r\nexport async function verifyAndCreateOrder(sessionId: string): Promise<VerifyAndCreateOrderResult> {\r\n  if (!sessionId) {\r\n    return { ok: false, error: \"No session ID provided\" }\r\n  }\r\n\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      console.error(\"Supabase client creation failed\")\r\n      return { ok: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const {\r\n      data: { user },\r\n      error: authError,\r\n    } = await supabase.auth.getUser()\r\n\r\n    if (authError) {\r\n      console.error(\"Auth error:\", authError)\r\n      return { ok: false, error: \"Authentication error\" }\r\n    }\r\n\r\n    if (!user) {\r\n      console.error(\"No user found in session\")\r\n      return { ok: false, error: \"User not authenticated\" }\r\n    }\r\n\r\n    const session = await stripe.checkout.sessions.retrieve(sessionId, {\r\n      expand: [\"line_items\"],\r\n    })\r\n\r\n    if (session.payment_status !== \"paid\") {\r\n      return { ok: false, error: \"Payment not completed\" }\r\n    }\r\n\r\n    const paymentIntentId = typeof session.payment_intent === \"string\" ? session.payment_intent : null\r\n    if (!paymentIntentId) {\r\n      return { ok: false, error: \"Missing payment intent\" }\r\n    }\r\n\r\n    {\r\n      const { data: existingOrder, error: existingOrderError } = await supabase\r\n        .from(\"orders\")\r\n        .select(\"id,user_id\")\r\n        .eq(\"stripe_payment_intent_id\", paymentIntentId)\r\n        .order(\"created_at\", { ascending: false })\r\n        .limit(1)\r\n        .maybeSingle()\r\n\r\n      if (existingOrderError) {\r\n        console.error(\"Error checking existing order:\", existingOrderError)\r\n      }\r\n\r\n      if (existingOrder?.id) {\r\n        if (existingOrder.user_id !== user.id) {\r\n          return { ok: false, error: \"Not authorized\" }\r\n        }\r\n        return { ok: true, orderId: existingOrder.id, message: \"Order already exists\" }\r\n      }\r\n    }\r\n\r\n    const itemsData = parseSessionItemsJson(session.metadata?.items_json)\r\n    if (!itemsData || itemsData.length === 0) {\r\n      return { ok: false, error: \"Checkout session items missing\" }\r\n    }\r\n\r\n    const shippingAddress: Json = session.customer_details?.address\r\n      ? {\r\n          name: session.customer_details.name || null,\r\n          email: session.customer_details.email || null,\r\n          address: {\r\n            city: session.customer_details.address.city || null,\r\n            country: session.customer_details.address.country || null,\r\n            line1: session.customer_details.address.line1 || null,\r\n            line2: session.customer_details.address.line2 || null,\r\n            postal_code: session.customer_details.address.postal_code || null,\r\n            state: session.customer_details.address.state || null,\r\n          },\r\n        }\r\n      : null\r\n\r\n    const orderData = {\r\n      user_id: user.id,\r\n      total_amount: (session.amount_total || 0) / 100,\r\n      status: \"paid\",\r\n      shipping_address: shippingAddress,\r\n      stripe_payment_intent_id: paymentIntentId,\r\n    }\r\n\r\n    const { data: order, error: orderError } = await supabase.from(\"orders\").insert(orderData).select(\"id, user_id\").single()\r\n\r\n    if (orderError) {\r\n      // If the webhook won the race and created the order first, we try to fetch it.\r\n      {\r\n        const { data: racedOrder } = await supabase\r\n          .from(\"orders\")\r\n          .select(\"id,user_id\")\r\n          .eq(\"stripe_payment_intent_id\", paymentIntentId)\r\n          .order(\"created_at\", { ascending: false })\r\n          .limit(1)\r\n          .maybeSingle()\r\n\r\n        if (racedOrder?.id) {\r\n          if (racedOrder.user_id !== user.id) {\r\n            return { ok: false, error: \"Not authorized\" }\r\n          }\r\n          return { ok: true, orderId: racedOrder.id, message: \"Order already exists\" }\r\n        }\r\n      }\r\n      return { ok: false, error: `Failed to create order: ${orderError.message}` }\r\n    }\r\n\r\n    const productIds = itemsData.map((item) => item.id).filter(Boolean)\r\n    if (productIds.length > 0) {\r\n      const { data: products, error: productsError } = await supabase\r\n        .from(\"products\")\r\n        .select(\"id, seller_id\")\r\n        .in(\"id\", productIds)\r\n\r\n      if (productsError) {\r\n        return { ok: false, error: \"Failed to load products for order\" }\r\n      }\r\n\r\n      const productSellerMap = new Map(products?.map((p) => [p.id, p.seller_id]) || [])\r\n\r\n      const validItems = itemsData\r\n        .map((item) => {\r\n          const sellerId = productSellerMap.get(item.id)\r\n          if (!sellerId) return null\r\n\r\n          return {\r\n            order_id: order.id,\r\n            product_id: item.id,\r\n            seller_id: sellerId,\r\n            ...(item.variantId ? { variant_id: item.variantId } : {}),\r\n            quantity: item.qty,\r\n            price_at_purchase: item.price,\r\n          }\r\n        })\r\n        .filter((item): item is NonNullable<typeof item> => Boolean(item))\r\n\r\n      if (validItems.length === 0) {\r\n        return { ok: false, error: \"No valid order items found\" }\r\n      }\r\n\r\n      // Stock decrement is enforced in the database on insert (trigger), so we don't\r\n      // need a service-role client here.\r\n      const { error: orderItemsError } = await supabase.from(\"order_items\").insert(validItems)\r\n      if (orderItemsError) {\r\n        return { ok: false, error: `Failed to create order items: ${orderItemsError.message}` }\r\n      }\r\n\r\n      await ensureOrderConversations(\r\n        supabase,\r\n        validItems.map((item) => ({\r\n          orderId: order.id,\r\n          buyerId: user.id,\r\n          sellerId: item.seller_id,\r\n          productId: item.product_id,\r\n        }))\r\n      )\r\n    }\r\n\r\n    return { ok: true, orderId: order.id }\r\n  } catch (error) {\r\n    console.error(\"Error verifying checkout session:\", error)\r\n    return {\r\n      ok: false,\r\n      error: `Failed to verify checkout session: ${error instanceof Error ? error.message : \"Unknown error\"}`,\r\n    }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\_components\\address-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\_components\\checkout-footer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\_components\\checkout-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\_components\\checkout-page-client.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'getCheckoutFeeQuoteAction'. Either include it or remove the dependency array. If 'getCheckoutFeeQuoteAction' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":128,"column":6,"nodeType":"ArrayExpression","endLine":128,"endColumn":13,"suggestions":[{"desc":"Update the dependencies array to be: [getCheckoutFeeQuoteAction, items]","fix":{"range":[4480,4487],"text":"[getCheckoutFeeQuoteAction, items]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useState, useCallback } from \"react\"\r\nimport { useCart, type CartItem } from \"@/components/providers/cart-context\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport {\r\n  ShoppingCart,\r\n  SpinnerGap,\r\n  Lock,\r\n  ArrowLeft,\r\n  Truck,\r\n  Package,\r\n  MapPin,\r\n  ShieldCheck,\r\n} from \"@phosphor-icons/react\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useTranslations, useLocale } from \"next-intl\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport type { CheckoutFeeQuoteResult, CreateCheckoutSessionResult } from \"../_actions/checkout\"\r\nimport { SHIPPING_COSTS, type SavedAddress, type NewAddressForm, type ShippingMethod } from \"./checkout-types\"\r\nimport { AddressSection } from \"./address-section\"\r\nimport { ShippingMethodSection } from \"./shipping-method-section\"\r\nimport { OrderItemsSection, OrderItemsSectionDesktop } from \"./order-items-section\"\r\ntype CreateCheckoutSessionAction = (items: CartItem[], locale?: \"en\" | \"bg\") => Promise<CreateCheckoutSessionResult>\r\n\r\ntype GetCheckoutFeeQuoteAction = (items: CartItem[]) => Promise<CheckoutFeeQuoteResult>\r\n\r\ntype CheckoutErrorKind = \"authRequired\" | \"ownProducts\" | \"generic\" | null\r\n\r\nexport default function CheckoutPageClient({\r\n  createCheckoutSessionAction,\r\n  getCheckoutFeeQuoteAction,\r\n}: {\r\n  createCheckoutSessionAction: CreateCheckoutSessionAction\r\n  getCheckoutFeeQuoteAction: GetCheckoutFeeQuoteAction\r\n}) {\r\n  const { items, totalItems, subtotal, isReady: isCartReady } = useCart()\r\n  const locale = useLocale()\r\n  const t = useTranslations(\"CheckoutPage\")\r\n  const tAuth = useTranslations(\"Auth\")\r\n\r\n  const [isProcessing, setIsProcessing] = useState(false)\r\n  const [buyerProtectionFee, setBuyerProtectionFee] = useState(0)\r\n  const [shippingMethod, setShippingMethod] = useState<ShippingMethod>(\"standard\")\r\n  const [mounted, setMounted] = useState(false)\r\n  const [savedAddresses, setSavedAddresses] = useState<SavedAddress[]>([])\r\n  const [selectedAddressId, setSelectedAddressId] = useState<string | null>(null)\r\n  const [useNewAddress, setUseNewAddress] = useState(false)\r\n  const [isLoadingAddresses, setIsLoadingAddresses] = useState(true)\r\n  const [isAuthenticated, setIsAuthenticated] = useState(false)\r\n  const [checkoutError, setCheckoutError] = useState<CheckoutErrorKind>(null)\r\n\r\n  const [newAddress, setNewAddress] = useState<NewAddressForm>({\r\n    firstName: \"\",\r\n    lastName: \"\",\r\n    address: \"\",\r\n    city: \"\",\r\n    state: \"\",\r\n    zip: \"\",\r\n  })\r\n\r\n  const [errors, setErrors] = useState<Partial<Record<keyof NewAddressForm, string>>>({})\r\n  const [touched, setTouched] = useState<Partial<Record<keyof NewAddressForm, boolean>>>({})\r\n  const [showAddressSelector, setShowAddressSelector] = useState(false)\r\n  const [isAtBottom, setIsAtBottom] = useState(false)\r\n\r\n  const fetchSavedAddresses = useCallback(async () => {\r\n    const supabase = createClient()\r\n    const {\r\n      data: { user },\r\n    } = await supabase.auth.getUser()\r\n\r\n    if (!user) {\r\n      setIsLoadingAddresses(false)\r\n      setIsAuthenticated(false)\r\n      return\r\n    }\r\n\r\n    setIsAuthenticated(true)\r\n\r\n    const { data: addresses } = await supabase\r\n      .from(\"user_addresses\")\r\n      .select(\r\n        \"id,label,full_name,phone,address_line1,address_line2,city,state,postal_code,country,is_default,created_at\"\r\n      )\r\n      .eq(\"user_id\", user.id)\r\n      .order(\"is_default\", { ascending: false })\r\n      .order(\"created_at\", { ascending: false })\r\n\r\n    if (addresses && addresses.length > 0) {\r\n      setSavedAddresses(addresses)\r\n      const defaultAddress = addresses.find((a) => a.is_default) ?? addresses.at(0)\r\n      if (defaultAddress) {\r\n        setSelectedAddressId(defaultAddress.id)\r\n      }\r\n    } else {\r\n      setUseNewAddress(true)\r\n    }\r\n\r\n    setIsLoadingAddresses(false)\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    setMounted(true)\r\n    fetchSavedAddresses()\r\n  }, [fetchSavedAddresses])\r\n\r\n  useEffect(() => {\r\n    let cancelled = false\r\n\r\n    if (items.length === 0) {\r\n      setBuyerProtectionFee(0)\r\n      return\r\n    }\r\n\r\n    ;(async () => {\r\n      const quote = await getCheckoutFeeQuoteAction(items)\r\n      if (cancelled) return\r\n      setBuyerProtectionFee(quote.ok ? quote.buyerProtectionFee : 0)\r\n    })()\r\n\r\n    return () => {\r\n      cancelled = true\r\n    }\r\n  }, [items])\r\n\r\n  useEffect(() => {\r\n    const handleScroll = () => {\r\n      const scrollTop = window.scrollY\r\n      const windowHeight = window.innerHeight\r\n      const docHeight = document.documentElement.scrollHeight\r\n      const scrolledToBottom = scrollTop + windowHeight >= docHeight - 100\r\n      setIsAtBottom(scrolledToBottom)\r\n    }\r\n\r\n    window.addEventListener('scroll', handleScroll)\r\n    return () => window.removeEventListener('scroll', handleScroll)\r\n  }, [])\r\n\r\n  const shippingCost = SHIPPING_COSTS[shippingMethod]\r\n  const tax = subtotal * 0.1\r\n  const total = subtotal + shippingCost + tax + buyerProtectionFee\r\n\r\n  const formatPrice = useCallback(\r\n    (price: number) => {\r\n      return new Intl.NumberFormat(locale === \"bg\" ? \"bg-BG\" : \"en-IE\", {\r\n        style: \"currency\",\r\n        currency: \"EUR\",\r\n      }).format(price)\r\n    },\r\n    [locale]\r\n  )\r\n\r\n  const authLoginHref = \"/auth/login?next=/checkout\"\r\n  const isAuthGateActive = !isAuthenticated && !isLoadingAddresses\r\n\r\n  const getCheckoutErrorKind = useCallback(\r\n    (errorMessage: string): CheckoutErrorKind => {\r\n      const normalized = errorMessage.trim()\r\n      if (normalized === \"Please sign in to checkout.\") return \"authRequired\"\r\n      if (normalized.startsWith(\"You cannot purchase your own products:\")) return \"ownProducts\"\r\n      return \"generic\"\r\n    },\r\n    []\r\n  )\r\n\r\n  const handleCheckout = async () => {\r\n    if (items.length === 0) return\r\n\r\n    setCheckoutError(null)\r\n\r\n    if (!isAuthenticated) {\r\n      setCheckoutError(\"authRequired\")\r\n      window.scrollTo({ top: 0, behavior: \"smooth\" })\r\n      return\r\n    }\r\n\r\n    setIsProcessing(true)\r\n    try {\r\n      const result = await createCheckoutSessionAction(items, locale === \"bg\" ? \"bg\" : \"en\")\r\n      if (!result.ok) {\r\n        setCheckoutError(getCheckoutErrorKind(result.error))\r\n        window.scrollTo({ top: 0, behavior: \"smooth\" })\r\n        return\r\n      }\r\n      window.location.href = result.url\r\n    } catch {\r\n      setCheckoutError(\"generic\")\r\n      window.scrollTo({ top: 0, behavior: \"smooth\" })\r\n    } finally {\r\n      setIsProcessing(false)\r\n    }\r\n  }\r\n\r\n  const updateNewAddress = useCallback(\r\n    (field: keyof NewAddressForm) => (e: React.ChangeEvent<HTMLInputElement>) => {\r\n      setNewAddress((prev) => ({ ...prev, [field]: e.target.value }))\r\n      // Clear error when user types\r\n      if (touched[field] && errors[field]) {\r\n        setErrors((prev) => ({ ...prev, [field]: \"\" }))\r\n      }\r\n    },\r\n    [touched, errors]\r\n  )\r\n\r\n  const validateField = useCallback(\r\n    (field: keyof NewAddressForm) => {\r\n      const value = newAddress[field]\r\n      let error = \"\"\r\n\r\n      if (!value || !value.trim()) {\r\n        error = t(`validation.${field}Required`)\r\n      } else if (field === \"zip\" && !/^\\d{4,5}$/.test(value)) {\r\n        error = t(\"validation.zipInvalid\")\r\n      } else if ((field === \"firstName\" || field === \"lastName\") && value.length < 2) {\r\n        error = t(\"validation.tooShort\", { min: 2 })\r\n      } else if (field === \"address\" && value.length < 5) {\r\n        error = t(\"validation.tooShort\", { min: 5 })\r\n      }\r\n\r\n      setErrors((prev) => ({ ...prev, [field]: error }))\r\n      return error\r\n    },\r\n    [newAddress, t]\r\n  )\r\n\r\n  const handleBlur = useCallback(\r\n    (field: keyof NewAddressForm) => () => {\r\n      setTouched((prev) => ({ ...prev, [field]: true }))\r\n      validateField(field)\r\n    },\r\n    [validateField]\r\n  )\r\n\r\n  const isFormValid = useCallback(() => {\r\n    if (!useNewAddress && selectedAddressId) return true\r\n    if (useNewAddress) {\r\n      const fields: Array<keyof NewAddressForm> = [\"firstName\", \"lastName\", \"address\", \"city\", \"state\", \"zip\"]\r\n      // Check validity without setting errors state - just validate the values directly\r\n      return fields.every((field) => {\r\n        const value = newAddress[field]\r\n        if (!value || !value.trim()) return false\r\n        if (field === \"zip\" && !/^\\d{4,5}$/.test(value)) return false\r\n        if ((field === \"firstName\" || field === \"lastName\") && value.length < 2) return false\r\n        if (field === \"address\" && value.length < 5) return false\r\n        return true\r\n      })\r\n    }\r\n    return false\r\n  }, [useNewAddress, selectedAddressId, newAddress])\r\n\r\n  const checkoutNotice = (() => {\r\n    if (isAuthGateActive) {\r\n      return {\r\n        title: t(\"authRequiredTitle\"),\r\n        description: t(\"authRequiredDescription\"),\r\n        primaryAction: {\r\n          label: tAuth(\"signIn\"),\r\n          href: authLoginHref,\r\n        },\r\n        showSecondaryCartAction: true,\r\n      }\r\n    }\r\n\r\n    if (!checkoutError) return null\r\n\r\n    if (checkoutError === \"authRequired\") {\r\n      return {\r\n        title: t(\"authRequiredTitle\"),\r\n        description: t(\"authRequiredDescription\"),\r\n        primaryAction: {\r\n          label: tAuth(\"signIn\"),\r\n          href: authLoginHref,\r\n        },\r\n        showSecondaryCartAction: true,\r\n      }\r\n    }\r\n\r\n    if (checkoutError === \"ownProducts\") {\r\n      return {\r\n        title: t(\"ownProductsTitle\"),\r\n        description: t(\"ownProductsDescription\"),\r\n        primaryAction: {\r\n          label: t(\"backToCart\"),\r\n          href: \"/cart\",\r\n        },\r\n        showSecondaryCartAction: false,\r\n      }\r\n    }\r\n\r\n    return {\r\n      title: t(\"checkoutErrorTitle\"),\r\n      description: t(\"checkoutError\"),\r\n      primaryAction: {\r\n        label: t(\"backToCart\"),\r\n        href: \"/cart\",\r\n      },\r\n      showSecondaryCartAction: false,\r\n    }\r\n  })()\r\n\r\n  // Loading state - only wait for mounted (hydration safety)\r\n  // Cart items are loaded from localStorage immediately, so we can show checkout\r\n  // content right away. Server sync happens in background.\r\n  if (!mounted) {\r\n    return (\r\n      <div className=\"min-h-96 flex items-center justify-center\">\r\n        <SpinnerGap className=\"size-5 animate-spin text-muted-foreground\" />\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Loading cart state - prevents false \"empty cart\" UI when cart is still hydrating/syncing.\r\n  if (items.length === 0 && !isCartReady) {\r\n    return (\r\n      <div className=\"min-h-96 flex items-center justify-center\">\r\n        <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\r\n          <SpinnerGap className=\"size-5 animate-spin\" />\r\n          <span>{t(\"loading\")}</span>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Empty cart state\r\n  if (items.length === 0) {\r\n    return (\r\n      <div className=\"min-h-96 flex items-center justify-center px-3\">\r\n        <div className=\"text-center\">\r\n          <div className=\"size-12 rounded-full bg-muted flex items-center justify-center mx-auto mb-3\">\r\n            <ShoppingCart className=\"size-6 text-muted-foreground\" />\r\n          </div>\r\n          <p className=\"text-sm font-medium mb-1\">{t(\"emptyCart\")}</p>\r\n          <p className=\"text-xs text-muted-foreground mb-3\">{t(\"emptyCartDescription\")}</p>\r\n          <Button asChild size=\"sm\">\r\n            <Link href=\"/\">{t(\"continueShopping\")}</Link>\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div>\r\n      {/* Mobile */}\r\n      <div className=\"lg:hidden pb-safe\">\r\n        {/* Accessible page title - sr-only on mobile since header shows step progress */}\r\n        <h1 className=\"sr-only\">{t(\"title\")}</h1>\r\n        \r\n        <div className=\"space-y-3 p-4\">\r\n          {checkoutNotice && (\r\n            <div\r\n              role=\"alert\"\r\n              className=\"rounded-lg border border-border bg-surface-subtle p-3\"\r\n            >\r\n              <div className=\"flex gap-3\">\r\n                <div className=\"mt-0.5 shrink-0\">\r\n                  <Lock className=\"size-4 text-primary\" weight=\"fill\" />\r\n                </div>\r\n                <div className=\"min-w-0 flex-1\">\r\n                  <p className=\"text-sm font-medium text-foreground\">\r\n                    {checkoutNotice.title}\r\n                  </p>\r\n                  <p className=\"mt-1 text-sm text-muted-foreground\">\r\n                    {checkoutNotice.description}\r\n                  </p>\r\n                  <div className=\"mt-3 flex items-center gap-2\">\r\n                    <Button asChild size=\"sm\" className=\"flex-1\">\r\n                      <Link href={checkoutNotice.primaryAction.href}>\r\n                        {checkoutNotice.primaryAction.label}\r\n                      </Link>\r\n                    </Button>\r\n                    {checkoutNotice.showSecondaryCartAction && (\r\n                      <Button asChild size=\"sm\" variant=\"secondary\" className=\"flex-1\">\r\n                        <Link href=\"/cart\">{t(\"backToCart\")}</Link>\r\n                      </Button>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {!isAuthGateActive && (\r\n            <Card>\r\n              <CardHeader className=\"border-b\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <CardTitle className=\"flex items-center gap-2 text-sm\">\r\n                    <MapPin className=\"size-4 text-primary\" weight=\"fill\" />\r\n                    {t(\"shippingAddress\")}\r\n                  </CardTitle>\r\n                  {isAuthenticated && (\r\n                    <Link href=\"/account/addresses\" className=\"text-xs text-primary font-medium\">{t(\"manageAddresses\")}</Link>\r\n                  )}\r\n                </div>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <AddressSection\r\n                  isLoadingAddresses={isLoadingAddresses}\r\n                  savedAddresses={savedAddresses}\r\n                  selectedAddressId={selectedAddressId}\r\n                  setSelectedAddressId={setSelectedAddressId}\r\n                  useNewAddress={useNewAddress}\r\n                  setUseNewAddress={setUseNewAddress}\r\n                  newAddress={newAddress}\r\n                  updateNewAddress={updateNewAddress}\r\n                  handleBlur={handleBlur}\r\n                  errors={errors}\r\n                  touched={touched}\r\n                  showAddressSelector={showAddressSelector}\r\n                  setShowAddressSelector={setShowAddressSelector}\r\n                />\r\n              </CardContent>\r\n            </Card>\r\n          )}\r\n\r\n          {!isAuthGateActive && (\r\n            <Card>\r\n              <CardHeader className=\"border-b\">\r\n                <CardTitle className=\"flex items-center gap-2 text-sm\">\r\n                  <Truck className=\"size-4 text-primary\" weight=\"fill\" />\r\n                  {t(\"shippingMethod\")}\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <ShippingMethodSection\r\n                  shippingMethod={shippingMethod}\r\n                  setShippingMethod={setShippingMethod}\r\n                  formatPrice={formatPrice}\r\n                  compact\r\n                />\r\n              </CardContent>\r\n            </Card>\r\n          )}\r\n\r\n          {/* Items */}\r\n          <Card>\r\n            <CardHeader className=\"border-b\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <CardTitle className=\"flex items-center gap-2 text-sm\">\r\n                  <Package className=\"size-4 text-primary\" weight=\"fill\" />\r\n                  {t(\"orderItems\")}\r\n                  <Badge variant=\"secondary\" className=\"ml-1\">{totalItems}</Badge>\r\n                </CardTitle>\r\n                <Link href=\"/cart\" className=\"text-xs text-primary font-medium\">{t(\"edit\")}</Link>\r\n              </div>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <OrderItemsSection items={items} formatPrice={formatPrice} />\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Summary */}\r\n          <Card>\r\n            <CardContent className=\"py-4 space-y-2\">\r\n              <div className=\"flex justify-between text-sm\">\r\n                <span className=\"text-muted-foreground\">{t(\"subtotal\")}</span>\r\n                <span>{formatPrice(subtotal)}</span>\r\n              </div>\r\n              <div className=\"flex justify-between text-sm\">\r\n                <span className=\"text-muted-foreground\">{t(\"shipping\")}</span>\r\n                <span className={shippingCost === 0 ? \"text-success font-medium\" : \"\"}>{shippingCost === 0 ? t(\"free\") : formatPrice(shippingCost)}</span>\r\n              </div>\r\n              <div className=\"flex justify-between text-sm\">\r\n                <span className=\"text-muted-foreground\">{t(\"tax\", { percent: 10 })}</span>\r\n                <span>{formatPrice(tax)}</span>\r\n              </div>\r\n              <div className=\"flex justify-between text-sm\">\r\n                <span className=\"text-muted-foreground\">{t(\"buyerProtection\")}</span>\r\n                <span>{formatPrice(buyerProtectionFee)}</span>\r\n              </div>\r\n              <div className=\"flex justify-between pt-2 border-t mt-2\">\r\n                <span className=\"font-semibold\">{t(\"total\")}</span>\r\n                <span className=\"text-lg font-bold\">{formatPrice(total)}</span>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          {/* Trust badges */}\r\n          <div className=\"flex items-center justify-center gap-4 py-1 text-2xs text-muted-foreground\">\r\n            <span className=\"flex items-center gap-1\"><Lock className=\"size-3\" weight=\"fill\" />{t(\"securePayment\")}</span>\r\n            <span className=\"flex items-center gap-1\"><ShieldCheck className=\"size-3\" weight=\"fill\" />{t(\"buyerProtection\")}</span>\r\n          </div>\r\n\r\n          <div className=\"h-20\" aria-hidden=\"true\" />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Mobile sticky footer - hide when scrolled to bottom */}\r\n      <div className={cn(\r\n        \"lg:hidden fixed inset-x-0 bottom-0 z-40 bg-surface-glass backdrop-blur-md border-t border-border transition-transform duration-300\",\r\n        isAtBottom ? \"translate-y-full\" : \"translate-y-0\"\r\n      )}>\r\n        <div className=\"px-4 py-3 pb-safe\">\r\n          <div className=\"flex items-center gap-2 mb-2 text-xs text-muted-foreground justify-center\">\r\n            <Lock className=\"size-3.5 text-success\" weight=\"fill\" />\r\n            <span>{t(\"secureCheckout\")}</span>\r\n            <span>ΓÇó</span>\r\n            <ShieldCheck className=\"size-3.5 text-success\" weight=\"fill\" />\r\n            <span>{t(\"buyerProtection\")}</span>\r\n          </div>\r\n          {isAuthGateActive ? (\r\n            <Button asChild size=\"lg\" className=\"w-full font-semibold\">\r\n              <Link href={authLoginHref}>\r\n                <Lock className=\"size-4 mr-2\" weight=\"fill\" />\r\n                {tAuth(\"signIn\")}\r\n              </Link>\r\n            </Button>\r\n          ) : (\r\n            <Button \r\n              onClick={handleCheckout} \r\n              disabled={isProcessing || !isFormValid()} \r\n              size=\"lg\"\r\n              className=\"w-full font-semibold\"\r\n            >\r\n              {isProcessing ? (\r\n                <>\r\n                  <SpinnerGap className=\"size-5 animate-spin mr-2\" />\r\n                  {t(\"processing\")}\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <Lock className=\"size-4 mr-2\" weight=\"fill\" />\r\n                  {t(\"completeOrder\")} ┬╖ {formatPrice(total)}\r\n                </>\r\n              )}\r\n            </Button>\r\n          )}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Desktop */}\r\n      <div className=\"hidden lg:block py-6\">\r\n        <div className=\"container max-w-5xl\">\r\n          {checkoutNotice && (\r\n            <div\r\n              role=\"alert\"\r\n              className=\"mb-5 rounded-lg border border-border bg-surface-subtle p-4\"\r\n            >\r\n              <div className=\"flex items-start justify-between gap-4\">\r\n                <div className=\"flex items-start gap-3\">\r\n                  <Lock className=\"mt-0.5 size-5 text-primary\" weight=\"fill\" />\r\n                  <div className=\"min-w-0\">\r\n                    <p className=\"text-sm font-medium text-foreground\">\r\n                      {checkoutNotice.title}\r\n                    </p>\r\n                    <p className=\"mt-1 text-sm text-muted-foreground\">\r\n                      {checkoutNotice.description}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"flex shrink-0 items-center gap-2\">\r\n                  <Button asChild size=\"sm\">\r\n                    <Link href={checkoutNotice.primaryAction.href}>\r\n                      {checkoutNotice.primaryAction.label}\r\n                    </Link>\r\n                  </Button>\r\n                  {checkoutNotice.showSecondaryCartAction && (\r\n                    <Button asChild size=\"sm\" variant=\"secondary\">\r\n                      <Link href=\"/cart\">{t(\"backToCart\")}</Link>\r\n                    </Button>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"flex items-center justify-between mb-5\">\r\n            <Link href=\"/cart\" className=\"inline-flex items-center gap-1.5 text-sm text-muted-foreground hover:text-foreground\">\r\n              <ArrowLeft className=\"size-4\" />{t(\"backToCart\")}\r\n            </Link>\r\n            <h1 className=\"text-lg font-semibold\">{t(\"title\")}</h1>\r\n            <div className=\"w-20\" aria-hidden=\"true\" />{/* Spacer for centering */}\r\n          </div>\r\n\r\n          <div className=\"flex items-start gap-6 lg:gap-8\">\r\n            {/* Main */}\r\n            <div className=\"flex-1 space-y-4\">\r\n              {!isAuthGateActive && (\r\n                <Card>\r\n                  <CardHeader className=\"border-b px-5\">\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <CardTitle className=\"flex items-center gap-2.5 text-base\">\r\n                        <MapPin className=\"size-5 text-primary\" weight=\"fill\" />\r\n                        {t(\"shippingAddress\")}\r\n                      </CardTitle>\r\n                      {isAuthenticated && <Link href=\"/account/addresses\" className=\"text-xs text-primary font-medium\">{t(\"manageAddresses\")}</Link>}\r\n                    </div>\r\n                  </CardHeader>\r\n                  <CardContent className=\"p-5 pt-4\">\r\n                    <AddressSection\r\n                      isLoadingAddresses={isLoadingAddresses}\r\n                      savedAddresses={savedAddresses}\r\n                      selectedAddressId={selectedAddressId}\r\n                      setSelectedAddressId={setSelectedAddressId}\r\n                      useNewAddress={useNewAddress}\r\n                      setUseNewAddress={setUseNewAddress}\r\n                      newAddress={newAddress}\r\n                      updateNewAddress={updateNewAddress}\r\n                      handleBlur={handleBlur}\r\n                      errors={errors}\r\n                      touched={touched}\r\n                      showAddressSelector={showAddressSelector}\r\n                      setShowAddressSelector={setShowAddressSelector}\r\n                    />\r\n                  </CardContent>\r\n                </Card>\r\n              )}\r\n\r\n              {!isAuthGateActive && (\r\n                <Card>\r\n                  <CardHeader className=\"border-b px-5\">\r\n                    <CardTitle className=\"flex items-center gap-2.5 text-base\">\r\n                      <Truck className=\"size-5 text-primary\" weight=\"fill\" />\r\n                      {t(\"shippingMethod\")}\r\n                    </CardTitle>\r\n                  </CardHeader>\r\n                  <CardContent className=\"p-5 pt-4\">\r\n                    <ShippingMethodSection\r\n                      shippingMethod={shippingMethod}\r\n                      setShippingMethod={setShippingMethod}\r\n                      formatPrice={formatPrice}\r\n                    />\r\n                  </CardContent>\r\n                </Card>\r\n              )}\r\n\r\n              {/* Items */}\r\n              <Card>\r\n                <CardHeader className=\"border-b px-5\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <CardTitle className=\"flex items-center gap-2.5 text-base\">\r\n                      <Package className=\"size-5 text-primary\" weight=\"fill\" />\r\n                      {t(\"orderItems\")}\r\n                      <Badge variant=\"secondary\" className=\"ml-1\">{totalItems}</Badge>\r\n                    </CardTitle>\r\n                    <Link href=\"/cart\" className=\"text-xs text-primary font-medium\">{t(\"edit\")}</Link>\r\n                  </div>\r\n                </CardHeader>\r\n                <CardContent className=\"p-5 pt-4\">\r\n                  <OrderItemsSectionDesktop items={items} formatPrice={formatPrice} />\r\n                </CardContent>\r\n              </Card>\r\n            </div>\r\n\r\n            {/* Sidebar */}\r\n            <div className=\"w-96 shrink-0\">\r\n              <Card className=\"sticky top-20\">\r\n                <CardHeader className=\"border-b px-5\">\r\n                  <CardTitle className=\"text-base\">{t(\"orderSummary\")}</CardTitle>\r\n                </CardHeader>\r\n                <CardContent className=\"p-5 pt-4 space-y-4\">\r\n                  <div className=\"space-y-3 text-sm\">\r\n                    <div className=\"flex justify-between\">\r\n                      <span className=\"text-muted-foreground\">{t(\"subtotal\")}</span>\r\n                      <span className=\"font-medium\">{formatPrice(subtotal)}</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between\">\r\n                      <span className=\"text-muted-foreground\">{t(\"shipping\")}</span>\r\n                      <span className={cn(\"font-medium\", shippingCost === 0 && \"text-success\")}>{shippingCost === 0 ? t(\"free\") : formatPrice(shippingCost)}</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between\">\r\n                      <span className=\"text-muted-foreground\">{t(\"tax\", { percent: 10 })}</span>\r\n                      <span className=\"font-medium\">{formatPrice(tax)}</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between\">\r\n                      <span className=\"text-muted-foreground\">{t(\"buyerProtection\")}</span>\r\n                      <span className=\"font-medium\">{formatPrice(buyerProtectionFee)}</span>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"border-t pt-4\">\r\n                    <div className=\"flex justify-between items-baseline\">\r\n                      <span className=\"text-base font-semibold\">{t(\"total\")}</span>\r\n                      <span className=\"text-xl font-bold\">{formatPrice(total)}</span>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {isAuthGateActive ? (\r\n                    <Button asChild size=\"lg\" className=\"w-full font-semibold\">\r\n                      <Link href={authLoginHref}>\r\n                        <Lock className=\"size-4 mr-2\" weight=\"fill\" />\r\n                        {tAuth(\"signIn\")}\r\n                      </Link>\r\n                    </Button>\r\n                  ) : (\r\n                    <Button \r\n                      onClick={handleCheckout} \r\n                      disabled={isProcessing || !isFormValid()} \r\n                      size=\"lg\"\r\n                      className=\"w-full font-semibold\"\r\n                    >\r\n                      {isProcessing ? (\r\n                        <>\r\n                          <SpinnerGap className=\"size-5 animate-spin mr-2\" />\r\n                          {t(\"processing\")}\r\n                        </>\r\n                      ) : (\r\n                        <>\r\n                          <Lock className=\"size-4 mr-2\" weight=\"fill\" />\r\n                          {t(\"proceedToPayment\")}\r\n                        </>\r\n                      )}\r\n                    </Button>\r\n                  )}\r\n\r\n                  <div className=\"flex items-center justify-center gap-4 text-xs text-muted-foreground pt-2\">\r\n                    <div className=\"flex items-center gap-1.5\">\r\n                      <Lock className=\"size-3.5 text-success\" weight=\"fill\" />\r\n                      <span>{t(\"secureCheckout\")}</span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-1.5\">\r\n                      <ShieldCheck className=\"size-3.5 text-success\" weight=\"fill\" />\r\n                      <span>{t(\"buyerProtection\")}</span>\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\_components\\checkout-success-page-client.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'verifyAndCreateOrderAction'. Either include it or remove the dependency array. If 'verifyAndCreateOrderAction' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":66,"column":6,"nodeType":"ArrayExpression","endLine":66,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [searchParams, t, verifyAndCreateOrderAction]","fix":{"range":[1821,1838],"text":"[searchParams, t, verifyAndCreateOrderAction]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useState } from \"react\"\r\nimport { useSearchParams } from \"next/navigation\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport type { VerifyAndCreateOrderResult } from \"../_actions/checkout\"\r\nimport {\r\n  CheckCircle,\r\n  XCircle,\r\n  SpinnerGap,\r\n  Package,\r\n  Envelope,\r\n  ArrowRight,\r\n} from \"@phosphor-icons/react\"\r\n\r\ntype SuccessState =\r\n  | { status: \"idle\" }\r\n  | { status: \"loading\" }\r\n  | { status: \"success\"; orderId: string | null }\r\n  | { status: \"error\"; message: string }\r\n\r\ntype VerifyAndCreateOrderAction = (sessionId: string) => Promise<VerifyAndCreateOrderResult>\r\n\r\nexport default function CheckoutSuccessPageClient({\r\n  verifyAndCreateOrderAction,\r\n}: {\r\n  verifyAndCreateOrderAction: VerifyAndCreateOrderAction\r\n}) {\r\n  const searchParams = useSearchParams()\r\n  const t = useTranslations(\"CheckoutSuccessPage\")\r\n\r\n  const [state, setState] = useState<SuccessState>({ status: \"idle\" })\r\n\r\n  useEffect(() => {\r\n    const sessionId = searchParams.get(\"session_id\")\r\n    if (!sessionId) {\r\n      setState({ status: \"error\", message: t(\"missingSession\") })\r\n      return\r\n    }\r\n\r\n    let cancelled = false\r\n\r\n    ;(async () => {\r\n      setState({ status: \"loading\" })\r\n      try {\r\n        const result = await verifyAndCreateOrderAction(sessionId)\r\n        if (cancelled) return\r\n\r\n        if (!result.ok) {\r\n          setState({ status: \"error\", message: result.error })\r\n          return\r\n        }\r\n\r\n        setState({ status: \"success\", orderId: result.orderId })\r\n      } catch (err) {\r\n        console.error(err)\r\n        if (!cancelled) setState({ status: \"error\", message: t(\"unknownError\") })\r\n      }\r\n    })()\r\n\r\n    return () => {\r\n      cancelled = true\r\n    }\r\n  }, [searchParams, t])\r\n\r\n  // Loading\r\n  if (state.status === \"loading\" || state.status === \"idle\") {\r\n    return (\r\n      <div className=\"min-h-(--page-section-min-h) flex items-center justify-center px-3\">\r\n        <div className=\"text-center\">\r\n          <SpinnerGap className=\"size-8 text-primary animate-spin mx-auto mb-3\" />\r\n          <p className=\"text-sm font-medium\">{t(\"verifying\")}</p>\r\n          <p className=\"text-xs text-muted-foreground mt-1\">{t(\"verifyingDescription\")}</p>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Error\r\n  if (state.status === \"error\") {\r\n    return (\r\n      <div className=\"min-h-(--page-section-min-h) flex items-center justify-center px-3\">\r\n        <div className=\"text-center max-w-sm\">\r\n          <div className=\"size-14 bg-destructive-subtle rounded-full flex items-center justify-center mx-auto mb-3\">\n            <XCircle className=\"size-7 text-destructive\" weight=\"fill\" />\r\n          </div>\r\n          <p className=\"text-sm font-semibold mb-1\">{t(\"paymentFailed\")}</p>\r\n          <p className=\"text-xs text-muted-foreground mb-4\">{state.message}</p>\r\n          <div className=\"flex gap-2\">\r\n            <Button asChild variant=\"outline\" size=\"sm\" className=\"flex-1 h-9\">\r\n              <Link href=\"/cart\">{t(\"backToCart\")}</Link>\r\n            </Button>\r\n            <Button asChild size=\"sm\" className=\"flex-1 h-9\">\r\n              <Link href=\"/\">{t(\"continueShopping\")}</Link>\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  // Success\r\n  return (\r\n    <div className=\"min-h-(--page-section-min-h) flex items-center justify-center px-3\">\r\n      <div className=\"text-center max-w-sm w-full\">\r\n        {/* Success icon */}\r\n        <div className=\"size-16 bg-success/10 rounded-full flex items-center justify-center mx-auto mb-4\">\r\n          <CheckCircle className=\"size-8 text-success\" weight=\"fill\" />\r\n        </div>\r\n        \r\n        <h1 className=\"text-lg font-semibold mb-1\">{t(\"paymentSuccessful\")}</h1>\r\n        <p className=\"text-sm text-muted-foreground mb-6\">{t(\"thankYou\")}</p>\r\n\r\n        {/* Order info */}\r\n        {state.orderId && (\r\n          <div className=\"bg-surface-subtle rounded-md px-3 py-2 mb-4 text-sm\">\r\n            <span className=\"text-muted-foreground\">{t(\"orderId\", { id: \"\" })}</span>\r\n            <span className=\"font-mono font-medium ml-1\">{state.orderId}</span>\r\n          </div>\r\n        )}\r\n\r\n        {/* Quick info */}\r\n        <div className=\"space-y-2 mb-6 text-left\">\r\n          <div className=\"flex items-center gap-2 text-sm\">\r\n            <Package className=\"size-4 text-primary shrink-0\" weight=\"fill\" />\r\n            <span className=\"text-muted-foreground\">{t(\"orderCreatedDescription\")}</span>\r\n          </div>\r\n          <div className=\"flex items-center gap-2 text-sm\">\r\n            <Envelope className=\"size-4 text-primary shrink-0\" weight=\"fill\" />\r\n            <span className=\"text-muted-foreground\">{t(\"confirmationEmail\")}</span>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Actions */}\r\n        <div className=\"flex gap-2\">\r\n          <Button asChild variant=\"outline\" size=\"sm\" className=\"flex-1 h-9\">\r\n            <Link href=\"/orders\">{t(\"viewOrders\")}</Link>\r\n          </Button>\r\n          <Button asChild size=\"sm\" className=\"flex-1 h-9\">\r\n            <Link href=\"/\">\r\n              {t(\"continueShopping\")}\r\n              <ArrowRight className=\"size-3.5 ml-1\" />\r\n            </Link>\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\_components\\checkout-types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\_components\\order-items-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\_components\\shipping-method-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\checkout\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\checkout\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\checkout\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\checkout\\success\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(checkout)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(legal)\\_components\\legal-doc-loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(legal)\\_components\\legal-page-layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(legal)\\cookies\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(legal)\\privacy\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(legal)\\privacy\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(legal)\\returns\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(legal)\\returns\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(legal)\\terms\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(legal)\\terms\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(support)\\contact\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(support)\\contact\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(support)\\customer-service\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(support)\\customer-service\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ArrowsClockwise' is defined but never used.","line":4,"column":19,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":34,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ArrowsClockwise"},"fix":{"range":[170,187],"text":""},"desc":"Remove unused variable \"ArrowsClockwise\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Package, ArrowsClockwise, CreditCard, User, Shield, Question, MagnifyingGlass as Search } from \"@phosphor-icons/react/dist/ssr\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { getTranslations, setRequestLocale } from \"next-intl/server\"\r\nimport { AppBreadcrumb, breadcrumbPresets } from \"@/components/shared/navigation/app-breadcrumb\"\r\nimport type { Metadata } from 'next'\r\nimport { validateLocale } from \"@/i18n/routing\"\r\nimport { CustomerServiceChat } from \"@/components/support/customer-service-chat\"\r\nimport { PageShell } from \"@/components/shared/page-shell\"\r\n\r\n// Generate static params for all locales - required for Next.js 16 Cache Components\r\nexport async function generateMetadata({ params }: { params: Promise<{ locale: string }> }): Promise<Metadata> {\r\n  const { locale: localeParam } = await params;\r\n  const locale = validateLocale(localeParam)\r\n  setRequestLocale(locale)\r\n  const t = await getTranslations({ locale, namespace: \"CustomerService\" })\r\n  return {\r\n    title: t(\"metaTitle\"),\r\n    description: t(\"metaDescription\"),\r\n  };\r\n}\r\n\r\nexport default async function CustomerServicePage({ params }: { params: Promise<{ locale: string }> }) {\r\n  const { locale: localeParam } = await params\r\n  const locale = validateLocale(localeParam)\r\n  \r\n  // Enable static rendering for this locale\r\n  setRequestLocale(locale)\r\n  \r\n  const t = await getTranslations('CustomerService')\r\n  const tBreadcrumbs = await getTranslations(\"Breadcrumbs\")\r\n\r\n    const helpTopics = [\r\n        { icon: Package, title: t('delivery') },\r\n        { icon: CreditCard, title: t('payment') },\r\n        { icon: User, title: t('address') },\r\n        { icon: Shield, title: t('memberships') },\r\n        { icon: Question, title: t('accessibility') },\r\n        { icon: Question, title: t('somethingElse') },\r\n        { icon: Question, title: t('loginPassword') },\r\n    ]\r\n\r\n    return (\r\n        <PageShell className=\"pb-12 overflow-x-hidden\">\r\n            <div className=\"container py-8 px-4 sm:px-6\">\r\n                <AppBreadcrumb\r\n                    items={breadcrumbPresets(tBreadcrumbs).customerService}\r\n                    ariaLabel={tBreadcrumbs(\"ariaLabel\")}\r\n                    homeLabel={tBreadcrumbs(\"homeLabel\")}\r\n                />\r\n                \r\n                <h1 className=\"text-3xl font-bold mb-8\">{t('title')}</h1>\r\n\r\n                <div className=\"mb-12\">\r\n                    <h2 className=\"text-xl font-bold mb-4\">{t('helpTitle')}</h2>\r\n                    <div className=\"grid grid-cols-1 xs:grid-cols-2 gap-2 sm:gap-4 md:grid-cols-3\">\r\n                        {helpTopics.map((topic, i) => (\r\n                            <Card key={i} className=\"hover:bg-muted cursor-pointer transition-colors overflow-hidden\">\r\n                                <CardContent className=\"flex items-center p-3 sm:p-4 gap-2 sm:gap-4\">\r\n                                    <div className=\"bg-secondary p-2 rounded-full shrink-0\">\r\n                                        <topic.icon className=\"w-6 h-6 sm:w-8 sm:h-8 text-muted-foreground\" />\r\n                                    </div>\r\n                                    <span className=\"font-medium text-foreground text-sm sm:text-base line-clamp-2 break-words\">{topic.title}</span>\r\n                                </CardContent>\r\n                            </Card>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"mb-12\">\r\n                    <h2 className=\"text-xl font-bold mb-4\">{t('searchTitle')}</h2>\r\n                    <div className=\"relative max-w-2xl\">\r\n                        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\" />\r\n                        <Input\r\n                            className=\"pl-10 h-12 text-lg border-input\"\r\n                            placeholder={t('searchPlaceholder')}\r\n                        />\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                    <div className=\"col-span-2\">\r\n                        <h2 className=\"text-xl font-bold mb-4\">{t('allHelpTopics')}</h2>\r\n                        <div className=\"space-y-4\">\r\n                            <details className=\"group border border-border rounded-lg\">\r\n                                <summary className=\"flex justify-between items-center font-medium cursor-pointer list-none p-4 bg-muted group-open:bg-background\">\r\n                                    <span>{t('recommended')}</span>\r\n                                    <span className=\"transition group-open:rotate-180\">\r\n                                        <svg fill=\"none\" height=\"24\" shapeRendering=\"geometricPrecision\" stroke=\"currentColor\" strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"1.5\" viewBox=\"0 0 24 24\" width=\"24\"><path d=\"M6 9l6 6 6-6\"></path></svg>\r\n                                    </span>\r\n                                </summary>\r\n                                <div className=\"text-muted-foreground p-4 pt-0\">\r\n                                    <ul className=\"space-y-2\">\r\n                                        <li><Link href=\"#\" className=\"text-link hover:underline\">{t('wheresMy')}</Link></li>\r\n                                        <li><Link href=\"#\" className=\"text-link hover:underline\">{t('shipping')}</Link></li>\r\n                                        <li><Link href=\"#\" className=\"text-link hover:underline\">{t('returns')}</Link></li>\r\n                                    </ul>\r\n                                </div>\r\n                            </details>\r\n                            <details className=\"group border border-border rounded-lg\">\r\n                                <summary className=\"flex justify-between items-center font-medium cursor-pointer list-none p-4 bg-muted group-open:bg-background\">\r\n                                    <span>{t('wheresMy')}</span>\r\n                                    <span className=\"transition group-open:rotate-180\">\r\n                                        <svg fill=\"none\" height=\"24\" shapeRendering=\"geometricPrecision\" stroke=\"currentColor\" strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth=\"1.5\" viewBox=\"0 0 24 24\" width=\"24\"><path d=\"M6 9l6 6 6-6\"></path></svg>\r\n                                    </span>\r\n                                </summary>\r\n                                <div className=\"text-muted-foreground p-4 pt-0\">\r\n                                    <p className=\"mb-2\">{t('trackOrders')}</p>\r\n                                    <Button variant=\"outline\" className=\"w-full justify-start\">{t('goToOrders')}</Button>\r\n                                </div>\r\n                            </details>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div>\r\n                        <div className=\"bg-muted p-4 rounded-lg border border-border\">\r\n                            <h3 className=\"font-bold text-lg mb-4\">{t('contactUs')}</h3>\r\n                            <p className=\"text-sm text-muted-foreground mb-4\">\r\n                                {t('needMoreHelp')}\r\n                            </p>\r\n                            <CustomerServiceChat />\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </PageShell>\r\n    )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(support)\\faq\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Truck' is defined but never used.","line":8,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":8,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Truck"},"fix":{"range":[160,171],"text":""},"desc":"Remove unused variable \"Truck\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Question' is defined but never used.","line":9,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":9,"endColumn":11,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Question"},"fix":{"range":[171,185],"text":""},"desc":"Remove unused variable \"Question\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CaretDown' is defined but never used.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":12,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CaretDown"},"fix":{"range":[185,199],"text":""},"desc":"Remove unused variable \"CaretDown\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { \r\n  Package, \r\n  CreditCard, \r\n  ArrowsClockwise, \r\n  User, \r\n  Shield, \r\n  Truck, \r\n  Question,\r\n  CaretDown\r\n} from \"@phosphor-icons/react/dist/ssr\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { getTranslations, setRequestLocale } from \"next-intl/server\"\r\nimport { AppBreadcrumb } from \"@/components/shared/navigation/app-breadcrumb\"\r\nimport type { Metadata } from 'next'\r\nimport { validateLocale } from \"@/i18n/routing\"\r\nimport {\r\n  Accordion,\r\n  AccordionContent,\r\n  AccordionItem,\r\n  AccordionTrigger,\r\n} from \"@/components/ui/accordion\"\r\nimport { PageShell } from \"@/components/shared/page-shell\"\r\n\r\n// Generate static params for all locales\r\nexport async function generateMetadata({ params }: { params: Promise<{ locale: string }> }): Promise<Metadata> {\r\n  const { locale: localeParam } = await params\r\n  const locale = validateLocale(localeParam)\r\n  setRequestLocale(locale)\r\n\r\n  const t = await getTranslations({ locale, namespace: 'FAQPage' })\r\n  return {\r\n    title: t('metaTitle'),\r\n    description: t('metaDescription'),\r\n  }\r\n}\r\n\r\n// FAQ data structure\r\nconst faqCategories = {\r\n  en: [\r\n    {\r\n      id: 'orders',\r\n      icon: Package,\r\n      title: 'Orders & Shipping',\r\n      faqs: [\r\n        { q: 'How do I track my order?', a: 'You can track your order by going to \"My Orders\" in your account. Click on the order you want to track to see real-time shipping updates.' },\r\n        { q: 'How long does shipping take?', a: 'Standard shipping takes 5-7 business days. Express shipping (2-3 days) and overnight shipping are also available at checkout.' },\r\n        { q: 'Can I change my shipping address after ordering?', a: 'You can change your shipping address within 1 hour of placing your order. Go to \"My Orders\" and click \"Edit\" next to the shipping address.' },\r\n        { q: 'Do you ship internationally?', a: 'Currently, we ship within Bulgaria and select EU countries. International shipping options are expanding soon.' },\r\n      ]\r\n    },\r\n    {\r\n      id: 'returns',\r\n      icon: ArrowsClockwise,\r\n      title: 'Returns & Refunds',\r\n      faqs: [\r\n        { q: 'What is your return policy?', a: 'We offer 30-day returns on most items. Items must be in original condition with tags attached. Some categories like intimates and personalized items are final sale.' },\r\n        { q: 'How do I start a return?', a: 'Go to \"My Orders\", find the item you want to return, and click \"Return Item\". Follow the instructions to print your return label.' },\r\n        { q: 'When will I receive my refund?', a: 'Refunds are processed within 3-5 business days after we receive your return. It may take an additional 5-10 days for the refund to appear on your statement.' },\r\n        { q: 'Can I exchange an item instead of returning it?', a: 'Yes! During the return process, you can choose to exchange for a different size or color if available.' },\r\n      ]\r\n    },\r\n    {\r\n      id: 'payments',\r\n      icon: CreditCard,\r\n      title: 'Payments & Pricing',\r\n      faqs: [\r\n        { q: 'What payment methods do you accept?', a: 'We accept all major credit cards (Visa, Mastercard, American Express), PayPal, Apple Pay, Google Pay, and bank transfers.' },\r\n        { q: 'Is my payment information secure?', a: 'Yes, all payments are processed through Stripe with bank-level SSL encryption. We never store your full card details.' },\r\n        { q: 'Can I pay in installments?', a: 'Yes, we offer installment payments through Klarna for orders over Γé¼50. Select \"Pay in 4\" at checkout.' },\r\n        { q: 'Why was my payment declined?', a: 'Payments may be declined due to insufficient funds, incorrect card details, or bank security measures. Please try again or use a different payment method.' },\r\n      ]\r\n    },\r\n    {\r\n      id: 'account',\r\n      icon: User,\r\n      title: 'Account & Profile',\r\n      faqs: [\r\n        { q: 'How do I create an account?', a: 'Click \"Sign Up\" in the top right corner. You can register with your email or sign up instantly with Google or Apple.' },\r\n        { q: 'How do I reset my password?', a: 'Click \"Sign In\", then \"Forgot Password\". Enter your email and we\\'ll send you a reset link.' },\r\n        { q: 'Can I delete my account?', a: 'Yes, you can delete your account from Settings > Privacy > Delete Account. This action is permanent and cannot be undone.' },\r\n        { q: 'How do I change my email address?', a: 'Go to Account Settings and click on your email. You\\'ll need to verify the new email address before the change takes effect.' },\r\n      ]\r\n    },\r\n    {\r\n      id: 'selling',\r\n      icon: Shield,\r\n      title: 'Selling on Treido',\r\n      faqs: [\r\n        { q: 'How do I start selling?', a: 'Click \"Sell\" in the navigation bar and follow the steps to create your seller account. You\\'ll need to verify your identity and set up payment details.' },\r\n        { q: 'What fees does Treido charge?', a: 'Personal sellers pay 0% seller fee. Business accounts pay a small seller fee (0.5ΓÇô1.5%) depending on plan. Buyers pay a Buyer Protection fee at checkout (percent + fixed, capped).' },\r\n        { q: 'How do I get paid for my sales?', a: 'Payments are transferred to your bank account within 3-5 business days after the buyer confirms receipt or after the protection period ends.' },\r\n        { q: 'What items can I sell?', a: 'You can sell most new and used items. Prohibited items include weapons, drugs, counterfeit goods, and hazardous materials. See our full policy for details.' },\r\n      ]\r\n    },\r\n    {\r\n      id: 'protection',\r\n      icon: Shield,\r\n      title: 'Buyer Protection',\r\n      faqs: [\r\n        { q: 'What is Buyer Protection?', a: 'Buyer Protection ensures you receive the item as described or get a full refund. It covers all purchases made through Treido\\'s secure checkout.' },\r\n        { q: 'How do I file a claim?', a: 'If there\\'s an issue with your order, go to \"My Orders\" and click \"Report a Problem\". Our team will review your case within 24-48 hours.' },\r\n        { q: 'What does Buyer Protection cover?', a: 'It covers items not received, items significantly not as described, and damaged items. You\\'re protected for the full purchase price including shipping.' },\r\n        { q: 'How long does protection last?', a: 'Protection is active from purchase until 30 days after confirmed delivery. Make sure to inspect items and report issues promptly.' },\r\n      ]\r\n    },\r\n  ],\r\n  bg: [\r\n    {\r\n      id: 'orders',\r\n      icon: Package,\r\n      title: '╨ƒ╨╛╤Ç╤è╤ç╨║╨╕ ╨╕ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░',\r\n      faqs: [\r\n        { q: '╨Ü╨░╨║ ╨┤╨░ ╨┐╤Ç╨╛╤ü╨╗╨╡╨┤╤Å ╨┐╨╛╤Ç╤è╤ç╨║╨░╤é╨░ ╤ü╨╕?', a: '╨£╨╛╨╢╨╡╤é╨╡ ╨┤╨░ ╨┐╤Ç╨╛╤ü╨╗╨╡╨┤╨╕╤é╨╡ ╨┐╨╛╤Ç╤è╤ç╨║╨░╤é╨░ ╤ü╨╕ ╨╛╤é \"╨£╨╛╨╕╤é╨╡ ╨┐╨╛╤Ç╤è╤ç╨║╨╕\" ╨▓ ╨┐╤Ç╨╛╤ä╨╕╨╗╨░ ╨▓╨╕. ╨Ü╨╗╨╕╨║╨╜╨╡╤é╨╡ ╨╜╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨░╤é╨░, ╨╖╨░ ╨┤╨░ ╨▓╨╕╨┤╨╕╤é╨╡ ╨░╨║╤é╤â╨░╨╗╨╕╨╖╨░╤å╨╕╨╕ ╨▓ ╤Ç╨╡╨░╨╗╨╜╨╛ ╨▓╤Ç╨╡╨╝╨╡.' },\r\n        { q: '╨Ü╨╛╨╗╨║╨╛ ╨▓╤Ç╨╡╨╝╨╡ ╨╛╤é╨╜╨╡╨╝╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░╤é╨░?', a: '╨í╤é╨░╨╜╨┤╨░╤Ç╤é╨╜╨░╤é╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░ ╨╛╤é╨╜╨╡╨╝╨░ 5-7 ╤Ç╨░╨▒╨╛╤é╨╜╨╕ ╨┤╨╜╨╕. ╨ò╨║╤ü╨┐╤Ç╨╡╤ü╨╜╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░ (2-3 ╨┤╨╜╨╕) ╨╕ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░ ╨╜╨░ ╤ü╨╗╨╡╨┤╨▓╨░╤ë╨╕╤Å ╨┤╨╡╨╜ ╤ü╤è╤ë╨╛ ╤ü╨░ ╨╜╨░╨╗╨╕╤ç╨╜╨╕.' },\r\n        { q: '╨£╨╛╨│╨░ ╨╗╨╕ ╨┤╨░ ╨┐╤Ç╨╛╨╝╨╡╨╜╤Å ╨░╨┤╤Ç╨╡╤ü╨░ ╨╖╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░ ╤ü╨╗╨╡╨┤ ╨┐╨╛╤Ç╤è╤ç╨║╨░?', a: '╨£╨╛╨╢╨╡╤é╨╡ ╨┤╨░ ╨┐╤Ç╨╛╨╝╨╡╨╜╨╕╤é╨╡ ╨░╨┤╤Ç╨╡╤ü╨░ ╨┤╨╛ 1 ╤ç╨░╤ü ╤ü╨╗╨╡╨┤ ╨┐╨╛╤Ç╤è╤ç╨║╨░╤é╨░. ╨₧╤é╨╕╨┤╨╡╤é╨╡ ╨▓ \"╨£╨╛╨╕╤é╨╡ ╨┐╨╛╤Ç╤è╤ç╨║╨╕\" ╨╕ ╨║╨╗╨╕╨║╨╜╨╡╤é╨╡ \"╨á╨╡╨┤╨░╨║╤é╨╕╤Ç╨░╨╣\".' },\r\n        { q: '╨ö╨╛╤ü╤é╨░╨▓╤Å╤é╨╡ ╨╗╨╕ ╨▓ ╤ç╤â╨╢╨▒╨╕╨╜╨░?', a: '╨Æ ╨╝╨╛╨╝╨╡╨╜╤é╨░ ╨┤╨╛╤ü╤é╨░╨▓╤Å╨╝╨╡ ╨▓ ╨æ╤è╨╗╨│╨░╤Ç╨╕╤Å ╨╕ ╨╕╨╖╨▒╤Ç╨░╨╜╨╕ ╤ü╤é╤Ç╨░╨╜╨╕ ╨╛╤é ╨ò╨í. ╨á╨░╨╖╤ê╨╕╤Ç╤Å╨▓╨░╨╝╨╡ ╨╝╨╡╨╢╨┤╤â╨╜╨░╤Ç╨╛╨┤╨╜╨╕╤é╨╡ ╨╛╨┐╤å╨╕╨╕ ╤ü╨║╨╛╤Ç╨╛.' },\r\n      ]\r\n    },\r\n    {\r\n      id: 'returns',\r\n      icon: ArrowsClockwise,\r\n      title: '╨Æ╤Ç╤è╤ë╨░╨╜╨╕╤Å ╨╕ ╨▓╤è╨╖╤ü╤é╨░╨╜╨╛╨▓╤Å╨▓╨░╨╜╨╕╤Å',\r\n      faqs: [\r\n        { q: '╨Ü╨░╨║╨▓╨░ ╨╡ ╨┐╨╛╨╗╨╕╤é╨╕╨║╨░╤é╨░ ╨▓╨╕ ╨╖╨░ ╨▓╤Ç╤è╤ë╨░╨╜╨╡?', a: '╨ƒ╤Ç╨╡╨┤╨╗╨░╨│╨░╨╝╨╡ 30-╨┤╨╜╨╡╨▓╨╜╨╛ ╨▓╤Ç╤è╤ë╨░╨╜╨╡ ╨╜╨░ ╨┐╨╛╨▓╨╡╤ç╨╡╤é╨╛ ╨░╤Ç╤é╨╕╨║╤â╨╗╨╕. ╨É╤Ç╤é╨╕╨║╤â╨╗╨╕╤é╨╡ ╤é╤Ç╤Å╨▒╨▓╨░ ╨┤╨░ ╤ü╨░ ╨▓ ╨╛╤Ç╨╕╨│╨╕╨╜╨░╨╗╨╜╨╛ ╤ü╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡ ╤ü ╨╡╤é╨╕╨║╨╡╤é╨╕.' },\r\n        { q: '╨Ü╨░╨║ ╨┤╨░ ╨╖╨░╨┐╨╛╤ç╨╜╨░ ╨▓╤Ç╤è╤ë╨░╨╜╨╡?', a: '╨₧╤é╨╕╨┤╨╡╤é╨╡ ╨▓ \"╨£╨╛╨╕╤é╨╡ ╨┐╨╛╤Ç╤è╤ç╨║╨╕\", ╨╜╨░╨╝╨╡╤Ç╨╡╤é╨╡ ╨░╤Ç╤é╨╕╨║╤â╨╗╨░ ╨╕ ╨║╨╗╨╕╨║╨╜╨╡╤é╨╡ \"╨Æ╤è╤Ç╨╜╨╕ ╨░╤Ç╤é╨╕╨║╤â╨╗\". ╨í╨╗╨╡╨┤╨▓╨░╨╣╤é╨╡ ╨╕╨╜╤ü╤é╤Ç╤â╨║╤å╨╕╨╕╤é╨╡ ╨╖╨░ ╨┐╨╡╤ç╨░╤é ╨╜╨░ ╨╡╤é╨╕╨║╨╡╤é.' },\r\n        { q: '╨Ü╨╛╨│╨░ ╤ë╨╡ ╨┐╨╛╨╗╤â╤ç╨░ ╨▓╤è╨╖╤ü╤é╨░╨╜╨╛╨▓╤Å╨▓╨░╨╜╨╡╤é╨╛?', a: '╨Æ╤è╨╖╤ü╤é╨░╨╜╨╛╨▓╤Å╨▓╨░╨╜╨╕╤Å╤é╨░ ╤ü╨╡ ╨╛╨▒╤Ç╨░╨▒╨╛╤é╨▓╨░╤é ╨▓ ╤Ç╨░╨╝╨║╨╕╤é╨╡ ╨╜╨░ 3-5 ╤Ç╨░╨▒╨╛╤é╨╜╨╕ ╨┤╨╜╨╕ ╤ü╨╗╨╡╨┤ ╨┐╨╛╨╗╤â╤ç╨░╨▓╨░╨╜╨╡ ╨╜╨░ ╨▓╤Ç╤è╤ë╨░╨╜╨╡╤é╨╛.' },\r\n        { q: '╨£╨╛╨│╨░ ╨╗╨╕ ╨┤╨░ ╤ü╨╝╨╡╨╜╤Å ╨░╤Ç╤é╨╕╨║╤â╨╗ ╨▓╨╝╨╡╤ü╤é╨╛ ╨┤╨░ ╨│╨╛ ╨▓╤è╤Ç╨╜╨░?', a: '╨ö╨░! ╨ƒ╨╛ ╨▓╤Ç╨╡╨╝╨╡ ╨╜╨░ ╨┐╤Ç╨╛╤å╨╡╤ü╨░ ╨╜╨░ ╨▓╤Ç╤è╤ë╨░╨╜╨╡ ╨╝╨╛╨╢╨╡╤é╨╡ ╨┤╨░ ╨╕╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨┤╨░ ╤ü╨╝╨╡╨╜╨╕╤é╨╡ ╤ü ╤Ç╨░╨╖╨╗╨╕╤ç╨╡╨╜ ╤Ç╨░╨╖╨╝╨╡╤Ç ╨╕╨╗╨╕ ╤å╨▓╤Å╤é.' },\r\n      ]\r\n    },\r\n    {\r\n      id: 'payments',\r\n      icon: CreditCard,\r\n      title: '╨ƒ╨╗╨░╤ë╨░╨╜╨╕╤Å ╨╕ ╤å╨╡╨╜╨╕',\r\n      faqs: [\r\n        { q: '╨Ü╨░╨║╨▓╨╕ ╨╝╨╡╤é╨╛╨┤╨╕ ╨╜╨░ ╨┐╨╗╨░╤ë╨░╨╜╨╡ ╨┐╤Ç╨╕╨╡╨╝╨░╤é╨╡?', a: '╨ƒ╤Ç╨╕╨╡╨╝╨░╨╝╨╡ ╨▓╤ü╨╕╤ç╨║╨╕ ╨╛╤ü╨╜╨╛╨▓╨╜╨╕ ╨║╤Ç╨╡╨┤╨╕╤é╨╜╨╕ ╨║╨░╤Ç╤é╨╕ (Visa, Mastercard), PayPal, Apple Pay, Google Pay ╨╕ ╨▒╨░╨╜╨║╨╛╨▓╨╕ ╨┐╤Ç╨╡╨▓╨╛╨┤╨╕.' },\r\n        { q: '╨ù╨░╤ë╨╕╤é╨╡╨╜╨░ ╨╗╨╕ ╨╡ ╨┐╨╗╨░╤é╨╡╨╢╨╜╨░╤é╨░ ╨╝╨╕ ╨╕╨╜╤ä╨╛╤Ç╨╝╨░╤å╨╕╤Å?', a: '╨ö╨░, ╨▓╤ü╨╕╤ç╨║╨╕ ╨┐╨╗╨░╤ë╨░╨╜╨╕╤Å ╤ü╨╡ ╨╛╨▒╤Ç╨░╨▒╨╛╤é╨▓╨░╤é ╨┐╤Ç╨╡╨╖ Stripe ╤ü╤è╤ü SSL ╨║╤Ç╨╕╨┐╤é╨╕╤Ç╨░╨╜╨╡. ╨¥╨╕╨║╨╛╨│╨░ ╨╜╨╡ ╤ü╤è╤à╤Ç╨░╨╜╤Å╨▓╨░╨╝╨╡ ╨┐╤è╨╗╨╜╨╕╤é╨╡ ╨┤╨░╨╜╨╜╨╕ ╨╜╨░ ╨║╨░╤Ç╤é╨░╤é╨░ ╨▓╨╕.' },\r\n        { q: '╨£╨╛╨│╨░ ╨╗╨╕ ╨┤╨░ ╨┐╨╗╨░╤é╤Å ╨╜╨░ ╨▓╨╜╨╛╤ü╨║╨╕?', a: '╨ö╨░, ╨┐╤Ç╨╡╨┤╨╗╨░╨│╨░╨╝╨╡ ╨┐╨╗╨░╤ë╨░╨╜╨╡ ╨╜╨░ ╨▓╨╜╨╛╤ü╨║╨╕ ╤ç╤Ç╨╡╨╖ Klarna ╨╖╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨╕ ╨╜╨░╨┤ 50Γé¼. ╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ \"╨ƒ╨╗╨░╤é╨╕ ╨╜╨░ 4\" ╨┐╤Ç╨╕ ╨┐╨╗╨░╤ë╨░╨╜╨╡.' },\r\n        { q: '╨ù╨░╤ë╨╛ ╨┐╨╗╨░╤ë╨░╨╜╨╡╤é╨╛ ╨╝╨╕ ╨▒╨╡╤ê╨╡ ╨╛╤é╨║╨░╨╖╨░╨╜╨╛?', a: '╨ƒ╨╗╨░╤ë╨░╨╜╨╕╤Å╤é╨░ ╨╝╨╛╨│╨░╤é ╨┤╨░ ╨▒╤è╨┤╨░╤é ╨╛╤é╨║╨░╨╖╨░╨╜╨╕ ╨┐╨╛╤Ç╨░╨┤╨╕ ╨╜╨╡╨┤╨╛╤ü╤é╨░╤é╤è╤ç╨╜╨╕ ╤ü╤Ç╨╡╨┤╤ü╤é╨▓╨░ ╨╕╨╗╨╕ ╨│╤Ç╨╡╤ê╨╜╨╕ ╨┤╨░╨╜╨╜╨╕. ╨£╨╛╨╗╤Å, ╨╛╨┐╨╕╤é╨░╨╣╤é╨╡ ╨╛╤é╨╜╨╛╨▓╨╛.' },\r\n      ]\r\n    },\r\n    {\r\n      id: 'account',\r\n      icon: User,\r\n      title: '╨É╨║╨░╤â╨╜╤é ╨╕ ╨┐╤Ç╨╛╤ä╨╕╨╗',\r\n      faqs: [\r\n        { q: '╨Ü╨░╨║ ╨┤╨░ ╤ü╤è╨╖╨┤╨░╨╝ ╨░╨║╨░╤â╨╜╤é?', a: '╨Ü╨╗╨╕╨║╨╜╨╡╤é╨╡ \"╨á╨╡╨│╨╕╤ü╤é╤Ç╨░╤å╨╕╤Å\" ╨│╨╛╤Ç╨╡ ╨▓╨┤╤Å╤ü╨╜╨╛. ╨£╨╛╨╢╨╡╤é╨╡ ╨┤╨░ ╤ü╨╡ ╤Ç╨╡╨│╨╕╤ü╤é╤Ç╨╕╤Ç╨░╤é╨╡ ╤ü ╨╕╨╝╨╡╨╣╨╗ ╨╕╨╗╨╕ ╤ü Google/Apple.' },\r\n        { q: '╨Ü╨░╨║ ╨┤╨░ ╨╜╤â╨╗╨╕╤Ç╨░╨╝ ╨┐╨░╤Ç╨╛╨╗╨░╤é╨░ ╤ü╨╕?', a: '╨Ü╨╗╨╕╨║╨╜╨╡╤é╨╡ \"╨Æ╤à╨╛╨┤\", ╨┐╨╛╤ü╨╗╨╡ \"╨ù╨░╨▒╤Ç╨░╨▓╨╡╨╜╨░ ╨┐╨░╤Ç╨╛╨╗╨░\". ╨Æ╤è╨▓╨╡╨┤╨╡╤é╨╡ ╨╕╨╝╨╡╨╣╨╗╨░ ╤ü╨╕ ╨╕ ╤ë╨╡ ╨▓╨╕ ╨╕╨╖╨┐╤Ç╨░╤é╨╕╨╝ ╨╗╨╕╨╜╨║ ╨╖╨░ ╨╜╤â╨╗╨╕╤Ç╨░╨╜╨╡.' },\r\n        { q: '╨£╨╛╨│╨░ ╨╗╨╕ ╨┤╨░ ╨╕╨╖╤é╤Ç╨╕╤Å ╨░╨║╨░╤â╨╜╤é╨░ ╤ü╨╕?', a: '╨ö╨░, ╨╝╨╛╨╢╨╡╤é╨╡ ╨┤╨░ ╨╕╨╖╤é╤Ç╨╕╨╡╤é╨╡ ╨░╨║╨░╤â╨╜╤é╨░ ╤ü╨╕ ╨╛╤é ╨¥╨░╤ü╤é╤Ç╨╛╨╣╨║╨╕ > ╨ƒ╨╛╨▓╨╡╤Ç╨╕╤é╨╡╨╗╨╜╨╛╤ü╤é > ╨ÿ╨╖╤é╤Ç╨╕╨╣ ╨░╨║╨░╤â╨╜╤é. ╨ó╨╛╨▓╨░ ╨┤╨╡╨╣╤ü╤é╨▓╨╕╨╡ ╨╡ ╨╜╨╡╨╛╨▒╤Ç╨░╤é╨╕╨╝╨╛.' },\r\n        { q: '╨Ü╨░╨║ ╨┤╨░ ╨┐╤Ç╨╛╨╝╨╡╨╜╤Å ╨╕╨╝╨╡╨╣╨╗ ╨░╨┤╤Ç╨╡╤ü╨░ ╤ü╨╕?', a: '╨₧╤é╨╕╨┤╨╡╤é╨╡ ╨▓ ╨¥╨░╤ü╤é╤Ç╨╛╨╣╨║╨╕ ╨╜╨░ ╨░╨║╨░╤â╨╜╤é╨░ ╨╕ ╨║╨╗╨╕╨║╨╜╨╡╤é╨╡ ╨╜╨░ ╨╕╨╝╨╡╨╣╨╗╨░ ╤ü╨╕. ╨⌐╨╡ ╤é╤Ç╤Å╨▒╨▓╨░ ╨┤╨░ ╨┐╨╛╤é╨▓╤è╤Ç╨┤╨╕╤é╨╡ ╨╜╨╛╨▓╨╕╤Å ╨╕╨╝╨╡╨╣╨╗.' },\r\n      ]\r\n    },\r\n    {\r\n      id: 'selling',\r\n      icon: Shield,\r\n      title: '╨ƒ╤Ç╨╛╨┤╨░╨▓╨░╨╜╨╡ ╨▓ Treido',\r\n      faqs: [\r\n        { q: '╨Ü╨░╨║ ╨┤╨░ ╨╖╨░╨┐╨╛╤ç╨╜╨░ ╨┤╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╨╝?', a: '╨Ü╨╗╨╕╨║╨╜╨╡╤é╨╡ \"╨ƒ╤Ç╨╛╨┤╨░╨╣\" ╨▓ ╨╜╨░╨▓╨╕╨│╨░╤å╨╕╤Å╤é╨░ ╨╕ ╤ü╨╗╨╡╨┤╨▓╨░╨╣╤é╨╡ ╤ü╤é╤è╨┐╨║╨╕╤é╨╡ ╨╖╨░ ╤ü╤è╨╖╨┤╨░╨▓╨░╨╜╨╡ ╨╜╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨║╨╕ ╨░╨║╨░╤â╨╜╤é.' },\r\n        { q: '╨Ü╨░╨║╨▓╨╕ ╤é╨░╨║╤ü╨╕ ╨╜╨░╤ç╨╕╤ü╨╗╤Å╨▓╨░ Treido?', a: '╨¢╨╕╤ç╨╜╨╕╤é╨╡ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨╕ ╨┐╨╗╨░╤ë╨░╤é 0% ╤é╨░╨║╤ü╨░ ╨╖╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨░. ╨æ╨╕╨╖╨╜╨╡╤ü ╨░╨║╨░╤â╨╜╤é╨╕ ╨┐╨╗╨░╤ë╨░╤é ╨╝╨░╨╗╨║╨░ ╤é╨░╨║╤ü╨░ (0.5ΓÇô1.5%) ╤ü╨┐╨╛╤Ç╨╡╨┤ ╨┐╨╗╨░╨╜╨░. ╨Ü╤â╨┐╤â╨▓╨░╤ç╨╕╤é╨╡ ╨┐╨╗╨░╤ë╨░╤é ╤é╨░╨║╤ü╨░ ΓÇ₧╨ù╨░╤ë╨╕╤é╨░ ╨╜╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨░ΓÇ£ ╨┐╤Ç╨╕ ╨┐╨╗╨░╤ë╨░╨╜╨╡ (╨┐╤Ç╨╛╤å╨╡╨╜╤é + ╤ä╨╕╨║╤ü╨╕╤Ç╨░╨╜╨░, ╤ü ╨╗╨╕╨╝╨╕╤é).' },\r\n        { q: '╨Ü╨░╨║ ╨┐╨╛╨╗╤â╤ç╨░╨▓╨░╨╝ ╨┐╨╗╨░╤ë╨░╨╜╨╡ ╨╖╨░ ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕╤é╨╡ ╤ü╨╕?', a: '╨ƒ╨╗╨░╤ë╨░╨╜╨╕╤Å╤é╨░ ╤ü╨╡ ╨┐╤Ç╨╡╨▓╨╡╨╢╨┤╨░╤é ╨┐╨╛ ╨▒╨░╨╜╨║╨╛╨▓╨░╤é╨░ ╨▓╨╕ ╤ü╨╝╨╡╤é╨║╨░ ╨▓ ╤Ç╨░╨╝╨║╨╕╤é╨╡ ╨╜╨░ 3-5 ╤Ç╨░╨▒╨╛╤é╨╜╨╕ ╨┤╨╜╨╕ ╤ü╨╗╨╡╨┤ ╨┐╨╛╤é╨▓╤è╤Ç╨╢╨┤╨╡╨╜╨╕╨╡.' },\r\n        { q: '╨Ü╨░╨║╨▓╨╕ ╨░╤Ç╤é╨╕╨║╤â╨╗╨╕ ╨╝╨╛╨│╨░ ╨┤╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╨╝?', a: '╨£╨╛╨╢╨╡╤é╨╡ ╨┤╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤é╨╡ ╨┐╨╛╨▓╨╡╤ç╨╡╤é╨╛ ╨╜╨╛╨▓╨╕ ╨╕ ╤â╨┐╨╛╤é╤Ç╨╡╨▒╤Å╨▓╨░╨╜╨╕ ╨░╤Ç╤é╨╕╨║╤â╨╗╨╕. ╨ù╨░╨▒╤Ç╨░╨╜╨╡╨╜╨╕ ╤ü╨░ ╨╛╤Ç╤è╨╢╨╕╤Å, ╨╜╨░╤Ç╨║╨╛╤é╨╕╤å╨╕, ╤ä╨░╨╗╤ê╨╕╤ä╨╕╨║╨░╤é╨╕.' },\r\n      ]\r\n    },\r\n    {\r\n      id: 'protection',\r\n      icon: Shield,\r\n      title: '╨ù╨░╤ë╨╕╤é╨░ ╨╜╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨░',\r\n      faqs: [\r\n        { q: '╨Ü╨░╨║╨▓╨╛ ╨╡ ╨ù╨░╤ë╨╕╤é╨░ ╨╜╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨░?', a: '╨ù╨░╤ë╨╕╤é╨░╤é╨░ ╨╜╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨░ ╨│╨░╤Ç╨░╨╜╤é╨╕╤Ç╨░, ╤ç╨╡ ╤ë╨╡ ╨┐╨╛╨╗╤â╤ç╨╕╤é╨╡ ╨░╤Ç╤é╨╕╨║╤â╨╗╨░ ╨║╨░╨║╤é╨╛ ╨╡ ╨╛╨┐╨╕╤ü╨░╨╜ ╨╕╨╗╨╕ ╨┐╤è╨╗╨╜╨╛ ╨▓╤è╨╖╤ü╤é╨░╨╜╨╛╨▓╤Å╨▓╨░╨╜╨╡.' },\r\n        { q: '╨Ü╨░╨║ ╨┤╨░ ╨┐╨╛╨┤╨░╨╝ ╨╢╨░╨╗╨▒╨░?', a: '╨É╨║╨╛ ╨╕╨╝╨░ ╨┐╤Ç╨╛╨▒╨╗╨╡╨╝ ╤ü ╨┐╨╛╤Ç╤è╤ç╨║╨░╤é╨░, ╨╛╤é╨╕╨┤╨╡╤é╨╡ ╨▓ \"╨£╨╛╨╕╤é╨╡ ╨┐╨╛╤Ç╤è╤ç╨║╨╕\" ╨╕ ╨║╨╗╨╕╨║╨╜╨╡╤é╨╡ \"╨ö╨╛╨║╨╗╨░╨┤╨▓╨░╨╣ ╨┐╤Ç╨╛╨▒╨╗╨╡╨╝\".' },\r\n        { q: '╨Ü╨░╨║╨▓╨╛ ╨┐╨╛╨║╤Ç╨╕╨▓╨░ ╨╖╨░╤ë╨╕╤é╨░╤é╨░?', a: '╨ƒ╨╛╨║╤Ç╨╕╨▓╨░ ╨╜╨╡╨┐╨╛╨╗╤â╤ç╨╡╨╜╨╕ ╨░╤Ç╤é╨╕╨║╤â╨╗╨╕, ╨░╤Ç╤é╨╕╨║╤â╨╗╨╕ ╨╖╨╜╨░╤ç╨╕╤é╨╡╨╗╨╜╨╛ ╤Ç╨░╨╖╨╗╨╕╤ç╨╜╨╕ ╨╛╤é ╨╛╨┐╨╕╤ü╨░╨╜╨╕╨╡╤é╨╛ ╨╕ ╨┐╨╛╨▓╤Ç╨╡╨┤╨╡╨╜╨╕ ╨░╤Ç╤é╨╕╨║╤â╨╗╨╕.' },\r\n        { q: '╨Ü╨╛╨╗╨║╨╛ ╨┤╤è╨╗╨│╨╛ ╤é╤Ç╨░╨╡ ╨╖╨░╤ë╨╕╤é╨░╤é╨░?', a: '╨ù╨░╤ë╨╕╤é╨░╤é╨░ ╨╡ ╨░╨║╤é╨╕╨▓╨╜╨░ ╨╛╤é ╨┐╨╛╨║╤â╨┐╨║╨░╤é╨░ ╨┤╨╛ 30 ╨┤╨╜╨╕ ╤ü╨╗╨╡╨┤ ╨┐╨╛╤é╨▓╤è╤Ç╨┤╨╡╨╜╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░.' },\r\n      ]\r\n    },\r\n  ],\r\n}\r\n\r\nexport default async function FAQPage({ params }: { params: Promise<{ locale: string }> }) {\r\n  const { locale: localeParam } = await params\r\n  const locale = validateLocale(localeParam)\r\n  setRequestLocale(locale)\r\n\r\n  const categories = faqCategories[locale as keyof typeof faqCategories] || faqCategories.en\r\n  const t = {\r\n    en: {\r\n      title: 'Frequently Asked Questions',\r\n      subtitle: 'Find answers to common questions about shopping, selling, and more.',\r\n      searchPlaceholder: 'Search FAQ...',\r\n      cantFind: \"Can't find what you're looking for?\",\r\n      contactUs: 'Contact our support team',\r\n      categories: 'Browse by category',\r\n    },\r\n    bg: {\r\n      title: '╨º╨╡╤ü╤é╨╛ ╨╖╨░╨┤╨░╨▓╨░╨╜╨╕ ╨▓╤è╨┐╤Ç╨╛╤ü╨╕',\r\n      subtitle: '╨¥╨░╨╝╨╡╤Ç╨╡╤é╨╡ ╨╛╤é╨│╨╛╨▓╨╛╤Ç╨╕ ╨╜╨░ ╤ç╨╡╤ü╤é╨╛ ╤ü╤Ç╨╡╤ë╨░╨╜╨╕ ╨▓╤è╨┐╤Ç╨╛╤ü╨╕ ╨╖╨░ ╨┐╨░╨╖╨░╤Ç╤â╨▓╨░╨╜╨╡, ╨┐╤Ç╨╛╨┤╨░╨▓╨░╨╜╨╡ ╨╕ ╨╛╤ë╨╡.',\r\n      searchPlaceholder: '╨ó╤è╤Ç╤ü╨╡╨╜╨╡ ╨▓ ╨º╨ù╨Æ...',\r\n      cantFind: '╨¥╨╡ ╨╜╨░╨╝╨╕╤Ç╨░╤é╨╡ ╤é╨╛╨▓╨░, ╨║╨╛╨╡╤é╨╛ ╤é╤è╤Ç╤ü╨╕╤é╨╡?',\r\n      contactUs: '╨í╨▓╤è╤Ç╨╢╨╡╤é╨╡ ╤ü╨╡ ╤ü ╨╜╨░╤ê╨╕╤Å ╨╡╨║╨╕╨┐',\r\n      categories: '╨ƒ╤Ç╨╡╨│╨╗╨╡╨┤╨░╨╣ ╨┐╨╛ ╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å',\r\n    },\r\n  }[locale as 'en' | 'bg'] || {\r\n    title: 'Frequently Asked Questions',\r\n    subtitle: 'Find answers to common questions about shopping, selling, and more.',\r\n    searchPlaceholder: 'Search FAQ...',\r\n    cantFind: \"Can't find what you're looking for?\",\r\n    contactUs: 'Contact our support team',\r\n    categories: 'Browse by category',\r\n  }\r\n\r\n  const breadcrumbItems = [\r\n    { label: locale === 'bg' ? '╨º╨ù╨Æ' : 'FAQ' },\r\n  ]\r\n\r\n  return (\r\n    <PageShell className=\"pb-12\">\r\n      <div className=\"container py-8 px-4 sm:px-6\">\r\n        <AppBreadcrumb items={breadcrumbItems} />\r\n        \r\n        {/* Header */}\r\n        <div className=\"text-center mb-10\">\r\n          <h1 className=\"text-3xl font-bold mb-3\">{t.title}</h1>\r\n          <p className=\"text-muted-foreground max-w-2xl mx-auto\">{t.subtitle}</p>\r\n        </div>\r\n\r\n        {/* Category Cards */}\r\n        <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-10\">\r\n          {categories.map((category) => (\r\n            <a\r\n              key={category.id}\r\n              href={`#${category.id}`}\r\n              className=\"flex flex-col items-center p-4 rounded-lg border border-border bg-card hover:bg-accent transition-colors text-center\"\r\n            >\r\n              <category.icon className=\"w-8 h-8 mb-2 text-primary\" />\r\n              <span className=\"text-sm font-medium\">{category.title}</span>\r\n            </a>\r\n          ))}\r\n        </div>\r\n\r\n        {/* FAQ Sections */}\r\n        <div className=\"space-y-8 max-w-4xl mx-auto\">\r\n          {categories.map((category) => (\r\n            <Card key={category.id} id={category.id} className=\"scroll-mt-20\">\r\n              <CardHeader className=\"pb-4\">\r\n                <CardTitle className=\"flex items-center gap-3\">\r\n                  <category.icon className=\"w-6 h-6 text-primary\" />\r\n                  {category.title}\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <Accordion type=\"single\" collapsible className=\"w-full\">\r\n                  {category.faqs.map((faq, index) => (\r\n                    <AccordionItem key={index} value={`${category.id}-${index}`}>\r\n                      <AccordionTrigger className=\"text-left\">\r\n                        {faq.q}\r\n                      </AccordionTrigger>\r\n                      <AccordionContent className=\"text-muted-foreground\">\r\n                        {faq.a}\r\n                      </AccordionContent>\r\n                    </AccordionItem>\r\n                  ))}\r\n                </Accordion>\r\n              </CardContent>\r\n            </Card>\r\n          ))}\r\n        </div>\r\n\r\n        {/* Contact CTA */}\r\n        <Card className=\"mt-10 max-w-2xl mx-auto bg-surface-subtle\">\r\n          <CardContent className=\"flex flex-col sm:flex-row items-center justify-between gap-4 py-6\">\r\n            <div className=\"text-center sm:text-left\">\r\n              <p className=\"font-medium\">{t.cantFind}</p>\r\n            </div>\r\n            <Link \r\n              href=\"/customer-service\" \r\n              className=\"inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-interactive-hover transition-colors\"\r\n            >\r\n              {t.contactUs}\r\n            </Link>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </PageShell>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(support)\\feedback\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(support)\\help\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(support)\\help\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\(support)\\security\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\_lib\\pagination.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\_providers\\onboarding-provider.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isChecking' is assigned a value but never used.","line":56,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":56,"endColumn":20},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'hideOnboarding' to the outer scope.","line":157,"column":29,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":157,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { createContext, useEffect, useMemo, useState, useRef, type ReactNode } from \"react\"\r\nimport { useRouter, usePathname } from \"next/navigation\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport { useAuthOptional } from \"@/components/providers/auth-state-manager\"\r\n\r\ninterface OnboardingContextValue {\r\n  showOnboarding: () => void\r\n  hideOnboarding: () => void\r\n  isOnboardingComplete: boolean\r\n}\r\n\r\nconst OnboardingContext = createContext<OnboardingContextValue | null>(null)\r\n\r\ninterface OnboardingProviderProps {\r\n  children: ReactNode\r\n  locale: string\r\n}\r\n\r\ninterface ProfileData {\r\n  username: string | null\r\n  display_name: string | null\r\n  onboarding_completed: boolean | null\r\n  account_type: \"personal\" | \"business\"\r\n}\r\n\r\n// Type for raw profile data from Supabase (may not have full type info)\r\ninterface RawProfileData {\r\n  username?: string | null\r\n  display_name?: string | null\r\n  onboarding_completed?: boolean | null\r\n  account_type?: string | null\r\n}\r\n\r\n// Routes that should always be accessible without onboarding\r\nconst BYPASS_PREFIXES = [\"/onboarding\", \"/auth\", \"/api\", \"/terms\", \"/privacy\", \"/help\", \"/search\", \"/cart\", \"/categories\"]\r\n\r\nfunction stripLocale(pathname: string) {\r\n  return pathname.replace(/^\\/(en|bg)(?=\\/|$)/, \"\") || \"/\"\r\n}\r\n\r\nfunction hasPrefix(pathname: string, prefix: string) {\r\n  return pathname === prefix || pathname.startsWith(`${prefix}/`)\r\n}\r\n\r\nexport function OnboardingProvider({\r\n  children,\r\n  locale,\r\n}: OnboardingProviderProps) {\r\n  const auth = useAuthOptional()\r\n  const router = useRouter()\r\n  const pathname = usePathname()\r\n  \r\n  const [profile, setProfile] = useState<ProfileData | null>(null)\r\n  const [isChecking, setIsChecking] = useState(true)\r\n  const hasCheckedRef = useRef<string | null>(null)\r\n  const hasRedirectedRef = useRef(false)\r\n  const previousPathnameRef = useRef<string | null>(null)\r\n\r\n  // Get user from auth context\r\n  const user = auth?.user ?? null\r\n  const authLoading = auth?.isLoading ?? true\r\n\r\n  // Check if current route should bypass onboarding check\r\n  const pathWithoutLocale = useMemo(() => stripLocale(pathname), [pathname])\r\n  const shouldBypass = useMemo(\r\n    () => BYPASS_PREFIXES.some((prefix) => hasPrefix(pathWithoutLocale, prefix)),\r\n    [pathWithoutLocale],\r\n  )\r\n\r\n  // When leaving onboarding routes, force a re-check. This ensures that once the\r\n  // user completes onboarding (DB row updated), we don't keep stale client state.\r\n  useEffect(() => {\r\n    const previous = previousPathnameRef.current\r\n    previousPathnameRef.current = pathWithoutLocale\r\n\r\n    const wasOnboarding = previous ? hasPrefix(previous, \"/onboarding\") : false\r\n    const isOnboarding = hasPrefix(pathWithoutLocale, \"/onboarding\")\r\n\r\n    if (wasOnboarding && !isOnboarding) {\r\n      hasCheckedRef.current = null\r\n      hasRedirectedRef.current = false\r\n      setIsChecking(true)\r\n    }\r\n  }, [pathWithoutLocale])\r\n\r\n  // Check if we should redirect to onboarding when user changes\r\n  useEffect(() => {\r\n    if (authLoading) return // Wait for auth to settle\r\n    if (shouldBypass) {\r\n      setIsChecking(false)\r\n      return // Don't check onboarding on bypass routes\r\n    }\r\n\r\n    const checkOnboarding = async () => {\r\n      if (!user) {\r\n        setProfile(null)\r\n        hasCheckedRef.current = null\r\n        hasRedirectedRef.current = false\r\n        setIsChecking(false)\r\n        return\r\n      }\r\n\r\n      // Already checked for this user\r\n      if (hasCheckedRef.current === user.id) {\r\n        setIsChecking(false)\r\n        return\r\n      }\r\n      hasCheckedRef.current = user.id\r\n\r\n      const supabase = createClient()\r\n\r\n      // Get profile - check onboarding_completed flag\r\n      const { data: rawProfile, error } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"username, display_name, onboarding_completed, account_type\")\r\n        .eq(\"id\", user.id)\r\n        .single()\r\n\r\n      const profileData = rawProfile as RawProfileData | null\r\n      \r\n      if (!error && profileData) {\r\n        setProfile({\r\n          username: profileData.username ?? null,\r\n          display_name: profileData.display_name ?? null,\r\n          onboarding_completed: profileData.onboarding_completed ?? null,\r\n          account_type: (profileData.account_type as \"personal\" | \"business\") ?? \"personal\",\r\n        })\r\n\r\n        // Check if onboarding is needed based on onboarding_completed flag (NOT username)\r\n        const needsOnboarding = profileData.onboarding_completed !== true\r\n\r\n        // Redirect to onboarding if needed and haven't already\r\n        if (needsOnboarding && !hasRedirectedRef.current && !shouldBypass) {\r\n          hasRedirectedRef.current = true\r\n          router.push(`/${locale}/onboarding`)\r\n        }\r\n      } else {\r\n        setProfile(null)\r\n      }\r\n\r\n      setIsChecking(false)\r\n    }\r\n\r\n    checkOnboarding()\r\n  }, [user, authLoading, locale, router, shouldBypass])\r\n\r\n  // Reset redirect flag when pathname changes to allow re-checking\r\n  useEffect(() => {\r\n    if (shouldBypass) {\r\n      hasRedirectedRef.current = false\r\n    }\r\n  }, [pathWithoutLocale, shouldBypass])\r\n\r\n  const showOnboarding = () => router.push(`/${locale}/onboarding`)\r\n  const hideOnboarding = () => {} // No-op for route-based onboarding\r\n\r\n  const isOnboardingComplete = profile?.onboarding_completed === true\r\n\r\n  return (\r\n    <OnboardingContext.Provider value={{ showOnboarding, hideOnboarding, isOnboardingComplete }}>\r\n      {children}\r\n    </OnboardingContext.Provider>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\about\\_components\\about-page-content.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\about\\_components\\about-page-skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\about\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\about\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\accessibility\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\assistant\\_components\\assistant-playground.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\assistant\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\cart\\_components\\cart-page-client.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Badge' is defined but never used.","line":11,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":15,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Badge"},"fix":{"range":[420,465],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect } from \"react\"\r\nimport Image from \"next/image\"\r\nimport { Link, useRouter } from \"@/i18n/routing\"\nimport { useCart } from \"@/components/providers/cart-context\"\nimport { Button } from \"@/components/ui/button\"\nimport { IconButton } from \"@/components/ui/icon-button\"\nimport { Card, CardContent } from \"@/components/ui/card\"\nimport { Separator } from \"@/components/ui/separator\"\nimport { Badge } from \"@/components/ui/badge\"\nimport {\r\n  CheckCircle,\r\n  ShoppingCart,\r\n  Trash,\r\n  Heart,\r\n  SpinnerGap,\r\n  Truck,\r\n  ShieldCheck,\r\n  Minus,\r\n  Plus,\r\n  ArrowRight,\r\n  Package,\r\n} from \"@phosphor-icons/react\"\r\nimport { AppBreadcrumb, breadcrumbPresets } from \"@/components/shared/navigation/app-breadcrumb\"\r\nimport { useTranslations, useLocale } from \"next-intl\"\r\nimport { useRecentlyViewed } from \"@/hooks/use-recently-viewed\"\r\nimport { ProductCard } from \"@/components/shared/product/product-card\"\r\nimport { PageShell } from \"@/components/shared/page-shell\"\r\nimport { useHeaderOptional } from \"@/components/providers/header-context\"\r\n\r\n/** Timeout to show cart content even if auth hasn't finished (ms) */\r\nconst CART_READY_TIMEOUT = 3000\r\n\r\nexport default function CartPageClient() {\r\n  const { items, isReady, removeFromCart, updateQuantity, subtotal, totalItems } = useCart()\r\n  const router = useRouter()\r\n  const t = useTranslations(\"CartPage\")\r\n  const tCartDropdown = useTranslations(\"CartDropdown\")\r\n  const tBreadcrumbs = useTranslations(\"Breadcrumbs\")\r\n  const locale = useLocale()\r\n  const { products: recentlyViewed, isLoaded: recentlyViewedLoaded } = useRecentlyViewed()\r\n  const header = useHeaderOptional()\r\n  \r\n  // Timeout fallback: show cart after 3s even if auth hasn't settled\r\n  const [timedOut, setTimedOut] = useState(false)\r\n  useEffect(() => {\r\n    if (isReady) return // Already ready, no timeout needed\r\n    const timer = setTimeout(() => setTimedOut(true), CART_READY_TIMEOUT)\r\n    return () => clearTimeout(timer)\r\n  }, [isReady])\r\n\r\n  useEffect(() => {\r\n    if (!header) return\r\n    header.setHomepageHeader(null)\r\n    header.setContextualHeader(null)\r\n    header.setProductHeader(null)\r\n  }, [header])\r\n  \r\n  // Cart is \"effectively ready\" if either fully ready or timed out\r\n  const effectivelyReady = isReady || timedOut\r\n\r\n  const handleCheckout = () => {\r\n    if (items.length === 0) return\r\n    router.push(\"/checkout\")\r\n  }\r\n\r\n  const formatPrice = (price: number) => {\r\n    return new Intl.NumberFormat(locale === \"bg\" ? \"bg-BG\" : \"en-IE\", {\r\n      style: \"currency\",\r\n      currency: \"EUR\",\r\n      minimumFractionDigits: 2,\r\n    }).format(price)\r\n  }\r\n\r\n  const getProductUrl = (item: (typeof items)[0]) => {\r\n    const sellerSlug = item.username ?? item.storeSlug\r\n    if (!sellerSlug) return \"#\"\r\n    return `/${sellerSlug}/${item.slug ?? item.id}`\r\n  }\r\n\r\n  // Show loading spinner only while waiting (max 3s)\r\n  if (!effectivelyReady) {\r\n    return (\r\n      <div className=\"bg-secondary/30 min-h-(--page-section-min-h-lg) pt-14 lg:pt-0\">\r\n        <div className=\"container py-6 flex items-center justify-center\">\r\n          <SpinnerGap className=\"size-5 animate-spin text-muted-foreground\" />\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (items.length === 0) {\r\n    const recentItems = recentlyViewed\r\n      .filter((product) => product.username || product.storeSlug)\r\n      .slice(0, 4)\r\n\r\n    return (\r\n      <div className=\"bg-secondary/30 min-h-(--page-section-min-h-lg) pt-14 lg:pt-0\">\r\n        <div className=\"container py-6\">\r\n          <AppBreadcrumb\r\n            items={breadcrumbPresets(tBreadcrumbs).cart}\r\n            ariaLabel={tBreadcrumbs(\"ariaLabel\")}\r\n            homeLabel={tBreadcrumbs(\"homeLabel\")}\r\n            className=\"hidden lg:flex\"\r\n          />\r\n\r\n          <div className=\"mt-8 lg:mt-12 max-w-md mx-auto text-center\">\r\n            <div className=\"size-24 bg-surface-subtle rounded-full flex items-center justify-center mx-auto mb-6\">\r\n              <ShoppingCart className=\"size-10 text-muted-foreground\" weight=\"duotone\" />\r\n            </div>\r\n            <h1 className=\"text-2xl font-semibold mb-2\">{t(\"emptyTitle\")}</h1>\r\n            <p className=\"text-muted-foreground mb-8\">{t(\"emptyDescription\")}</p>\r\n            <div className=\"flex flex-col gap-3\">\r\n              <Button\r\n                asChild\r\n                size=\"lg\"\r\n                className=\"rounded-full h-12 font-medium\"\r\n              >\r\n                <Link href=\"/\">\r\n                  {t(\"continueShopping\")}\r\n                  <ArrowRight className=\"size-4 ml-2\" />\r\n                </Link>\r\n              </Button>\r\n              <Button asChild variant=\"outline\" size=\"lg\" className=\"rounded-full h-12\">\r\n                <Link href=\"/todays-deals\">{t(\"viewDeals\")}</Link>\r\n              </Button>\r\n            </div>\r\n          </div>\r\n\r\n          {recentlyViewedLoaded && recentItems.length > 0 && (\r\n            <section className=\"mt-10\">\r\n              <h2 className=\"text-sm font-semibold text-foreground mb-3\">\r\n                {t(\"recentlyViewedTitle\")}\r\n              </h2>\r\n              <div className=\"grid grid-cols-2 gap-2 md:grid-cols-4\">\r\n                {recentItems.map((product) => (\r\n                  <ProductCard\r\n                    key={`recent-${product.id}`}\r\n                    id={product.id}\r\n                    title={product.title}\r\n                    price={product.price}\r\n                    image={product.image || \"/placeholder.svg\"}\r\n                    slug={product.slug}\r\n                    username={product.username ?? product.storeSlug ?? null}\r\n                    showQuickAdd={false}\r\n                    showSeller={false}\r\n                    showWishlist={false}\r\n                  />\r\n                ))}\r\n              </div>\r\n            </section>\r\n          )}\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <PageShell variant=\"muted\" className=\"pb-32 pt-14 lg:pb-12 lg:pt-0\">\r\n      <div className=\"container py-4 lg:py-6\">\r\n        <AppBreadcrumb\r\n          items={breadcrumbPresets(tBreadcrumbs).cart}\r\n          ariaLabel={tBreadcrumbs(\"ariaLabel\")}\r\n          homeLabel={tBreadcrumbs(\"homeLabel\")}\r\n          className=\"hidden lg:flex\"\r\n        />\r\n\r\n        <div className=\"mt-4 mb-6 flex items-baseline justify-between\">\r\n          <div>\r\n            <h1 className=\"text-2xl lg:text-3xl font-semibold\">{t(\"title\")}</h1>\r\n            <p className=\"text-muted-foreground mt-1 text-sm\">\r\n              {totalItems} {tCartDropdown(totalItems === 1 ? \"item\" : \"items\")}\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 gap-3 lg:grid-cols-3 lg:gap-6\">\n          {/* Cart Items List */}\r\n          <div className=\"lg:col-span-2 space-y-3\">\r\n            {items.map((item, index) => (\r\n              <div \r\n                key={`${item.id}:${item.variantId ?? \"\"}`} \r\n                className=\"bg-card rounded-lg border border-border/50 p-2.5\"\n              >\r\n                <div className=\"flex gap-3\">\r\n                  {/* Image */}\r\n                  <Link\r\n                    href={getProductUrl(item)}\r\n                    className=\"relative shrink-0 size-20 bg-background rounded-md overflow-hidden border border-border/50\"\r\n                  >\r\n                    {item.image ? (\r\n                      <Image\r\n                        src={item.image}\r\n                        alt={item.title}\r\n                        fill\r\n                        className=\"object-contain p-1.5\"\r\n                        sizes=\"80px\"\r\n                        priority={index === 0}\r\n                      />\r\n                    ) : (\r\n                      <div className=\"size-full flex items-center justify-center text-muted-foreground\">\r\n                        <Package size={28} weight=\"duotone\" />\r\n                      </div>\r\n                    )}\r\n                  </Link>\r\n\r\n                  {/* Content */}\r\n                  <div className=\"flex-1 min-w-0 flex flex-col\">\r\n                    {/* Title */}\r\n                    <Link\r\n                      href={getProductUrl(item)}\r\n                      className=\"font-medium hover:text-primary transition-colors line-clamp-2 text-sm leading-snug pr-6\"\r\n                    >\r\n                      {item.title}\r\n                    </Link>\r\n                    \r\n                    {/* Stock badge */}\r\n                    <div className=\"flex items-center gap-1 mt-1\">\r\n                      <CheckCircle className=\"size-3 text-success\" weight=\"fill\" />\r\n                      <span className=\"text-2xs text-success\">{t(\"inStock\")}</span>\r\n                    </div>\r\n\r\n                    {/* Price */}\r\n                    <p className=\"text-base font-bold mt-auto pt-1\">\r\n                      {formatPrice(item.price * item.quantity)}\r\n                    </p>\r\n                  </div>\r\n\r\n                  {/* Right side: Delete + Quantity + Wishlist */}\n                  <div className=\"flex flex-col items-end justify-between shrink-0\">\n                    {/* Delete */}\n                    <IconButton\n                      onClick={() => removeFromCart(item.id, item.variantId)}\n                      size=\"icon-lg\"\n                      variant=\"ghost\"\n                      className=\"hover:bg-destructive-subtle text-muted-foreground hover:text-destructive\"\n                      aria-label={t(\"delete\")}\n                    >\n                      <Trash className=\"size-4\" />\n                    </IconButton>\n\n                    {/* Quantity selector */}\n                    <div className=\"flex items-center h-touch-lg rounded-xl border border-border bg-surface-subtle overflow-hidden\">\n                      <IconButton\n                        size=\"icon-lg\"\n                        variant=\"ghost\"\n                        onClick={() =>\n                          item.quantity > 1 && updateQuantity(item.id, item.quantity - 1, item.variantId)\n                        }\n                        disabled={item.quantity <= 1}\n                        className=\"rounded-none border-r border-border hover:bg-muted disabled:opacity-30\"\n                        aria-label={tCartDropdown(\"decreaseQuantity\")}\n                      >\n                        <Minus className=\"size-3.5\" weight=\"bold\" />\n                      </IconButton>\n                      <span className=\"min-w-touch text-center text-sm font-semibold tabular-nums\">{item.quantity}</span>\n                      <IconButton\n                        size=\"icon-lg\"\n                        variant=\"ghost\"\n                        onClick={() => updateQuantity(item.id, item.quantity + 1, item.variantId)}\n                        disabled={item.quantity >= 10}\n                        className=\"rounded-none border-l border-border hover:bg-muted disabled:opacity-30\"\n                        aria-label={tCartDropdown(\"increaseQuantity\")}\n                      >\n                        <Plus className=\"size-3.5\" weight=\"bold\" />\n                      </IconButton>\n                    </div>\n\n                    {/* Wishlist */}\n                    <IconButton\n                      size=\"icon-lg\"\n                      variant=\"ghost\"\n                      className=\"hover:bg-muted text-muted-foreground hover:text-primary\"\n                      aria-label={t(\"saveForLater\")}\n                    >\n                      <Heart className=\"size-4\" />\n                    </IconButton>\n                  </div>\n                </div>\n              </div>\n            ))}\r\n          </div>\r\n\r\n          {/* Order Summary - Desktop Sidebar */}\n          <div className=\"hidden lg:block\">\n            <div className=\"sticky top-24 space-y-4\">\n              <Card className=\"border-border-subtle\">\n                <CardContent className=\"p-5\">\n                  <h2 className=\"font-semibold text-lg mb-4\">\n                    {t(\"orderSummaryTitle\")}\n                  </h2>\n\r\n                  <div className=\"space-y-3 mb-4\">\r\n                    <div className=\"flex justify-between text-sm\">\r\n                      <span className=\"text-muted-foreground\">\r\n                        {t(\"subtotalCount\", { count: totalItems })}\r\n                      </span>\r\n                      <span>{formatPrice(subtotal)}</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between text-sm\">\r\n                      <span className=\"text-muted-foreground\">{t(\"shippingLabel\")}</span>\r\n                      <span className=\"text-success font-medium\">\r\n                        {t(\"freeLabel\")}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n\r\n                  <Separator className=\"my-4\" />\r\n\r\n                  <div className=\"flex justify-between mb-6\">\r\n                    <span className=\"font-semibold\">{t(\"totalLabel\")}</span>\r\n                    <span className=\"text-xl font-bold\">{formatPrice(subtotal)}</span>\r\n                  </div>\r\n\r\n                  <Button\r\n                    onClick={handleCheckout}\r\n                    variant=\"cta\"\r\n                    size=\"lg\"\r\n                    className=\"w-full rounded-full h-12 font-semibold shadow-sm\"\r\n                  >\r\n                    {t(\"proceedToCheckout\")}\r\n                    <ArrowRight className=\"size-4 ml-2\" />\r\n                  </Button>\r\n\r\n                  <div className=\"mt-6 pt-4 border-t border-border space-y-2\">\r\n                    <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\r\n                      <ShieldCheck className=\"size-4 text-success\" weight=\"fill\" />\r\n                      <span>{t(\"secureCheckout\")}</span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\r\n                      <Truck className=\"size-4 text-primary\" weight=\"fill\" />\r\n                      <span>{t(\"returns30Day\")}</span>\r\n                    </div>\r\n                  </div>\r\n                </CardContent>\r\n              </Card>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Mobile Sticky Footer */}\r\n      <div className=\"fixed bottom-0 inset-x-0 bg-background border-t border-border z-40 lg:hidden pb-safe\">\r\n        <div className=\"flex items-center gap-3 px-4 py-3\">\n          <div className=\"flex-1 min-w-0\">\r\n            <p className=\"text-xs text-muted-foreground mb-0.5\">\r\n              {t(\"totalLabel\")}\r\n            </p>\r\n            <p className=\"text-lg font-bold leading-none\">{formatPrice(subtotal)}</p>\r\n          </div>\r\n          <Button\r\n            onClick={handleCheckout}\r\n            variant=\"cta\"\r\n            size=\"lg\"\r\n            className=\"rounded-full px-8 font-semibold shadow-sm\"\r\n          >\r\n            {t(\"checkout\")}\r\n            <ArrowRight className=\"size-4 ml-1.5\" />\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    </PageShell>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\cart\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\cart\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\cart\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\categories\\[slug]\\[subslug]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\categories\\[slug]\\_lib\\search-products.ts","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 28 to the 25 allowed.","line":7,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":7,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createStaticClient } from \"@/lib/supabase/server\"\r\nimport { ITEMS_PER_PAGE } from \"../../../_lib/pagination\"\r\nimport type { CategoryProductFilters, Product } from \"./types\"\r\nimport { normalizeAttributeKey } from \"@/lib/attributes/normalize-attribute-key\"\r\nimport { logEvent } from \"@/lib/structured-log\"\r\n\r\nexport async function searchProducts(\r\n  supabase: ReturnType<typeof createStaticClient>,\r\n  categoryId: string,\r\n  filters: CategoryProductFilters,\r\n  page: number = 1,\r\n  limit: number = ITEMS_PER_PAGE,\r\n  shippingFilter: string = \"\"\r\n): Promise<{ products: Product[]; total: number }> {\r\n  const debug = process.env.NODE_ENV !== \"production\" && process.env.DEBUG_CATEGORY_SEARCH === \"1\"\r\n  const t0 = debug ? Date.now() : 0\r\n  const offset = (page - 1) * limit\r\n\r\n  // Avoid `select('*')` which can be very expensive on wide tables.\r\n  // For counts, selecting a single column is sufficient.\r\n  // NOTE: exact counts can be very expensive (esp. with shipping OR filters).\r\n  // We use a planned count for much faster response time.\r\n  let countQuery = supabase.from(\"products\").select(\"id\", { count: \"planned\", head: true })\r\n\r\n  // Select only fields needed by the category page cards.\r\n  // IMPORTANT: keep this as a literal string so Supabase types can infer the row shape.\r\n  let dbQuery = supabase.from(\"products\").select(\r\n    \"id,title,price,list_price,images,rating,review_count,category_id,slug,tags,attributes,created_at,profiles:profiles!products_seller_id_fkey(id,username,display_name,business_name,avatar_url,tier,account_type,is_verified_business)\"\r\n  )\r\n\r\n  if (categoryId) {\r\n    countQuery = countQuery.filter(\"category_ancestors\", \"cs\", `{${categoryId}}`)\r\n    dbQuery = dbQuery.filter(\"category_ancestors\", \"cs\", `{${categoryId}}`)\r\n  }\r\n\r\n  if (shippingFilter) {\r\n    countQuery = countQuery.or(shippingFilter)\r\n    dbQuery = dbQuery.or(shippingFilter)\r\n  }\r\n\r\n  if (filters.minPrice) {\r\n    countQuery = countQuery.gte(\"price\", Number(filters.minPrice))\r\n    dbQuery = dbQuery.gte(\"price\", Number(filters.minPrice))\r\n  }\r\n  if (filters.maxPrice) {\r\n    countQuery = countQuery.lte(\"price\", Number(filters.maxPrice))\r\n    dbQuery = dbQuery.lte(\"price\", Number(filters.maxPrice))\r\n  }\r\n  if (filters.tag) {\r\n    countQuery = countQuery.contains(\"tags\", [filters.tag])\r\n    dbQuery = dbQuery.contains(\"tags\", [filters.tag])\r\n  }\r\n  if (filters.minRating) {\r\n    countQuery = countQuery.gte(\"rating\", Number(filters.minRating))\r\n    dbQuery = dbQuery.gte(\"rating\", Number(filters.minRating))\r\n  }\r\n  if (filters.availability === \"instock\") {\r\n    countQuery = countQuery.gt(\"stock\", 0)\r\n    dbQuery = dbQuery.gt(\"stock\", 0)\r\n  }\r\n\r\n  if (filters.attributes) {\r\n    for (const [rawAttrName, attrValue] of Object.entries(filters.attributes)) {\r\n      if (!attrValue) continue\r\n\r\n      const attrName = normalizeAttributeKey(rawAttrName) || rawAttrName\r\n\r\n      if (Array.isArray(attrValue)) {\r\n        const values = attrValue.filter((v): v is string => typeof v === \"string\" && v.length > 0)\r\n        if (values.length === 1) {\r\n          countQuery = countQuery.contains(\"attributes\", { [attrName]: values[0] })\r\n          dbQuery = dbQuery.contains(\"attributes\", { [attrName]: values[0] })\r\n        } else if (values.length > 1) {\r\n          countQuery = countQuery.in(`attributes->>${attrName}`, values)\r\n          dbQuery = dbQuery.in(`attributes->>${attrName}`, values)\r\n        }\r\n      } else if (typeof attrValue === \"string\" && attrValue.length > 0) {\r\n        countQuery = countQuery.contains(\"attributes\", { [attrName]: attrValue })\r\n        dbQuery = dbQuery.contains(\"attributes\", { [attrName]: attrValue })\r\n      }\r\n    }\r\n  }\r\n\r\n  switch (filters.sort) {\r\n    case \"newest\":\r\n      dbQuery = dbQuery.order(\"created_at\", { ascending: false })\r\n      break\r\n    case \"price-asc\":\r\n      dbQuery = dbQuery.order(\"price\", { ascending: true })\r\n      break\r\n    case \"price-desc\":\r\n      dbQuery = dbQuery.order(\"price\", { ascending: false })\r\n      break\r\n    case \"rating\":\r\n      dbQuery = dbQuery.order(\"rating\", { ascending: false, nullsFirst: false })\r\n      break\r\n    default:\r\n      dbQuery = dbQuery.order(\"rating\", { ascending: false, nullsFirst: false })\r\n  }\r\n\r\n  dbQuery = dbQuery.range(offset, offset + limit - 1)\r\n\r\n  const tParallel0 = debug ? Date.now() : 0\r\n  const [{ count: totalCount }, { data }] = await Promise.all([countQuery, dbQuery])\r\n  if (debug) {\r\n    logEvent(\"info\", \"category_search_products_debug\", {\r\n      route: \"category/[slug]\",\r\n      parallelMs: Date.now() - tParallel0,\r\n      rows: (data || []).length,\r\n      total: totalCount ?? 0,\r\n      overallMs: Date.now() - t0,\r\n    })\r\n  }\r\n\r\n  type DbSellerProfile = {\r\n    id: string | null\r\n    username: string | null\r\n    display_name: string | null\r\n    business_name: string | null\r\n    avatar_url: string | null\r\n    tier: string | null\r\n    account_type: string | null\r\n    is_verified_business: boolean | null\r\n  }\r\n\r\n  type DbProductRow = {\r\n    id: string\r\n    title: string\r\n    price: number\r\n    list_price: number | null\r\n    images: string[] | null\r\n    rating: number | null\r\n    review_count: number | null\r\n    category_id: string | null\r\n    slug: string | null\r\n    tags: string[] | null\r\n    attributes: unknown\r\n    profiles: DbSellerProfile | DbSellerProfile[] | null\r\n  }\r\n\r\n  const rows = (data || []) as unknown as DbProductRow[]\r\n\r\n  const products: Product[] = rows.map((p) => {\r\n    const profile = p.profiles && !Array.isArray(p.profiles) ? p.profiles : null\r\n    return {\r\n      id: p.id,\r\n      title: p.title,\r\n      price: p.price,\r\n      list_price: p.list_price,\r\n      images: p.images || [],\r\n      rating: p.rating,\r\n      review_count: p.review_count,\r\n      category_id: p.category_id,\r\n      image_url: p.images?.[0] || null,\r\n      slug: p.slug,\r\n      sellers: profile\r\n        ? {\r\n            id: profile.id ?? null,\r\n            store_slug: profile.username ?? null,\r\n            display_name: profile.display_name ?? null,\r\n            business_name: profile.business_name ?? null,\r\n            avatar_url: profile.avatar_url ?? null,\r\n            tier: profile.tier ?? null,\r\n            account_type: profile.account_type ?? null,\r\n            is_verified_business: profile.is_verified_business ?? null,\r\n          }\r\n        : null,\r\n      attributes: p.attributes as Record<string, string> | null,\r\n      tags: Array.isArray(p.tags) ? p.tags.filter((t) => typeof t === \"string\") : [],\r\n    }\r\n  })\r\n\r\n  return { products, total: totalCount || 0 }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\categories\\[slug]\\_lib\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\categories\\[slug]\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\categories\\[slug]\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\categories\\[slug]\\not-found.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\categories\\[slug]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Product' is defined but never used.","line":22,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":22,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Product"},"fix":{"range":[1100,1143],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createStaticClient } from \"@/lib/supabase/server\"\r\nimport { SubcategoryTabs } from \"@/components/category/subcategory-tabs\"\r\nimport { DesktopFilterToolbar } from \"@/components/desktop/desktop-filter-toolbar\"\r\nimport { FilterChips } from \"@/components/shared/filters/filter-chips\"\r\nimport { SearchPagination } from \"@/components/shared/search/search-pagination\"\r\nimport { EmptyStateCTA } from \"@/components/shared/empty-state-cta\"\r\nimport { DesktopShell } from \"@/components/layout/desktop-shell.server\"\r\nimport { ProductGrid, type ProductGridProduct } from \"@/components/grid\"\r\nimport { Suspense, use } from \"react\"\r\nimport { getTranslations, setRequestLocale } from \"next-intl/server\"\r\nimport { notFound } from \"next/navigation\"\r\nimport type { Metadata } from 'next'\r\nimport CategorySlugLoading from \"./loading\"\r\nimport { normalizeAttributeKey } from \"@/lib/attributes/normalize-attribute-key\"\r\nimport {\n  getCategoryBySlug,\n  getCategoryContext,\n  getSubcategoriesForBrowse,\n  type CategoryWithCount,\n} from \"@/lib/data/categories\"\nimport { searchProducts } from \"./_lib/search-products\"\r\nimport type { Product } from \"./_lib/types\"\r\nimport { ITEMS_PER_PAGE } from \"../../_lib/pagination\"\r\nimport { MobileCategoryBrowser } from \"@/components/mobile/mobile-category-browser\"\r\nimport type { UIProduct } from \"@/lib/data/products\"\r\nimport type { CategoryAttribute } from \"@/lib/types/categories\"\r\n\r\n// =============================================================================\r\n// CATEGORY PAGE - HYBRID CACHING STRATEGY\r\n//\r\n// Static/Cached data (via 'use cache' functions):\r\n// - Category hierarchy (getCategoryContext, getCategoryHierarchy)\r\n// - Category metadata (getCategoryBySlug)\r\n//\r\n// Dynamic data:\r\n// - searchParams-driven filtering/pagination/sort\r\n// =============================================================================\r\n\r\n// Generate metadata for SEO - Uses cached getCategoryBySlug\r\nexport async function generateMetadata({\r\n  params\r\n}: {\r\n  params: Promise<{ slug: string; locale: string }>\r\n}): Promise<Metadata> {\r\n  const { slug, locale } = await params\r\n  setRequestLocale(locale)\r\n\r\n  // Use cached function instead of direct query\r\n  const category = await getCategoryBySlug(slug)\r\n\r\n  if (!category) {\r\n    const tNotFound = await getTranslations({ locale, namespace: \"CategoryNotFound\" })\r\n    return {\r\n      title: tNotFound(\"title\"),\r\n    }\r\n  }\r\n\r\n  const categoryName = locale === \"bg\" && category.name_bg\r\n    ? category.name_bg\r\n    : category.name\r\n\r\n  const t = await getTranslations({ locale, namespace: \"CategoryPage\" })\r\n\r\n  return {\r\n    title: t(\"metaTitle\", { categoryName }),\r\n    description: t(\"metaDescription\", { categoryName }),\r\n    openGraph: {\r\n      title: t(\"metaTitle\", { categoryName }),\r\n      description: t(\"metaDescription\", { categoryName }),\r\n    },\r\n  }\r\n}\r\n\r\n\r\nexport default function CategoryPage({\r\n  params: paramsPromise,\r\n  searchParams: searchParamsPromise,\r\n}: {\r\n  params: Promise<{ slug: string; locale: string }>\r\n  searchParams: Promise<{\r\n    minPrice?: string\r\n    maxPrice?: string\r\n    minRating?: string\r\n    subcategory?: string\r\n    tag?: string\r\n    deals?: string\r\n    brand?: string\r\n    availability?: string\r\n    sort?: string\r\n    page?: string\r\n    [key: string]: string | string[] | undefined  // Dynamic attr_* params\r\n  }>\r\n}) {\r\n  return (\r\n    <Suspense\r\n      fallback={\r\n        <CategorySlugLoading />\r\n      }\r\n    >\r\n      <CategoryPageContent paramsPromise={paramsPromise} searchParamsPromise={searchParamsPromise} />\r\n    </Suspense>\r\n  )\r\n}\r\n\r\nfunction CategoryPageContent({\r\n  paramsPromise,\r\n  searchParamsPromise,\r\n}: {\r\n  paramsPromise: Promise<{ slug: string; locale: string }>\r\n  searchParamsPromise: Promise<{\r\n    minPrice?: string\r\n    maxPrice?: string\r\n    minRating?: string\r\n    subcategory?: string\r\n    tag?: string\r\n    deals?: string\r\n    brand?: string\r\n    availability?: string\r\n    sort?: string\r\n    page?: string\r\n    [key: string]: string | string[] | undefined\r\n  }>\r\n}) {\r\n  const { slug, locale } = use(paramsPromise)\r\n  setRequestLocale(locale)\r\n\r\n  // Cached category shell data\r\n  const categoryContext = use(getCategoryContext(slug))\r\n  if (!categoryContext) {\n    notFound()\n  }\n\r\n  const { current: currentCategory, parent: parentCategory } = categoryContext\r\n  \r\n  // Fetch subcategories with counts - NEVER filter on category browse pages\r\n  // All children should show as circles; sorting handles curated-first ordering\r\n  const subcategoriesWithCounts = use(getSubcategoriesForBrowse(currentCategory.id, false))\r\n\r\n  const categoryId = currentCategory.id\r\n\r\n  const categoryName = locale === 'bg' && currentCategory.name_bg\r\n    ? currentCategory.name_bg\r\n    : currentCategory.name\r\n\r\n  // Extract filterable attributes for the filter toolbar\r\n  const filterableAttributes = categoryContext.attributes.filter(attr => attr.is_filterable)\r\n\r\n  return (\n    <CategoryPageDynamicContent\n      locale={locale}\n      slug={slug}\n      categoryId={categoryId}\n      searchParamsPromise={searchParamsPromise}\r\n      currentCategory={currentCategory}\r\n      parentCategory={parentCategory}\r\n      subcategoriesWithCounts={subcategoriesWithCounts}\n      filterableAttributes={filterableAttributes}\n      categoryName={categoryName}\n    />\n  )\n}\n\r\nfunction CategoryPageDynamicContent({\r\n  locale,\r\n  slug,\r\n  categoryId,\r\n  searchParamsPromise,\r\n  currentCategory,\r\n  parentCategory,\r\n  subcategoriesWithCounts,\n  filterableAttributes,\n  categoryName,\n}: {\n  locale: string\r\n  slug: string\r\n  categoryId: string\r\n  searchParamsPromise: Promise<{\r\n    minPrice?: string\r\n    maxPrice?: string\r\n    minRating?: string\r\n    subcategory?: string\r\n    tag?: string\r\n    deals?: string\r\n    brand?: string\r\n    availability?: string\r\n    sort?: string\r\n    page?: string\r\n    [key: string]: string | string[] | undefined\r\n  }>\r\n  currentCategory: Awaited<ReturnType<typeof getCategoryContext>> extends infer T\r\n    ? T extends { current: infer C }\r\n      ? C\r\n      : never\r\n    : never\r\n  parentCategory: Awaited<ReturnType<typeof getCategoryContext>> extends infer T\r\n    ? T extends { parent: infer P }\r\n      ? P\r\n      : never\r\n    : never\r\n  /** DEC-002: Subcategories with product counts for curated browse UX */\n  subcategoriesWithCounts: CategoryWithCount[]\n  filterableAttributes: CategoryAttribute[]\n  categoryName: string\n}) {\n  // React/Next can only stream partial prerenders when request-bound data is\r\n  // accessed via Suspense. `use()` will suspend this segment properly.\r\n  const searchParams = use(searchParamsPromise)\r\n  const currentPage = Math.max(1, Number.parseInt(searchParams.page || \"1\", 10))\r\n\r\n  const attributeFilters: Record<string, string | string[]> = {}\r\n  for (const [key, value] of Object.entries(searchParams)) {\r\n    if (key.startsWith('attr_') && value) {\r\n      const rawName = key.replace('attr_', '')\r\n      const attrKey = normalizeAttributeKey(rawName) || rawName\r\n      const nextValues = Array.isArray(value) ? value : [value]\r\n      const existing = attributeFilters[attrKey]\r\n      if (!existing) {\r\n        attributeFilters[attrKey] = nextValues\r\n      } else {\r\n        const existingValues = Array.isArray(existing) ? existing : [existing]\r\n        attributeFilters[attrKey] = [...new Set([...existingValues, ...nextValues])]\n      }\r\n    }\r\n  }\r\n\r\n  // NOTE: This route is statically generated for SEO. Avoid request-bound reads\r\n  // (cookies/headers) here so Next.js can prerender successfully.\r\n  const shippingFilter = \"\"\r\n\r\n  const supabase = createStaticClient()\r\n  if (!supabase) {\r\n    notFound()\r\n  }\r\n\r\n  const result = use(\r\n    searchProducts(\r\n      supabase,\r\n      categoryId,\r\n      {\r\n        minPrice: searchParams.minPrice,\r\n        maxPrice: searchParams.maxPrice,\r\n        tag: searchParams.tag,\r\n        minRating: searchParams.minRating,\r\n        availability: searchParams.availability,\r\n        sort: searchParams.sort,\r\n        attributes: Object.keys(attributeFilters).length > 0 ? attributeFilters : undefined,\r\n      },\r\n      currentPage,\r\n      ITEMS_PER_PAGE,\r\n      shippingFilter\r\n    )\r\n  )\r\n\r\n  const products = result.products\r\n  const totalProducts = result.total\r\n\r\n  const mobileInitialProducts: UIProduct[] = products.map((p): UIProduct => ({\r\n    id: p.id,\r\n    title: p.title,\r\n    price: p.price,\r\n    ...(p.list_price != null ? { listPrice: p.list_price } : {}),\r\n    image: p.image_url || p.images?.[0] || '/placeholder.svg',\r\n    rating: p.rating ?? 0,\r\n    reviews: p.review_count ?? 0,\r\n    slug: p.slug ?? null,\r\n    storeSlug: p.sellers?.store_slug ?? null,\r\n    sellerId: p.sellers?.id ?? null,\r\n    sellerName: p.sellers?.display_name || p.sellers?.business_name || p.sellers?.store_slug || null,\r\n    sellerAvatarUrl: p.sellers?.avatar_url ?? null,\r\n    sellerTier:\r\n      p.sellers?.account_type === 'business'\r\n        ? 'business'\r\n        : p.sellers?.tier === 'premium'\r\n          ? 'premium'\r\n          : 'basic',\r\n    sellerVerified: p.sellers?.is_verified_business ?? false,\r\n    ...(p.attributes?.condition ? { condition: p.attributes.condition } : {}),\r\n    ...(p.attributes?.brand ? { brand: p.attributes.brand } : {}),\r\n  }))\r\n\r\n  return (\r\n    <>\r\n      <div className=\"lg:hidden\">\n        <MobileCategoryBrowser\n          initialProducts={mobileInitialProducts}\n          initialProductsSlug={slug}\n          locale={locale}\n          filterableAttributes={filterableAttributes}\n          contextualCategoryName={categoryName}\n          contextualBackHref={\n            parentCategory\n              ? `/categories/${parentCategory.slug}`\r\n              : `/categories`\r\n          }\r\n          // DEC-002: Use subcategoriesWithCounts for curated ordering + visibility filtering\r\n          contextualSubcategories={subcategoriesWithCounts}\r\n          categoryId={categoryId}\r\n          parentCategory={parentCategory ? {\r\n            id: parentCategory.id,\r\n            slug: parentCategory.slug,\r\n            name: parentCategory.name,\r\n            name_bg: parentCategory.name_bg,\r\n            parent_id: parentCategory.parent_id,\r\n          } : null}\r\n        />\r\n      </div>\r\n\r\n      <DesktopShell\r\n        variant=\"muted\"\r\n        className=\"hidden lg:block\"\r\n      >\r\n        {/* Subcategory circles - full width above grid (DEC-002: curated ordering + counts) */}\r\n        <SubcategoryTabs\r\n          currentCategory={currentCategory}\r\n          subcategories={subcategoriesWithCounts}\r\n          parentCategory={parentCategory}\r\n          basePath=\"/categories\"\r\n          variant=\"desktop\"\r\n          showCounts={true}\r\n        />\r\n\r\n        {/* Unified Filter Toolbar */}\r\n        <DesktopFilterToolbar\r\n          locale={locale}\r\n          productCount={totalProducts}\r\n          categoryName={categoryName}\r\n          categorySlug={slug}\r\n          categoryId={categoryId}\r\n          attributes={filterableAttributes}\r\n        />\r\n\r\n        {/* Active filter chips */}\r\n        <FilterChips currentCategory={currentCategory} basePath={`/categories/${slug}`} className=\"mb-3\" />\r\n\r\n        {/* Product grid with container queries */}\r\n        <div>\r\n          {products.length === 0 ? (\r\n            <EmptyStateCTA variant=\"no-category\" categoryName={categoryName} className=\"mt-4\" />\r\n          ) : (\r\n            <ProductGrid\r\n              products={products.map((product): ProductGridProduct => ({\r\n                id: product.id,\r\n                title: product.title,\r\n                price: product.price,\r\n                image: product.image_url || product.images?.[0] || \"/placeholder.svg\",\r\n                listPrice: product.list_price ?? undefined,\r\n                rating: product.rating ?? 0,\r\n                reviews: product.review_count ?? 0,\r\n                slug: product.slug ?? null,\r\n                storeSlug: product.sellers?.store_slug ?? null,\r\n                sellerId: product.sellers?.id ?? null,\r\n                sellerName: product.sellers?.display_name || product.sellers?.business_name || product.sellers?.store_slug || undefined,\r\n                sellerAvatarUrl: product.sellers?.avatar_url ?? null,\r\n                sellerVerified: Boolean(product.sellers?.is_verified_business),\r\n                condition: product.attributes?.condition,\r\n                tags: product.tags ?? [],\r\n              }))}\r\n              viewMode=\"grid\"\r\n            />\r\n          )}\r\n        </div>\r\n\r\n        {products.length > 0 && (\r\n          <SearchPagination\r\n            totalItems={totalProducts}\r\n            itemsPerPage={ITEMS_PER_PAGE}\r\n            currentPage={currentPage}\r\n          />\r\n        )}\r\n      </DesktopShell>\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\categories\\_components\\categories-header-sync.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\categories\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\categories\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\categories\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\gift-cards\\_components\\gift-cards-featured-designs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\gift-cards\\_components\\gift-cards-hero.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\gift-cards\\_components\\gift-cards-loading-skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\gift-cards\\_components\\gift-cards-quick-actions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\gift-cards\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\gift-cards\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\members\\_components\\members-loading-skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\members\\_components\\members-page-client.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 31 to the 25 allowed.","line":132,"column":25,"nodeType":null,"messageId":"refactorFunction","endLine":132,"endColumn":42}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useTransition } from \"react\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useRouter } from \"@/i18n/routing\"\r\nimport { formatDistanceToNow } from \"date-fns\"\r\nimport {\r\n  ArrowLeft,\r\n  ArrowRight,\r\n  CheckCircle,\r\n  MagnifyingGlass,\r\n  MapPin,\r\n  Package,\r\n  ShoppingBag,\r\n  SpinnerGap,\r\n  Star,\r\n  Storefront,\r\n  Users,\r\n} from \"@phosphor-icons/react\"\r\n\r\nimport { AppBreadcrumb } from \"@/components/shared/navigation/app-breadcrumb\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { FieldLabel } from \"@/components/shared/field\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { ToggleGroup, ToggleGroupItem } from \"@/components/ui/toggle-group\"\r\nimport { UserAvatar } from \"@/components/shared/user-avatar\"\r\nimport { PageShell } from \"@/components/shared/page-shell\"\r\n\r\ninterface Member {\r\n  id: string\r\n  username: string | null\r\n  display_name: string | null\r\n  avatar_url: string | null\r\n  account_type: string | null\r\n  is_seller: boolean | null\r\n  is_verified_business: boolean | null\r\n  verified: boolean | null\r\n  location: string | null\r\n  tier: string | null\r\n  created_at: string\r\n}\r\n\r\nexport interface MembersPageClientProps {\r\n  members: Member[]\r\n  totalCount: number\r\n  totalMembers: number\r\n  totalSellers: number\r\n  currentPage: number\r\n  totalPages: number\r\n  filter: string\r\n  sort: string\r\n  searchQuery: string\r\n  locale: string\r\n}\r\n\r\nfunction MemberCard({ member, locale }: { member: Member; locale: string }) {\r\n  const displayName = member.display_name || member.username || \"Unknown\"\r\n\r\n  return (\r\n    <Link href={`/${member.username || \"unknown\"}`}>\r\n      <Card className=\"h-full hover:shadow-md transition-shadow cursor-pointer group\">\r\n        <CardContent className=\"p-4\">\r\n          <div className=\"flex items-start gap-3\">\r\n            <div className=\"relative\">\r\n              <UserAvatar\r\n                name={displayName}\r\n                avatarUrl={member.avatar_url ?? null}\r\n                className=\"size-14 border-2 border-background shadow bg-muted\"\r\n                fallbackClassName=\"text-lg bg-selected text-primary\"\r\n              />\r\n              {(member.is_verified_business || member.verified) && (\r\n                <div className=\"absolute -bottom-0.5 -right-0.5 bg-info rounded-full p-0.5 border-2 border-background\">\r\n                  <CheckCircle className=\"size-3 text-info-foreground\" weight=\"fill\" />\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"flex-1 min-w-0\">\r\n              <div className=\"flex items-center gap-1.5\">\r\n                <h3 className=\"font-semibold truncate group-hover:text-primary transition-colors\">{displayName}</h3>\r\n              </div>\r\n              <p className=\"text-xs text-muted-foreground\">@{member.username}</p>\r\n\r\n              <div className=\"flex flex-wrap items-center gap-1.5 mt-2\">\r\n                {member.is_seller && (\r\n                  <Badge variant=\"secondary\" className=\"text-2xs px-1.5 py-0 gap-0.5\">\r\n                    <Package className=\"size-3\" />\r\n                    Seller\r\n                  </Badge>\r\n                )}\r\n                {member.tier && member.tier !== \"free\" && (\r\n                  <Badge\r\n                    variant=\"outline\"\r\n                    className=\"text-2xs px-1.5 py-0 gap-0.5 text-rating border-rating/30 bg-rating/10\"\r\n                  >\r\n                    <Star className=\"size-3\" weight=\"fill\" />\r\n                    {member.tier}\r\n                  </Badge>\r\n                )}\r\n              </div>\r\n\r\n              {member.location && (\r\n                <p className=\"text-xs text-muted-foreground flex items-center gap-1 mt-1.5\">\r\n                  <MapPin className=\"size-3\" />\r\n                  {member.location}\r\n                </p>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex items-center justify-between mt-3 pt-3 border-t text-xs text-muted-foreground\">\r\n            {member.account_type === \"business\" && (\r\n              <Badge variant=\"secondary\" className=\"text-2xs px-1.5 py-0\">\r\n                <Storefront className=\"size-3 mr-0.5\" />\r\n                {locale === \"bg\" ? \"╨æ╨╕╨╖╨╜╨╡╤ü\" : \"Business\"}\r\n              </Badge>\r\n            )}\r\n            <span className=\"text-2xs text-muted-foreground\">\r\n              {locale === \"bg\" ? \"╨ƒ╤Ç╨╕╤ü╤è╨╡╨┤╨╕╨╜╨╕╨╗ ╤ü╨╡\" : \"Joined\"}{\" \"}\r\n              {formatDistanceToNow(new Date(member.created_at), { addSuffix: true })}\r\n            </span>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </Link>\r\n  )\r\n}\r\n\r\nexport default function MembersPageClient({\r\n  members,\r\n  totalCount,\r\n  totalMembers,\r\n  totalSellers,\r\n  currentPage,\r\n  totalPages,\r\n  filter,\r\n  sort,\r\n  searchQuery,\r\n  locale,\r\n}: MembersPageClientProps) {\r\n  const router = useRouter()\r\n  const [isPending, startTransition] = useTransition()\r\n  const [search, setSearch] = useState(searchQuery)\r\n\r\n  const updateParams = (updates: Record<string, string>) => {\r\n    const params = new URLSearchParams()\r\n    if (filter !== \"all\" || updates.filter) params.set(\"filter\", updates.filter || filter)\r\n    if (sort !== \"active\" || updates.sort) params.set(\"sort\", updates.sort || sort)\r\n    if (search || updates.q) params.set(\"q\", updates.q ?? search)\r\n    if (updates.page) params.set(\"page\", updates.page)\r\n\r\n    startTransition(() => {\r\n      router.push(`/members?${params.toString()}`)\r\n    })\r\n  }\r\n\r\n  const handleSearch = (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    updateParams({ q: search, page: \"1\" })\r\n  }\r\n\r\n  return (\r\n    <PageShell variant=\"muted\" className=\"pb-20 sm:pb-8\">\r\n      <div className=\"bg-primary text-primary-foreground py-6 sm:py-10\">\r\n        <div className=\"container\">\r\n          <div className=\"[&_nav]:border-border-subtle [&_nav]:mb-2 [&_a]:text-foreground [&_a:hover]:text-primary-foreground [&_span[aria-current]]:text-primary-foreground [&_svg]:text-muted-foreground\">\r\n            <AppBreadcrumb\r\n              items={[\r\n                { label: locale === \"bg\" ? \"╨¥╨░╤ç╨░╨╗╨╛\" : \"Home\", href: \"/\" },\r\n                { label: locale === \"bg\" ? \"╨₧╨▒╤ë╨╜╨╛╤ü╤é\" : \"Community\" },\r\n              ]}\r\n              homeLabel={locale === \"bg\" ? \"╨¥╨░╤ç╨░╨╗╨╛\" : \"Treido\"}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"flex items-center gap-3 mb-2\">\r\n            <div className=\"size-12 sm:size-14 bg-hover rounded-full flex items-center justify-center\">\r\n              <Users className=\"size-6 sm:size-7 text-primary-foreground\" weight=\"fill\" />\r\n            </div>\r\n            <div>\r\n              <h1 className=\"text-2xl sm:text-4xl font-bold\">{locale === \"bg\" ? \"╨₧╨▒╤ë╨╜╨╛╤ü╤é\" : \"Community\"}</h1>\r\n              <p className=\"text-foreground text-sm sm:text-base mt-1\">\r\n                {locale === \"bg\" ? \"╨₧╤é╨║╤Ç╨╕╨╣ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨╕ ╨╕ ╨║╤â╨┐╤â╨▓╨░╤ç╨╕\" : \"Discover sellers and buyers\"}\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex gap-4 mt-4 text-sm\">\r\n            <div>\r\n              <span className=\"text-2xl font-bold\">{totalMembers.toLocaleString()}</span>\r\n              <p className=\"text-foreground\">{locale === \"bg\" ? \"╤ç╨╗╨╡╨╜╨╛╨▓╨╡\" : \"members\"}</p>\r\n            </div>\r\n            <div>\r\n              <span className=\"text-2xl font-bold\">{totalSellers.toLocaleString()}</span>\r\n              <p className=\"text-foreground\">{locale === \"bg\" ? \"╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨╕\" : \"sellers\"}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"container py-6\">\r\n        <div className=\"flex flex-col sm:flex-row gap-4 mb-6\">\r\n          <form onSubmit={handleSearch} className=\"flex-1\">\r\n            <div className=\"relative\">\r\n              <MagnifyingGlass className=\"absolute left-3 top-1/2 -translate-y-1/2 size-4 text-muted-foreground\" />\r\n              <FieldLabel htmlFor=\"members-search\" className=\"sr-only\">\r\n                {locale === \"bg\" ? \"╨ó╤è╤Ç╤ü╨╕ ╨┐╨╛ ╨╕╨╝╨╡\" : \"Search by name\"}\r\n              </FieldLabel>\r\n              <Input\r\n                id=\"members-search\"\r\n                placeholder={locale === \"bg\" ? \"╨ó╤è╤Ç╤ü╨╕ ╨┐╨╛ ╨╕╨╝╨╡...\" : \"Search by name...\"}\r\n                value={search}\r\n                onChange={(e) => setSearch(e.target.value)}\r\n                className=\"pl-9 pr-20\"\r\n              />\r\n              <Button\r\n                type=\"submit\"\r\n                size=\"sm\"\r\n                className=\"absolute right-1 top-1/2 -translate-y-1/2\"\r\n                disabled={isPending}\r\n              >\r\n                {isPending ? (\r\n                  <SpinnerGap className=\"size-4 animate-spin\" />\r\n                ) : locale === \"bg\" ? (\r\n                  \"╨ó╤è╤Ç╤ü╨╕\"\r\n                ) : (\r\n                  \"Search\"\r\n                )}\r\n              </Button>\r\n            </div>\r\n          </form>\r\n\r\n          <Select value={sort} onValueChange={(value) => updateParams({ sort: value, page: \"1\" })}>\r\n            <SelectTrigger className=\"w-full sm:w-(--members-sort-w-sm)\">\r\n              <SelectValue placeholder={locale === \"bg\" ? \"╨í╨╛╤Ç╤é╨╕╤Ç╨░╨╣ ╨┐╨╛\" : \"Sort by\"} />\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              <SelectItem value=\"active\">{locale === \"bg\" ? \"╨¥╨░╤ü╨║╨╛╤Ç╨╛ ╨░╨║╤é╨╕╨▓╨╜╨╕\" : \"Recently Active\"}</SelectItem>\r\n              <SelectItem value=\"rating\">{locale === \"bg\" ? \"╨¥╨░╨╣-╨▓╨╕╤ü╨╛╨║╨╛ ╨╛╤å╨╡╨╜╨╡╨╜╨╕\" : \"Highest Rated\"}</SelectItem>\r\n              <SelectItem value=\"sales\">{locale === \"bg\" ? \"╨¥╨░╨╣-╨╝╨╜╨╛╨│╨╛ ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕\" : \"Most Sales\"}</SelectItem>\r\n              <SelectItem value=\"purchases\">{locale === \"bg\" ? \"╨¥╨░╨╣-╨╝╨╜╨╛╨│╨╛ ╨┐╨╛╨║╤â╨┐╨║╨╕\" : \"Most Purchases\"}</SelectItem>\r\n              <SelectItem value=\"newest\">{locale === \"bg\" ? \"╨¥╨░╨╣-╨╜╨╛╨▓╨╕\" : \"Newest\"}</SelectItem>\r\n            </SelectContent>\r\n          </Select>\r\n        </div>\r\n\r\n        <ToggleGroup\r\n          type=\"single\"\r\n          value={filter}\r\n          onValueChange={(value) => value && updateParams({ filter: value, page: \"1\" })}\r\n          className=\"justify-start mb-6\"\r\n        >\r\n          <ToggleGroupItem value=\"all\" className=\"gap-2\">\r\n            <Users className=\"size-4\" />\r\n            {locale === \"bg\" ? \"╨Æ╤ü╨╕╤ç╨║╨╕\" : \"All\"}\r\n          </ToggleGroupItem>\r\n          <ToggleGroupItem value=\"sellers\" className=\"gap-2\">\r\n            <Package className=\"size-4\" />\r\n            {locale === \"bg\" ? \"╨ƒ╤Ç╨╛╨┤╨░╨▓╨░╤ç╨╕\" : \"Sellers\"}\r\n          </ToggleGroupItem>\r\n          <ToggleGroupItem value=\"buyers\" className=\"gap-2\">\r\n            <ShoppingBag className=\"size-4\" />\r\n            {locale === \"bg\" ? \"╨Ü╤â╨┐╤â╨▓╨░╤ç╨╕\" : \"Buyers\"}\r\n          </ToggleGroupItem>\r\n          <ToggleGroupItem value=\"business\" className=\"gap-2\">\r\n            <Storefront className=\"size-4\" />\r\n            {locale === \"bg\" ? \"╨æ╨╕╨╖╨╜╨╡╤ü\" : \"Business\"}\r\n          </ToggleGroupItem>\r\n        </ToggleGroup>\r\n\r\n        <p className=\"text-sm text-muted-foreground mb-4\">\r\n          <span className=\"font-semibold text-foreground\">{totalCount.toLocaleString()}</span>{\" \"}\r\n          {locale === \"bg\" ? \"╤Ç╨╡╨╖╤â╨╗╤é╨░╤é╨░\" : \"results\"}\r\n          {searchQuery && <span> {locale === \"bg\" ? \"╨╖╨░\" : \"for\"} &quot;{searchQuery}&quot;</span>}\r\n        </p>\r\n\r\n        {members.length > 0 ? (\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\r\n            {members.map((member) => (\r\n              <MemberCard key={member.id} member={member} locale={locale} />\r\n            ))}\r\n          </div>\r\n        ) : (\r\n          <div className=\"py-12 text-center text-muted-foreground\">\r\n            <Users className=\"size-12 mx-auto mb-3 opacity-50\" />\r\n            <p>{locale === \"bg\" ? \"╨¥╤Å╨╝╨░ ╨╜╨░╨╝╨╡╤Ç╨╡╨╜╨╕ ╤ç╨╗╨╡╨╜╨╛╨▓╨╡\" : \"No members found\"}</p>\r\n          </div>\r\n        )}\r\n\r\n        {totalPages > 1 && (\r\n          <div className=\"flex items-center justify-center gap-2 mt-8\">\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              disabled={currentPage <= 1 || isPending}\r\n              onClick={() => updateParams({ page: String(currentPage - 1) })}\r\n            >\r\n              <ArrowLeft className=\"size-4 mr-1\" />\r\n              {locale === \"bg\" ? \"╨ƒ╤Ç╨╡╨┤╨╕╤ê╨╜╨░\" : \"Previous\"}\r\n            </Button>\r\n\r\n            <span className=\"text-sm text-muted-foreground px-4\">\r\n              {locale === \"bg\" ? \"╨í╤é╤Ç╨░╨╜╨╕╤å╨░\" : \"Page\"} {currentPage} {locale === \"bg\" ? \"╨╛╤é\" : \"of\"} {totalPages}\r\n            </span>\r\n\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              disabled={currentPage >= totalPages || isPending}\r\n              onClick={() => updateParams({ page: String(currentPage + 1) })}\r\n            >\r\n              {locale === \"bg\" ? \"╨í╨╗╨╡╨┤╨▓╨░╤ë╨░\" : \"Next\"}\r\n              <ArrowRight className=\"size-4 ml-1\" />\r\n            </Button>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </PageShell>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\members\\_lib\\get-members-page-data.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MembersFilter' is defined but never used.","line":3,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":28,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MembersFilter"},"fix":{"range":[70,84],"text":""},"desc":"Remove unused variable \"MembersFilter\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MembersSort' is defined but never used.","line":3,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":62,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"MembersSort"},"fix":{"range":[104,117],"text":""},"desc":"Remove unused variable \"MembersSort\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/lib/supabase/server\"\r\n\r\nimport type { MembersFilter, MembersSearchParams, MembersSort } from \"./members-types\"\r\n\r\nconst PAGE_SIZE = 24\r\n\r\nexport async function getMembersPageData(searchParams: MembersSearchParams) {\r\n  const { filter = \"all\", sort = \"active\", page = \"1\", q } = searchParams\r\n\r\n  const supabase = await createClient()\r\n\r\n  const currentPage = Number.parseInt(page) || 1\r\n  const offset = (currentPage - 1) * PAGE_SIZE\r\n\r\n  // Build the query with all conditions applied inline\r\n  // This avoids complex generic types for the query builder\r\n  let baseQuery = supabase\r\n    .from(\"profiles\")\r\n    .select(\r\n      `\r\n      id,\r\n      username,\r\n      display_name,\r\n      avatar_url,\r\n      account_type,\r\n      is_seller,\r\n      is_verified_business,\r\n      verified,\r\n      location,\r\n      tier,\r\n      created_at\r\n    `,\r\n      { count: \"exact\" }\r\n    )\r\n    .not(\"username\", \"is\", null)\r\n\r\n  // Apply filter\r\n  if (filter === \"sellers\") {\r\n    baseQuery = baseQuery.eq(\"is_seller\", true)\r\n  } else if (filter === \"buyers\") {\r\n    baseQuery = baseQuery.eq(\"is_seller\", false)\r\n  } else if (filter === \"business\") {\r\n    baseQuery = baseQuery.eq(\"account_type\", \"business\")\r\n  }\r\n\r\n  // Apply search\r\n  if (q) {\r\n    baseQuery = baseQuery.or(`username.ilike.%${q}%,display_name.ilike.%${q}%`)\r\n  }\r\n\r\n  // Apply sort\r\n  if (sort === \"rating\") {\r\n    baseQuery = baseQuery.order(\"seller_rating\", { ascending: false, nullsFirst: false })\r\n  } else if (sort === \"sales\") {\r\n    baseQuery = baseQuery.order(\"total_sales\", { ascending: false })\r\n  } else if (sort === \"purchases\") {\r\n    baseQuery = baseQuery.order(\"total_purchases\", { ascending: false })\r\n  } else if (sort === \"newest\") {\r\n    baseQuery = baseQuery.order(\"created_at\", { ascending: false })\r\n  } else {\r\n    // \"active\" is the default\r\n    baseQuery = baseQuery.order(\"last_active_at\", { ascending: false, nullsFirst: false })\r\n  }\r\n\r\n  // Apply pagination\r\n  baseQuery = baseQuery.range(offset, offset + PAGE_SIZE - 1)\r\n\r\n  const { data: members, count, error } = await baseQuery\r\n  if (error) {\r\n    throw error\r\n  }\r\n\r\n  const totalPages = Math.ceil((count || 0) / PAGE_SIZE)\r\n\r\n  const { count: totalMembers } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"id\", { count: \"exact\", head: true })\r\n    .not(\"username\", \"is\", null)\r\n\r\n  const { count: totalSellers } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"id\", { count: \"exact\", head: true })\r\n    .eq(\"is_seller\", true)\r\n    .not(\"username\", \"is\", null)\r\n\r\n  return {\r\n    members: members || [],\r\n    totalCount: count || 0,\r\n    totalMembers: totalMembers || 0,\r\n    totalSellers: totalSellers || 0,\r\n    currentPage,\r\n    totalPages,\r\n    filter,\r\n    sort,\r\n    searchQuery: q || \"\",\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\members\\_lib\\members-types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\members\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\members\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\members\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\messages\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\registry\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\registry\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\search\\_components\\search-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\search\\_lib\\search-products.ts","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 30 to the 25 allowed.","line":61,"column":41,"nodeType":null,"messageId":"refactorFunction","endLine":61,"endColumn":43}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createStaticClient } from \"@/lib/supabase/server\"\nimport { ITEMS_PER_PAGE } from \"../../_lib/pagination\"\nimport type { Product, SearchProductFilters } from \"./types\"\nimport { isBoostActiveNow } from \"@/lib/boost/boost-status\"\nimport { normalizeAttributeKey } from \"@/lib/attributes/normalize-attribute-key\"\n\r\ntype SearchQueryResult = {\r\n  data?: unknown[] | null\r\n  count?: number | null\r\n}\r\n\r\ntype SearchQuery = {\n  select: (columns: string, options?: Record<string, unknown>) => SearchQuery\n  or: (filters: string) => SearchQuery\n  in: (column: string, values: string[]) => SearchQuery\n  ilike: (column: string, pattern: string) => SearchQuery\n  gte: (column: string, value: number) => SearchQuery\n  lte: (column: string, value: number) => SearchQuery\n  contains: (column: string, value: unknown) => SearchQuery\n  eq: (column: string, value: unknown) => SearchQuery\r\n  gt: (column: string, value: unknown) => SearchQuery\r\n  order: (column: string, options: { ascending: boolean; nullsFirst?: boolean }) => SearchQuery\r\n  range: (from: number, to: number) => PromiseLike<SearchQueryResult>\r\n} & PromiseLike<SearchQueryResult>\r\n\r\nexport async function searchProducts(\r\n  supabase: ReturnType<typeof createStaticClient>,\r\n  query: string,\r\n  categoryIds: string[] | null,\r\n  filters: SearchProductFilters,\r\n  page: number = 1,\r\n  limit: number = ITEMS_PER_PAGE,\r\n  shippingFilter?: string\r\n): Promise<{ products: Product[]; total: number }> {\r\n  const offset = (page - 1) * limit\n  const nowIso = new Date().toISOString()\n  const dealsOnly = filters.deals === \"true\"\n  const promotedOnly = filters.promoted === \"true\"\n\r\n  const buildCountBase = () => {\r\n    const base = dealsOnly\r\n      ? supabase.from(\"deal_products\")\r\n      : supabase.from(\"products\")\r\n\r\n    return base.select(\r\n      \"id, profiles!products_seller_id_fkey(is_verified_business,account_type)\",\r\n      { count: \"exact\", head: true }\r\n    ) as unknown as SearchQuery\r\n  }\r\n\r\n  const buildDbBase = () => {\r\n    const base = dealsOnly\r\n      ? supabase.from(\"deal_products\")\r\n      : supabase.from(\"products\")\r\n\r\n    return base.select(\r\n      \"id,title,price,list_price,images,rating,review_count,category_id,slug,tags,is_boosted,boost_expires_at,profiles:profiles!products_seller_id_fkey(id,username,display_name,business_name,avatar_url,tier,account_type,is_verified_business),categories:categories!products_category_id_fkey(slug)\"\r\n    ) as unknown as SearchQuery\r\n  }\r\n\r\n  const applyFilters = (q: SearchQuery) => {\r\n    let next = q\r\n\r\n    if (shippingFilter) next = next.or(shippingFilter)\r\n\r\n    if (categoryIds && categoryIds.length > 0) next = next.in(\"category_id\", categoryIds)\r\n\r\n    if (filters.minPrice) next = next.gte(\"price\", Number(filters.minPrice))\n    if (filters.maxPrice) next = next.lte(\"price\", Number(filters.maxPrice))\n    if (filters.tag) next = next.contains(\"tags\", [filters.tag])\n    if (filters.minRating) next = next.gte(\"rating\", Number(filters.minRating))\n    if (filters.nearby === \"true\") {\n      const normalizedCity = filters.city?.trim().toLowerCase()\n      const targetCity =\n        normalizedCity && normalizedCity !== \"undefined\" && normalizedCity !== \"null\"\n          ? normalizedCity\n          : \"sofia\"\n      next = next.ilike(\"seller_city\", targetCity)\n    }\n\n    // Verified sellers (business verification)\n    if (filters.verified === \"true\") next = next.eq(\"profiles.is_verified_business\", true)\n    if (filters.availability === \"instock\") next = next.gt(\"stock\", 0)\r\n\r\n    if (filters.attributes) {\r\n      for (const [rawAttrName, attrValue] of Object.entries(filters.attributes)) {\r\n        if (!attrValue) continue\r\n\r\n        const attrName = normalizeAttributeKey(rawAttrName) || rawAttrName\r\n\r\n        if (Array.isArray(attrValue)) {\r\n          const values = attrValue.filter((v): v is string => typeof v === \"string\" && v.length > 0)\r\n          if (values.length === 1) {\r\n            next = next.contains(\"attributes\", { [attrName]: values[0] })\r\n          } else if (values.length > 1) {\r\n            next = next.in(`attributes->>${attrName}`, values)\r\n          }\r\n        } else if (typeof attrValue === \"string\" && attrValue.length > 0) {\r\n          next = next.contains(\"attributes\", { [attrName]: attrValue })\r\n        }\r\n      }\r\n    }\r\n\r\n    if (query) {\r\n      next = next.or(`title.ilike.%${query}%,description.ilike.%${query}%`)\r\n    }\r\n\r\n    return next\r\n  }\r\n\r\n  const applySecondarySort = (q: SearchQuery) => {\r\n    switch (filters.sort) {\r\n      case \"newest\":\r\n        return q.order(\"created_at\", { ascending: false })\r\n      case \"price-asc\":\r\n        return q.order(\"price\", { ascending: true })\r\n      case \"price-desc\":\r\n        return q.order(\"price\", { ascending: false })\r\n      case \"rating\":\r\n        return q.order(\"rating\", { ascending: false, nullsFirst: false })\r\n      default:\r\n        return q.order(\"rating\", { ascending: false, nullsFirst: false })\r\n    }\r\n  }\r\n\r\n  const { count: boostedCountRaw } = await applyFilters(buildCountBase())\n    .eq(\"is_boosted\", true)\n    .gt(\"boost_expires_at\", nowIso)\n\n  const boostedCount = boostedCountRaw || 0\n\r\n  const boostedBase = () =>\r\n    applySecondarySort(\r\n      applyFilters(buildDbBase())\r\n        .eq(\"is_boosted\", true)\r\n        .gt(\"boost_expires_at\", nowIso)\r\n        .order(\"boost_expires_at\", { ascending: false, nullsFirst: false })\r\n    )\r\n\r\n  const restBase = () =>\n    applySecondarySort(\n      applyFilters(buildDbBase()).or(`boost_expires_at.is.null,boost_expires_at.lte.${nowIso}`)\n    )\n\n  let data: unknown[] = []\n\n  const toProducts = (rows: unknown[]): Product[] =>\n    (rows || [])\n      .map((raw): Product | null => {\n        if (!raw || typeof raw !== \"object\" || Array.isArray(raw)) return null\n        const p = raw as Record<string, unknown>\n\n        const id = typeof p.id === \"string\" ? p.id : null\n        const title = typeof p.title === \"string\" ? p.title : null\n        const price = typeof p.price === \"number\" ? p.price : null\n        if (!id || !title || price == null) return null\n\n        const list_price = typeof p.list_price === \"number\" ? p.list_price : null\n        const images = Array.isArray(p.images)\n          ? p.images.filter((img): img is string => typeof img === \"string\" && img.length > 0)\n          : []\n\n        const rating = typeof p.rating === \"number\" ? p.rating : null\n        const review_count = typeof p.review_count === \"number\" ? p.review_count : null\n        const category_id = typeof p.category_id === \"string\" ? p.category_id : null\n        const slug = typeof p.slug === \"string\" ? p.slug : null\n\n        const boostExpiresAt = typeof p.boost_expires_at === \"string\" ? p.boost_expires_at : null\n        const isBoostedFlag = typeof p.is_boosted === \"boolean\" ? p.is_boosted : false\n\n        const profilesValue = p.profiles\n        const profiles =\n          profilesValue && typeof profilesValue === \"object\" && !Array.isArray(profilesValue)\n            ? (() => {\n                const pr = profilesValue as Record<string, unknown>\n                return {\n                  id: typeof pr.id === \"string\" ? pr.id : null,\n                  username: typeof pr.username === \"string\" ? pr.username : null,\n                  display_name: typeof pr.display_name === \"string\" ? pr.display_name : null,\n                  business_name: typeof pr.business_name === \"string\" ? pr.business_name : null,\n                  avatar_url: typeof pr.avatar_url === \"string\" ? pr.avatar_url : null,\n                  tier: typeof pr.tier === \"string\" ? pr.tier : null,\n                  account_type: typeof pr.account_type === \"string\" ? pr.account_type : null,\n                  is_verified_business:\n                    typeof pr.is_verified_business === \"boolean\" ? pr.is_verified_business : null,\n                }\n              })()\n            : null\n\n        const categoriesValue = p.categories\n        const categoriesSlug =\n          categoriesValue && typeof categoriesValue === \"object\" && !Array.isArray(categoriesValue)\n            ? (categoriesValue as Record<string, unknown>).slug\n            : null\n        const categories =\n          typeof categoriesSlug === \"string\" && categoriesSlug.length > 0\n            ? { slug: categoriesSlug }\n            : null\n\n        const tags = Array.isArray(p.tags)\n          ? p.tags.filter((t): t is string => typeof t === \"string\" && t.length > 0)\n          : []\n\n        const product: Product = {\n          id,\n          title,\n          price,\n          list_price,\n          images,\n          rating,\n          review_count,\n          category_id,\n          image_url: images[0] ?? null,\n          tags,\n          slug,\n          is_boosted: isBoostActiveNow({ is_boosted: isBoostedFlag, boost_expires_at: boostExpiresAt }),\n          profiles,\n          categories,\n        }\n\n        return product\n      })\n      .filter((p): p is Product => p != null)\n\n  if (promotedOnly) {\n    if (boostedCount <= 0) return { products: [], total: 0 }\n\n    const { data: boostedData } = await boostedBase().range(offset, offset + limit - 1)\n    data = boostedData || []\n\n    return { products: toProducts(data), total: boostedCount }\n  }\n\n  const { count: total } = await applyFilters(buildCountBase())\n\n  if (offset < boostedCount) {\n    const boostedStart = offset\n    const boostedEnd = Math.min(boostedCount - 1, offset + limit - 1)\n    const { data: boostedData } = await boostedBase().range(boostedStart, boostedEnd)\n\r\n    data = boostedData || []\r\n\r\n    const remaining = limit - data.length\r\n    if (remaining > 0) {\r\n      const { data: restData } = await restBase().range(0, remaining - 1)\r\n      data = [...data, ...(restData || [])]\r\n    }\r\n  } else {\r\n    const restOffset = offset - boostedCount\r\n    const { data: restData } = await restBase().range(restOffset, restOffset + limit - 1)\r\n    data = restData || []\r\n  }\r\n\r\n  const products = toProducts(data)\n\n  return { products, total: total ?? 0 }\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\search\\_lib\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\search\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\search\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\search\\page.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 120 to the 25 allowed.","line":52,"column":31,"nodeType":null,"messageId":"refactorFunction","endLine":52,"endColumn":41},{"ruleId":"prefer-const","severity":2,"message":"'brands' is never reassigned. Use 'const' instead.","line":100,"column":7,"nodeType":"Identifier","messageId":"useConst","endLine":100,"endColumn":23,"fix":{"range":[4003,4028],"text":"const brands: string[] = []"}},{"ruleId":"unicorn/no-useless-undefined","severity":1,"message":"Do not use useless `undefined`.","line":102,"column":50,"nodeType":"Identifier","messageId":"no-useless-undefined","endLine":102,"endColumn":59,"fix":{"range":[4130,4142],"text":""}},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":175,"column":45,"nodeType":"CallExpression","messageId":"array-from","endLine":175,"endColumn":100,"fix":{"range":[7416,7471],"text":"[...new Set([...existingValues, ...nextValues])]"}},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":212,"column":43,"nodeType":"CallExpression","messageId":"array-from","endLine":212,"endColumn":98,"fix":{"range":[9212,9267],"text":"[...new Set([...existingValues, ...nextValues])]"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":1,"fixableWarningCount":3,"source":"import { createStaticClient } from \"@/lib/supabase/server\"\r\nimport { SearchFilters } from \"@/components/shared/search/search-filters\"\nimport { SubcategoryTabs } from \"@/components/category/subcategory-tabs\"\nimport { SearchHeader } from \"./_components/search-header\"\nimport { searchProducts } from \"./_lib/search-products\"\nimport type { Category, Product } from \"./_lib/types\"\nimport { DesktopFilters } from \"@/components/shared/filters/desktop-filters\"\nimport { FilterChips } from \"@/components/shared/filters/filter-chips\"\nimport { SortSelect } from \"@/components/shared/search/sort-select\"\nimport { SearchPagination } from \"@/components/shared/search/search-pagination\"\r\nimport { EmptyStateCTA } from \"@/components/shared/empty-state-cta\"\r\nimport { DesktopShell } from \"@/components/layout/desktop-shell.server\"\r\nimport { ProductGrid, type ProductGridProduct } from \"@/components/grid\"\r\nimport { PageShell } from \"@/components/shared/page-shell\"\r\nimport { Suspense } from \"react\"\r\nimport { setRequestLocale, getTranslations } from \"next-intl/server\"\r\nimport { cookies } from \"next/headers\"\r\nimport type { Metadata } from 'next'\r\nimport { getShippingFilter, parseShippingRegion } from '@/lib/shipping'\r\nimport { ITEMS_PER_PAGE } from \"../_lib/pagination\"\nimport { getCategoryContext } from \"@/lib/data/categories\"\nimport type { CategoryAttribute } from \"@/lib/data/categories\"\nimport { normalizeAttributeKey } from \"@/lib/attributes/normalize-attribute-key\"\nimport { MobileFilterControls } from \"@/components/mobile/filters/mobile-filter-controls\"\n\r\nexport async function generateMetadata({ params, searchParams }: {\r\n  params: Promise<{ locale: string }>\r\n  searchParams: Promise<{ q?: string; category?: string }>\r\n}): Promise<Metadata> {\r\n  const { locale } = await params\r\n  setRequestLocale(locale)\r\n  const resolvedSearchParams = await searchParams;\r\n  const query = resolvedSearchParams.q || '';\r\n  const category = resolvedSearchParams.category || '';\r\n\r\n  let title = 'Search Results';\r\n  if (query) {\r\n    title = `\"${query}\" - Search Results`;\r\n  } else if (category) {\r\n    title = `${category.charAt(0).toUpperCase() + category.slice(1)} - Shop`;\r\n  }\r\n\r\n  return {\r\n    title,\r\n    description: query\r\n      ? `Find the best deals on \"${query}\" at Treido. Fast shipping and great prices.`\r\n      : 'Browse our wide selection of products. Find electronics, fashion, home goods and more.',\r\n  };\r\n}\r\n\r\n\r\nexport default async function SearchPage({\r\n  params,\r\n  searchParams: searchParamsPromise,\r\n}: {\r\n  params: Promise<{ locale: string }>\r\n  searchParams: Promise<{\n    q?: string\n    category?: string\n    minPrice?: string\n    maxPrice?: string\n    minRating?: string\n    subcategory?: string\n    tag?: string\n    deals?: string\n    promoted?: string\n    nearby?: string\n    city?: string\n    verified?: string\n    brand?: string\n    availability?: string\n    sort?: string\n    page?: string\n    [key: string]: string | string[] | undefined  // Dynamic attr_* params\n  }>\n}) {\n  const { locale } = await params\r\n  setRequestLocale(locale)\r\n  const searchParams = await searchParamsPromise\r\n  const supabase = createStaticClient()\r\n  const query = searchParams.q || \"\"\r\n  const currentPage = Math.max(1, Number.parseInt(searchParams.page || \"1\", 10))\r\n\r\n  // Read shipping zone from cookie (set by header \"╨ö╨╛╤ü╤é╨░╨▓╨║╨░ ╨┤╨╛\" dropdown)\r\n  // Only filter if user has selected a specific zone (not WW = worldwide = show all)\r\n  const cookieStore = await cookies()\r\n  const userZone = cookieStore.get('user-zone')?.value\r\n  const parsedZone = parseShippingRegion(userZone)\r\n  const shippingFilter = parsedZone !== 'WW'\r\n    ? (getShippingFilter(parsedZone) || undefined)\r\n    : undefined\r\n\r\n  let products: Product[] = []\r\n  let totalProducts = 0\r\n  let currentCategory: Category | null = null\r\n  let parentCategory: Category | null = null\r\n  let subcategories: Category[] = []\r\n  let allCategories: Category[] = []\r\n  let allCategoriesWithSubs: { category: Category; subs: Category[] }[] = []\r\n  let brands: string[] = []\r\n  let filterableAttributes: CategoryAttribute[] = []\r\n  let categoryIdForFilters: string | undefined = undefined\r\n\r\n  if (supabase) {\r\n    // Fetch L0 categories first (with subcategories fetched separately)\r\n    // Order by display_order first (curated), then name (DEC-002 compliance)\r\n    const { data: rootCats, error: rootError } = await supabase\r\n      .from(\"categories\")\r\n      .select(\"id, name, name_bg, slug, parent_id, image_url, display_order\")\r\n      .is(\"parent_id\", null)\r\n      .order(\"display_order\", { ascending: true })\r\n      .order(\"name\", { ascending: true })\r\n\r\n    if (rootError) {\r\n      console.error(\"[SearchPage] Root categories fetch error:\", rootError)\r\n    }\r\n\r\n    if (rootCats && rootCats.length > 0) {\r\n      allCategories = rootCats\r\n\r\n      // Fetch L1 subcategories for all root categories\r\n      // Order by display_order first (curated), then name (DEC-002 compliance)\r\n      const rootIds = rootCats.map(c => c.id)\r\n      const { data: subCats } = await supabase\r\n        .from(\"categories\")\r\n        .select(\"id, name, name_bg, slug, parent_id, image_url, display_order\")\r\n        .in(\"parent_id\", rootIds)\r\n        .order(\"display_order\", { ascending: true })\r\n        .order(\"name\", { ascending: true })\r\n\r\n      // Build the hierarchical structure for the sidebar\r\n      allCategoriesWithSubs = rootCats.map(cat => ({\r\n        category: cat,\r\n        subs: (subCats || []).filter(c => c.parent_id === cat.id)\r\n      }))\r\n\r\n      // Also store subCats for category lookup\r\n      const allCats = [...rootCats, ...(subCats || [])]\r\n\r\n      // If a category is specified, get its details and subcategories\r\n      if (searchParams.category) {\r\n        // Find the category from our already fetched data\r\n        const categoryData = allCats.find(c => c.slug === searchParams.category) || null\r\n\r\n        if (categoryData) {\r\n          currentCategory = categoryData\r\n          categoryIdForFilters = categoryData.id\r\n\r\n          // Check if this is a subcategory (has parent_id)\r\n          if (categoryData.parent_id) {\r\n            parentCategory = allCats.find(c => c.id === categoryData.parent_id) || null\r\n            // No subcategories for a subcategory\r\n            subcategories = []\r\n          } else {\r\n            // This is a main category - get its subcategories\r\n            subcategories = allCats.filter(c => c.parent_id === categoryData.id)\r\n          }\r\n\r\n          // Build product query with category filter\r\n          // Get products from this category AND all its subcategories\r\n          const categoryIds = [categoryData.id, ...subcategories.map(s => s.id)]\r\n\r\n          // Extract attr_* params for attribute filtering\r\n          const attributeFilters: Record<string, string | string[]> = {}\r\n          for (const [key, value] of Object.entries(searchParams)) {\r\n            if (key.startsWith('attr_') && value) {\r\n              const rawName = key.replace('attr_', '')\r\n              const attrKey = normalizeAttributeKey(rawName) || rawName\r\n              const nextValues = Array.isArray(value) ? value : [value]\r\n              const existing = attributeFilters[attrKey]\r\n              if (!existing) {\r\n                attributeFilters[attrKey] = nextValues\r\n              } else {\r\n                const existingValues = Array.isArray(existing) ? existing : [existing]\r\n                attributeFilters[attrKey] = Array.from(new Set([...existingValues, ...nextValues]))\r\n              }\r\n            }\r\n          }\r\n\r\n          // Use the helper function with pagination and shipping filter\r\n          const result = await searchProducts(supabase, query, categoryIds, {\n            minPrice: searchParams.minPrice,\n            maxPrice: searchParams.maxPrice,\n            tag: searchParams.tag,\n            minRating: searchParams.minRating,\n            deals: searchParams.deals,\n            promoted: searchParams.promoted,\n            nearby: searchParams.nearby,\n            city: searchParams.city,\n            verified: searchParams.verified,\n            availability: searchParams.availability,\n            sort: searchParams.sort,\n            attributes: Object.keys(attributeFilters).length > 0 ? attributeFilters : undefined,\n          }, currentPage, ITEMS_PER_PAGE, shippingFilter)\n          products = result.products\r\n          totalProducts = result.total\r\n        }\r\n      } else {\r\n        // No category filter - get all products filtered by shipping zone\r\n        // Extract attr_* params for attribute filtering\r\n        const attributeFilters: Record<string, string | string[]> = {}\r\n        for (const [key, value] of Object.entries(searchParams)) {\r\n          if (key.startsWith('attr_') && value) {\r\n            const rawName = key.replace('attr_', '')\r\n            const attrKey = normalizeAttributeKey(rawName) || rawName\r\n            const nextValues = Array.isArray(value) ? value : [value]\r\n            const existing = attributeFilters[attrKey]\r\n            if (!existing) {\r\n              attributeFilters[attrKey] = nextValues\r\n            } else {\r\n              const existingValues = Array.isArray(existing) ? existing : [existing]\r\n              attributeFilters[attrKey] = Array.from(new Set([...existingValues, ...nextValues]))\r\n            }\r\n          }\r\n        }\r\n\r\n        const result = await searchProducts(supabase, query, null, {\n          minPrice: searchParams.minPrice,\n          maxPrice: searchParams.maxPrice,\n          tag: searchParams.tag,\n          minRating: searchParams.minRating,\n          deals: searchParams.deals,\n          promoted: searchParams.promoted,\n          nearby: searchParams.nearby,\n          city: searchParams.city,\n          verified: searchParams.verified,\n          availability: searchParams.availability,\n          sort: searchParams.sort,\n          attributes: Object.keys(attributeFilters).length > 0 ? attributeFilters : undefined,\n        }, currentPage, ITEMS_PER_PAGE, shippingFilter)\n        products = result.products\r\n        totalProducts = result.total\r\n      }\r\n    }\r\n\r\n    // Extract unique brands from products for the filter\r\n    // This would ideally come from a brands table, but for now we can extract from products\r\n    // brands = [...new Set(products.map(p => p.brand).filter(Boolean))]\r\n  }\r\n\r\n  // For mobile quick filters, fetch filterable attributes for the active category (if any)\r\n  if (searchParams.category) {\r\n    const ctx = await getCategoryContext(searchParams.category)\r\n    if (ctx) {\r\n      filterableAttributes = ctx.attributes\r\n      categoryIdForFilters = ctx.current.id\r\n    }\r\n  }\r\n\r\n  // Get translations for search page UI\r\n  const t = await getTranslations('SearchFilters')\r\n\r\n  // Transform products for ProductGrid\r\n  const gridProducts: ProductGridProduct[] = products.map((product) => ({\r\n    id: product.id,\r\n    title: product.title,\r\n    price: product.price,\r\n    image: product.image_url || product.images?.[0] || \"/placeholder.svg\",\r\n    listPrice: product.list_price ?? undefined,\r\n    rating: product.rating ?? 0,\r\n    reviews: product.review_count ?? 0,\r\n    slug: product.slug ?? null,\r\n    storeSlug: product.profiles?.username ?? null,\r\n    sellerId: product.profiles?.id ?? null,\r\n    sellerName: product.profiles?.display_name || product.profiles?.business_name || product.profiles?.username || undefined,\r\n    sellerAvatarUrl: product.profiles?.avatar_url ?? null,\r\n    sellerVerified: Boolean(product.profiles?.is_verified_business),\r\n    condition: product.attributes?.condition,\r\n    tags: product.tags ?? [],\r\n  }))\r\n\r\n  const categoryName = currentCategory\r\n    ? (locale === \"bg\" && currentCategory.name_bg)\r\n      ? currentCategory.name_bg\r\n      : currentCategory.name\r\n    : undefined\r\n\r\n  // Sidebar content for desktop\r\n  const sidebarContent = (\r\n    <div className=\"bg-sidebar rounded-lg p-4\">\r\n      <Suspense>\r\n        <SearchFilters\r\n          categories={allCategories}\r\n          subcategories={subcategories}\r\n          currentCategory={currentCategory}\r\n          allCategoriesWithSubs={allCategoriesWithSubs}\r\n          brands={brands}\r\n        />\r\n      </Suspense>\r\n    </div>\r\n  )\r\n\r\n  return (\r\n    <>\r\n      {/* Mobile Layout */}\n      <PageShell variant=\"muted\" className=\"lg:hidden overflow-x-hidden\">\n        <div className=\"container overflow-x-hidden py-4\">\n          {/* Show SubcategoryTabs when in a category, SearchHeader otherwise */}\r\n          {currentCategory ? (\r\n            <Suspense>\r\n              <SubcategoryTabs\r\n                currentCategory={currentCategory}\r\n                subcategories={subcategories}\r\n                parentCategory={parentCategory}\r\n              />\r\n            </Suspense>\r\n          ) : (\r\n            <Suspense>\r\n              <SearchHeader\r\n                query={query}\r\n                category={searchParams.category}\r\n                totalResults={products.length}\r\n              />\r\n            </Suspense>\r\n          )}\r\n\r\n          {/* Mobile Filter Controls */}\n          <Suspense>\n            <MobileFilterControls\n              locale={locale}\n              {...(currentCategory?.slug ? { categorySlug: currentCategory.slug } : {})}\n              {...(categoryIdForFilters ? { categoryId: categoryIdForFilters } : {})}\n              {...(query ? { searchQuery: query } : {})}\n              attributes={filterableAttributes}\n              subcategories={subcategories.map((c) => ({\n                id: c.id,\n                name: c.name,\n                name_bg: c.name_bg,\n                slug: c.slug,\n              }))}\n              {...(categoryName ? { categoryName } : {})}\n              {...(currentCategory\n                ? {\n                    currentCategory: {\n                      name: categoryName ?? currentCategory.name,\n                      slug: currentCategory.slug,\n                    },\n                  }\n                : {})}\n              basePath=\"/search\"\n              stickyTop=\"var(--app-header-offset)\"\n              sticky={true}\n              userZone={userZone ?? null}\n              className=\"mb-3\"\n            />\n          </Suspense>\n\r\n          {/* Mobile Results Info Strip */}\r\n          <div className=\"sm:hidden mb-4 flex items-center justify-between text-sm text-muted-foreground bg-surface-subtle rounded-lg px-3 py-2.5\">\r\n            <span>\r\n              <span className=\"font-semibold text-foreground\">{totalProducts}</span> {totalProducts === 1 ? t('product') : t('products')}\r\n            </span>\r\n            {currentCategory && (\r\n              <span className=\"text-xs bg-selected text-primary px-2 py-0.5 rounded-full font-medium\">\r\n                {categoryName}\r\n              </span>\r\n            )}\r\n          </div>\r\n\r\n          {/* Mobile Product Grid */}\r\n          <ProductGrid\n            products={gridProducts}\n            viewMode=\"grid\"\n            cardAppearance=\"tile\"\n            cardMedia=\"landscape\"\n            cardDensity=\"compact\"\n            cardUiVariant=\"mobile-clean\"\n          />\n\r\n          {products.length === 0 && (\r\n            <EmptyStateCTA\r\n              variant={query ? \"no-search\" : \"no-category\"}\r\n              {...(query ? { searchQuery: query } : {})}\r\n              {...(categoryName ? { categoryName } : {})}\r\n              className=\"mt-8\"\r\n            />\r\n          )}\r\n\r\n          {/* Pagination */}\r\n          {products.length > 0 && (\r\n            <Suspense>\r\n              <SearchPagination\r\n                totalItems={totalProducts}\r\n                itemsPerPage={ITEMS_PER_PAGE}\r\n                currentPage={currentPage}\r\n              />\r\n            </Suspense>\r\n          )}\r\n        </div>\r\n      </PageShell>\r\n\r\n      {/* Desktop Layout with DesktopShell */}\r\n      <DesktopShell\r\n        variant=\"muted\"\r\n        className=\"hidden lg:block\"\r\n        sidebar={sidebarContent}\r\n        sidebarSticky\r\n      >\r\n        {/* Show SubcategoryTabs when in a category, SearchHeader otherwise */}\r\n        {currentCategory ? (\r\n          <Suspense>\r\n            <SubcategoryTabs\r\n              currentCategory={currentCategory}\r\n              subcategories={subcategories}\r\n              parentCategory={parentCategory}\r\n            />\r\n          </Suspense>\r\n        ) : (\r\n          <Suspense>\r\n            <SearchHeader\r\n              query={query}\r\n              category={searchParams.category}\r\n              totalResults={products.length}\r\n            />\r\n          </Suspense>\r\n        )}\r\n\r\n        {/* Active Filter Pills */}\r\n        <div className=\"mb-4\">\r\n          <Suspense>\r\n            <FilterChips currentCategory={currentCategory} />\r\n          </Suspense>\r\n        </div>\r\n\r\n        {/* Desktop Filter & Sort Row */}\r\n        <div className=\"flex mb-4 items-center gap-2\">\r\n          <div className=\"max-w-44\">\r\n            <SortSelect />\r\n          </div>\r\n          <div className=\"flex items-center gap-2\">\r\n            <Suspense>\r\n              <DesktopFilters />\r\n            </Suspense>\r\n          </div>\r\n          <p className=\"text-sm text-muted-foreground ml-auto whitespace-nowrap\">\r\n            <span className=\"font-semibold text-foreground\">{totalProducts}</span>\r\n            <span> {t('results')}</span>\r\n            {query && (\r\n              <span>\r\n                {\" \"}{t('for')} <span className=\"font-medium text-primary\">&quot;{query}&quot;</span>\r\n              </span>\r\n            )}\r\n            {currentCategory && !query && (\r\n              <span> {t('in')} <span className=\"font-medium\">{categoryName}</span></span>\r\n            )}\r\n          </p>\r\n        </div>\r\n\r\n        {/* Product Grid with container queries */}\r\n        <div>\r\n          {products.length === 0 ? (\r\n            <EmptyStateCTA\r\n              variant={query ? \"no-search\" : \"no-category\"}\r\n              {...(query ? { searchQuery: query } : {})}\r\n              {...(categoryName ? { categoryName } : {})}\r\n              className=\"mt-4\"\r\n            />\r\n          ) : (\r\n            <ProductGrid products={gridProducts} viewMode=\"grid\" />\r\n          )}\r\n        </div>\r\n\r\n        {/* Pagination */}\r\n        {products.length > 0 && (\r\n          <Suspense>\r\n            <SearchPagination\r\n              totalItems={totalProducts}\r\n              itemsPerPage={ITEMS_PER_PAGE}\r\n              currentPage={currentPage}\r\n            />\r\n          </Suspense>\r\n        )}\r\n      </DesktopShell>\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\seller\\dashboard\\_components\\seller-dashboard-loading-skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\seller\\dashboard\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\seller\\dashboard\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\seller\\dashboard\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\seller\\settings\\payouts\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\sellers\\_components\\sellers-directory-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\sellers\\_components\\sellers-empty-state.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\sellers\\_components\\sellers-loading-skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\sellers\\_components\\top-sellers-hero.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\sellers\\_lib\\get-top-sellers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\sellers\\_lib\\top-sellers-types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\sellers\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\sellers\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\todays-deals\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\todays-deals\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\todays-deals\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\wishlist\\[token]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\wishlist\\_components\\wishlist-page-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\wishlist\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\wishlist\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\wishlist\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\wishlist\\shared\\[token]\\add-all-to-cart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(main)\\wishlist\\shared\\[token]\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(onboarding)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(onboarding)\\onboarding\\_components\\account-type-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(onboarding)\\onboarding\\_components\\interest-chip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(onboarding)\\onboarding\\_components\\onboarding-shell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(onboarding)\\onboarding\\account-type\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(onboarding)\\onboarding\\business-profile\\page.tsx","messages":[{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":21,"column":6,"nodeType":"Identifier","messageId":"method","endLine":21,"endColumn":13,"fix":{"range":[880,880],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":22,"column":6,"nodeType":"Identifier","messageId":"method","endLine":22,"endColumn":13,"fix":{"range":[916,916],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":23,"column":6,"nodeType":"Identifier","messageId":"method","endLine":23,"endColumn":13,"fix":{"range":[943,943],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":24,"column":6,"nodeType":"Identifier","messageId":"method","endLine":24,"endColumn":13,"fix":{"range":[969,969],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":25,"column":6,"nodeType":"Identifier","messageId":"method","endLine":25,"endColumn":13,"fix":{"range":[995,995],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":97,"column":37,"nodeType":"Identifier","messageId":"method","endLine":97,"endColumn":44,"fix":{"range":[3331,3331],"text":"All"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":6,"source":"\"use client\"\r\n\r\nimport { useEffect, useState, useTransition } from \"react\"\r\nimport { useRouter } from \"next/navigation\"\r\nimport { useLocale, useTranslations } from \"next-intl\"\r\nimport { ArrowRight, Camera, SpinnerGap, Check, X, Globe, MapPin } from \"@phosphor-icons/react\"\r\nimport Image from \"next/image\"\r\nimport Avatar from \"boring-avatars\"\r\n\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { OnboardingShell } from \"../_components/onboarding-shell\"\nimport { type AvatarVariant, getColorPalette } from \"@/lib/avatar-palettes\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\n\r\nfunction slugify(text: string): string {\r\n  return text\r\n    .toLowerCase()\r\n    .replace(/[^a-z0-9\\s_-]/g, \"\")\r\n    .replace(/\\s+/g, \"_\")\r\n    .replace(/-+/g, \"_\")\r\n    .replace(/_+/g, \"_\")\r\n    .replace(/^_|_$/g, \"\")\r\n    .slice(0, 30)\r\n}\r\n\r\nexport default function BusinessProfilePage() {\r\n  const router = useRouter()\r\n  const locale = useLocale()\r\n  const t = useTranslations(\"Onboarding\")\r\n\r\n  const [isPending, startTransition] = useTransition()\r\n\r\n  const [businessName, setBusinessName] = useState(\"\")\r\n  const [username, setUsername] = useState(\"\")\r\n  const [usernameManuallyEdited, setUsernameManuallyEdited] = useState(false)\r\n  const [category, setCategory] = useState(\"\")\r\n  const [website, setWebsite] = useState(\"\")\r\n  const [location, setLocation] = useState(\"\")\r\n  const [isCheckingUsername, setIsCheckingUsername] = useState(false)\r\n  const [usernameAvailable, setUsernameAvailable] = useState<boolean | null>(null)\r\n\r\n  const [logoPreview, setLogoPreview] = useState<string | null>(null)\r\n  const [avatarVariant] = useState<AvatarVariant>(\"bauhaus\")\r\n  const [avatarPalette] = useState(2)\r\n\r\n  useEffect(() => {\r\n    if (!usernameManuallyEdited && businessName) {\r\n      const suggested = slugify(businessName)\r\n      if (suggested) setUsername(suggested)\r\n    }\r\n  }, [businessName, usernameManuallyEdited])\r\n\r\n  useEffect(() => {\r\n    let cancelled = false\r\n\r\n    const timeoutId = setTimeout(async () => {\r\n      const cleaned = username.trim().toLowerCase()\r\n      if (!cleaned || cleaned.length < 3) {\r\n        if (!cancelled) setUsernameAvailable(null)\r\n        return\r\n      }\r\n\r\n      if (!cancelled) setIsCheckingUsername(true)\r\n      try {\r\n        const supabase = createClient()\r\n        const { data } = await supabase\r\n          .from(\"profiles\")\r\n          .select(\"id\")\r\n          .ilike(\"username\", cleaned)\r\n          .maybeSingle()\r\n\r\n        if (!cancelled) setUsernameAvailable(!data)\r\n      } finally {\r\n        if (!cancelled) setIsCheckingUsername(false)\r\n      }\r\n    }, 500)\r\n\r\n    return () => {\r\n      cancelled = true\r\n      clearTimeout(timeoutId)\r\n    }\r\n  }, [username])\r\n\r\n  const handleLogoChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0]\r\n    if (!file) return\r\n    const reader = new FileReader()\r\n    reader.onloadend = () => setLogoPreview(reader.result as string)\r\n    reader.readAsDataURL(file)\r\n  }\r\n\r\n  const handleUsernameChange = (value: string) => {\r\n    setUsernameManuallyEdited(true)\r\n    setUsername(value.toLowerCase().replace(/[^a-z0-9_]/g, \"\"))\r\n  }\r\n\r\n  const handleContinue = () => {\r\n    try {\r\n      sessionStorage.setItem(\r\n        \"onboarding_profile\",\r\n        JSON.stringify({\r\n          businessName: businessName.trim(),\r\n          username: username.trim().toLowerCase(),\r\n          category,\r\n          website: website.trim(),\r\n          location: location.trim(),\r\n          accountType: \"business\",\r\n          avatarType: logoPreview ? \"custom\" : \"generated\",\r\n          avatarVariant: !logoPreview ? avatarVariant : undefined,\r\n          avatarPalette: !logoPreview ? avatarPalette : undefined,\r\n        }),\r\n      )\r\n    } catch {\r\n      // Ignore storage access errors\r\n    }\r\n\r\n    startTransition(() => {\r\n      router.push(`/${locale}/onboarding/interests?type=business`)\r\n    })\r\n  }\r\n\r\n  const handleBack = () => {\r\n    router.push(`/${locale}/onboarding/account-type`)\r\n  }\r\n\r\n  const canContinue =\r\n    businessName.trim().length > 0 &&\r\n    username.trim().length >= 3 &&\r\n    usernameAvailable === true &&\r\n    category.length > 0\r\n\r\n  const usernameIndicator = (() => {\r\n    if (!username || username.trim().length < 3) return null\r\n\r\n    if (isCheckingUsername) {\r\n      return (\r\n        <span className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\r\n          <SpinnerGap className=\"size-4 animate-spin\" />\r\n          {t(\"businessProfile.checking\")}\r\n        </span>\r\n      )\r\n    }\r\n\r\n    if (usernameAvailable === true) {\r\n      return (\r\n        <span className=\"flex items-center gap-1.5 text-xs text-success\">\r\n          <Check className=\"size-4\" weight=\"bold\" />\r\n          {t(\"businessProfile.available\")}\r\n        </span>\r\n      )\r\n    }\r\n\r\n    if (usernameAvailable === false) {\r\n      return (\r\n        <span className=\"flex items-center gap-1.5 text-xs text-destructive\">\r\n          <X className=\"size-4\" />\r\n          {t(\"businessProfile.unavailable\")}\r\n        </span>\r\n      )\r\n    }\r\n\r\n    return null\r\n  })()\r\n\r\n  return (\r\n    <OnboardingShell\r\n      title={t(\"businessProfile.title\")}\r\n      subtitle={t(\"businessProfile.subtitle\")}\r\n      stepLabel={t(\"common.stepLabel\", { current: 2, total: 5 })}\r\n      progress={40}\r\n      onBack={handleBack}\r\n      backLabel={t(\"common.back\")}\r\n      footer={\r\n        <Button onClick={handleContinue} disabled={!canContinue || isPending} size=\"lg\" className=\"w-full\">\r\n          {isPending ? (\r\n            <>\r\n              <SpinnerGap className=\"size-5 animate-spin\" />\r\n              {t(\"common.processing\")}\r\n            </>\r\n          ) : (\r\n            <>\r\n              {t(\"common.continue\")}\r\n              <ArrowRight className=\"size-5\" weight=\"bold\" />\r\n            </>\r\n          )}\r\n        </Button>\r\n      }\r\n    >\r\n      <div className=\"space-y-6\">\r\n        <div>\r\n          <Label className=\"text-sm font-semibold mb-2 block text-foreground\">{t(\"businessProfile.logoLabel\")}</Label>\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"relative\">\r\n              <div className=\"size-16 rounded-xl overflow-hidden border-2 border-selected-border shadow-sm\">\r\n                {logoPreview ? (\r\n                  <Image\r\n                    src={logoPreview}\r\n                    alt={t(\"businessProfile.logoLabel\")}\r\n                    width={64}\r\n                    height={64}\r\n                    className=\"object-cover w-full h-full\"\r\n                  />\r\n                ) : (\r\n                  <Avatar\r\n                    size={64}\r\n                    name={businessName || \"business\"}\r\n                    variant={avatarVariant}\r\n                    colors={getColorPalette(avatarPalette)}\r\n                    square\r\n                  />\r\n                )}\r\n              </div>\r\n              <label className=\"absolute -bottom-1 -right-1 size-7 bg-primary text-primary-foreground rounded-full flex items-center justify-center cursor-pointer hover:bg-interactive-hover transition-colors shadow-sm\">\r\n                <Camera className=\"size-3.5\" weight=\"bold\" />\r\n                <input type=\"file\" accept=\"image/*\" className=\"hidden\" onChange={handleLogoChange} />\r\n              </label>\r\n            </div>\r\n            <p className=\"text-xs text-muted-foreground flex-1\">{t(\"businessProfile.logoHint\")}</p>\r\n          </div>\r\n        </div>\r\n\r\n        <div>\r\n          <Label htmlFor=\"businessName\" className=\"text-sm font-semibold text-foreground\">\r\n            {t(\"businessProfile.businessNameLabel\")}\r\n          </Label>\r\n          <Input\r\n            id=\"businessName\"\r\n            value={businessName}\r\n            onChange={(e) => setBusinessName(e.target.value)}\r\n            placeholder={t(\"businessProfile.businessNamePlaceholder\")}\r\n            className=\"mt-2\"\r\n            maxLength={100}\r\n          />\r\n          <p className=\"text-xs text-muted-foreground mt-1.5\">{t(\"businessProfile.businessNameHint\")}</p>\r\n        </div>\r\n\r\n        <div>\r\n          <Label htmlFor=\"username\" className=\"text-sm font-semibold text-foreground\">\r\n            {t(\"businessProfile.usernameLabel\")}\r\n          </Label>\r\n          <div className=\"relative mt-2\">\r\n            <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\">@</span>\r\n            <Input\r\n              id=\"username\"\r\n              value={username}\r\n              onChange={(e) => handleUsernameChange(e.target.value)}\r\n              placeholder={t(\"businessProfile.usernamePlaceholder\")}\r\n              className=\"pl-8\"\r\n              maxLength={30}\r\n            />\r\n          </div>\r\n          <div className=\"flex justify-between items-center gap-3 mt-1.5\">\r\n            <p className=\"text-xs text-muted-foreground\">{t(\"businessProfile.usernameHint\")}</p>\r\n            {usernameIndicator}\r\n          </div>\r\n        </div>\r\n\r\n        <div>\r\n          <Label htmlFor=\"category\" className=\"text-sm font-semibold text-foreground\">\r\n            {t(\"businessProfile.categoryLabel\")}\r\n          </Label>\r\n          <Select value={category} onValueChange={setCategory}>\r\n            <SelectTrigger className=\"mt-2\">\r\n              <SelectValue placeholder={t(\"businessProfile.categoryPlaceholder\")} />\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              {Object.entries(\r\n                t.raw(\"businessProfile.categories\") as Record<string, string>,\r\n              ).map(([key, label]) => (\r\n                <SelectItem key={key} value={key}>\r\n                  {label}\r\n                </SelectItem>\r\n              ))}\r\n            </SelectContent>\r\n          </Select>\r\n        </div>\r\n\r\n        <div>\r\n          <Label htmlFor=\"website\" className=\"text-sm font-semibold text-foreground\">\r\n            {t(\"businessProfile.websiteLabel\")}\r\n          </Label>\r\n          <div className=\"mt-2 flex items-center border rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-ring\">\r\n            <div className=\"px-3 flex items-center bg-secondary border-r h-11\">\r\n              <Globe className=\"size-4 text-muted-foreground\" weight=\"duotone\" />\r\n            </div>\r\n            <input\r\n              id=\"website\"\r\n              type=\"url\"\r\n              value={website}\r\n              onChange={(e) => setWebsite(e.target.value)}\r\n              placeholder={t(\"businessProfile.websitePlaceholder\")}\r\n              className=\"flex-1 h-11 px-3 text-sm bg-background focus:outline-none\"\r\n            />\r\n          </div>\r\n        </div>\r\n\r\n        <div>\r\n          <Label htmlFor=\"location\" className=\"text-sm font-semibold text-foreground\">\r\n            {t(\"businessProfile.locationLabel\")}\r\n          </Label>\r\n          <div className=\"mt-2 flex items-center border rounded-lg overflow-hidden focus-within:ring-2 focus-within:ring-ring\">\r\n            <div className=\"px-3 flex items-center bg-secondary border-r h-11\">\r\n              <MapPin className=\"size-4 text-muted-foreground\" weight=\"duotone\" />\r\n            </div>\r\n            <input\r\n              id=\"location\"\r\n              type=\"text\"\r\n              value={location}\r\n              onChange={(e) => setLocation(e.target.value)}\r\n              placeholder={t(\"businessProfile.locationPlaceholder\")}\r\n              className=\"flex-1 h-11 px-3 text-sm bg-background focus:outline-none\"\r\n            />\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </OnboardingShell>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(onboarding)\\onboarding\\complete\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(onboarding)\\onboarding\\interests\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(onboarding)\\onboarding\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(onboarding)\\onboarding\\profile\\page.tsx","messages":[{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":248,"column":73,"nodeType":"Identifier","messageId":"method","endLine":248,"endColumn":80,"fix":{"range":[8647,8647],"text":"All"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\"\r\n\r\nimport { useEffect, useState, useTransition } from \"react\"\r\nimport { useRouter, useSearchParams } from \"next/navigation\"\r\nimport { useLocale, useTranslations } from \"next-intl\"\r\nimport { ArrowRight, Camera, SpinnerGap, Check, X } from \"@phosphor-icons/react\"\r\nimport Image from \"next/image\"\r\nimport Avatar from \"boring-avatars\"\r\n\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { OnboardingShell } from \"../_components/onboarding-shell\"\nimport { cn } from \"@/lib/utils\"\r\nimport { AVATAR_VARIANTS, type AvatarVariant, getColorPalette } from \"@/lib/avatar-palettes\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\n\r\nexport default function ProfilePage() {\r\n  const router = useRouter()\r\n  const searchParams = useSearchParams()\r\n  const locale = useLocale()\r\n  const t = useTranslations(\"Onboarding\")\r\n\r\n  const accountType = searchParams.get(\"type\") || \"personal\"\r\n  const [isPending, startTransition] = useTransition()\r\n\r\n  useEffect(() => {\r\n    if (accountType === \"business\") {\r\n      router.replace(`/${locale}/onboarding/business-profile`)\r\n    }\r\n  }, [accountType, locale, router])\r\n\r\n  const [username, setUsername] = useState(\"\")\r\n  const [displayName, setDisplayName] = useState(\"\")\r\n  const [isCheckingUsername, setIsCheckingUsername] = useState(false)\r\n  const [usernameAvailable, setUsernameAvailable] = useState<boolean | null>(null)\r\n\r\n  const [avatarVariant, setAvatarVariant] = useState<AvatarVariant>(\"beam\")\r\n  const [avatarPalette] = useState(0)\r\n  const [avatarPreview, setAvatarPreview] = useState<string | null>(null)\r\n  const [useCustomAvatar, setUseCustomAvatar] = useState(false)\r\n\r\n  useEffect(() => {\r\n    let cancelled = false\r\n\r\n    const timeoutId = setTimeout(async () => {\r\n      const cleaned = username.trim().toLowerCase()\r\n      if (!cleaned || cleaned.length < 3) {\r\n        if (!cancelled) setUsernameAvailable(null)\r\n        return\r\n      }\r\n\r\n      if (!cancelled) setIsCheckingUsername(true)\r\n      try {\r\n        const supabase = createClient()\r\n        const { data } = await supabase\r\n          .from(\"profiles\")\r\n          .select(\"id\")\r\n          .ilike(\"username\", cleaned)\r\n          .maybeSingle()\r\n\r\n        if (!cancelled) setUsernameAvailable(!data)\r\n      } finally {\r\n        if (!cancelled) setIsCheckingUsername(false)\r\n      }\r\n    }, 500)\r\n\r\n    return () => {\r\n      cancelled = true\r\n      clearTimeout(timeoutId)\r\n    }\r\n  }, [username])\r\n\r\n  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0]\r\n    if (!file) return\r\n    const reader = new FileReader()\r\n    reader.onloadend = () => setAvatarPreview(reader.result as string)\r\n    reader.readAsDataURL(file)\r\n    setUseCustomAvatar(true)\r\n  }\r\n\r\n  const handleContinue = () => {\r\n    try {\r\n      sessionStorage.setItem(\r\n        \"onboarding_profile\",\r\n        JSON.stringify({\r\n          username: username.trim().toLowerCase(),\r\n          displayName: displayName.trim(),\r\n          accountType,\r\n          avatarType: useCustomAvatar ? \"custom\" : \"generated\",\r\n          avatarVariant: !useCustomAvatar ? avatarVariant : undefined,\r\n          avatarPalette: !useCustomAvatar ? avatarPalette : undefined,\r\n        }),\r\n      )\r\n    } catch {\r\n      // Ignore storage access errors\r\n    }\r\n\r\n    startTransition(() => {\r\n      router.push(`/${locale}/onboarding/interests?type=${accountType}`)\r\n    })\r\n  }\r\n\r\n  const handleBack = () => {\r\n    router.push(`/${locale}/onboarding/account-type`)\r\n  }\r\n\r\n  const canContinue = username.trim().length >= 3 && usernameAvailable === true\r\n\r\n  const usernameIndicator = (() => {\r\n    if (!username || username.trim().length < 3) return null\r\n\r\n    if (isCheckingUsername) {\r\n      return (\r\n        <span className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\r\n          <SpinnerGap className=\"size-4 animate-spin\" />\r\n          {t(\"profile.checking\")}\r\n        </span>\r\n      )\r\n    }\r\n\r\n    if (usernameAvailable === true) {\r\n      return (\r\n        <span className=\"flex items-center gap-1.5 text-xs text-success\">\r\n          <Check className=\"size-4\" weight=\"bold\" />\r\n          {t(\"profile.available\")}\r\n        </span>\r\n      )\r\n    }\r\n\r\n    if (usernameAvailable === false) {\r\n      return (\r\n        <span className=\"flex items-center gap-1.5 text-xs text-destructive\">\r\n          <X className=\"size-4\" />\r\n          {t(\"profile.unavailable\")}\r\n        </span>\r\n      )\r\n    }\r\n\r\n    return null\r\n  })()\r\n\r\n  return (\r\n    <OnboardingShell\r\n      title={t(\"profile.title\")}\r\n      subtitle={t(\"profile.subtitle\")}\r\n      stepLabel={t(\"common.stepLabel\", { current: 2, total: 4 })}\r\n      progress={50}\r\n      onBack={handleBack}\r\n      backLabel={t(\"common.back\")}\r\n      footer={\r\n        <Button\r\n          onClick={handleContinue}\r\n          disabled={!canContinue || isPending}\r\n          size=\"lg\"\r\n          className=\"w-full\"\r\n        >\r\n          {isPending ? (\r\n            <>\r\n              <SpinnerGap className=\"size-5 animate-spin\" />\r\n              {t(\"common.processing\")}\r\n            </>\r\n          ) : (\r\n            <>\r\n              {t(\"common.continue\")}\r\n              <ArrowRight className=\"size-5\" weight=\"bold\" />\r\n            </>\r\n          )}\r\n        </Button>\r\n      }\r\n    >\r\n      <div className=\"space-y-6\">\r\n        <div>\r\n          <Label className=\"text-sm font-semibold mb-2 block text-foreground\">\r\n            {t(\"profile.profileImageLabel\")}\r\n          </Label>\r\n          <div className=\"flex items-center gap-4\">\r\n            <div className=\"relative\">\r\n              <div className=\"size-16 rounded-xl overflow-hidden border-2 border-selected-border shadow-sm\">\r\n                {useCustomAvatar && avatarPreview ? (\r\n                  <Image\r\n                    src={avatarPreview}\r\n                    alt={t(\"profile.profileImageLabel\")}\r\n                    width={64}\r\n                    height={64}\r\n                    className=\"object-cover w-full h-full\"\r\n                  />\r\n                ) : (\r\n                  <Avatar\r\n                    size={64}\r\n                    name={username || \"user\"}\r\n                    variant={avatarVariant}\r\n                    colors={getColorPalette(avatarPalette)}\r\n                    square\r\n                  />\r\n                )}\r\n              </div>\r\n              <label className=\"absolute -bottom-1 -right-1 size-7 bg-primary text-primary-foreground rounded-full flex items-center justify-center cursor-pointer hover:bg-interactive-hover transition-colors shadow-sm\">\r\n                <Camera className=\"size-3.5\" weight=\"bold\" />\r\n                <input type=\"file\" accept=\"image/*\" className=\"hidden\" onChange={handleAvatarChange} />\r\n              </label>\r\n            </div>\r\n\r\n            <div className=\"flex-1\">\r\n              <div className=\"flex gap-1.5 mb-2\">\r\n                {AVATAR_VARIANTS.slice(0, 4).map((variant) => (\r\n                  <button\r\n                    key={variant}\r\n                    type=\"button\"\r\n                    onClick={() => {\r\n                      setAvatarVariant(variant)\r\n                      setUseCustomAvatar(false)\r\n                    }}\r\n                    className={cn(\r\n                      \"size-11 rounded-lg border-2 overflow-hidden transition-all\",\r\n                      !useCustomAvatar && avatarVariant === variant\r\n                        ? \"border-primary shadow-sm ring-2 ring-focus-ring\"\r\n                        : \"border-input hover:border-hover-border\",\r\n                    )}\r\n                  >\r\n                    <Avatar\r\n                      size={44}\r\n                      name={username || \"user\"}\r\n                      variant={variant}\r\n                      colors={getColorPalette(avatarPalette)}\r\n                      square\r\n                    />\r\n                  </button>\r\n                ))}\r\n              </div>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                {t(\"profile.profileImageHint\")}\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        <div>\r\n          <Label htmlFor=\"username\" className=\"text-sm font-semibold text-foreground\">\r\n            {t(\"profile.usernameLabel\")}\r\n          </Label>\r\n          <div className=\"relative mt-2\">\r\n            <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\">@</span>\r\n            <Input\r\n              id=\"username\"\r\n              value={username}\r\n              onChange={(e) => setUsername(e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, \"\"))}\r\n              placeholder={t(\"profile.usernamePlaceholder\")}\r\n              className=\"pl-8\"\r\n              maxLength={30}\r\n            />\r\n          </div>\r\n          <div className=\"flex justify-between items-center gap-3 mt-1.5\">\r\n            <p className=\"text-xs text-muted-foreground\">{t(\"profile.usernameHint\")}</p>\r\n            {usernameIndicator}\r\n          </div>\r\n        </div>\r\n\r\n        <div>\r\n          <Label htmlFor=\"displayName\" className=\"text-sm font-semibold text-foreground\">\r\n            {t(\"profile.displayNameLabel\")}\r\n          </Label>\r\n          <Input\r\n            id=\"displayName\"\r\n            value={displayName}\r\n            onChange={(e) => setDisplayName(e.target.value)}\r\n            placeholder={t(\"profile.displayNamePlaceholder\")}\r\n            className=\"mt-2\"\r\n            maxLength={50}\r\n          />\r\n          <p className=\"text-xs text-muted-foreground mt-1.5\">\r\n            {t(\"profile.displayNameHint\")}\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </OnboardingShell>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(plans)\\_components\\plans-page-client.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(plans)\\_components\\pricing-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(plans)\\plans\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(plans)\\plans\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/subscriptions' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":3,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":3,"endColumn":101}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"∩╗┐import { createClient } from \"@/lib/supabase/server\"\r\nimport { getActivePlans } from \"@/lib/data/plans\"\r\nimport { createSubscriptionCheckoutSession, downgradeToFreeTier } from \"@/app/actions/subscriptions\"\r\nimport PlansPageClient from \"../_components/plans-page-client\"\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\ninterface PlansPageProps {\r\n  params: Promise<{ locale: string }>\r\n}\r\n\r\nexport default async function PlansPage({ params }: PlansPageProps) {\r\n  const { locale } = await params\r\n\r\n  const plans = await getActivePlans()\r\n\r\n  let initialUserId: string | null = null\r\n  let initialCurrentTier = \"free\"\r\n\r\n  try {\r\n    const supabase = await createClient()\r\n    const {\r\n      data: { user },\r\n    } = await supabase.auth.getUser()\r\n\r\n    if (user) {\r\n      initialUserId = user.id\r\n      const { data: profile } = await supabase\r\n        .from(\"profiles\")\r\n        .select(\"tier\")\r\n        .eq(\"id\", user.id)\r\n        .single()\r\n      if (profile?.tier) initialCurrentTier = profile.tier\r\n    }\r\n  } catch {\r\n    // Anonymous users are allowed on this page\r\n  }\r\n\r\n  return (\r\n    <PlansPageClient\r\n      locale={locale || \"en\"}\r\n      initialPlans={plans as Parameters<typeof PlansPageClient>[0][\"initialPlans\"]}\r\n      initialUserId={initialUserId}\r\n      initialCurrentTier={initialCurrentTier}\r\n      actions={{ createSubscriptionCheckoutSession, downgradeToFreeTier }}\r\n    />\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\PerformanceMeasureGuard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_actions\\sell.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createAdminClient' is defined but never used.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"createAdminClient"},"fix":{"range":[107,125],"text":""},"desc":"Remove unused variable \"createAdminClient\"."}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 50 to the 25 allowed.","line":26,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":26,"endColumn":36},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":105,"column":24,"nodeType":"CallExpression","messageId":"array-from","endLine":111,"endColumn":4,"fix":{"range":[3247,3439],"text":"[...new Set(\r\n      (form.attributes || [])\r\n        .map((attr) => attr.attributeId)\r\n        .filter((id): id is string => typeof id === \"string\" && id.length > 0),\r\n    )]"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use server\"\r\n\r\nimport { z } from \"zod\"\r\nimport { sellFormSchemaV4 } from \"@/lib/sell/schema-v4\"\r\nimport { createAdminClient, createClient } from \"@/lib/supabase/server\"\r\nimport { normalizeAttributeKey } from \"@/lib/attributes/normalize-attribute-key\"\r\n\r\nexport type CreateListingResult =\r\n  | {\r\n      success: true\r\n      id: string\r\n      sellerUsername: string\r\n      product: {\r\n        id: string\r\n        slug: string | null\r\n      }\r\n    }\r\n  | {\r\n      success: false\r\n      error: string\r\n      message?: string\r\n      issues?: Array<{ path: string[]; message: string }>\r\n      upgradeRequired?: boolean\r\n    }\r\n\r\nexport async function createListing(args: { sellerId: string; data: unknown }): Promise<CreateListingResult> {\r\n  const schema = z.object({ sellerId: z.string().min(1), data: z.unknown() })\r\n  const parsedArgs = schema.safeParse(args)\r\n  if (!parsedArgs.success) {\r\n    return { success: false, error: \"Invalid input\" }\r\n  }\r\n\r\n  const { sellerId, data } = parsedArgs.data\r\n\r\n  const parsed = sellFormSchemaV4.safeParse(data)\r\n  if (!parsed.success) {\r\n    return {\r\n      success: false,\r\n      error: \"Validation failed\",\r\n      issues: parsed.error.issues.map((i) => ({ path: i.path.map(String), message: i.message })),\r\n    }\r\n  }\r\n\r\n  const supabase = await createClient()\r\n  const {\r\n    data: { user },\r\n  } = await supabase.auth.getUser()\r\n\r\n  if (!user) {\r\n    return { success: false, error: \"Unauthorized\" }\r\n  }\r\n\r\n  if (user.id !== sellerId) {\r\n    return { success: false, error: \"Forbidden\" }\r\n  }\r\n\r\n  // Ensure user has username\r\n  const { data: profile } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"id, username\")\r\n    .eq(\"id\", user.id)\r\n    .single()\r\n\r\n  if (!profile?.username) {\r\n    return { success: false, error: \"You must set up a username to sell items\" }\r\n  }\r\n\r\n  // Enforce listing limit using direct queries (no RPC needed)\r\n  const [{ count: currentListings }, { data: subscription }] = await Promise.all([\r\n    supabase\r\n      .from(\"products\")\r\n      .select(\"id\", { count: \"exact\", head: true })\r\n      .eq(\"seller_id\", user.id)\r\n      .eq(\"status\", \"active\"),\r\n    supabase\r\n      .from(\"subscriptions\")\r\n      .select(\"plan_type, subscription_plans!inner(max_listings)\")\r\n      .eq(\"seller_id\", user.id)\r\n      .eq(\"status\", \"active\")\r\n      .single(),\r\n  ])\r\n\r\n  const subPlan = subscription?.subscription_plans as unknown as { max_listings: number } | null\r\n  const maxListings = subPlan?.max_listings ?? 10\r\n  const isUnlimited = maxListings === -1\r\n  const remaining = isUnlimited ? Number.POSITIVE_INFINITY : Math.max(maxListings - (currentListings ?? 0), 0)\r\n\r\n  if (!isUnlimited && remaining <= 0) {\r\n    return {\r\n      success: false,\r\n      error: \"LISTING_LIMIT_REACHED\",\r\n      message: `You have reached your listing limit (${currentListings} of ${maxListings}). Please upgrade your plan to add more listings.`,\r\n      upgradeRequired: true,\r\n    }\r\n  }\r\n\r\n  const form = parsed.data\r\n\r\n  const imageUrls = (form.images || []).map((img) => img.url)\r\n\r\n  // Build attributes JSONB (canonical keys).\r\n  // Keep `condition` in JSONB too, so filters/hero specs can rely on a single key.\r\n  const attributesJson: Record<string, string> = {}\r\n\r\n  const attributeIds = Array.from(\r\n    new Set(\r\n      (form.attributes || [])\r\n        .map((attr) => attr.attributeId)\r\n        .filter((id): id is string => typeof id === \"string\" && id.length > 0),\r\n    ),\r\n  )\r\n\r\n  const attributeKeyById = new Map<string, string>()\r\n  if (attributeIds.length > 0) {\r\n    const { data: defs, error: defsError } = await supabase\r\n      .from(\"category_attributes\")\r\n      .select(\"id, attribute_key, name\")\r\n      .in(\"id\", attributeIds)\r\n\r\n    if (defsError) {\r\n      console.error(\"[sell:createListing] Failed to resolve attribute_key:\", defsError)\r\n    } else {\r\n      for (const def of defs || []) {\r\n        const key = (def.attribute_key ?? normalizeAttributeKey(def.name ?? \"\")).trim()\r\n        if (def.id && key) attributeKeyById.set(def.id, key)\r\n      }\r\n    }\r\n  }\r\n\r\n  for (const attr of form.attributes || []) {\r\n    const keyFromId = attr.attributeId ? attributeKeyById.get(attr.attributeId) : null\r\n    const key = (keyFromId ?? normalizeAttributeKey(attr.name)).trim()\r\n    if (!key) continue\r\n    attributesJson[key] = attr.value\r\n  }\r\n\r\n  const conditionRaw = typeof form.condition === \"string\" ? form.condition.trim() : \"\"\r\n  const condition = conditionRaw || attributesJson.condition || \"new\"\r\n  attributesJson.condition = condition\r\n\r\n  const price = Number.parseFloat(form.price)\r\n  if (!Number.isFinite(price) || price <= 0) {\r\n    return {\r\n      success: false,\r\n      error: \"Validation failed\",\r\n      issues: [\r\n        {\r\n          path: [\"price\"],\r\n          message: \"Enter a valid price greater than 0\",\r\n        },\r\n      ],\r\n    }\r\n  }\r\n  const listPrice = form.compareAtPrice ? Number.parseFloat(form.compareAtPrice) : null\r\n\r\n  const hasDiscount =\r\n    Number.isFinite(price) &&\r\n    typeof listPrice === \"number\" &&\r\n    Number.isFinite(listPrice) &&\r\n    listPrice > price\r\n\r\n  if (typeof listPrice === \"number\" && Number.isFinite(listPrice) && !hasDiscount) {\r\n    return {\r\n      success: false,\r\n      error: \"Validation failed\",\r\n      issues: [\r\n        {\r\n          path: [\"compareAtPrice\"],\r\n          message: \"Compare at price must be higher than your price\",\r\n        },\r\n      ],\r\n    }\r\n  }\r\n\r\n  const salePercent = hasDiscount && listPrice > 0\r\n    ? Math.round(((listPrice - price) / listPrice) * 100)\r\n    : 0\r\n\r\n  const productData = {\r\n    seller_id: user.id,\r\n    title: form.title,\r\n    description: form.description || \"\",\r\n    price,\r\n    list_price: hasDiscount ? listPrice : null,\r\n    is_on_sale: hasDiscount,\r\n    sale_percent: salePercent,\r\n    sale_end_date: null,\r\n    category_id: form.categoryId || null,\r\n    brand_id: form.brandId || null,\r\n    tags: form.tags || [],\r\n    images: imageUrls,\r\n    stock: form.quantity ?? 1,\r\n    listing_type: \"normal\",\r\n    is_boosted: false,\r\n    boost_expires_at: null,\r\n    seller_city: form.sellerCity || null,\r\n    ships_to_bulgaria: form.shipsToBulgaria ?? true,\r\n    ships_to_uk: form.shipsToUK ?? false,\r\n    ships_to_europe: form.shipsToEurope ?? false,\r\n    ships_to_usa: form.shipsToUSA ?? false,\r\n    ships_to_worldwide: form.shipsToWorldwide ?? false,\r\n    pickup_only: form.pickupOnly ?? false,\r\n    free_shipping: form.freeShipping ?? false,\r\n    // Keep condition in the dedicated column too (canonical for the DB)\r\n    condition,\r\n    attributes: attributesJson,\r\n  }\r\n\r\n  const { data: product, error } = await supabase\r\n    .from(\"products\")\r\n    .insert(productData)\r\n    .select(\"id, slug\")\r\n    .single()\r\n\r\n  if (error) {\r\n    if (error.message?.includes(\"LISTING_LIMIT_REACHED\") || error.code === \"P0001\") {\r\n      return {\r\n        success: false,\r\n        error: \"LISTING_LIMIT_REACHED\",\r\n        message: \"You have reached your listing limit. Please upgrade your plan to add more listings.\",\r\n        upgradeRequired: true,\r\n      }\r\n    }\r\n\r\n    if (error.code === \"23514\" && error.message?.includes(\"Category must be a leaf category\")) {\r\n      return {\r\n        success: false,\r\n        error: \"LEAF_CATEGORY_REQUIRED\",\r\n        message: \"Please select a more specific category (leaf category)\",\r\n      }\r\n    }\r\n    return { success: false, error: error.message || \"Failed to create product\" }\r\n  }\r\n\r\n  const imageRecords = (form.images || []).map((img, index) => ({\r\n    product_id: product.id,\r\n    image_url: img.url,\r\n    thumbnail_url: img.thumbnailUrl || img.url,\r\n    display_order: index,\r\n    is_primary: index === 0,\r\n  }))\r\n\r\n  if (imageRecords.length > 0) {\r\n    const { error: imagesError } = await supabase.from(\"product_images\").insert(imageRecords)\r\n    if (imagesError) {\r\n      // Non-critical: product created but images failed\r\n    }\r\n  }\r\n\r\n  if (form.attributes && form.attributes.length > 0) {\r\n    const attributeRecords = form.attributes.map((attr) => ({\r\n      product_id: product.id,\r\n      attribute_id: attr.attributeId || null,\r\n      name: attr.name,\r\n      value: attr.value,\r\n      is_custom: attr.isCustom ?? false,\r\n    }))\r\n\r\n    const { error: attrError } = await supabase.from(\"product_attributes\").insert(attributeRecords)\r\n    if (attrError) {\r\n      // Non-critical: product created but attributes failed\r\n    }\r\n  }\r\n\r\n  // Default city hint\r\n  if (form.sellerCity) {\r\n    try {\r\n      await supabase\r\n        .from(\"profiles\")\r\n        .update({ default_city: form.sellerCity })\r\n        .eq(\"id\", user.id)\r\n        .is(\"default_city\", null)\r\n    } catch {\r\n      // ignore\r\n    }\r\n  }\r\n\r\n  return {\r\n    success: true,\r\n    id: product.id,\r\n    sellerUsername: profile.username,\r\n    product: {\r\n      id: product.id,\r\n      slug: product.slug ?? null,\r\n    },\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\ai\\ai-listing-assistant.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'images' logical expression could make the dependencies of useCallback Hook (at line 248) change on every render. To fix this, wrap the initialization of 'images' in its own useMemo() Hook.","line":111,"column":9,"nodeType":"VariableDeclarator","endLine":111,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useCallback, useMemo, useState } from \"react\";\nimport { Sparkle, SpinnerGap, Check, WarningCircle } from \"@phosphor-icons/react\";\nimport { toast } from \"sonner\";\nimport { useTranslations } from \"next-intl\";\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { conditionOptions } from \"@/lib/sell/schema-v4\";\r\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\r\nimport type { Category } from \"../../_lib/types\";\r\n\r\ntype SuggestionResponse = {\r\n  title: string | null;\r\n  description: string | null;\r\n  condition:\r\n    | \"new-with-tags\"\r\n    | \"new-without-tags\"\r\n    | \"used-like-new\"\r\n    | \"used-excellent\"\r\n    | \"used-good\"\r\n    | \"used-fair\"\r\n    | null;\r\n  category:\r\n    | {\r\n        slug: string | null;\r\n        name: string | null;\r\n        rationale: string | null;\r\n      }\r\n    | null;\r\n  price: {\r\n    suggested: number | null;\r\n    low: number | null;\r\n    high: number | null;\r\n    currency: \"BGN\" | \"EUR\" | \"USD\" | null;\r\n    rationale: string | null;\r\n  };\r\n  attributes: Array<{ name: string; value: string; rationale: string | null }>;\r\n  tags: string[];\r\n  questions: string[];\r\n  warnings: string[];\r\n};\r\n\r\ntype FlatCategory = {\r\n  id: string;\r\n  slug: string;\r\n  name: string;\r\n  name_bg?: string | null;\r\n  path: Array<{ id: string; name: string; slug: string }>;\r\n};\r\n\r\nfunction flattenCategories(categories: Category[], locale: string): FlatCategory[] {\r\n  const out: FlatCategory[] = [];\r\n\r\n  function walk(node: Category, path: FlatCategory[\"path\"]) {\r\n    const name = locale === \"bg\" && node.name_bg ? node.name_bg : node.name;\r\n    const nextPath = [...path, { id: node.id, name, slug: node.slug }];\r\n    out.push({ id: node.id, slug: node.slug, name: node.name, name_bg: node.name_bg ?? null, path: nextPath });\r\n\r\n    for (const child of node.children ?? []) {\r\n      walk(child, nextPath);\r\n    }\r\n  }\r\n\r\n  for (const c of categories) walk(c, []);\r\n  return out;\r\n}\r\n\r\nfunction scoreCategoryMatch(target: string, cat: FlatCategory): number {\r\n  const t = target.trim().toLowerCase();\r\n  if (!t) return 0;\r\n\r\n  const slug = cat.slug.toLowerCase();\r\n  const nameEn = cat.name.toLowerCase();\r\n  const nameBg = (cat.name_bg ?? \"\").toLowerCase();\r\n\r\n  if (t === slug) return 100;\r\n  if (t === nameEn || (nameBg && t === nameBg)) return 90;\r\n\r\n  const hay = `${slug} ${nameEn} ${nameBg} ${cat.path.map((p) => p.name.toLowerCase()).join(\" \")}`;\r\n  if (hay.includes(t)) return 70;\r\n\r\n  // token overlap\r\n  const tokens = t.split(/\\s+|>|/).filter(Boolean);\r\n  if (tokens.length === 0) return 0;\r\n  const hits = tokens.filter((tok) => tok.length >= 3 && hay.includes(tok)).length;\r\n  return Math.min(60, hits * 10);\r\n}\r\n\r\n/**\r\n * AiListingAssistant - AI-powered form suggestions from product images.\r\n * Uses context pattern (useSellForm/useSellFormContext) instead of prop drilling.\r\n * \r\n * @example\r\n * ```tsx\r\n * // Inside SellFormProvider\r\n * <AiListingAssistant />\r\n * ```\r\n */\r\nexport function AiListingAssistant() {\n  // Use context instead of prop drilling\n  const form = useSellForm();\n  const { categories, locale, isBg } = useSellFormContext();\n  const tSell = useTranslations(\"Sell\")\n  \r\n  const [enabled, setEnabled] = useState(false);\r\n  const [status, setStatus] = useState<\"idle\" | \"loading\" | \"ready\" | \"error\">(\"idle\");\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [suggestions, setSuggestions] = useState<SuggestionResponse | null>(null);\r\n\r\n  const images = form.watch(\"images\") ?? [];\r\n  const currency = form.watch(\"currency\") ?? \"BGN\";\r\n\r\n  const flatCategories = useMemo(() => flattenCategories(categories, locale), [categories, locale]);\r\n\r\n  const canGenerate = images.length > 0 && status !== \"loading\";\r\n\r\n  const resolveSuggestedCategory = useCallback(\r\n    (s: SuggestionResponse): FlatCategory | null => {\r\n      const slug = s.category?.slug ?? \"\";\r\n      const name = s.category?.name ?? \"\";\r\n      const target = slug || name;\r\n      if (!target) return null;\r\n\r\n      let best: { cat: FlatCategory; score: number } | null = null;\r\n      for (const cat of flatCategories) {\r\n        const score = scoreCategoryMatch(target, cat);\r\n        if (score <= 0) continue;\r\n        if (!best || score > best.score) best = { cat, score };\r\n      }\r\n\r\n      if (!best || best.score < 50) return null;\r\n      return best.cat;\r\n    },\r\n    [flatCategories]\r\n  );\r\n\r\n  const applyAll = useCallback(\r\n    (s: SuggestionResponse) => {\r\n      let applied = 0;\r\n\r\n      if (s.title) {\r\n        form.setValue(\"title\", s.title, { shouldValidate: true, shouldDirty: true });\r\n        applied += 1;\r\n      }\r\n\r\n      if (s.description) {\r\n        form.setValue(\"description\", s.description, { shouldValidate: true, shouldDirty: true });\r\n        applied += 1;\r\n      }\r\n\r\n      if (s.condition) {\r\n        form.setValue(\"condition\", s.condition, { shouldValidate: true, shouldDirty: true });\r\n        applied += 1;\r\n      }\r\n\r\n      if (typeof s.price.suggested === \"number\" && Number.isFinite(s.price.suggested)) {\r\n        form.setValue(\"price\", s.price.suggested.toFixed(2), { shouldValidate: true, shouldDirty: true });\r\n        applied += 1;\r\n      }\r\n\r\n      const matchedCategory = resolveSuggestedCategory(s);\r\n      if (matchedCategory) {\r\n        form.setValue(\"categoryId\", matchedCategory.id, { shouldValidate: true, shouldDirty: true });\r\n        form.setValue(\"categoryPath\", matchedCategory.path, { shouldDirty: true });\r\n        applied += 1;\r\n      }\r\n\r\n      if (Array.isArray(s.tags) && s.tags.length > 0) {\r\n        const existing = form.getValues(\"tags\") ?? [];\r\n        const merged = [...new Set([...existing, ...s.tags])].slice(0, 10);\r\n        form.setValue(\"tags\", merged, { shouldDirty: true });\r\n        applied += 1;\r\n      }\r\n\r\n      if (Array.isArray(s.attributes) && s.attributes.length > 0) {\r\n        const existing = form.getValues(\"attributes\") ?? [];\r\n        const existingKeys = new Set(existing.map((a) => `${a.name}`.toLowerCase()));\r\n\r\n        const additions = s.attributes\r\n          .filter((a) => a.name && a.value)\r\n          .filter((a) => !existingKeys.has(a.name.toLowerCase()))\r\n          .slice(0, 12)\r\n          .map((a) => ({\r\n            attributeId: null,\r\n            name: a.name,\r\n            value: a.value,\r\n            isCustom: true,\r\n          }));\r\n\r\n        if (additions.length > 0) {\r\n          form.setValue(\"attributes\", [...existing, ...additions], { shouldDirty: true });\r\n          applied += 1;\r\n        }\r\n      }\r\n\r\n      if (applied > 0) {\r\n        toast.success(isBg ? \"╨ƒ╤Ç╨╕╨╗╨╛╨╢╨╡╨╜╨╕ AI ╨┐╤Ç╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╤Å\" : \"Applied AI suggestions\");\r\n      } else {\r\n        toast.message(isBg ? \"╨¥╤Å╨╝╨░ ╨║╨░╨║╨▓╨╛ ╨┤╨░ ╤ü╨╡ ╨┐╤Ç╨╕╨╗╨╛╨╢╨╕\" : \"Nothing to apply\");\r\n      }\r\n    },\r\n    [form, isBg, resolveSuggestedCategory]\r\n  );\r\n\r\n  const generate = useCallback(async () => {\r\n    if (!canGenerate) return;\r\n\r\n    setStatus(\"loading\");\r\n    setError(null);\r\n\r\n    try {\r\n      const payload = {\r\n        locale,\r\n        currency,\r\n        images: images.slice(0, 4).map((img) => ({ url: img.url })),\r\n        context: {\r\n          title: form.getValues(\"title\") || \"\",\r\n          description: form.getValues(\"description\") || \"\",\r\n          condition: form.getValues(\"condition\") || \"\",\r\n        },\r\n      };\r\n\r\n      const res = await fetch(\"/api/ai/listing-suggestions\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(payload),\r\n      });\r\n\r\n      const data = (await res.json()) as SuggestionResponse | { error?: string };\n      if (!res.ok) {\n        const errorMessage =\n          typeof (data as { error?: unknown }).error === \"string\"\n            ? (data as { error?: string }).error\n            : undefined;\n        throw new Error(errorMessage || \"Failed to generate suggestions\");\n      }\n\r\n      setSuggestions(data as SuggestionResponse);\r\n      setStatus(\"ready\");\r\n\r\n      toast.success(isBg ? \"AI ╨┐╤Ç╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╤Å ╨│╨╛╤é╨╛╨▓╨╕\" : \"AI suggestions ready\");\r\n    } catch (e) {\r\n      const message = e instanceof Error ? e.message : \"Failed to generate suggestions\";\r\n      setError(message);\r\n      setStatus(\"error\");\r\n    }\r\n  }, [canGenerate, currency, form, images, isBg, locale]);\r\n\r\n  const showPanel = enabled;\r\n\r\n  const matchedCategory = suggestions ? resolveSuggestedCategory(suggestions) : null;\n  const conditionLabel = suggestions?.condition\n    ? (() => {\n        const option = conditionOptions.find((c) => c.value === suggestions.condition)\n        if (option) return tSell(option.labelKey as never)\n        return suggestions.condition\n      })()\n    : null;\n\r\n  // Minimal: just a single button that generates suggestions\r\n  // No card wrapper, no toggle - just action\r\n  if (!showPanel) {\r\n    return (\r\n      <Button\r\n        type=\"button\"\r\n        variant=\"outline\"\r\n        onClick={() => {\r\n          setEnabled(true);\r\n          if (canGenerate) generate();\r\n        }}\r\n        disabled={images.length === 0}\r\n        className=\"w-full h-11 gap-2 border-dashed border-border\"\r\n      >\r\n        <Sparkle className=\"size-4\" weight=\"fill\" />\r\n        <span className=\"text-sm\">\r\n          {isBg ? \"AI ╨┐╤Ç╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╤Å\" : \"AI suggestions\"}\r\n        </span>\r\n        {images.length === 0 && (\r\n          <span className=\"text-xs text-muted-foreground ml-1\">\r\n            ({isBg ? \"╨┤╨╛╨▒╨░╨▓╨╕ ╤ü╨╜╨╕╨╝╨║╨░\" : \"add photo first\"})\r\n          </span>\r\n        )}\r\n      </Button>\r\n    );\r\n  }\r\n\r\n  // Expanded: show results inline\r\n  return (\r\n    <div className=\"space-y-3\">\r\n      {/* Header with close */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <Sparkle className=\"size-4 text-primary\" weight=\"fill\" />\r\n          <span className=\"text-sm font-medium\">{isBg ? \"AI ╨┐╤Ç╨╡╨┤╨╗╨╛╨╢╨╡╨╜╨╕╤Å\" : \"AI suggestions\"}</span>\r\n        </div>\r\n        <Button\r\n          type=\"button\"\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          onClick={() => { setEnabled(false); setSuggestions(null); }}\r\n          className=\"h-8 px-2 text-muted-foreground\"\r\n        >\r\n          {isBg ? \"╨ù╨░╤é╨▓╨╛╤Ç╨╕\" : \"Close\"}\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Actions */}\r\n      <div className=\"flex items-center gap-2\">\r\n        <Button\r\n          type=\"button\"\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n          onClick={generate}\r\n          disabled={!canGenerate}\r\n          className=\"h-9 gap-1.5\"\r\n        >\r\n          {status === \"loading\" ? (\r\n            <SpinnerGap className=\"size-4 animate-spin\" />\r\n          ) : (\r\n            <Sparkle className=\"size-4\" />\r\n          )}\r\n          {status === \"loading\" \r\n            ? (isBg ? \"╨ô╨╡╨╜╨╡╤Ç╨╕╤Ç╨░╨╜╨╡...\" : \"Generating...\") \r\n            : (isBg ? \"╨ô╨╡╨╜╨╡╤Ç╨╕╤Ç╨░╨╣\" : \"Generate\")}\r\n        </Button>\r\n\r\n        {suggestions && (\r\n          <Button\r\n            type=\"button\"\r\n            variant=\"secondary\"\r\n            size=\"sm\"\r\n            onClick={() => applyAll(suggestions)}\r\n            className=\"h-9 gap-1.5\"\r\n          >\r\n            <Check className=\"size-4\" />\r\n            {isBg ? \"╨ƒ╤Ç╨╕╨╗╨╛╨╢╨╕ ╨▓╤ü╨╕╤ç╨║╨╕\" : \"Apply all\"}\r\n          </Button>\r\n        )}\r\n      </div>\r\n\r\n      {/* Error */}\r\n      {error && (\r\n        <div className=\"flex items-center gap-2 text-sm text-destructive\">\r\n          <WarningCircle className=\"size-4\" />\r\n          <span>{error}</span>\r\n        </div>\r\n      )}\r\n\r\n      {/* Results - compact list */}\n      {suggestions && (() => {\n        const title = suggestions.title\n        const condition = suggestions.condition\n        const suggestedPrice = typeof suggestions.price.suggested === \"number\" && Number.isFinite(suggestions.price.suggested)\n          ? suggestions.price.suggested\n          : null\n\n        return (\n          <div className=\"space-y-2\">\n            {title && (\n              <button\n                type=\"button\"\n                onClick={() => {\n                  form.setValue(\"title\", title, { shouldValidate: true, shouldDirty: true });\n                  toast.success(isBg ? \"╨ù╨░╨│╨╗╨░╨▓╨╕╨╡╤é╨╛ ╨╡ ╨┐╤Ç╨╕╨╗╨╛╨╢╨╡╨╜╨╛\" : \"Title applied\");\n                }}\n                className=\"w-full flex items-center justify-between gap-2 px-3 py-2 rounded-lg border border-dashed border-border text-left hover:bg-accent\"\n              >\n                <div className=\"min-w-0\">\n                  <div className=\"text-xs text-muted-foreground\">{isBg ? \"╨ù╨░╨│╨╗╨░╨▓╨╕╨╡\" : \"Title\"}</div>\n                  <div className=\"text-sm truncate\">{title}</div>\n                </div>\n                <Check className=\"size-4 text-muted-foreground shrink-0\" />\n              </button>\n            )}\n\n            {matchedCategory && (\n              <button\n                type=\"button\"\n                onClick={() => {\n                  form.setValue(\"categoryId\", matchedCategory.id, { shouldValidate: true, shouldDirty: true });\n                  form.setValue(\"categoryPath\", matchedCategory.path, { shouldDirty: true });\n                  toast.success(isBg ? \"╨Ü╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å╤é╨░ ╨╡ ╨┐╤Ç╨╕╨╗╨╛╨╢╨╡╨╜╨░\" : \"Category applied\");\n                }}\n                className=\"w-full flex items-center justify-between gap-2 px-3 py-2 rounded-lg border border-dashed border-border text-left hover:bg-accent\"\n              >\n                <div className=\"min-w-0\">\n                  <div className=\"text-xs text-muted-foreground\">{isBg ? \"╨Ü╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å\" : \"Category\"}</div>\n                  <div className=\"text-sm truncate\">{matchedCategory.path.map(p => p.name).join(\" > \")}</div>\n                </div>\n                <Check className=\"size-4 text-muted-foreground shrink-0\" />\n              </button>\n            )}\n\n            {condition && (\n              <button\n                type=\"button\"\n                onClick={() => {\n                  form.setValue(\"condition\", condition, { shouldValidate: true, shouldDirty: true });\n                  toast.success(isBg ? \"╨í╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡╤é╨╛ ╨╡ ╨┐╤Ç╨╕╨╗╨╛╨╢╨╡╨╜╨╛\" : \"Condition applied\");\n                }}\n                className=\"w-full flex items-center justify-between gap-2 px-3 py-2 rounded-lg border border-dashed border-border text-left hover:bg-accent\"\n              >\n                <div className=\"min-w-0\">\n                  <div className=\"text-xs text-muted-foreground\">{isBg ? \"╨í╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡\" : \"Condition\"}</div>\n                  <div className=\"text-sm\">{conditionLabel}</div>\n                </div>\n                <Check className=\"size-4 text-muted-foreground shrink-0\" />\n              </button>\n            )}\n\n            {suggestedPrice !== null && (\n              <button\n                type=\"button\"\n                onClick={() => {\n                  form.setValue(\"price\", suggestedPrice.toFixed(2), { shouldValidate: true, shouldDirty: true });\n                  toast.success(isBg ? \"╨ª╨╡╨╜╨░╤é╨░ ╨╡ ╨┐╤Ç╨╕╨╗╨╛╨╢╨╡╨╜╨░\" : \"Price applied\");\n                }}\n                className=\"w-full flex items-center justify-between gap-2 px-3 py-2 rounded-lg border border-dashed border-border text-left hover:bg-accent\"\n              >\n                <div className=\"min-w-0\">\n                  <div className=\"text-xs text-muted-foreground\">{isBg ? \"╨ª╨╡╨╜╨░\" : \"Price\"}</div>\n                  <div className=\"text-sm\">{suggestedPrice.toFixed(2)} {suggestions.price.currency ?? currency}</div>\n                </div>\n                <Check className=\"size-4 text-muted-foreground shrink-0\" />\n              </button>\n            )}\n          </div>\n        )\n      })()}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\fields\\attributes-field.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 26 to the 25 allowed.","line":142,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":142,"endColumn":32},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'EXCLUDED_NAMES'. Either include it or remove the dependency array.","line":273,"column":5,"nodeType":"ArrayExpression","endLine":273,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [EXCLUDED_NAMES, dbAttributes]","fix":{"range":[9869,9883],"text":"[EXCLUDED_NAMES, dbAttributes]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useMemo has a missing dependency: 'EXCLUDED_NAMES'. Either include it or remove the dependency array.","line":282,"column":5,"nodeType":"ArrayExpression","endLine":282,"endColumn":19,"suggestions":[{"desc":"Update the dependencies array to be: [EXCLUDED_NAMES, dbAttributes]","fix":{"range":[10217,10231],"text":"[EXCLUDED_NAMES, dbAttributes]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useCallback, memo, useMemo } from \"react\";\r\nimport { Sliders, Plus, X, Info, SpinnerGap, WarningCircle, CheckCircle, CaretRight } from \"@phosphor-icons/react\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Field, FieldLabel, FieldDescription, FieldContent } from \"@/components/shared/field\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport type { ProductAttribute } from \"@/lib/sell/schema-v4\";\r\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\r\nimport { SelectDrawer } from \"../ui/select-drawer\";\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\ninterface CategoryAttribute {\r\n  id: string;\r\n  name: string;\r\n  name_bg?: string | null;\r\n  attribute_type: \"text\" | \"number\" | \"select\" | \"multiselect\" | \"boolean\" | \"date\";\r\n  is_required: boolean;\r\n  is_filterable: boolean;\r\n  options?: string[];\r\n  options_bg?: string[];\r\n  placeholder?: string;\r\n  placeholder_bg?: string;\r\n  sort_order: number;\r\n}\r\n\r\n// ============================================================================\r\n// Helper: Check if attribute value is filled\r\n// ============================================================================\r\nfunction isAttributeFilled(value: string | undefined | null): boolean {\r\n  return value !== undefined && value !== null && value.trim() !== \"\";\r\n}\r\n\r\n// ============================================================================\r\n// ATTRIBUTES FIELD - Database-driven category attributes\r\n// Single source of truth: category_attributes table via /api/categories/:id/attributes\r\n// ============================================================================\r\n\r\ninterface AttributesFieldProps {\r\n  className?: string;\r\n  compact?: boolean;\r\n}\r\n\r\n/**\r\n * Attribute selection with Drawer support on mobile\r\n */\r\nfunction AttributeSelect({\r\n  label,\r\n  value,\r\n  options,\r\n  optionsBg,\r\n  onChange,\r\n  placeholder,\r\n  compact,\r\n  isBg,\r\n}: {\r\n  label: string;\r\n  value: string;\r\n  options: string[];\r\n  optionsBg?: string[];\r\n  onChange: (val: string) => void;\r\n  placeholder?: string;\r\n  compact: boolean;\r\n  isBg: boolean;\r\n}) {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n\r\n  const normalizedOptions = useMemo(() => {\r\n    return options.map((opt, idx) => ({\r\n      value: opt,\r\n      label: (isBg && optionsBg?.[idx]) ? optionsBg[idx] : opt\r\n    }));\r\n  }, [options, optionsBg, isBg]);\r\n\r\n  const displayValue = useMemo(() => {\r\n    if (!value) return null;\r\n    return normalizedOptions.find(opt => opt.value === value)?.label || value;\r\n  }, [value, normalizedOptions]);\r\n\r\n  if (compact) {\r\n    return (\r\n      <>\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => setIsOpen(true)}\r\n          className=\"relative w-full flex items-center h-12 px-4 rounded-md border border-border bg-background hover:border-hover-border transition-colors text-left shadow-xs\"\r\n        >\r\n          <div className=\"flex items-center gap-2 flex-1 min-w-0\">\r\n            <span className=\"text-2xs font-bold uppercase tracking-wider text-muted-foreground shrink-0\">\r\n              {label}:\r\n            </span>\r\n            <span className={cn(\r\n              \"text-sm font-semibold truncate\",\r\n              displayValue ? \"text-foreground\" : \"text-muted-foreground\"\r\n            )}>\r\n              {displayValue || placeholder || (isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡...\" : \"Select...\")}\r\n            </span>\r\n          </div>\r\n          <CaretRight className=\"size-4 text-muted-foreground shrink-0 ml-2\" weight=\"bold\" />\r\n        </button>\r\n        <SelectDrawer\r\n          isOpen={isOpen}\r\n          onClose={() => setIsOpen(false)}\r\n          title={label}\r\n          options={options}\r\n          {...(optionsBg ? { optionsBg } : {})}\r\n          value={value}\r\n          onChange={onChange}\r\n          locale={isBg ? \"bg\" : \"en\"}\r\n        />\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Select value={value || undefined} onValueChange={onChange}>\r\n      <SelectTrigger className=\"w-full h-12 rounded-md border-border font-medium\">\r\n        <SelectValue placeholder={placeholder || (isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╕...\" : \"Select...\")} />\r\n      </SelectTrigger>\r\n      <SelectContent>\r\n        {normalizedOptions.map((opt) => (\r\n          <SelectItem key={opt.value} value={opt.value} className=\"font-medium\">\r\n            {opt.label}\r\n          </SelectItem>\r\n        ))}\r\n      </SelectContent>\r\n    </Select>\r\n  );\r\n}\r\n\r\nexport function AttributesField({ className, compact = false }: AttributesFieldProps) {\r\n  const { setValue, watch } = useSellForm();\r\n  const { isBg } = useSellFormContext();\r\n\r\n  const categoryId = watch(\"categoryId\");\r\n  const watchedAttributes = watch(\"attributes\");\r\n  const attributes = useMemo(() => watchedAttributes || [], [watchedAttributes]);\r\n\r\n  // DB-based attributes state\r\n  const [dbAttributes, setDbAttributes] = useState<CategoryAttribute[]>([]);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [newAttrName, setNewAttrName] = useState(\"\");\r\n  const [newAttrValue, setNewAttrValue] = useState(\"\");\r\n  const [showAllDbAttributes, setShowAllDbAttributes] = useState(false);\r\n\r\n  // Fetch attributes from database when category changes\r\n  useEffect(() => {\r\n    if (!categoryId) {\r\n      setDbAttributes([]);\r\n      return;\r\n    }\r\n\r\n    const fetchAttributes = async () => {\r\n      setIsLoading(true);\r\n      try {\r\n        const response = await fetch(`/api/categories/${categoryId}/attributes`);\r\n        if (response.ok) {\r\n          const data = await response.json();\r\n          const maybeAttributes = (data && typeof data === \"object\" && \"attributes\" in data)\r\n            ? (data as { attributes?: unknown }).attributes\r\n            : data;\r\n\r\n          if (!Array.isArray(maybeAttributes)) {\r\n            setDbAttributes([]);\r\n            return;\r\n          }\r\n\r\n          const normalized = (maybeAttributes as Array<Record<string, unknown>>).map((attr) => ({\r\n            id: String(attr.id),\r\n            name: String(attr.name ?? \"\"),\r\n            name_bg: attr.name_bg ?? attr.nameBg ?? null,\r\n            attribute_type: (attr.attribute_type ?? attr.type ?? \"text\") as CategoryAttribute[\"attribute_type\"],\r\n            is_required: Boolean(attr.is_required ?? attr.required),\r\n            is_filterable: Boolean(attr.is_filterable ?? attr.filterable),\r\n            options: (attr.options ?? undefined) as string[] | undefined,\r\n            options_bg: (attr.options_bg ?? attr.optionsBg ?? undefined) as string[] | undefined,\r\n            placeholder: (attr.placeholder ?? undefined) as string | undefined,\r\n            placeholder_bg: (attr.placeholder_bg ?? attr.placeholderBg ?? undefined) as string | undefined,\r\n            sort_order: Number(attr.sort_order ?? attr.sortOrder ?? 0),\r\n          })) as CategoryAttribute[];\r\n\r\n          setDbAttributes(normalized);\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Failed to fetch category attributes:\", error);\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n\r\n    fetchAttributes();\r\n  }, [categoryId]);\r\n\r\n  // Handle attribute change\r\n  const handleAttributeChange = useCallback((attr: CategoryAttribute, value: string) => {\r\n    const existing = attributes.find(a => a.attributeId === attr.id);\r\n    let newAttrs: ProductAttribute[];\r\n\r\n    if (existing) {\r\n      if (value) {\r\n        newAttrs = attributes.map(a =>\r\n          a.attributeId === attr.id ? { ...a, value } : a\r\n        );\r\n      } else {\r\n        newAttrs = attributes.filter(a => a.attributeId !== attr.id);\r\n      }\r\n    } else if (value) {\r\n      newAttrs = [...attributes, {\r\n        attributeId: attr.id,\r\n        name: attr.name,\r\n        value,\r\n        isCustom: false,\r\n      }];\r\n    } else {\r\n      newAttrs = attributes;\r\n    }\r\n\r\n    setValue(\"attributes\", newAttrs, { shouldValidate: true });\r\n  }, [attributes, setValue]);\r\n\r\n  // Add custom attribute\r\n  const handleAddCustom = useCallback(() => {\r\n    if (!newAttrName.trim() || !newAttrValue.trim()) return;\r\n\r\n    const newAttr: ProductAttribute = {\r\n      attributeId: null,\r\n      name: newAttrName.trim(),\r\n      value: newAttrValue.trim(),\r\n      isCustom: true,\r\n    };\r\n\r\n    setValue(\"attributes\", [...attributes, newAttr], { shouldValidate: true });\r\n    setNewAttrName(\"\");\r\n    setNewAttrValue(\"\");\r\n  }, [newAttrName, newAttrValue, attributes, setValue]);\r\n\r\n  // Remove custom attribute\r\n  const handleRemoveCustom = useCallback((index: number) => {\r\n    const customs = attributes.filter(a => a.isCustom);\r\n    const customToRemove = customs[index];\r\n    setValue(\"attributes\", attributes.filter(a => a !== customToRemove), { shouldValidate: true });\r\n  }, [attributes, setValue]);\r\n\r\n  // Localization helpers\r\n  const getName = useCallback((attr: CategoryAttribute) =>\r\n    isBg && attr.name_bg ? attr.name_bg : attr.name, [isBg]);\r\n\r\n  const getPlaceholder = useCallback((attr: CategoryAttribute) =>\r\n    isBg && attr.placeholder_bg ? attr.placeholder_bg : attr.placeholder, [isBg]);\r\n\r\n  const customAttrs = useMemo(() => attributes.filter(a => a.isCustom), [attributes]);\r\n\r\n  // Filter out condition attribute (handled by ConditionField)\r\n  const EXCLUDED_NAMES = [\"condition\", \"╤ü╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡\", \"╤ü╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡ ╨╜╨░ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨░\"];\r\n  \r\n  const dbRequiredAttrs = useMemo(\r\n    () => dbAttributes\r\n      .filter(a => a.is_required)\r\n      .filter(a => !EXCLUDED_NAMES.includes(a.name.toLowerCase()) && \r\n                   !(a.name_bg && EXCLUDED_NAMES.includes(a.name_bg.toLowerCase())))\r\n      .sort((a, b) => (a.sort_order ?? 0) - (b.sort_order ?? 0)),\r\n    [dbAttributes]\r\n  );\r\n\r\n  const dbOptionalAttrs = useMemo(\r\n    () => dbAttributes\r\n      .filter(a => !a.is_required)\r\n      .filter(a => !EXCLUDED_NAMES.includes(a.name.toLowerCase()) && \r\n                   !(a.name_bg && EXCLUDED_NAMES.includes(a.name_bg.toLowerCase())))\r\n      .sort((a, b) => (a.sort_order ?? 0) - (b.sort_order ?? 0)),\r\n    [dbAttributes]\r\n  );\r\n\r\n  // Cap required fields at 6 for cleaner UX\r\n  const SMART_LIMIT = 6;\r\n  const dbRequiredSmart = useMemo(() => dbRequiredAttrs.slice(0, SMART_LIMIT), [dbRequiredAttrs]);\r\n\r\n  // Completion tracking\r\n  const dbRequiredSmartCount = dbRequiredSmart.length;\r\n  const filledDbRequiredSmartCount = useMemo(() => {\r\n    return dbRequiredSmart.reduce((acc, attr) => {\r\n      const v = attributes.find(a => a.attributeId === attr.id)?.value || \"\";\r\n      return acc + (isAttributeFilled(v) ? 1 : 0);\r\n    }, 0);\r\n  }, [attributes, dbRequiredSmart]);\r\n\r\n  // No category selected\r\n  if (!categoryId) {\r\n    return (\r\n      <div className={cn(\"rounded-md border border-dashed border-border bg-surface-subtle p-4\", className)}>\r\n        <p className=\"text-sm text-muted-foreground text-center\">\r\n          {isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å, ╨╖╨░ ╨┤╨░ ╨▓╨╕╨┤╨╕╤é╨╡ ╤ü╨┐╨╡╤å╨╕╤ä╨╕╨║╨░╤å╨╕╨╕╤é╨╡\" : \"Select a category to see item specifics\"}\r\n        </p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const content = (\r\n    <FieldContent className={cn(\"space-y-5\", !compact && \"p-5\")}>\r\n      {/* Loading */}\r\n      {isLoading && (\r\n        <div className=\"flex items-center justify-center p-8\">\r\n          <SpinnerGap className=\"size-6 animate-spin text-primary\" />\r\n        </div>\r\n      )}\r\n\r\n      {/* Required attributes (smart subset) */}\r\n      {!isLoading && dbRequiredSmart.length > 0 && (\r\n        <div className=\"space-y-4\">\r\n          <div className=\"flex items-center justify-between gap-2\">\r\n            <div className=\"flex items-center gap-2 text-sm font-bold\">\r\n              {filledDbRequiredSmartCount === dbRequiredSmartCount ? (\r\n                <CheckCircle className=\"size-4 text-primary\" weight=\"fill\" />\r\n              ) : (\r\n                <WarningCircle className=\"size-4 text-muted-foreground\" weight=\"fill\" />\r\n              )}\r\n              <span className=\"text-foreground uppercase tracking-wider text-xs\">\r\n                {isBg ? \"╨₧╤ü╨╜╨╛╨▓╨╜╨╕ ╤à╨░╤Ç╨░╨║╤é╨╡╤Ç╨╕╤ü╤é╨╕╨║╨╕\" : \"Main specifics\"}\r\n              </span>\r\n            </div>\r\n            <span className=\"text-xs font-bold text-muted-foreground tabular-nums bg-surface-subtle px-2 py-0.5 rounded-full\">\r\n              {filledDbRequiredSmartCount}/{dbRequiredSmartCount}\r\n            </span>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n            {dbRequiredSmart.map((attr) => {\r\n              const currentValue = attributes.find(a => a.attributeId === attr.id)?.value || \"\";\r\n              return (\r\n                <div key={attr.id} className=\"space-y-1.5\">\r\n                  {!compact && (\r\n                    <Label className=\"block text-xs font-bold text-muted-foreground uppercase tracking-wider\">\r\n                      {getName(attr)}\r\n                      <span className=\"text-destructive ml-1\">*</span>\r\n                    </Label>\r\n                  )}\r\n                  {attr.attribute_type === \"select\" && attr.options?.length ? (\r\n                    <AttributeSelect\r\n                      label={getName(attr)}\r\n                      value={currentValue}\r\n                      options={attr.options}\r\n                      {...(attr.options_bg ? { optionsBg: attr.options_bg } : {})}\r\n                      onChange={(value) => handleAttributeChange(attr, value)}\r\n                      placeholder={`${isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╕\" : \"Select\"} ${getName(attr)}`}\r\n                      compact={compact}\r\n                      isBg={isBg}\r\n                    />\r\n                  ) : (\r\n                    <div className={cn(\r\n                      \"relative flex items-center h-12 px-4 rounded-md border transition-colors\",\r\n                      \"bg-background border-border shadow-xs focus-within:border-ring focus-within:ring-2 focus-within:ring-ring\"\r\n                    )}>\r\n                      <label className=\"text-2xs font-bold uppercase tracking-wider text-muted-foreground shrink-0 mr-2\">\r\n                        {getName(attr)}:\r\n                        <span className=\"text-destructive ml-1\">*</span>\r\n                      </label>\r\n                      <Input\r\n                        value={currentValue}\r\n                        onChange={(e) => handleAttributeChange(attr, e.target.value)}\r\n                        placeholder={getPlaceholder(attr) || `${isBg ? \"╨Æ╤è╨▓╨╡╨┤╨╕\" : \"Enter\"} ${getName(attr)}`}\r\n                        type={attr.attribute_type === \"number\" ? \"number\" : \"text\"}\r\n                        className=\"h-auto p-0 border-none bg-transparent shadow-none focus-visible:ring-0 text-sm font-semibold flex-1 min-w-0\"\r\n                      />\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Optional attributes (expandable) */}\r\n      {!isLoading && (dbOptionalAttrs.length > 0 || dbRequiredAttrs.length > SMART_LIMIT) && (\r\n        <div className=\"space-y-3\">\r\n          <div className=\"flex items-center justify-between gap-2\">\r\n            <Label className=\"text-xs font-bold text-muted-foreground uppercase tracking-wider\">\r\n              {isBg ? \"╨₧╤ë╨╡ ╨┤╨╡╤é╨░╨╣╨╗╨╕ (╨┐╨╛ ╨╢╨╡╨╗╨░╨╜╨╕╨╡)\" : \"More details (optional)\"}\r\n            </Label>\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={() => setShowAllDbAttributes(v => !v)}\r\n              className=\"h-8 text-xs font-bold text-primary hover:bg-hover active:bg-active\"\r\n            >\r\n              {showAllDbAttributes ? (isBg ? \"╨í╨║╤Ç╨╕╨╣\" : \"Hide\") : (isBg ? \"╨ƒ╨╛╨║╨░╨╢╨╕ ╨▓╤ü╨╕╤ç╨║╨╕\" : \"Show all\")}\r\n            </Button>\r\n          </div>\r\n\r\n          {showAllDbAttributes && (\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2\">\r\n              {/* Remaining required beyond smart cap */}\r\n              {dbRequiredAttrs.slice(SMART_LIMIT).map((attr) => {\r\n                const currentValue = attributes.find(a => a.attributeId === attr.id)?.value || \"\";\r\n                return (\r\n                  <div key={attr.id} className=\"space-y-1.5\">\r\n                    {!compact && (\r\n                      <Label className=\"block text-xs font-bold text-muted-foreground uppercase tracking-wider\">\r\n                        {getName(attr)}\r\n                        <span className=\"text-destructive ml-1\">*</span>\r\n                      </Label>\r\n                    )}\r\n                    {attr.attribute_type === \"select\" && attr.options?.length ? (\r\n                      <AttributeSelect\r\n                        label={getName(attr)}\r\n                        value={currentValue}\r\n                        options={attr.options}\r\n                        {...(attr.options_bg ? { optionsBg: attr.options_bg } : {})}\r\n                        onChange={(value) => handleAttributeChange(attr, value)}\r\n                        placeholder={`${isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╕\" : \"Select\"} ${getName(attr)}`}\r\n                        compact={compact}\r\n                        isBg={isBg}\r\n                      />\r\n                    ) : (\r\n                      <div className={cn(\r\n                        \"relative flex items-center h-12 px-4 rounded-md border transition-colors\",\r\n                        \"bg-background border-border shadow-xs focus-within:border-ring focus-within:ring-2 focus-within:ring-ring\"\r\n                      )}>\r\n                        <label className=\"text-2xs font-bold uppercase tracking-wider text-muted-foreground shrink-0 mr-2\">\r\n                          {getName(attr)}:\r\n                          <span className=\"text-destructive ml-1\">*</span>\r\n                        </label>\r\n                        <Input\r\n                          value={currentValue}\r\n                          onChange={(e) => handleAttributeChange(attr, e.target.value)}\r\n                          placeholder={getPlaceholder(attr) || `${isBg ? \"╨Æ╤è╨▓╨╡╨┤╨╕\" : \"Enter\"} ${getName(attr)}`}\r\n                          type={attr.attribute_type === \"number\" ? \"number\" : \"text\"}\r\n                          className=\"h-auto p-0 border-none bg-transparent shadow-none focus-visible:ring-0 text-sm font-semibold flex-1 min-w-0\"\r\n                        />\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                );\r\n              })}\r\n\r\n              {/* Optional attributes */}\r\n              {dbOptionalAttrs.map((attr) => {\r\n                const currentValue = attributes.find(a => a.attributeId === attr.id)?.value || \"\";\r\n                return (\r\n                  <div key={attr.id} className=\"space-y-1.5\">\r\n                    {!compact && (\r\n                      <Label className=\"block text-xs font-bold text-muted-foreground uppercase tracking-wider\">\r\n                        {getName(attr)}\r\n                      </Label>\r\n                    )}\r\n                    {attr.attribute_type === \"select\" && attr.options?.length ? (\r\n                      <AttributeSelect\r\n                        label={getName(attr)}\r\n                        value={currentValue}\r\n                        options={attr.options}\r\n                        {...(attr.options_bg ? { optionsBg: attr.options_bg } : {})}\r\n                        onChange={(value) => handleAttributeChange(attr, value)}\r\n                        placeholder={`${isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╕\" : \"Select\"} ${getName(attr)}`}\r\n                        compact={compact}\r\n                        isBg={isBg}\r\n                      />\r\n                    ) : (\r\n                      <div className={cn(\r\n                        \"relative flex items-center h-12 px-4 rounded-md border transition-colors\",\r\n                        \"bg-background border-border shadow-xs focus-within:border-ring focus-within:ring-2 focus-within:ring-ring\"\r\n                      )}>\r\n                        <label className=\"text-2xs font-bold uppercase tracking-wider text-muted-foreground shrink-0 mr-2\">\r\n                          {getName(attr)}:\r\n                        </label>\r\n                        <Input\r\n                          value={currentValue}\r\n                          onChange={(e) => handleAttributeChange(attr, e.target.value)}\r\n                          placeholder={getPlaceholder(attr) || `${isBg ? \"╨Æ╤è╨▓╨╡╨┤╨╕\" : \"Enter\"} ${getName(attr)}`}\r\n                          type={attr.attribute_type === \"number\" ? \"number\" : \"text\"}\r\n                          className=\"h-auto p-0 border-none bg-transparent shadow-none focus-visible:ring-0 text-sm font-semibold flex-1 min-w-0\"\r\n                        />\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n\r\n      {/* Fallback: category has DB attributes but no required ones */}\r\n      {!isLoading && dbRequiredSmart.length === 0 && dbAttributes.length > 0 && (\r\n        <div className=\"space-y-4\">\r\n          <div className=\"flex items-center gap-2 text-xs font-bold text-muted-foreground uppercase tracking-wider\">\r\n            <Info className=\"size-4\" weight=\"bold\" />\r\n            {isBg ? \"╨í╨┐╨╡╤å╨╕╤ä╨╕╨║╨░╤å╨╕╨╕╤é╨╡ ╨┐╨╛╨╝╨░╨│╨░╤é ╨╜╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨╕╤é╨╡\" : \"Item specifics help buyers\"}\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n            {dbAttributes.map((attr) => {\r\n              const currentValue = attributes.find(a => a.attributeId === attr.id)?.value || \"\";\r\n              return (\r\n                <div key={attr.id} className=\"space-y-1.5\">\r\n                  {!compact && (\r\n                    <Label className=\"block text-xs font-bold text-muted-foreground uppercase tracking-wider\">\r\n                      {getName(attr)}\r\n                      {attr.is_required && <span className=\"text-destructive ml-1\">*</span>}\r\n                    </Label>\r\n                  )}\r\n                  {attr.attribute_type === \"select\" && attr.options?.length ? (\r\n                    <AttributeSelect\r\n                      label={getName(attr)}\r\n                      value={currentValue}\r\n                      options={attr.options}\r\n                      {...(attr.options_bg ? { optionsBg: attr.options_bg } : {})}\r\n                      onChange={(value) => handleAttributeChange(attr, value)}\r\n                      placeholder={getPlaceholder(attr) || `${isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╕\" : \"Select\"} ${getName(attr)}`}\r\n                      compact={compact}\r\n                      isBg={isBg}\r\n                    />\r\n                  ) : (\r\n                    <div className={cn(\r\n                      \"relative flex items-center h-12 px-4 rounded-md border transition-colors\",\r\n                      \"bg-background border-border shadow-xs focus-within:border-ring focus-within:ring-2 focus-within:ring-ring\"\r\n                    )}>\r\n                      <label className=\"text-2xs font-bold uppercase tracking-wider text-muted-foreground shrink-0 mr-2\">\r\n                        {getName(attr)}:\r\n                        {attr.is_required && <span className=\"text-destructive ml-1\">*</span>}\r\n                      </label>\r\n                      <Input\r\n                        value={currentValue}\r\n                        onChange={(e) => handleAttributeChange(attr, e.target.value)}\r\n                        placeholder={getPlaceholder(attr) || `${isBg ? \"╨Æ╤è╨▓╨╡╨┤╨╕\" : \"Enter\"} ${getName(attr)}`}\r\n                        type={attr.attribute_type === \"number\" ? \"number\" : \"text\"}\r\n                        className=\"h-auto p-0 border-none bg-transparent shadow-none focus-visible:ring-0 text-sm font-semibold flex-1 min-w-0\"\r\n                      />\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Custom attributes */}\r\n      {!isLoading && (\r\n        <div className=\"space-y-4 pt-4 border-t border-border/50\">\r\n          <Label className=\"text-xs font-bold text-muted-foreground uppercase tracking-wider\">\r\n            {isBg ? \"╨ö╨╛╨┐╤è╨╗╨╜╨╕╤é╨╡╨╗╨╜╨╕ ╤à╨░╤Ç╨░╨║╤é╨╡╤Ç╨╕╤ü╤é╨╕╨║╨╕\" : \"Custom Attributes\"}\r\n          </Label>\r\n\r\n          {customAttrs.length > 0 && (\r\n            <div className=\"grid gap-2\">\r\n              {customAttrs.map((attr, index) => (\r\n                <div key={index} className=\"flex items-center gap-3 rounded-md border border-border bg-surface-subtle p-3\">\r\n                  <div className=\"min-w-0 flex-1 flex items-center gap-2\">\r\n                    <span className=\"text-xs font-bold text-muted-foreground uppercase tracking-wider shrink-0\">{attr.name}:</span>\r\n                    <span className=\"truncate text-sm font-bold text-foreground\">{attr.value}</span>\r\n                  </div>\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => handleRemoveCustom(index)}\r\n                    className=\"size-8 flex items-center justify-center rounded-lg hover:bg-destructive-subtle text-muted-foreground hover:text-destructive transition-colors\"\n                    aria-label={isBg ? \"╨ƒ╤Ç╨╡╨╝╨░╤à╨╜╨╕\" : \"Remove\"}\r\n                  >\r\n                    <X className=\"size-4\" weight=\"bold\" />\r\n                  </button>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"flex flex-col gap-3 p-4 rounded-md bg-surface-subtle border border-dashed border-border\">\r\n            <div className=\"grid grid-cols-2 gap-3\">\r\n              <div className=\"space-y-1.5\">\r\n                <Label className=\"text-2xs font-bold text-muted-foreground uppercase tracking-wider\">{isBg ? \"╨ÿ╨╝╨╡\" : \"Name\"}</Label>\r\n                <Input\r\n                  value={newAttrName}\r\n                  onChange={(e) => setNewAttrName(e.target.value)}\r\n                  placeholder={isBg ? \"╨╜╨░╨┐╤Ç. ╨£╨░╤é╨╡╤Ç╨╕╨░╨╗\" : \"e.g., Material\"}\r\n                  className=\"h-10 rounded-lg border-border font-medium text-sm\"\r\n                />\r\n              </div>\r\n              <div className=\"space-y-1.5\">\r\n                <Label className=\"text-2xs font-bold text-muted-foreground uppercase tracking-wider\">{isBg ? \"╨í╤é╨╛╨╣╨╜╨╛╤ü╤é\" : \"Value\"}</Label>\r\n                <Input\r\n                  value={newAttrValue}\r\n                  onChange={(e) => setNewAttrValue(e.target.value)}\r\n                  placeholder={isBg ? \"╨╜╨░╨┐╤Ç. ╨ƒ╨░╨╝╤â╨║\" : \"e.g., Cotton\"}\r\n                  className=\"h-10 rounded-lg border-border font-medium text-sm\"\r\n                />\r\n              </div>\r\n            </div>\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"outline\"\r\n              onClick={handleAddCustom}\r\n              disabled={!newAttrName.trim() || !newAttrValue.trim()}\r\n              className=\"h-10 rounded-md border-selected-border text-primary font-bold text-xs uppercase tracking-widest hover:bg-hover active:bg-active\"\r\n            >\r\n              <Plus className=\"size-3.5 mr-2\" weight=\"bold\" />\r\n              {isBg ? \"╨ö╨╛╨▒╨░╨▓╨╕ ╤à╨░╤Ç╨░╨║╤é╨╡╤Ç╨╕╤ü╤é╨╕╨║╨░\" : \"Add attribute\"}\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </FieldContent>\r\n  );\r\n\r\n  return (\r\n    <Field className={className}>\r\n      {!compact ? (\r\n        <div className=\"rounded-md border border-border bg-background overflow-hidden shadow-xs\">\r\n          <div className=\"p-4 pb-3 border-b border-border/50 bg-surface-subtle\">\r\n            <div className=\"flex items-center gap-3.5\">\r\n              <div className=\"flex size-10 items-center justify-center rounded-md bg-background border border-border shadow-xs\">\r\n                <Sliders className=\"size-5 text-muted-foreground\" weight=\"bold\" />\r\n              </div>\r\n              <div>\r\n                <FieldLabel className=\"text-sm font-bold tracking-tight text-foreground\">\r\n                  {isBg ? \"╨Ñ╨░╤Ç╨░╨║╤é╨╡╤Ç╨╕╤ü╤é╨╕╨║╨╕\" : \"Item Specifics\"}\r\n                </FieldLabel>\r\n                <FieldDescription className=\"text-xs font-medium text-muted-foreground mt-0.5\">\r\n                  {isBg\r\n                    ? \"╨ö╨╛╨▒╨░╨▓╨╡╤é╨╡ ╨┤╨╡╤é╨░╨╣╨╗╨╕, ╨╖╨░ ╨┤╨░ ╨┐╨╛╨╝╨╛╨│╨╜╨╡╤é╨╡ ╨╜╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨╕╤é╨╡ ╨┤╨░ ╨╜╨░╨╝╨╡╤Ç╤Å╤é ╨┐╤Ç╨╛╨┤╤â╨║╤é╨░\"\r\n                    : \"Add details to help buyers find your product\"}\r\n                </FieldDescription>\r\n              </div>\r\n            </div>\r\n          </div>\r\n          {content}\r\n        </div>\r\n      ) : (\r\n        content\r\n      )}\r\n    </Field>\r\n  );\r\n}\r\n\r\nexport default memo(AttributesField);\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\fields\\brand-field.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_field' is defined but never used.","line":51,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MemoizedBrandField' is assigned a value but never used.","line":113,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":113,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useCallback, memo } from \"react\";\r\nimport { Controller } from \"react-hook-form\";\r\nimport { Tag } from \"lucide-react\";\r\nimport { Field, FieldLabel, FieldDescription, FieldError, FieldContent } from \"@/components/shared/field\";\nimport { cn } from \"@/lib/utils\";\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\nimport { BrandCombobox } from \"../ui/brand-combobox\";\nimport { useTranslations } from \"next-intl\";\n\r\n// ============================================================================\r\n// BRAND FIELD - Brand selector using shadcn Combobox pattern\r\n// ============================================================================\r\n// Uses the extracted BrandCombobox component for consistent shadcn/ui patterns\r\n\r\ninterface BrandFieldProps {\r\n  /** Custom class name for the field wrapper */\r\n  className?: string;\r\n  /** Use compact layout (no section wrapper) */\r\n  compact?: boolean;\r\n  /** Allow custom brand entry */\r\n  allowCustom?: boolean;\r\n}\r\n\r\nexport function BrandField({\r\n  className,\r\n  compact = false,\r\n  allowCustom = true\r\n}: BrandFieldProps) {\n  const { control, setValue, watch } = useSellForm();\n  const { brands, isBg, locale } = useSellFormContext();\n  const tSell = useTranslations(\"Sell\")\n\r\n  const brandId = watch(\"brandId\");\r\n  const brandName = watch(\"brandName\");\r\n\r\n  // Handle brand selection change\r\n  const handleValueChange = useCallback(\r\n    (newBrandId: string | null, newBrandName: string) => {\r\n      setValue(\"brandId\", newBrandId, { shouldValidate: true });\r\n      setValue(\"brandName\", newBrandName, { shouldValidate: false });\r\n    },\r\n    [setValue]\r\n  );\r\n\r\n  return (\r\n    <Controller\r\n      name=\"brandId\"\r\n      control={control}\r\n      render={({ field: _field, fieldState }) => (\r\n        <Field data-invalid={fieldState.invalid} className={className}>\r\n          {/* Section Header (non-compact mode) */}\r\n          {!compact && (\r\n            <div className=\"p-4 pb-3 border-b border-border/50 bg-surface-subtle\">\r\n              <div className=\"flex items-center gap-3.5\">\r\n                <div className=\"flex size-10 items-center justify-center rounded-md bg-background border border-border shadow-xs\">\r\n                  <Tag className=\"size-5 text-muted-foreground\" />\r\n                </div>\r\n                <div>\r\n                  <FieldLabel className=\"text-sm font-bold tracking-tight text-foreground\">\r\n                    {isBg ? \"╨£╨░╤Ç╨║╨░\" : \"Brand\"}\r\n                  </FieldLabel>\r\n                  <FieldDescription className=\"text-xs font-medium text-muted-foreground mt-0.5\">\r\n                    {isBg\r\n                      ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨╝╨░╤Ç╨║╨░╤é╨░ ╨╜╨░ ╨▓╨░╤ê╨╕╤Å ╨┐╤Ç╨╛╨┤╤â╨║╤é\"\r\n                      : \"Select your product's brand\"}\r\n                  </FieldDescription>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Compact Label - hidden if we use label inside */}\r\n          {compact && (\r\n            <div className=\"hidden\">\r\n              <FieldLabel className=\"text-xs font-bold text-muted-foreground uppercase tracking-wider mb-2 block\">\r\n                {isBg ? \"╨£╨░╤Ç╨║╨░\" : \"Brand\"}\r\n              </FieldLabel>\r\n            </div>\r\n          )}\r\n\r\n          {/* Brand Combobox - Using extracted shadcn-compliant component */}\r\n          <FieldContent className={cn(!compact && \"p-5\")}>\r\n            <BrandCombobox\r\n              brands={brands}\r\n              value={brandId ?? null}\r\n              {...(brandName ? { customValue: brandName } : {})}\r\n              onValueChange={handleValueChange}\r\n              allowCustom={allowCustom}\r\n              locale={locale}\r\n            />\r\n\r\n            {/* Error Message */}\n            {fieldState.invalid && (\n              <FieldError className=\"mt-2\">\n                {fieldState.error?.message ? tSell(fieldState.error.message as never) : null}\n              </FieldError>\n            )}\n          </FieldContent>\n        </Field>\n      )}\n    />\r\n  );\r\n}\r\n\r\n/**\r\n * Memoized BrandField - Brand selector using shadcn Combobox pattern.\r\n * Optimized to prevent unnecessary re-renders when unrelated form state changes.\r\n * @see useSellForm - Hook for form state access\r\n * @see useSellFormContext - Hook for context access\r\n */\r\nconst MemoizedBrandField = memo(BrandField);\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\fields\\category-field.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move async arrow function 'prefetchCategoryAttributes' to the outer scope.","line":39,"column":65,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":39,"endColumn":67},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MemoizedCategoryField' is assigned a value but never used.","line":164,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":164,"endColumn":28}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { memo } from \"react\";\nimport { Controller } from \"react-hook-form\";\nimport { FolderSimple } from \"@phosphor-icons/react\";\nimport { Field, FieldLabel, FieldDescription, FieldError, FieldContent } from \"@/components/shared/field\";\nimport { useTranslations } from \"next-intl\";\n\r\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\r\nimport { CategorySelector } from \"../ui/category-modal\";\r\nimport type { CategoryPathItem } from \"../../_lib/types\";\r\n\r\n// ============================================================================\r\n// CATEGORY FIELD - Category picker using context pattern\r\n// ============================================================================\r\n\r\ninterface CategoryFieldProps {\r\n  /** Callback when category changes (for side effects like loading attributes) */\r\n  onCategoryChange?: (categoryId: string, path: CategoryPathItem[]) => void;\r\n  /** Custom class name for the field wrapper */\r\n  className?: string;\r\n  /** Use compact layout (no card wrapper) */\r\n  compact?: boolean;\r\n}\r\n\r\nexport function CategoryField({ onCategoryChange, className, compact = false }: CategoryFieldProps) {\n  const { control, setValue, watch } = useSellForm();\n  const { categories, isBg } = useSellFormContext();\n  const tSell = useTranslations(\"Sell\")\n\r\n  const categoryPathRaw = watch(\"categoryPath\");\r\n  const categoryPath: CategoryPathItem[] | undefined = categoryPathRaw?.map((item) => ({\r\n    id: item.id,\r\n    name: item.name,\r\n    slug: item.slug,\r\n    name_bg: item.name_bg ?? null,\r\n  }));\r\n\r\n  const prefetchCategoryAttributes = async (categoryId: string) => {\r\n    if (!categoryId) return;\r\n    try {\r\n      // Warm the cache for the attributes field.\r\n      // This endpoint accepts UUID or slug; categoryId is UUID here.\r\n      await fetch(`/api/categories/${encodeURIComponent(categoryId)}/attributes`, {\r\n        method: \"GET\",\r\n        credentials: \"same-origin\",\r\n      });\r\n    } catch {\r\n      // Non-blocking: it's only a prefetch.\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Controller\r\n      name=\"categoryId\"\r\n      control={control}\r\n      render={({ field, fieldState }) => (\r\n        <Field data-invalid={fieldState.invalid} className={className}>\r\n          {!compact ? (\r\n            <div className=\"rounded-md border border-form-section-border bg-form-section-bg overflow-hidden shadow-xs\">\r\n              {/* Header */}\r\n              <div className=\"p-section pb-form border-b border-border/50 bg-surface-subtle\">\r\n                <div className=\"flex items-center gap-form-sm\">\r\n                  <div className=\"flex size-10 items-center justify-center rounded-md bg-background border border-border shadow-xs\">\r\n                    <FolderSimple className=\"size-5 text-muted-foreground\" weight=\"bold\" />\r\n                  </div>\r\n                  <div>\r\n                    <FieldLabel className=\"text-sm font-bold tracking-tight text-foreground\">\r\n                      {isBg ? \"╨Ü╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å\" : \"Category\"}\r\n                    </FieldLabel>\r\n                    <FieldDescription className=\"text-xs font-medium text-muted-foreground mt-0.5\">\r\n                      {isBg\r\n                        ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨╜╨░╨╣-╨┐╨╛╨┤╤à╨╛╨┤╤Å╤ë╨░╤é╨░ ╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å ╨╖╨░ ╨▓╨░╤ê╨╕╤Å ╨┐╤Ç╨╛╨┤╤â╨║╤é\"\r\n                        : \"Choose the most appropriate category for your product\"}\r\n                    </FieldDescription>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Category Selector */}\r\n              <FieldContent className=\"p-section\">\r\n                <CategorySelector\r\n                  categories={categories}\r\n                  value={field.value || \"\"}\r\n                  {...(categoryPath ? { selectedPath: categoryPath } : {})}\r\n                  onChange={(categoryId, path) => {\r\n                    const normalizedPath: CategoryPathItem[] = path.map((item) => ({\r\n                      id: item.id,\r\n                      name: item.name,\r\n                      slug: item.slug,\r\n                      name_bg: item.name_bg ?? null,\r\n                    }))\r\n\r\n                    // Reset item specifics when switching categories to prevent stale fields/values.\r\n                    setValue(\"attributes\", [], { shouldValidate: true, shouldDirty: true });\r\n                    field.onChange(categoryId);\r\n                    setValue(\"categoryPath\", normalizedPath, { shouldValidate: false });\r\n                    onCategoryChange?.(categoryId, normalizedPath);\r\n                    void prefetchCategoryAttributes(categoryId);\r\n                  }}\r\n                  locale={isBg ? \"bg\" : \"en\"}\r\n                />\r\n\r\n                {/* Error Message */}\n                {fieldState.invalid && (\n                  <FieldError className=\"mt-form-sm\">\n                    {fieldState.error?.message ? tSell(fieldState.error.message as never) : null}\n                  </FieldError>\n                )}\n              </FieldContent>\n            </div>\n          ) : (\n            <>\r\n              {/* Compact Label - hidden if we use label inside */}\r\n              <div className=\"hidden\">\r\n                <FieldLabel className=\"text-sm font-semibold mb-form-sm\">\r\n                  {isBg ? \"╨Ü╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å\" : \"Category\"}\r\n                </FieldLabel>\r\n              </div>\r\n\r\n              <FieldContent>\r\n                <CategorySelector\r\n                  categories={categories}\r\n                  value={field.value || \"\"}\r\n                  {...(categoryPath ? { selectedPath: categoryPath } : {})}\r\n                  onChange={(categoryId, path) => {\r\n                    const normalizedPath: CategoryPathItem[] = path.map((item) => ({\r\n                      id: item.id,\r\n                      name: item.name,\r\n                      slug: item.slug,\r\n                      name_bg: item.name_bg ?? null,\r\n                    }))\r\n\r\n                    // Reset item specifics when switching categories to prevent stale fields/values.\r\n                    setValue(\"attributes\", [], { shouldValidate: true, shouldDirty: true });\r\n                    field.onChange(categoryId);\r\n                    setValue(\"categoryPath\", normalizedPath, { shouldValidate: false });\r\n                    onCategoryChange?.(categoryId, normalizedPath);\r\n                    void prefetchCategoryAttributes(categoryId);\r\n                  }}\r\n                  locale={isBg ? \"bg\" : \"en\"}\r\n                />\n\n                {fieldState.invalid && (\n                  <FieldError className=\"mt-3\">\n                    {fieldState.error?.message ? tSell(fieldState.error.message as never) : null}\n                  </FieldError>\n                )}\n              </FieldContent>\n            </>\n          )}\n        </Field>\r\n      )}\r\n    />\r\n  );\r\n}\r\n\r\n/**\r\n * Memoized CategoryField - Category picker using context pattern.\r\n * Optimized to prevent unnecessary re-renders when unrelated form state changes.\r\n * @see useSellForm - Hook for form state access\r\n * @see useSellFormContext - Hook for context access\r\n */\r\nconst MemoizedCategoryField = memo(CategoryField);\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\fields\\condition-field.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 27 to the 25 allowed.","line":42,"column":39,"nodeType":null,"messageId":"refactorFunction","endLine":42,"endColumn":41},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MemoizedConditionField' is assigned a value but never used.","line":226,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":226,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { memo, useState } from \"react\";\nimport { Controller } from \"react-hook-form\";\nimport { Sparkle, Check, CaretRight } from \"@phosphor-icons/react\";\nimport { Field, FieldLabel, FieldDescription, FieldError, FieldContent } from \"@/components/shared/field\";\nimport { cn } from \"@/lib/utils\";\nimport { conditionOptions } from \"@/lib/sell/schema-v4\";\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\nimport { useTranslations } from \"next-intl\";\nimport {\n  Drawer,\n  DrawerContent,\n  DrawerHeader,\n  DrawerTitle,\n  DrawerDescription,\r\n  DrawerTrigger,\r\n} from \"@/components/ui/drawer\";\r\n\r\n// ============================================================================\r\n// CONDITION FIELD - Item condition selector with proper mobile touch targets\r\n// Best practices: min 44px touch targets, clear selection states\r\n// ============================================================================\r\n\r\ninterface ConditionFieldProps {\r\n  /** Custom class name for the field wrapper */\r\n  className?: string;\r\n  /** Use compact mobile-style layout */\r\n  compact?: boolean;\r\n}\r\n\r\nexport function ConditionField({ className, compact = false }: ConditionFieldProps) {\n  const { control } = useSellForm();\n  const { isBg } = useSellFormContext();\n  const [isOpen, setIsOpen] = useState(false);\n  const tSell = useTranslations(\"Sell\")\n\n  return (\n    <Controller\n      name=\"condition\"\n      control={control}\n      render={({ field, fieldState }) => {\n        const selectedOption = conditionOptions.find(opt => opt.value === field.value);\n        const selectedLabel = selectedOption ? tSell(selectedOption.labelKey as never) : null;\n\n        return (\n          <Field data-invalid={fieldState.invalid} className={className}>\n            {/* Section Header (non-compact mode) */}\r\n            {!compact && (\r\n              <div className=\"flex items-center gap-3.5 mb-4\">\r\n                <div className=\"flex size-10 items-center justify-center rounded-md bg-form-section-bg border border-form-section-border shadow-xs\">\r\n                  <Sparkle className=\"size-5 text-muted-foreground\" weight=\"bold\" />\r\n                </div>\r\n                <div>\r\n                  <FieldLabel className=\"text-sm font-bold tracking-tight text-foreground\">\r\n                    {isBg ? \"╨í╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡\" : \"Condition\"}\r\n                  </FieldLabel>\r\n                  <FieldDescription className=\"text-sm text-muted-foreground mt-0.5\">\r\n                    {isBg\r\n                      ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╤ü╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡╤é╨╛ ╨╜╨░ ╨▓╨░╤ê╨╕╤Å ╨┐╤Ç╨╛╨┤╤â╨║╤é\"\r\n                      : \"Select the condition of your item\"}\r\n                  </FieldDescription>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Compact Label */}\r\n            {compact && (\r\n              <div className=\"hidden\">\r\n                <FieldLabel className=\"text-sm font-semibold mb-form-sm\">\r\n                  {isBg ? \"╨í╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡\" : \"Condition\"}\r\n                </FieldLabel>\r\n              </div>\r\n            )}\r\n\r\n            <FieldContent>\r\n              {compact ? (\r\n                /* Mobile: Drawer Pattern with \"SelectionCard\" Trigger */\r\n                <Drawer open={isOpen} onOpenChange={setIsOpen}>\r\n                  <DrawerTrigger asChild>\r\n                    <button\r\n                      type=\"button\"\r\n                      className={cn(\r\n                        \"w-full flex items-center gap-3.5 min-h-16 px-4 py-3 rounded-xl border text-left transition-colors\",\r\n                        \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring\",\r\n                        fieldState.invalid \n                          ? \"border-destructive/50 bg-destructive-subtle\" \n                          : selectedLabel \n                            ? \"border-selected-border bg-selected\" \n                            : \"border-border bg-card hover:bg-hover\"\n                      )}\r\n                    >\r\n                      <div className={cn(\r\n                        \"size-11 rounded-xl flex items-center justify-center shrink-0 transition-colors\",\r\n                        selectedLabel ? \"bg-selected text-primary\" : \"bg-muted text-muted-foreground\"\r\n                      )}>\r\n                        <Sparkle className=\"size-5\" weight={selectedLabel ? \"fill\" : \"regular\"} />\r\n                      </div>\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <div className=\"flex items-center gap-1.5\">\r\n                          <span className=\"text-xs font-bold uppercase tracking-wider text-muted-foreground\">\r\n                            {isBg ? \"╨í╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡\" : \"Condition\"}\r\n                          </span>\r\n                          <span className=\"text-destructive text-xs\">*</span>\r\n                        </div>\r\n                        <span className={cn(\r\n                          \"text-base font-semibold truncate block mt-0.5\",\r\n                          selectedLabel ? \"text-foreground\" : \"text-text-subtle\"\r\n                        )}>\r\n                          {selectedLabel || (isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡...\" : \"Select condition\")}\r\n                        </span>\r\n                      </div>\r\n                      <CaretRight className={cn(\r\n                        \"size-5 shrink-0 transition-colors\",\r\n                        selectedLabel ? \"text-primary\" : \"text-text-subtle\"\r\n                      )} weight=\"bold\" />\r\n                    </button>\r\n                  </DrawerTrigger>\r\n                  <DrawerContent className=\"max-h-dialog\">\r\n                    <DrawerHeader className=\"border-b border-border/50 pb-4\">\r\n                      <DrawerTitle className=\"text-xl font-bold\">{isBg ? \"╨í╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡\" : \"Item condition\"}</DrawerTitle>\r\n                      <DrawerDescription className=\"text-sm\">\r\n                        {isBg ? \"╨æ╤è╨┤╨╡╤é╨╡ ╤é╨╛╤ç╨╜╨╕ ΓÇö ╤é╨╛╨▓╨░ ╨╕╨╖╨│╤Ç╨░╨╢╨┤╨░ ╨┤╨╛╨▓╨╡╤Ç╨╕╨╡\" : \"Be accurate ΓÇö it builds trust with buyers\"}\r\n                      </DrawerDescription>\r\n                    </DrawerHeader>\r\n                    <div className=\"p-4 space-y-3 max-h-dialog-sm overflow-y-auto\" data-vaul-no-drag>\r\n                      {conditionOptions.map((option) => {\n                        const isSelected = field.value === option.value;\n                        const label = tSell(option.labelKey as never);\n\n                        return (\n                          <button\n                            key={option.value}\n                            type=\"button\"\r\n                            onClick={() => {\r\n                              field.onChange(option.value);\r\n                              setIsOpen(false);\r\n                            }}\r\n                            className={cn(\r\n                              \"w-full flex items-center gap-4 p-4 rounded-2xl border transition-colors text-left\",\r\n                              isSelected\r\n                                ? \"border-selected-border bg-selected ring-2 ring-ring\"\r\n                                : \"border-transparent bg-surface-subtle hover:bg-hover\"\r\n                            )}\r\n                          >\r\n                            <div className={cn(\r\n                              \"size-12 rounded-xl flex items-center justify-center shrink-0 transition-colors\",\r\n                              isSelected ? \"bg-selected\" : \"bg-surface-subtle\"\r\n                            )}>\r\n                              <Sparkle \r\n                                className={cn(\r\n                                  \"size-6 transition-colors\",\r\n                                  isSelected ? \"text-primary\" : \"text-muted-foreground\"\r\n                                )} \r\n                                weight={isSelected ? \"fill\" : \"regular\"} \r\n                              />\r\n                            </div>\r\n                            <div className=\"flex-1 min-w-0 py-0.5\">\r\n                              <div className={cn(\r\n                                \"text-base font-bold\",\r\n                                isSelected ? \"text-primary\" : \"text-foreground\"\r\n                              )}>\r\n                                {label}\r\n                              </div>\r\n                            </div>\r\n                            {isSelected && (\r\n                              <div className=\"size-7 rounded-full bg-primary flex items-center justify-center shrink-0\">\r\n                                <Check className=\"size-4 text-primary-foreground\" weight=\"bold\" />\r\n                              </div>\r\n                            )}\r\n                          </button>\r\n                        );\r\n                      })}\r\n                    </div>\r\n                    <div className=\"h-safe-b\" />\r\n                  </DrawerContent>\r\n                </Drawer>\r\n              ) : (\r\n                /* Desktop: Grid Pattern */\r\n                <div className=\"grid gap-2.5 grid-cols-2 sm:grid-cols-3\">\r\n                  {conditionOptions.map((option) => {\r\n                    const isSelected = field.value === option.value;\n                    const label = tSell(option.labelKey as never);\n\n                    return (\n                      <button\n                        key={option.value}\r\n                        type=\"button\"\r\n                        onClick={() => field.onChange(option.value)}\r\n                        className={cn(\r\n                          \"flex items-center justify-center h-12 px-4 rounded-md border transition-colors text-center\",\r\n                          \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:ring-offset-background\",\r\n                          \"touch-manipulation\",\r\n                          isSelected\r\n                            ? \"border-selected-border bg-selected text-primary font-bold shadow-xs\"\r\n                            : \"border-border bg-background hover:border-hover-border text-muted-foreground hover:text-foreground\"\r\n                        )}\r\n                      >\r\n                        <span className=\"text-sm leading-tight\">\r\n                          {label}\r\n                        </span>\r\n                      </button>\r\n                    );\r\n                  })}\r\n                </div>\r\n              )}\r\n\r\n              {/* Error Message */}\r\n              {fieldState.invalid && (\n                <FieldError className=\"mt-3\">\n                  {fieldState.error?.message ? tSell(fieldState.error.message as never) : null}\n                </FieldError>\n              )}\n            </FieldContent>\n          </Field>\n        );\n      }}\r\n    />\r\n  );\r\n}/**\r\n * Memoized ConditionField - Item condition selector using context pattern.\r\n * Optimized to prevent unnecessary re-renders when unrelated form state changes.\r\n * @see useSellForm - Hook for form state access\r\n * @see useSellFormContext - Hook for context access\r\n */\r\nconst MemoizedConditionField = memo(ConditionField);\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\fields\\description-field.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MemoizedDescriptionField' is assigned a value but never used.","line":170,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":170,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { memo } from \"react\";\r\nimport { Controller } from \"react-hook-form\";\r\nimport { TextAlignLeft, TextB, TextItalic, List } from \"@phosphor-icons/react\";\nimport { Field, FieldLabel, FieldDescription, FieldError, FieldContent } from \"@/components/shared/field\";\nimport { cn } from \"@/lib/utils\";\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\nimport { useTranslations } from \"next-intl\";\n\r\n// ============================================================================\r\n// DESCRIPTION FIELD - Rich text area for product description\r\n// ============================================================================\r\n\r\ninterface DescriptionFieldProps {\r\n  /** Custom class name for the field wrapper */\r\n  className?: string;\r\n  /** Prefix for DOM ids (prevents duplicates across layouts) */\r\n  idPrefix?: string;\r\n  /** Maximum characters allowed */\r\n  maxLength?: number;\r\n  /** Minimum rows for the textarea */\r\n  minRows?: number;\r\n  /** Use compact layout (no section wrapper) */\r\n  compact?: boolean;\r\n}\r\n\r\nexport function DescriptionField({\r\n  className,\r\n  idPrefix = \"sell-form\",\r\n  maxLength = 2000,\r\n  minRows = 4,\r\n  compact = false\r\n}: DescriptionFieldProps) {\n  const { control, watch } = useSellForm();\n  const { isBg } = useSellFormContext();\n  const tSell = useTranslations(\"Sell\")\n\r\n  const currentValue = watch(\"description\") || \"\";\r\n  const charCount = currentValue.length;\r\n  const textareaId = `${idPrefix}-description`;\r\n\r\n  return (\r\n    <Controller\r\n      name=\"description\"\r\n      control={control}\r\n      render={({ field, fieldState }) => (\r\n        <Field data-invalid={fieldState.invalid} className={className}>\r\n          {/* Section Header (non-compact mode) */}\r\n          {!compact && (\r\n            <div className=\"p-4 pb-3 border-b border-border/50 bg-surface-subtle\">\r\n              <div className=\"flex items-center gap-3.5\">\r\n                <div className=\"flex size-10 items-center justify-center rounded-md bg-background border border-border shadow-xs\">\r\n                  <TextAlignLeft className=\"size-5 text-muted-foreground\" weight=\"bold\" />\r\n                </div>\r\n                <div>\r\n                  <FieldLabel className=\"text-sm font-bold tracking-tight text-foreground\">\r\n                    {isBg ? \"╨₧╨┐╨╕╤ü╨░╨╜╨╕╨╡\" : \"Description\"}\r\n                  </FieldLabel>\r\n                  <FieldDescription className=\"text-xs font-medium text-muted-foreground mt-0.5\">\r\n                    {isBg\r\n                      ? \"╨₧╨┐╨╕╤ê╨╡╤é╨╡ ╨┤╨╡╤é╨░╨╣╨╗╨╕╤é╨╡ - ╤Ç╨░╨╖╨╝╨╡╤Ç, ╤å╨▓╤Å╤é, ╨┤╨╡╤ä╨╡╨║╤é╨╕\"\r\n                      : \"Describe the details - size, color, flaws\"}\r\n                  </FieldDescription>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Compact Label */}\r\n          {compact && (\r\n            <div className=\"hidden\">\r\n              <FieldLabel className=\"text-xs font-bold text-muted-foreground uppercase tracking-wider mb-2 block\">\r\n                {isBg ? \"╨₧╨┐╨╕╤ü╨░╨╜╨╕╨╡\" : \"Description\"}\r\n              </FieldLabel>\r\n            </div>\r\n          )}\r\n\r\n          {/* Rich Textarea with label inside */}\r\n          <FieldContent className={cn(!compact && \"p-5\")}>\r\n            <div className={cn(\r\n              \"rounded-md border shadow-xs overflow-hidden transition-colors bg-background\",\r\n              \"focus-within:border-ring focus-within:ring-2 focus-within:ring-ring\",\r\n              fieldState.invalid && \"border-destructive focus-within:ring-destructive-subtle\"\n            )}>\n              <div className=\"px-4 pt-3\">\r\n                <label\r\n                  htmlFor={textareaId}\r\n                  className=\"text-2xs font-bold uppercase tracking-wider text-muted-foreground leading-none\"\r\n                >\r\n                  {isBg ? \"╨₧╨┐╨╕╤ü╨░╨╜╨╕╨╡\" : \"Description\"}\r\n                </label>\r\n              </div>\r\n              <textarea\r\n                {...field}\r\n                id={textareaId}\r\n                aria-invalid={fieldState.invalid}\r\n                placeholder={isBg\r\n                  ? \"╨ö╨╛╨▒╨░╨▓╨╡╤é╨╡ ╨╛╨┐╨╕╤ü╨░╨╜╨╕╨╡ ╨╜╨░ ╨▓╨░╤ê╨╕╤Å ╨┐╤Ç╨╛╨┤╤â╨║╤é...\"\r\n                  : \"Add a description of your product...\"}\r\n                maxLength={maxLength}\r\n                rows={minRows}\r\n                className={cn(\r\n                  \"block w-full resize-none border-0 bg-transparent px-4 py-2 text-sm font-semibold\",\r\n                  \"placeholder:text-muted-foreground focus:ring-0 focus:outline-none\",\r\n                  \"min-h-32\"\r\n                )}\r\n              />\r\n\r\n              {/* Toolbar */}\r\n              <div className=\"flex items-center justify-between border-t border-border/50 bg-surface-subtle px-4 py-2\">\r\n                <div className=\"flex gap-1\">\r\n                  <button\r\n                    type=\"button\"\r\n                    className=\"size-8 flex items-center justify-center rounded-lg text-muted-foreground hover:bg-background hover:text-primary hover:shadow-sm transition-all\"\r\n                    title={isBg ? \"╨ú╨┤╨╡╨▒╨╡╨╗╨╡╨╜\" : \"Bold\"}\r\n                    aria-label={isBg ? \"╨ú╨┤╨╡╨▒╨╡╨╗╨╡╨╜ ╤é╨╡╨║╤ü╤é\" : \"Bold text\"}\r\n                  >\r\n                    <TextB className=\"size-3.5\" weight=\"bold\" />\r\n                  </button>\r\n                  <button\r\n                    type=\"button\"\r\n                    className=\"size-8 flex items-center justify-center rounded-lg text-muted-foreground hover:bg-background hover:text-primary hover:shadow-sm transition-all\"\r\n                    title={isBg ? \"╨Ü╤â╤Ç╤ü╨╕╨▓\" : \"Italic\"}\r\n                    aria-label={isBg ? \"╨Ü╤â╤Ç╤ü╨╕╨▓ ╤é╨╡╨║╤ü╤é\" : \"Italic text\"}\r\n                  >\r\n                    <TextItalic className=\"size-3.5\" weight=\"bold\" />\r\n                  </button>\r\n                  <button\r\n                    type=\"button\"\r\n                    className=\"size-8 flex items-center justify-center rounded-lg text-muted-foreground hover:bg-background hover:text-primary hover:shadow-sm transition-all\"\r\n                    title={isBg ? \"╨í╨┐╨╕╤ü╤è╨║\" : \"List\"}\r\n                    aria-label={isBg ? \"╨ö╨╛╨▒╨░╨▓╨╕ ╤ü╨┐╨╕╤ü╤è╨║\" : \"Add list\"}\r\n                  >\r\n                    <List className=\"size-3.5\" weight=\"bold\" />\r\n                  </button>\r\n                </div>\r\n                <span\r\n                  className={cn(\r\n                    \"text-2xs font-bold tabular-nums uppercase tracking-widest\",\r\n                    charCount >= maxLength\r\n                      ? \"text-destructive\"\r\n                      : \"text-muted-foreground\"\r\n                  )}\r\n                >\r\n                  {charCount.toLocaleString()} / {maxLength.toLocaleString()}\r\n                </span>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Error Message */}\n            {fieldState.invalid && (\n              <FieldError className=\"mt-2\">\n                {fieldState.error?.message ? tSell(fieldState.error.message as never) : null}\n              </FieldError>\n            )}\n          </FieldContent>\n        </Field>\n      )}\n    />\r\n  );\r\n}\r\n\r\n/**\r\n * Memoized DescriptionField - Rich textarea with formatting toolbar.\r\n * Optimized to prevent unnecessary re-renders when unrelated form state changes.\r\n * @see useSellForm - Hook for form state access\r\n * @see useSellFormContext - Hook for context access\r\n */\r\nconst MemoizedDescriptionField = memo(DescriptionField);\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\fields\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\fields\\photos-field.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'images' logical expression could make the dependencies of useCallback Hook (at line 187) change on every render. To fix this, wrap the initialization of 'images' in its own useMemo() Hook.","line":82,"column":9,"nodeType":"VariableDeclarator","endLine":82,"endColumn":39},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'images' logical expression could make the dependencies of useCallback Hook (at line 211) change on every render. To fix this, wrap the initialization of 'images' in its own useMemo() Hook.","line":82,"column":9,"nodeType":"VariableDeclarator","endLine":82,"endColumn":39},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'images' logical expression could make the dependencies of useCallback Hook (at line 221) change on every render. To fix this, wrap the initialization of 'images' in its own useMemo() Hook.","line":82,"column":9,"nodeType":"VariableDeclarator","endLine":82,"endColumn":39},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'images' logical expression could make the dependencies of useCallback Hook (at line 249) change on every render. To fix this, wrap the initialization of 'images' in its own useMemo() Hook.","line":82,"column":9,"nodeType":"VariableDeclarator","endLine":82,"endColumn":39},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | undefined`.","line":116,"column":23,"nodeType":"LogicalExpression","messageId":"unsafeArgument","endLine":116,"endColumn":53},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MemoizedPhotosField' is assigned a value but never used.","line":433,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":433,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useCallback, useState, useRef, memo } from \"react\";\r\nimport { useDropzone } from \"react-dropzone\";\r\nimport { Camera, SpinnerGap, WarningCircle } from \"@phosphor-icons/react\";\r\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Field, FieldLabel, FieldDescription, FieldError, FieldContent } from \"@/components/shared/field\";\nimport { useTranslations } from \"next-intl\";\n\r\nimport type { ProductImage } from \"@/lib/sell/schema-v4\";\r\nimport { compressImage } from \"@/lib/image-compression\";\r\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\r\nimport { PhotoThumbnail, UploadZone, ImagePreviewModal } from \"../ui\";\r\n// Note: AiListingAssistant will be updated in Phase 3 to use context pattern\r\n\r\n// ============================================================================\r\n// Upload Progress Types\r\n// ============================================================================\r\ninterface UploadProgress {\r\n  file: File;\r\n  progress: number;\r\n  status: \"uploading\" | \"processing\" | \"done\" | \"error\";\r\n  error?: string;\r\n}\r\n\r\n// ============================================================================\r\n// Upload Progress Item Component\r\n// ============================================================================\r\nfunction UploadProgressItem({ upload }: { upload: UploadProgress }) {\r\n  return (\r\n    <div className=\"flex items-center gap-3 p-2 rounded-lg bg-surface-subtle\">\r\n      <div className=\"h-10 w-10 rounded bg-muted flex items-center justify-center shrink-0\">\r\n        {upload.status === \"done\" ? (\r\n          <Camera className=\"h-5 w-5 text-primary\" weight=\"fill\" />\r\n        ) : upload.status === \"error\" ? (\r\n          <WarningCircle className=\"h-5 w-5 text-destructive\" weight=\"fill\" />\r\n        ) : (\r\n          <SpinnerGap className=\"h-5 w-5 animate-spin text-primary\" />\r\n        )}\r\n      </div>\r\n      <div className=\"flex-1 min-w-0\">\r\n        <div className=\"text-xs font-medium truncate\">{upload.file.name}</div>\r\n        <div className=\"mt-1\">\r\n          {upload.status === \"error\" ? (\r\n            <span className=\"text-xs text-destructive\">{upload.error}</span>\r\n          ) : upload.status === \"done\" ? (\r\n            <span className=\"text-xs text-primary\">Uploaded</span>\r\n          ) : (\r\n            <Progress value={upload.progress} className=\"h-1\" />\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// PHOTOS FIELD - Unified photo upload using context pattern\r\n// ============================================================================\r\n\r\ninterface PhotosFieldProps {\r\n  maxPhotos?: number;\r\n  onUploadStart?: () => void;\r\n  onUploadEnd?: () => void;\r\n  /** Use compact layout (no card wrapper/header). Useful when parent section already provides a card. */\r\n  compact?: boolean;\r\n}\r\n\r\nexport function PhotosField({\r\n  maxPhotos = 12,\r\n  onUploadStart,\r\n  onUploadEnd,\r\n  compact = false,\r\n}: PhotosFieldProps) {\n  // Use context instead of prop drilling\n  const { watch, setValue, formState: { errors } } = useSellForm();\n  const { isBg } = useSellFormContext();\n  const tSell = useTranslations(\"Sell\")\n\r\n  // Local state\r\n  const images = watch(\"images\") || [];\r\n  const [uploads, setUploads] = useState<UploadProgress[]>([]);\r\n  const [draggingIndex, setDraggingIndex] = useState<number | null>(null);\r\n  const [previewImage, setPreviewImage] = useState<ProductImage | null>(null);\r\n  const dragOverIndex = useRef<number | null>(null);\r\n\r\n  // ============================================================================\r\n  // Upload Logic\r\n  // ============================================================================\r\n\r\n  const uploadFile = useCallback(async (file: File): Promise<ProductImage | null> => {\r\n    // Compress image on client-side BEFORE upload\r\n    let compressedFile: File;\r\n    try {\r\n      compressedFile = await compressImage(file, {\r\n        maxWidth: 1920,\r\n        maxHeight: 1920,\r\n        quality: 0.85,\r\n        type: \"image/webp\",\r\n      });\r\n    } catch {\r\n      compressedFile = file;\r\n    }\r\n\r\n    const formData = new FormData();\r\n    formData.append(\"file\", compressedFile);\r\n\r\n    const response = await fetch(\"/api/upload-image\", {\r\n      method: \"POST\",\r\n      body: formData,\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const error = await response.json();\r\n      throw new Error(error.error || \"Upload failed\");\r\n    }\r\n\r\n    const data = await response.json();\r\n    return {\r\n      url: data.url,\r\n      thumbnailUrl: data.thumbnailUrl || data.url,\r\n      isPrimary: false,\r\n    };\r\n  }, []);\r\n\r\n  const onDrop = useCallback(async (acceptedFiles: File[]) => {\r\n    const remainingSlots = maxPhotos - images.length;\r\n    const filesToUpload = acceptedFiles.slice(0, remainingSlots);\r\n\r\n    if (filesToUpload.length === 0) return;\r\n\r\n    onUploadStart?.();\r\n\r\n    // Initialize progress tracking\r\n    const initialUploads: UploadProgress[] = filesToUpload.map(file => ({\r\n      file,\r\n      progress: 0,\r\n      status: \"uploading\" as const,\r\n    }));\r\n    setUploads(initialUploads);\r\n\r\n    // Upload all files\r\n    const uploadPromises = filesToUpload.map(async (file, idx) => {\r\n      try {\r\n        const progressInterval = setInterval(() => {\r\n          setUploads(prev => prev.map((u, i) =>\r\n            i === idx && u.progress < 90\r\n              ? { ...u, progress: u.progress + 10 }\r\n              : u\r\n          ));\r\n        }, 100);\r\n\r\n        const result = await uploadFile(file);\r\n\r\n        clearInterval(progressInterval);\r\n        setUploads(prev => prev.map((u, i) =>\r\n          i === idx ? { ...u, progress: 100, status: \"done\" as const } : u\r\n        ));\r\n\r\n        return result;\r\n      } catch (error) {\r\n        setUploads(prev => prev.map((u, i) =>\r\n          i === idx ? {\r\n            ...u,\r\n            status: \"error\" as const,\r\n            error: error instanceof Error ? error.message : \"Upload failed\"\r\n          } : u\r\n        ));\r\n        return null;\r\n      }\r\n    });\r\n\r\n    const results = await Promise.all(uploadPromises);\r\n    const successfulUploads = results.filter((r): r is ProductImage => r !== null);\r\n\r\n    // Add to form\r\n    const newImages = [...images, ...successfulUploads];\r\n    if (newImages.length > 0 && !newImages.some(i => i.isPrimary) && newImages[0]) {\r\n        newImages[0] = { ...newImages[0], isPrimary: true };\r\n      }\r\n    setValue(\"images\", newImages, { shouldValidate: true });\r\n\r\n    // Clear upload progress after delay\r\n    setTimeout(() => setUploads([]), 1500);\r\n    onUploadEnd?.();\r\n  }, [images, maxPhotos, setValue, uploadFile, onUploadStart, onUploadEnd]);\r\n\r\n  const { getRootProps, getInputProps, isDragActive } = useDropzone({\r\n    onDrop,\r\n    accept: {\r\n      \"image/jpeg\": [\".jpg\", \".jpeg\"],\r\n      \"image/png\": [\".png\"],\r\n      \"image/webp\": [\".webp\"],\r\n    },\r\n    maxSize: 10 * 1024 * 1024, // 10MB\r\n    disabled: images.length >= maxPhotos,\r\n    multiple: true,\r\n  });\r\n\r\n  // ============================================================================\r\n  // Image Management Handlers\r\n  // ============================================================================\r\n\r\n  const handleRemove = useCallback((index: number) => {\r\n    const newImages = images.filter((_, i) => i !== index);\r\n    if (images[index]?.isPrimary && newImages.length > 0 && newImages[0]) {\r\n        newImages[0] = { ...newImages[0], isPrimary: true };\r\n      }\r\n    setValue(\"images\", newImages, { shouldValidate: true });\r\n  }, [images, setValue]);\r\n\r\n  const handleSetCover = useCallback((index: number) => {\r\n    const newImages = images.map((img, i) => ({\r\n      ...img,\r\n      isPrimary: i === index,\r\n    }));\r\n    const cover = newImages.splice(index, 1)[0];\r\n    if (cover) newImages.unshift(cover);\r\n    setValue(\"images\", newImages, { shouldValidate: true });\r\n  }, [images, setValue]);\r\n\r\n  // Drag & drop reorder\r\n  const handleDragStart = useCallback((index: number) => {\r\n    setDraggingIndex(index);\r\n  }, []);\r\n\r\n  const handleDragOver = useCallback((e: React.DragEvent, index: number) => {\r\n    e.preventDefault();\r\n    dragOverIndex.current = index;\r\n  }, []);\r\n\r\n  const handleDragEnd = useCallback(() => {\r\n    if (draggingIndex !== null && dragOverIndex.current !== null && draggingIndex !== dragOverIndex.current) {\r\n      const newImages = [...images];\r\n      const [removed] = newImages.splice(draggingIndex, 1);\r\n      if (removed) {\r\n        newImages.splice(dragOverIndex.current, 0, removed);\r\n      }\r\n\r\n      newImages.forEach((img, i) => {\r\n        img.isPrimary = i === 0;\r\n      });\r\n\r\n      setValue(\"images\", newImages, { shouldValidate: true });\r\n    }\r\n    setDraggingIndex(null);\r\n    dragOverIndex.current = null;\r\n  }, [draggingIndex, images, setValue]);\r\n\r\n  // ============================================================================\r\n  // Render\r\n  // ============================================================================\r\n\r\n  const hasImages = images.length > 0;\r\n  const isUploading = uploads.some(u => u.status === \"uploading\" || u.status === \"processing\");\r\n  const hasError = !!errors.images;\r\n\r\n  return (\r\n    <>\r\n      {/* Main Photos Field */}\r\n      <Field data-invalid={hasError}>\r\n        {!compact ? (\r\n          <div className=\"rounded-md border border-form-section-border bg-form-section-bg overflow-hidden shadow-xs\">\r\n            {/* Header */}\r\n            <div className=\"p-4 pb-3 border-b border-border/50 bg-surface-subtle\">\r\n              <div className=\"flex items-start justify-between gap-4\">\r\n                <div className=\"flex items-center gap-3.5\">\r\n                  <div className=\"flex size-10 items-center justify-center rounded-md bg-form-section-bg border border-form-section-border shadow-xs\">\r\n                    <Camera className=\"size-5 text-muted-foreground\" weight=\"bold\" />\r\n                  </div>\r\n                  <div>\r\n                    <FieldLabel className=\"text-sm font-bold tracking-tight text-foreground\">\r\n                      {isBg ? \"╨í╨╜╨╕╨╝╨║╨╕\" : \"Photos\"}\r\n                    </FieldLabel>\r\n                    <FieldDescription className=\"text-xs font-medium text-muted-foreground mt-0.5\">\r\n                      {isBg\r\n                        ? `╨ö╨╛╨▒╨░╨▓╨╡╤é╨╡ ╨┤╨╛ ${maxPhotos} ╤ü╨╜╨╕╨╝╨║╨╕. ╨ƒ╤è╤Ç╨▓╨░╤é╨░ ╨╡ ╨║╨╛╤Ç╨╕╤å╨░.`\r\n                        : `Add up to ${maxPhotos} photos. First image is the cover.`}\r\n                    </FieldDescription>\r\n                  </div>\r\n                </div>\r\n                <Badge\r\n                  variant={images.length === 0 ? \"destructive\" : \"secondary\"}\r\n                  className=\"h-6 rounded-sm px-2 text-xs font-semibold tabular-nums\"\r\n                >\r\n                  {images.length}/{maxPhotos}\r\n                </Badge>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Content */}\r\n            <FieldContent className=\"p-5\">\r\n              {/* Photo Grid */}\r\n              {hasImages && (\r\n                <div className=\"grid grid-cols-4 sm:grid-cols-4 lg:grid-cols-6 gap-2 mb-4\">\r\n                  {images.map((image, index) => (\r\n                    <PhotoThumbnail\r\n                      key={`${image.url}-${index}`}\r\n                      image={image}\r\n                      index={index}\r\n                      isCover={index === 0 || !!image.isPrimary}\r\n                      onRemove={() => handleRemove(index)}\r\n                      onSetCover={() => handleSetCover(index)}\r\n                      onPreview={() => setPreviewImage(image)}\r\n                      isDragging={draggingIndex === index}\r\n                      onDragStart={() => handleDragStart(index)}\r\n                      onDragOver={(e) => handleDragOver(e, index)}\r\n                      onDragEnd={handleDragEnd}\r\n                    />\r\n                  ))}\r\n                </div>\r\n              )}\r\n\r\n              {/* Upload Zone */}\r\n              {images.length < maxPhotos && (\r\n                <UploadZone\r\n                  isUploading={isUploading}\r\n                  isDragActive={isDragActive}\r\n                  getRootProps={getRootProps}\r\n                  getInputProps={getInputProps}\r\n                  currentCount={images.length}\r\n                  maxCount={maxPhotos}\r\n                  locale={isBg ? \"bg\" : \"en\"}\r\n                />\r\n              )}\r\n\r\n              {/* Upload Progress */}\r\n              {uploads.length > 0 && (\r\n                <div className=\"mt-4 space-y-2\">\r\n                  {uploads.map((upload, i) => (\r\n                    <UploadProgressItem key={i} upload={upload} />\r\n                  ))}\r\n                </div>\r\n              )}\r\n\r\n              {/* Error Message */}\n              {hasError && (\n                <FieldError className=\"mt-3\">\n                  {errors.images?.message ? tSell(errors.images.message as never) : null}\n                </FieldError>\n              )}\n            </FieldContent>\n          </div>\n        ) : (\n          <FieldContent>\r\n            <div className=\"flex items-start justify-between gap-4 mb-3\">\r\n              <div className=\"space-y-0.5\">\r\n                <p className=\"text-sm text-muted-foreground\">\r\n                  {isBg\r\n                    ? `╨ö╨╛╨▒╨░╨▓╨╡╤é╨╡ ╨┤╨╛ ${maxPhotos} ╤ü╨╜╨╕╨╝╨║╨╕. ╨ƒ╤è╤Ç╨▓╨░╤é╨░ ╨╡ ╨║╨╛╤Ç╨╕╤å╨░.`\r\n                    : `Add up to ${maxPhotos} photos. First image is the cover.`}\r\n                </p>\r\n              </div>\r\n              <Badge\r\n                variant={images.length === 0 ? \"destructive\" : \"secondary\"}\r\n                className=\"h-6 rounded-sm px-2 text-xs font-semibold tabular-nums\"\r\n              >\r\n                {images.length}/{maxPhotos}\r\n              </Badge>\r\n            </div>\r\n\r\n            {/* Photo Grid */}\r\n            {hasImages && (\r\n              <div className=\"grid grid-cols-4 sm:grid-cols-4 lg:grid-cols-6 gap-2 mb-4\">\r\n                {images.map((image, index) => (\r\n                  <PhotoThumbnail\r\n                    key={`${image.url}-${index}`}\r\n                    image={image}\r\n                    index={index}\r\n                    isCover={index === 0 || !!image.isPrimary}\r\n                    onRemove={() => handleRemove(index)}\r\n                    onSetCover={() => handleSetCover(index)}\r\n                    onPreview={() => setPreviewImage(image)}\r\n                    isDragging={draggingIndex === index}\r\n                    onDragStart={() => handleDragStart(index)}\r\n                    onDragOver={(e) => handleDragOver(e, index)}\r\n                    onDragEnd={handleDragEnd}\r\n                  />\r\n                ))}\r\n              </div>\r\n            )}\r\n\r\n            {/* Upload Zone */}\r\n            {images.length < maxPhotos && (\r\n              <UploadZone\r\n                isUploading={isUploading}\r\n                isDragActive={isDragActive}\r\n                getRootProps={getRootProps}\r\n                getInputProps={getInputProps}\r\n                currentCount={images.length}\r\n                maxCount={maxPhotos}\r\n                locale={isBg ? \"bg\" : \"en\"}\r\n              />\r\n            )}\r\n\r\n            {/* Upload Progress */}\r\n            {uploads.length > 0 && (\r\n              <div className=\"mt-4 space-y-2\">\r\n                {uploads.map((upload, i) => (\r\n                  <UploadProgressItem key={i} upload={upload} />\r\n                ))}\r\n              </div>\r\n            )}\r\n\r\n            {/* Error Message */}\n            {hasError && (\n              <FieldError className=\"mt-3\">\n                {errors.images?.message ? tSell(errors.images.message as never) : null}\n              </FieldError>\n            )}\n          </FieldContent>\n        )}\n      </Field>\n\r\n      {/* Image Preview Modal */}\r\n      {previewImage && (\r\n        <ImagePreviewModal\r\n          image={previewImage}\r\n          onClose={() => setPreviewImage(null)}\r\n        />\r\n      )}\r\n    </>\r\n  );\r\n}\r\n\r\n/**\r\n * Memoized PhotosField - Photo upload with drag/drop, compression, and preview.\r\n * Optimized to prevent unnecessary re-renders when unrelated form state changes.\r\n * @see useSellForm - Hook for form state access\r\n * @see useSellFormContext - Hook for context access\r\n */\r\nconst MemoizedPhotosField = memo(PhotosField);\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\fields\\pricing-field.tsx","messages":[{"ruleId":"unicorn/prefer-number-properties","severity":1,"message":"Prefer `Number.isNaN` over `isNaN`.","line":179,"column":16,"nodeType":"Identifier","messageId":"error","endLine":179,"endColumn":21,"suggestions":[{"messageId":"suggestion","fix":{"range":[6538,6543],"text":"Number.isNaN"},"data":{"description":"isNaN","property":"isNaN"},"desc":"Replace `isNaN` with `Number.isNaN`."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_setPriceSuggestion' is assigned a value but never used.","line":230,"column":27,"nodeType":"Identifier","messageId":"unusedVar","endLine":230,"endColumn":46},{"ruleId":"sonarjs/no-all-duplicated-branches","severity":1,"message":"This conditional operation returns the same value whether the condition is \"true\" or \"false\".","line":426,"column":13,"nodeType":"ConditionalExpression","messageId":"returnsTheSameValue","endLine":426,"endColumn":65},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MemoizedPricingField' is assigned a value but never used.","line":491,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":491,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useCallback, useEffect, memo } from \"react\";\r\nimport { Controller } from \"react-hook-form\";\r\nimport {\r\n  Tag,\r\n  Gavel,\r\n  CurrencyDollar,\r\n  TrendUp,\r\n  TrendDown,\r\n  Minus,\r\n  Plus,\r\n  Handshake,\r\n  CaretRight,\r\n} from \"@phosphor-icons/react\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Field, FieldLabel, FieldDescription, FieldError, FieldContent } from \"@/components/shared/field\";\nimport { cn } from \"@/lib/utils\";\nimport { formatOptions } from \"@/lib/sell/schema-v4\";\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\nimport { SelectDrawer } from \"../ui/select-drawer\";\nimport { useTranslations } from \"next-intl\";\n\r\n// ============================================================================\r\n// Constants - V1: BGN only (Cash on Delivery in Bulgaria)\r\n// ============================================================================\r\nconst CURRENCY_SYMBOLS: Record<string, string> = {\r\n  BGN: \"╨╗╨▓\",\r\n  EUR: \"Γé¼\",\r\n  USD: \"$\",\r\n};\r\n\r\n// V1: Only BGN for cash on delivery in Bulgaria\r\nconst CURRENCIES = [\r\n  { value: \"BGN\", label: \"BGN (╨╗╨▓)\" },\r\n];\r\n\r\n// ============================================================================\r\n// Price Suggestion Types & Component\r\n// ============================================================================\r\ninterface PriceSuggestion {\r\n  low: number;\r\n  median: number;\r\n  high: number;\r\n  currency: string;\r\n  count: number;\r\n}\r\n\r\nfunction PriceSuggestionCard({\r\n  suggestion,\r\n  currentPrice,\r\n  onApply,\r\n  isBg,\r\n}: {\r\n  suggestion: PriceSuggestion | null;\r\n  currentPrice: string;\r\n  onApply: (price: number) => void;\r\n  isBg: boolean;\r\n}) {\r\n  if (!suggestion || suggestion.count < 3) return null;\r\n\r\n  const priceNum = Number.parseFloat(currentPrice) || 0;\r\n  const symbol = CURRENCY_SYMBOLS[suggestion.currency] || suggestion.currency;\r\n\r\n  const getPricePosition = () => {\r\n    if (priceNum <= 0) return null;\r\n    if (priceNum < suggestion.low) return \"below\";\r\n    if (priceNum > suggestion.high) return \"above\";\r\n    if (priceNum < suggestion.median) return \"low\";\r\n    if (priceNum > suggestion.median) return \"high\";\r\n    return \"median\";\r\n  };\r\n\r\n  const position = getPricePosition();\r\n\r\n  return (\r\n    <div className=\"p-3 rounded-lg bg-muted border border-border\">\r\n      <div className=\"flex items-center gap-2 mb-2\">\r\n        <TrendUp className=\"h-4 w-4 text-primary\" />\r\n        <span className=\"text-xs font-semibold text-foreground\">\r\n          {isBg ? `╨ª╨╡╨╜╨╛╨▓╨╕ ╨╛╤Ç╨╕╨╡╨╜╤é╨╕╤Ç (${suggestion.count} ╨┐╨╛╨┤╨╛╨▒╨╜╨╕ ╨╛╨▒╤Å╨▓╨╕)` : `Price Guide (${suggestion.count} similar listings)`}\r\n        </span>\r\n      </div>\r\n\r\n      <div className=\"flex items-center gap-4\">\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => onApply(suggestion.low)}\r\n          className=\"flex-1 p-2 rounded-lg bg-background hover:bg-accent transition-colors text-center\"\r\n        >\r\n          <div className=\"text-xs text-muted-foreground mb-0.5\">{isBg ? \"╨¥╨╕╤ü╨║╨░\" : \"Low\"}</div>\r\n          <div className=\"text-sm font-semibold text-foreground\">\r\n            {symbol}{suggestion.low.toFixed(2)}\r\n          </div>\r\n        </button>\r\n\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => onApply(suggestion.median)}\r\n          className=\"flex-1 p-2 rounded-lg bg-selected hover:bg-hover active:bg-active transition-colors text-center ring-2 ring-ring\"\r\n        >\r\n          <div className=\"text-xs text-primary mb-0.5\">{isBg ? \"╨ƒ╤Ç╨╡╨┐╨╛╤Ç╤è╤ç╨░╨╜╨░\" : \"Recommended\"}</div>\r\n          <div className=\"text-sm font-bold text-primary\">\r\n            {symbol}{suggestion.median.toFixed(2)}\r\n          </div>\r\n        </button>\r\n\r\n        <button\r\n          type=\"button\"\r\n          onClick={() => onApply(suggestion.high)}\r\n          className=\"flex-1 p-2 rounded-lg bg-background hover:bg-accent transition-colors text-center\"\r\n        >\r\n          <div className=\"text-xs text-muted-foreground mb-0.5\">{isBg ? \"╨Æ╨╕╤ü╨╛╨║╨░\" : \"High\"}</div>\r\n          <div className=\"text-sm font-semibold text-foreground\">\r\n            {symbol}{suggestion.high.toFixed(2)}\r\n          </div>\r\n        </button>\r\n      </div>\r\n\r\n      {position && priceNum > 0 && (\r\n        <div className={cn(\r\n          \"mt-2 flex items-center gap-1.5 text-xs\",\r\n          position === \"below\" && \"text-success\",\r\n          position === \"above\" && \"text-warning\",\r\n          (position === \"low\" || position === \"median\" || position === \"high\") && \"text-primary\"\r\n        )}>\r\n          {position === \"below\" && <TrendDown className=\"h-3.5 w-3.5\" />}\r\n          {position === \"above\" && <TrendUp className=\"h-3.5 w-3.5\" />}\r\n          {position === \"below\" && (isBg ? \"╨ª╨╡╨╜╨░╤é╨░ ╨▓╨╕ ╨╡ ╨┐╨╛╨┤ ╨┐╨░╨╖╨░╤Ç╨╜╨░╤é╨░ - ╨┐╤Ç╨╛╨┤╨░╨▓╨░ ╤ü╨╡ ╨┐╨╛-╨▒╤è╤Ç╨╖╨╛!\" : \"Your price is below market - items sell faster!\")}\r\n          {position === \"above\" && (isBg ? \"╨ª╨╡╨╜╨░╤é╨░ ╨▓╨╕ ╨╡ ╨╜╨░╨┤ ╤é╨╕╨┐╨╕╤ç╨╜╨╕╤Å ╨┤╨╕╨░╨┐╨░╨╖╨╛╨╜\" : \"Your price is above typical range\")}\r\n          {position === \"low\" && (isBg ? \"╨Ü╨╛╨╜╨║╤â╤Ç╨╡╨╜╤é╨╜╨░ ╤å╨╡╨╜╨░\" : \"Competitively priced\")}\r\n          {position === \"median\" && (isBg ? \"╨í╤Ç╨╡╨┤╨╜╨░ ╨┐╨░╨╖╨░╤Ç╨╜╨░ ╤å╨╡╨╜╨░\" : \"Priced at market average\")}\r\n          {position === \"high\" && (isBg ? \"╨ƒ╤Ç╨╡╨╝╨╕╤â╨╝ ╤å╨╡╨╜╨╛╨╛╨▒╤Ç╨░╨╖╤â╨▓╨░╨╜╨╡\" : \"Premium pricing\")}\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// Quantity Stepper Component\r\n// ============================================================================\r\nfunction QuantityStepper({\r\n  value,\r\n  onChange,\r\n  min = 1,\r\n  max = 9999,\r\n}: {\r\n  value: number;\r\n  onChange: (val: number) => void;\r\n  min?: number;\r\n  max?: number;\r\n}) {\r\n  return (\r\n    <div className=\"flex items-center h-12 w-fit rounded-md border border-border bg-background shadow-xs overflow-hidden\">\r\n      <button\r\n        type=\"button\"\r\n        onClick={() => onChange(Math.max(min, value - 1))}\r\n        disabled={value <= min}\r\n        className=\"h-full px-4 flex items-center justify-center hover:bg-muted disabled:opacity-40 disabled:cursor-not-allowed transition-colors touch-manipulation border-r border-border/50\"\r\n        aria-label=\"Decrease quantity\"\r\n      >\r\n        <Minus className=\"size-4\" weight=\"bold\" />\r\n      </button>\r\n      <Input\r\n        type=\"number\"\r\n        value={value}\r\n        onChange={(e) => {\r\n          const num = Number.parseInt(e.target.value, 10);\r\n          if (!isNaN(num)) {\r\n            onChange(Math.max(min, Math.min(max, num)));\r\n          }\r\n        }}\r\n        className=\"w-14 h-full text-center text-base font-bold border-none bg-transparent focus-visible:ring-0 focus-visible:ring-offset-0 shadow-none\"\r\n        min={min}\r\n        max={max}\r\n      />\r\n      <button\r\n        type=\"button\"\r\n        onClick={() => onChange(Math.min(max, value + 1))}\r\n        disabled={value >= max}\r\n        className=\"h-full px-4 flex items-center justify-center hover:bg-muted disabled:opacity-40 disabled:cursor-not-allowed transition-colors touch-manipulation border-l border-border/50\"\r\n        aria-label=\"Increase quantity\"\r\n      >\r\n        <Plus className=\"size-4\" weight=\"bold\" />\r\n      </button>\r\n    </div>\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// PRICING FIELD - Price, quantity, offers using context pattern\r\n// ============================================================================\r\n\r\ninterface PricingFieldProps {\r\n  /** Custom class name for the field wrapper */\r\n  className?: string;\r\n  /** Category ID for price suggestions */\r\n  categoryId?: string;\r\n  /** Prefix for DOM ids (prevents duplicates across layouts) */\r\n  idPrefix?: string;\r\n  /** Use compact layout */\r\n  compact?: boolean;\r\n}\r\n\r\nexport function PricingField({ className, categoryId, idPrefix = \"sell-form\", compact = false }: PricingFieldProps) {\n  const { control, setValue, watch, formState: { errors } } = useSellForm();\n  const { isBg } = useSellFormContext();\n  const tSell = useTranslations(\"Sell\")\n\n  const [isCurrencyDrawerOpen, setIsCurrencyDrawerOpen] = useState(false);\n\r\n  // Watch form values\r\n  const format = watch(\"format\");\r\n  const price = watch(\"price\");\r\n  const currency = watch(\"currency\");\r\n  const quantity = watch(\"quantity\");\r\n  const acceptOffers = watch(\"acceptOffers\");\r\n  const compareAtPrice = watch(\"compareAtPrice\");\r\n\r\n  const [priceSuggestion, _setPriceSuggestion] = useState<PriceSuggestion | null>(null);\r\n  const priceInputId = `${idPrefix}-price`;\r\n  const comparePriceInputId = `${idPrefix}-compare-price`;\r\n\r\n  // Fetch price suggestions (stub - would connect to API)\r\n  useEffect(() => {\r\n    // Stub: Price suggestion API not implemented yet\r\n    // Would query historical prices by category/condition to suggest pricing\r\n  }, [categoryId]);\r\n\r\n  const handleApplyPrice = useCallback((priceValue: number) => {\r\n    setValue(\"price\", priceValue.toFixed(2), { shouldValidate: true });\r\n  }, [setValue]);\r\n\r\n  const hasError = !!errors.price;\r\n\r\n  const content = (\r\n    <FieldContent className={cn(\"space-y-6\", !compact && \"p-6\")}>\r\n      {/* Format Selection */}\r\n      <div className=\"grid grid-cols-2 gap-3\">\r\n        {formatOptions.map((option) => {\n          const isSelected = format === option.value;\n          const Icon = option.value === \"fixed\" ? Tag : Gavel;\n          const label = tSell(option.labelKey as never);\n\n          return (\n            <button\n              key={option.value}\r\n              type=\"button\"\r\n              onClick={() => setValue(\"format\", option.value, { shouldValidate: true })}\r\n              className={cn(\r\n                \"flex items-center justify-center gap-2 h-12 rounded-md border transition-colors\",\r\n                \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:ring-offset-background\",\r\n                isSelected\r\n                  ? \"border-selected-border bg-selected text-primary font-bold shadow-xs\"\r\n                  : \"border-border bg-background hover:border-hover-border text-muted-foreground hover:text-foreground\"\r\n              )}\r\n            >\r\n              <Icon className=\"size-5\" weight={isSelected ? \"fill\" : \"bold\"} />\r\n              <span className=\"text-sm\">\r\n                {label}\r\n              </span>\r\n            </button>\r\n          );\r\n        })}\r\n      </div>\r\n\r\n      {/* Price Input - Premium card design */}\r\n      <Controller\r\n        name=\"price\"\r\n        control={control}\r\n        render={({ field, fieldState }) => (\r\n          <div className=\"space-y-3\">\r\n            <div className=\"flex items-center justify-between px-1\">\r\n              <label htmlFor={priceInputId} className=\"text-sm font-bold text-foreground\">\r\n                {isBg ? \"╨Æ╨░╤ê╨░╤é╨░ ╤å╨╡╨╜╨░\" : \"Your price\"} <span className=\"text-destructive\">*</span>\r\n              </label>\r\n            </div>\r\n            \r\n            <div className={cn(\r\n              \"rounded-xl border bg-card overflow-hidden transition-all\",\r\n              \"focus-within:ring-2 focus-within:ring-ring focus-within:border-ring\",\r\n              fieldState.invalid ? \"border-destructive/50 bg-destructive-subtle\" : \"border-border\"\n            )}>\r\n              <div className=\"flex items-center h-16 px-4\">\r\n                <span className=\"text-2xl font-bold text-muted-foreground mr-2\">\r\n                  {CURRENCY_SYMBOLS[currency] || currency}\r\n                </span>\r\n                <Input\r\n                  {...field}\r\n                  id={priceInputId}\r\n                  type=\"text\"\r\n                  inputMode=\"decimal\"\r\n                  placeholder=\"0.00\"\r\n                  className=\"border-none bg-transparent h-full text-3xl font-bold p-0 focus-visible:ring-0 flex-1\"\r\n                />\r\n                {compact ? (\r\n                  <>\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => setIsCurrencyDrawerOpen(true)}\r\n                      className=\"flex items-center gap-1.5 px-3 py-2 rounded-xl bg-surface-subtle hover:bg-hover active:bg-active transition-colors\"\r\n                    >\r\n                      <span className=\"text-sm font-bold\">{currency}</span>\r\n                      <CaretRight className=\"size-3.5 text-muted-foreground rotate-90\" />\r\n                    </button>\r\n                    <SelectDrawer\r\n                      isOpen={isCurrencyDrawerOpen}\r\n                      onClose={() => setIsCurrencyDrawerOpen(false)}\r\n                      title={isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨▓╨░╨╗╤â╤é╨░\" : \"Select Currency\"}\r\n                      options={CURRENCIES.map(c => c.value)}\r\n                      optionsBg={CURRENCIES.map(c => c.label)}\r\n                      value={currency}\r\n                      onChange={(val) => setValue(\"currency\", val as \"EUR\")}\r\n                      locale={isBg ? \"bg\" : \"en\"}\r\n                    />\r\n                  </>\r\n                ) : (\r\n                  <Select\r\n                    value={currency}\r\n                    onValueChange={(val) => setValue(\"currency\", val as \"EUR\")}\r\n                  >\r\n                    <SelectTrigger className=\"w-auto min-w-24 border-none bg-surface-subtle h-10 rounded-xl font-bold focus:ring-0 focus:ring-offset-0 shadow-none px-3 text-sm\">\r\n                      <SelectValue />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {CURRENCIES.map((c) => (\r\n                        <SelectItem key={c.value} value={c.value} className=\"font-medium\">\r\n                          {c.label}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                )}\r\n              </div>\r\n            </div>\r\n            {fieldState.invalid && (\n              <FieldError>\n                {fieldState.error?.message ? tSell(fieldState.error.message as never) : null}\n              </FieldError>\n            )}\n          </div>\n        )}\n      />\n\r\n      {/* Price Suggestions */}\r\n      <PriceSuggestionCard\r\n        suggestion={priceSuggestion}\r\n        currentPrice={price}\r\n        onApply={handleApplyPrice}\r\n        isBg={isBg}\r\n      />\r\n\r\n      {/* Compare at Price (Optional) */}\r\n      <div className=\"space-y-2\">\r\n        <div className=\"flex items-center justify-between px-1\">\r\n          <label htmlFor={comparePriceInputId} className=\"text-sm font-bold text-foreground flex items-center gap-2\">\r\n            {isBg ? \"╨í╤é╨░╤Ç╨░ ╤å╨╡╨╜╨░\" : \"Compare at price\"}\r\n            <span className=\"text-xs font-medium text-muted-foreground\">{isBg ? \"(╨┐╨╛ ╨╕╨╖╨▒╨╛╤Ç)\" : \"(optional)\"}</span>\r\n          </label>\r\n        </div>\r\n        <div className={cn(\r\n          \"flex items-center h-14 px-4 rounded-xl border bg-card transition-colors\",\r\n          \"focus-within:ring-2 focus-within:ring-ring focus-within:border-ring\"\r\n        )}>\r\n          <span className=\"text-base font-bold text-muted-foreground mr-2\">\r\n            {CURRENCY_SYMBOLS[currency] || currency}\r\n          </span>\r\n          <Input\r\n            id={comparePriceInputId}\r\n            type=\"text\"\r\n            inputMode=\"decimal\"\r\n            placeholder={isBg ? \"╨₧╤Ç╨╕╨│╨╕╨╜╨░╨╗╨╜╨░ ╤å╨╡╨╜╨░\" : \"Original price\"}\r\n            value={compareAtPrice || \"\"}\r\n            onChange={(e) => setValue(\"compareAtPrice\", e.target.value)}\r\n            className=\"border-none bg-transparent h-full text-lg font-semibold p-0 focus-visible:ring-0 flex-1\"\r\n          />\r\n        </div>\r\n      </div>\r\n\r\n      {/* Quantity */}\r\n      <div className=\"space-y-2\">\r\n        <Label className=\"text-sm font-bold px-1\">\r\n          {isBg ? \"╨Ü╨╛╨╗╨╕╤ç╨╡╤ü╤é╨▓╨╛\" : \"Quantity\"}\r\n        </Label>\r\n        <QuantityStepper\r\n          value={quantity}\r\n          onChange={(val) => setValue(\"quantity\", val, { shouldValidate: true })}\r\n        />\r\n      </div>\r\n\r\n      {/* Accept Offers Toggle - Premium pill design */}\r\n      <div\r\n        role=\"button\"\r\n        tabIndex={0}\r\n        onClick={() => setValue(\"acceptOffers\", !acceptOffers)}\r\n        onKeyDown={(e) => { if (e.key === \"Enter\" || e.key === \" \") { e.preventDefault(); setValue(\"acceptOffers\", !acceptOffers); } }}\r\n        className={cn(\r\n          \"w-full flex items-center gap-3.5 p-4 rounded-xl border transition-colors cursor-pointer\",\r\n          \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring\",\r\n          acceptOffers \r\n            ? \"border-selected-border bg-selected\" \r\n            : \"border-border bg-card hover:bg-hover\"\r\n        )}\r\n      >\r\n        <div className={cn(\r\n          \"size-11 rounded-xl flex items-center justify-center shrink-0 transition-all\",\r\n          acceptOffers \r\n            ? \"bg-selected text-primary\" \r\n            : \"bg-muted text-muted-foreground\"\r\n        )}>\r\n          <Handshake className=\"size-5\" weight={acceptOffers ? \"fill\" : \"regular\"} />\r\n        </div>\r\n        <div className=\"flex-1 text-left min-w-0\">\r\n          <span className={cn(\r\n            \"text-base font-semibold block\",\r\n            acceptOffers ? \"text-foreground\" : \"text-foreground\"\r\n          )}>\r\n            {isBg ? \"╨ƒ╤Ç╨╕╨╡╨╝╨░╨╜╨╡ ╨╜╨░ ╨╛╤ä╨╡╤Ç╤é╨╕\" : \"Accept offers\"}\r\n          </span>\r\n          <span className=\"text-sm text-muted-foreground line-clamp-1\">\r\n            {isBg\r\n              ? \"╨ƒ╨╛╨╖╨▓╨╛╨╗╨╡╤é╨╡ ╨╜╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨╕╤é╨╡ ╨┤╨░ ╨┐╤Ç╨╡╨┤╨╗╨░╨│╨░╤é ╤å╨╡╨╜╨░\"\r\n              : \"Let buyers negotiate the price\"}\r\n          </span>\r\n        </div>\r\n        <Switch \r\n          checked={acceptOffers} \r\n          onCheckedChange={(checked) => setValue(\"acceptOffers\", checked)}\r\n          className=\"shrink-0 scale-110\"\r\n        />\r\n      </div>\r\n    </FieldContent>\r\n  );\r\n\r\n  return (\r\n    <Field data-invalid={hasError} className={className}>\r\n      {!compact ? (\r\n        <div className=\"rounded-md border border-form-section-border bg-form-section-bg overflow-hidden shadow-xs\">\r\n          {/* Header */}\r\n          <div className=\"p-section pb-form border-b border-border/50 bg-surface-subtle\">\r\n            <div className=\"flex items-center gap-form-sm\">\r\n              <div className=\"flex size-10 items-center justify-center rounded-md bg-form-section-bg border border-form-section-border shadow-xs\">\r\n                <CurrencyDollar className=\"size-5 text-muted-foreground\" weight=\"bold\" />\r\n              </div>\r\n              <div>\r\n                <FieldLabel className=\"text-sm font-bold tracking-tight text-foreground\">\r\n                  {isBg ? \"╨ª╨╡╨╜╨░ ╨╕ ╨║╨╛╨╗╨╕╤ç╨╡╤ü╤é╨▓╨╛\" : \"Price & Quantity\"}\r\n                </FieldLabel>\r\n                <FieldDescription className=\"text-sm text-muted-foreground mt-0.5\">\r\n                  {isBg\r\n                    ? \"╨ù╨░╨┤╨░╨╣╤é╨╡ ╤å╨╡╨╜╨░ ╨╕ ╨╜╨░╨╗╨╕╤ç╨╜╨╛ ╨║╨╛╨╗╨╕╤ç╨╡╤ü╤é╨▓╨╛\"\r\n                    : \"Set your price and available quantity\"}\r\n                </FieldDescription>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {content}\r\n        </div>\r\n      ) : (\r\n        <>\r\n          {/* Compact Label - hidden if we use label inside */}\r\n          <div className=\"hidden\">\r\n            <FieldLabel className=\"text-sm font-semibold mb-form-sm\">\r\n              {isBg ? \"╨ª╨╡╨╜╨░ ╨╕ ╨║╨╛╨╗╨╕╤ç╨╡╤ü╤é╨▓╨╛\" : \"Pricing\"}\r\n            </FieldLabel>\r\n          </div>\r\n          {content}\r\n        </>\r\n      )}\r\n    </Field>\r\n  );\r\n}\r\n\r\n/**\r\n * Memoized PricingField - Price, quantity, currency, and offer settings.\r\n * Optimized to prevent unnecessary re-renders when unrelated form state changes.\r\n * @see useSellForm - Hook for form state access\r\n * @see useSellFormContext - Hook for context access\r\n */\r\nconst MemoizedPricingField = memo(PricingField);\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\fields\\review-field.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useEffect' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":19,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"useEffect"},"fix":{"range":[17,51],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 41 to the 25 allowed.","line":87,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":87,"endColumn":28}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect } from \"react\";\r\nimport Image from \"next/image\";\r\nimport {\r\n  CheckCircle,\r\n  Camera,\r\n  FolderOpen,\r\n  CurrencyDollar,\r\n  Truck,\r\n  Tag,\r\n  Package,\r\n  PencilSimple,\r\n  Warning,\r\n} from \"@phosphor-icons/react\";\r\nimport { Button } from \"@/components/ui/button\";\nimport { cn } from \"@/lib/utils\";\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\nimport { conditionOptions } from \"@/lib/sell/schema-v4\";\nimport { useTranslations } from \"next-intl\";\n\r\n// ============================================================================\r\n// REVIEW FIELD - Final review step using context pattern\r\n// Phase 4: Responsive Unification\r\n// ============================================================================\r\n\r\n// Currency symbols\r\nconst CURRENCY_SYMBOLS: Record<string, string> = {\r\n  BGN: \"╨╗╨▓\",\r\n  EUR: \"Γé¼\",\r\n  USD: \"$\",\r\n};\r\n\r\n// Section wrapper for review - Premium design\r\nfunction ReviewSection({\r\n  title,\r\n  icon: Icon,\r\n  onEdit,\r\n  isComplete,\r\n  children,\r\n}: {\r\n  title: string;\r\n  icon: React.ElementType;\r\n  onEdit?: () => void;\r\n  isComplete?: boolean;\r\n  children: React.ReactNode;\r\n}) {\r\n  return (\r\n    <div className=\"rounded-2xl border border-border bg-card overflow-hidden\">\r\n      <div className=\"flex items-center justify-between px-4 py-3 bg-surface-subtle border-b border-border/50\">\r\n        <div className=\"flex items-center gap-3\">\r\n          <div className={cn(\r\n            \"size-9 rounded-xl flex items-center justify-center\",\r\n            isComplete ? \"bg-success/10\" : \"bg-muted\"\r\n          )}>\r\n            <Icon className={cn(\r\n              \"size-4.5\",\r\n              isComplete ? \"text-success\" : \"text-muted-foreground\"\r\n            )} weight=\"fill\" />\r\n          </div>\r\n          <span className=\"text-sm font-bold text-foreground\">{title}</span>\r\n        </div>\r\n        {onEdit && (\r\n          <Button\r\n            type=\"button\"\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={onEdit}\r\n            className=\"h-8 px-3 gap-1.5 text-primary text-sm font-semibold hover:bg-hover active:bg-active\"\r\n          >\r\n            <PencilSimple className=\"size-4\" />\r\n            Edit\r\n          </Button>\r\n        )}\r\n      </div>\r\n      <div className=\"p-4\">\r\n        {children}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\ninterface ReviewFieldProps {\r\n  onEditStep?: (step: number) => void;\r\n}\r\n\r\nexport function ReviewField({ onEditStep }: ReviewFieldProps) {\n  const { watch } = useSellForm();\n  const { isBg, setCurrentStep } = useSellFormContext();\n  const tSell = useTranslations(\"Sell\")\n  \r\n  const formValues = watch();\r\n  \r\n  const {\r\n    images,\r\n    title,\r\n    description,\r\n    categoryId,\r\n    categoryPath,\r\n    condition,\r\n    brandName,\r\n    attributes,\r\n    price,\r\n    currency,\r\n    quantity,\r\n    acceptOffers,\r\n    shippingPrice,\r\n    shipsToBulgaria,\r\n    shipsToEurope,\r\n    pickupOnly,\r\n  } = formValues;\r\n\r\n  // Check overall validity\r\n  const hasPhotos = Boolean(images && images.length > 0);\r\n  const hasTitle = Boolean(title && title.length >= 5);\r\n  const hasCategory = Boolean(categoryId);\r\n  const hasCondition = Boolean(condition);\r\n  const hasPrice = Boolean(price && Number.parseFloat(price) > 0);\r\n\r\n  const isValid = hasPhotos && hasTitle && hasCategory && hasCondition && hasPrice;\r\n\r\n  // Handle edit navigation - use provided callback or context\r\n  const handleEdit = (step: number) => {\r\n    if (onEditStep) {\r\n      onEditStep(step);\r\n    } else {\r\n      setCurrentStep(step);\r\n    }\r\n    window.scrollTo({ top: 0, behavior: \"instant\" });\r\n  };\r\n\r\n  // Get condition label\r\n  const conditionInfo = conditionOptions.find(c => c.value === condition);\n  const conditionLabel = conditionInfo\n    ? tSell(conditionInfo.labelKey as never)\n    : \"\";\n\r\n  // Get currency symbol\r\n  const currencySymbol = CURRENCY_SYMBOLS[currency] || currency;\r\n\r\n  // Get category path display\r\n  const categoryDisplay = categoryPath && categoryPath.length > 0\r\n    ? categoryPath.map(c => c.name).join(\" ΓÇ║ \")\r\n    : \"\";\r\n\r\n  return (\r\n    <div className=\"flex flex-col gap-5\">\r\n      {/* Validation warnings - Premium alert design */}\r\n      {!isValid && (\r\n        <div className=\"p-4 rounded-2xl bg-surface-subtle border border-border\">\r\n          <div className=\"flex items-start gap-3.5\">\r\n            <div className=\"size-10 rounded-xl bg-warning/10 flex items-center justify-center shrink-0\">\r\n              <Warning className=\"size-5 text-warning\" weight=\"fill\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-sm font-bold text-foreground\">\r\n                {isBg ? \"╨ƒ╨╛╨┐╤è╨╗╨╜╨╡╤é╨╡ ╨╖╨░╨┤╤è╨╗╨╢╨╕╤é╨╡╨╗╨╜╨╕╤é╨╡ ╨┐╨╛╨╗╨╡╤é╨░\" : \"Complete required fields\"}\r\n              </p>\r\n              <ul className=\"text-sm text-muted-foreground mt-2 space-y-1\">\r\n                {!hasPhotos && <li>ΓÇó {isBg ? \"╨ö╨╛╨▒╨░╨▓╨╡╤é╨╡ ╨┐╨╛╨╜╨╡ 1 ╤ü╨╜╨╕╨╝╨║╨░\" : \"Add at least 1 photo\"}</li>}\r\n                {!hasTitle && <li>ΓÇó {isBg ? \"╨ö╨╛╨▒╨░╨▓╨╡╤é╨╡ ╨╖╨░╨│╨╗╨░╨▓╨╕╨╡\" : \"Add a title\"}</li>}\r\n                {!hasCategory && <li>ΓÇó {isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å\" : \"Select a category\"}</li>}\r\n                {!hasCondition && <li>ΓÇó {isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╤ü╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡\" : \"Select condition\"}</li>}\r\n                {!hasPrice && <li>ΓÇó {isBg ? \"╨Æ╤è╨▓╨╡╨┤╨╡╤é╨╡ ╤å╨╡╨╜╨░\" : \"Enter a price\"}</li>}\r\n              </ul>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Photos & Details */}\r\n      <ReviewSection\r\n        title={isBg ? \"╨í╨╜╨╕╨╝╨║╨╕ ╨╕ ╨╛╨┐╨╕╤ü╨░╨╜╨╕╨╡\" : \"Photos & Details\"}\r\n        icon={Camera}\r\n        isComplete={hasPhotos && hasTitle}\r\n        onEdit={() => handleEdit(1)}\r\n      >\r\n        {/* Photo preview */}\r\n        {hasPhotos && (\r\n          <div className=\"flex gap-2 mb-3 overflow-x-auto pb-1 -mx-1 px-1\">\r\n            {images.slice(0, 5).map((img, idx) => (\r\n              <div\r\n                key={idx}\r\n                className=\"relative w-14 h-14 rounded-lg overflow-hidden shrink-0 bg-muted\"\r\n              >\r\n                <Image\r\n                  src={img.thumbnailUrl || img.url}\r\n                  alt={`Photo ${idx + 1}`}\r\n                  fill\r\n                  className=\"object-cover\"\r\n                  sizes=\"56px\"\r\n                />\r\n                {idx === 0 && (\r\n                  <div className=\"absolute bottom-0 inset-x-0 bg-surface-overlay py-0.5 text-center\">\r\n                    <span className=\"text-2xs text-overlay-text font-bold uppercase tracking-wider\">Cover</span>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            ))}\r\n            {images.length > 5 && (\r\n              <div className=\"w-14 h-14 rounded-lg bg-muted flex items-center justify-center shrink-0\">\r\n                <span className=\"text-xs font-bold text-muted-foreground\">\r\n                  +{images.length - 5}\r\n                </span>\r\n              </div>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Title */}\r\n        <p className=\"font-bold text-base line-clamp-2 leading-tight\">{title || \"-\"}</p>\r\n        \r\n        {/* Description */}\r\n        {description && (\r\n          <p className=\"text-xs text-muted-foreground mt-1.5 line-clamp-2\">\r\n            {description}\r\n          </p>\r\n        )}\r\n      </ReviewSection>\r\n\r\n      {/* Category & Condition */}\r\n      <ReviewSection\r\n        title={isBg ? \"╨Ü╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å ╨╕ ╤ü╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡\" : \"Category & Condition\"}\r\n        icon={FolderOpen}\r\n        isComplete={hasCategory && hasCondition}\r\n        onEdit={() => handleEdit(2)}\r\n      >\r\n        <div className=\"space-y-3\">\r\n          {/* Category */}\r\n          <div className=\"flex items-start gap-2\">\r\n            <Tag className=\"size-4 text-muted-foreground mt-0.5\" />\r\n            <div>\r\n              <p className=\"text-xs text-muted-foreground\">{isBg ? \"╨Ü╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å\" : \"Category\"}</p>\r\n              <p className=\"text-sm font-medium\">{categoryDisplay || \"-\"}</p>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Condition */}\r\n          <div className=\"flex items-start gap-2\">\r\n            <Package className=\"size-4 text-muted-foreground mt-0.5\" />\r\n            <div>\r\n              <p className=\"text-xs text-muted-foreground\">{isBg ? \"╨í╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡\" : \"Condition\"}</p>\r\n              <p className=\"text-sm font-medium\">{conditionLabel || \"-\"}</p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </ReviewSection>\r\n\r\n      {/* Item Specifics (Brand + Attributes) */}\r\n      {(brandName || (attributes && attributes.length > 0)) && (\r\n        <ReviewSection\r\n          title={isBg ? \"╨ö╨╡╤é╨░╨╣╨╗╨╕\" : \"Item Specifics\"}\r\n          icon={Tag}\r\n          isComplete={true}\r\n          onEdit={() => handleEdit(2)}\r\n        >\r\n          <div className=\"space-y-3\">\r\n            {/* Brand */}\r\n            {brandName && (\r\n              <div className=\"flex items-start gap-2\">\r\n                <Tag className=\"size-4 text-muted-foreground mt-0.5\" />\r\n                <div>\r\n                  <p className=\"text-xs text-muted-foreground\">{isBg ? \"╨£╨░╤Ç╨║╨░\" : \"Brand\"}</p>\r\n                  <p className=\"text-sm font-medium\">{brandName}</p>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Attributes */}\r\n            {attributes && attributes.length > 0 && (\r\n              <div className={brandName ? \"pt-2 border-t border-border\" : \"\"}>\r\n                <p className=\"text-xs text-muted-foreground mb-2\">\r\n                  {isBg ? \"╨Ñ╨░╤Ç╨░╨║╤é╨╡╤Ç╨╕╤ü╤é╨╕╨║╨╕\" : \"Attributes\"}\r\n                </p>\r\n                <div className=\"flex flex-wrap gap-2\">\r\n                  {attributes.map((attr, idx) => (\r\n                    <span\r\n                      key={idx}\r\n                      className=\"px-2 py-1 rounded-md bg-muted text-xs\"\r\n                    >\r\n                      {attr.name}: {attr.value}\r\n                    </span>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </ReviewSection>\r\n      )}\r\n\r\n      {/* Pricing & Shipping */}\r\n      <ReviewSection\r\n        title={isBg ? \"╨ª╨╡╨╜╨░ ╨╕ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░\" : \"Price & Shipping\"}\r\n        icon={CurrencyDollar}\r\n        isComplete={hasPrice}\r\n        onEdit={() => handleEdit(3)}\r\n      >\r\n        <div className=\"space-y-3\">\r\n          {/* Price */}\r\n          <div className=\"flex items-center justify-between\">\r\n            <span className=\"text-muted-foreground\">{isBg ? \"╨ª╨╡╨╜╨░\" : \"Price\"}</span>\r\n            <span className=\"text-xl font-bold\">\r\n              {currencySymbol} {Number.parseFloat(price || \"0\").toFixed(2)}\r\n            </span>\r\n          </div>\r\n\r\n          {/* Quantity */}\r\n          {quantity > 1 && (\r\n            <div className=\"flex items-center justify-between text-sm\">\r\n              <span className=\"text-muted-foreground\">{isBg ? \"╨Ü╨╛╨╗╨╕╤ç╨╡╤ü╤é╨▓╨╛\" : \"Quantity\"}</span>\r\n              <span className=\"font-medium\">{quantity}</span>\r\n            </div>\r\n          )}\r\n\r\n          {/* Accept offers */}\r\n          {acceptOffers && (\r\n            <div className=\"flex items-center gap-2 text-sm text-success\">\r\n              <CheckCircle className=\"size-4\" weight=\"fill\" />\r\n              {isBg ? \"╨ƒ╤Ç╨╕╨╡╨╝╨░ ╨╛╤ä╨╡╤Ç╤é╨╕\" : \"Accepts offers\"}\r\n            </div>\r\n          )}\r\n\r\n          {/* Shipping */}\r\n          <div className=\"pt-2 border-t border-border mt-3\">\r\n            <div className=\"flex items-center gap-2 mb-2\">\r\n              <Truck className=\"size-4 text-muted-foreground\" />\r\n              <span className=\"text-sm text-muted-foreground\">\r\n                {isBg ? \"╨ö╨╛╤ü╤é╨░╨▓╨║╨░\" : \"Shipping\"}\r\n              </span>\r\n            </div>\r\n\r\n            {pickupOnly ? (\r\n              <p className=\"text-sm\">{isBg ? \"╨í╨░╨╝╨╛ ╨╗╨╕╤ç╨╜╨╛ ╨┐╤Ç╨╡╨┤╨░╨▓╨░╨╜╨╡\" : \"Pickup only\"}</p>\r\n            ) : (\r\n              <div className=\"space-y-1 text-sm\">\r\n                <p>\r\n                  <span className=\"text-muted-foreground\">{isBg ? \"╨ª╨╡╨╜╨░:\" : \"Price:\"}</span>{\" \"}\r\n                  {shippingPrice && Number.parseFloat(shippingPrice) > 0\r\n                    ? `${currencySymbol} ${Number.parseFloat(shippingPrice).toFixed(2)}`\r\n                    : isBg ? \"╨æ╨╡╨╖╨┐╨╗╨░╤é╨╜╨░\" : \"Free\"}\r\n                </p>\r\n                <p className=\"text-muted-foreground\">\r\n                  {[\r\n                    shipsToBulgaria && \"≡ƒçº≡ƒç¼ Bulgaria\",\r\n                    shipsToEurope && \"≡ƒç¬≡ƒç║ Europe\",\r\n                  ].filter(Boolean).join(\", \") || \"-\"}\r\n                </p>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </ReviewSection>\r\n\r\n      {/* Terms agreement - Clean design */}\r\n      <p className=\"text-xs text-muted-foreground text-center px-4 leading-relaxed\">\r\n        {isBg\r\n          ? \"╨ƒ╤Ç╨╕ ╨┐╤â╨▒╨╗╨╕╨║╤â╨▓╨░╨╜╨╡ ╨╜╨░ ╨╛╨▒╤Å╨▓╨░╤é╨░, ╨Æ╨╕╨╡ ╤ü╨╡ ╤ü╤è╨│╨╗╨░╤ü╤Å╨▓╨░╤é╨╡ ╤ü ╨ú╤ü╨╗╨╛╨▓╨╕╤Å╤é╨░ ╨╖╨░ ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨░ ╨╕ ╨┐╨╛╤é╨▓╤è╤Ç╨╢╨┤╨░╨▓╨░╤é╨╡, ╤ç╨╡ ╨╕╨╜╤ä╨╛╤Ç╨╝╨░╤å╨╕╤Å╤é╨░ ╨╡ ╨▓╤Å╤Ç╨╜╨░.\"\r\n          : \"By publishing this listing, you agree to the Terms of Sale and confirm that all information is accurate.\"}\r\n      </p>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\fields\\shipping-field.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 73 to the 25 allowed.","line":239,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":239,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MemoizedShippingField' is assigned a value but never used.","line":610,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":610,"endColumn":28}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { memo, useState } from \"react\";\r\nimport {\r\n  Truck,\r\n  MapPin,\r\n  House,\r\n  Package,\r\n  CaretRight,\r\n} from \"@phosphor-icons/react\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Checkbox } from \"@/components/ui/checkbox\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Field, FieldLabel, FieldDescription, FieldError, FieldContent } from \"@/components/shared/field\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\r\nimport { BULGARIAN_CITIES } from \"@/lib/bulgarian-cities\";\r\nimport { SelectDrawer } from \"../ui/select-drawer\";\r\nimport { useTranslations } from \"next-intl\";\r\n\r\n// ============================================================================\r\n// Shipping Regions Configuration - V1: Bulgaria only (Cash on Delivery)\r\n// International shipping will be added when card payments are implemented\r\n// ============================================================================\r\nconst SHIPPING_REGIONS = [\r\n  {\r\n    id: \"bulgaria\",\r\n    field: \"shipsToBulgaria\" as const,\r\n    label: \"Bulgaria\",\r\n    labelBg: \"╨æ╤è╨╗╨│╨░╤Ç╨╕╤Å\",\r\n    description: \"Cash on delivery via courier\",\r\n    descriptionBg: \"╨¥╨░╨╗╨╛╨╢╨╡╨╜ ╨┐╨╗╨░╤é╨╡╨╢ ╤ü ╨║╤â╤Ç╨╕╨╡╤Ç\",\r\n    icon: House,\r\n    deliveryTime: \"1-3 days\",\r\n    deliveryTimeBg: \"1-3 ╨┤╨╜╨╕\",\r\n    carriers: [\"Speedy\", \"Econt\"],\r\n  },\r\n  {\r\n    id: \"pickup\",\r\n    field: \"pickupOnly\" as const,\r\n    label: \"Local Pickup\",\r\n    labelBg: \"╨¢╨╕╤ç╨╜╨╛ ╨▓╨╖╨╡╨╝╨░╨╜╨╡\",\r\n    description: \"Buyer picks up in person\",\r\n    descriptionBg: \"╨Ü╤â╨┐╤â╨▓╨░╤ç╤è╤é ╨▓╨╖╨╡╨╝╨░ ╨╗╨╕╤ç╨╜╨╛\",\r\n    icon: MapPin,\r\n    deliveryTime: \"Arranged\",\r\n    deliveryTimeBg: \"╨ƒ╨╛ ╨┤╨╛╨│╨╛╨▓╨░╤Ç╤Å╨╜╨╡\",\r\n    carriers: [],\r\n  },\r\n] as const;\r\n\r\n// ============================================================================\r\n// Shipping Region Card Component\r\n// ============================================================================\r\nfunction ShippingRegionCard({\r\n  region,\r\n  isSelected,\r\n  onToggle,\r\n  isBg,\r\n}: {\r\n  region: typeof SHIPPING_REGIONS[number];\r\n  isSelected: boolean;\r\n  onToggle: () => void;\r\n  isBg: boolean;\r\n}) {\r\n  const Icon = region.icon;\r\n\r\n  return (\r\n    <label\r\n      className={cn(\r\n        \"relative flex items-start gap-3 p-3 rounded-md border text-left transition-colors w-full cursor-pointer\",\r\n        isSelected\r\n          ? \"border-selected-border bg-selected shadow-xs\"\r\n          : \"border-border bg-background hover:border-hover-border\"\r\n      )}\r\n    >\r\n      {/* Icon */}\r\n      <div className={cn(\r\n        \"size-9 rounded-full flex items-center justify-center shrink-0 border\",\r\n        isSelected ? \"bg-selected border-selected-border\" : \"bg-surface-subtle border-border/50\"\r\n      )}>\r\n        <Icon className={cn(\r\n          \"size-4.5\",\r\n          isSelected ? \"text-primary\" : \"text-muted-foreground\"\r\n        )} weight={isSelected ? \"fill\" : \"bold\"} />\r\n      </div>\r\n\r\n      {/* Content */}\r\n      <div className=\"flex-1 min-w-0\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <span className={cn(\r\n            \"font-bold text-sm tracking-tight\",\r\n            isSelected ? \"text-primary\" : \"text-foreground\"\r\n          )}>\r\n            {isBg ? region.labelBg : region.label}\r\n          </span>\r\n          <span className=\"text-2xs font-bold text-muted-foreground uppercase tracking-wider\">\r\n            {isBg ? region.deliveryTimeBg : region.deliveryTime}\r\n          </span>\r\n        </div>\r\n        <p className=\"text-xs text-muted-foreground font-medium mt-0.5\">\r\n          {isBg ? region.descriptionBg : region.description}\r\n        </p>\r\n        {region.carriers.length > 0 && isSelected && (\r\n          <div className=\"flex flex-wrap gap-1 mt-1.5\">\r\n            {region.carriers.map((carrier) => (\r\n              <span\r\n                key={carrier}\r\n                className=\"text-2xs font-bold px-1.5 py-0.5 rounded-md bg-surface-subtle text-primary border border-border\"\r\n              >\r\n                {carrier}\r\n              </span>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Checkbox */}\r\n      <Checkbox\r\n        checked={isSelected}\r\n        onCheckedChange={() => onToggle()}\r\n        className=\"size-4.5 rounded-md border-border data-[state=checked]:bg-primary data-[state=checked]:border-primary\"\r\n        aria-label={isBg ? region.labelBg : region.label}\r\n      />\r\n    </label>\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// Dimensions Input Component\r\n// ============================================================================\r\nfunction DimensionsInput({\r\n  dimensions,\r\n  onChange,\r\n  isBg,\r\n}: {\r\n  dimensions: { lengthCm?: number; widthCm?: number; heightCm?: number; weightKg?: number } | undefined;\r\n  onChange: (dims: { lengthCm?: number; widthCm?: number; heightCm?: number; weightKg?: number }) => void;\r\n  isBg: boolean;\r\n}) {\r\n  return (\r\n    <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-3\">\r\n      <div className=\"space-y-1.5\">\r\n        <Label className=\"text-xs font-bold text-muted-foreground uppercase tracking-wider\">{isBg ? \"╨ö╤è╨╗╨╢╨╕╨╜╨░\" : \"Length\"}</Label>\r\n        <div className=\"relative\">\r\n          <Input\r\n            type=\"number\"\r\n            placeholder=\"0\"\r\n            value={dimensions?.lengthCm || \"\"}\r\n            onChange={(e) =>\r\n              onChange({\r\n                ...(dimensions ?? {}),\r\n                ...(e.target.value ? { lengthCm: Number(e.target.value) } : {}),\r\n              })\r\n            }\r\n            className=\"h-10 pr-8 rounded-lg border-border font-medium\"\r\n          />\r\n          <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-2xs font-bold text-muted-foreground\">cm</span>\r\n        </div>\r\n      </div>\r\n      <div className=\"space-y-1.5\">\r\n        <Label className=\"text-xs font-bold text-muted-foreground uppercase tracking-wider\">{isBg ? \"╨¿╨╕╤Ç╨╕╨╜╨░\" : \"Width\"}</Label>\r\n        <div className=\"relative\">\r\n          <Input\r\n            type=\"number\"\r\n            placeholder=\"0\"\r\n            value={dimensions?.widthCm || \"\"}\r\n            onChange={(e) =>\r\n              onChange({\r\n                ...(dimensions ?? {}),\r\n                ...(e.target.value ? { widthCm: Number(e.target.value) } : {}),\r\n              })\r\n            }\r\n            className=\"h-10 pr-8 rounded-lg border-border font-medium\"\r\n          />\r\n          <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-2xs font-bold text-muted-foreground\">cm</span>\r\n        </div>\r\n      </div>\r\n      <div className=\"space-y-1.5\">\r\n        <Label className=\"text-xs font-bold text-muted-foreground uppercase tracking-wider\">{isBg ? \"╨Æ╨╕╤ü╨╛╤ç╨╕╨╜╨░\" : \"Height\"}</Label>\r\n        <div className=\"relative\">\r\n          <Input\r\n            type=\"number\"\r\n            placeholder=\"0\"\r\n            value={dimensions?.heightCm || \"\"}\r\n            onChange={(e) =>\r\n              onChange({\r\n                ...(dimensions ?? {}),\r\n                ...(e.target.value ? { heightCm: Number(e.target.value) } : {}),\r\n              })\r\n            }\r\n            className=\"h-10 pr-8 rounded-lg border-border font-medium\"\r\n          />\r\n          <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-2xs font-bold text-muted-foreground\">cm</span>\r\n        </div>\r\n      </div>\r\n      <div className=\"space-y-1.5\">\r\n        <Label className=\"text-xs font-bold text-muted-foreground uppercase tracking-wider\">{isBg ? \"╨ó╨╡╨│╨╗╨╛\" : \"Weight\"}</Label>\r\n        <div className=\"relative\">\r\n          <Input\r\n            type=\"number\"\r\n            step=\"0.1\"\r\n            placeholder=\"0\"\r\n            value={dimensions?.weightKg || \"\"}\r\n            onChange={(e) =>\r\n              onChange({\r\n                ...(dimensions ?? {}),\r\n                ...(e.target.value ? { weightKg: Number(e.target.value) } : {}),\r\n              })\r\n            }\r\n            className=\"h-10 pr-8 rounded-lg border-border font-medium\"\r\n          />\r\n          <span className=\"absolute right-2 top-1/2 -translate-y-1/2 text-2xs font-bold text-muted-foreground\">kg</span>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// SHIPPING FIELD - Shipping regions, city, dimensions using context\r\n// ============================================================================\r\n\r\ninterface ShippingFieldProps {\r\n  /** Custom class name for the field wrapper */\r\n  className?: string;\r\n  /** Use compact layout */\r\n  compact?: boolean;\r\n}\r\n\r\nexport function ShippingField({ className, compact = false }: ShippingFieldProps) {\r\n  const { setValue, watch } = useSellForm();\r\n  const { isBg } = useSellFormContext();\r\n  const tSell = useTranslations(\"Sell\")\r\n\r\n  const [isCityDrawerOpen, setIsCityDrawerOpen] = useState(false);\r\n  const [isProcessingDrawerOpen, setIsProcessingDrawerOpen] = useState(false);\r\n\r\n  // Watch shipping values - V1: Bulgaria only\r\n  const shipsToBulgaria = watch(\"shipsToBulgaria\");\r\n  const pickupOnly = watch(\"pickupOnly\");\r\n  const freeShipping = watch(\"freeShipping\");\r\n  const shippingPrice = watch(\"shippingPrice\");\r\n  const sellerCity = watch(\"sellerCity\");\r\n  const dimensions = watch(\"dimensions\");\r\n  const processingDays = watch(\"processingDays\");\r\n\r\n  const cleanDimensions = dimensions\r\n    ? {\r\n      ...(dimensions.lengthCm !== undefined ? { lengthCm: dimensions.lengthCm } : {}),\r\n      ...(dimensions.widthCm !== undefined ? { widthCm: dimensions.widthCm } : {}),\r\n      ...(dimensions.heightCm !== undefined ? { heightCm: dimensions.heightCm } : {}),\r\n      ...(dimensions.weightKg !== undefined ? { weightKg: dimensions.weightKg } : {}),\r\n    }\r\n    : undefined;\r\n\r\n  // V1: Only Bulgaria + Local Pickup\r\n  const regionValues = {\r\n    shipsToBulgaria,\r\n    pickupOnly,\r\n  };\r\n\r\n  const toggleRegion = (field: keyof typeof regionValues) => {\r\n    setValue(field, !regionValues[field], { shouldValidate: true });\r\n  };\r\n\r\n  const anyRegionSelected = Object.values(regionValues).some(Boolean);\r\n  const hasError = !anyRegionSelected;\r\n\r\n  const cityOptions = BULGARIAN_CITIES.map(c => c.label);\r\n  const cityOptionsBg = BULGARIAN_CITIES.map(c => c.labelBg);\r\n  const selectedCityLabel = BULGARIAN_CITIES.find(c => c.value === sellerCity)?.[isBg ? \"labelBg\" : \"label\"];\r\n\r\n  const processingOptions = [1, 2, 3, 5, 7, 10, 14].map(d => String(d));\r\n  const processingOptionsBg = [1, 2, 3, 5, 7, 10, 14].map(d => `${d} ${d === 1 ? \"╨┤╨╡╨╜\" : \"╨┤╨╜╨╕\"}`);\r\n  const processingOptionsEn = [1, 2, 3, 5, 7, 10, 14].map(d => `${d} ${d === 1 ? \"day\" : \"days\"}`);\r\n\r\n  const content = (\r\n    <FieldContent className={cn(\"space-y-6\", !compact && \"p-6\")}>\r\n      {/* Shipping Regions */}\r\n      <div className=\"space-y-3\">\r\n        <Label className=\"text-sm font-semibold\">\r\n          {isBg ? \"╨á╨╡╨│╨╕╨╛╨╜╨╕ ╨╖╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░\" : \"Shipping Regions\"}\r\n        </Label>\r\n        <div className=\"grid gap-3 sm:grid-cols-2\">\r\n          {SHIPPING_REGIONS.map((region) => (\r\n            <ShippingRegionCard\r\n              key={region.id}\r\n              region={region}\r\n              isSelected={regionValues[region.field]}\r\n              onToggle={() => toggleRegion(region.field)}\r\n              isBg={isBg}\r\n            />\r\n          ))}\r\n        </div>\r\n        {hasError && (\r\n          <FieldError>\r\n            {tSell(\"validation.shippingRegionRequired\" as never)}\r\n          </FieldError>\r\n        )}\r\n      </div>\r\n\r\n      {/* Seller City (for Bulgaria or Pickup) */}\r\n      {(shipsToBulgaria || pickupOnly) && (\r\n        <div className=\"space-y-2\">\r\n          {compact ? (\r\n            <>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setIsCityDrawerOpen(true)}\r\n                  className={cn(\r\n                    \"w-full flex items-center gap-3.5 min-h-16 px-4 py-3 rounded-xl border text-left transition-colors\",\r\n                    \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring\",\r\n                    sellerCity \r\n                      ? \"border-selected-border bg-selected\" \r\n                      : \"border-border bg-card hover:bg-hover\"\r\n                  )}\r\n                >\r\n                  <div className={cn(\r\n                    \"size-11 rounded-xl flex items-center justify-center shrink-0 transition-colors\",\r\n                    sellerCity ? \"bg-selected text-primary\" : \"bg-muted text-muted-foreground\"\r\n                  )}>\r\n                    <MapPin className=\"size-5\" weight={sellerCity ? \"fill\" : \"regular\"} />\r\n                  </div>\r\n                  <div className=\"flex-1 min-w-0\">\r\n                  <div className=\"flex items-center gap-1.5\">\r\n                    <span className=\"text-xs font-bold uppercase tracking-wider text-muted-foreground\">\r\n                      {isBg ? \"╨¢╨╛╨║╨░╤å╨╕╤Å\" : \"Ships from\"}\r\n                    </span>\r\n                    <span className=\"text-destructive text-xs\">*</span>\r\n                  </div>\r\n                  <span className={cn(\r\n                    \"text-base font-semibold truncate block mt-0.5\",\r\n                    sellerCity ? \"text-foreground\" : \"text-text-subtle\"\r\n                  )}>\r\n                    {selectedCityLabel || (isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨│╤Ç╨░╨┤...\" : \"Select your city\")}\r\n                  </span>\r\n                </div>\r\n                <CaretRight className={cn(\r\n                  \"size-5 shrink-0 transition-colors\",\r\n                  sellerCity ? \"text-primary\" : \"text-text-subtle\"\r\n                )} weight=\"bold\" />\r\n              </button>\r\n              <SelectDrawer\r\n                isOpen={isCityDrawerOpen}\r\n                onClose={() => setIsCityDrawerOpen(false)}\r\n                title={isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨│╤Ç╨░╨┤\" : \"Select City\"}\r\n                options={BULGARIAN_CITIES.map(c => c.value)}\r\n                optionsBg={isBg ? cityOptionsBg : cityOptions}\r\n                value={sellerCity || \"\"}\r\n                onChange={(val) => setValue(\"sellerCity\", val)}\r\n                locale={isBg ? \"bg\" : \"en\"}\r\n              />\r\n            </>\r\n          ) : (\r\n            <>\r\n              <Label className=\"text-sm font-semibold\">\r\n                {isBg ? \"╨Æ╨░╤ê╨╕╤Å╤é ╨│╤Ç╨░╨┤\" : \"Your City\"} *\r\n              </Label>\r\n              <Select\r\n                value={sellerCity || \"\"}\r\n                onValueChange={(val) => setValue(\"sellerCity\", val)}\r\n              >\r\n                <SelectTrigger className=\"h-12 rounded-md border-border font-medium\">\r\n                  <SelectValue placeholder={isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨│╤Ç╨░╨┤...\" : \"Select city...\"} />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {BULGARIAN_CITIES.map((city) => (\r\n                    <SelectItem key={city.value} value={city.value} className=\"font-medium\">\r\n                      {isBg ? city.labelBg : city.label}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </>\r\n          )}\r\n          <p className=\"text-xs text-muted-foreground font-medium px-1\">\r\n            {isBg\r\n              ? \"╨ô╤Ç╨░╨┤╤è╤é, ╨╛╤é ╨║╨╛╨╣╤é╨╛ ╤ë╨╡ ╨╕╨╖╨┐╤Ç╨░╤ë╨░╤é╨╡\"\r\n              : \"The city you'll ship from\"}\r\n          </p>\r\n        </div>\r\n      )}\r\n\r\n      {/* Free Shipping Toggle - Premium pill design */}\r\n      <div\r\n        role=\"button\"\r\n        tabIndex={0}\r\n        onClick={() => {\r\n          setValue(\"freeShipping\", !freeShipping);\r\n          if (!freeShipping) {\r\n            setValue(\"shippingPrice\", \"0\");\r\n          }\r\n        }}\r\n        onKeyDown={(e) => {\r\n          if (e.key === \"Enter\" || e.key === \" \") {\r\n            e.preventDefault();\r\n            setValue(\"freeShipping\", !freeShipping);\r\n            if (!freeShipping) {\r\n              setValue(\"shippingPrice\", \"0\");\r\n            }\r\n          }\r\n        }}\r\n        className={cn(\r\n          \"w-full flex items-center gap-3.5 p-4 rounded-xl border transition-colors cursor-pointer\",\r\n          \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring\",\r\n          freeShipping \r\n            ? \"border-selected-border bg-selected\" \r\n            : \"border-border bg-card hover:bg-hover\"\r\n        )}\r\n      >\r\n        <div className={cn(\r\n          \"size-11 rounded-xl flex items-center justify-center shrink-0 transition-all\",\r\n          freeShipping \r\n            ? \"bg-selected text-primary\" \r\n            : \"bg-muted text-muted-foreground\"\r\n        )}>\r\n          <Truck className=\"size-5\" weight={freeShipping ? \"fill\" : \"regular\"} />\r\n        </div>\r\n        <div className=\"flex-1 text-left min-w-0\">\r\n          <span className=\"text-base font-semibold block\">\r\n            {isBg ? \"╨æ╨╡╨╖╨┐╨╗╨░╤é╨╜╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░\" : \"Free shipping\"}\r\n          </span>\r\n          <span className=\"text-sm text-muted-foreground line-clamp-1\">\r\n            {isBg\r\n              ? \"╨ƒ╤Ç╨╕╨▓╨╗╨╡╤ç╨╡╤é╨╡ ╨┐╨╛╨▓╨╡╤ç╨╡ ╨║╤â╨┐╤â╨▓╨░╤ç╨╕\"\r\n              : \"Attract more buyers with free delivery\"}\r\n          </span>\r\n        </div>\r\n        <Switch \r\n          checked={freeShipping} \r\n          onCheckedChange={(checked) => {\r\n            setValue(\"freeShipping\", checked);\r\n            if (checked) {\r\n              setValue(\"shippingPrice\", \"0\");\r\n            }\r\n          }}\r\n          className=\"shrink-0 scale-110\"\r\n        />\r\n      </div>\r\n\r\n      {/* Shipping Price (if not free) */}\r\n      {!freeShipping && (\r\n        <div className=\"space-y-2\">\r\n          <div className=\"flex items-center justify-between px-1\">\r\n            <label className=\"text-sm font-bold text-foreground\">\r\n              {isBg ? \"╨ª╨╡╨╜╨░ ╨╖╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░\" : \"Shipping price\"}\r\n            </label>\r\n          </div>\r\n          <div className={cn(\r\n            \"flex items-center h-14 px-4 rounded-xl border bg-card transition-colors\",\r\n            \"focus-within:ring-2 focus-within:ring-ring focus-within:border-ring\"\r\n          )}>\r\n            <span className=\"text-base font-bold text-muted-foreground mr-2\">╨╗╨▓</span>\r\n            <Input\r\n              type=\"text\"\r\n              inputMode=\"decimal\"\r\n              placeholder=\"0.00\"\r\n              value={shippingPrice || \"\"}\r\n              onChange={(e) => setValue(\"shippingPrice\", e.target.value)}\r\n              className=\"border-none bg-transparent h-full text-lg font-semibold p-0 focus-visible:ring-0 flex-1\"\r\n            />\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Package Dimensions */}\r\n      <div className=\"space-y-3\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <Package className=\"size-4 text-muted-foreground\" weight=\"bold\" />\r\n          <Label className=\"text-sm font-semibold\">\r\n            {isBg ? \"╨á╨░╨╖╨╝╨╡╤Ç╨╕ ╨╜╨░ ╨┐╤Ç╨░╤é╨║╨░╤é╨░ (╨┐╨╛ ╨╕╨╖╨▒╨╛╤Ç)\" : \"Package Dimensions (optional)\"}\r\n          </Label>\r\n        </div>\r\n        <DimensionsInput\r\n          dimensions={cleanDimensions}\r\n          onChange={(dims) => {\r\n            const next = dims\r\n              ? {\r\n                ...(dims.lengthCm !== undefined ? { lengthCm: dims.lengthCm } : {}),\r\n                ...(dims.widthCm !== undefined ? { widthCm: dims.widthCm } : {}),\r\n                ...(dims.heightCm !== undefined ? { heightCm: dims.heightCm } : {}),\r\n                ...(dims.weightKg !== undefined ? { weightKg: dims.weightKg } : {}),\r\n              }\r\n              : undefined;\r\n            setValue(\"dimensions\", next);\r\n          }}\r\n          isBg={isBg}\r\n        />\r\n      </div>\r\n\r\n      {/* Processing Time */}\r\n      <div className=\"space-y-2\">\r\n        {compact ? (\r\n          <>\r\n            <button\r\n              type=\"button\"\r\n              onClick={() => setIsProcessingDrawerOpen(true)}\r\n              className=\"relative w-full flex items-center h-12 px-4 rounded-md border border-border bg-background hover:border-hover-border transition-colors text-left shadow-xs\"\r\n            >\r\n              <div className=\"flex items-center gap-2 flex-1 min-w-0\">\r\n                <span className=\"text-2xs font-bold uppercase tracking-wider text-muted-foreground shrink-0\">\r\n                  {isBg ? \"╨₧╨▒╤Ç╨░╨▒╨╛╤é╨║╨░:\" : \"Processing:\"}\r\n                </span>\r\n                <span className=\"text-sm font-semibold text-foreground truncate\">\r\n                  {processingDays} {isBg ? (processingDays === 1 ? \"╨┤╨╡╨╜\" : \"╨┤╨╜╨╕\") : (processingDays === 1 ? \"day\" : \"days\")}\r\n                </span>\r\n              </div>\r\n              <CaretRight className=\"size-4 text-text-subtle shrink-0 ml-2\" weight=\"bold\" />\r\n            </button>\r\n            <SelectDrawer\r\n              isOpen={isProcessingDrawerOpen}\r\n              onClose={() => setIsProcessingDrawerOpen(false)}\r\n              title={isBg ? \"╨Æ╤Ç╨╡╨╝╨╡ ╨╖╨░ ╨╛╨▒╤Ç╨░╨▒╨╛╤é╨║╨░\" : \"Processing Time\"}\r\n              options={processingOptions}\r\n              optionsBg={isBg ? processingOptionsBg : processingOptionsEn}\r\n              value={String(processingDays)}\r\n              onChange={(val) => setValue(\"processingDays\", Number(val))}\r\n              locale={isBg ? \"bg\" : \"en\"}\r\n            />\r\n          </>\r\n        ) : (\r\n          <>\r\n            <Label className=\"text-sm font-semibold\">\r\n              {isBg ? \"╨Æ╤Ç╨╡╨╝╨╡ ╨╖╨░ ╨╛╨▒╤Ç╨░╨▒╨╛╤é╨║╨░\" : \"Processing Time\"}\r\n            </Label>\r\n            <Select\r\n              value={String(processingDays)}\r\n              onValueChange={(val) => setValue(\"processingDays\", Number(val))}\r\n            >\r\n              <SelectTrigger className=\"h-12 w-44 rounded-md border-border font-medium\">\r\n                <SelectValue />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                {[1, 2, 3, 5, 7, 10, 14].map((days) => (\r\n                  <SelectItem key={days} value={String(days)} className=\"font-medium\">\r\n                    {days} {isBg ? (days === 1 ? \"╨┤╨╡╨╜\" : \"╨┤╨╜╨╕\") : (days === 1 ? \"day\" : \"days\")}\r\n                  </SelectItem>\r\n                ))}\r\n              </SelectContent>\r\n            </Select>\r\n          </>\r\n        )}\r\n        <p className=\"text-xs text-muted-foreground font-medium px-1\">\r\n          {isBg\r\n            ? \"╨Æ╤Ç╨╡╨╝╨╡ ╨╖╨░ ╨┐╨╛╨┤╨│╨╛╤é╨╛╨▓╨║╨░ ╨╜╨░ ╨┐╨╛╤Ç╤è╤ç╨║╨░╤é╨░ ╨┐╤Ç╨╡╨┤╨╕ ╨╕╨╖╨┐╤Ç╨░╤ë╨░╨╜╨╡\"\r\n            : \"Time to prepare the order before shipping\"}\r\n        </p>\r\n      </div>\r\n    </FieldContent>\r\n  );\r\n\r\n  return (\r\n    <Field data-invalid={hasError} className={className}>\r\n      {!compact ? (\r\n        <div className=\"rounded-md border border-form-section-border bg-form-section-bg overflow-hidden shadow-xs\">\r\n          {/* Header */}\r\n          <div className=\"p-4 pb-3 border-b border-border/50 bg-surface-subtle\">\r\n            <div className=\"flex items-center gap-3.5\">\r\n              <div className=\"flex size-10 items-center justify-center rounded-md bg-form-section-bg border border-form-section-border shadow-xs\">\r\n                <Truck className=\"size-5 text-muted-foreground\" weight=\"bold\" />\r\n              </div>\r\n              <div>\r\n                <FieldLabel className=\"text-sm font-bold tracking-tight text-foreground\">\r\n                  {isBg ? \"╨ö╨╛╤ü╤é╨░╨▓╨║╨░\" : \"Shipping\"}\r\n                </FieldLabel>\r\n                <FieldDescription className=\"text-xs font-medium text-muted-foreground mt-0.5\">\r\n                  {isBg\r\n                    ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╤Ç╨╡╨│╨╕╨╛╨╜╨╕╤é╨╡, ╨┤╨╛ ╨║╨╛╨╕╤é╨╛ ╨┤╨╛╤ü╤é╨░╨▓╤Å╤é╨╡\"\r\n                    : \"Select regions you can ship to\"}\r\n                </FieldDescription>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {content}\r\n        </div>\r\n      ) : (\r\n        <>\r\n          {/* Compact Label - hidden if we use label inside */}\r\n          <div className=\"hidden\">\r\n            <div className=\"flex items-center gap-2 mb-2\">\r\n              <Truck className=\"size-4 text-muted-foreground\" weight=\"bold\" />\r\n              <FieldLabel className=\"text-sm font-medium\">\r\n                {isBg ? \"╨ö╨╛╤ü╤é╨░╨▓╨║╨░\" : \"Shipping\"}\r\n              </FieldLabel>\r\n            </div>\r\n          </div>\r\n          {content}\r\n        </>\r\n      )}\r\n    </Field>\r\n  );\r\n}\r\n\r\n/**\r\n * Memoized ShippingField - Shipping regions, city, and dimensions selector.\r\n * Optimized to prevent unnecessary re-renders when unrelated form state changes.\r\n * @see useSellForm - Hook for form state access\r\n * @see useSellFormContext - Hook for context access\r\n */\r\nconst MemoizedShippingField = memo(ShippingField);\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\fields\\title-field.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MemoizedTitleField' is assigned a value but never used.","line":143,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":143,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { memo } from \"react\";\nimport { Controller } from \"react-hook-form\";\nimport { TextAa } from \"@phosphor-icons/react\";\nimport { Input } from \"@/components/ui/input\";\nimport { Field, FieldLabel, FieldDescription, FieldError, FieldContent } from \"@/components/shared/field\";\nimport { cn } from \"@/lib/utils\";\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\nimport { useTranslations } from \"next-intl\";\n\r\n// ============================================================================\r\n// TITLE FIELD - Product title input with character count\r\n// Mobile-first: 48px input height, clear labels, readable character counter\r\n// ============================================================================\r\n\r\ninterface TitleFieldProps {\r\n  /** Custom class name for the field wrapper */\r\n  className?: string;\r\n  /** Prefix for DOM ids (prevents duplicates across layouts) */\r\n  idPrefix?: string;\r\n  /** Minimum characters required */\r\n  minLength?: number;\r\n  /** Maximum characters allowed */\r\n  maxLength?: number;\r\n  /** Use compact layout (no section wrapper) */\r\n  compact?: boolean;\r\n}\r\n\r\nexport function TitleField({\r\n  className,\r\n  idPrefix = \"sell-form\",\r\n  minLength = 5,\r\n  maxLength = 80,\r\n  compact = false\n}: TitleFieldProps) {\n  const { control, watch } = useSellForm();\n  const { isBg } = useSellFormContext();\n  const tSell = useTranslations(\"Sell\")\n\r\n  const currentValue = watch(\"title\") || \"\";\r\n  const charCount = currentValue.length;\r\n  const inputId = `${idPrefix}-title`;\r\n\r\n  return (\r\n    <Controller\r\n      name=\"title\"\r\n      control={control}\r\n      render={({ field, fieldState }) => (\r\n        <Field data-invalid={fieldState.invalid} className={className}>\r\n          {/* Section Header (non-compact mode) */}\r\n          {!compact && (\r\n            <div className=\"p-4 pb-3 border-b border-form-section-border bg-surface-subtle\">\r\n              <div className=\"flex items-center gap-3.5\">\r\n                <div className=\"flex size-10 items-center justify-center rounded-md bg-form-section-bg border border-form-section-border shadow-xs\">\r\n                  <TextAa className=\"size-5 text-muted-foreground\" weight=\"bold\" />\r\n                </div>\r\n                <div>\r\n                  <FieldLabel className=\"text-sm font-bold tracking-tight text-foreground\">\r\n                    {isBg ? \"╨ù╨░╨│╨╗╨░╨▓╨╕╨╡\" : \"Title\"}\r\n                  </FieldLabel>\r\n                  <FieldDescription className=\"text-xs font-medium text-muted-foreground mt-0.5\">\r\n                    {isBg\r\n                      ? `${minLength}-${maxLength} ╤ü╨╕╨╝╨▓╨╛╨╗╨░. ╨æ╤è╨┤╨╡╤é╨╡ ╨║╨╛╨╜╨║╤Ç╨╡╤é╨╜╨╕.`\r\n                      : `${minLength}-${maxLength} characters. Be specific.`}\r\n                  </FieldDescription>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Compact Label - hidden if we use label inside */}\r\n          {compact && (\r\n            <div className=\"hidden\">\r\n              <FieldLabel className=\"text-xs font-bold text-muted-foreground uppercase tracking-wider mb-2 block\">\r\n                {isBg ? \"╨ù╨░╨│╨╗╨░╨▓╨╕╨╡\" : \"Title\"}\r\n              </FieldLabel>\r\n            </div>\r\n          )}\r\n\r\n          {/* Input - Premium card design */}\r\n          <FieldContent className={cn(!compact && \"p-5\")}>\r\n            <div className=\"space-y-2\">\r\n              {compact && (\r\n                <div className=\"flex items-center justify-between px-1\">\r\n                  <label htmlFor={inputId} className=\"text-sm font-bold text-foreground\">\r\n                    {isBg ? \"╨ù╨░╨│╨╗╨░╨▓╨╕╨╡\" : \"Title\"} <span className=\"text-destructive\">*</span>\r\n                  </label>\r\n                  <span className={cn(\r\n                    \"text-xs font-bold tabular-nums\",\r\n                    charCount > maxLength - 10 ? \"text-warning\" : \"text-muted-foreground\"\r\n                  )}>\r\n                    {charCount}/{maxLength}\r\n                  </span>\r\n                </div>\r\n              )}\r\n              <div className={cn(\r\n                \"relative rounded-xl border bg-card overflow-hidden transition-all\",\r\n                \"focus-within:ring-2 focus-within:ring-ring focus-within:border-ring\",\r\n                fieldState.invalid ? \"border-destructive/50 bg-destructive-subtle\" : \"border-border\"\n              )}>\r\n                <Input\r\n                  {...field}\r\n                  id={inputId}\r\n                  aria-invalid={fieldState.invalid}\r\n                  placeholder={isBg\r\n                    ? \"╨¥╨░╨┐╤Ç. iPhone 15 Pro Max 256GB\"\r\n                    : \"e.g., iPhone 15 Pro Max 256GB\"}\r\n                  maxLength={maxLength}\r\n                  className=\"border-none bg-transparent h-14 px-4 text-base font-medium placeholder:text-muted-foreground focus-visible:ring-0\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            {/* Helper text - shows progress toward minimum */}\r\n            {charCount > 0 && charCount < minLength && (\r\n              <p className=\"mt-2 text-sm font-medium text-primary flex items-center gap-1.5 px-1\">\r\n                {isBg\r\n                  ? `╨ö╨╛╨▒╨░╨▓╨╡╤é╨╡ ╨╛╤ë╨╡ ${minLength - charCount} ╤ü╨╕╨╝╨▓╨╛╨╗╨░`\r\n                  : `Add ${minLength - charCount} more characters`}\r\n              </p>\r\n            )}\r\n\r\n            {/* Error Message */}\r\n            {fieldState.invalid && (\n              <FieldError className=\"mt-form-sm\">\n                {fieldState.error?.message ? tSell(fieldState.error.message as never) : null}\n              </FieldError>\n            )}\n          </FieldContent>\n        </Field>\n      )}\n    />\r\n  );\r\n}\r\n\r\n/**\r\n * Memoized TitleField - Product title input with character count.\r\n * Optimized to prevent unnecessary re-renders when unrelated form state changes.\r\n * @see useSellForm - Hook for form state access\r\n * @see useSellFormContext - Hook for context access\r\n */\r\nconst MemoizedTitleField = memo(TitleField);\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\layouts\\desktop-layout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useTransition' is defined but never used.","line":3,"column":33,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":46,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useTransition"},"fix":{"range":[47,62],"text":""},"desc":"Remove unused variable \"useTransition\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setCurrentStep' is assigned a value but never used.","line":58,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":58,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'categories' is assigned a value but never used.","line":64,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":64,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showReview' is assigned a value but never used.","line":67,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":67,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleSubmit' is assigned a value but never used.","line":84,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":84,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useCallback, useState, useTransition } from \"react\";\r\nimport {\r\n  Rocket,\r\n  Sparkle,\r\n  Spinner,\r\n  ArrowRight,\r\n  Check,\r\n  Warning,\r\n  X,\r\n} from \"@phosphor-icons/react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { PageContainer } from \"@/components/shared/page-container\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\r\nimport {\r\n  PhotosField,\r\n  CategoryField,\r\n  ConditionField,\r\n  TitleField,\r\n  DescriptionField,\r\n  BrandField,\r\n  PricingField,\r\n  ShippingField,\r\n  AttributesField,\r\n} from \"../fields\";\r\nimport { ProgressHeader, ChecklistSidebar } from \"../ui\";\r\nimport { AiListingAssistant } from \"../ai/ai-listing-assistant\";\r\n\r\n// ============================================================================\r\n// DESKTOP LAYOUT - Two-column layout with all fields visible\r\n// Phase 4: Responsive Unification\r\n// ============================================================================\r\n\r\nimport type { SellFormDataV4 } from \"@/lib/sell/schema-v4\";\r\n\r\ninterface DesktopLayoutProps {\r\n  onSubmit: (data: SellFormDataV4) => void;\r\n  submitError: string | null;\r\n  setSubmitError: (error: string | null) => void;\r\n  isSubmitting?: boolean;\r\n}\r\n\r\nexport function DesktopLayout({\r\n  onSubmit,\r\n  submitError,\r\n  setSubmitError,\r\n  isSubmitting = false,\r\n}: DesktopLayoutProps) {\r\n  const form = useSellForm();\r\n  const {\r\n    isBg,\r\n    progress,\r\n    progressItems,\r\n    currentStep,\r\n    setCurrentStep,\r\n    totalSteps,\r\n    isSaving,\r\n    autoSaved,\r\n    hasUnsavedChanges,\r\n    saveDraft,\r\n    categories,\r\n  } = useSellFormContext();\r\n\r\n  const [showReview, setShowReview] = useState(false);\r\n\r\n  const formValues = form.watch();\r\n\r\n  // Open review screen\r\n  const handleOpenReview = useCallback(async () => {\r\n    setSubmitError(null);\r\n    const ok = await form.trigger();\r\n    setShowReview(true);\r\n    window.scrollTo({ top: 0, behavior: \"instant\" });\r\n\r\n    if (!ok) {\r\n      // toast handled in form validation\r\n    }\r\n  }, [form, setSubmitError]);\r\n\r\n  // Handle form submission\r\n  const handleSubmit = useCallback(() => {\r\n    form.handleSubmit(\r\n      (data) => {\r\n        onSubmit(data);\r\n      },\r\n      () => {\r\n        // Validation errors handled by react-hook-form\r\n      }\r\n    )();\r\n  }, [onSubmit, form]);\r\n\r\n  // Manual save\r\n  const handleSaveDraft = useCallback(() => {\r\n    saveDraft();\r\n  }, [saveDraft]);\r\n\r\n  // Tips card data\r\n  const tips = [\r\n    { en: \"Quality photos increase sales\", bg: \"╨Ü╨░╤ç╨╡╤ü╤é╨▓╨╡╨╜╨╕ ╤ü╨╜╨╕╨╝╨║╨╕ ╤â╨▓╨╡╨╗╨╕╤ç╨░╨▓╨░╤é ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕╤é╨╡\" },\r\n    { en: \"Detailed descriptions build trust\", bg: \"╨ƒ╨╛╨┤╤Ç╨╛╨▒╨╜╨╛ ╨╛╨┐╨╕╤ü╨░╨╜╨╕╨╡ ╨╕╨╖╨│╤Ç╨░╨╢╨┤╨░ ╨┤╨╛╨▓╨╡╤Ç╨╕╨╡\" },\r\n    { en: \"Competitive pricing attracts buyers\", bg: \"╨Ü╨╛╨╜╨║╤â╤Ç╨╡╨╜╤é╨╜╨░ ╤å╨╡╨╜╨░ ╨┐╤Ç╨╕╨▓╨╗╨╕╤ç╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨╕\" },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"flex flex-1 flex-col pb-8\">\r\n      {/* Sticky Header with Progress */}\r\n      <ProgressHeader\r\n        progressPercent={progress}\r\n        autoSaved={autoSaved}\r\n        isSaving={isSaving}\r\n        hasUnsavedChanges={hasUnsavedChanges}\r\n        onSaveDraft={handleSaveDraft}\r\n        locale={isBg ? \"bg\" : \"en\"}\r\n        currentStep={currentStep}\r\n        totalSteps={totalSteps}\r\n      />\r\n\r\n      {/* Main Content */}\r\n      <PageContainer size=\"wide\" className=\"py-4\">\r\n        <div className=\"grid gap-4 lg:grid-cols-sell-main xl:grid-cols-sell-main-xl\">\n          {/* Main Form */}\r\n          <div className=\"min-w-0\">\r\n            <form\r\n              onSubmit={(e) => {\r\n                e.preventDefault();\r\n                void handleOpenReview();\r\n              }}\r\n              className=\"space-y-6\"\r\n            >\r\n              {/* Section 1: Photos & AI */}\r\n              <section className=\"space-y-6 rounded-md border border-border bg-background p-6\">\r\n                <h2 className=\"text-base font-semibold text-foreground\">\r\n                  {isBg ? \"╨í╨╜╨╕╨╝╨║╨╕\" : \"Photos\"}\r\n                </h2>\r\n                <PhotosField maxPhotos={12} compact />\r\n\r\n                {/* AI Assistant - Show after first photo */}\r\n                {(formValues.images?.length ?? 0) > 0 && (\r\n                  <div className=\"pt-4 border-t border-border\">\r\n                    <AiListingAssistant />\r\n                  </div>\r\n                )}\r\n              </section>\r\n\r\n              {/* Section 2: Item Details */}\r\n              <section className=\"space-y-6 rounded-md border border-border bg-background p-6\">\r\n                <h2 className=\"text-base font-semibold text-foreground\">\r\n                  {isBg ? \"╨ö╨╡╤é╨░╨╣╨╗╨╕\" : \"Details\"}\r\n                </h2>\r\n\r\n                <TitleField compact idPrefix=\"sell-form-desktop\" />\r\n                <CategoryField compact />\r\n                <ConditionField compact />\r\n                <BrandField compact />\r\n                <DescriptionField compact idPrefix=\"sell-form-desktop\" />\r\n                <AttributesField compact />\r\n              </section>\r\n\r\n              {/* Section 3: Pricing & Shipping */}\r\n              <section className=\"space-y-6 rounded-md border border-border bg-background p-6\">\r\n                <h2 className=\"text-base font-semibold text-foreground\">\r\n                  {isBg ? \"╨ª╨╡╨╜╨░ ╨╕ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░\" : \"Pricing & Shipping\"}\r\n                </h2>\r\n\r\n                <PricingField compact idPrefix=\"sell-form-desktop\" />\r\n                <ShippingField compact />\r\n              </section>\r\n\r\n              {/* Error Display */}\r\n              {submitError && (\r\n                <div className=\"flex items-center gap-3 p-4 rounded-lg bg-destructive-subtle text-destructive border border-destructive/20\">\n                  <Warning className=\"size-5 shrink-0\" />\r\n                  <p className=\"text-sm flex-1\">{submitError}</p>\r\n                  <Button\r\n                    type=\"button\"\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    className=\"h-8 w-8 p-0 shrink-0\"\r\n                    onClick={() => setSubmitError(null)}\r\n                  >\r\n                    <X className=\"size-4\" />\r\n                  </Button>\r\n                </div>\r\n              )}\r\n\r\n              {/* Submit Button */}\r\n              <Button\r\n                type=\"submit\"\r\n                disabled={isSubmitting}\r\n                size=\"lg\"\r\n                className={cn(\r\n                  \"w-full h-12 rounded-md gap-2 text-sm font-semibold\",\r\n                  progress !== 100 && \"bg-muted text-muted-foreground hover:bg-hover active:bg-active\"\r\n                )}\r\n              >\r\n                {isSubmitting ? (\r\n                  <>\r\n                    <Spinner className=\"size-5 animate-spin\" />\r\n                    {isBg ? \"╨ƒ╤â╨▒╨╗╨╕╨║╤â╨▓╨░╨╜╨╡...\" : \"Publishing...\"}\r\n                  </>\r\n                ) : progress === 100 ? (\r\n                  <>\r\n                    <Rocket className=\"size-5\" weight=\"bold\" />\r\n                    {isBg ? \"╨ƒ╤Ç╨╡╨│╨╗╨╡╨┤ ╨╕ ╨┐╤â╨▒╨╗╨╕╨║╤â╨▓╨░╨╜╨╡\" : \"Review & publish\"}\r\n                    <ArrowRight className=\"size-5\" weight=\"bold\" />\r\n                  </>\r\n                ) : (\r\n                  <>\r\n                    <Sparkle className=\"size-5\" weight=\"bold\" />\r\n                    {isBg ? `╨ƒ╤Ç╨╡╨│╨╗╨╡╨┤ (${progress}%)` : `Review (${progress}%)`}\r\n                  </>\r\n                )}\r\n              </Button>\r\n\r\n              {progress < 100 && (\r\n                <p className=\"text-center text-sm text-muted-foreground\">\r\n                  {isBg\r\n                    ? \"╨ƒ╨╛╨┐╤è╨╗╨╜╨╡╤é╨╡ ╨▓╤ü╨╕╤ç╨║╨╕ ╨╖╨░╨┤╤è╨╗╨╢╨╕╤é╨╡╨╗╨╜╨╕ ╨┐╨╛╨╗╨╡╤é╨░, ╨╖╨░ ╨┤╨░ ╨┐╤â╨▒╨╗╨╕╨║╤â╨▓╨░╤é╨╡\"\r\n                    : \"Complete all required fields to publish your listing\"}\r\n                </p>\r\n              )}\r\n            </form>\r\n          </div>\r\n\r\n          {/* Desktop Sidebar */}\r\n          <aside className=\"hidden lg:block\">\r\n            <div className=\"sticky top-20 space-y-4\">\r\n              <ChecklistSidebar items={progressItems} />\n\r\n              {/* Tips Card */}\r\n              <div className=\"p-4 rounded-md border border-border bg-background shadow-xs\">\r\n                <div className=\"flex items-center gap-2.5 mb-4\">\r\n                  <div className=\"flex size-8 items-center justify-center rounded-md bg-selected border border-selected-border\">\r\n                    <Sparkle className=\"size-4 text-primary\" weight=\"bold\" />\r\n                  </div>\r\n                  <h4 className=\"text-sm font-semibold text-foreground\">\r\n                    {isBg ? \"╨í╤è╨▓╨╡╤é╨╕ ╨╖╨░ ╨┐╤Ç╨╛╨┤╨░╨╢╨▒╨╕\" : \"Selling Tips\"}\r\n                  </h4>\r\n                </div>\r\n                <ul className=\"space-y-3\">\r\n                  {tips.map((tip, index) => (\r\n                    <li key={index} className=\"flex items-start gap-3\">\r\n                      <div className=\"size-4 rounded-full bg-selected flex items-center justify-center shrink-0 mt-0.5\">\r\n                        <Check className=\"size-2.5 text-primary\" weight=\"bold\" />\r\n                      </div>\r\n                      <span className=\"text-sm text-muted-foreground leading-relaxed\">\r\n                        {isBg ? tip.bg : tip.en}\r\n                      </span>\r\n                    </li>\r\n                  ))}\r\n                </ul>\r\n              </div>\r\n            </div>\r\n          </aside>\r\n        </div>\r\n      </PageContainer>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\layouts\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\layouts\\mobile-layout.tsx","messages":[{"ruleId":"sonarjs/prefer-immediate-return","severity":1,"message":"Immediately return this expression instead of assigning it to the temporary variable \"hasPrice\".","line":66,"column":24,"nodeType":"CallExpression","messageId":"doImmediateAction","endLine":66,"endColumn":70,"fix":{"range":[2393,2480],"text":"return Boolean(price && Number.parseFloat(price) > 0)"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\";\r\n\r\nimport { useMemo } from \"react\";\r\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\r\nimport {\r\n  StepWhat,\r\n  StepCategory,\r\n  StepDetails,\r\n  StepPricing,\r\n  StepReview,\r\n} from \"../steps\";\r\nimport { StepperWrapper } from \"./stepper-wrapper\";\r\nimport type { SellFormDataV4 } from \"@/lib/sell/schema-v4\";\r\n\r\n// ============================================================================\r\n// MOBILE LAYOUT - Premium 5-step wizard with Framer Motion animations\r\n// New flow: What ΓåÆ Category ΓåÆ Details ΓåÆ Pricing ΓåÆ Review\r\n// Following the PLAN-sell-form-masterpiece.md spec\r\n// ============================================================================\r\n\r\n// Step configuration for mobile wizard (5-step flow)\r\n// 1) What: title + 1 photo (low friction entry)\r\n// 2) Category: full-screen picker (determines subsequent fields)\r\n// 3) Details: condition + attributes + description + additional photos\r\n// 4) Pricing: price + shipping options\r\n// 5) Review: final validation + publish\r\nconst MOBILE_STEPS = [\r\n  { id: 1, title: { en: \"What\", bg: \"╨Ü╨░╨║╨▓╨╛\" }, fields: [\"title\", \"images\"] },\r\n  { id: 2, title: { en: \"Category\", bg: \"╨Ü╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å\" }, fields: [\"categoryId\"] },\r\n  { id: 3, title: { en: \"Details\", bg: \"╨ö╨╡╤é╨░╨╣╨╗╨╕\" }, fields: [\"condition\"] },\r\n  { id: 4, title: { en: \"Price\", bg: \"╨ª╨╡╨╜╨░\" }, fields: [\"price\", \"shippingPrice\", \"sellerCity\"] },\r\n  { id: 5, title: { en: \"Review\", bg: \"╨ƒ╤Ç╨╡╨│╨╗╨╡╨┤\" }, fields: [] },\r\n];\r\n\r\ninterface MobileLayoutProps {\r\n  onSubmit: (data: SellFormDataV4) => void;\r\n  isSubmitting?: boolean;\r\n}\r\n\r\nexport function MobileLayout({ onSubmit, isSubmitting = false }: MobileLayoutProps) {\r\n  const form = useSellForm();\r\n  const { currentStep, setCurrentStep } = useSellFormContext();\r\n\r\n  const images = form.watch(\"images\");\r\n  const title = form.watch(\"title\");\r\n  const categoryId = form.watch(\"categoryId\");\r\n  const condition = form.watch(\"condition\");\r\n  const price = form.watch(\"price\");\r\n\r\n  const canContinue = useMemo(() => {\r\n    if (currentStep === 1) {\r\n      const hasPhotos = Boolean(images && images.length > 0);\r\n      const hasTitle = Boolean(title && title.trim().length >= 5);\r\n      return hasPhotos && hasTitle;\r\n    }\r\n\r\n    if (currentStep === 2) {\r\n      return Boolean(categoryId);\r\n    }\r\n\r\n    if (currentStep === 3) {\r\n      return Boolean(condition);\r\n    }\r\n\r\n    if (currentStep === 4) {\r\n      const hasPrice = Boolean(price && Number.parseFloat(price) > 0);\r\n      return hasPrice;\r\n    }\r\n\r\n    return true;\r\n  }, [categoryId, condition, currentStep, images, price, title]);\r\n\r\n  const isPublishDisabled = useMemo(() => {\r\n    const hasPhotos = Boolean(images && images.length > 0);\r\n    const hasTitle = Boolean(title && title.trim().length >= 5);\r\n    const hasCategory = Boolean(categoryId);\r\n    const hasCondition = Boolean(condition);\r\n    const hasPrice = Boolean(price && Number.parseFloat(price) > 0);\r\n    return !(hasPhotos && hasTitle && hasCategory && hasCondition && hasPrice);\r\n  }, [categoryId, condition, images, price, title]);\r\n\r\n  // Handle submission\r\n  const handleSubmit = () => {\r\n    form.handleSubmit(\r\n      (data) => onSubmit(data),\r\n      () => { /* Validation errors handled by fields */ }\r\n    )();\r\n  };\r\n\r\n  const handleNext = async () => {\r\n    const stepFields = MOBILE_STEPS[currentStep - 1]?.fields ?? [];\r\n    const ok = stepFields.length > 0 ? await form.trigger(stepFields as never) : true;\r\n    if (!ok) return;\r\n    if (currentStep < MOBILE_STEPS.length) setCurrentStep(currentStep + 1);\r\n  };\r\n\r\n  // Render current step content\r\n  const renderStepContent = () => {\r\n    switch (currentStep) {\r\n      case 1:\r\n        return <StepWhat />;\r\n      case 2:\r\n        return <StepCategory />;\r\n      case 3:\r\n        return <StepDetails />;\r\n      case 4:\r\n        return <StepPricing />;\r\n      case 5:\r\n        return <StepReview />;\r\n      default:\r\n        return null;\r\n    }\r\n  };\r\n\r\n  return (\r\n    <StepperWrapper \r\n      steps={MOBILE_STEPS} \r\n      onSubmit={handleSubmit} \r\n      onNext={handleNext}\r\n      isSubmitting={isSubmitting}\r\n      isNextDisabled={!canContinue}\r\n      isSubmitDisabled={isPublishDisabled}\r\n    >\r\n      {renderStepContent()}\r\n    </StepperWrapper>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\layouts\\stepper-wrapper.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\sell-form-provider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\sell-form-unified.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 28 to the 25 allowed.","line":111,"column":10,"nodeType":null,"messageId":"refactorFunction","endLine":111,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'pendingSubmitData' is assigned a value but never used.","line":131,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":131,"endColumn":27},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'tSell'. Either include it or remove the dependency array.","line":201,"column":6,"nodeType":"ArrayExpression","endLine":201,"endColumn":69,"suggestions":[{"desc":"Update the dependencies array to be: [payoutStatus, createListingAction, sellerId, clearDraft, isBg, tSell]","fix":{"range":[6450,6513],"text":"[payoutStatus, createListingAction, sellerId, clearDraft, isBg, tSell]"}}]},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":295,"column":19,"nodeType":"JSXOpeningElement","endLine":299,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useCallback, useTransition } from \"react\";\r\nimport { toast } from \"sonner\";\r\nimport {\r\n  CheckCircle,\r\n  House,\r\n  Plus,\r\n  Share,\r\n  Eye,\r\n  SpinnerGap,\r\n  CloudArrowUp,\r\n  Lightning,\r\n} from \"@phosphor-icons/react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { createClient } from \"@/lib/supabase/client\";\r\nimport { Link } from \"@/i18n/routing\";\r\nimport { BoostDialog } from \"@/components/shared/seller/boost-dialog\";\r\nimport { useTranslations } from \"next-intl\";\r\n\r\nimport { SellFormProvider, useSellForm, useSellFormContext, defaultSellFormValuesV4 } from \"./sell-form-provider\";\r\nimport { DesktopLayout, MobileLayout } from \"./layouts\";\r\nimport { PayoutRequiredModal } from \"./ui/payout-required-modal\";\r\nimport type { Category } from \"../_lib/types\";\r\nimport type { SellFormDataV4 } from \"@/lib/sell/schema-v4\";\r\n\r\ntype SellerPayoutStatus = {\r\n  stripe_connect_account_id: string | null;\r\n  details_submitted: boolean;\r\n  charges_enabled: boolean;\r\n  payouts_enabled: boolean;\r\n} | null;\r\n\r\nfunction isPayoutReady(payoutStatus: SellerPayoutStatus | undefined): boolean {\r\n  return Boolean(\r\n    payoutStatus?.details_submitted && payoutStatus?.charges_enabled && payoutStatus?.payouts_enabled\r\n  );\r\n}\r\n\r\ntype CreateListingResult =\r\n  | {\r\n      success: true;\r\n      id: string;\r\n      sellerUsername: string;\r\n      product: {\r\n        id: string;\r\n        slug: string | null;\r\n      };\r\n    }\r\n  | {\r\n      success: false;\r\n      error: string;\r\n      message?: string;\r\n      issues?: Array<{ path: string[]; message: string }>;\r\n      upgradeRequired?: boolean;\r\n    };\r\n\r\ntype CreateListingAction = (args: { sellerId: string; data: unknown }) => Promise<CreateListingResult>;\r\n\r\n// ============================================================================\r\n// UNIFIED SELL FORM - Phase 4: Responsive Unification\r\n// Single component that handles both desktop and mobile layouts\r\n// ============================================================================\r\n\r\ninterface UnifiedSellFormProps {\r\n  locale?: string;\r\n  existingProduct?: SellFormDataV4 & { id: string };\r\n  sellerId: string;\r\n  categories?: Category[];\r\n  createListingAction: CreateListingAction;\r\n  payoutStatus?: SellerPayoutStatus;\r\n}\r\n\r\n/**\r\n * UnifiedSellForm - Main sell form component\r\n * \r\n * Uses SellFormProvider for state management and renders either:\r\n * - DesktopLayout (lg+): Single page with all sections visible\r\n * - MobileLayout (<lg): Multi-step wizard\r\n * \r\n * Both layouts use the same unified field components from fields/\r\n */\r\nexport function UnifiedSellForm({\r\n  locale = \"en\",\r\n  existingProduct,\r\n  sellerId,\r\n  categories = [],\r\n  createListingAction,\r\n  payoutStatus,\r\n}: UnifiedSellFormProps) {\r\n  return (\r\n    <SellFormProvider\r\n      locale={locale}\r\n      categories={categories}\r\n      sellerId={sellerId}\r\n      {...(existingProduct ? { existingProduct } : {})}\r\n      totalSteps={4}\r\n    >\r\n      <SellFormContent \r\n        sellerId={sellerId} \r\n        createListingAction={createListingAction} \r\n        payoutStatus={payoutStatus}\r\n      />\r\n    </SellFormProvider>\r\n  );\r\n}\r\n\r\n/**\r\n * SellFormContent - Inner component that has access to form context\r\n */\r\nfunction SellFormContent({\n  sellerId,\n  createListingAction,\n  payoutStatus,\n}: {\n  sellerId: string;\n  createListingAction: CreateListingAction;\n  payoutStatus: SellerPayoutStatus | undefined;\n}) {\n  const form = useSellForm();\n  const { isBg, clearDraft, setCurrentStep, locale } = useSellFormContext();\n  const tSell = useTranslations(\"Sell\");\n  const tBoost = useTranslations(\"Boost\");\n  \r\n  const [isPending, startTransition] = useTransition();\r\n  const [submitError, setSubmitError] = useState<string | null>(null);\r\n  const [showSuccess, setShowSuccess] = useState(false);\r\n  const [createdProductId, setCreatedProductId] = useState<string | null>(null);\r\n  const [createdProductHref, setCreatedProductHref] = useState<string | null>(null);\r\n  const [showPayoutModal, setShowPayoutModal] = useState(false);\r\n  const [pendingSubmitData, setPendingSubmitData] = useState<SellFormDataV4 | null>(null);\r\n\r\n  // Handle form submission - check payout status first\r\n  const handleSubmit = useCallback(async (data: SellFormDataV4) => {\r\n    setSubmitError(null);\r\n    \r\n    // Gate at publish: check payout status before submitting\r\n    if (!isPayoutReady(payoutStatus)) {\r\n      setPendingSubmitData(data);\r\n      setShowPayoutModal(true);\r\n      return;\r\n    }\r\n    \r\n    startTransition(async () => {\r\n      try {\r\n        const supabase = createClient();\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        \r\n        if (!user) {\r\n          setSubmitError(isBg ? \"╨£╨╛╨╗╤Å, ╨▓╨╗╨╡╨╖╤é╨╡ ╨▓ ╨┐╤Ç╨╛╤ä╨╕╨╗╨░ ╤ü╨╕\" : \"Please sign in to continue\");\r\n          return;\r\n        }\r\n\r\n        const result: CreateListingResult = await createListingAction({ sellerId, data });\n\n        if (!result.success) {\n          const issueMessages = result.issues\n            ?.map((i) => {\n              const key = i.message\n              if (!key) return null\n              try {\n                return tSell(key as never)\n              } catch {\n                return key\n              }\n            })\n            .filter(Boolean)\n            .join(\", \")\n            .trim()\n\n          const baseError = result.message || result.error || \"Failed to create listing\";\n          throw new Error(baseError + (issueMessages ? ` (${issueMessages})` : \"\"));\n        }\n\r\n        // Clear draft after successful submission\r\n        clearDraft();\r\n\r\n        toast.success(\r\n          isBg ? \"╨₧╨▒╤Å╨▓╨░╤é╨░ ╨╡ ╨┐╤â╨▒╨╗╨╕╨║╤â╨▓╨░╨╜╨░!\" : \"Listing published!\",\r\n          { description: isBg ? \"╨Æ╨░╤ê╨╕╤Å╤é ╨┐╤Ç╨╛╨┤╤â╨║╤é ╨╡ ╨╜╨░ ╨╢╨╕╨▓╨╛\" : \"Your product is now live\" }\r\n        );\r\n\r\n        const productId = result.product.id;\r\n        setCreatedProductId(productId);\r\n        setCreatedProductHref(\r\n          result.sellerUsername\r\n            ? `/${result.sellerUsername}/${result.product.slug || productId}`\r\n            : null,\r\n        );\r\n          setShowSuccess(true);\r\n          window.scrollTo({ top: 0, behavior: \"instant\" });\r\n      } catch (error) {\r\n        console.error(\"Submit error:\", error);\r\n        const errorMessage = error instanceof Error \r\n          ? error.message \r\n          : isBg ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╨┐╤â╨▒╨╗╨╕╨║╤â╨▓╨░╨╜╨╡\" : \"Error publishing listing\";\r\n        setSubmitError(errorMessage);\r\n        toast.error(errorMessage);\r\n      }\r\n    });\r\n  }, [isBg, sellerId, clearDraft, payoutStatus, createListingAction]);\r\n\r\n  // Handle reset for new listing\r\n  const handleNewListing = useCallback(() => {\r\n    // Clear localStorage draft to prevent state persistence\r\n    clearDraft();\r\n    // Reset form to default values\r\n    form.reset(defaultSellFormValuesV4);\r\n    // Reset to step 1\r\n    setCurrentStep(1);\r\n    // Clear UI state\r\n    setSubmitError(null);\r\n    setCreatedProductId(null);\r\n    setCreatedProductHref(null);\r\n    setShowSuccess(false);\r\n    window.scrollTo({ top: 0, behavior: \"instant\" });\r\n  }, [form, clearDraft, setCurrentStep]);\r\n\r\n  // Processing screen\r\n  if (isPending) {\r\n    return (\r\n      <div className=\"flex flex-1 flex-col items-center justify-center px-4\">\r\n        <div className=\"w-full max-w-sm text-center space-y-8\">\r\n          <div className=\"relative mx-auto w-24 h-24\">\r\n            {/* Outer spinning ring */}\r\n            <div className=\"absolute inset-0 rounded-full border-4 border-border border-t-primary animate-spin\" />\r\n            {/* Inner icon */}\r\n            <div className=\"absolute inset-0 flex items-center justify-center\">\r\n              <CloudArrowUp className=\"size-10 text-primary animate-bounce\" weight=\"bold\" />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"space-y-3\">\r\n            <h2 className=\"text-2xl font-bold tracking-tight text-foreground\">\r\n              {isBg ? \"╨ƒ╤â╨▒╨╗╨╕╨║╤â╨▓╨░╨╜╨╡...\" : \"Publishing...\"}\r\n            </h2>\r\n            <p className=\"text-muted-foreground font-medium\">\r\n              {isBg \r\n                ? \"╨ƒ╨╛╨┤╨│╨╛╤é╨▓╤Å╨╝╨╡ ╨▓╨░╤ê╨░╤é╨░ ╨╛╨▒╤Å╨▓╨░ ╨╖╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨╕╤é╨╡.\"\r\n                : \"Preparing your listing for buyers.\"}\r\n            </p>\r\n          </div>\r\n\r\n          <div className=\"flex items-center justify-center gap-2 text-xs font-bold text-primary uppercase tracking-widest\">\r\n            <SpinnerGap className=\"size-4 animate-spin\" weight=\"bold\" />\r\n            <span>{isBg ? \"╨£╨╛╨╗╤Å, ╨╕╨╖╤ç╨░╨║╨░╨╣╤é╨╡\" : \"Please wait\"}</span>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Success screen\r\n  if (showSuccess) {\r\n    const productTitle = form.getValues().title || (isBg ? \"╨Æ╨░╤ê╨╕╤Å╤é ╨┐╤Ç╨╛╨┤╤â╨║╤é\" : \"Your product\");\r\n    const firstImageObj = form.getValues().images?.[0];\r\n    const firstImageUrl = typeof firstImageObj === \"string\" ? firstImageObj : firstImageObj?.url;\r\n    const productId = createdProductId;\r\n\r\n    return (\r\n      <div className=\"flex flex-1 flex-col\">\r\n        {/* Header */}\r\n        <header className=\"sticky top-0 z-40 bg-background border-b border-border\">\r\n          <div className=\"flex items-center justify-center h-14\">\r\n            <span className=\"text-sm font-medium text-muted-foreground\">\r\n              {isBg ? \"╨₧╨▒╤Å╨▓╨░╤é╨░ ╨╡ ╨┐╤â╨▒╨╗╨╕╨║╤â╨▓╨░╨╜╨░\" : \"Listing Published\"}\r\n            </span>\r\n          </div>\r\n        </header>\r\n\r\n        {/* Success content */}\r\n        <main className=\"flex-1 flex flex-col items-center justify-center px-4 py-12\">\r\n          <div className=\"w-full max-w-sm text-center space-y-8\">\r\n            {/* Success icon - clean, no animation */}\r\n            <div className=\"mx-auto w-20 h-20 bg-success rounded-full flex items-center justify-center\">\r\n              <CheckCircle className=\"size-10 text-success-foreground\" weight=\"fill\" />\r\n            </div>\r\n\r\n            {/* Success message */}\r\n            <div className=\"space-y-3\">\r\n              <h1 className=\"text-3xl font-bold tracking-tight text-foreground\">\r\n                {isBg ? \"╨ƒ╤â╨▒╨╗╨╕╨║╤â╨▓╨░╨╜╨╛!\" : \"Published!\"}\r\n              </h1>\r\n              <p className=\"text-lg text-muted-foreground leading-relaxed\">\r\n                {isBg \r\n                  ? \"╨Æ╨░╤ê╨░╤é╨░ ╨╛╨▒╤Å╨▓╨░ ╨╡ ╨╜╨░ ╨╢╨╕╨▓╨╛ ╨╕ ╨│╨╛╤é╨╛╨▓╨░ ╨╖╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨╕.\"\r\n                  : \"Your listing is live and ready for buyers.\"}\r\n              </p>\r\n            </div>\r\n\r\n            {/* Product preview card - cleaner */}\r\n            {firstImageUrl && (\r\n              <div className=\"bg-surface-subtle rounded-md p-4 border border-border/50\">\r\n                <div className=\"flex items-center gap-4\">\r\n                  <img \r\n                    src={firstImageUrl} \r\n                    alt={productTitle}\r\n                    className=\"w-20 h-20 rounded-md object-cover\"\r\n                  />\r\n                  <div className=\"flex-1 text-left min-w-0\">\r\n                    <p className=\"font-bold text-base truncate\">{productTitle}</p>\r\n                    <p className=\"text-sm text-muted-foreground\">\r\n                      {isBg ? \"╨₧╨▒╤Å╨▓╨░╤é╨░ ╨╡ ╨░╨║╤é╨╕╨▓╨╜╨░\" : \"Listing is active\"}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Action buttons - cleaner, more professional */}\r\n            <div className=\"space-y-4 pt-4\">\r\n              <Button asChild className=\"w-full h-12 gap-2 bg-primary hover:bg-interactive-hover text-base font-semibold rounded-md\">\r\n                <Link href={createdProductHref || \"/\"}>\r\n                  <Eye className=\"size-5\" />\r\n                  {isBg ? \"╨Æ╨╕╨╢ ╨╛╨▒╤Å╨▓╨░╤é╨░\" : \"View Listing\"}\r\n                </Link>\r\n              </Button>\r\n\r\n              {/* Boost CTA */}\r\n              {productId && (\r\n                <div className=\"space-y-2\">\r\n                  <BoostDialog\r\n                    product={{ id: productId, title: productTitle, is_boosted: false, boost_expires_at: null }}\r\n                    locale={locale}\r\n                    trigger={\r\n                      <Button variant=\"outline\" className=\"w-full h-12 gap-2 rounded-md font-semibold\">\r\n                        <Lightning className=\"size-5 text-primary\" weight=\"fill\" />\r\n                        {tBoost(\"title\")}\r\n                      </Button>\r\n                    }\r\n                  />\r\n                  <p className=\"text-xs text-muted-foreground\">{tBoost(\"description\")}</p>\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"grid grid-cols-2 gap-4\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  className=\"h-12 gap-2 rounded-md font-medium\"\r\n                  onClick={() => {\r\n                    const shareLocale = isBg ? \"bg\" : \"en\";\r\n                    if (navigator.share) {\r\n                      navigator.share({\r\n                        title: productTitle,\r\n                        url: createdProductHref\r\n                          ? `${window.location.origin}/${shareLocale}${createdProductHref}`\r\n                          : `${window.location.origin}/${shareLocale}/sell`,\r\n                      });\r\n                    } else {\r\n                      navigator.clipboard.writeText(\r\n                        createdProductHref\r\n                          ? `${window.location.origin}/${shareLocale}${createdProductHref}`\r\n                          : `${window.location.origin}/${shareLocale}/sell`\r\n                      );\r\n                      toast.success(isBg ? \"╨¢╨╕╨╜╨║╤è╤é ╨╡ ╨║╨╛╨┐╨╕╤Ç╨░╨╜\" : \"Link copied\");\r\n                    }\r\n                  }}\r\n                >\r\n                  <Share className=\"size-5\" />\r\n                  {isBg ? \"╨í╨┐╨╛╨┤╨╡╨╗╨╕\" : \"Share\"}\r\n                </Button>\r\n\r\n                <Button\r\n                  variant=\"outline\"\r\n                  className=\"h-12 gap-2 rounded-md font-medium\"\r\n                  onClick={handleNewListing}\r\n                >\r\n                  <Plus className=\"size-5\" />\r\n                  {isBg ? \"╨¥╨╛╨▓╨░\" : \"New\"}\r\n                </Button>\r\n              </div>\r\n\r\n              <Button\r\n                variant=\"ghost\"\r\n                asChild\r\n                className=\"w-full h-12 gap-2 text-muted-foreground hover:text-foreground rounded-md\"\r\n              >\r\n                <Link href=\"/\">\r\n                  <House className=\"size-5\" />\r\n                  {isBg ? \"╨Ü╤è╨╝ ╨╜╨░╤ç╨░╨╗╨╛╤é╨╛\" : \"Go Home\"}\r\n                </Link>\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </main>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Responsive layout: Desktop (lg+) shows all sections, Mobile (<lg) uses stepper\r\n  return (\r\n    <>\r\n      {/* Desktop Layout */}\r\n      <div className=\"hidden lg:block\">\r\n        <DesktopLayout\r\n          onSubmit={handleSubmit}\r\n          submitError={submitError}\r\n          setSubmitError={setSubmitError}\r\n          isSubmitting={isPending}\r\n        />\r\n      </div>\r\n\r\n      {/* Mobile Layout */}\r\n      <div className=\"lg:hidden\">\r\n        <MobileLayout \r\n          onSubmit={handleSubmit} \r\n          isSubmitting={isPending}\r\n        />\r\n      </div>\r\n\r\n      {/* Payout Required Modal - shown when user tries to publish without Stripe setup */}\r\n      <PayoutRequiredModal\r\n        open={showPayoutModal}\r\n        onOpenChange={setShowPayoutModal}\r\n      />\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\sign-in-prompt.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\steps\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\steps\\step-category.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'rawCategoryPath' logical expression could make the dependencies of useMemo Hook (at line 29) change on every render. Move it inside the useMemo callback. Alternatively, wrap the initialization of 'rawCategoryPath' in its own useMemo() Hook.","line":19,"column":9,"nodeType":"VariableDeclarator","endLine":19,"endColumn":54}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useCallback, useMemo } from \"react\";\r\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\r\nimport { CategorySelector } from \"../ui/category-modal\";\r\nimport type { CategoryPathItem } from \"../../_lib/types\";\r\n\r\n// ============================================================================\r\n// STEP 2: CATEGORY - Full-screen category picker\r\n// Category determines ALL subsequent fields.\r\n// User picks: Electronics ΓåÆ Mobile ΓåÆ iPhone ΓåÆ attributes load.\r\n// ============================================================================\r\n\r\nexport function StepCategory() {\r\n  const { watch, setValue } = useSellForm();\r\n  const { isBg, categories, setCurrentStep } = useSellFormContext();\r\n  \r\n  const categoryId = watch(\"categoryId\") || \"\";\r\n  const rawCategoryPath = watch(\"categoryPath\") || [];\r\n  \r\n  // Normalize categoryPath to match CategoryPathItem type (name_bg: string | null, not undefined)\r\n  const categoryPath: CategoryPathItem[] = useMemo(() => \r\n    rawCategoryPath.map(item => ({\r\n      id: item.id,\r\n      name: item.name,\r\n      name_bg: item.name_bg ?? null,\r\n      slug: item.slug,\r\n    })), \r\n    [rawCategoryPath]\r\n  );\r\n\r\n  const handleCategoryChange = useCallback((newCategoryId: string, path: CategoryPathItem[]) => {\r\n    setValue(\"categoryId\", newCategoryId, { shouldValidate: true });\r\n    setValue(\"categoryPath\", path, { shouldValidate: false });\r\n    \r\n    // Auto-advance to next step when a leaf category is selected\r\n    if (newCategoryId && path.length > 0) {\r\n      // Small delay to show the selection before advancing\r\n      setTimeout(() => {\r\n        setCurrentStep(3);\r\n      }, 300);\r\n    }\r\n  }, [setValue, setCurrentStep]);\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Section header */}\r\n      <div className=\"space-y-1\">\r\n          <h2 className=\"text-2xl font-bold tracking-tight text-foreground\">\r\n            {isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å\" : \"Choose a category\"}\r\n          </h2>\r\n          <p className=\"text-sm text-muted-foreground\">\r\n            {isBg \r\n              ? \"╨Ü╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å╤é╨░ ╨╛╨┐╤Ç╨╡╨┤╨╡╨╗╤Å ╨║╨░╨║╨▓╨╕ ╨┤╨╡╤é╨░╨╣╨╗╨╕ ╤ë╨╡ ╨┐╨╛╨┐╤è╨╗╨╜╨╕╤é╨╡\" \r\n              : \"The category determines what details you'll fill in\"}\r\n          </p>\r\n        </div>\r\n\r\n      <div className=\"space-y-4\">\r\n        <CategorySelector\r\n          categories={categories}\r\n          value={categoryId}\r\n          selectedPath={categoryPath}\r\n          onChange={handleCategoryChange}\r\n          locale={isBg ? \"bg\" : \"en\"}\r\n        />\r\n        \r\n        {/* Show current path if selected */}\r\n        {categoryPath.length > 0 && (\r\n          <div className=\"p-4 rounded-xl bg-selected border border-selected-border\">\r\n            <p className=\"text-xs font-bold uppercase tracking-wider text-primary mb-1\">\r\n              {isBg ? \"╨ÿ╨╖╨▒╤Ç╨░╨╜╨░ ╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å\" : \"Selected category\"}\r\n            </p>\r\n            <p className=\"text-sm font-semibold text-foreground\">\r\n              {categoryPath.map(c => isBg && c.name_bg ? c.name_bg : c.name).join(\" ΓÇ║ \")}\r\n            </p>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\steps\\step-details.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Sparkle' is defined but never used.","line":5,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":17,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Sparkle"},"fix":{"range":[141,149],"text":""},"desc":"Remove unused variable \"Sparkle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Plus' is defined but never used.","line":5,"column":46,"nodeType":"Identifier","messageId":"unusedVar","endLine":5,"endColumn":50,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Plus"},"fix":{"range":[175,181],"text":""},"desc":"Remove unused variable \"Plus\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'categoryPath' is assigned a value but never used.","line":102,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":102,"endColumn":21},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'images' logical expression could make the dependencies of useCallback Hook (at line 205) change on every render. To fix this, wrap the initialization of 'images' in its own useMemo() Hook.","line":106,"column":9,"nodeType":"VariableDeclarator","endLine":106,"endColumn":39},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'images' logical expression could make the dependencies of useCallback Hook (at line 216) change on every render. To fix this, wrap the initialization of 'images' in its own useMemo() Hook.","line":106,"column":9,"nodeType":"VariableDeclarator","endLine":106,"endColumn":39},{"ruleId":"unicorn/no-useless-undefined","severity":1,"message":"Do not use useless `undefined`.","line":173,"column":22,"nodeType":"Identifier","messageId":"no-useless-undefined","endLine":173,"endColumn":31,"fix":{"range":[6259,6269],"text":""}},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":356,"column":15,"nodeType":"JSXOpeningElement","endLine":356,"endColumn":82}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\";\r\n\r\nimport { useState, useMemo, useCallback, useEffect } from \"react\";\r\nimport { Controller } from \"react-hook-form\";\r\nimport { Sparkle, CaretRight, Check, Camera, Plus, X } from \"@phosphor-icons/react\";\r\nimport { cn } from \"@/lib/utils\";\nimport { conditionOptions } from \"@/lib/sell/schema-v4\";\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\nimport { useTranslations } from \"next-intl\";\nimport {\r\n  Drawer,\r\n  DrawerContent,\r\n  DrawerHeader,\r\n  DrawerTitle,\r\n} from \"@/components/ui/drawer\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport type { ProductAttribute } from \"@/lib/sell/schema-v4\";\r\n\r\n// ============================================================================\r\n// STEP 3: DETAILS - Clean iOS-style form\r\n// Condition + Attributes + Description + Photos\r\n// ============================================================================\r\n\r\ninterface CategoryAttribute {\r\n  id: string;\r\n  name: string;\r\n  name_bg?: string | null;\r\n  attribute_type: \"text\" | \"number\" | \"select\" | \"multiselect\" | \"boolean\" | \"date\";\r\n  is_required: boolean;\r\n  options?: string[];\r\n  options_bg?: string[];\r\n  placeholder?: string;\r\n  placeholder_bg?: string;\r\n  sort_order: number;\r\n}\r\n\r\n// Helper: Check if attribute value is filled\r\nfunction isAttributeFilled(value: string | undefined | null): boolean {\r\n  return value !== undefined && value !== null && value.trim() !== \"\";\r\n}\r\n\r\n// Simple selection row - iOS style\r\nfunction SelectionRow({\r\n  label,\r\n  value,\r\n  placeholder,\r\n  onClick,\r\n  hasError,\r\n  required,\r\n}: {\r\n  label: string;\r\n  value: string | undefined;\r\n  placeholder: string;\r\n  onClick: () => void;\r\n  hasError?: boolean | undefined;\r\n  required?: boolean | undefined;\r\n}) {\r\n  return (\r\n    <button\r\n      type=\"button\"\r\n      onClick={onClick}\r\n      className={cn(\r\n        \"w-full flex items-center justify-between h-14 px-4 rounded-xl border transition-all\",\r\n        \"active:opacity-90\",\r\n        hasError\r\n          ? \"border-destructive/40 bg-surface-subtle\"\r\n          : value\r\n            ? \"bg-selected border-selected-border\"\r\n            : \"border-border bg-card hover:bg-hover\"\r\n      )}\r\n    >\r\n      <div className=\"flex-1 text-left min-w-0\">\r\n        <span className=\"text-tiny font-semibold uppercase tracking-wide text-muted-foreground block\">\r\n          {label}{required && <span className=\"text-destructive ml-0.5\">*</span>}\r\n        </span>\r\n        <span className={cn(\r\n          \"text-reading font-medium truncate block -mt-0.5\",\r\n          value ? \"text-foreground\" : \"text-muted-foreground\"\r\n        )}>\r\n          {value || placeholder}\r\n        </span>\r\n      </div>\r\n      <CaretRight className=\"size-4 text-muted-foreground shrink-0\" weight=\"bold\" />\r\n    </button>\r\n  );\r\n}\r\n\r\nexport function StepDetails() {\n  const { control, watch, setValue } = useSellForm();\n  const { isBg } = useSellFormContext();\n  const tSell = useTranslations(\"Sell\")\n\r\n  // Drawer states\r\n  const [conditionOpen, setConditionOpen] = useState(false);\r\n  const [attrDrawerOpen, setAttrDrawerOpen] = useState<string | null>(null);\r\n\r\n  // Watch values\r\n  const condition = watch(\"condition\");\r\n  const categoryId = watch(\"categoryId\");\r\n  const categoryPath = watch(\"categoryPath\");\r\n  const description = watch(\"description\") || \"\";\r\n  const watchedAttributes = watch(\"attributes\");\r\n  const attributes = useMemo(() => watchedAttributes || [], [watchedAttributes]);\r\n  const images = watch(\"images\") || [];\r\n\r\n  // Get condition label\r\n  const selectedCondition = conditionOptions.find(c => c.value === condition);\n  const conditionLabel = selectedCondition\n    ? tSell(selectedCondition.labelKey as never)\n    : undefined;\n\r\n  // DB attributes state\r\n  const [dbAttributes, setDbAttributes] = useState<CategoryAttribute[]>([]);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n\r\n  // Fetch attributes when category changes\r\n  useEffect(() => {\r\n    if (!categoryId) {\r\n      setDbAttributes([]);\r\n      return;\r\n    }\r\n    const fetchAttributes = async () => {\r\n      setIsLoading(true);\r\n      try {\r\n        const response = await fetch(`/api/categories/${categoryId}/attributes`);\r\n        if (response.ok) {\r\n          const data = await response.json();\r\n          const attrs = data.attributes || data;\r\n          if (Array.isArray(attrs)) {\r\n            const normalized = attrs.map((attr: Record<string, unknown>) => ({\r\n              id: String(attr.id),\r\n              name: String(attr.name ?? \"\"),\r\n              name_bg: attr.name_bg ?? attr.nameBg ?? null,\r\n              attribute_type: (attr.attribute_type ?? attr.type ?? \"text\") as CategoryAttribute[\"attribute_type\"],\r\n              is_required: Boolean(attr.is_required ?? attr.required),\r\n              options: (attr.options ?? undefined) as string[] | undefined,\r\n              options_bg: (attr.options_bg ?? attr.optionsBg ?? undefined) as string[] | undefined,\r\n              placeholder: (attr.placeholder ?? undefined) as string | undefined,\r\n              placeholder_bg: (attr.placeholder_bg ?? attr.placeholderBg ?? undefined) as string | undefined,\r\n              sort_order: Number(attr.sort_order ?? attr.sortOrder ?? 0),\r\n            })) as CategoryAttribute[];\r\n            // Filter out condition attribute\r\n            setDbAttributes(normalized.filter(a =>\r\n              ![\"condition\", \"╤ü╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡\"].includes(a.name.toLowerCase())\r\n            ).sort((a, b) => a.sort_order - b.sort_order));\r\n          }\r\n        }\r\n      } catch {\r\n        // silent\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n    fetchAttributes();\r\n  }, [categoryId]);\r\n\r\n  // Required attributes (max 6)\r\n  const requiredAttrs = useMemo(() =>\r\n    dbAttributes.filter(a => a.is_required).slice(0, 6),\r\n    [dbAttributes]\r\n  );\r\n\r\n  // Get attribute value\r\n  const getAttrValue = useCallback((attrId: string) => {\r\n    return attributes.find(a => a.attributeId === attrId)?.value || \"\";\r\n  }, [attributes]);\r\n\r\n  // Get attribute display value\r\n  const getAttrDisplayValue = useCallback((attr: CategoryAttribute) => {\r\n    const val = getAttrValue(attr.id);\r\n    if (!val) return undefined;\r\n    if (attr.attribute_type === \"select\" && attr.options) {\r\n      const idx = attr.options.indexOf(val);\r\n      if (isBg && attr.options_bg?.[idx]) return attr.options_bg[idx];\r\n    }\r\n    return val;\r\n  }, [getAttrValue, isBg]);\r\n\r\n  // Handle attribute change\r\n  const handleAttrChange = useCallback((attr: CategoryAttribute, value: string) => {\r\n    const existing = attributes.find(a => a.attributeId === attr.id);\r\n    let newAttrs: ProductAttribute[];\r\n    if (existing) {\r\n      newAttrs = value\r\n        ? attributes.map(a => a.attributeId === attr.id ? { ...a, value } : a)\r\n        : attributes.filter(a => a.attributeId !== attr.id);\r\n    } else if (value) {\r\n      newAttrs = [...attributes, { attributeId: attr.id, name: attr.name, value, isCustom: false }];\r\n    } else {\r\n      newAttrs = attributes;\r\n    }\r\n    setValue(\"attributes\", newAttrs, { shouldValidate: true });\r\n  }, [attributes, setValue]);\r\n\r\n  // Photo handlers (simplified)\r\n  const addDemoPhoto = useCallback(() => {\r\n    if (images.length >= 12) return;\r\n    const id = Math.floor(Math.random() * 1000);\r\n    setValue(\"images\", [...images, {\r\n      url: `https://picsum.photos/seed/${id}/600/600`,\r\n      isPrimary: images.length === 0,\r\n    }], { shouldValidate: true });\r\n  }, [images, setValue]);\r\n\r\n  const removePhoto = useCallback((index: number) => {\r\n    const newImages = images.filter((_, i) => i !== index);\r\n    if (newImages.length > 0 && !newImages.some(img => img.isPrimary)) {\r\n      const first = newImages[0];\r\n      if (first) {\r\n        newImages[0] = { url: first.url, isPrimary: true, thumbnailUrl: first.thumbnailUrl };\r\n      }\r\n    }\r\n    setValue(\"images\", newImages, { shouldValidate: true });\r\n  }, [images, setValue]);\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"space-y-1\">\r\n        <h2 className=\"text-2xl font-bold tracking-tight text-foreground\">\r\n          {isBg ? \"╨ö╨╡╤é╨░╨╣╨╗╨╕ ╨╖╨░ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨░\" : \"Product details\"}\r\n        </h2>\r\n        <p className=\"text-reading text-muted-foreground\">\r\n          {isBg\r\n            ? \"╨ö╨╛╨▒╨░╨▓╨╡╤é╨╡ ╨╕╨╜╤ä╨╛╤Ç╨╝╨░╤å╨╕╤Å, ╨║╨╛╤Å╤é╨╛ ╨┐╨╛╨╝╨░╨│╨░ ╨╜╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨╕╤é╨╡\"\r\n            : \"Add information that helps buyers find your item\"}\r\n        </p>\r\n      </div>\r\n\r\n      {/* Condition - SelectionRow */}\r\n      <Controller\r\n        name=\"condition\"\r\n        control={control}\r\n        render={({ fieldState }) => (\r\n          <SelectionRow\r\n            label={isBg ? \"╨í╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡\" : \"Condition\"}\r\n            value={conditionLabel}\r\n            placeholder={isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╤ü╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡\" : \"Select condition\"}\r\n            onClick={() => setConditionOpen(true)}\r\n            hasError={fieldState.invalid}\r\n            required\r\n          />\r\n        )}\r\n      />\r\n\r\n      {/* Required Attributes - iOS grouped list style */}\r\n      {!isLoading && requiredAttrs.length > 0 && (\r\n        <div className=\"space-y-2\">\r\n          <span className=\"text-tiny font-semibold uppercase tracking-wide text-muted-foreground px-1\">\r\n            {isBg ? \"╨₧╤ü╨╜╨╛╨▓╨╜╨╕ ╤à╨░╤Ç╨░╨║╤é╨╡╤Ç╨╕╤ü╤é╨╕╨║╨╕\" : \"Main specifics\"}\r\n            <span className=\"ml-1.5 text-muted-foreground\">\r\n              {requiredAttrs.filter(a => isAttributeFilled(getAttrValue(a.id))).length}/{requiredAttrs.length}\r\n            </span>\r\n          </span>\r\n          <div className=\"bg-card rounded-xl border border-border divide-y divide-border/60 overflow-hidden\">\r\n            {requiredAttrs.map((attr) => {\r\n              const name = isBg && attr.name_bg ? attr.name_bg : attr.name;\r\n              const displayValue = getAttrDisplayValue(attr);\r\n\r\n              if (attr.attribute_type === \"select\" && attr.options?.length) {\r\n                return (\r\n                  <button\r\n                    key={attr.id}\r\n                    type=\"button\"\r\n                    onClick={() => setAttrDrawerOpen(attr.id)}\r\n                    className=\"w-full flex items-center justify-between h-14 px-4 active:bg-active transition-colors\"\r\n                  >\r\n                    <span className=\"text-reading text-foreground\">{name}</span>\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <span className={cn(\r\n                        \"text-reading\",\r\n                        displayValue ? \"text-foreground font-medium\" : \"text-muted-foreground\"\r\n                      )}>\r\n                        {displayValue || (isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╕\" : \"Select\")}\r\n                      </span>\r\n                      <CaretRight className=\"size-4 text-muted-foreground\" weight=\"bold\" />\r\n                    </div>\r\n                  </button>\r\n                );\r\n              }\r\n\r\n              // Text/number input inline\r\n              return (\r\n                <div key={attr.id} className=\"flex items-center justify-between h-14 px-4\">\r\n                  <span className=\"text-reading text-foreground shrink-0\">{name}</span>\r\n                  <Input\r\n                    value={getAttrValue(attr.id)}\r\n                    onChange={(e) => handleAttrChange(attr, e.target.value)}\r\n                    placeholder={isBg ? \"╨Æ╤è╨▓╨╡╨┤╨╕...\" : \"Enter...\"}\r\n                    type={attr.attribute_type === \"number\" ? \"number\" : \"text\"}\r\n                    className=\"border-none bg-transparent h-full p-0 text-reading text-right font-medium focus-visible:ring-0 w-32 placeholder:text-muted-foreground\"\r\n                  />\r\n                </div>\r\n              );\r\n            })}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Description - iOS card style */}\r\n      <div className=\"space-y-2\">\r\n        <div className=\"flex items-center justify-between px-1\">\r\n          <span className=\"text-tiny font-semibold uppercase tracking-wide text-muted-foreground\">\r\n            {isBg ? \"╨₧╨┐╨╕╤ü╨░╨╜╨╕╨╡\" : \"Description\"}\r\n          </span>\r\n          <span className=\"text-tiny font-medium tabular-nums text-muted-foreground\">\r\n            {description.length}/2000\r\n          </span>\r\n        </div>\r\n        <Controller\r\n          name=\"description\"\r\n          control={control}\r\n          render={({ field }) => (\r\n            <div className=\"bg-card rounded-xl border border-border overflow-hidden focus-within:border-ring focus-within:ring-2 focus-within:ring-ring transition-colors\">\r\n              <Textarea\r\n                {...field}\r\n                placeholder={isBg\r\n                  ? \"╨₧╨┐╨╕╤ê╨╡╤é╨╡ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨░: ╨╝╨░╤Ç╨║╨░, ╤Ç╨░╨╖╨╝╨╡╤Ç, ╨╖╨░╤ë╨╛ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤é╨╡...\"\r\n                  : \"Describe your item: brand, size, why you're selling...\"}\r\n                rows={4}\r\n                maxLength={2000}\r\n                className=\"border-none bg-transparent resize-none text-reading px-4 py-3 focus-visible:ring-0 placeholder:text-muted-foreground\"\r\n              />\r\n            </div>\r\n          )}\r\n        />\r\n      </div>\r\n\r\n      {/* Additional Photos - Simple grid */}\r\n      <div className=\"space-y-2\">\r\n        <div className=\"flex items-center justify-between px-1\">\r\n          <span className=\"text-tiny font-semibold uppercase tracking-wide text-muted-foreground\">\r\n            {isBg ? \"╨í╨╜╨╕╨╝╨║╨╕\" : \"Photos\"}\r\n          </span>\r\n          <span className=\"text-tiny font-medium tabular-nums text-muted-foreground\">\r\n            {images.length}/12\r\n          </span>\r\n        </div>\r\n        <div className=\"grid grid-cols-4 gap-2\">\r\n          {images.length < 12 && (\r\n               <button\r\n                 type=\"button\"\r\n                 onClick={addDemoPhoto}\r\n                 className=\"aspect-square rounded-xl border-2 border-dashed border-border flex flex-col items-center justify-center gap-1 hover:border-hover-border hover:bg-hover transition-colors active:scale-95\"\r\n               >\r\n                 <Camera className=\"size-5 text-muted-foreground\" />\r\n                 <span className=\"text-2xs font-medium text-muted-foreground\">\r\n                   {isBg ? \"╨ö╨╛╨▒╨░╨▓╨╕\" : \"Add\"}\r\n                 </span>\r\n              </button>\r\n          )}\r\n          {images.map((img, i) => (\r\n            <div key={`${img.url}-${i}`} className=\"aspect-square rounded-xl bg-muted relative overflow-hidden group ring-1 ring-border/50\">\r\n              <img src={img.url} alt=\"\" className=\"w-full h-full object-cover\" />\r\n              {i === 0 && (\r\n                <div className=\"absolute bottom-1 left-1 px-1.5 py-0.5 rounded text-2xs font-bold bg-surface-overlay text-overlay-text\">\r\n                  {isBg ? \"╨Ü╨╛╤Ç╨╕╤å╨░\" : \"Cover\"}\r\n                </div>\r\n              )}\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => removePhoto(i)}\r\n                className=\"absolute top-1 right-1 size-6 flex items-center justify-center rounded-full bg-surface-overlay text-overlay-text opacity-0 group-hover:opacity-100 transition-opacity\"\r\n              >\r\n                <X className=\"size-3\" weight=\"bold\" />\r\n              </button>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      </div>\r\n\r\n      {/* Condition Drawer */}\r\n      <Drawer open={conditionOpen} onOpenChange={setConditionOpen}>\r\n        <DrawerContent className=\"max-h-dialog flex flex-col\">\r\n          <DrawerHeader className=\"border-b border-border pb-4\">\r\n            <DrawerTitle className=\"text-lg font-bold\">\r\n              {isBg ? \"╨í╤è╤ü╤é╨╛╤Å╨╜╨╕╨╡ ╨╜╨░ ╨┐╤Ç╨╛╨┤╤â╨║╤é╨░\" : \"Item condition\"}\r\n            </DrawerTitle>\r\n          </DrawerHeader>\r\n          <ScrollArea className=\"flex-1 min-h-0\">\r\n            <div className=\"p-4 space-y-1.5\">\r\n              {conditionOptions.map((opt) => {\n                const isSelected = condition === opt.value;\n                const label = tSell(opt.labelKey as never);\n                return (\n                  <button\n                    key={opt.value}\r\n                    type=\"button\"\r\n                    onClick={() => {\r\n                      setValue(\"condition\", opt.value, { shouldValidate: true });\r\n                      setConditionOpen(false);\r\n                    }}\r\n                    className={cn(\r\n                      \"w-full flex items-center justify-between h-14 px-4 rounded-xl transition-colors\",\r\n                      \"active:opacity-90\",\r\n                      isSelected\r\n                        ? \"bg-selected border border-selected-border\"\r\n                        : \"bg-surface-subtle hover:bg-hover\"\r\n                    )}\r\n                  >\r\n                    <span className={cn(\r\n                      \"text-reading\",\r\n                      isSelected ? \"font-bold text-foreground\" : \"font-medium text-foreground\"\r\n                    )}>\r\n                      {label}\r\n                    </span>\r\n                    {isSelected && (\r\n                      <div className=\"size-6 rounded-full bg-checked flex items-center justify-center\">\r\n                        <Check className=\"size-3.5 text-checked-foreground\" weight=\"bold\" />\r\n                      </div>\r\n                    )}\r\n                  </button>\r\n                );\r\n              })}\r\n            </div>\r\n          </ScrollArea>\r\n        </DrawerContent>\r\n      </Drawer>\r\n\r\n      {/* Attribute Select Drawers */}\r\n      {requiredAttrs.filter(a => a.attribute_type === \"select\" && a.options?.length).map((attr) => {\r\n        const name = isBg && attr.name_bg ? attr.name_bg : attr.name;\r\n        const currentValue = getAttrValue(attr.id);\r\n        return (\r\n          <Drawer key={attr.id} open={attrDrawerOpen === attr.id} onOpenChange={(open) => setAttrDrawerOpen(open ? attr.id : null)}>\r\n            <DrawerContent className=\"max-h-dialog flex flex-col\">\r\n              <DrawerHeader className=\"border-b border-border pb-4\">\r\n                <DrawerTitle className=\"text-lg font-bold\">{name}</DrawerTitle>\r\n              </DrawerHeader>\r\n              <ScrollArea className=\"flex-1 min-h-0\">\r\n                <div className=\"p-4 space-y-1.5\">\r\n                  {attr.options?.map((opt, idx) => {\r\n                    const isSelected = currentValue === opt;\r\n                    const displayLabel = isBg && attr.options_bg?.[idx] ? attr.options_bg[idx] : opt;\r\n                    return (\r\n                      <button\r\n                        key={opt}\r\n                        type=\"button\"\r\n                        onClick={() => {\r\n                          handleAttrChange(attr, opt);\r\n                          setAttrDrawerOpen(null);\r\n                        }}\r\n                        className={cn(\r\n                          \"w-full flex items-center justify-between h-14 px-4 rounded-xl transition-colors\",\r\n                          \"active:opacity-90\",\r\n                          isSelected\r\n                            ? \"bg-selected border border-selected-border\"\r\n                            : \"bg-surface-subtle hover:bg-hover\"\r\n                        )}\r\n                      >\r\n                        <span className={cn(\r\n                          \"text-reading\",\r\n                          isSelected ? \"font-bold text-foreground\" : \"font-medium text-foreground\"\r\n                        )}>\r\n                          {displayLabel}\r\n                        </span>\r\n                        {isSelected && (\r\n                          <div className=\"size-6 rounded-full bg-checked flex items-center justify-center\">\r\n                            <Check className=\"size-3.5 text-checked-foreground\" weight=\"bold\" />\r\n                          </div>\r\n                        )}\r\n                      </button>\r\n                    );\r\n                  })}\r\n                </div>\r\n              </ScrollArea>\r\n            </DrawerContent>\r\n          </Drawer>\r\n        );\r\n      })}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\steps\\step-pricing.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useCallback' is defined but never used.","line":3,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":31,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useCallback"},"fix":{"range":[34,47],"text":""},"desc":"Remove unused variable \"useCallback\"."}]},{"ruleId":"unicorn/prefer-number-properties","severity":1,"message":"Prefer `Number.isNaN` over `isNaN`.","line":69,"column":16,"nodeType":"Identifier","messageId":"error","endLine":69,"endColumn":21,"suggestions":[{"messageId":"suggestion","fix":{"range":[2199,2204],"text":"Number.isNaN"},"data":{"description":"isNaN","property":"isNaN"},"desc":"Replace `isNaN` with `Number.isNaN`."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'errors' is assigned a value but never used.","line":95,"column":50,"nodeType":"Identifier","messageId":"unusedVar","endLine":95,"endColumn":56},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'price' is assigned a value but never used.","line":103,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":103,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useCallback } from \"react\";\r\nimport { Controller } from \"react-hook-form\";\r\nimport {\r\n  Tag,\r\n  Gavel,\r\n  Minus,\r\n  Plus,\r\n  Handshake,\r\n  CaretRight,\r\n  Check,\r\n} from \"@phosphor-icons/react\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\nimport {\r\n  Drawer,\r\n  DrawerContent,\r\n  DrawerHeader,\r\n  DrawerTitle,\r\n} from \"@/components/ui/drawer\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { cn } from \"@/lib/utils\";\nimport { formatOptions } from \"@/lib/sell/schema-v4\";\nimport { useSellForm, useSellFormContext } from \"../sell-form-provider\";\nimport { useTranslations } from \"next-intl\";\n\r\n// ============================================================================\r\n// STEP 4: PRICING - Clean iOS-style form\r\n// Format + Price + Currency + Quantity + Offers\r\n// ============================================================================\r\n\r\n// Bulgaria joined Eurozone Jan 1, 2025 - EUR only\r\nconst CURRENCIES = [\r\n  { value: \"EUR\", label: \"Γé¼\", labelFull: \"EUR (Γé¼)\" },\r\n] as const;\r\n\r\n// ============================================================================\r\n// Reusable Components - standardized h-14 touch targets\r\n// ============================================================================\r\n\r\nfunction QuantityStepper({\r\n  value,\r\n  onChange,\r\n  min = 1,\r\n  max = 9999,\r\n}: {\r\n  value: number;\r\n  onChange: (val: number) => void;\r\n  min?: number;\r\n  max?: number;\r\n}) {\r\n  return (\r\n    <div className=\"flex items-center h-14 w-fit rounded-xl border border-border bg-card overflow-hidden\">\r\n      <button\r\n        type=\"button\"\r\n        onClick={() => onChange(Math.max(min, value - 1))}\r\n        disabled={value <= min}\r\n        className=\"h-full px-5 flex items-center justify-center hover:bg-hover active:bg-active disabled:opacity-40 disabled:cursor-not-allowed transition-colors\"\r\n        aria-label=\"Decrease quantity\"\r\n      >\r\n        <Minus className=\"size-5\" weight=\"bold\" />\r\n      </button>\r\n      <Input\r\n        type=\"number\"\r\n        value={value}\r\n        onChange={(e) => {\r\n          const num = Number.parseInt(e.target.value, 10);\r\n          if (!isNaN(num)) {\r\n            onChange(Math.max(min, Math.min(max, num)));\r\n          }\r\n        }}\r\n        className=\"w-16 h-full text-center text-lg font-bold border-none bg-transparent focus-visible:ring-0 shadow-none\"\r\n        min={min}\r\n        max={max}\r\n      />\r\n      <button\r\n        type=\"button\"\r\n        onClick={() => onChange(Math.min(max, value + 1))}\r\n        disabled={value >= max}\r\n        className=\"h-full px-5 flex items-center justify-center hover:bg-hover active:bg-active disabled:opacity-40 disabled:cursor-not-allowed transition-colors\"\r\n        aria-label=\"Increase quantity\"\r\n      >\r\n        <Plus className=\"size-5\" weight=\"bold\" />\r\n      </button>\r\n    </div>\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// Main Component\r\n// ============================================================================\r\n\r\nexport function StepPricing() {\n  const { control, setValue, watch, formState: { errors } } = useSellForm();\n  const { isBg } = useSellFormContext();\n  const tSell = useTranslations(\"Sell\")\n\n  const [currencyDrawerOpen, setCurrencyDrawerOpen] = useState(false);\n\r\n  // Watch values\r\n  const format = watch(\"format\");\r\n  const price = watch(\"price\");\r\n  const currency = watch(\"currency\");\r\n  const compareAtPrice = watch(\"compareAtPrice\");\r\n  const quantity = watch(\"quantity\");\r\n  const acceptOffers = watch(\"acceptOffers\");\r\n\r\n  const currencySymbol = CURRENCIES.find(c => c.value === currency)?.label || currency;\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"space-y-1\">\r\n        <h2 className=\"text-2xl font-bold tracking-tight text-foreground\">\r\n          {isBg ? \"╨ª╨╡╨╜╨░ ╨╕ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░\" : \"Price & shipping\"}\r\n        </h2>\r\n        <p className=\"text-reading text-muted-foreground\">\r\n          {isBg \r\n            ? \"╨ù╨░╨┤╨░╨╣╤é╨╡ ╤å╨╡╨╜╨░ ╨╕ ╨╕╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨╛╨┐╤å╨╕╨╕ ╨╖╨░ ╨┤╨╛╤ü╤é╨░╨▓╨║╨░\" \r\n            : \"Set your price and choose shipping options\"}\r\n        </p>\r\n      </div>\r\n\r\n      {/* Format Selection - iOS segmented style */}\r\n      <div className=\"grid grid-cols-2 gap-3\">\r\n        {formatOptions.map((option) => {\n          const isSelected = format === option.value;\n          const Icon = option.value === \"fixed\" ? Tag : Gavel;\n          const label = tSell(option.labelKey as never);\n\n          return (\n            <button\n              key={option.value}\r\n              type=\"button\"\r\n              onClick={() => setValue(\"format\", option.value, { shouldValidate: true })}\r\n              className={cn(\r\n                \"flex items-center justify-center gap-2 h-14 rounded-xl border transition-all\",\r\n                \"active:opacity-90\",\r\n                isSelected\r\n                  ? \"bg-selected border-selected-border text-foreground font-bold\"\r\n                  : \"border-border bg-card hover:bg-hover text-muted-foreground\"\r\n              )}\r\n            >\r\n              <Icon className=\"size-5\" weight={isSelected ? \"fill\" : \"regular\"} />\r\n              <span className=\"text-reading\">{label}</span>\r\n            </button>\r\n          );\r\n        })}\r\n      </div>\r\n\r\n      {/* Price Input - iOS card style */}\r\n      <Controller\r\n        name=\"price\"\r\n        control={control}\r\n        render={({ field, fieldState }) => (\r\n          <div className=\"space-y-2\">\r\n            <div className=\"flex items-center justify-between px-1\">\r\n              <span className=\"text-tiny font-semibold uppercase tracking-wide text-muted-foreground\">\r\n                {isBg ? \"╨Æ╨░╤ê╨░╤é╨░ ╤å╨╡╨╜╨░\" : \"Your price\"} <span className=\"text-destructive\">*</span>\r\n              </span>\r\n            </div>\r\n            <div className={cn(\r\n              \"bg-card rounded-xl border overflow-hidden transition-all\",\r\n              \"focus-within:border-selected-border focus-within:ring-2 focus-within:ring-focus-ring\",\r\n              fieldState.invalid ? \"border-destructive/50 bg-destructive-subtle\" : \"border-border\"\n            )}>\r\n              <div className=\"flex items-center h-16 px-4\">\r\n                <span className=\"text-2xl font-bold text-muted-foreground mr-2\">\r\n                  {currencySymbol}\r\n                </span>\r\n                <Input\r\n                  {...field}\r\n                  type=\"text\"\r\n                  inputMode=\"decimal\"\r\n                  placeholder=\"0.00\"\r\n                  className=\"border-none bg-transparent h-full text-3xl font-bold p-0 focus-visible:ring-0 flex-1\"\r\n                />\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => setCurrencyDrawerOpen(true)}\r\n                  className=\"flex items-center gap-1.5 px-3 py-2 rounded-xl bg-surface-subtle hover:bg-hover active:bg-active transition-colors\"\r\n                >\r\n                  <span className=\"text-sm font-bold\">{currency}</span>\r\n                  <CaretRight className=\"size-3.5 text-muted-foreground rotate-90\" weight=\"bold\" />\r\n                </button>\r\n              </div>\r\n            </div>\r\n            {fieldState.invalid && fieldState.error && (\r\n              <p className=\"text-sm text-destructive px-1\">{fieldState.error.message}</p>\r\n            )}\r\n          </div>\r\n        )}\r\n      />\r\n\r\n      {/* Compare at Price - iOS grouped list item */}\r\n      <div className=\"space-y-2\">\r\n        <div className=\"flex items-center justify-between px-1\">\r\n          <span className=\"text-tiny font-semibold uppercase tracking-wide text-muted-foreground\">\r\n            {isBg ? \"╨í╤é╨░╤Ç╨░ ╤å╨╡╨╜╨░\" : \"Compare at price\"}\r\n            <span className=\"ml-1 font-normal opacity-60\">{isBg ? \"(╨┐╨╛ ╨╕╨╖╨▒╨╛╤Ç)\" : \"(optional)\"}</span>\r\n          </span>\r\n        </div>\r\n        <div className={cn(\r\n          \"bg-card rounded-xl border border-border overflow-hidden transition-all\",\r\n          \"focus-within:border-selected-border focus-within:ring-2 focus-within:ring-focus-ring\"\r\n        )}>\r\n          <div className=\"flex items-center h-14 px-4\">\r\n            <span className=\"text-lg font-bold text-muted-foreground mr-2\">\r\n              {currencySymbol}\r\n            </span>\r\n            <Input\r\n              type=\"text\"\r\n              inputMode=\"decimal\"\r\n              placeholder={isBg ? \"╨₧╤Ç╨╕╨│╨╕╨╜╨░╨╗╨╜╨░ ╤å╨╡╨╜╨░\" : \"Original price\"}\r\n              value={compareAtPrice || \"\"}\r\n              onChange={(e) => setValue(\"compareAtPrice\", e.target.value)}\r\n              className=\"border-none bg-transparent h-full text-lg font-semibold p-0 focus-visible:ring-0 flex-1\"\r\n            />\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Quantity */}\r\n      <div className=\"space-y-2\">\r\n        <span className=\"text-tiny font-semibold uppercase tracking-wide text-muted-foreground px-1\">\r\n          {isBg ? \"╨Ü╨╛╨╗╨╕╤ç╨╡╤ü╤é╨▓╨╛\" : \"Quantity\"}\r\n        </span>\r\n        <QuantityStepper\r\n          value={quantity}\r\n          onChange={(val) => setValue(\"quantity\", val, { shouldValidate: true })}\r\n        />\r\n      </div>\r\n\r\n      {/* Accept Offers Toggle - iOS list row style */}\r\n      <div\r\n        className={cn(\r\n          \"w-full flex items-center gap-3.5 py-3.5 min-h-touch-lg px-4 rounded-xl border transition-all\",\r\n          acceptOffers \r\n            ? \"bg-selected border-selected-border\" \r\n            : \"bg-card border-border hover:bg-hover\"\r\n        )}\r\n      >\r\n        <div className={cn(\r\n          \"size-11 rounded-xl flex items-center justify-center shrink-0 transition-all\",\r\n          acceptOffers \r\n            ? \"bg-checked text-checked-foreground\" \r\n            : \"bg-muted text-muted-foreground\"\r\n        )}>\r\n          <Handshake className=\"size-5\" weight={acceptOffers ? \"fill\" : \"regular\"} />\r\n        </div>\r\n        <div className=\"flex-1 text-left min-w-0\">\r\n          <span className=\"text-reading font-semibold text-foreground block\">\r\n            {isBg ? \"╨ƒ╤Ç╨╕╨╡╨╝╨░╨╜╨╡ ╨╜╨░ ╨╛╤ä╨╡╤Ç╤é╨╕\" : \"Accept offers\"}\r\n          </span>\r\n          <span className=\"text-sm text-muted-foreground line-clamp-1\">\r\n            {isBg\r\n              ? \"╨ƒ╨╛╨╖╨▓╨╛╨╗╨╡╤é╨╡ ╨╜╨░ ╨║╤â╨┐╤â╨▓╨░╤ç╨╕╤é╨╡ ╨┤╨░ ╨┐╤Ç╨╡╨┤╨╗╨░╨│╨░╤é ╤å╨╡╨╜╨░\"\r\n              : \"Let buyers negotiate the price\"}\r\n          </span>\r\n        </div>\r\n        <Switch \r\n          checked={acceptOffers} \r\n          onCheckedChange={(checked) => setValue(\"acceptOffers\", checked)}\r\n          className=\"shrink-0\"\r\n        />\r\n      </div>\r\n\r\n      {/* Currency Drawer */}\r\n      <Drawer open={currencyDrawerOpen} onOpenChange={setCurrencyDrawerOpen}>\r\n        <DrawerContent className=\"max-h-dialog flex flex-col\">\r\n          <DrawerHeader className=\"border-b border-border pb-4\">\r\n            <DrawerTitle className=\"text-lg font-bold\">\r\n              {isBg ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨▓╨░╨╗╤â╤é╨░\" : \"Select currency\"}\r\n            </DrawerTitle>\r\n          </DrawerHeader>\r\n          <ScrollArea className=\"flex-1 min-h-0\">\r\n            <div className=\"p-4 space-y-1.5\">\r\n              {CURRENCIES.map((curr) => {\r\n                const isSelected = currency === curr.value;\r\n                return (\r\n                  <button\r\n                    key={curr.value}\r\n                    type=\"button\"\r\n                    onClick={() => {\r\n                      setValue(\"currency\", curr.value as \"EUR\");\r\n                      setCurrencyDrawerOpen(false);\r\n                    }}\r\n                    className={cn(\r\n                      \"w-full flex items-center justify-between h-14 px-4 rounded-xl transition-colors\",\r\n                      \"active:opacity-90\",\r\n                      isSelected\r\n                        ? \"bg-selected border border-selected-border\"\r\n                        : \"bg-surface-subtle hover:bg-hover\"\r\n                    )}\r\n                  >\r\n                    <span className={cn(\r\n                      \"text-reading\",\r\n                      isSelected ? \"font-bold text-foreground\" : \"font-medium text-foreground\"\r\n                    )}>\r\n                      {curr.labelFull}\r\n                    </span>\r\n                    {isSelected && (\r\n                      <div className=\"size-6 rounded-full bg-checked flex items-center justify-center\">\r\n                        <Check className=\"size-3.5 text-checked-foreground\" weight=\"bold\" />\r\n                      </div>\r\n                    )}\r\n                  </button>\r\n                );\r\n              })}\r\n            </div>\r\n          </ScrollArea>\r\n        </DrawerContent>\r\n      </Drawer>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\steps\\step-review.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\steps\\step-what.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\ui\\brand-combobox.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used.","line":7,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":16,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Button"},"fix":{"range":[203,251],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_locale' is assigned a value but never used.","line":75,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":75,"endColumn":18},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":221,"column":17,"nodeType":"JSXOpeningElement","endLine":225,"endColumn":19},{"ruleId":"jsx-a11y/role-has-required-aria-props","severity":1,"message":"Elements with the ARIA role \"combobox\" must have the following attributes defined: aria-controls,aria-expanded","line":256,"column":7,"nodeType":"JSXAttribute","endLine":256,"endColumn":22},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":276,"column":13,"nodeType":"JSXOpeningElement","endLine":280,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport * as React from \"react\";\r\nimport { CheckIcon, ShieldCheck, Plus, X } from \"lucide-react\";\r\nimport { CaretRight } from \"@phosphor-icons/react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n  Command,\r\n  CommandEmpty,\r\n  CommandGroup,\r\n  CommandInput,\r\n  CommandItem,\r\n  CommandList,\r\n  CommandSeparator,\r\n} from \"@/components/ui/command\";\r\nimport {\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n} from \"@/components/ui/popover\";\r\nimport {\r\n  Drawer,\r\n  DrawerContent,\r\n  DrawerHeader,\r\n  DrawerTitle,\r\n} from \"@/components/ui/drawer\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport { useTranslations } from \"next-intl\";\r\n\r\n// ============================================================================\r\n// BRAND COMBOBOX - shadcn/ui Combobox pattern for brand selection\r\n// ============================================================================\r\n// Pattern verified from Context7 (shadcn/ui Combobox docs)\r\n// Uses Popover + Command for searchable dropdown with custom brand support\r\n\r\nexport interface Brand {\r\n  id: string;\r\n  name: string;\r\n  slug?: string;\r\n  logo_url?: string | null;\r\n  is_verified?: boolean;\r\n}\r\n\r\nexport interface BrandComboboxProps {\r\n  /** Array of available brands */\r\n  brands: Brand[];\r\n  /** Currently selected brand ID (null/undefined for custom brand) */\r\n  value: string | null | undefined;\r\n  /** Custom brand name (when value is null) */\r\n  customValue?: string;\r\n  /** Callback when brand selection changes */\r\n  onValueChange: (brandId: string | null, brandName: string) => void;\r\n  /** Placeholder text when nothing selected */\r\n  placeholder?: string;\r\n  /** Allow entering custom brand names */\r\n  allowCustom?: boolean;\r\n  /** Disable the combobox */\r\n  disabled?: boolean;\r\n  /** Custom class name */\r\n  className?: string;\r\n  /** Locale for translations */\r\n  locale?: string;\r\n}\r\n\r\nexport function BrandCombobox({\r\n  brands,\r\n  value,\r\n  customValue = \"\",\r\n  onValueChange,\r\n  placeholder,\r\n  allowCustom = true,\r\n  disabled = false,\r\n  className,\r\n  locale: _locale = \"en\",\r\n}: BrandComboboxProps) {\r\n  const [open, setOpen] = React.useState(false);\r\n  const [searchQuery, setSearchQuery] = React.useState(\"\");\r\n  const isMobile = useIsMobile();\r\n  \r\n  const t = useTranslations(\"Sell\")\r\n  const selectedBrand = brands.find((b) => b.id === value);\r\n  \r\n  // Display text for the trigger button\r\n  const displayText = React.useMemo(() => {\r\n    if (selectedBrand) return selectedBrand.name;\r\n    if (customValue) return customValue;\r\n    return placeholder ?? t(\"brandCombobox.defaultPlaceholder\");\r\n  }, [selectedBrand, customValue, placeholder, t]);\r\n\r\n  // Filter brands based on search query\r\n  const filteredBrands = React.useMemo(() => {\r\n    if (!searchQuery.trim()) {\r\n      return brands.slice(0, 50); // Limit initial display\r\n    }\r\n    const query = searchQuery.toLowerCase().trim();\r\n    return brands\r\n      .filter((b) =>\r\n        b.name.toLowerCase().includes(query) ||\r\n        b.slug?.toLowerCase().includes(query)\r\n      )\r\n      .sort((a, b) => {\r\n        // Exact match first\r\n        const aExact = a.name.toLowerCase() === query;\r\n        const bExact = b.name.toLowerCase() === query;\r\n        if (aExact && !bExact) return -1;\r\n        if (!aExact && bExact) return 1;\r\n        // Verified brands next\r\n        if (a.is_verified && !b.is_verified) return -1;\r\n        if (!a.is_verified && b.is_verified) return 1;\r\n        // Then alphabetically\r\n        return a.name.localeCompare(b.name);\r\n      })\r\n      .slice(0, 50);\r\n  }, [searchQuery, brands]);\r\n\r\n  // Check if custom value option should be shown\r\n  const showCustomOption = React.useMemo(() => {\r\n    if (!allowCustom || !searchQuery.trim()) return false;\r\n    const query = searchQuery.toLowerCase().trim();\r\n    return !brands.some((b) => b.name.toLowerCase() === query);\r\n  }, [allowCustom, searchQuery, brands]);\r\n\r\n  // Handle brand selection\r\n  const handleSelect = React.useCallback(\r\n    (brand: Brand) => {\r\n      onValueChange(brand.id, brand.name);\r\n      setOpen(false);\r\n      setSearchQuery(\"\");\r\n    },\r\n    [onValueChange]\r\n  );\r\n\r\n  // Handle custom brand entry\r\n  const handleCustomBrand = React.useCallback(() => {\r\n    if (searchQuery.trim()) {\r\n      onValueChange(null, searchQuery.trim());\r\n      setOpen(false);\r\n      setSearchQuery(\"\");\r\n    }\r\n  }, [searchQuery, onValueChange]);\r\n\r\n  // Handle clear\r\n  const handleClear = React.useCallback(\r\n    (e: React.MouseEvent) => {\r\n      e.stopPropagation();\r\n      onValueChange(null, \"\");\r\n    },\r\n    [onValueChange]\r\n  );\r\n\r\n  // Handle skip (unbranded)\r\n  const handleSkip = React.useCallback(() => {\r\n    onValueChange(null, \"\");\r\n    setOpen(false);\r\n    setSearchQuery(\"\");\r\n  }, [onValueChange]);\r\n\r\n  const commandContent = (\r\n    <Command shouldFilter={false} className=\"bg-transparent\">\r\n      <CommandInput\r\n        placeholder={t(\"brandCombobox.searchPlaceholder\")}\r\n        value={searchQuery}\r\n        onValueChange={setSearchQuery}\r\n        className=\"h-12 border-none focus:ring-0\"\r\n      />\r\n      <CommandList className={cn(\"overflow-y-auto\", isMobile ? \"max-h-(--dialog-h-50vh)\" : \"max-h-(--spacing-scroll-md)\")}>\r\n        <CommandEmpty>\r\n          {showCustomOption ? (\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleCustomBrand}\r\n              className=\"w-full p-3 text-left hover:bg-accent rounded-sm flex items-center gap-2\"\r\n            >\r\n                <Plus className=\"size-4 text-primary\" />\r\n                <span className=\"text-sm\">\r\n                  {t(\"brandCombobox.addCustom\", { name: searchQuery })}\r\n                </span>\r\n              </button>\r\n            ) : (\r\n              <span className=\"text-sm text-muted-foreground p-3 block\">\r\n                {t(\"brandCombobox.noBrandFound\")}\r\n              </span>\r\n            )}\r\n          </CommandEmpty>\r\n        \r\n        {/* Custom brand option when searching */}\r\n        {showCustomOption && filteredBrands.length > 0 && (\r\n          <>\r\n            <CommandGroup>\r\n              <CommandItem\r\n                onSelect={handleCustomBrand}\r\n                className=\"flex items-center gap-2\"\r\n              >\r\n                <Plus className=\"size-4 text-primary\" />\r\n                <span>\r\n                  {t(\"brandCombobox.addCustom\", { name: searchQuery })}\r\n                </span>\r\n              </CommandItem>\r\n            </CommandGroup>\r\n            <CommandSeparator />\r\n          </>\r\n        )}\r\n\r\n        <CommandGroup>\r\n          {filteredBrands.map((brand) => (\r\n            <CommandItem\r\n              key={brand.id}\r\n              value={brand.name}\r\n              onSelect={() => handleSelect(brand)}\r\n              className=\"flex items-center gap-2\"\r\n            >\r\n              <CheckIcon\r\n                className={cn(\r\n                  \"size-4 shrink-0\",\r\n                  value === brand.id ? \"opacity-100\" : \"opacity-0\"\r\n                )}\r\n              />\r\n              {/* Brand logo */}\r\n              {brand.logo_url ? (\r\n                <img\r\n                  src={brand.logo_url}\r\n                  alt=\"\"\r\n                  className=\"size-5 object-contain\"\r\n                />\r\n              ) : (\r\n                <div className=\"size-5 rounded bg-muted flex items-center justify-center text-xs font-medium text-muted-foreground\">\r\n                  {brand.name[0]}\r\n                </div>\r\n              )}\r\n              <span className=\"flex-1\">{brand.name}</span>\r\n              {brand.is_verified && (\r\n                <ShieldCheck className=\"size-4 text-primary shrink-0\" />\r\n              )}\r\n            </CommandItem>\r\n          ))}\r\n        </CommandGroup>\r\n\r\n        {/* Skip / Unbranded option */}\r\n        <CommandSeparator />\r\n        <CommandGroup>\r\n          <CommandItem\r\n            onSelect={handleSkip}\r\n            className=\"text-muted-foreground justify-center text-xs\"\r\n          >\r\n            {t(\"brandCombobox.skipNoBrand\")}\r\n          </CommandItem>\r\n        </CommandGroup>\r\n      </CommandList>\r\n    </Command>\r\n  );\r\n\r\n  const trigger = (\n    <button\n      type=\"button\"\n      role=\"combobox\"\n      aria-expanded={open}\n      onClick={isMobile ? () => setOpen(true) : undefined}\n      disabled={disabled}\n      className={cn(\n        \"relative w-full flex flex-col justify-center h-14 px-4 rounded-md border transition-all text-left\",\n        \"bg-background border border-border shadow-xs\",\n        \"hover:border-hover-border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:ring-offset-background\",\n        \"transition-colors\",\r\n        disabled && \"opacity-50 cursor-not-allowed\",\r\n        className\r\n      )}\r\n    >\r\n      <span className=\"text-2xs font-bold uppercase tracking-wider text-muted-foreground leading-none mb-1.5\">\r\n        {t(\"brandCombobox.label\")}\r\n      </span>\r\n      <div className=\"flex items-center justify-between w-full\">\r\n        <span className=\"flex items-center gap-2.5 truncate pr-12\">\r\n          {/* Brand logo if available */}\r\n          {selectedBrand?.logo_url && (\r\n            <img\r\n              src={selectedBrand.logo_url}\r\n              alt=\"\"\r\n              className=\"size-5 object-contain\"\r\n            />\r\n          )}\r\n          <span className={cn(\r\n            \"text-sm font-semibold truncate\",\r\n            (selectedBrand || customValue) ? \"text-foreground\" : \"text-muted-foreground\"\r\n          )}>\r\n            {displayText}\r\n          </span>\r\n          {/* Verified badge */}\r\n          {selectedBrand?.is_verified && (\r\n            <ShieldCheck className=\"size-3.5 text-primary shrink-0\" />\r\n          )}\r\n          {/* Custom brand indicator */}\r\n          {customValue && !selectedBrand && (\r\n            <span className=\"text-2xs font-bold text-muted-foreground uppercase tracking-wider shrink-0\">\r\n              ({t(\"brandCombobox.customIndicator\")})\r\n            </span>\r\n          )}\r\n        </span>\r\n      </div>\r\n      <div className=\"absolute right-4 top-1/2 -translate-y-1/2 flex items-center gap-1.5 shrink-0\">\r\n        {/* Clear button */}\r\n        {(selectedBrand || customValue) && (\r\n          <span\r\n            role=\"button\"\r\n            tabIndex={0}\r\n            onClick={handleClear}\r\n            onKeyDown={(e) => e.key === \"Enter\" && handleClear(e as unknown as React.MouseEvent)}\r\n            className=\"size-6 flex items-center justify-center rounded-lg hover:bg-muted transition-colors\"\r\n            aria-label={t(\"brandCombobox.clear\")}\r\n          >\r\n            <X className=\"size-3.5 text-muted-foreground\" />\r\n          </span>\r\n        )}\r\n        <CaretRight className=\"size-4 text-muted-foreground\" weight=\"bold\" />\r\n      </div>\r\n    </button>\r\n  );\r\n\r\n  if (isMobile) {\n    return (\n      <>\n        {trigger}\n        <Drawer open={open} onOpenChange={setOpen}>\n          <DrawerContent>\n            <DrawerHeader className=\"text-left border-b border-border/50 pb-4\">\n              <DrawerTitle className=\"text-base font-bold\">\n                {t(\"brandCombobox.mobileTitle\")}\n              </DrawerTitle>\r\n            </DrawerHeader>\r\n            <div className=\"p-2 pb-8\">\r\n              {commandContent}\r\n            </div>\r\n          </DrawerContent>\r\n        </Drawer>\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Popover open={open} onOpenChange={setOpen}>\r\n      <PopoverTrigger asChild>\r\n        {trigger}\r\n      </PopoverTrigger>\r\n      <PopoverContent \r\n        className=\"w-(--radix-popover-trigger-width) p-0\" \r\n        align=\"start\"\r\n      >\r\n        {commandContent}\r\n      </PopoverContent>\r\n    </Popover>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\ui\\category-modal\\index.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":4,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":30,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[100,103],"text":""},"desc":"Remove unused variable \"X\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'handleClear' is assigned a value but never used.","line":262,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":262,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useMemo, useCallback } from \"react\";\r\nimport { CaretRight, Check, X, MagnifyingGlass, CaretLeft, FolderSimple } from \"@phosphor-icons/react\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\";\r\nimport {\r\n  Drawer,\r\n  DrawerContent,\r\n  DrawerHeader,\r\n  DrawerTitle,\r\n  DrawerDescription,\r\n} from \"@/components/ui/drawer\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { useIsMobile } from \"@/hooks/use-mobile\";\r\nimport type { Category, CategoryPathItem } from \"../../../_lib/types\";\r\n\r\n// ============================================================================\r\n// Types\r\n// ============================================================================\r\ninterface CategoryModalProps {\r\n  categories: Category[];\r\n  value: string;\r\n  selectedPath?: CategoryPathItem[];\r\n  onChange: (categoryId: string, path: CategoryPathItem[]) => void;\r\n  locale?: string;\r\n  className?: string;\r\n}\r\n\r\ninterface FlatCategory extends Category {\r\n  path: CategoryPathItem[];\r\n  fullPath: string;\r\n  searchText: string;\r\n}\r\n\r\n// ============================================================================\r\n// Shared Sub-Components (DRY)\r\n// ============================================================================\r\n\r\n/** Reusable search input for category search */\r\nfunction CategorySearchInput({\r\n  value,\r\n  onChange,\r\n  locale,\r\n  compact = false,\r\n}: {\r\n  value: string;\r\n  onChange: (val: string) => void;\r\n  locale: string;\r\n  compact?: boolean;\r\n}) {\r\n  return (\r\n    <div className=\"relative\">\r\n      <MagnifyingGlass \r\n        className={cn(\r\n          \"absolute top-1/2 -translate-y-1/2 text-muted-foreground\",\r\n          compact ? \"left-2.5 size-4\" : \"left-3.5 size-5 text-muted-foreground\"\r\n        )} \r\n        weight=\"bold\" \r\n      />\r\n      <Input\r\n        value={value}\r\n        onChange={(e) => onChange(e.target.value)}\r\n        placeholder={locale === \"bg\" ? (compact ? \"╨ó╤è╤Ç╤ü╨╕...\" : \"╨ó╤è╤Ç╤ü╨╕ ╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å...\") : (compact ? \"Search...\" : \"Search category...\")}\r\n        className={cn(\r\n          compact \r\n            ? \"pl-9 h-9 text-sm\" \r\n            : \"pl-11 h-12 text-base font-medium rounded-md border-border bg-muted focus:bg-background transition-colors\"\r\n        )}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n\r\n/** Reusable empty state when no search results */\r\nfunction CategoryEmptyState({ locale, compact = false }: { locale: string; compact?: boolean }) {\r\n  if (compact) {\r\n    return (\r\n      <div className=\"py-8 text-center text-muted-foreground\">\r\n        <p className=\"text-sm\">\r\n          {locale === \"bg\" ? \"╨¥╤Å╨╝╨░ ╤Ç╨╡╨╖╤â╨╗╤é╨░╤é╨╕\" : \"No results\"}\r\n        </p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"py-12 text-center\">\r\n      <div className=\"size-16 rounded-full bg-surface-subtle flex items-center justify-center mx-auto mb-4\">\r\n        <MagnifyingGlass className=\"size-8 text-muted-foreground\" />\r\n      </div>\r\n      <p className=\"text-sm font-bold text-muted-foreground uppercase tracking-widest\">\r\n        {locale === \"bg\" ? \"╨¥╤Å╨╝╨░ ╨╜╨░╨╝╨╡╤Ç╨╡╨╜╨╕ ╤Ç╨╡╨╖╤â╨╗╤é╨░╤é╨╕\" : \"No results found\"}\r\n      </p>\r\n    </div>\r\n  );\r\n}\r\n\r\n/** Reusable search results list */\r\nfunction CategorySearchResults({\r\n  results,\r\n  selectedValue,\r\n  onSelect,\r\n  locale,\r\n  compact = false,\r\n}: {\r\n  results: FlatCategory[];\r\n  selectedValue: string;\r\n  onSelect: (cat: FlatCategory) => void;\r\n  locale: string;\r\n  compact?: boolean;\r\n}) {\r\n  const getName = (cat: FlatCategory) =>\r\n    locale === \"bg\" && cat.name_bg ? cat.name_bg : cat.name;\r\n\r\n  if (compact) {\r\n    return (\r\n      <div className=\"space-y-1\">\r\n        {results.map((cat) => (\r\n          <button\r\n            key={cat.id}\r\n            type=\"button\"\r\n            onClick={() => onSelect(cat)}\r\n            className={cn(\r\n              \"w-full flex flex-col items-start gap-0.5 px-3 py-2 rounded-md text-left transition-colors\",\r\n              \"hover:bg-hover\",\r\n              selectedValue === cat.id && \"bg-selected\"\r\n            )}\r\n          >\r\n            <span className=\"text-sm font-medium\">{getName(cat)}</span>\r\n            <span className=\"text-xs text-muted-foreground truncate w-full\">\r\n              {cat.fullPath}\r\n            </span>\r\n          </button>\r\n        ))}\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"grid gap-2\">\r\n      {results.map((cat) => (\r\n        <button\r\n          key={cat.id}\r\n          type=\"button\"\r\n          onClick={() => onSelect(cat)}\r\n          className={cn(\r\n            \"w-full flex flex-col items-start gap-0.5 px-4 py-2.5 rounded-md border text-left transition-colors\",\r\n            selectedValue === cat.id \r\n              ? \"border-selected-border bg-selected shadow-xs\" \r\n              : \"border-border bg-background hover:border-hover-border\"\r\n          )}\r\n        >\r\n          <span className=\"text-sm font-bold text-foreground\">{getName(cat)}</span>\r\n          <span className=\"text-2xs font-bold text-muted-foreground uppercase tracking-wider truncate w-full\">\r\n            {cat.fullPath}\r\n          </span>\r\n        </button>\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// Helper Functions\r\n// ============================================================================\r\nfunction toPathItem(cat: Category): CategoryPathItem {\r\n  return {\r\n    id: cat.id,\r\n    name: cat.name,\r\n    name_bg: cat.name_bg ?? null,\r\n    slug: cat.slug,\r\n  };\r\n}\r\n\r\n// ============================================================================\r\n// Main Category Selector (Exported)\r\n// ============================================================================\r\nexport function CategorySelector({\r\n  categories,\r\n  value,\r\n  selectedPath,\r\n  onChange,\r\n  locale = \"en\",\r\n  className,\r\n}: CategoryModalProps) {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const isMobile = useIsMobile();\r\n\r\n  // Flatten categories for search and lookup\r\n  const flatCategories = useMemo(() => {\r\n    const result: FlatCategory[] = [];\r\n    function flatten(cats: Category[], path: CategoryPathItem[] = []) {\r\n      for (const cat of cats) {\r\n        const currentPath = [...path, toPathItem(cat)];\r\n        const fullPath = currentPath\r\n          .map((c) => (locale === \"bg\" && c.name_bg ? c.name_bg : c.name))\r\n          .join(\" ΓÇ║ \");\r\n        result.push({\r\n          ...cat,\r\n          path: currentPath,\r\n          fullPath,\r\n          searchText: `${cat.name} ${cat.name_bg || \"\"} ${cat.slug}`.toLowerCase(),\r\n        });\r\n        if (cat.children?.length) {\r\n          flatten(cat.children, currentPath);\r\n        }\r\n      }\r\n    }\r\n    flatten(categories);\r\n    return result;\r\n  }, [categories, locale]);\r\n\r\n  // Find selected category\r\n  const selectedCategory = useMemo(() => {\r\n    if (!value) return null;\r\n    const found = flatCategories.find((c) => c.id === value);\r\n    if (found) return found;\r\n\r\n    // If not found in flat list (lazy loaded), use selectedPath if available\r\n    if (selectedPath && selectedPath.length > 0) {\r\n      const last = selectedPath.at(-1);\r\n      if (last && last.id === value) {\r\n        const fullPath = selectedPath\r\n          .map((c) => (locale === \"bg\" && c.name_bg ? c.name_bg : c.name))\r\n          .join(\" ΓÇ║ \");\r\n        return {\r\n          ...last,\r\n          parent_id: null,\r\n          path: selectedPath,\r\n          fullPath,\r\n          searchText: \"\",\r\n        } as FlatCategory;\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }, [flatCategories, value, selectedPath, locale]);\r\n\r\n  // Smart path display for mobile to save space\r\n  const displayPath = useMemo(() => {\r\n    if (!selectedCategory) return locale === \"bg\" ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡...\" : \"Select...\";\r\n    \r\n    const path = selectedCategory.path;\r\n    if (!path || path.length === 0) return selectedCategory.name;\r\n\r\n    // On mobile, truncate long paths to show only the most relevant context (last 2 segments)\r\n    if (isMobile && path.length > 2) {\r\n      const lastTwo = path.slice(-2).map(c => (locale === \"bg\" && c.name_bg ? c.name_bg : c.name));\r\n      return `... ΓÇ║ ${lastTwo.join(\" ΓÇ║ \")}`;\r\n    }\r\n    \r\n    return selectedCategory.fullPath;\r\n  }, [selectedCategory, locale, isMobile]);\r\n\r\n  const handleClear = (e: React.MouseEvent) => {\r\n    e.stopPropagation();\r\n    onChange(\"\", []);\r\n  };\r\n\r\n  const handleSelect = useCallback(\r\n    (cat: FlatCategory) => {\r\n      onChange(cat.id, cat.path);\r\n      setIsOpen(false);\r\n    },\r\n    [onChange]\r\n  );\r\n\r\n  // ===== TRIGGER BUTTON - Compact, matches input styling =====\r\n  const TriggerButton = (\r\n    <button\r\n      type=\"button\"\r\n      onClick={() => setIsOpen(true)}\r\n      className={cn(\r\n        \"relative w-full flex items-center h-12 px-4 rounded-md border transition-all text-left\",\r\n        \"bg-background border border-border shadow-xs\",\r\n        \"hover:border-hover-border focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:ring-offset-background\",\r\n        \"transition-colors\",\r\n        className\r\n      )}\r\n    >\r\n      <div className=\"flex items-center gap-2 flex-1 min-w-0\">\r\n        <span className=\"text-2xs font-bold uppercase tracking-wider text-muted-foreground shrink-0\">\r\n          {locale === \"bg\" ? \"╨Ü╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å:\" : \"Category:\"}\r\n        </span>\r\n        <span className={cn(\r\n          \"text-sm font-semibold truncate pr-4\",\r\n          selectedCategory ? \"text-foreground\" : \"text-muted-foreground\"\r\n        )}>\r\n          {displayPath}\r\n        </span>\r\n      </div>\r\n      <div className=\"flex items-center gap-2 shrink-0\">\r\n        {selectedCategory && (\r\n          <div className=\"size-5 rounded-full bg-selected flex items-center justify-center\">\r\n            <Check className=\"size-3 text-primary\" weight=\"bold\" />\r\n          </div>\r\n        )}\r\n        <CaretRight className=\"size-4 text-muted-foreground\" weight=\"bold\" />\r\n      </div>\r\n    </button>\r\n  );\r\n\r\n  const contentProps = {\r\n    categories,\r\n    flatCategories,\r\n    value,\r\n    onSelect: handleSelect,\r\n    locale,\r\n  };\r\n\r\n  if (isMobile) {\r\n    return (\r\n      <>\r\n        {TriggerButton}\r\n        <Drawer open={isOpen} onOpenChange={setIsOpen} snapPoints={[1]}>\r\n          <DrawerContent className=\"h-full max-h-full rounded-none\">\r\n            <DrawerHeader className=\"sr-only\">\r\n              <DrawerTitle>\r\n                {locale === \"bg\" ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╕ ╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å\" : \"Select Category\"}\r\n              </DrawerTitle>\r\n              <DrawerDescription>\r\n                {locale === \"bg\" ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╡╤é╨╡ ╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å ╨╖╨░ ╨▓╨░╤ê╨╕╤Å ╨┐╤Ç╨╛╨┤╤â╨║╤é\" : \"Choose a category for your product\"}\r\n              </DrawerDescription>\r\n            </DrawerHeader>\r\n            <CategoryModalContent {...contentProps} isMobile />\r\n          </DrawerContent>\r\n        </Drawer>\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {TriggerButton}\r\n      <Dialog open={isOpen} onOpenChange={setIsOpen}>\r\n        <DialogContent className=\"max-w-2xl max-h-dialog-sm p-0 gap-0 rounded-lg\">\r\n          <DialogHeader className=\"px-4 py-3 border-b\">\r\n            <DialogTitle className=\"text-base font-semibold\">\r\n              {locale === \"bg\" ? \"╨ÿ╨╖╨▒╨╡╤Ç╨╕ ╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å\" : \"Select Category\"}\r\n            </DialogTitle>\r\n          </DialogHeader>\r\n          <CategoryModalContent {...contentProps} isMobile={false} />\r\n        </DialogContent>\r\n      </Dialog>\r\n    </>\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// Modal Content (Shared between Mobile/Desktop)\r\n// ============================================================================\r\ninterface CategoryModalContentProps {\r\n  categories: Category[];\r\n  flatCategories: FlatCategory[];\r\n  value: string;\r\n  onSelect: (cat: FlatCategory) => void;\r\n  locale: string;\r\n  isMobile: boolean;\r\n}\r\n\r\nfunction CategoryModalContent({\r\n  categories,\r\n  flatCategories,\r\n  value,\r\n  onSelect,\r\n  locale,\r\n  isMobile,\r\n}: CategoryModalContentProps) {\r\n  const [searchQuery, setSearchQuery] = useState(\"\");\r\n  const [navigationPath, setNavigationPath] = useState<Category[]>([]);\r\n  const [activeL1, setActiveL1] = useState<Category | null>(categories[0] || null);\r\n  const [childrenById, setChildrenById] = useState<Record<string, Category[]>>({});\r\n  const [loadingChildrenById, setLoadingChildrenById] = useState<Record<string, boolean>>({});\r\n\r\n  const MAX_DEPTH = 4; // L0 -> L1 -> L2 -> L3 -> L4 (supports 647 L4 categories)\r\n  const stepLabels = locale === \"bg\"\r\n    ? [\"╨¥╨╕╨▓╨╛ 0\", \"╨¥╨╕╨▓╨╛ 1\", \"╨¥╨╕╨▓╨╛ 2\", \"╨¥╨╕╨▓╨╛ 3\", \"╨¥╨╕╨▓╨╛ 4\"]\r\n    : [\"Level 0\", \"Level 1\", \"Level 2\", \"Level 3\", \"Level 4\"];\r\n  const lastNavigationItem = navigationPath.at(-1)\r\n\r\n  const getName = (cat: Category) =>\r\n    locale === \"bg\" && cat.name_bg ? cat.name_bg : cat.name;\r\n\r\n  const getChildren = useCallback(\r\n    (cat: Category | null): Category[] => {\r\n      if (!cat) return [];\r\n      return childrenById[cat.id] ?? cat.children ?? [];\r\n    },\r\n    [childrenById]\r\n  );\r\n\r\n  const ensureChildrenLoaded = useCallback(\r\n    async (cat: Category): Promise<Category[]> => {\r\n      const existing = getChildren(cat);\r\n      if (existing.length > 0) return existing;\r\n      \r\n      // Skip if already loading\r\n      if (loadingChildrenById[cat.id]) return [];\r\n      \r\n      // Lazy-load children from API for deeper levels (L4+)\r\n      setLoadingChildrenById(prev => ({ ...prev, [cat.id]: true }));\r\n      try {\r\n        const res = await fetch(`/api/categories/${encodeURIComponent(cat.id)}/children`);\r\n        if (res.ok) {\r\n          const data = await res.json();\r\n          const children = (data.children || []) as Category[];\r\n          if (children.length > 0) {\r\n            setChildrenById(prev => ({ ...prev, [cat.id]: children }));\r\n            return children;\r\n          }\r\n        }\r\n      } catch {\r\n        // Silently fail - treat as leaf category\r\n      } finally {\r\n        setLoadingChildrenById(prev => ({ ...prev, [cat.id]: false }));\r\n      }\r\n      return [];\r\n    },\r\n    [getChildren, loadingChildrenById]\r\n  );\r\n\r\n  // Search results\r\n  const searchResults = useMemo(() => {\r\n    if (!searchQuery.trim()) return [];\r\n    const query = searchQuery.toLowerCase();\r\n    return flatCategories\r\n      .filter((cat) => cat.searchText.includes(query))\r\n      .slice(0, 12);\r\n  }, [flatCategories, searchQuery]);\r\n\r\n  // Current level categories\r\n  const currentCategories = useMemo(() => {\r\n    if (isMobile) {\r\n      if (navigationPath.length === 0) return categories;\r\n      const lastInPath = navigationPath.at(-1);\r\n      if (!lastInPath) return categories;\r\n      return getChildren(lastInPath);\r\n    } else {\r\n      return getChildren(activeL1);\r\n    }\r\n  }, [categories, navigationPath, activeL1, isMobile, getChildren]);\r\n\r\n  // Helper to construct FlatCategory for lazy-loaded categories\r\n  const constructFlatCategory = useCallback(\r\n    (cat: Category, path: Category[]): FlatCategory => {\r\n      const pathItems = [...path, cat].map(toPathItem);\r\n      const fullPath = pathItems\r\n        .map((c) => (locale === \"bg\" && c.name_bg ? c.name_bg : c.name))\r\n        .join(\" ΓÇ║ \");\r\n      return {\r\n        ...cat,\r\n        path: pathItems,\r\n        fullPath,\r\n        searchText: `${cat.name} ${cat.name_bg || \"\"} ${cat.slug}`.toLowerCase(),\r\n      };\r\n    },\r\n    [locale]\r\n  );\r\n\r\n  // Navigation handlers\r\n  const handleNavigate = useCallback(async (cat: Category) => {\r\n    const depth = navigationPath.length;\r\n    const knownChildren = getChildren(cat);\r\n\r\n    // If we're already at max depth, treat selection as final.\r\n    if (depth >= MAX_DEPTH) {\r\n      // First try to find in flatCategories (for pre-loaded items)\r\n      let flatCat = flatCategories.find((c) => c.id === cat.id);\r\n      // If not found (lazy-loaded), construct it from the navigation path\r\n      if (!flatCat) {\r\n        flatCat = constructFlatCategory(cat, navigationPath);\r\n      }\r\n      onSelect(flatCat);\r\n      return;\r\n    }\r\n\r\n    if (knownChildren.length > 0) {\r\n      setNavigationPath((prev) => [...prev, cat]);\r\n      return;\r\n    }\r\n\r\n    // Lazy-load children when not preloaded (keeps payload small; L3 can be huge).\r\n    const loadedChildren = await ensureChildrenLoaded(cat);\r\n    if (loadedChildren.length > 0) {\r\n      setNavigationPath((prev) => [...prev, cat]);\r\n      return;\r\n    }\r\n\r\n    // Leaf category - first try flatCategories, then construct\r\n    let flatCat = flatCategories.find((c) => c.id === cat.id);\r\n    if (!flatCat) {\r\n      flatCat = constructFlatCategory(cat, navigationPath);\r\n    }\r\n    onSelect(flatCat);\r\n  }, [MAX_DEPTH, constructFlatCategory, ensureChildrenLoaded, flatCategories, getChildren, navigationPath, onSelect]);\r\n\r\n  const handleDesktopNavigate = useCallback(async (cat: Category) => {\r\n    const knownChildren = getChildren(cat);\r\n    if (knownChildren.length > 0) {\r\n      setActiveL1(cat);\r\n      return;\r\n    }\r\n\r\n    const loadedChildren = await ensureChildrenLoaded(cat);\r\n    if (loadedChildren.length > 0) {\r\n      setActiveL1(cat);\r\n      return;\r\n    }\r\n\r\n    // Leaf category - first try flatCategories, then construct\r\n    let flatCat = flatCategories.find((c) => c.id === cat.id);\r\n    if (!flatCat) {\r\n      // For desktop, the path is just [activeL1, cat] if activeL1 is set\r\n      const path = activeL1 ? [activeL1] : [];\r\n      flatCat = constructFlatCategory(cat, path);\r\n    }\r\n    onSelect(flatCat);\r\n  }, [activeL1, constructFlatCategory, ensureChildrenLoaded, flatCategories, getChildren, onSelect]);\r\n\r\n  const handleBack = useCallback(() => {\r\n    setNavigationPath((prev) => prev.slice(0, -1));\r\n  }, []);\r\n\r\n  const handleSearchSelect = useCallback((cat: FlatCategory) => {\r\n    onSelect(cat);\r\n  }, [onSelect]);\r\n\r\n  // ===== MOBILE LAYOUT =====\r\n  if (isMobile) {\r\n    const currentStep = Math.min(navigationPath.length, MAX_DEPTH) + 1;\r\n    return (\r\n      <div className=\"flex flex-col min-h-0 flex-1 bg-background\">\r\n        {/* Header: Search + Step/Breadcrumb combined */}\r\n        <div className=\"flex flex-col border-b border-border/50 bg-background shrink-0\">\r\n          {/* Search Row */}\r\n          <div className=\"px-4 py-3\">\r\n            <CategorySearchInput value={searchQuery} onChange={setSearchQuery} locale={locale} />\r\n          </div>\r\n\r\n          {/* Step & Breadcrumb Row */}\r\n          {!searchQuery.trim() && (\r\n            <div className=\"px-4 py-2.5 bg-surface-subtle flex items-center justify-between gap-4 border-t border-border/50\">\r\n              <div className=\"flex items-center gap-3 min-w-0\">\r\n                {navigationPath.length > 0 ? (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={handleBack}\r\n                    className=\"size-8 flex items-center justify-center rounded-lg bg-background border border-border shadow-xs shrink-0 transition-colors hover:bg-hover active:bg-active\"\r\n                  >\r\n                    <CaretLeft className=\"size-4\" weight=\"bold\" />\r\n                  </button>\r\n                ) : (\r\n                  <div className=\"size-8 flex items-center justify-center rounded-lg bg-selected border border-selected-border shrink-0\">\r\n                    <FolderSimple className=\"size-4 text-primary\" weight=\"bold\" />\r\n                  </div>\r\n                )}\r\n                \r\n                <div className=\"flex flex-col min-w-0\">\r\n                  <span className=\"text-2xs font-bold text-muted-foreground uppercase tracking-widest leading-none mb-1\">\r\n                    {locale === \"bg\" ? \"╨í╤é╤è╨┐╨║╨░\" : \"Step\"} {currentStep}/{MAX_DEPTH + 1}\r\n                  </span>\r\n                  <h3 className=\"text-xs font-bold text-foreground uppercase tracking-wider truncate\">\r\n                    {navigationPath.length > 0 \r\n                      ? (lastNavigationItem ? getName(lastNavigationItem) : stepLabels[0])\r\n                      : stepLabels[0]\r\n                    }\r\n                  </h3>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"shrink-0 px-2 py-1 rounded-md bg-background border border-border shadow-xs\">\r\n                <span className=\"text-2xs font-bold text-primary uppercase tracking-tighter\">\r\n                  {stepLabels[Math.min(currentStep - 1, stepLabels.length - 1)]}\r\n                </span>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <ScrollArea className=\"flex-1 min-h-0\">\r\n          <div className=\"p-4\">\r\n            {searchQuery.trim() ? (\r\n              searchResults.length === 0 ? (\r\n                <CategoryEmptyState locale={locale} />\r\n              ) : (\r\n                <CategorySearchResults\r\n                  results={searchResults}\r\n                  selectedValue={value}\r\n                  onSelect={handleSearchSelect}\r\n                  locale={locale}\r\n                />\r\n              )\r\n            ) : (\r\n              <div className=\"grid grid-cols-2 gap-3\">\r\n                {currentCategories.map((cat) => (\r\n                  <CategoryCard\r\n                    key={cat.id}\r\n                    category={cat}\r\n                    isSelected={value === cat.id}\r\n                    hasChildren={getChildren(cat).length > 0}\r\n                    onClick={() => handleNavigate(cat)}\r\n                    locale={locale}\r\n                  />\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </ScrollArea>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // ===== DESKTOP LAYOUT (Two-Panel) =====\r\n  return (\r\n    <div className=\"flex h-(--spacing-scroll-lg)\">\r\n      {/* Left Panel - L1 Categories */}\r\n      <div className=\"w-48 border-r bg-surface-subtle\">\r\n        <ScrollArea className=\"h-full\">\r\n          <div className=\"p-1.5\">\r\n            {categories.map((cat) => (\r\n              <button\r\n                key={cat.id}\r\n                type=\"button\"\r\n                onClick={() => setActiveL1(cat)}\r\n                className={cn(\r\n                  \"w-full flex items-center justify-between px-3 py-2 rounded-md text-sm transition-colors\",\r\n                  activeL1?.id === cat.id\r\n                    ? \"bg-selected text-primary font-medium\"\r\n                    : \"text-foreground hover:bg-hover\"\r\n                )}\r\n              >\r\n                <span className=\"truncate\">{getName(cat)}</span>\r\n                {getChildren(cat).length > 0 ? (\r\n                  <CaretRight className=\"size-3.5 text-muted-foreground shrink-0\" />\r\n                ) : null}\r\n              </button>\r\n            ))}\r\n          </div>\r\n        </ScrollArea>\r\n      </div>\r\n\r\n      {/* Right Panel - Subcategories */}\r\n      <div className=\"flex-1 flex flex-col\">\r\n        {/* Search */}\r\n        <div className=\"px-3 py-2 border-b\">\r\n          <CategorySearchInput value={searchQuery} onChange={setSearchQuery} locale={locale} compact />\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <ScrollArea className=\"flex-1\">\r\n          <div className=\"p-3\">\r\n            {searchQuery.trim() ? (\r\n              searchResults.length === 0 ? (\r\n                <CategoryEmptyState locale={locale} compact />\r\n              ) : (\r\n                <CategorySearchResults\r\n                  results={searchResults}\r\n                  selectedValue={value}\r\n                  onSelect={handleSearchSelect}\r\n                  locale={locale}\r\n                  compact\r\n                />\r\n              )\r\n            ) : (\r\n              <div className=\"grid grid-cols-3 gap-2\">\r\n                {currentCategories.map((cat) => (\r\n                  <CategoryCard\r\n                    key={cat.id}\r\n                    category={cat}\r\n                    isSelected={value === cat.id}\r\n                    hasChildren={getChildren(cat).length > 0}\r\n                    onClick={() => {\r\n                      void handleDesktopNavigate(cat);\r\n                    }}\r\n                    locale={locale}\r\n                  />\r\n                ))}\r\n              </div>\r\n            )}\r\n          </div>\r\n        </ScrollArea>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n// ============================================================================\r\n// Category Card Component - Compact, clean design\r\n// ============================================================================\r\ninterface CategoryCardProps {\r\n  category: Category;\r\n  isSelected: boolean;\r\n  hasChildren: boolean;\r\n  onClick: () => void;\r\n  locale: string;\r\n}\r\n\r\nfunction CategoryCard({\r\n  category,\r\n  isSelected,\r\n  hasChildren,\r\n  onClick,\r\n  locale,\r\n}: CategoryCardProps) {\r\n  const name = locale === \"bg\" && category.name_bg ? category.name_bg : category.name;\r\n\r\n  return (\r\n      <button\r\n        type=\"button\"\r\n        onClick={onClick}\r\n        className={cn(\r\n          \"relative flex items-center justify-between gap-3 w-full px-4 py-2.5 rounded-md border text-left transition-colors min-h-12 touch-manipulation\",\r\n          \"hover:border-hover-border active:bg-active\",\r\n          \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1 focus-visible:ring-offset-background\",\r\n          isSelected \r\n            ? \"border-selected-border bg-selected shadow-xs\" \r\n            : \"border-border bg-background shadow-xs\"\r\n        )}\r\n      >\r\n      <span className=\"text-sm font-bold text-foreground line-clamp-2 flex-1 leading-tight\">\r\n        {name}\r\n      </span>\r\n        <div className=\"shrink-0\">\r\n          {hasChildren ? (\r\n            <div className=\"size-5 rounded-full bg-surface-subtle flex items-center justify-center\">\r\n              <CaretRight className=\"size-3 text-muted-foreground\" weight=\"bold\" />\r\n            </div>\r\n          ) : isSelected ? (\r\n            <div className=\"size-5 rounded-full bg-primary flex items-center justify-center\">\r\n              <Check className=\"size-2.5 text-primary-foreground\" weight=\"bold\" />\r\n            </div>\r\n          ) : (\r\n            <div className=\"size-5 rounded-full border border-border/50\" />\r\n          )}\r\n        </div>\r\n    </button>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\ui\\checklist-sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\ui\\image-preview-modal.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":37,"column":7,"nodeType":"JSXOpeningElement","endLine":42,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { X } from \"@phosphor-icons/react\";\r\nimport type { ProductImage } from \"@/lib/sell/schema-v4\";\r\n\r\ninterface ImagePreviewModalProps {\r\n  image: ProductImage;\r\n  onClose: () => void;\r\n}\r\n\r\n/**\r\n * ImagePreviewModal - Full screen image preview overlay\r\n * \r\n * Shows a large preview of a product image with close button.\r\n * Used in the photos section for previewing uploaded images.\r\n */\r\nexport function ImagePreviewModal({\r\n  image,\r\n  onClose,\r\n}: ImagePreviewModalProps) {\r\n    return (\r\n      <div \r\n      className=\"fixed inset-0 z-50 bg-surface-gallery text-overlay-text flex items-center justify-center p-4\"\r\n      onClick={onClose}\r\n      role=\"dialog\"\r\n      aria-modal=\"true\"\r\n      aria-label=\"Image preview\"\r\n    >\r\n      <button\r\n        type=\"button\"\r\n        onClick={onClose}\r\n        className=\"absolute top-4 right-4 p-3 rounded-full bg-overlay-light/10 hover:bg-overlay-light/20 text-overlay-text transition-colors min-h-11 min-w-11\"\r\n        aria-label=\"Close preview\"\r\n      >\r\n        <X className=\"size-6\" weight=\"bold\" />\r\n      </button>\r\n      <img\r\n        src={image.url}\r\n        alt=\"Product preview\"\r\n        className=\"max-w-full max-h-dialog object-contain rounded-lg\"\r\n        onClick={(e) => e.stopPropagation()}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\ui\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\ui\\payout-required-modal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | undefined`.","line":45,"column":25,"nodeType":"LogicalExpression","messageId":"unsafeArgument","endLine":45,"endColumn":67},{"ruleId":"unicorn/prefer-optional-catch-binding","severity":1,"message":"Remove unused catch binding `err`.","line":55,"column":14,"nodeType":"Identifier","messageId":"with-name","endLine":55,"endColumn":17,"fix":{"range":[1691,1697],"text":""}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":55,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":55,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { useLocale } from \"next-intl\";\r\nimport { Wallet, ShieldCheck, Zap, ArrowRight, Loader2 } from \"lucide-react\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogDescription,\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\ninterface PayoutRequiredModalProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n}\r\n\r\n/**\r\n * Modal shown when user tries to publish but hasn't completed Stripe payout setup.\r\n * Links to /api/connect/onboarding which redirects to Stripe, then back to /sell\r\n */\r\nexport function PayoutRequiredModal({ open, onOpenChange }: PayoutRequiredModalProps) {\r\n  const locale = useLocale();\r\n  const isBg = locale === \"bg\";\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const handleSetupPayments = async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const response = await fetch(\"/api/connect/onboarding\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"x-next-intl-locale\": locale,\r\n          \"x-return-to-sell\": \"true\", // Custom header to indicate return to /sell\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json().catch(() => ({}));\r\n        throw new Error(errorData.error || \"Failed to start setup\");\r\n      }\r\n\r\n      const data = await response.json();\r\n      if (!data?.url) {\r\n        throw new Error(\"No redirect URL received\");\r\n      }\r\n\r\n      // Redirect to Stripe - they'll return to /sell?payout=complete\r\n      window.location.href = data.url;\r\n    } catch (err) {\r\n      setError(\r\n        isBg\r\n          ? \"╨ô╤Ç╨╡╤ê╨║╨░ ╨┐╤Ç╨╕ ╤ü╤é╨░╤Ç╤é╨╕╤Ç╨░╨╜╨╡ ╨╜╨░ ╨╜╨░╤ü╤é╤Ç╨╛╨╣╨║╨░╤é╨░. ╨₧╨┐╨╕╤é╨░╨╣╤é╨╡ ╨╛╤é╨╜╨╛╨▓╨╛.\"\r\n          : \"Error starting setup. Please try again.\"\r\n      );\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={onOpenChange}>\r\n      <DialogContent className=\"sm:max-w-md\">\r\n        <DialogHeader className=\"text-center sm:text-center\">\r\n          {/* Icon */}\r\n          <div className=\"mx-auto mb-4 size-16 rounded-2xl bg-primary flex items-center justify-center\">\r\n            <Wallet className=\"size-8 text-primary-foreground\" strokeWidth={2} />\r\n          </div>\r\n\r\n          <DialogTitle className=\"text-xl font-bold\">\r\n            {isBg ? \"╨¥╨░╤ü╤é╤Ç╨╛╨╣╤é╨╡ ╨┐╨╗╨░╤ë╨░╨╜╨╕╤Å╤é╨░\" : \"Set Up Payments\"}\r\n          </DialogTitle>\r\n          <DialogDescription className=\"text-muted-foreground\">\r\n            {isBg\r\n              ? \"╨í╨▓╤è╤Ç╨╢╨╡╤é╨╡ ╨▒╨░╨╜╨║╨╛╨▓╨░╤é╨░ ╤ü╨╕ ╤ü╨╝╨╡╤é╨║╨░, ╨╖╨░ ╨┤╨░ ╨┐╨╛╨╗╤â╤ç╨░╨▓╨░╤é╨╡ ╨┐╨╗╨░╤ë╨░╨╜╨╕╤Å ╨╛╤é ╨║╤â╨┐╤â╨▓╨░╤ç╨╕╤é╨╡.\"\r\n              : \"Connect your bank account to receive payments from buyers.\"}\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        {/* Benefits */}\r\n        <div className=\"space-y-3 py-4\">\r\n          <div className=\"flex items-start gap-3\">\r\n            <div className=\"size-8 rounded-lg bg-selected flex items-center justify-center shrink-0\">\r\n              <ShieldCheck className=\"size-4 text-primary\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-sm font-medium text-foreground\">\r\n                {isBg ? \"╨í╨╕╨│╤â╤Ç╨╜╨╕ ╨┐╨╗╨░╤ë╨░╨╜╨╕╤Å\" : \"Secure payments\"}\r\n              </p>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                {isBg\r\n                  ? \"╨₧╨▒╤Ç╨░╨▒╨╛╤é╨╡╨╜╨╕ ╨╛╤é Stripe, ╤ü╨▓╨╡╤é╨╛╨▓╨╡╨╜ ╨╗╨╕╨┤╨╡╤Ç\"\r\n                  : \"Processed by Stripe, a global leader\"}\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <div className=\"flex items-start gap-3\">\r\n            <div className=\"size-8 rounded-lg bg-selected flex items-center justify-center shrink-0\">\r\n              <Zap className=\"size-4 text-primary\" />\r\n            </div>\r\n            <div>\r\n              <p className=\"text-sm font-medium text-foreground\">\r\n                {isBg ? \"╨æ╤è╤Ç╨╖╨╕ ╨┐╤Ç╨╡╨▓╨╛╨┤╨╕\" : \"Fast transfers\"}\r\n              </p>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                {isBg\r\n                  ? \"╨ƒ╨╛╨╗╤â╤ç╨░╨▓╨░╨╣╤é╨╡ ╨┐╨░╤Ç╨╕╤é╨╡ ╤ü╨╕ ╨╖╨░ ╨┤╨╜╨╕, ╨╜╨╡ ╤ü╨╡╨┤╨╝╨╕╤å╨╕\"\r\n                  : \"Get your money in days, not weeks\"}\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Error */}\r\n        {error && (\r\n          <div className=\"p-3 rounded-lg bg-destructive-subtle text-destructive text-sm\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        {/* CTA */}\r\n        <div className=\"flex flex-col gap-2 pt-2\">\r\n          <Button\r\n            onClick={handleSetupPayments}\r\n            disabled={loading}\r\n            size=\"lg\"\r\n            className=\"w-full\"\r\n          >\r\n            {loading ? (\r\n              <Loader2 className=\"size-5 mr-2 animate-spin\" />\r\n            ) : (\r\n              <Wallet className=\"size-5 mr-2\" />\r\n            )}\r\n            {isBg ? \"╨¥╨░╤ü╤é╤Ç╨╛╨╣╨▓╨░╨╜╨╡ ╨╜╨░ ╨┐╨╗╨░╤ë╨░╨╜╨╕╤Å\" : \"Set Up Payments\"}\r\n            <ArrowRight className=\"size-5 ml-2\" />\r\n          </Button>\r\n          <Button\r\n            variant=\"ghost\"\r\n            onClick={() => onOpenChange(false)}\r\n            disabled={loading}\r\n            className=\"w-full\"\r\n          >\r\n            {isBg ? \"╨ƒ╨╛-╨║╤è╤ü╨╜╨╛\" : \"Later\"}\r\n          </Button>\r\n        </div>\r\n\r\n        {/* Note */}\r\n        <p className=\"text-xs text-center text-muted-foreground\">\r\n          {isBg\r\n            ? \"╨Æ╨░╤ê╨░╤é╨░ ╨╛╨▒╤Å╨▓╨░ ╨╡ ╨╖╨░╨┐╨░╨╖╨╡╨╜╨░ ╨║╨░╤é╨╛ ╤ç╨╡╤Ç╨╜╨╛╨▓╨░. ╨£╨╛╨╢╨╡╤é╨╡ ╨┤╨░ ╤Å ╨┐╤â╨▒╨╗╨╕╨║╤â╨▓╨░╤é╨╡ ╤ü╨╗╨╡╨┤ ╨╜╨░╤ü╤é╤Ç╨╛╨╣╨║╨░╤é╨░.\"\r\n            : \"Your listing is saved as a draft. You can publish it after setup.\"}\r\n        </p>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\ui\\photo-thumbnail.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DotsSixVertical' is defined but never used.","line":6,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":18,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"DotsSixVertical"},"fix":{"range":[67,87],"text":""},"desc":"Remove unused variable \"DotsSixVertical\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport Image from \"next/image\";\r\nimport {\r\n  Trash,\r\n  DotsSixVertical,\r\n  Star,\r\n  MagnifyingGlassPlus,\r\n} from \"@phosphor-icons/react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport type { ProductImage } from \"@/lib/sell/schema-v4\";\r\n\r\ninterface PhotoThumbnailProps {\r\n  image: ProductImage;\r\n  index: number;\r\n  isCover: boolean;\r\n  onRemove: () => void;\r\n  onSetCover: () => void;\r\n  onPreview: () => void;\r\n  isDragging: boolean;\r\n  onDragStart: () => void;\r\n  onDragOver: (e: React.DragEvent) => void;\r\n  onDragEnd: () => void;\r\n}\r\n\r\n/**\r\n * PhotoThumbnail - Draggable photo thumbnail with actions\r\n * \r\n * Displays a product image with:\r\n * - Cover badge for primary image\r\n * - Position number\r\n * - Hover overlay with preview/delete buttons\r\n * - Drag handle for reordering\r\n */\r\nexport function PhotoThumbnail({\r\n  image,\r\n  index,\r\n  isCover,\r\n  onRemove,\r\n  onSetCover,\r\n  onPreview,\r\n  isDragging,\r\n  onDragStart,\r\n  onDragOver,\r\n  onDragEnd,\r\n}: PhotoThumbnailProps) {\r\n  return (\r\n    <div\r\n      draggable\r\n      onDragStart={onDragStart}\r\n      onDragOver={onDragOver}\r\n      onDragEnd={onDragEnd}\r\n      className={cn(\r\n        \"group relative aspect-square overflow-hidden rounded-md border bg-muted transition-colors\",\r\n        isDragging \r\n          ? \"border-selected-border border-dashed opacity-50 scale-95\" \r\n          : \"border-border/40 hover:border-hover-border\",\r\n        \"cursor-grab active:cursor-grabbing touch-manipulation\"\r\n      )}\r\n    >\r\n      <Image\r\n        src={image.thumbnailUrl || image.url}\r\n        alt={`Product image ${index + 1}`}\r\n        fill\r\n        className=\"object-cover\"\r\n        sizes=\"(max-width: 640px) 25vw, 150px\"\r\n      />\r\n\r\n      {/* Cover Badge - Top left */}\r\n      {isCover && (\r\n        <div className=\"absolute top-1.5 left-1.5 z-10\">\r\n          <Badge variant=\"secondary\" className=\"px-1.5 py-0 gap-1 font-bold text-2xs uppercase tracking-wider bg-background/90 backdrop-blur-xs text-primary border-none shadow-sm h-5\">\r\n            <Star className=\"size-2\" weight=\"fill\" />\r\n            Cover\r\n          </Badge>\r\n        </div>\r\n      )}\r\n\r\n      {/* Delete Button - Top right, always visible on mobile for better UX */}\r\n      <button\r\n        type=\"button\"\r\n        onClick={(e) => { e.stopPropagation(); onRemove(); }}\r\n        className=\"absolute top-1.5 right-1.5 z-10 p-1 rounded-full bg-background/90 backdrop-blur-xs text-destructive shadow-sm hover:bg-destructive hover:text-destructive-foreground transition-colors\"\r\n        title=\"Remove\"\r\n      >\r\n        <Trash className=\"size-3\" weight=\"bold\" />\r\n      </button>\r\n\r\n      {/* Position Number - Bottom left */}\r\n      <div className=\"absolute bottom-1.5 left-1.5 bg-surface-overlay backdrop-blur-xs text-overlay-text text-2xs font-bold px-1 py-0.5 rounded-md\">\r\n        {index + 1}\r\n      </div>\r\n\r\n      {/* Hover Overlay - Desktop only */}\r\n      <div className=\"absolute inset-0 bg-transparent group-hover:bg-surface-overlay transition-colors hidden sm:block\">\r\n        <div className=\"absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={(e) => { e.stopPropagation(); onPreview(); }}\r\n            className=\"p-2 rounded-full bg-background/95 text-foreground shadow-sm\"\r\n          >\r\n            <MagnifyingGlassPlus className=\"size-4\" />\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Set as Cover Button - Bottom right (if not cover) */}\r\n      {!isCover && (\r\n        <button\r\n          type=\"button\"\r\n          onClick={(e) => { e.stopPropagation(); onSetCover(); }}\r\n          className=\"absolute bottom-1.5 right-1.5 z-10 p-1 rounded-full bg-background/90 backdrop-blur-xs text-primary shadow-sm hover:bg-primary hover:text-primary-foreground transition-colors sm:opacity-0 sm:group-hover:opacity-100\"\r\n          title=\"Set as cover\"\r\n        >\r\n          <Star className=\"size-3\" />\r\n        </button>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\ui\\progress-header.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_locale' is defined but never used.","line":37,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Spinner, CloudCheck, FloppyDisk, CaretLeft, House } from \"@phosphor-icons/react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Progress } from \"@/components/ui/progress\";\r\nimport { PageContainer } from \"@/components/shared/page-container\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { Link } from \"@/i18n/routing\";\r\nimport { useTranslations } from \"next-intl\";\r\n\r\ninterface ProgressHeaderProps {\r\n  progressPercent: number;\r\n  autoSaved: boolean;\r\n  isSaving: boolean;\r\n  hasUnsavedChanges: boolean;\r\n  onSaveDraft: () => void;\r\n  locale: string;\r\n  currentStep: number;\r\n  totalSteps: number;\r\n}\r\n\r\n/**\r\n * ProgressHeader - Sticky header showing form progress and save status\r\n * \r\n * Displays:\r\n * - Back/Home link\r\n * - Progress bar (desktop) or step dots (mobile)\r\n * - Save status indicator\r\n * - Manual save button\r\n */\r\nexport function ProgressHeader({\r\n  progressPercent,\r\n  autoSaved,\r\n  isSaving,\r\n  hasUnsavedChanges,\r\n  onSaveDraft,\r\n  locale: _locale,\r\n  currentStep,\r\n  totalSteps,\r\n}: ProgressHeaderProps) {\r\n  const isComplete = progressPercent === 100;\r\n  const tSell = useTranslations(\"Sell\")\r\n  const tNav = useTranslations(\"Navigation\")\r\n  const tCommon = useTranslations(\"Common\")\r\n\r\n  return (\r\n    <header className=\"sticky top-0 z-40 bg-background border-b border-border/60\">\r\n      <PageContainer size=\"wide\">\r\n        {/* Top bar with logo and actions */}\r\n        <div className=\"flex items-center justify-between h-14 gap-4\">\r\n          {/* Left: Back/Logo */}\r\n          <Link\r\n            href=\"/\"\r\n            className=\"flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors group\"\r\n          >\r\n            <CaretLeft className=\"size-4\" weight=\"bold\" />\r\n            <House className=\"size-5\" />\r\n            <span className=\"hidden sm:inline text-sm font-medium\">\r\n              {tNav(\"home\")}\r\n            </span>\r\n          </Link>\r\n\r\n          {/* Center: Progress indicator (Desktop) */}\r\n          <div className=\"flex-1 max-w-md mx-4 hidden sm:block\">\r\n            <div className=\"flex items-center gap-4\">\r\n                <Progress\r\n                  value={progressPercent}\r\n                  className=\"h-1.5 flex-1\"\r\n                  aria-label={tSell(\"progressHeader.formProgressAriaLabel\", { percent: progressPercent })}\r\n                />\r\n              <span className={cn(\r\n                \"text-sm font-semibold tabular-nums min-w-10 text-right\",\r\n                isComplete ? \"text-primary\" : \"text-muted-foreground\"\r\n              )}>\r\n                {progressPercent}%\r\n              </span>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Center: Step indicator (Mobile) */}\r\n          <div className=\"sm:hidden flex-1 flex justify-center\">\r\n            <div className=\"flex items-center gap-1.5\">\r\n              {Array.from({ length: totalSteps }).map((_, i) => (\r\n                <div\r\n                  key={i}\r\n                  className={cn(\r\n                    \"h-1 rounded-full transition-all duration-300\",\r\n                    i + 1 === currentStep ? \"w-6 bg-primary\" : \"w-2 bg-hover\"\r\n                  )}\r\n                />\r\n              ))}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Right: Save status + Actions */}\r\n          <div className=\"flex items-center gap-2\">\r\n            {/* Save status indicator */}\r\n            <div className={cn(\r\n              \"flex items-center gap-1.5 text-xs transition-opacity\",\r\n              (autoSaved || isSaving) ? \"opacity-100\" : \"opacity-0\"\r\n            )}>\r\n              {isSaving ? (\r\n                <>\r\n                  <Spinner className=\"size-3.5 animate-spin text-muted-foreground\" />\r\n                  <span className=\"text-muted-foreground hidden sm:inline\">\r\n                    {tCommon(\"saving\")}\r\n                  </span>\r\n                </>\r\n              ) : autoSaved ? (\r\n                <>\r\n                  <CloudCheck className=\"size-3.5 text-primary\" />\r\n                  <span className=\"text-primary hidden sm:inline\">\r\n                    {tCommon(\"saved\")}\r\n                  </span>\r\n                </>\r\n              ) : null}\r\n            </div>\r\n\r\n            {/* Manual save button */}\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={onSaveDraft}\r\n              className=\"h-9 px-3 gap-2 text-muted-foreground hover:text-foreground\"\r\n              disabled={!hasUnsavedChanges}\r\n            >\r\n              <FloppyDisk className=\"size-4\" />\r\n              <span className=\"hidden sm:inline\">\r\n                {tCommon(\"save\")}\r\n              </span>\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Mobile progress bar (Bottom of header) */}\r\n        <div className=\"sm:hidden pb-2\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <Progress value={progressPercent} className=\"h-1 flex-1\" />\r\n            <span className={cn(\r\n              \"text-sm font-semibold tabular-nums\",\r\n              isComplete ? \"text-primary\" : \"text-muted-foreground\"\r\n            )}>\r\n              {progressPercent}%\r\n            </span>\r\n          </div>\r\n        </div>\r\n      </PageContainer>\r\n    </header>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\ui\\select-drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\ui\\sell-error-boundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\ui\\sell-section-skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_components\\ui\\upload-zone.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_locale' is assigned a value but never used.","line":32,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Camera, Plus, SpinnerGap } from \"@phosphor-icons/react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { useTranslations } from \"next-intl\";\r\n\r\ninterface UploadZoneProps {\r\n  isUploading: boolean;\r\n  isDragActive: boolean;\r\n  getRootProps: () => Record<string, unknown>;\r\n  getInputProps: () => Record<string, unknown>;\r\n  currentCount: number;\r\n  maxCount: number;\r\n  locale?: \"en\" | \"bg\";\r\n}\r\n\r\n/**\r\n * UploadZone - Premium drop zone for uploading product photos\r\n * \r\n * Displays a drag & drop area with:\r\n * - Visual feedback for drag state\r\n * - Loading spinner when uploading\r\n * - Count of remaining photos allowed\r\n */\r\nexport function UploadZone({\r\n  isUploading,\r\n  isDragActive,\r\n  getRootProps,\r\n  getInputProps,\r\n  currentCount,\r\n  maxCount,\r\n  locale: _locale = \"en\",\r\n}: UploadZoneProps) {\r\n  const remaining = maxCount - currentCount;\r\n  const t = useTranslations(\"Sell\")\r\n  \r\n  return (\r\n    <div\r\n      {...getRootProps()}\r\n      className={cn(\r\n        \"relative flex flex-col items-center justify-center rounded-2xl border-2 border-dashed transition-colors cursor-pointer\",\r\n        \"min-h-44 sm:min-h-48 touch-manipulation\",\r\n        \"hover:bg-hover active:bg-active\",\r\n        isDragActive\r\n          ? \"border-selected-border bg-selected\"\r\n          : \"border-border/60 bg-surface-subtle\",\r\n        isUploading && \"pointer-events-none opacity-70\"\r\n      )}\r\n    >\r\n      <input {...getInputProps()} />\r\n\r\n      {isUploading ? (\r\n        <div className=\"flex flex-col items-center gap-4\">\r\n          <div className=\"size-20 rounded-2xl bg-surface-subtle flex items-center justify-center\">\r\n            <SpinnerGap className=\"size-10 text-primary animate-spin\" />\r\n          </div>\r\n          <div className=\"text-center\">\r\n            <span className=\"text-base font-semibold text-foreground block\">\r\n              {t(\"uploadZone.uploading\")}\r\n            </span>\r\n          </div>\r\n        </div>\r\n      ) : (\r\n        <>\r\n          <div className=\"size-20 rounded-2xl bg-surface-subtle flex items-center justify-center mb-4\">\r\n            {isDragActive ? (\r\n              <Plus className=\"size-10 text-primary\" weight=\"bold\" />\r\n            ) : (\r\n              <Camera className=\"size-10 text-primary\" weight=\"fill\" />\r\n            )}\r\n          </div>\r\n          <div className=\"text-center space-y-1\">\r\n            <span className=\"text-lg font-bold text-foreground block\">\r\n              {isDragActive\r\n                ? t(\"uploadZone.dropHere\")\r\n                : t(\"uploadZone.tapToAddPhotos\")}\r\n            </span>\r\n            <span className=\"text-sm text-muted-foreground\">\r\n              {t(\"uploadZone.fileHint\")}\r\n            </span>\r\n          </div>\r\n          <span className=\"mt-4 text-xs font-medium text-muted-foreground\">\r\n            {remaining > 0 \r\n              ? t(\"uploadZone.remaining\", { count: remaining })\r\n              : t(\"uploadZone.maxReached\")}\r\n          </span>\r\n        </>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\_lib\\types.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CategoryAttribute' is defined but never used.","line":33,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":33,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CustomAttribute' is defined but never used.","line":50,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":50,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ProductImage' is defined but never used.","line":58,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":58,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// ============================================================================\r\n// SELL PAGE TYPES - Single Source of Truth\r\n// ============================================================================\r\n\r\n/**\r\n * Category type with recursive children support\r\n * Supports unlimited nesting levels for hierarchical categories\r\n */\r\nexport interface Category {\r\n  id: string;\r\n  name: string;\r\n  name_bg?: string | null;\r\n  slug: string;\r\n  parent_id: string | null;\r\n  display_order?: number | null;\r\n  children?: Category[]; // Optional to support both flat and nested structures\r\n}\r\n\r\nexport type CategoryPathItem = Pick<Category, \"id\" | \"name\" | \"name_bg\" | \"slug\">;\r\n\r\n/**\r\n * Seller/Store information\r\n */\r\nexport interface Seller {\r\n  id: string;\r\n  store_name: string;\r\n  store_slug?: string;\r\n}\r\n\r\n/**\r\n * Category-specific attribute definition\r\n */\r\ninterface CategoryAttribute {\r\n  id: string;\r\n  category_id: string;\r\n  name: string;\r\n  name_bg: string | null;\r\n  attribute_type: 'text' | 'number' | 'select' | 'multiselect' | 'boolean' | 'date';\r\n  is_required: boolean;\r\n  options: string[];\r\n  options_bg: string[];\r\n  placeholder: string | null;\r\n  placeholder_bg: string | null;\r\n  sort_order: number;\r\n}\r\n\r\n/**\r\n * Custom attribute key-value pair\r\n */\r\ninterface CustomAttribute {\r\n  name: string;\r\n  value: string;\r\n}\r\n\r\n/**\r\n * Product image with positioning\r\n */\r\ninterface ProductImage {\r\n  url: string;\r\n  thumbnailUrl?: string;\r\n  position: number;\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\sell\\_lib\\categories.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\sell\\client.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isPayoutReady' is defined but never used.","line":27,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":27,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'t' is assigned a value but never used.","line":52,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":52,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { Link } from \"@/i18n/routing\";\r\nimport { createClient } from \"@/lib/supabase/client\";\r\nimport { useLocale, useTranslations } from \"next-intl\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { ProgressHeader } from \"../_components/ui\";\r\nimport {\r\n  SignInPrompt,\r\n  SellFormSkeleton,\r\n  SellErrorBoundary,\r\n  UnifiedSellForm,\r\n  type Category,\r\n  type Seller\r\n} from \"../_components\";\r\n\r\nexport type SellerPayoutStatus = {\r\n  stripe_connect_account_id: string | null;\r\n  details_submitted: boolean;\r\n  charges_enabled: boolean;\r\n  payouts_enabled: boolean;\r\n} | null;\r\n\r\ntype CreateListingAction = Parameters<typeof UnifiedSellForm>[0][\"createListingAction\"]\r\n\r\nfunction isPayoutReady(payoutStatus: SellerPayoutStatus): boolean {\r\n  return Boolean(\r\n    payoutStatus?.details_submitted && payoutStatus?.charges_enabled && payoutStatus?.payouts_enabled\r\n  );\r\n}\r\n\r\ninterface SellPageClientProps {\r\n  initialUser: { id: string; email?: string } | null;\r\n  initialSeller: Seller | null;\r\n  initialNeedsOnboarding?: boolean;\r\n  initialUsername?: string | null;\r\n  initialPayoutStatus?: SellerPayoutStatus;\r\n  categories: Category[];\r\n  createListingAction: CreateListingAction;\r\n}\r\n\r\nexport function SellPageClient({\r\n  initialUser,\r\n  initialSeller,\r\n  initialNeedsOnboarding = false,\r\n  initialUsername = null,\r\n  initialPayoutStatus,\r\n  categories, // Pre-fetched from server\r\n  createListingAction,\r\n}: SellPageClientProps) {\r\n  const t = useTranslations(\"Sell\");\r\n  const locale = useLocale();\r\n  const safeLocale = locale === \"bg\" ? \"bg\" : \"en\";\r\n  const [user, setUser] = useState(initialUser);\r\n  const [seller, setSeller] = useState(initialSeller);\r\n  const [isAuthChecking, setIsAuthChecking] = useState(!initialUser);\r\n  const [needsOnboarding, setNeedsOnboarding] = useState(initialNeedsOnboarding);\r\n  const [username, setUsername] = useState<string | null>(initialUsername);\r\n  const [payoutStatus, setPayoutStatus] = useState<SellerPayoutStatus>(initialPayoutStatus ?? null);\r\n  const isBg = safeLocale === \"bg\";\r\n\r\n  // Listen for auth state changes (for client-side navigation)\r\n  useEffect(() => {\r\n    // If we already have initial user from server, skip auth check\r\n    if (initialUser) {\r\n      setIsAuthChecking(false);\r\n      return;\r\n    }\r\n\r\n    const supabase = createClient();\r\n\r\n    const { data: { subscription } } = supabase.auth.onAuthStateChange(async (_event: string, session: { user?: { id: string; email?: string } } | null) => {\r\n      const currentUser = session?.user ?? null;\r\n      setUser(\r\n        currentUser\r\n          ? {\r\n            id: currentUser.id,\r\n            ...(currentUser.email ? { email: currentUser.email } : {}),\r\n          }\r\n          : null\r\n      );\r\n\r\n      if (currentUser && !seller) {\r\n        // Check if user has a profile with username and is_seller status\r\n        const { data: profileData } = await supabase\r\n          .from(\"profiles\")\r\n          .select(\"id, username, display_name, business_name, is_seller, account_type\")\r\n          .eq(\"id\", currentUser.id)\r\n          .single();\r\n\r\n        const { data: payoutData } = await supabase\r\n          .from(\"seller_payout_status\")\r\n          .select(\"stripe_connect_account_id, details_submitted, charges_enabled, payouts_enabled\")\r\n          .eq(\"seller_id\", currentUser.id)\r\n          .maybeSingle();\r\n\r\n        setPayoutStatus(payoutData ?? null);\r\n\r\n        if (profileData?.username) {\r\n          setUsername(profileData.username);\r\n\r\n          // Check if user needs onboarding (has username but is_seller is false)\r\n          if (!profileData.is_seller) {\r\n            setNeedsOnboarding(true);\r\n          } else {\r\n            setSeller({\r\n              id: profileData.id,\r\n              store_name: profileData.display_name || profileData.business_name || profileData.username || \"Store\",\r\n            });\r\n          }\r\n        }\r\n      } else if (!currentUser) {\r\n        setSeller(null);\r\n        setNeedsOnboarding(false);\r\n        setPayoutStatus(null);\r\n      }\r\n\r\n      setIsAuthChecking(false);\r\n    });\r\n\r\n    // Fallback timeout\r\n    const timeout = setTimeout(() => {\r\n      setIsAuthChecking(false);\r\n    }, 2000);\r\n\r\n    return () => {\r\n      subscription.unsubscribe();\r\n      clearTimeout(timeout);\r\n    };\r\n  }, [initialUser, seller]);\r\n\r\n  // Loading state while checking auth - but show SignInPrompt immediately for guests\r\n  if (isAuthChecking && initialUser) {\r\n    return <SellFormSkeleton />;\r\n  }\r\n\r\n  // Not logged in - show sign in prompt (render immediately for guests)\r\n  if (!user || (!initialUser && isAuthChecking)) {\r\n    return (\r\n      <div className=\"flex flex-1 flex-col\">\r\n        <ProgressHeader\r\n          progressPercent={0}\r\n          autoSaved={false}\r\n          isSaving={false}\r\n          hasUnsavedChanges={false}\r\n          onSaveDraft={() => {}}\r\n          locale={safeLocale}\r\n          currentStep={1}\r\n          totalSteps={4}\r\n        />\r\n        <div className=\"flex-1 flex flex-col justify-center overflow-y-auto\">\r\n          <SignInPrompt />\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // First-time seller onboarding\r\n  // User has username but hasn't set up their seller profile yet (is_seller = false)\r\n  // Redirect to home page where post-signup modal will handle onboarding\r\n  if (needsOnboarding && user && username) {\r\n    return (\r\n      <div className=\"flex flex-1 flex-col\">\r\n        <ProgressHeader\r\n          progressPercent={0}\r\n          autoSaved={false}\r\n          isSaving={false}\r\n          hasUnsavedChanges={false}\r\n          onSaveDraft={() => {}}\r\n          locale={safeLocale}\r\n          currentStep={1}\r\n          totalSteps={4}\r\n        />\r\n        <div className=\"flex-1 flex flex-col items-center justify-center overflow-y-auto py-8 px-4 text-center\">\r\n          <div className=\"max-w-md space-y-4\">\r\n            <h2 className=\"text-2xl font-bold text-foreground\">\r\n              {isBg ? \"╨ù╨░╨▓╤è╤Ç╤ê╨╡╤é╨╡ ╨╜╨░╤ü╤é╤Ç╨╛╨╣╨║╨░╤é╨░ ╨╜╨░ ╨░╨║╨░╤â╨╜╤é╨░\" : \"Complete Your Account Setup\"}\r\n            </h2>\r\n            <p className=\"text-muted-foreground\">\r\n              {isBg\r\n                ? \"╨£╨╛╨╗╤Å, ╨╖╨░╨▓╤è╤Ç╤ê╨╡╤é╨╡ ╨╜╨░╤ü╤é╤Ç╨╛╨╣╨║╨░╤é╨░ ╨╜╨░ ╨▓╨░╤ê╨╕╤Å ╨┐╤Ç╨╛╤ä╨╕╨╗, ╨┐╤Ç╨╡╨┤╨╕ ╨┤╨░ ╨╖╨░╨┐╨╛╤ç╨╜╨╡╤é╨╡ ╨┤╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤é╨╡.\"\r\n                : \"Please complete your profile setup before you can start selling.\"}\r\n            </p>\r\n            <Button asChild size=\"lg\" className=\"w-full\">\r\n              <Link href=\"/?onboarding=true\">\r\n                {isBg ? \"╨ù╨░╨▓╤è╤Ç╤ê╨╡╤é╨╡ ╨╜╨░╤ü╤é╤Ç╨╛╨╣╨║╨░╤é╨░\" : \"Complete Setup\"}\r\n              </Link>\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // No username yet - need to set one up (legacy users only)\r\n  // New users get username at signup, so this shouldn't happen\r\n  if (!seller) {\r\n    return (\r\n      <div className=\"flex flex-1 flex-col\">\r\n        <ProgressHeader\r\n          progressPercent={0}\r\n          autoSaved={false}\r\n          isSaving={false}\r\n          hasUnsavedChanges={false}\r\n          onSaveDraft={() => {}}\r\n          locale={safeLocale}\r\n          currentStep={1}\r\n          totalSteps={4}\r\n        />\r\n        <div className=\"flex-1 flex flex-col justify-center overflow-y-auto py-8\">\r\n          <div className=\"container-narrow text-center space-y-4\">\r\n            <h2 className=\"text-2xl font-bold\">\r\n              {isBg ? \"╨¥╨░╤ü╤é╤Ç╨╛╨╣╤é╨╡ ╨┐╨╛╤é╤Ç╨╡╨▒╨╕╤é╨╡╨╗╤ü╨║╨╛ ╨╕╨╝╨╡\" : \"Set Up Your Username\"}\r\n            </h2>\r\n            <p className=\"text-muted-foreground\">\r\n              {isBg\r\n                ? \"╨¥╤â╨╢╨╜╨╛ ╨▓╨╕ ╨╡ ╨┐╨╛╤é╤Ç╨╡╨▒╨╕╤é╨╡╨╗╤ü╨║╨╛ ╨╕╨╝╨╡, ╨┐╤Ç╨╡╨┤╨╕ ╨┤╨░ ╨╖╨░╨┐╨╛╤ç╨╜╨╡╤é╨╡ ╨┤╨░ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤é╨╡.\"\r\n                : \"You need a username before you can start selling. Visit your account settings to set one up.\"}\r\n            </p>\r\n            <Button asChild>\r\n              <Link href=\"/account/profile\">{isBg ? \"╨¥╨░╤ü╤é╤Ç╨╛╨╣╨║╨╕\" : \"Go to Settings\"}</Link>\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // =========================================================================\r\n  // MAIN CONTENT: Sell Form\r\n  // Payout status is checked at publish time, not at form entry\r\n  // =========================================================================\r\n\r\n  return (\r\n    <SellErrorBoundary sellerId={seller.id}>\r\n      {/* UnifiedSellForm handles both desktop and mobile layouts */}\r\n      <UnifiedSellForm\r\n        sellerId={seller.id}\r\n        locale={safeLocale}\r\n        categories={categories}\r\n        createListingAction={createListingAction}\r\n        payoutStatus={payoutStatus}\r\n      />\r\n    </SellErrorBoundary>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\sell\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\sell\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\sell\\orders\\_components\\order-status-actions.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_orderId' is defined but never used.","line":56,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":56,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_sellerId' is defined but never used.","line":57,"column":13,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useState, useTransition } from \"react\"\nimport { useTranslations } from \"next-intl\"\nimport { Button } from \"@/components/ui/button\"\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\"\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\"\nimport { Input } from \"@/components/ui/input\"\nimport { Label } from \"@/components/ui/label\"\nimport { Loader2, Package, Truck, CheckCircle, XCircle, MessageSquare } from \"lucide-react\"\nimport {\n  canSellerUpdateStatus,\n  SHIPPING_CARRIER_VALUES,\n  type OrderItemStatus, \n  type ShippingCarrier \n} from \"@/lib/order-status\"\nimport { ORDER_STATUS_CONFIG } from \"@/components/shared/orders/order-status-config\"\nimport { toast } from \"sonner\"\nimport { Link, useRouter } from \"@/i18n/routing\"\n\r\nexport type OrderStatusActionsServerActions = {\r\n  updateOrderItemStatus: (\r\n    orderItemId: string,\r\n    newStatus: OrderItemStatus,\r\n    trackingNumber?: string,\r\n    shippingCarrier?: ShippingCarrier\r\n  ) => Promise<{ success: boolean; error?: string }>\r\n}\r\n\r\ninterface OrderStatusActionsProps {\r\n  orderItemId: string\n  currentStatus: OrderItemStatus\n  orderId: string\n  sellerId: string\n  isSeller?: boolean\n  conversationId?: string | null\n  actions: OrderStatusActionsServerActions\n}\n\nexport function OrderStatusActions({\n  orderItemId,\n  currentStatus,\n  orderId: _orderId,\n  sellerId: _sellerId,\n  isSeller = true,\n  conversationId,\n  actions,\n}: OrderStatusActionsProps) {\n  const tOrders = useTranslations(\"Orders\")\n  const tCommon = useTranslations(\"Common\")\n  const router = useRouter()\n  const [isPending, startTransition] = useTransition()\n  const [showShippingDialog, setShowShippingDialog] = useState(false)\n  const [trackingNumber, setTrackingNumber] = useState('')\n  const [shippingCarrier, setShippingCarrier] = useState<ShippingCarrier | ''>()\n\n  const config = ORDER_STATUS_CONFIG[currentStatus]\n  const canUpdate = isSeller && canSellerUpdateStatus(currentStatus)\n  const nextStatus = config.nextStatus\n\n  async function handleStatusUpdate(newStatus: OrderItemStatus) {\n    // If shipping, show dialog for tracking info\n    if (newStatus === 'shipped') {\n      setShowShippingDialog(true)\n      return\n    }\n\n    startTransition(async () => {\n      try {\n        const result = await actions.updateOrderItemStatus(orderItemId, newStatus)\n        if (result.success) {\n          const statusLabel = tOrders(ORDER_STATUS_CONFIG[newStatus].labelKey)\n          toast.success(tOrders(\"toasts.orderMarkedAs\", { status: statusLabel }))\n          router.refresh()\n        } else {\n          toast.error(result.error || tOrders(\"errors.failedToUpdateStatus\"))\n        }\n      } catch {\n        toast.error(tOrders(\"errors.unexpectedError\"))\n      }\n    })\n  }\n\r\n  async function handleShippingSubmit() {\r\n    startTransition(async () => {\r\n      try {\r\n        const result = await actions.updateOrderItemStatus(\r\n          orderItemId, \r\n          'shipped',\r\n          trackingNumber || undefined,\r\n          shippingCarrier as ShippingCarrier || undefined\r\n        )\r\n        if (result.success) {\n          toast.success(tOrders(\"toasts.orderMarkedAsShipped\"))\n          setShowShippingDialog(false)\n          router.refresh()\n        } else {\n          toast.error(result.error || tOrders(\"errors.failedToUpdateStatus\"))\n        }\n      } catch {\n        toast.error(tOrders(\"errors.unexpectedError\"))\n      }\n    })\n  }\n\r\n  const getActionIcon = (status: OrderItemStatus) => {\r\n    switch (status) {\r\n      case 'received': return <CheckCircle className=\"h-4 w-4\" />\r\n      case 'processing': return <Package className=\"h-4 w-4\" />\r\n      case 'shipped': return <Truck className=\"h-4 w-4\" />\r\n      case 'delivered': return <CheckCircle className=\"h-4 w-4\" />\r\n      case 'cancelled': return <XCircle className=\"h-4 w-4\" />\r\n      default: return null\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex flex-wrap items-center gap-2\">\r\n      {/* Chat Link */}\r\n      {conversationId && (\n        <Button variant=\"outline\" size=\"sm\" asChild>\n          <Link href={`/chat/${conversationId}`}>\n            <MessageSquare className=\"h-4 w-4 mr-1.5\" />\n            {tOrders(\"actions.chat\")}\n          </Link>\n        </Button>\n      )}\n\n      {/* Status Actions */}\n      {canUpdate && nextStatus && (\n        <Button\n          size=\"sm\"\n          onClick={() => handleStatusUpdate(nextStatus)}\n          disabled={isPending}\n        >\n          {isPending ? (\n            <Loader2 className=\"h-4 w-4 mr-1.5 animate-spin\" />\n          ) : (\n            getActionIcon(nextStatus)\n          )}\n          {isPending ? tOrders(\"actions.updating\") : config.nextActionKey ? tOrders(config.nextActionKey) : null}\n        </Button>\n      )}\n\n      {/* Cancel Option */}\n      {canUpdate && currentStatus !== 'cancelled' && (\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          className=\"text-status-error hover:bg-status-error/10\"\n          onClick={() => handleStatusUpdate('cancelled')}\n          disabled={isPending}\n        >\n          <XCircle className=\"h-4 w-4 mr-1.5\" />\n          {tCommon(\"cancel\")}\n        </Button>\n      )}\n\n      {/* Shipping Dialog */}\n      <Dialog open={showShippingDialog} onOpenChange={setShowShippingDialog}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>{tOrders(\"actions.shipOrder\")}</DialogTitle>\n            <DialogDescription>\n              {tOrders(\"shipping.dialogDescription\")}\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"carrier\">{tOrders(\"shipping.carrierLabel\")}</Label>\n              <Select value={shippingCarrier} onValueChange={(v) => setShippingCarrier(v as ShippingCarrier)}>\n                <SelectTrigger id=\"carrier\">\n                  <SelectValue placeholder={tOrders(\"shipping.carrierPlaceholder\")} />\n                </SelectTrigger>\n                <SelectContent>\n                  {SHIPPING_CARRIER_VALUES.map((carrier) => (\n                    <SelectItem key={carrier} value={carrier}>\n                      {tOrders(`shippingCarriers.${carrier}` as never)}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"tracking\">{tOrders(\"shipping.trackingNumberLabel\")}</Label>\n              <Input\n                id=\"tracking\"\n                placeholder={tOrders(\"shipping.trackingNumberPlaceholder\")}\n                value={trackingNumber}\n                onChange={(e) => setTrackingNumber(e.target.value)}\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button \n              variant=\"outline\" \n              onClick={() => setShowShippingDialog(false)}\n              disabled={isPending}\n            >\n              {tCommon(\"cancel\")}\n            </Button>\n            <Button onClick={handleShippingSubmit} disabled={isPending}>\n              {isPending ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-1.5 animate-spin\" />\n                  {tOrders(\"actions.shipping\")}\n                </>\n              ) : (\n                <>\n                  <Truck className=\"h-4 w-4 mr-1.5\" />\n                  {tOrders(\"actions.markAsShipped\")}\n                </>\n              )}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\sell\\orders\\_components\\seller-rate-buyer-actions.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'actions'. Either include it or remove the dependency array.","line":65,"column":6,"nodeType":"ArrayExpression","endLine":65,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [actions, isDelivered, orderItemId]","fix":{"range":[2063,2089],"text":"[actions, isDelivered, orderItemId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useTransition } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { CheckCircle, UserCheck } from \"lucide-react\"\r\nimport { type OrderItemStatus } from \"@/lib/order-status\"\r\nimport { useRouter } from \"@/i18n/routing\"\r\nimport { toast } from \"sonner\"\r\nimport { StarRatingDialog } from \"@/components/shared/star-rating-dialog\"\r\n\r\ntype SubmitBuyerFeedbackInput = {\r\n  buyer_id: string\r\n  order_id: string\r\n  rating: number\r\n  comment?: string\r\n  payment_promptness?: boolean\r\n  communication?: boolean\r\n  reasonable_expectations?: boolean\r\n}\r\n\r\nexport type SellerRateBuyerActionsServerActions = {\r\n  canSellerRateBuyer: (\r\n    orderItemId: string\r\n  ) => Promise<{ canRate: boolean; hasRated: boolean; buyerId?: string; orderId?: string }>\r\n  submitBuyerFeedback: (\r\n    input: SubmitBuyerFeedbackInput\r\n  ) => Promise<{ success: boolean; error?: string }>\r\n}\r\n\r\ninterface SellerRateBuyerActionsProps {\r\n  orderItemId: string\r\n  currentStatus: OrderItemStatus\r\n  locale?: string\r\n  actions: SellerRateBuyerActionsServerActions\r\n}\r\n\r\nexport function SellerRateBuyerActions({\r\n  orderItemId,\r\n  currentStatus,\r\n  locale = 'en',\r\n  actions,\r\n}: SellerRateBuyerActionsProps) {\r\n  const router = useRouter()\r\n  const [isPending, startTransition] = useTransition()\r\n  const [showRatingDialog, setShowRatingDialog] = useState(false)\r\n  const [canRate, setCanRate] = useState(false)\r\n  const [hasRated, setHasRated] = useState(false)\r\n  const [buyerId, setBuyerId] = useState<string | undefined>()\r\n  const [orderId, setOrderId] = useState<string | undefined>()\r\n\r\n  const isDelivered = currentStatus === 'delivered'\r\n\r\n  // Check if can rate when delivered\r\n  useEffect(() => {\r\n    async function checkRatingStatus() {\r\n      if (isDelivered) {\r\n        const result = await actions.canSellerRateBuyer(orderItemId)\r\n        setCanRate(result.canRate)\r\n        setHasRated(result.hasRated)\r\n        setBuyerId(result.buyerId)\r\n        setOrderId(result.orderId)\r\n      }\r\n    }\r\n    checkRatingStatus()\r\n  }, [isDelivered, orderItemId])\r\n\r\n  async function handleSubmitRating(rating: number, comment: string) {\r\n    if (!buyerId || !orderId) {\r\n      toast.error('Buyer or order not found')\r\n      return\r\n    }\r\n\r\n    startTransition(async () => {\r\n      try {\r\n        const result = await actions.submitBuyerFeedback({\r\n          buyer_id: buyerId,\r\n          order_id: orderId,\r\n          rating,\r\n          ...(comment ? { comment } : {}),\r\n        })\r\n        \r\n        if (result.success) {\r\n          toast.success(locale === 'bg' ? '╨æ╨╗╨░╨│╨╛╨┤╨░╤Ç╨╕╨╝ ╨╖╨░ ╨╛╤é╨╖╨╕╨▓╨░!' : 'Thank you for your feedback!')\r\n          setShowRatingDialog(false)\r\n          setHasRated(true)\r\n          router.refresh()\r\n        } else {\r\n          toast.error(result.error || 'Failed to submit rating')\r\n        }\r\n      } catch {\r\n        toast.error('An error occurred')\r\n      }\r\n    })\r\n  }\r\n\r\n  const t = {\r\n    rateBuyer: locale === 'bg' ? '╨₧╤å╨╡╨╜╨╕ ╨║╤â╨┐╤â╨▓╨░╤ç╨░' : 'Rate Buyer',\r\n    ratedBuyer: locale === 'bg' ? '╨₧╤å╨╡╨╜╨╡╨╜' : 'Rated',\r\n    ratingTitle: locale === 'bg' ? '╨Ü╨░╨║ ╨▒╨╕╤à╤é╨╡ ╨╛╤å╨╡╨╜╨╕╨╗╨╕ ╨║╤â╨┐╤â╨▓╨░╤ç╨░?' : 'How would you rate the buyer?',\r\n    ratingDescription: locale === 'bg' \r\n      ? '╨Æ╨░╤ê╨░╤é╨░ ╨╛╤å╨╡╨╜╨║╨░ ╨┐╨╛╨╝╨░╨│╨░ ╨╜╨░ ╨┤╤Ç╤â╨│╨╕ ╨┐╤Ç╨╛╨┤╨░╨▓╨░╤ç╨╕ ╨┤╨░ ╨┐╨╛╨╖╨╜╨░╨▓╨░╤é ╨║╨╗╨╕╨╡╨╜╤é╨╕╤é╨╡ ╤ü╨╕.'\r\n      : 'Your rating helps other sellers know their customers better.',\r\n    commentLabel: locale === 'bg' ? '╨Ü╨╛╨╝╨╡╨╜╤é╨░╤Ç (╨┐╨╛ ╨╕╨╖╨▒╨╛╤Ç)' : 'Comment (optional)',\r\n    commentPlaceholder: locale === 'bg' \r\n      ? '╨í╨┐╨╛╨┤╨╡╨╗╨╡╤é╨╡ ╨╛╨┐╨╕╤é╨░ ╤ü╨╕ ╤ü ╤é╨╛╨╖╨╕ ╨║╤â╨┐╤â╨▓╨░╤ç...'\r\n      : 'Share your experience with this buyer...',\r\n    submitRating: locale === 'bg' ? '╨ÿ╨╖╨┐╤Ç╨░╤é╨╕ ╨╛╤é╨╖╨╕╨▓' : 'Submit Review',\r\n    cancel: locale === 'bg' ? '╨₧╤é╨╝╨╡╨╜╨╕' : 'Cancel',\r\n  }\r\n\r\n  // Don't render if order is not delivered\r\n  if (!isDelivered) {\r\n    return null\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {/* Rate Buyer Button - only for delivered orders that haven't been rated */}\r\n      {canRate && !hasRated && (\r\n        <Button\r\n          size=\"sm\"\r\n          variant=\"outline\"\r\n          onClick={() => setShowRatingDialog(true)}\r\n          disabled={isPending}\r\n        >\r\n          <UserCheck className=\"h-4 w-4 mr-1.5\" />\r\n          {t.rateBuyer}\r\n        </Button>\r\n      )}\r\n\r\n      {/* Already Rated Badge */}\r\n      {hasRated && (\r\n        <span className=\"inline-flex items-center gap-1 text-sm text-success\">\r\n          <CheckCircle className=\"h-4 w-4\" />\r\n          {t.ratedBuyer}\r\n        </span>\r\n      )}\r\n\r\n      {/* Rating Dialog */}\r\n      <StarRatingDialog\r\n        open={showRatingDialog}\r\n        onOpenChange={setShowRatingDialog}\r\n        onSubmit={handleSubmitRating}\r\n        title={t.ratingTitle}\r\n        description={t.ratingDescription}\r\n        commentLabel={t.commentLabel}\r\n        commentPlaceholder={t.commentPlaceholder}\r\n        submitLabel={t.submitRating}\r\n        cancelLabel={t.cancel}\r\n        locale={locale}\r\n        isLoading={isPending}\r\n      />\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\sell\\orders\\client.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":142,"column":6,"nodeType":"ArrayExpression","endLine":142,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadData]","fix":{"range":[4399,4401],"text":"[loadData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useState } from \"react\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport Image from \"next/image\"\r\nimport { ArrowLeft, Package, Loader2, RefreshCw, ExternalLink } from \"lucide-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\"\r\nimport { UserAvatar } from \"@/components/shared/user-avatar\"\r\nimport { OrderStatusBadge } from \"@/components/shared/orders/order-status-badge\"\r\nimport { OrderStatusActions, type OrderStatusActionsServerActions } from \"./_components/order-status-actions\"\r\nimport { SellerRateBuyerActions, type SellerRateBuyerActionsServerActions } from \"./_components/seller-rate-buyer-actions\"\r\nimport { type OrderItemStatus } from \"@/lib/order-status\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { formatDistanceToNow } from \"date-fns\"\r\nimport { useTranslations } from \"next-intl\"\r\n\r\ntype SellerOrderItem = {\r\n  id: string\r\n  order_id: string\r\n  seller_id: string\r\n  quantity: number\r\n  price_at_purchase: number\r\n  status: OrderItemStatus\r\n  tracking_number: string | null\r\n  shipping_carrier: string | null\r\n  created_at: string\r\n  product?: {\r\n    id: string\r\n    title: string\r\n    images: string[]\r\n    slug: string\r\n  }\r\n  order?: {\r\n    id: string\r\n    user_id: string\r\n    total_amount: number\r\n    status: string\r\n    shipping_address: {\r\n      name?: string\r\n      email?: string\r\n      address?: {\r\n        line1?: string\r\n        line2?: string\r\n        city?: string\r\n        state?: string\r\n        postal_code?: string\r\n        country?: string\r\n      }\r\n    } | null\r\n    created_at: string\r\n  }\r\n  buyer?: {\r\n    id: string\r\n    full_name: string | null\r\n    email: string | null\r\n    avatar_url: string | null\r\n  }\r\n}\r\n\r\nexport type SellerOrdersClientServerActions = OrderStatusActionsServerActions &\r\n  SellerRateBuyerActionsServerActions & {\r\n    getSellerOrders: (\r\n      statusFilter?: OrderItemStatus | \"all\"\r\n    ) => Promise<{ orders: SellerOrderItem[]; error?: string }>\r\n    getSellerOrderStats: () => Promise<{\r\n      pending: number\r\n      received: number\r\n      processing: number\r\n      shipped: number\r\n      delivered: number\r\n      cancelled: number\r\n      total: number\r\n    }>\r\n    getOrderConversation: (\r\n      orderId: string,\r\n      sellerId: string\r\n    ) => Promise<{ conversationId: string | null; error?: string }>\r\n  }\r\n\r\ninterface SellerOrdersClientProps {\r\n  locale: string\r\n  actions: SellerOrdersClientServerActions\r\n}\r\n\r\ntype StatusFilter = OrderItemStatus | 'all' | 'active'\r\n\r\nexport function SellerOrdersClient({ locale, actions }: SellerOrdersClientProps) {\r\n  const tCommon = useTranslations(\"Common\")\r\n  const [orders, setOrders] = useState<SellerOrderItem[]>([])\r\n  const [isLoading, setIsLoading] = useState(true)\r\n  const [isRefreshing, setIsRefreshing] = useState(false)\r\n  const [activeTab, setActiveTab] = useState<StatusFilter>('all')\r\n  const [stats, setStats] = useState({\r\n    pending: 0,\r\n    received: 0,\r\n    processing: 0,\r\n    shipped: 0,\r\n    delivered: 0,\r\n    cancelled: 0,\r\n    total: 0\r\n  })\r\n  const [conversationMap, setConversationMap] = useState<Map<string, string>>(new Map())\r\n\r\n  // Load orders and stats\r\n  async function loadData() {\r\n    try {\r\n      const [ordersResult, statsResult] = await Promise.all([\r\n        actions.getSellerOrders(),\r\n        actions.getSellerOrderStats()\r\n      ])\r\n\r\n      if (ordersResult.orders) {\r\n        setOrders(ordersResult.orders)\r\n\r\n        // Load conversation IDs for each order\r\n        const convPromises = ordersResult.orders.map(async (item) => {\r\n          const result = await actions.getOrderConversation(item.order_id, item.seller_id)\r\n          return { key: `${item.order_id}-${item.seller_id}`, conversationId: result.conversationId }\r\n        })\r\n\r\n        const conversations = await Promise.all(convPromises)\r\n        const map = new Map<string, string>()\r\n        conversations.forEach(({ key, conversationId }) => {\r\n          if (conversationId) map.set(key, conversationId)\r\n        })\r\n        setConversationMap(map)\r\n      }\r\n\r\n      setStats(statsResult)\r\n    } catch (error) {\r\n      console.error('Error loading orders:', error)\r\n    } finally {\r\n      setIsLoading(false)\r\n      setIsRefreshing(false)\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    loadData()\r\n  }, [])\r\n\r\n  function handleRefresh() {\r\n    setIsRefreshing(true)\r\n    loadData()\r\n  }\r\n\r\n  // Filter orders based on active tab\r\n  const filteredOrders = orders.filter(order => {\r\n    if (activeTab === 'all') return true\r\n    if (activeTab === 'active') return ['pending', 'received', 'processing', 'shipped'].includes(order.status)\r\n    return order.status === activeTab\r\n  })\r\n\r\n  // Stats cards\r\n  const statCards = [\r\n    { key: 'pending' as const, label: 'Pending', icon: 'ΓÅ│', color: 'bg-order-pending' },\r\n    { key: 'processing' as const, label: 'Processing', icon: '≡ƒôª', color: 'bg-order-processing' },\r\n    { key: 'shipped' as const, label: 'Shipped', icon: '≡ƒÜÜ', color: 'bg-order-shipped' },\r\n    { key: 'delivered' as const, label: 'Delivered', icon: '≡ƒÄë', color: 'bg-order-delivered' },\r\n  ]\r\n\r\n  return (\r\n    <div className=\"flex flex-1 flex-col\">\r\n      {/* Header */}\r\n      <header className=\"sticky top-0 z-50 bg-background border-b\">\r\n        <div className=\"container mx-auto px-4 py-4 flex items-center gap-4\">\r\n          <Button variant=\"ghost\" size=\"icon\" asChild aria-label={tCommon(\"back\")}>\r\n            <Link href=\"/sell\">\r\n              <ArrowLeft className=\"h-5 w-5\" />\r\n            </Link>\r\n          </Button>\r\n          <div className=\"flex-1\">\r\n            <h1 className=\"text-xl font-semibold\">Your Orders</h1>\r\n            <p className=\"text-sm text-muted-foreground\">Manage incoming orders and shipments</p>\r\n          </div>\r\n          <Button variant=\"outline\" size=\"sm\" onClick={handleRefresh} disabled={isRefreshing}>\r\n            <RefreshCw className={cn(\"h-4 w-4 mr-2\", isRefreshing && \"animate-spin\")} />\r\n            Refresh\r\n          </Button>\r\n        </div>\r\n      </header>\r\n\r\n      <div className=\"container mx-auto px-4 py-6 space-y-6\">\r\n        {/* Stats Cards */}\r\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\r\n          {statCards.map((stat) => (\r\n            <Card\r\n              key={stat.key}\r\n              className={cn(\r\n                \"cursor-pointer transition-all hover:shadow-md\",\r\n                activeTab === stat.key && \"ring-2 ring-primary\"\r\n              )}\r\n              onClick={() => setActiveTab(stat.key)}\r\n            >\r\n              <CardContent className=\"p-4\">\r\n                <div className=\"flex items-center gap-3\">\r\n                  <div className={cn(\"w-10 h-10 rounded-full flex items-center justify-center text-badge-fg-on-solid\", stat.color)}>\r\n                    <span className=\"text-lg\">{stat.icon}</span>\r\n                  </div>\r\n                  <div>\r\n                    <p className=\"text-2xl font-bold\">{stats[stat.key]}</p>\r\n                    <p className=\"text-sm text-muted-foreground\">{stat.label}</p>\r\n                  </div>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          ))}\r\n        </div>\r\n\r\n        {/* Filter Tabs */}\r\n        <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as StatusFilter)}>\r\n          <div className=\"flex items-center justify-between\">\r\n            <TabsList>\r\n              <TabsTrigger value=\"all\">\r\n                All ({stats.total})\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"active\">\r\n                Active ({stats.pending + stats.received + stats.processing + stats.shipped})\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"pending\">Pending</TabsTrigger>\r\n              <TabsTrigger value=\"shipped\">Shipped</TabsTrigger>\r\n              <TabsTrigger value=\"delivered\">Delivered</TabsTrigger>\r\n            </TabsList>\r\n          </div>\r\n\r\n          {/* Orders List */}\r\n          <TabsContent value={activeTab} className=\"mt-4\">\r\n            {isLoading ? (\r\n              <div className=\"flex items-center justify-center py-12\">\r\n                <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\r\n              </div>\r\n            ) : filteredOrders.length === 0 ? (\r\n              <Card>\r\n                <CardContent className=\"py-12 text-center\">\r\n                  <Package className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\r\n                  <h3 className=\"text-lg font-medium mb-2\">No orders yet</h3>\r\n                  <p className=\"text-muted-foreground\">\r\n                    {activeTab === 'all'\r\n                      ? \"When customers purchase your products, their orders will appear here.\"\r\n                      : `You have no ${activeTab} orders.`\r\n                    }\r\n                  </p>\r\n                </CardContent>\r\n              </Card>\r\n            ) : (\r\n              <div className=\"space-y-4\">\r\n                {filteredOrders.map((item) => {\r\n                  const convKey = `${item.order_id}-${item.seller_id}`\r\n                  const conversationId = conversationMap.get(convKey)\r\n\r\n                  return (\r\n                    <Card key={item.id}>\r\n                      <CardContent className=\"p-4 md:p-4\">\r\n                        <div className=\"flex flex-col md:flex-row gap-4\">\r\n                          {/* Product Image */}\r\n                          <div className=\"relative w-full md:w-24 h-24 bg-muted rounded-lg overflow-hidden shrink-0\">\r\n                            {item.product?.images?.[0] ? (\r\n                              <Image\r\n                                src={item.product.images[0]}\r\n                                alt={item.product?.title || 'Product'}\r\n                                fill\r\n                                className=\"object-cover\"\r\n                              />\r\n                            ) : (\r\n                              <div className=\"w-full h-full flex items-center justify-center\">\r\n                                <Package className=\"h-8 w-8 text-muted-foreground\" />\r\n                              </div>\r\n                            )}\r\n                          </div>\r\n\r\n                          {/* Order Details */}\r\n                          <div className=\"flex-1 min-w-0\">\r\n                            <div className=\"flex flex-wrap items-start justify-between gap-2 mb-2\">\r\n                              <div>\r\n                                <h3 className=\"font-semibold line-clamp-1\">\r\n                                  {item.product?.title || 'Unknown Product'}\r\n                                </h3>\r\n                                <p className=\"text-sm text-muted-foreground\">\r\n                                  Qty: {item.quantity} ├ù ${item.price_at_purchase.toFixed(2)}\r\n                                </p>\r\n                              </div>\r\n                              <OrderStatusBadge status={item.status} />\r\n                            </div>\r\n\r\n                            {/* Buyer Info */}\r\n                            {item.buyer && (\r\n                              <div className=\"flex items-center gap-2 mb-3 text-sm\">\r\n                                <UserAvatar\r\n                                  name={item.buyer.full_name || item.buyer.email || \"User\"}\r\n                                  avatarUrl={item.buyer.avatar_url ?? null}\r\n                                  className=\"size-6 bg-muted\"\r\n                                  fallbackClassName=\"bg-muted text-2xs font-semibold\"\r\n                                />\r\n                                <span className=\"text-muted-foreground\">\r\n                                  {item.buyer.full_name || item.buyer.email}\r\n                                </span>\r\n                              </div>\r\n                            )}\r\n\r\n                            {/* Shipping Address - Full details for seller to ship */}\r\n                            {item.order?.shipping_address && (\r\n                              <div className=\"text-sm bg-surface-subtle rounded-lg p-3 mb-3 space-y-1\">\r\n                                <div className=\"flex items-center gap-1.5 font-medium text-foreground\">\r\n                                  ≡ƒôì Ship To:\r\n                                </div>\r\n                                {item.order.shipping_address.name && (\r\n                                  <div>{item.order.shipping_address.name}</div>\r\n                                )}\r\n                                {item.order.shipping_address.address?.line1 && (\r\n                                  <div className=\"text-muted-foreground\">{item.order.shipping_address.address.line1}</div>\r\n                                )}\r\n                                {item.order.shipping_address.address?.line2 && (\r\n                                  <div className=\"text-muted-foreground\">{item.order.shipping_address.address.line2}</div>\r\n                                )}\r\n                                {item.order.shipping_address.address && (\r\n                                  <div className=\"text-muted-foreground\">\r\n                                    {[\r\n                                      item.order.shipping_address.address.city,\r\n                                      item.order.shipping_address.address.state,\r\n                                      item.order.shipping_address.address.postal_code,\r\n                                    ].filter(Boolean).join(', ')}\r\n                                  </div>\r\n                                )}\r\n                                {item.order.shipping_address.address?.country && (\r\n                                  <div className=\"text-muted-foreground font-medium\">{item.order.shipping_address.address.country}</div>\r\n                                )}\r\n                                {item.order.shipping_address.email && (\r\n                                  <div className=\"text-xs text-muted-foreground mt-1\">Γ£ë∩╕Å {item.order.shipping_address.email}</div>\r\n                                )}\r\n                              </div>\r\n                            )}\r\n\r\n                            {/* Tracking Info */}\r\n                            {item.tracking_number && (\r\n                              <div className=\"text-sm mb-3\">\r\n                                <span className=\"text-muted-foreground\">Tracking: </span>\r\n                                <span className=\"font-mono\">{item.tracking_number}</span>\r\n                                {item.shipping_carrier && (\r\n                                  <span className=\"text-muted-foreground\"> ({item.shipping_carrier})</span>\r\n                                )}\r\n                              </div>\r\n                            )}\r\n\r\n                            {/* Time */}\r\n                            <p className=\"text-xs text-muted-foreground\">\r\n                              Ordered {formatDistanceToNow(new Date(item.created_at), { addSuffix: true })}\r\n                            </p>\r\n                          </div>\r\n\r\n                          {/* Actions */}\r\n                          <div className=\"flex md:flex-col gap-2 justify-end\">\r\n                            <OrderStatusActions\n                              orderItemId={item.id}\n                              currentStatus={item.status}\n                              orderId={item.order_id}\n                              sellerId={item.seller_id}\n                              isSeller={true}\n                              conversationId={conversationId ?? null}\n                              actions={{ updateOrderItemStatus: actions.updateOrderItemStatus }}\n                            />\n\r\n                            {/* Rate Buyer - only shown for delivered orders */}\r\n                            <SellerRateBuyerActions\r\n                              orderItemId={item.id}\r\n                              currentStatus={item.status}\r\n                              locale={locale}\r\n                              actions={{\r\n                                canSellerRateBuyer: actions.canSellerRateBuyer,\r\n                                submitBuyerFeedback: actions.submitBuyerFeedback,\r\n                              }}\r\n                            />\r\n\r\n                            {item.product?.slug && (\r\n                              <Button variant=\"ghost\" size=\"sm\" asChild>\r\n                                <Link href={`/product/${item.product.slug}`} target=\"_blank\">\r\n                                  <ExternalLink className=\"h-4 w-4\" />\r\n                                </Link>\r\n                              </Button>\r\n                            )}\r\n                          </div>\r\n                        </div>\r\n                      </CardContent>\r\n                    </Card>\r\n                  )\r\n                })}\r\n              </div>\r\n            )}\r\n          </TabsContent>\r\n        </Tabs>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\sell\\orders\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\sell\\orders\\page.tsx","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/orders' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":4,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":10,"endColumn":30},{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/buyer-feedback' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":11,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":11,"endColumn":67}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from \"@/lib/supabase/server\"\r\nimport { setRequestLocale } from \"next-intl/server\"\r\nimport { redirect, validateLocale } from \"@/i18n/routing\"\r\nimport {\r\n  canSellerRateBuyer,\r\n  getOrderConversation,\r\n  getSellerOrders,\r\n  getSellerOrderStats,\r\n  updateOrderItemStatus,\r\n} from \"@/app/actions/orders\"\r\nimport { submitBuyerFeedback } from \"@/app/actions/buyer-feedback\"\r\nimport { SellerOrdersClient } from \"./client\"\r\n\r\nexport const metadata = {\r\n  title: \"Your Orders | Seller Dashboard\",\r\n  description: \"Manage incoming orders, track shipments, and communicate with buyers\",\r\n}\r\n\r\nexport default async function SellerOrdersPage({\r\n  params,\r\n}: {\r\n  params: Promise<{ locale: string }>\r\n}) {\r\n  const { locale: localeParam } = await params\r\n  const locale = validateLocale(localeParam)\r\n  setRequestLocale(locale)\r\n\r\n  const supabase = await createClient()\r\n  const {\r\n    data: { user },\r\n  } = await supabase.auth.getUser()\r\n\r\n  if (!user) {\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n\r\n  return (\r\n    <SellerOrdersClient\r\n      locale={locale}\r\n      actions={{\r\n        getSellerOrders,\r\n        getSellerOrderStats,\r\n        getOrderConversation,\r\n        updateOrderItemStatus,\r\n        canSellerRateBuyer,\r\n        submitBuyerFeedback,\r\n      }}\r\n    />\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\(sell)\\sell\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\[username]\\[productSlug]\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\[username]\\[productSlug]\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\[username]\\[productSlug]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'HeroSpec' is defined but never used.","line":6,"column":143,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":151,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"HeroSpec"},"fix":{"range":[349,364],"text":""},"desc":"Remove unused variable \"HeroSpec\"."}]},{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/reviews' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":8,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":8,"endColumn":53}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { notFound } from \"next/navigation\"\r\nimport type { Metadata } from \"next\"\r\nimport { getTranslations, setRequestLocale } from \"next-intl/server\"\r\n\r\nimport { createStaticClient } from \"@/lib/supabase/server\"\r\nimport { fetchProductByUsernameAndSlug, fetchSellerProducts, fetchProductFavoritesCount, fetchProductHeroSpecs, type ProductPageProduct, type HeroSpec } from \"@/lib/data/product-page\"\r\nimport { fetchProductReviews, type ProductReview } from \"@/lib/data/product-reviews\"\r\nimport { submitReview } from \"@/app/actions/reviews\"\r\n\r\nimport { ProductPageLayout } from \"@/components/shared/product/product-page-layout\"\nimport {\n  buildProductPageViewModel,\n  isUuid,\n} from \"@/lib/view-models/product-page\"\nimport { routing } from \"@/i18n/routing\"\n\r\n// =============================================================================\r\n// SEO-OPTIMIZED PRODUCT PAGE\r\n// URL Pattern: /{username}/{productSlug}\r\n// Example: /indecisive_wear/vintage-leather-jacket\r\n// \r\n// ISR OPTIMIZATION:\r\n// - generateStaticParams fetches top 25 products for build-time pre-rendering\r\n// - High-traffic product pages are pre-built for fast first loads + SEO\r\n// - New/less-popular products are rendered on-demand (ISR)\r\n// =============================================================================\r\n\r\n// Pre-generate top 25 products (by views/sales) for fast SEO pages\r\nexport async function generateStaticParams() {\r\n  const supabase = createStaticClient()\r\n  \r\n  // Fallback when Supabase isn't configured (e.g. local/E2E)\r\n  if (!supabase) {\r\n    return routing.locales.map((locale) => ({ \r\n      locale, \r\n      username: '__fallback__',\r\n      productSlug: '__fallback__'\r\n    }))\r\n  }\r\n\r\n  const nowIso = new Date().toISOString()\r\n\r\n  // Fetch top products with seller usernames.\r\n  // Important: Only prioritize ACTIVE boosts (boost_expires_at > now).\r\n  const boostedResult = await supabase\r\n    .from(\"products\")\r\n    .select(\"slug, seller:profiles!products_seller_id_fkey(username)\")\r\n    .eq(\"status\", \"active\")\r\n    .not(\"slug\", \"is\", null)\r\n    .eq(\"is_boosted\", true)\r\n    .gt(\"boost_expires_at\", nowIso)\r\n    .order(\"boost_expires_at\", { ascending: false, nullsFirst: false })\r\n    .order(\"review_count\", { ascending: false, nullsFirst: false })\r\n    .order(\"created_at\", { ascending: false })\r\n    .limit(25)\r\n\r\n  const boosted = boostedResult.data || []\n\n  const remaining = 25 - boosted.length\n  const rest = remaining > 0\n    ? ((await supabase\n        .from(\"products\")\n        .select(\"slug, seller:profiles!products_seller_id_fkey(username)\")\n        .eq(\"status\", \"active\")\n        .not(\"slug\", \"is\", null)\n        .or(`boost_expires_at.is.null,boost_expires_at.lte.${nowIso}`)\n        .order(\"review_count\", { ascending: false, nullsFirst: false })\n        .order(\"created_at\", { ascending: false })\n        .limit(remaining)).data || [])\n    : []\n\n  const products = [...boosted, ...rest]\n\r\n  if (!products || products.length === 0) {\r\n    return routing.locales.map((locale) => ({ \r\n      locale, \r\n      username: '__fallback__',\r\n      productSlug: '__fallback__'\r\n    }))\r\n  }\r\n\r\n  // Build locale ├ù username ├ù productSlug combinations\r\n  const params: Array<{ locale: string; username: string; productSlug: string }> = []\r\n  \r\n  for (const product of products) {\r\n    const slug = product.slug\r\n    // Seller is returned as object from Supabase relation\r\n    const seller = product.seller as { username: string | null } | null\r\n    const username = seller?.username\r\n    \r\n    if (slug && username) {\r\n      for (const locale of routing.locales) {\r\n        params.push({ locale, username, productSlug: slug })\r\n      }\r\n    }\r\n  }\r\n\r\n  // Fallback if no valid products found\r\n  if (params.length === 0) {\r\n    return routing.locales.map((locale) => ({ \r\n      locale, \r\n      username: '__fallback__',\r\n      productSlug: '__fallback__'\r\n    }))\r\n  }\r\n\r\n  return params\r\n}\r\n\r\ninterface ProductPageProps {\r\n  params: Promise<{\r\n    username: string\r\n    productSlug: string\r\n    locale: string\r\n  }>\r\n}\r\n\r\nexport async function generateMetadata({ params }: ProductPageProps): Promise<Metadata> {\n  const { username, productSlug, locale } = await params\n  setRequestLocale(locale)\n  const product = await fetchProductByUsernameAndSlug(username, productSlug)\n\r\n  if (!product) {\r\n    const t = await getTranslations({ locale, namespace: \"ProductNotFound\" })\r\n    return {\n      title: t(\"metaTitle\"),\n    }\n  }\n\n  const tProduct = await getTranslations({ locale, namespace: \"Product\" })\n  const tBreadcrumbs = await getTranslations({ locale, namespace: \"Breadcrumbs\" })\n\n  const displayName = product.seller?.display_name || product.seller?.username || username\n  const canonicalUrl = `/${locale}/${username}/${productSlug}`\n  const siteUrl = process.env.NEXT_PUBLIC_SITE_URL || \"https://treido.eu\"\n  const fullCanonicalUrl = `${siteUrl}${canonicalUrl}`\n\n  const description = product.meta_description\n    || (product.description ? product.description.slice(0, 155) : null)\n    || tProduct(\"metaDescriptionFallback\", { title: product.title, seller: displayName })\n\n  const ogImage = Array.isArray(product.images) && product.images?.[0]\n    ? (product.images[0] as string)\n    : null\n\n  return {\n    title: tProduct(\"metaTitle\", { title: product.title, seller: displayName }),\n    description,\n    alternates: {\n      canonical: fullCanonicalUrl,\n      languages: {\n        en: `${siteUrl}/en/${username}/${productSlug}`,\n        bg: `${siteUrl}/bg/${username}/${productSlug}`,\n      },\n    },\n    openGraph: {\n      title: product.title,\n      type: \"website\",\n      url: fullCanonicalUrl,\n      siteName: tBreadcrumbs(\"homeLabel\"),\n      description,\n      images: ogImage\n        ? [{\n            url: ogImage,\n            alt: product.title,\n            width: 1200,\n            height: 630,\n          }]\n        : [],\n    },\n    twitter: {\n      card: \"summary_large_image\",\n      title: product.title,\n      description,\n      images: ogImage ? [ogImage] : [],\n    },\n    robots: {\n      index: true,\n      follow: true,\n    },\n  }\n}\n\r\nexport default async function ProductPage({ params }: ProductPageProps) {\r\n  const { username, productSlug, locale } = await params\r\n  setRequestLocale(locale)\r\n\r\n  // Handle fallback from generateStaticParams (when Supabase unavailable at build)\r\n  if (username === '__fallback__' || productSlug === '__fallback__') {\r\n    notFound()\r\n  }\r\n\r\n  const supabase = createStaticClient()\r\n  if (!supabase) notFound()\r\n\r\n  const productData = await fetchProductByUsernameAndSlug(username, productSlug)\r\n  if (!productData) notFound()\r\n\r\n  const category = productData.category\r\n  const seller = productData.seller\r\n  if (!seller) notFound()\r\n\r\n  let parentCategory: ProductPageProduct[\"category\"] | null = null\r\n  if (category?.parent_id) {\r\n    const { data: parent } = await supabase\r\n      .from(\"categories\")\r\n      .select(\"id, name, name_bg, slug, icon, parent_id\")\r\n      .eq(\"id\", category.parent_id)\r\n      .maybeSingle()\r\n    parentCategory = (parent as unknown as ProductPageProduct[\"category\"] | null) ?? null\r\n  }\r\n\r\n  const rootCategory = parentCategory?.parent_id ? parentCategory : parentCategory ?? category\n  const tBreadcrumbs = await getTranslations({ locale, namespace: \"Breadcrumbs\" })\n  const siteUrl = process.env.NEXT_PUBLIC_SITE_URL || \"https://treido.eu\"\n  const sellerName = seller.display_name || seller.username || username\n  const productAttributes = productData.attributes as Record<string, unknown> | null | undefined\n\n  // IMPORTANT: Keep key order/structure identical to the original JSON-LD output.\n  const jsonLd = {\n    \"@context\": \"https://schema.org\",\n    \"@type\": \"Product\",\n    name: productData.title,\n    description: productData.description,\n    image: (Array.isArray(productData.images) ? productData.images : []) || [],\n    sku: productData.id,\n    brand: productAttributes?.brand\n      ? { \"@type\": \"Brand\", name: productAttributes.brand as string }\n      : undefined,\n    offers: {\n      \"@type\": \"Offer\",\n      price: productData.price,\n      priceCurrency: \"EUR\",\n      availability: Number(productData.stock ?? 0) > 0\n        ? \"https://schema.org/InStock\"\n        : \"https://schema.org/OutOfStock\",\n      seller: {\n        \"@type\": \"Organization\",\n        name: sellerName,\n        url: `${siteUrl}/${locale}/${seller.username ?? username}`,\n      },\n      url: `${siteUrl}/${locale}/${username}/${productSlug}`,\n    },\n    aggregateRating: Number(productData.review_count ?? 0) > 0\n      ? {\n          \"@type\": \"AggregateRating\",\n          ratingValue: (productData.rating as number | null | undefined) || 0,\n          reviewCount: productData.review_count,\n        }\n      : undefined,\n  }\n\n  const breadcrumbJsonLd = {\n    \"@context\": \"https://schema.org\",\n    \"@type\": \"BreadcrumbList\",\n    itemListElement: [\n      {\n        \"@type\": \"ListItem\",\n        position: 1,\n        name: tBreadcrumbs(\"home\"),\n        item: `${siteUrl}/${locale}`,\n      },\n      ...(parentCategory\n        ? [{\n            \"@type\": \"ListItem\",\n            position: 2,\n            name: parentCategory.name,\n            item: `${siteUrl}/${locale}/categories/${parentCategory.slug}`,\n          }]\n        : []),\n      ...(category\n        ? [{\n            \"@type\": \"ListItem\",\n            position: parentCategory ? 3 : 2,\n            name: category.name,\n            item: `${siteUrl}/${locale}/categories/${category.slug}`,\n          }]\n        : []),\n      {\n        \"@type\": \"ListItem\",\n        position: (parentCategory ? 3 : 2) + (category ? 1 : 0),\n        name: productData.title,\n        item: `${siteUrl}/${locale}/${username}/${productSlug}`,\n      },\n    ],\n  }\n\n  // Fetch related products, favorites count, and hero specs in parallel\n  const [relatedProductsRaw, favoritesCount, heroSpecs] = await Promise.all([\n    fetchSellerProducts(seller.id, productData.id, 10),\n    fetchProductFavoritesCount(productData.id),\n    fetchProductHeroSpecs(productData.id, locale),\r\n  ])\r\n\r\n  const reviews: ProductReview[] = isUuid(productData.id)\r\n    ? await fetchProductReviews(productData.id, 8)\r\n    : []\r\n\r\n  const viewModel = buildProductPageViewModel({\n    username,\n    product: productData,\n    seller,\n    category,\n    parentCategory,\n    relatedProductsRaw: relatedProductsRaw || [],\n    heroSpecs, // Pass database-driven hero specs\n    jsonLd,\n    breadcrumbJsonLd,\n  })\n\r\n  return (\r\n    <ProductPageLayout\r\n      locale={locale}\r\n      username={username}\r\n      productSlug={productSlug}\r\n      product={productData}\r\n      seller={seller}\r\n      category={category}\r\n      parentCategory={parentCategory}\r\n      rootCategory={rootCategory}\r\n      relatedProducts={viewModel.relatedProducts}\r\n      reviews={reviews}\r\n      viewModel={viewModel}\r\n      variants={productData.product_variants ?? []}\r\n      submitReview={submitReview}\r\n      favoritesCount={favoritesCount}\r\n    />\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\[username]\\error.tsx","messages":[{"ruleId":"@next/next/no-html-link-for-pages","severity":2,"message":"Do not use an `<a>` element to navigate to `/`. Use `<Link />` from `next/link` instead. See: https://nextjs.org/docs/messages/no-html-link-for-pages","line":37,"column":11,"nodeType":"JSXOpeningElement","endLine":40,"endColumn":12},{"ruleId":"@next/next/no-html-link-for-pages","severity":2,"message":"Do not use an `<a>` element to navigate to `/`. Use `<Link />` from `next/link` instead. See: https://nextjs.org/docs/messages/no-html-link-for-pages","line":37,"column":11,"nodeType":"JSXOpeningElement","endLine":40,"endColumn":12},{"ruleId":"@next/next/no-html-link-for-pages","severity":2,"message":"Do not use an `<a>` element to navigate to `/`. Use `<Link />` from `next/link` instead. See: https://nextjs.org/docs/messages/no-html-link-for-pages","line":37,"column":11,"nodeType":"JSXOpeningElement","endLine":40,"endColumn":12},{"ruleId":"@next/next/no-html-link-for-pages","severity":2,"message":"Do not use an `<a>` element to navigate to `/`. Use `<Link />` from `next/link` instead. See: https://nextjs.org/docs/messages/no-html-link-for-pages","line":37,"column":11,"nodeType":"JSXOpeningElement","endLine":40,"endColumn":12},{"ruleId":"@next/next/no-html-link-for-pages","severity":2,"message":"Do not use an `<a>` element to navigate to `/`. Use `<Link />` from `next/link` instead. See: https://nextjs.org/docs/messages/no-html-link-for-pages","line":37,"column":11,"nodeType":"JSXOpeningElement","endLine":40,"endColumn":12},{"ruleId":"@next/next/no-html-link-for-pages","severity":2,"message":"Do not use an `<a>` element to navigate to `/`. Use `<Link />` from `next/link` instead. See: https://nextjs.org/docs/messages/no-html-link-for-pages","line":37,"column":11,"nodeType":"JSXOpeningElement","endLine":40,"endColumn":12},{"ruleId":"@next/next/no-html-link-for-pages","severity":2,"message":"Do not use an `<a>` element to navigate to `/`. Use `<Link />` from `next/link` instead. See: https://nextjs.org/docs/messages/no-html-link-for-pages","line":37,"column":11,"nodeType":"JSXOpeningElement","endLine":40,"endColumn":12},{"ruleId":"@next/next/no-html-link-for-pages","severity":2,"message":"Do not use an `<a>` element to navigate to `/`. Use `<Link />` from `next/link` instead. See: https://nextjs.org/docs/messages/no-html-link-for-pages","line":37,"column":11,"nodeType":"JSXOpeningElement","endLine":40,"endColumn":12},{"ruleId":"@next/next/no-html-link-for-pages","severity":2,"message":"Do not use an `<a>` element to navigate to `/`. Use `<Link />` from `next/link` instead. See: https://nextjs.org/docs/messages/no-html-link-for-pages","line":37,"column":11,"nodeType":"JSXOpeningElement","endLine":40,"endColumn":12},{"ruleId":"@next/next/no-html-link-for-pages","severity":2,"message":"Do not use an `<a>` element to navigate to `/`. Use `<Link />` from `next/link` instead. See: https://nextjs.org/docs/messages/no-html-link-for-pages","line":37,"column":11,"nodeType":"JSXOpeningElement","endLine":40,"endColumn":12}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useTranslations } from 'next-intl'\r\n\r\nexport default function ProfileError({\r\n  error,\r\n  reset,\r\n}: {\r\n  error: Error & { digest?: string }\r\n  reset: () => void\r\n}) {\r\n  const t = useTranslations('ProfileError')\r\n\r\n  return (\r\n    <div className=\"min-h-(--page-section-min-h) flex items-center justify-center px-4\">\r\n      <div className=\"text-center max-w-md\">\r\n        <h1 className=\"text-2xl font-bold text-foreground mb-2\">{t('title')}</h1>\r\n        <p className=\"text-muted-foreground mb-3\">\r\n          {t('description')}\r\n        </p>\r\n\r\n        {error.digest ? (\r\n          <p className=\"text-xs text-muted-foreground mb-4 font-mono bg-muted px-3 py-2 rounded\">\r\n            {t('errorId')}: {error.digest}\r\n          </p>\r\n        ) : null}\r\n\r\n        <div className=\"flex flex-col sm:flex-row gap-3 justify-center\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={reset}\r\n            className=\"inline-flex items-center justify-center rounded-md border border-input bg-background px-4 py-2 text-sm font-medium text-foreground hover:bg-accent hover:text-accent-foreground\"\r\n          >\r\n            {t('tryAgain')}\r\n          </button>\r\n\r\n          <a\r\n            href=\"/\"\r\n            className=\"inline-flex items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground hover:bg-interactive-hover\"\r\n          >\r\n            {t('goToHomepage')}\r\n          </a>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\[username]\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\[username]\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\[username]\\not-found.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\[username]\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Suspense' is defined but never used.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":18,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Suspense"},"fix":{"range":[152,184],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/seller-follows' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":10,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":10,"endColumn":76},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ProfileProduct' is defined but never used.","line":66,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":66,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SellerReview' is defined but never used.","line":87,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":87,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BuyerReview' is defined but never used.","line":98,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":98,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UserSpecificData' is defined but never used.","line":182,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":182,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { notFound } from \"next/navigation\"\r\nimport type { Metadata } from \"next\"\r\nimport { getTranslations, setRequestLocale } from \"next-intl/server\"\r\nimport { Suspense } from \"react\"\r\nimport { createClient, createStaticClient } from \"@/lib/supabase/server\"\r\nimport { getPublicProfileData, getProfileMetadata } from \"@/lib/data/profile-page\"\r\nimport { safeAvatarSrc } from \"@/lib/utils\"\r\nimport { PublicProfileClient } from \"./profile-client\"\r\nimport { routing } from \"@/i18n/routing\"\r\nimport { followSeller, unfollowSeller } from \"@/app/actions/seller-follows\"\r\n\r\n// =============================================================================\r\n// SEO-OPTIMIZED PROFILE PAGE - HYBRID CACHING\r\n// URL Pattern: /{username}\r\n// Example: /indecisive_wear\r\n// \r\n// CACHING STRATEGY:\r\n// - Profile data is PUBLIC and CACHED via 'use cache' in getPublicProfileData\r\n// - User-specific data (isOwnProfile, isFollowing) is DYNAMIC (requires auth)\r\n// - Uses Suspense to stream dynamic content while showing cached content fast\r\n// \r\n// ISR OPTIMIZATION:\r\n// - generateStaticParams fetches top 25 active sellers for build-time pre-rendering\r\n// - High-traffic seller pages are pre-built for fast first loads + SEO\r\n// - New/less-active sellers are rendered on-demand (ISR)\r\n// =============================================================================\r\n\r\n// Pre-generate top 25 active sellers (by product count) for fast SEO pages\r\nexport async function generateStaticParams() {\r\n  const supabase = createStaticClient()\r\n  \r\n  // Fallback when Supabase isn't configured (e.g. local/E2E)\r\n  if (!supabase) {\r\n    return routing.locales.map((locale) => ({ locale, username: '__fallback__' }))\r\n  }\r\n\r\n  // Fetch top 25 active sellers with products (ordered by activity)\r\n  const { data: sellers } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"username, products(id)\")\r\n    .eq(\"is_seller\", true)\r\n    .not(\"username\", \"is\", null)\r\n    .limit(25)\r\n\r\n  if (!sellers || sellers.length === 0) {\r\n    return routing.locales.map((locale) => ({ locale, username: '__fallback__' }))\r\n  }\r\n\r\n  // Sort by product count (most active sellers first) and take top 25\r\n  const activeSellers = sellers\r\n    .map(s => ({ \r\n      username: s.username as string, \r\n      productCount: Array.isArray(s.products) ? s.products.length : 0 \r\n    }))\r\n    .filter(s => s.username && s.productCount > 0)\r\n    .sort((a, b) => b.productCount - a.productCount)\r\n    .slice(0, 25)\r\n\r\n  // Generate locale ├ù username combinations\r\n  return routing.locales.flatMap((locale) =>\r\n    activeSellers.map((s) => ({ locale, username: s.username }))\r\n  )\r\n}\r\n\r\n// Proper types for products and reviews - must match profile-client.tsx\r\ninterface ProfileProduct {\r\n  id: string\r\n  title: string\r\n  slug: string | null\r\n  price: number\r\n  list_price: number | null\r\n  images: string[] | null\r\n  rating: number | null\r\n  review_count: number | null\r\n  created_at: string\r\n  is_boosted: boolean | null\r\n  seller_id: string | null\r\n  condition: string | null\r\n}\r\n\r\ninterface ReviewPerson {\r\n  username: string | null\r\n  display_name: string | null\r\n  avatar_url: string | null\r\n}\r\n\r\ninterface SellerReview {\r\n  id: string\r\n  rating: number\r\n  comment: string | null\r\n  item_as_described: boolean | null\r\n  shipping_speed: boolean | null\r\n  communication: boolean | null\r\n  created_at: string\r\n  buyer: ReviewPerson | null\r\n}\r\n\r\ninterface BuyerReview {\r\n  id: string\r\n  rating: number\r\n  comment: string | null\r\n  payment_promptness: boolean | null\r\n  communication: boolean | null\r\n  created_at: string\r\n  seller: ReviewPerson | null\r\n}\r\n\r\ninterface ProfilePageProps {\r\n  params: Promise<{\r\n    username: string\r\n    locale: string\r\n  }>\r\n}\r\n\r\n// Generate metadata for SEO - uses CACHED data function\r\nexport async function generateMetadata({ params }: ProfilePageProps): Promise<Metadata> {\r\n  const { username, locale } = await params\r\n  setRequestLocale(locale)\r\n\r\n  const data = await getProfileMetadata(username)\r\n\r\n  if (!data?.profile) {\r\n    const tNotFound = await getTranslations({ locale, namespace: \"ProfileNotFound\" })\r\n    return {\r\n      title: tNotFound(\"title\"),\r\n    }\r\n  }\r\n\r\n  const { profile, sellerStats } = data\r\n  const usernameTag = profile.username || username\r\n  const displayName = profile.display_name || usernameTag\r\n  const t = await getTranslations({ locale, namespace: \"ProfilePage\" })\r\n  const siteUrl = process.env.NEXT_PUBLIC_SITE_URL || \"https://treido.eu\"\r\n  const canonicalUrl = `${siteUrl}/${locale}/${username}`\r\n  \r\n  const title = `${displayName} (@${usernameTag})`\r\n  const totalSales = sellerStats?.total_sales ?? 0\r\n  const avgRating = sellerStats?.average_rating ?? 0\r\n  const description =\r\n    profile.bio ||\r\n    (profile.is_seller\r\n      ? t(\"metadataDescriptionSeller\", {\r\n          name: displayName,\r\n          sales: totalSales,\r\n          rating: avgRating.toFixed(1),\r\n        })\r\n      : t(\"metadataDescriptionMember\", { name: displayName }))\r\n\r\n  const ogAvatar = safeAvatarSrc(profile.avatar_url)\r\n  const ogImages = ogAvatar && ogAvatar.startsWith(\"http\") ? [ogAvatar] : undefined\r\n\r\n  return {\r\n    title,\r\n    description,\r\n    alternates: {\r\n      canonical: canonicalUrl,\r\n      languages: {\r\n        en: `${siteUrl}/en/${username}`,\r\n        bg: `${siteUrl}/bg/${username}`,\r\n      },\r\n    },\r\n    openGraph: {\r\n      title,\r\n      description,\r\n      type: \"profile\",\r\n      url: canonicalUrl,\r\n      images: ogImages,\r\n    },\r\n    twitter: {\r\n      card: \"summary\",\r\n      title,\r\n      description,\r\n    },\r\n    robots: {\r\n      index: true,\r\n      follow: true,\r\n    },\r\n  }\r\n}\r\n\r\n// Dynamic user-specific data component (wrapped in Suspense)\r\nasync function UserSpecificData({ \r\n  profileId, \r\n  isSeller \r\n}: { \r\n  profileId: string\r\n  isSeller: boolean \r\n}) {\r\n  const supabase = await createClient()\r\n  const { data: { user: currentUser } } = await supabase.auth.getUser()\r\n  \r\n  const isOwnProfile = currentUser?.id === profileId\r\n  \r\n  // Check if current user is following this seller\r\n  let isFollowing = false\r\n  if (currentUser && isSeller && !isOwnProfile) {\r\n    const { data: followData } = await supabase\r\n      .from(\"store_followers\")\r\n      .select(\"id\")\r\n      .eq(\"follower_id\", currentUser.id)\r\n      .eq(\"seller_id\", profileId)\r\n      .maybeSingle()\r\n    isFollowing = !!followData\r\n  }\r\n  \r\n  return { isOwnProfile, isFollowing }\r\n}\r\n\r\nexport default async function PublicProfilePage({ params }: ProfilePageProps) {\r\n  // NO connection() - uses cached getPublicProfileData function\r\n  const { username, locale } = await params\r\n  setRequestLocale(locale)\r\n\r\n  // Handle fallback from generateStaticParams (when Supabase unavailable at build)\r\n  if (username === '__fallback__') {\r\n    notFound()\r\n  }\r\n\r\n  // Fetch ALL public profile data from CACHED function (single call)\r\n  const profileData = await getPublicProfileData(username)\r\n\r\n  if (!profileData?.profile) {\r\n    notFound()\r\n  }\r\n\r\n  const { \r\n    profile, \r\n    products, \r\n    productCount, \r\n    sellerReviews, \r\n    sellerReviewCount,\r\n    buyerReviews,\r\n    buyerReviewCount \r\n  } = profileData\r\n\r\n  // Fetch user-specific data (dynamic, requires auth)\r\n  // This is the ONLY dynamic part - wrapped separately for potential streaming\r\n  const supabase = await createClient()\r\n  const { data: { user: currentUser } } = await supabase.auth.getUser()\r\n  \r\n  const isOwnProfile = currentUser?.id === profile.id\r\n  \r\n  let isFollowing = false\r\n  if (currentUser && profile.is_seller && !isOwnProfile) {\r\n    const { data: followData } = await supabase\r\n      .from(\"store_followers\")\r\n      .select(\"id\")\r\n      .eq(\"follower_id\", currentUser.id)\r\n      .eq(\"seller_id\", profile.id)\r\n      .maybeSingle()\r\n    isFollowing = !!followData\r\n  }\r\n\r\n  return (\r\n    <PublicProfileClient\r\n      profile={profile}\r\n      products={products}\r\n      productCount={productCount}\r\n      sellerReviews={sellerReviews}\r\n      sellerReviewCount={sellerReviewCount}\r\n      buyerReviews={buyerReviews}\r\n      buyerReviewCount={buyerReviewCount}\r\n      isOwnProfile={isOwnProfile}\r\n      isFollowing={isFollowing}\r\n      locale={locale}\r\n      followActions={{ followSeller, unfollowSeller }}\r\n    />\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\[username]\\profile-client.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Image' is defined but never used.","line":4,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":13,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Image"},"fix":{"range":[61,91],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Separator' is defined but never used.","line":11,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":19,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Separator"},"fix":{"range":[400,453],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ShoppingBag' is defined but never used.","line":24,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ShoppingBag"},"fix":{"range":[652,668],"text":""},"desc":"Remove unused variable \"ShoppingBag\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CheckCircle' is defined but never used.","line":25,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":25,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CheckCircle"},"fix":{"range":[668,684],"text":""},"desc":"Remove unused variable \"CheckCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Heart' is defined but never used.","line":35,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":35,"endColumn":8,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Heart"},"fix":{"range":[825,835],"text":""},"desc":"Remove unused variable \"Heart\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Verified' is defined but never used.","line":40,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":40,"endColumn":26,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Verified"},"fix":{"range":[884,912],"text":""},"desc":"Remove unused variable \"Verified\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useState } from \"react\"\r\nimport Image from \"next/image\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useLocale, useTranslations } from \"next-intl\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { IconButton } from \"@/components/ui/icon-button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport {\r\n  ProfileShell,\r\n  ProfileStats,\r\n  ProfileTabs,\r\n  ProfileSettingsPanel,\r\n  ProfileHeaderSync,\r\n} from \"@/components/shared/profile\"\r\nimport {\r\n  Star,\r\n  MapPin,\r\n  Calendar,\r\n  Package,\r\n  ShoppingBag,\r\n  CheckCircle,\r\n  Storefront,\r\n  Globe,\r\n  FacebookLogo,\r\n  InstagramLogo,\r\n  TwitterLogo,\r\n  TiktokLogo,\r\n  YoutubeLogo,\r\n  PencilSimple,\r\n  ShareNetwork,\r\n  Heart,\r\n  ArrowRight,\r\n  Gear,\r\n  ChatCircle,\r\n  Users,\r\n  CheckCircle as Verified,\r\n} from \"@phosphor-icons/react\"\r\nimport { ProductCard } from \"@/components/shared/product/product-card\"\r\nimport { FollowSellerButton, type FollowSellerActions } from \"@/components/shared/seller/follow-seller-button\"\r\nimport { SellerVerificationBadge } from \"@/components/shared/product/seller-verification-badge\"\r\nimport { UserAvatar } from \"@/components/shared/user-avatar\"\r\nimport { useAuth } from \"@/components/providers/auth-state-manager\"\r\nimport { EmptyStateCTA } from \"@/components/shared/empty-state-cta\"\r\n\r\n// =============================================================================\r\n// Types - Match the data shape from lib/data/profile-page.ts\r\n// =============================================================================\r\n\r\ninterface ProfileProduct {\r\n  id: string\r\n  title: string\r\n  slug: string | null\r\n  price: number\r\n  list_price: number | null\r\n  images: string[] | null\r\n  rating: number | null\r\n  review_count: number | null\r\n  created_at: string\r\n  is_boosted: boolean | null\r\n  seller_id: string | null\r\n  condition: string | null\r\n}\r\n\r\ninterface ReviewPerson {\r\n  username: string | null\r\n  display_name: string | null\r\n  avatar_url: string | null\r\n}\r\n\r\ninterface SellerReview {\r\n  id: string\r\n  rating: number\r\n  comment: string | null\r\n  item_as_described: boolean | null\r\n  shipping_speed: boolean | null\r\n  communication: boolean | null\r\n  created_at: string\r\n  buyer: ReviewPerson | null\r\n}\r\n\r\ninterface BuyerReview {\r\n  id: string\r\n  rating: number\r\n  comment: string | null\r\n  payment_promptness: boolean | null\r\n  communication: boolean | null\r\n  created_at: string\r\n  seller: ReviewPerson | null\r\n}\r\n\r\ninterface PublicProfileClientProps {\r\n  profile: {\r\n    id: string\r\n    username: string | null\r\n    display_name: string | null\r\n    avatar_url: string | null\r\n    banner_url: string | null\r\n    bio: string | null\r\n    account_type: string | null\r\n    tier?: string | null\r\n    is_seller: boolean | null\r\n    is_verified_business: boolean | null\r\n    verified?: boolean | null\r\n    location: string | null\r\n    business_name: string | null\r\n    website_url: string | null\r\n    social_links: Record<string, string> | null\r\n    total_sales: number\r\n    total_purchases: number\r\n    average_rating?: number | null\r\n    follower_count?: number\r\n    created_at: string | null  // nullable from cache to avoid ISR write storms\r\n  }\r\n  products: ProfileProduct[]\r\n  productCount: number\r\n  sellerReviews: SellerReview[]\r\n  sellerReviewCount: number\r\n  buyerReviews: BuyerReview[]\r\n  buyerReviewCount: number\r\n  isOwnProfile: boolean\r\n  isFollowing: boolean\r\n  locale: string\r\n  /** Actions for follow/unfollow - passed from server component */\r\n  followActions?: FollowSellerActions\r\n}\r\n\r\nfunction StarRating({ rating, count, size = \"sm\" }: { rating: number; count: number; size?: \"sm\" | \"md\" }) {\r\n  const stars = []\r\n  const fullStars = Math.floor(rating)\r\n  const hasHalf = rating % 1 >= 0.5\r\n\r\n  for (let i = 0; i < 5; i++) {\r\n    if (i < fullStars) {\r\n      stars.push(<Star key={i} weight=\"fill\" className={`text-rating ${size === \"md\" ? \"size-5\" : \"size-4\"}`} />)\r\n    } else if (i === fullStars && hasHalf) {\r\n      stars.push(<Star key={i} weight=\"duotone\" className={`text-rating ${size === \"md\" ? \"size-5\" : \"size-4\"}`} />)\r\n    } else {\r\n      stars.push(<Star key={i} weight=\"regular\" className={`text-rating-empty ${size === \"md\" ? \"size-5\" : \"size-4\"}`} />)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex items-center gap-1\">\r\n      <div className=\"flex\">{stars}</div>\r\n      <span className={`font-medium ${size === \"md\" ? \"text-base\" : \"text-sm\"}`}>{rating.toFixed(1)}</span>\r\n      <span className={`text-muted-foreground ${size === \"md\" ? \"text-sm\" : \"text-xs\"}`}>({count})</span>\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction formatTimeAgo(input: string, locale: string): string | null {\r\n  const d = new Date(input)\r\n  const ms = d.getTime()\r\n  if (!Number.isFinite(ms)) return null\r\n\r\n  const diffSeconds = Math.round((ms - Date.now()) / 1000)\r\n  const abs = Math.abs(diffSeconds)\r\n\r\n  const rtf = new Intl.RelativeTimeFormat(locale, { numeric: \"auto\", style: \"short\" })\r\n\r\n  if (abs < 60) return rtf.format(diffSeconds, \"second\")\r\n\r\n  const diffMinutes = Math.round(diffSeconds / 60)\r\n  if (Math.abs(diffMinutes) < 60) return rtf.format(diffMinutes, \"minute\")\r\n\r\n  const diffHours = Math.round(diffMinutes / 60)\r\n  if (Math.abs(diffHours) < 24) return rtf.format(diffHours, \"hour\")\r\n\r\n  const diffDays = Math.round(diffHours / 24)\r\n  if (Math.abs(diffDays) < 7) return rtf.format(diffDays, \"day\")\r\n\r\n  const diffWeeks = Math.round(diffDays / 7)\r\n  if (Math.abs(diffWeeks) < 5) return rtf.format(diffWeeks, \"week\")\r\n\r\n  const diffMonths = Math.round(diffDays / 30)\r\n  if (Math.abs(diffMonths) < 12) return rtf.format(diffMonths, \"month\")\r\n\r\n  const diffYears = Math.round(diffDays / 365)\r\n  return rtf.format(diffYears, \"year\")\r\n}\r\n\r\nexport function PublicProfileClient({\r\n  profile,\r\n  products,\r\n  productCount,\r\n  sellerReviews,\r\n  sellerReviewCount,\r\n  buyerReviews,\r\n  buyerReviewCount,\r\n  isOwnProfile,\r\n  isFollowing,\r\n  followActions,\r\n}: PublicProfileClientProps) {\r\n  const locale = useLocale()\r\n  const tProfile = useTranslations(\"ProfilePage\")\r\n  const tSeller = useTranslations(\"Seller\")\r\n  const { signOut } = useAuth()\r\n\r\n  // Avoid SSR/hydration mismatch for time-based + Intl-rendered text (React error 419 in prod).\r\n  const [isHydrated, setIsHydrated] = useState(false)\r\n  useEffect(() => {\r\n    setIsHydrated(true)\r\n  }, [])\r\n\r\n  const [activeTab, setActiveTab] = useState(profile.is_seller ? \"listings\" : \"reviews\")\r\n\r\n  const displayName = profile.display_name || profile.username || tProfile(\"user\")\r\n  // Handle nullable created_at (ISR cache optimization)\r\n  const memberSince = profile.created_at ? new Date(profile.created_at) : null\r\n\r\n  const socialIcons: Record<string, React.ReactNode> = {\r\n    facebook: <FacebookLogo className=\"size-5\" weight=\"fill\" />,\r\n    instagram: <InstagramLogo className=\"size-5\" weight=\"fill\" />,\r\n    twitter: <TwitterLogo className=\"size-5\" weight=\"fill\" />,\r\n    tiktok: <TiktokLogo className=\"size-5\" weight=\"fill\" />,\r\n    youtube: <YoutubeLogo className=\"size-5\" weight=\"fill\" />,\r\n  }\r\n\r\n  const memberSinceLabel =\r\n    isHydrated && memberSince\r\n      ? tSeller(\"memberSince\", {\r\n          date: new Intl.DateTimeFormat(locale, { month: \"long\", year: \"numeric\" }).format(memberSince),\r\n        })\r\n      : null\r\n\r\n  // Build stats for the horizontal row (Tradesphere pattern: 4 stats)\r\n  const statsItems = profile.is_seller\r\n    ? [\r\n        { value: productCount, label: tProfile(\"listings\") },\r\n        { value: profile.total_sales, label: tProfile(\"sold\") },\r\n        { value: profile.follower_count ?? 0, label: tProfile(\"followers\") },\r\n        { value: profile.total_purchases, label: tProfile(\"following\") },\r\n      ]\r\n    : [\r\n        { value: profile.total_purchases, label: tProfile(\"purchases\") },\r\n        { value: buyerReviewCount, label: tProfile(\"reviews\") },\r\n      ]\r\n\r\n  // Build tabs array\r\n  const tabs = [\r\n    // Listings tab (sellers only)\r\n    ...(profile.is_seller ? [{\r\n      value: \"listings\",\r\n      label: tProfile(\"forSale\"),\r\n      count: productCount,\r\n      icon: <Package className=\"size-4\" />,\r\n      content: (\r\n        <div className=\"px-4 py-4\">\r\n          {products.length > 0 ? (\r\n            <>\r\n              <div className=\"grid grid-cols-2 gap-3\">\r\n                {products.map((product) => (\r\n                  <ProductCard\r\n                    key={product.id}\r\n                    id={product.id}\r\n                    title={product.title}\r\n                    price={product.price}\r\n                    image={product.images?.[0] || ''}\r\n                    originalPrice={product.list_price}\r\n                    sellerId={product.seller_id}\r\n                    slug={product.slug}\r\n                    {...(product.condition ? { condition: product.condition } : {})}\r\n                    username={profile.username}\r\n                    sellerName={displayName}\r\n                    sellerAvatarUrl={profile.avatar_url}\r\n                    sellerVerified={Boolean(profile.is_verified_business)}\r\n                    sellerTier={profile.account_type === 'business' ? 'business' : (profile.tier === 'premium' ? 'premium' : 'basic')}\r\n                  />\r\n                ))}\r\n              </div>\r\n              {productCount > 12 && (\r\n                <div className=\"mt-6 flex justify-center\">\r\n                  <Link href={`/search?seller=${profile.id}`}>\r\n                    <Button variant=\"outline\" className=\"gap-2\">\r\n                      {tProfile(\"viewAll\")} ({productCount})\r\n                      <ArrowRight className=\"size-4\" />\r\n                    </Button>\r\n                  </Link>\r\n                </div>\r\n              )}\r\n            </>\r\n          ) : (\r\n            <EmptyStateCTA\r\n              variant=\"no-listings\"\r\n              title={tProfile(\"noActiveListings\")}\r\n              showCTA={Boolean(isOwnProfile)}\r\n            />\r\n          )}\r\n        </div>\r\n      ),\r\n    }] : []),\r\n\r\n    // Reviews tab\r\n    {\r\n      value: \"reviews\",\r\n      label: tProfile(\"reviews\"),\r\n      count: profile.is_seller ? sellerReviewCount : buyerReviewCount,\r\n      icon: <Star className=\"size-4\" />,\r\n      content: (\r\n        <div className=\"px-4 py-4\">\r\n          {profile.is_seller ? (\r\n            // Seller reviews\r\n            sellerReviews.length > 0 ? (\r\n              <div className=\"space-y-3\">\r\n                {sellerReviews.map((review) => (\r\n                  <Card key={review.id}>\r\n                    <CardContent className=\"p-3\">\r\n                      <div className=\"flex items-start gap-3\">\r\n                        <UserAvatar\r\n                          name={review.buyer?.display_name || review.buyer?.username || \"?\"}\r\n                          avatarUrl={review.buyer?.avatar_url ?? null}\r\n                          className=\"size-9\"\r\n                          fallbackClassName=\"text-xs\"\r\n                        />\r\n                        <div className=\"flex-1 min-w-0\">\r\n                          <div className=\"flex items-center justify-between gap-2\">\r\n                            {review.buyer?.username ? (\r\n                              <Link\r\n                                href={`/${review.buyer.username}`}\r\n                                className=\"font-medium text-sm truncate tap-transparent\"\r\n                              >\r\n                                {review.buyer.display_name || review.buyer.username}\r\n                              </Link>\r\n                            ) : (\r\n                              <span className=\"font-medium text-sm truncate\">\r\n                                {review.buyer?.display_name || tProfile(\"buyer\")}\r\n                              </span>\r\n                            )}\r\n                            <span className=\"text-xs text-muted-foreground flex-shrink-0\">\r\n                              {isHydrated ? formatTimeAgo(review.created_at, locale) ?? \"\" : \"\"}\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"mt-1\">\r\n                            <StarRating rating={review.rating} count={0} />\r\n                          </div>\r\n                          {review.comment && (\r\n                            <p className=\"mt-2 text-sm text-muted-foreground line-clamp-3\">{review.comment}</p>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                ))}\r\n              </div>\r\n            ) : (\r\n              <div className=\"py-12 text-center text-muted-foreground\">\r\n                <Star className=\"size-12 mx-auto mb-3\" />\r\n                <p>{tProfile(\"noReviewsYet\")}</p>\r\n              </div>\r\n            )\r\n          ) : (\r\n            // Buyer reviews\r\n            buyerReviews.length > 0 ? (\r\n              <div className=\"space-y-3\">\r\n                {buyerReviews.map((review) => (\r\n                  <Card key={review.id}>\r\n                    <CardContent className=\"p-3\">\r\n                      <div className=\"flex items-start gap-3\">\r\n                        <UserAvatar\r\n                          name={review.seller?.display_name || review.seller?.username || \"?\"}\r\n                          avatarUrl={review.seller?.avatar_url ?? null}\r\n                          className=\"size-9\"\r\n                          fallbackClassName=\"text-xs\"\r\n                        />\r\n                        <div className=\"flex-1 min-w-0\">\r\n                          <div className=\"flex items-center justify-between gap-2\">\r\n                            {review.seller?.username ? (\r\n                              <Link\r\n                                href={`/${review.seller.username}`}\r\n                                className=\"font-medium text-sm truncate tap-transparent\"\r\n                              >\r\n                                {review.seller.display_name || review.seller.username}\r\n                              </Link>\r\n                            ) : (\r\n                              <span className=\"font-medium text-sm truncate\">\r\n                                {review.seller?.display_name || tProfile(\"seller\")}\r\n                              </span>\r\n                            )}\r\n                            <span className=\"text-xs text-muted-foreground flex-shrink-0\">\r\n                              {isHydrated ? formatTimeAgo(review.created_at, locale) ?? \"\" : \"\"}\r\n                            </span>\r\n                          </div>\r\n                          <div className=\"mt-1\">\r\n                            <StarRating rating={review.rating} count={0} />\r\n                          </div>\r\n                          {review.comment && (\r\n                            <p className=\"mt-2 text-sm text-muted-foreground line-clamp-3\">{review.comment}</p>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                ))}\r\n              </div>\r\n            ) : (\r\n              <div className=\"py-12 text-center text-muted-foreground\">\r\n                <Star className=\"size-12 mx-auto mb-3\" />\r\n                <p>{tProfile(\"noReviewsYet\")}</p>\r\n              </div>\r\n            )\r\n          )}\r\n        </div>\r\n      ),\r\n    },\r\n\r\n    // Followers tab\r\n    {\r\n      value: \"followers\",\r\n      label: tProfile(\"followers\"),\r\n      icon: <Users className=\"size-4\" />,\r\n      content: (\r\n        <div className=\"space-y-3 pb-4\">\r\n          {(profile.follower_count ?? 0) > 0 ? (\r\n            <>\r\n              <div className=\"py-8 text-center text-muted-foreground\">\r\n                <Users className=\"size-12 mx-auto mb-3\" />\r\n                <p className=\"text-sm\">\r\n                  {tProfile(\"followersCount\", { count: profile.follower_count ?? 0 })}\r\n                </p>\r\n              </div>\r\n            </>\r\n          ) : (\r\n            <div className=\"py-12 text-center text-muted-foreground\">\r\n              <Users className=\"size-12 mx-auto mb-3\" />\r\n              <p>{tProfile(\"noFollowersYet\")}</p>\r\n            </div>\r\n          )}\r\n        </div>\r\n      ),\r\n    },\r\n\r\n    // Settings tab (own profile only)\r\n    ...(isOwnProfile ? [{\r\n      value: \"settings\",\r\n      label: tProfile(\"settings\"),\r\n      icon: <Gear className=\"size-4\" />,\r\n      content: (\r\n        <ProfileSettingsPanel\r\n          isSeller={Boolean(profile.is_seller)}\r\n          onSignOut={signOut}\r\n        />\r\n      ),\r\n    }] : []),\r\n  ]\r\n\r\n  // Header content: bio, location, badges, social\r\n  const headerContent = (\r\n    <div className=\"space-y-2\">\r\n      {/* Badges row */}\r\n      <div className=\"flex flex-wrap gap-1.5\">\r\n        {profile.account_type === \"business\" && (\r\n          <Badge variant=\"secondary\" className=\"gap-1 text-xs\">\r\n            <Storefront className=\"size-3\" />\r\n            {tProfile(\"business\")}\r\n          </Badge>\r\n        )}\r\n        {profile.is_seller && (\r\n          <Badge variant=\"success-subtle\" className=\"gap-1 text-xs\">\r\n            <Package className=\"size-3\" />\r\n            {tProfile(\"seller\")}\r\n          </Badge>\r\n        )}\r\n        <SellerVerificationBadge\r\n          variant=\"badge\"\r\n          size=\"sm\"\r\n          isVerifiedBusiness={Boolean(profile.is_verified_business)}\r\n        />\r\n      </div>\r\n\r\n      {/* Rating */}\r\n      {profile.is_seller && sellerReviewCount > 0 && profile.average_rating ? (\r\n        <StarRating rating={profile.average_rating} count={sellerReviewCount} />\r\n      ) : null}\r\n\r\n      {/* Bio */}\r\n      {profile.bio && (\r\n        <p className=\"text-sm text-muted-foreground\">{profile.bio}</p>\r\n      )}\r\n\r\n      {/* Location and member since */}\r\n      <div className=\"flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground\">\r\n        {profile.location && (\r\n          <span className=\"flex items-center gap-1\">\r\n            <MapPin className=\"size-3.5\" />\r\n            {profile.location}\r\n          </span>\r\n        )}\r\n        {memberSinceLabel && (\r\n          <span className=\"flex items-center gap-1\">\r\n            <Calendar className=\"size-3.5\" />\r\n            {memberSinceLabel}\r\n          </span>\r\n        )}\r\n      </div>\r\n\r\n      {/* Social links */}\r\n      {profile.social_links && Object.keys(profile.social_links).length > 0 && (\r\n        <div className=\"flex gap-2 pt-1\">\r\n          {profile.website_url && (\r\n            <IconButton\r\n              asChild\r\n              variant=\"outline\"\r\n              aria-label={tProfile(\"openWebsite\")}\r\n              className=\"rounded-full bg-surface-subtle\"\r\n            >\r\n              <a href={profile.website_url} target=\"_blank\" rel=\"noopener noreferrer\">\r\n                <Globe className=\"size-4\" aria-hidden=\"true\" />\r\n              </a>\r\n            </IconButton>\r\n          )}\r\n          {Object.entries(profile.social_links).map(([platform, url]) => {\r\n            if (!url) return null\r\n            return (\r\n              <IconButton\r\n                key={platform}\r\n                asChild\r\n                variant=\"outline\"\r\n                aria-label={tProfile(\"openSocial\", { platform })}\r\n                className=\"rounded-full bg-surface-subtle\"\r\n              >\r\n                <a href={url} target=\"_blank\" rel=\"noopener noreferrer\">\r\n                  <span aria-hidden=\"true\">\r\n                    {socialIcons[platform] || <Globe className=\"size-4\" />}\r\n                  </span>\r\n                </a>\r\n              </IconButton>\r\n            )\r\n          })}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n\r\n  // Action buttons (Tradesphere style: rounded-xl, side-by-side)\r\n  const handleShareProfile = async () => {\r\n    const url = typeof window !== \"undefined\" ? window.location.href : \"\"\r\n    if (!url) return\r\n\r\n    if (typeof navigator !== \"undefined\" && navigator.share) {\r\n      try {\r\n        await navigator.share({\r\n          title: displayName,\r\n          url,\r\n        })\r\n        return\r\n      } catch {\r\n        // User cancelled or share failed - silently ignore\r\n      }\r\n    }\r\n\r\n    if (typeof navigator !== \"undefined\" && navigator.clipboard) {\r\n      try {\r\n        await navigator.clipboard.writeText(url)\r\n      } catch {\r\n        // Best-effort only\r\n      }\r\n    }\r\n  }\r\n\r\n  const actions = isOwnProfile ? (\r\n    <>\r\n      <Link href=\"/account/profile\" className=\"w-full sm:flex-1 min-w-0\">\r\n        <Button className=\"w-full rounded-xl min-w-0\">\r\n          <PencilSimple className=\"size-4\" />\r\n          <span className=\"truncate\">{tProfile(\"editProfile\")}</span>\r\n        </Button>\r\n      </Link>\r\n      <Button\r\n        type=\"button\"\r\n        variant=\"secondary\"\r\n        size=\"icon\"\r\n        className=\"hidden sm:inline-flex rounded-xl\"\r\n        onClick={handleShareProfile}\r\n      >\r\n        <ShareNetwork className=\"size-4\" />\r\n      </Button>\r\n    </>\r\n  ) : (\r\n    <>\r\n      {profile.is_seller && followActions ? (\r\n        <FollowSellerButton\r\n          sellerId={profile.id}\r\n          initialIsFollowing={isFollowing}\r\n          actions={followActions}\r\n          locale={locale}\r\n          variant=\"default\"\r\n          size=\"default\"\r\n          className=\"w-full sm:flex-1 rounded-xl\"\r\n        />\r\n      ) : null}\r\n      {!isOwnProfile && (\r\n        <Link href={`/chat?to=${profile.id}`} className=\"w-full sm:flex-1 min-w-0\">\r\n          <Button variant=\"secondary\" className=\"w-full rounded-xl gap-2 min-w-0\">\r\n            <ChatCircle className=\"size-4\" />\r\n            <span className=\"truncate\">{tSeller(\"message\")}</span>\r\n          </Button>\r\n        </Link>\r\n      )}\r\n      <Button\r\n        type=\"button\"\r\n        variant=\"ghost\"\r\n        size=\"icon\"\r\n        className=\"hidden sm:inline-flex rounded-xl\"\r\n        aria-label={tProfile(\"share\")}\r\n        onClick={handleShareProfile}\r\n      >\r\n        <ShareNetwork className=\"size-5\" />\r\n      </Button>\r\n    </>\r\n  )\r\n\r\n  return (\r\n    <>\r\n      <ProfileHeaderSync\r\n        displayName={profile.display_name}\r\n        username={profile.username}\r\n        avatarUrl={profile.avatar_url}\r\n        isOwnProfile={isOwnProfile}\r\n        isFollowing={isFollowing}\r\n        sellerId={profile.id}\r\n      />\r\n      <ProfileShell\r\n        displayName={displayName}\r\n        username={profile.username}\r\n        avatarUrl={profile.avatar_url}\r\n        bannerUrl={profile.banner_url}\r\n        isVerifiedBusiness={Boolean(profile.is_verified_business)}\r\n        stats={<ProfileStats stats={statsItems} />}\r\n        actions={actions}\r\n        headerContent={headerContent}\r\n        tabs={\r\n          <ProfileTabs\r\n            tabs={tabs}\r\n            value={activeTab}\r\n            onValueChange={setActiveTab}\r\n          />\r\n        }\r\n      />\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\_components\\address-form.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\_components\\global-drawers.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\_components\\storefront-layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\_components\\storefront-shell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\_lib\\format-currency.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\_providers\\commerce-providers.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\_providers\\intl-client-provider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\api\\onboarding\\complete\\route.ts","messages":[{"ruleId":"unicorn/prefer-optional-catch-binding","severity":1,"message":"Remove unused catch binding `error`.","line":159,"column":12,"nodeType":"Identifier","messageId":"with-name","endLine":159,"endColumn":17,"fix":{"range":[5689,5697],"text":""}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":159,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":159,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { NextResponse, type NextRequest } from \"next/server\"\r\nimport { z } from \"zod\"\r\nimport { createAdminClient, createRouteHandlerClient } from \"@/lib/supabase/server\"\r\n\r\nconst optionalNonEmptyString = (schema: z.ZodString) =>\r\n  z.preprocess((value) => {\r\n    if (typeof value !== \"string\") return value\r\n    const trimmed = value.trim()\r\n    return trimmed.length === 0 ? undefined : trimmed\r\n  }, schema.optional())\r\n\r\nconst requestSchema = z.object({\r\n  username: optionalNonEmptyString(z.string().min(3).max(30)),\r\n  displayName: optionalNonEmptyString(z.string().max(50)),\r\n  businessName: optionalNonEmptyString(z.string().max(100)),\r\n  accountType: z.enum([\"personal\", \"business\"]),\r\n  category: optionalNonEmptyString(z.string().max(100)),\r\n  website: z.preprocess((value) => {\r\n    if (typeof value !== \"string\") return value\r\n    const trimmed = value.trim()\r\n    return trimmed.length === 0 ? undefined : trimmed\r\n  }, z.string().url().optional()),\r\n  location: optionalNonEmptyString(z.string().max(100)),\r\n  interests: z.array(z.string().min(1).max(50)).max(50).optional(),\r\n  avatarType: z.enum([\"custom\", \"generated\"]).optional(),\r\n  avatarVariant: z.string().optional(),\r\n  avatarPalette: z.number().int().min(0).max(50).optional(),\r\n})\r\n\r\ntype OnboardingCompleteRequest = z.infer<typeof requestSchema>\r\n\r\nexport async function POST(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ locale: string }> }\r\n) {\r\n  try {\r\n    const rawBody: unknown = await request.json()\r\n    const parsed = requestSchema.safeParse(rawBody)\r\n    if (!parsed.success) {\r\n      return NextResponse.json({ error: \"Invalid request\" }, { status: 400 })\r\n    }\r\n\r\n    const body: OnboardingCompleteRequest = parsed.data\r\n    void (await params) // Keep route signature stable for locale-prefixed API\r\n\r\n    const { supabase, applyCookies } = createRouteHandlerClient(request)\r\n    \r\n    // Get current user\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    \r\n    if (authError || !user) {\r\n      return applyCookies(\r\n        NextResponse.json(\r\n        { error: \"Unauthorized\" },\r\n        { status: 401 }\r\n      )\r\n      )\r\n    }\r\n\r\n    // Idempotency + safety: this endpoint should only be used to finish first-run onboarding.\r\n    // If a user already completed onboarding, don't let this route become a \"backdoor\" for\r\n    // changing protected/sensitive profile fields.\r\n    const { data: currentProfile, error: currentProfileError } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"onboarding_completed\")\r\n      .eq(\"id\", user.id)\r\n      .single()\r\n\r\n    if (currentProfileError) {\r\n      return applyCookies(\r\n        NextResponse.json({ error: \"Failed to load profile\" }, { status: 500 })\r\n      )\r\n    }\r\n\r\n    if (currentProfile?.onboarding_completed) {\r\n      return applyCookies(NextResponse.json({ success: true }))\r\n    }\r\n\r\n    // NOTE: `account_type` is treated as a sensitive entitlement-like field in Treido.\r\n    // Authenticated users may be restricted from updating it directly at the DB grant layer.\r\n    // Prefer the service-role client, but fall back to the authed client so onboarding can\r\n    // still complete even if the service key is not configured in the runtime.\r\n    let adminSupabase: ReturnType<typeof createAdminClient> | null = null\r\n    try {\r\n      adminSupabase = createAdminClient()\r\n    } catch {\r\n      adminSupabase = null\r\n    }\r\n\r\n    // Build profile update object (only columns that exist in `public.profiles`)\r\n    const profileUpdate: Record<string, unknown> = {\r\n      onboarding_completed: true,\r\n      updated_at: new Date().toISOString(),\r\n    }\r\n\r\n    if (adminSupabase) {\r\n      profileUpdate.account_type = body.accountType\r\n    }\r\n\r\n    if (body.username) {\r\n      profileUpdate.username = body.username\r\n    }\r\n\r\n    if (body.displayName) {\r\n      profileUpdate.display_name = body.displayName\r\n    }\r\n\r\n    if (body.location) {\r\n      profileUpdate.location = body.location\r\n    }\r\n\r\n    if (body.accountType === \"business\") {\r\n      if (body.businessName) profileUpdate.business_name = body.businessName\r\n      if (body.website) profileUpdate.website_url = body.website\r\n    }\r\n\r\n    // Update profile. Service role bypasses column grants; fallback respects grants.\r\n    //\r\n    // Important: if the service-role client is present but misconfigured (bad key / bad env),\r\n    // onboarding should still be able to complete via the authed client (without `account_type`).\r\n    // Otherwise we can deadlock users into onboarding forever.\r\n    const updateClient = adminSupabase ?? supabase\r\n    const { error: profileError } = await updateClient.from(\"profiles\").update(profileUpdate).eq(\"id\", user.id)\r\n\r\n    if (profileError && adminSupabase) {\r\n      const fallbackUpdate: Record<string, unknown> = { ...profileUpdate }\r\n      delete fallbackUpdate.account_type\r\n\r\n      const { error: fallbackError } = await supabase\r\n        .from(\"profiles\")\r\n        .update(fallbackUpdate)\r\n        .eq(\"id\", user.id)\r\n\r\n      if (!fallbackError) {\r\n        return applyCookies(NextResponse.json({ success: true }))\r\n      }\r\n    }\r\n\r\n    if (profileError) {\r\n      // Friendly conflict for username collisions (race vs availability check).\r\n      if (profileError.code === \"23505\") {\r\n        return applyCookies(\r\n          NextResponse.json(\r\n            { error: \"Username already taken\" },\r\n            { status: 409 }\r\n          )\r\n        )\r\n      }\r\n\r\n      return applyCookies(\r\n        NextResponse.json(\r\n        { error: \"Failed to update profile\" },\r\n        { status: 500 }\r\n      )\r\n      )\r\n    }\r\n\r\n    return applyCookies(NextResponse.json({ success: true }))\r\n  } catch (error) {\r\n    return NextResponse.json(\r\n      { error: \"Internal server error\" },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\locale-providers.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\[locale]\\not-found.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\actions\\blocked-users.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\actions\\boosts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\actions\\buyer-feedback.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":58,"column":39,"nodeType":"Literal","endLine":58,"endColumn":58},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":153,"column":37,"nodeType":"Literal","endLine":153,"endColumn":67},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":166,"column":40,"nodeType":"Literal","endLine":166,"endColumn":68}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { revalidateTag } from \"next/cache\"\r\n\r\n// =====================================================\r\n// BUYER FEEDBACK SERVER ACTIONS\r\n// For SELLERS to rate BUYERS after completed orders\r\n// This is the reverse of seller_feedback (buyer rates seller)\r\n// =====================================================\r\n\r\nexport interface BuyerFeedbackInput {\r\n  buyer_id: string\r\n  order_id: string\r\n  rating: number // 1-5\r\n  comment?: string\r\n  payment_promptness?: boolean // Did they pay on time?\r\n  communication?: boolean // Were they responsive?\r\n  reasonable_expectations?: boolean // Were their expectations fair?\r\n}\r\n\r\nexport interface BuyerFeedback {\r\n  id: string\r\n  seller_id: string\r\n  buyer_id: string\r\n  order_id: string | null\r\n  rating: number\r\n  comment: string | null\r\n  payment_promptness: boolean | null\r\n  communication: boolean | null\r\n  reasonable_expectations: boolean | null\r\n  seller_response: string | null\r\n  seller_response_at: string | null\r\n  created_at: string | null\r\n  updated_at: string | null\r\n  // Joined data from profiles\r\n  seller?: {\r\n    display_name: string | null\r\n    username: string | null\r\n  } | null\r\n}\r\n\r\n// =====================================================\r\n// SUBMIT BUYER FEEDBACK (Seller rates Buyer)\r\n// =====================================================\r\nexport async function submitBuyerFeedback(\r\n  input: BuyerFeedbackInput\r\n): Promise<{ success: boolean; error?: string; data?: BuyerFeedback }> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    // Get current user (must be seller)\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Verify user is a seller (has is_seller flag)\r\n    const { data: profile, error: profileError } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"id, username, is_seller\")\r\n      .eq(\"id\", user.id)\r\n      .single()\r\n\r\n    if (profileError || !profile) {\r\n      return { success: false, error: \"Profile not found\" }\r\n    }\r\n\r\n    if (!profile.is_seller) {\r\n      return { success: false, error: \"Only sellers can rate buyers\" }\r\n    }\r\n\r\n    // Verify the order exists and belongs to this seller\r\n    const { data: orderItem, error: orderError } = await supabase\r\n      .from(\"order_items\")\r\n      .select(`\r\n        id,\r\n        order_id,\r\n        seller_id,\r\n        status,\r\n        order:orders!inner(\r\n          id,\r\n          user_id,\r\n          status\r\n        )\r\n      `)\r\n      .eq(\"order_id\", input.order_id)\r\n      .eq(\"seller_id\", user.id)\r\n      .single()\r\n\r\n    if (orderError || !orderItem) {\r\n      return { success: false, error: \"Order not found or you are not the seller\" }\r\n    }\r\n\r\n    // Verify order is in a rateable state (delivered or completed)\r\n    if (![\"delivered\", \"completed\", \"shipped\"].includes(orderItem.status || \"\")) {\r\n      return { success: false, error: \"Can only rate buyers for delivered or completed orders\" }\r\n    }\r\n\r\n    // Verify buyer_id matches order user_id\r\n    const order = orderItem.order as unknown as { id: string; user_id: string; status: string }\r\n    if (order.user_id !== input.buyer_id) {\r\n      return { success: false, error: \"Buyer ID does not match order\" }\r\n    }\r\n\r\n    // Check if feedback already exists\r\n    const { data: existing } = await supabase\r\n      .from(\"buyer_feedback\")\r\n      .select(\"id\")\r\n      .eq(\"seller_id\", user.id)\r\n      .eq(\"order_id\", input.order_id)\r\n      .maybeSingle()\r\n\r\n    if (existing) {\r\n      return { success: false, error: \"You have already rated this buyer for this order\" }\r\n    }\r\n\r\n    // Validate rating\r\n    if (input.rating < 1 || input.rating > 5) {\r\n      return { success: false, error: \"Rating must be between 1 and 5\" }\r\n    }\r\n\r\n    // Insert feedback\r\n    const { data, error } = await supabase\n      .from(\"buyer_feedback\")\n      .insert({\n        seller_id: user.id,\n        buyer_id: input.buyer_id,\n        order_id: input.order_id,\n        rating: input.rating,\n        comment: input.comment || null,\n        payment_promptness: input.payment_promptness ?? true,\n        communication: input.communication ?? true,\n        reasonable_expectations: input.reasonable_expectations ?? true,\n      })\n      .select(\"id, seller_id, buyer_id, order_id, rating, comment, payment_promptness, communication, reasonable_expectations, seller_response, seller_response_at, created_at, updated_at\")\n      .single()\n\r\n    if (error) {\r\n      console.error(\"Error submitting buyer feedback:\", error)\r\n      return { success: false, error: \"Failed to submit feedback\" }\r\n    }\r\n\r\n    revalidateTag(\"buyer-stats\", \"max\")\r\n    revalidateTag(\"orders\", \"max\")\r\n\r\n    return { success: true, data: data as unknown as BuyerFeedback }\r\n  } catch (error) {\r\n    console.error(\"submitBuyerFeedback error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// CHECK IF SELLER CAN RATE BUYER\r\n// =====================================================\r\nexport async function canSellerRateBuyer(\r\n  orderId: string\r\n): Promise<{ canRate: boolean; reason?: string; buyerId?: string }> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { canRate: false, reason: \"Database connection failed\" }\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) {\r\n      return { canRate: false, reason: \"Not authenticated\" }\r\n    }\r\n\r\n    // Check if user is seller and has this order\r\n    const { data: orderItem, error } = await supabase\r\n      .from(\"order_items\")\r\n      .select(`\r\n        id,\r\n        status,\r\n        order:orders!inner(\r\n          id,\r\n          user_id\r\n        )\r\n      `)\r\n      .eq(\"order_id\", orderId)\r\n      .eq(\"seller_id\", user.id)\r\n      .single()\r\n\r\n    if (error || !orderItem) {\r\n      return { canRate: false, reason: \"Order not found\" }\r\n    }\r\n\r\n    // Check order status\r\n    if (![\"delivered\", \"completed\", \"shipped\"].includes(orderItem.status || \"\")) {\r\n      return { canRate: false, reason: \"Order must be delivered before rating\" }\r\n    }\r\n\r\n    // Check if already rated\r\n    const { data: existing } = await supabase\r\n      .from(\"buyer_feedback\")\r\n      .select(\"id\")\r\n      .eq(\"seller_id\", user.id)\r\n      .eq(\"order_id\", orderId)\r\n      .maybeSingle()\r\n\r\n    if (existing) {\r\n      return { canRate: false, reason: \"Already rated this buyer\" }\r\n    }\r\n\r\n    const order = orderItem.order as unknown as { id: string; user_id: string }\r\n    return { canRate: true, buyerId: order.user_id }\r\n  } catch (error) {\r\n    console.error(\"canSellerRateBuyer error:\", error)\r\n    return { canRate: false, reason: \"Error checking rating status\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// GET BUYER'S RECEIVED RATINGS (for /account/ratings page)\r\n// =====================================================\r\nexport async function getBuyerReceivedRatings(\r\n  options?: {\r\n    limit?: number\r\n    offset?: number\r\n  }\r\n): Promise<{\r\n  success: boolean\r\n  data?: BuyerFeedback[]\r\n  total?: number\r\n  averageRating?: number\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    const limit = options?.limit || 20\r\n    const offset = options?.offset || 0\r\n\r\n    // Get feedback received\r\n    const { data, error, count } = await supabase\n      .from(\"buyer_feedback\")\n      .select(`\n        id,\n        seller_id,\n        buyer_id,\n        order_id,\n        rating,\n        comment,\n        payment_promptness,\n        communication,\n        reasonable_expectations,\n        seller_response,\n        seller_response_at,\n        created_at,\n        updated_at,\n        seller:profiles!buyer_feedback_seller_id_fkey(\n          display_name,\n          username\n        )\n      `, { count: \"exact\" })\n      .eq(\"buyer_id\", user.id)\r\n      .order(\"created_at\", { ascending: false })\r\n      .range(offset, offset + limit - 1)\r\n\r\n    if (error) {\r\n      console.error(\"getBuyerReceivedRatings error:\", error)\r\n      return { success: false, error: \"Failed to fetch ratings\" }\r\n    }\r\n\r\n    // Get buyer stats for average\r\n    const { data: stats } = await supabase\r\n      .from(\"buyer_stats\")\r\n      .select(\"average_rating\")\r\n      .eq(\"user_id\", user.id)\r\n      .single()\r\n\r\n    return {\r\n      success: true,\r\n      data: (data || []) as unknown as BuyerFeedback[],\r\n      total: count || 0,\r\n      averageRating: Number(stats?.average_rating) || 0,\r\n    }\r\n  } catch (error) {\r\n    console.error(\"getBuyerReceivedRatings error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// GET FEEDBACK FOR A SPECIFIC BUYER (public view)\r\n// =====================================================\r\nexport async function getPublicBuyerFeedback(\r\n  buyerId: string,\r\n  options?: { limit?: number; offset?: number }\r\n): Promise<{\r\n  success: boolean\r\n  data?: BuyerFeedback[]\r\n  stats?: {\r\n    averageRating: number\r\n    totalRatings: number\r\n    positivePercentage: number\r\n  }\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    const limit = options?.limit || 10\r\n    const offset = options?.offset || 0\r\n\r\n    // Get feedback\r\n    const { data, error } = await supabase\r\n      .from(\"buyer_feedback\")\r\n      .select(`\r\n        id,\r\n        rating,\r\n        comment,\r\n        payment_promptness,\r\n        communication,\r\n        reasonable_expectations,\r\n        created_at,\r\n        seller:profiles!buyer_feedback_seller_id_fkey(\r\n          display_name,\r\n          username\r\n        )\r\n      `)\r\n      .eq(\"buyer_id\", buyerId)\r\n      .order(\"created_at\", { ascending: false })\r\n      .range(offset, offset + limit - 1)\r\n\r\n    if (error) {\r\n      console.error(\"getPublicBuyerFeedback error:\", error)\r\n      return { success: false, error: \"Failed to fetch feedback\" }\r\n    }\r\n\r\n    // Get stats\r\n    const { data: stats } = await supabase\r\n      .from(\"buyer_stats\")\r\n      .select(\"average_rating, total_ratings\")\r\n      .eq(\"user_id\", buyerId)\r\n      .single()\r\n\r\n    // Calculate positive percentage (ratings >= 4)\r\n    const { count: positiveCount } = await supabase\r\n      .from(\"buyer_feedback\")\r\n      .select(\"id\", { count: \"exact\", head: true })\r\n      .eq(\"buyer_id\", buyerId)\r\n      .gte(\"rating\", 4)\r\n\r\n    const positivePercentage = stats?.total_ratings && stats.total_ratings > 0\r\n      ? Math.round(((positiveCount || 0) / stats.total_ratings) * 100)\r\n      : 0\r\n\r\n    return {\r\n      success: true,\r\n      data: (data || []) as unknown as BuyerFeedback[],\r\n      stats: {\r\n        averageRating: Number(stats?.average_rating) || 0,\r\n        totalRatings: stats?.total_ratings || 0,\r\n        positivePercentage,\r\n      },\r\n    }\r\n  } catch (error) {\r\n    console.error(\"getPublicBuyerFeedback error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// GET FEEDBACK SELLER LEFT FOR BUYERS (seller dashboard)\r\n// =====================================================\r\nexport async function getSellerGivenFeedback(\r\n  options?: { limit?: number; offset?: number }\r\n): Promise<{\r\n  success: boolean\r\n  data?: (BuyerFeedback & { buyer_profile?: { full_name: string | null; avatar_url: string | null } })[]\r\n  total?: number\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    const limit = options?.limit || 20\r\n    const offset = options?.offset || 0\r\n\r\n    const { data, error, count } = await supabase\n      .from(\"buyer_feedback\")\n      .select(`\n        id,\n        seller_id,\n        buyer_id,\n        order_id,\n        rating,\n        comment,\n        payment_promptness,\n        communication,\n        reasonable_expectations,\n        seller_response,\n        seller_response_at,\n        created_at,\n        updated_at,\n        buyer_profile:profiles!buyer_feedback_buyer_id_fkey(\n          full_name,\n          avatar_url\n        )\n      `, { count: \"exact\" })\n      .eq(\"seller_id\", user.id)\r\n      .order(\"created_at\", { ascending: false })\r\n      .range(offset, offset + limit - 1)\r\n\r\n    if (error) {\r\n      console.error(\"getSellerGivenFeedback error:\", error)\r\n      return { success: false, error: \"Failed to fetch feedback\" }\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: (data || []) as unknown as (BuyerFeedback & { buyer_profile?: { full_name: string | null; avatar_url: string | null } })[],\r\n      total: count || 0,\r\n    }\r\n  } catch (error) {\r\n    console.error(\"getSellerGivenFeedback error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// UPDATE BUYER FEEDBACK (edit within time window)\r\n// =====================================================\r\nexport async function updateBuyerFeedback(\r\n  feedbackId: string,\r\n  updates: Partial<Pick<BuyerFeedbackInput, \"rating\" | \"comment\" | \"payment_promptness\" | \"communication\" | \"reasonable_expectations\">>\r\n): Promise<{ success: boolean; error?: string }> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Verify ownership and check time window (7 days)\r\n    const { data: existing, error: fetchError } = await supabase\r\n      .from(\"buyer_feedback\")\r\n      .select(\"id, seller_id, buyer_id, created_at\")\r\n      .eq(\"id\", feedbackId)\r\n      .eq(\"seller_id\", user.id)\r\n      .single()\r\n\r\n    if (fetchError || !existing) {\r\n      return { success: false, error: \"Feedback not found or access denied\" }\r\n    }\r\n\r\n    // Check 7-day edit window\r\n    const createdAt = new Date(existing.created_at || Date.now())\r\n    const now = new Date()\r\n    const daysSinceCreation = (now.getTime() - createdAt.getTime()) / (1000 * 60 * 60 * 24)\r\n\r\n    if (daysSinceCreation > 7) {\r\n      return { success: false, error: \"Edit window expired (7 days)\" }\r\n    }\r\n\r\n    // Validate rating if provided\r\n    if (updates.rating !== undefined && (updates.rating < 1 || updates.rating > 5)) {\r\n      return { success: false, error: \"Rating must be between 1 and 5\" }\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from(\"buyer_feedback\")\r\n      .update({\r\n        ...updates,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", feedbackId)\r\n\r\n    if (error) {\r\n      console.error(\"updateBuyerFeedback error:\", error)\r\n      return { success: false, error: \"Failed to update feedback\" }\r\n    }\r\n\r\n    revalidateTag(\"buyer-stats\", \"max\")\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"updateBuyerFeedback error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// DELETE BUYER FEEDBACK\r\n// =====================================================\r\nexport async function deleteBuyerFeedback(\r\n  feedbackId: string\r\n): Promise<{ success: boolean; error?: string }> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Verify ownership\r\n    const { error } = await supabase\r\n      .from(\"buyer_feedback\")\r\n      .delete()\r\n      .eq(\"id\", feedbackId)\r\n      .eq(\"seller_id\", user.id)\r\n\r\n    if (error) {\r\n      console.error(\"deleteBuyerFeedback error:\", error)\r\n      return { success: false, error: \"Failed to delete feedback\" }\r\n    }\r\n\r\n    revalidateTag(\"buyer-stats\", \"max\")\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"deleteBuyerFeedback error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\actions\\onboarding.ts","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 28 to the 25 allowed.","line":34,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":34,"endColumn":51}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { z } from \"zod\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\n\r\nexport interface OnboardingData {\r\n  userId: string\r\n  accountType: \"personal\" | \"business\" | null\r\n  displayName: string | null\r\n  bio: string | null\r\n  businessName: string | null\r\n  website: string | null\r\n  location: string | null\r\n  socialLinks: Record<string, string> | null\r\n  avatarType: \"custom\" | \"generated\"\r\n  avatarVariant?: string | undefined\r\n  avatarPalette?: number | undefined\r\n}\r\n\r\nconst onboardingSchema = z.object({\r\n  userId: z.string().uuid(),\r\n  accountType: z.enum([\"personal\", \"business\"]).nullable(),\r\n  displayName: z.string().max(50).nullable(),\r\n  bio: z.string().max(160).nullable(),\r\n  businessName: z.string().max(100).nullable(),\r\n  website: z.string().url().nullable().or(z.literal(\"\")).transform(v => v || null),\r\n  location: z.string().max(100).nullable(),\r\n  socialLinks: z.record(z.string(), z.string()).nullable(),\r\n  avatarType: z.enum([\"custom\", \"generated\"]),\r\n  avatarVariant: z.string().optional(),\r\n  avatarPalette: z.number().optional(),\r\n})\r\n\r\nexport async function completePostSignupOnboarding(\r\n  data: OnboardingData,\r\n  avatarFile: File | null,\r\n  coverFile: File | null\r\n): Promise<{ success: boolean; error?: string }> {\r\n  const parsed = onboardingSchema.safeParse(data)\r\n  \r\n  if (!parsed.success) {\r\n    console.error(\"Onboarding validation error:\", parsed.error)\r\n    return { success: false, error: \"Invalid data provided\" }\r\n  }\r\n\r\n  const {\r\n    userId,\r\n    accountType,\r\n    displayName,\r\n    bio,\r\n    businessName,\r\n    website,\r\n    location,\r\n    socialLinks,\r\n    avatarType,\r\n    avatarVariant,\r\n    avatarPalette,\r\n  } = parsed.data\r\n\r\n  const supabase = await createClient()\r\n\r\n  // Verify the user is authenticated and matches\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n  \r\n  if (authError || !user) {\r\n    return { success: false, error: \"Unauthorized\" }\r\n  }\r\n\r\n  if (user.id !== userId) {\r\n    return { success: false, error: \"Forbidden\" }\r\n  }\r\n\r\n  // Get current profile for username (needed for avatar generation)\r\n  const { data: profile } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"username\")\r\n    .eq(\"id\", userId)\r\n    .single()\r\n\r\n  const username = profile?.username || \"user\"\r\n\r\n  // Upload avatar if custom\r\n  let avatarUrl: string | null = null\r\n  if (avatarType === \"custom\" && avatarFile) {\r\n    const fileExt = avatarFile.name.split(\".\").pop()\r\n    const fileName = `${userId}-avatar-${Date.now()}.${fileExt}`\r\n    const filePath = `${userId}/${fileName}`\r\n\r\n    const { error: uploadError, data: uploadData } = await supabase.storage\r\n      .from(\"avatars\")\r\n      .upload(filePath, avatarFile, { upsert: true })\r\n\r\n    if (!uploadError && uploadData) {\r\n      const { data: { publicUrl } } = supabase.storage.from(\"avatars\").getPublicUrl(filePath)\r\n      avatarUrl = publicUrl\r\n    }\r\n  } else if (avatarType === \"generated\" && avatarVariant !== undefined) {\r\n    // Store as a special format that can be parsed by the avatar component\r\n    avatarUrl = `boring-avatar:${avatarVariant}:${avatarPalette ?? 0}:${username}`\r\n  }\r\n\r\n  // Upload cover image if provided (business only)\r\n  let bannerUrl: string | null = null\r\n  if (coverFile && accountType === \"business\") {\r\n    const fileExt = coverFile.name.split(\".\").pop()\r\n    const fileName = `${userId}-banner-${Date.now()}.${fileExt}`\r\n    const filePath = `${userId}/${fileName}`\r\n\r\n    const { error: uploadError, data: uploadData } = await supabase.storage\r\n      .from(\"avatars\") // Using same bucket for simplicity\r\n      .upload(filePath, coverFile, { upsert: true })\r\n\r\n    if (!uploadError && uploadData) {\r\n      const { data: { publicUrl } } = supabase.storage.from(\"avatars\").getPublicUrl(filePath)\r\n      bannerUrl = publicUrl\r\n    }\r\n  }\r\n\r\n  // Build update object - simplified without intent, just update profile\r\n  const updateData: Record<string, unknown> = {\r\n    onboarding_completed: true,\r\n    updated_at: new Date().toISOString(),\r\n  }\r\n\r\n  // Only update if values are provided\r\n  if (displayName) updateData.display_name = displayName\r\n  if (bio) updateData.bio = bio\r\n  if (avatarUrl) updateData.avatar_url = avatarUrl\r\n  if (bannerUrl) updateData.banner_url = bannerUrl\r\n  if (location) updateData.location = location\r\n  \r\n  // Business account-specific updates\r\n  if (accountType === \"business\") {\r\n    if (businessName) updateData.business_name = businessName\r\n    if (website) updateData.website_url = website\r\n  }\r\n  \r\n  // Social links for all account types\r\n  if (socialLinks && Object.keys(socialLinks).length > 0) {\r\n    updateData.social_links = socialLinks\r\n  }\r\n\r\n  // Update profile with authed client (RLS enforces ownership)\r\n  const { error: updateError } = await supabase\r\n    .from(\"profiles\")\r\n    .update(updateData)\r\n    .eq(\"id\", userId)\r\n\r\n  if (updateError) {\r\n    console.error(\"Profile update error:\", updateError)\r\n    return { success: false, error: \"Failed to update profile\" }\r\n  }\r\n\r\n  return { success: true }\r\n}\r\n\r\n/**\r\n * Check if a user needs to complete onboarding\r\n */\r\nexport async function checkOnboardingStatus(userId: string): Promise<{\r\n  needsOnboarding: boolean\r\n  profile: {\r\n    username: string | null\r\n    displayName: string | null\r\n    onboardingCompleted: boolean\r\n  } | null\r\n}> {\r\n  const supabase = await createClient()\r\n\r\n  const { data: rawProfile, error } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"username, display_name, onboarding_completed\")\r\n    .eq(\"id\", userId)\r\n    .single()\r\n\r\n  if (error || !rawProfile) {\r\n    return { needsOnboarding: false, profile: null }\r\n  }\r\n\r\n  return {\r\n    needsOnboarding: !rawProfile.onboarding_completed,\r\n    profile: {\r\n      username: rawProfile.username ?? null,\r\n      displayName: rawProfile.display_name ?? null,\r\n      onboardingCompleted: rawProfile.onboarding_completed ?? false,\r\n    },\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\actions\\orders.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 9 times.","line":106,"column":39,"nodeType":"Literal","endLine":106,"endColumn":70},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 9 times.","line":112,"column":39,"nodeType":"Literal","endLine":112,"endColumn":58},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 5 times.","line":124,"column":39,"nodeType":"Literal","endLine":124,"endColumn":61},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 8 times.","line":173,"column":37,"nodeType":"Literal","endLine":173,"endColumn":67},{"ruleId":"prefer-const","severity":2,"message":"'buyersMap' is never reassigned. Use 'const' instead.","line":217,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":217,"endColumn":18,"fix":{"range":[5945,6047],"text":"const buyersMap = new Map<string, { id: string; full_name: string | null; avatar_url: string | null }>()"}},{"ruleId":"unicorn/no-useless-undefined","severity":1,"message":"Do not use useless `undefined`.","line":235,"column":42,"nodeType":"Identifier","messageId":"no-useless-undefined","endLine":235,"endColumn":51,"fix":{"range":[6576,6586],"text":""}},{"ruleId":"sonarjs/no-unused-collection","severity":1,"message":"Either use this collection's contents or remove the collection.","line":359,"column":11,"nodeType":"Identifier","messageId":"unusedCollection","endLine":359,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_sellerId' is defined but never used.","line":389,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":389,"endColumn":12},{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":815,"column":60,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":815,"endColumn":73},{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":907,"column":78,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":907,"endColumn":109}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":1,"fixableWarningCount":1,"source":"\"use server\"\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { revalidateTag } from \"next/cache\"\r\nimport type { OrderItemStatus, ShippingCarrier } from \"@/lib/order-status\"\r\n\r\n// =====================================================\r\n// ORDER MANAGEMENT SERVER ACTIONS\r\n// For sellers to manage their incoming orders\r\n// =====================================================\r\n\r\nexport interface OrderItem {\n  id: string\n  order_id: string\n  product_id: string\n  seller_id: string\r\n  quantity: number\r\n  price_at_purchase: number\r\n  status: OrderItemStatus\r\n  seller_received_at: string | null\r\n  shipped_at: string | null\r\n  delivered_at: string | null\r\n  tracking_number: string | null\r\n  shipping_carrier: string | null\r\n  created_at: string\r\n  // Joined data\r\n  product?: {\r\n    id: string\r\n    title: string\r\n    images: string[]\r\n    slug: string\r\n  }\r\n  order?: {\r\n    id: string\r\n    user_id: string\r\n    total_amount: number\r\n    status: string\r\n    shipping_address: {\r\n      name?: string\r\n      email?: string\r\n      address?: {\r\n        line1?: string\r\n        line2?: string\r\n        city?: string\r\n        state?: string\r\n        postal_code?: string\r\n        country?: string\r\n      }\r\n    } | null\r\n    created_at: string\r\n  }\r\n  buyer?: {\n    id: string\n    full_name: string | null\n    email: string | null\n    avatar_url: string | null\n  }\n}\n\nconst ORDER_ITEM_LIST_SELECT = `\n  id,\n  order_id,\n  product_id,\n  seller_id,\n  quantity,\n  price_at_purchase,\n  status,\n  seller_received_at,\n  shipped_at,\n  delivered_at,\n  tracking_number,\n  shipping_carrier,\n  product:products(id, title, images, slug),\n  order:orders(id, user_id, total_amount, status, shipping_address, created_at)\n`\n\nconst ORDER_ITEM_DETAIL_SELECT = `\n  id,\n  order_id,\n  product_id,\n  seller_id,\n  quantity,\n  price_at_purchase,\n  status,\n  seller_received_at,\n  shipped_at,\n  delivered_at,\n  tracking_number,\n  shipping_carrier,\n  product:products(id, title, images, slug),\n  seller:profiles!order_items_seller_id_fkey(id, full_name, avatar_url, username)\n`\n\n/**\n * Update the status of an order item (seller only)\n */\nexport async function updateOrderItemStatus(\n  orderItemId: string,\r\n  newStatus: OrderItemStatus,\r\n  trackingNumber?: string,\r\n  shippingCarrier?: ShippingCarrier\r\n): Promise<{ success: boolean; error?: string }> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    // Verify user is authenticated and is the seller\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Fetch existing timestamps so we don't clobber them.\r\n    const { data: existingItem, error: existingError } = await supabase\r\n      .from(\"order_items\")\r\n      .select(\"id, seller_id, seller_received_at, shipped_at, delivered_at\")\r\n      .eq(\"id\", orderItemId)\r\n      .eq(\"seller_id\", user.id)\r\n      .single()\r\n\r\n    if (existingError || !existingItem) {\r\n      return { success: false, error: \"Order item not found\" }\r\n    }\r\n\r\n    // Build update payload\r\n    const updateData: Record<string, unknown> = { status: newStatus }\r\n\r\n    const now = new Date().toISOString()\r\n\r\n    if (newStatus === \"received\" && !existingItem.seller_received_at) {\r\n      updateData.seller_received_at = now\r\n    }\r\n\r\n    if (newStatus === \"shipped\" && !existingItem.shipped_at) {\r\n      updateData.shipped_at = now\r\n    }\r\n\r\n    if (newStatus === \"delivered\" && !existingItem.delivered_at) {\r\n      updateData.delivered_at = now\r\n    }\r\n    \r\n    // Add tracking info if shipping\r\n    if (newStatus === 'shipped') {\r\n      if (trackingNumber) {\r\n        updateData.tracking_number = trackingNumber\r\n      }\r\n      if (shippingCarrier) {\r\n        updateData.shipping_carrier = shippingCarrier\r\n      }\r\n    }\r\n\r\n    // Update the order item (RLS will verify seller_id)\r\n    const { error: updateError } = await supabase\r\n      .from('order_items')\r\n      .update(updateData)\r\n      .eq('id', orderItemId)\r\n      .eq('seller_id', user.id) // Extra safety check\r\n\r\n    if (updateError) {\r\n      console.error('Error updating order item status:', updateError)\r\n      return { success: false, error: \"Failed to update order status\" }\r\n    }\r\n\r\n    revalidateTag('orders', \"max\")\r\n    revalidateTag('messages', \"max\")\r\n    revalidateTag('conversations', \"max\")\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error('Error in updateOrderItemStatus:', error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Get all order items for the current seller\r\n */\r\nexport async function getSellerOrders(\n  statusFilter?: OrderItemStatus | 'all'\n): Promise<{ orders: OrderItem[]; error?: string }> {\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { orders: [], error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { orders: [], error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Build query\n    let query = supabase\n      .from('order_items')\n      .select(ORDER_ITEM_LIST_SELECT)\n      .eq('seller_id', user.id)\n      .order('created_at', { ascending: false, foreignTable: 'orders' })\n      .limit(200)\n\r\n    // Apply status filter\r\n    if (statusFilter && statusFilter !== 'all') {\r\n      query = query.eq('status', statusFilter)\r\n    }\r\n\r\n    const { data: orderItems, error: fetchError } = await query\r\n\r\n    if (fetchError) {\r\n      console.error('Error fetching seller orders:', fetchError)\r\n      return { orders: [], error: \"Failed to fetch orders\" }\r\n    }\r\n\r\n    // Get buyer profiles for each unique buyer\r\n    const buyerIds = [...new Set(orderItems?.map(item => item.order?.user_id).filter(Boolean))]\r\n    \r\n    let buyersMap = new Map<string, { id: string; full_name: string | null; avatar_url: string | null }>()\n    \r\n    if (buyerIds.length > 0) {\n      const { data: buyers } = await supabase\n        .from('profiles')\n        .select('id, full_name, avatar_url')\n        .in('id', buyerIds)\n\n      buyers?.forEach(buyer => {\n        buyersMap.set(buyer.id, buyer)\n      })\n    }\n\r\n    // Attach buyer info to each order item\n    const ordersWithBuyers = (orderItems ?? []).map((item) => ({\n      ...item,\n      created_at: item.order?.created_at ?? new Date().toISOString(),\n      buyer: (() => {\n        if (!item.order?.user_id) return undefined\n\n        const base = buyersMap.get(item.order.user_id)\n        const shippingAddress = item.order?.shipping_address\n        const email =\n          shippingAddress &&\n          typeof shippingAddress === 'object' &&\n          !Array.isArray(shippingAddress) &&\n          typeof (shippingAddress as { email?: unknown }).email === 'string'\n            ? (shippingAddress as { email: string }).email\n            : null\n\n        return {\n          id: item.order.user_id,\n          full_name: base?.full_name ?? null,\n          email,\n          avatar_url: base?.avatar_url ?? null,\n        }\n      })(),\n    }))\n\r\n    return { orders: ordersWithBuyers as OrderItem[] }\r\n  } catch (error) {\r\n    console.error('Error in getSellerOrders:', error)\r\n    return { orders: [], error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Get order counts by status for dashboard stats\r\n */\r\nexport async function getSellerOrderStats(): Promise<{\r\n  pending: number\r\n  received: number\r\n  processing: number\r\n  shipped: number\r\n  delivered: number\r\n  cancelled: number\r\n  total: number\r\n}> {\r\n  const defaultStats = {\r\n    pending: 0,\r\n    received: 0,\r\n    processing: 0,\r\n    shipped: 0,\r\n    delivered: 0,\r\n    cancelled: 0,\r\n    total: 0\r\n  }\r\n\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) return defaultStats\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) return defaultStats\r\n\r\n    const { data: orderItems } = await supabase\r\n      .from('order_items')\r\n      .select('status')\r\n      .eq('seller_id', user.id)\r\n\r\n    if (!orderItems) return defaultStats\r\n\r\n    const stats = { ...defaultStats }\r\n    orderItems.forEach(item => {\r\n      const status = item.status as OrderItemStatus\r\n      if (status in stats) {\r\n        stats[status]++\r\n      }\r\n      stats.total++\r\n    })\r\n\r\n    return stats\r\n  } catch {\r\n    return defaultStats\r\n  }\r\n}\r\n\r\n/**\r\n * Get all orders for the current buyer\r\n */\r\nexport async function getBuyerOrders(): Promise<{ orders: OrderItem[]; error?: string }> {\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { orders: [], error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { orders: [], error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Get orders for current user\r\n    const { data: orders, error: ordersError } = await supabase\r\n      .from('orders')\r\n      .select('id')\r\n      .eq('user_id', user.id)\r\n\r\n    if (ordersError) {\r\n      return { orders: [], error: \"Failed to fetch orders\" }\r\n    }\r\n\r\n    const orderIds = orders?.map(o => o.id) || []\r\n    if (orderIds.length === 0) {\r\n      return { orders: [] }\r\n    }\r\n\r\n    // Get order items with product and seller info\n    const { data: orderItems, error: itemsError } = await supabase\n      .from('order_items')\n      .select(ORDER_ITEM_LIST_SELECT)\n      .in('order_id', orderIds)\n      .order('created_at', { ascending: false, foreignTable: 'orders' })\n      .limit(200)\n\r\n    if (itemsError) {\r\n      return { orders: [], error: \"Failed to fetch order items\" }\r\n    }\r\n\r\n    // Get seller profiles\r\n    const sellerIds = [...new Set(orderItems?.map(item => item.seller_id).filter(Boolean))]\r\n\r\n    const sellersMap = new Map<string, { id: string; full_name: string | null; avatar_url: string | null }>()\r\n\r\n    if (sellerIds.length > 0) {\r\n      const { data: sellers } = await supabase\r\n        .from('profiles')\r\n        .select('id, full_name, avatar_url')\r\n        .in('id', sellerIds)\r\n\r\n      sellers?.forEach((seller) => {\r\n        sellersMap.set(seller.id, seller)\r\n      })\r\n    }\r\n\r\n    const itemsWithCreatedAt = (orderItems ?? []).map((item) => ({\r\n      ...item,\r\n      created_at: item.order?.created_at ?? new Date().toISOString(),\r\n    }))\r\n\r\n    return { orders: itemsWithCreatedAt as OrderItem[] }\r\n  } catch (error) {\r\n    console.error('Error in getBuyerOrders:', error)\r\n    return { orders: [], error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Get conversation ID for an order item (to link to chat)\r\n */\r\nexport async function getOrderConversation(\r\n  orderId: string,\r\n  _sellerId: string\r\n): Promise<{ conversationId: string | null; error?: string }> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { conversationId: null, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) {\r\n      return { conversationId: null, error: \"Not authenticated\" }\r\n    }\r\n\r\n    const { data: conversation } = await supabase\r\n      .from('conversations')\r\n      .select('id')\r\n      .eq('order_id', orderId)\r\n      .or(`buyer_id.eq.${user.id},seller_id.eq.${user.id}`)\r\n      .single()\r\n\r\n    return { conversationId: conversation?.id || null }\r\n  } catch {\r\n    return { conversationId: null }\r\n  }\r\n}\r\n\r\n/**\r\n * Buyer confirms delivery of an order item\r\n * This allows the buyer to mark an item as delivered once they receive it\r\n */\r\nexport async function buyerConfirmDelivery(\r\n  orderItemId: string\r\n): Promise<{ success: boolean; error?: string; sellerId?: string }> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // First verify this order item belongs to an order by this user\r\n    const { data: orderItem, error: fetchError } = await supabase\r\n      .from('order_items')\r\n      .select(`\r\n        id,\r\n        status,\r\n        seller_id,\r\n        order:orders!inner(user_id)\r\n      `)\r\n      .eq('id', orderItemId)\r\n      .single<{\r\n        id: string\r\n        status: string\r\n        seller_id: string\r\n        order: { user_id: string }\r\n      }>()\r\n\r\n    if (fetchError || !orderItem) {\r\n      return { success: false, error: \"Order item not found\" }\r\n    }\r\n\r\n    // Verify the user owns this order\r\n    if (orderItem.order.user_id !== user.id) {\r\n      return { success: false, error: \"Not authorized to update this order\" }\r\n    }\r\n\r\n    // Only allow confirmation if status is 'shipped'\r\n    if (orderItem.status !== 'shipped') {\r\n      return { \r\n        success: false, \r\n        error: orderItem.status === 'delivered' \r\n          ? \"Order already marked as delivered\" \r\n          : \"Order must be shipped before confirming delivery\"\r\n      }\r\n    }\r\n\r\n    // Update status to delivered\r\n    const { error: updateError } = await supabase\r\n      .from('order_items')\r\n      .update({ \r\n        status: 'delivered',\r\n        delivered_at: new Date().toISOString()\r\n      })\r\n      .eq('id', orderItemId)\r\n\r\n    if (updateError) {\r\n      console.error('Error confirming delivery:', updateError)\r\n      return { success: false, error: \"Failed to confirm delivery\" }\r\n    }\r\n\r\n    revalidateTag('orders', \"max\")\r\n\r\n    return { success: true, sellerId: orderItem.seller_id }\r\n  } catch (error) {\r\n    console.error('Error in buyerConfirmDelivery:', error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Check if buyer can leave feedback for a seller after delivery\r\n */\r\nexport async function canBuyerRateSeller(\r\n  orderItemId: string\r\n): Promise<{ canRate: boolean; hasRated: boolean; sellerId?: string }> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { canRate: false, hasRated: false }\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) {\r\n      return { canRate: false, hasRated: false }\r\n    }\r\n\r\n    // Get order item with order info\r\n    const { data: orderItem } = await supabase\r\n      .from('order_items')\r\n      .select(`\r\n        id,\r\n        status,\r\n        seller_id,\r\n        order_id,\r\n        order:orders!inner(user_id)\r\n      `)\r\n      .eq('id', orderItemId)\r\n      .single<{\r\n        id: string\r\n        status: string | null\r\n        seller_id: string\r\n        order_id: string\r\n        order: { user_id: string }\r\n      }>()\r\n\r\n    if (!orderItem) {\r\n      return { canRate: false, hasRated: false }\r\n    }\r\n\r\n    if (orderItem.order.user_id !== user.id) {\r\n      return { canRate: false, hasRated: false }\r\n    }\r\n\r\n    // Must be delivered to rate\r\n    if (orderItem.status !== 'delivered') {\r\n      return { canRate: false, hasRated: false, sellerId: orderItem.seller_id }\r\n    }\r\n\r\n    // Check if already rated\r\n    const { data: existingFeedback } = await supabase\r\n      .from('seller_feedback')\r\n      .select('id')\r\n      .eq('buyer_id', user.id)\r\n      .eq('seller_id', orderItem.seller_id)\r\n      .eq('order_id', orderItem.order_id)\r\n      .single()\r\n\r\n    return {\r\n      canRate: !existingFeedback,\r\n      hasRated: !!existingFeedback,\r\n      sellerId: orderItem.seller_id\r\n    }\r\n  } catch {\r\n    return { canRate: false, hasRated: false }\r\n  }\r\n}\r\n\r\n/**\r\n * Check if seller can rate buyer after delivery\r\n */\r\nexport async function canSellerRateBuyer(\r\n  orderItemId: string\r\n): Promise<{ canRate: boolean; hasRated: boolean; buyerId?: string; orderId?: string }> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { canRate: false, hasRated: false }\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) {\r\n      return { canRate: false, hasRated: false }\r\n    }\r\n\r\n    // Get order item - seller must own it\r\n    const { data: orderItem } = await supabase\r\n      .from('order_items')\r\n      .select(`\r\n        id,\r\n        status,\r\n        seller_id,\r\n        order_id,\r\n        order:orders!inner(user_id)\r\n      `)\r\n      .eq('id', orderItemId)\r\n      .eq('seller_id', user.id)\r\n      .single<{\r\n        id: string\r\n        status: string | null\r\n        seller_id: string\r\n        order_id: string\r\n        order: { user_id: string }\r\n      }>()\r\n\r\n    if (!orderItem) {\r\n      return { canRate: false, hasRated: false }\r\n    }\r\n\r\n    const buyerId = orderItem.order.user_id\r\n\r\n    // Must be delivered to rate\r\n    if (orderItem.status !== 'delivered') {\r\n      return { canRate: false, hasRated: false, buyerId, orderId: orderItem.order_id }\r\n    }\r\n\r\n    // Check if already rated - buyer_feedback uses order_id, not order_item_id\r\n    const { data: existingFeedback } = await supabase\r\n      .from('buyer_feedback')\r\n      .select('id')\r\n      .eq('seller_id', user.id)\r\n      .eq('buyer_id', buyerId)\r\n      .eq('order_id', orderItem.order_id)\r\n      .single()\r\n\r\n    return {\r\n      canRate: !existingFeedback,\r\n      hasRated: !!existingFeedback,\r\n      buyerId,\r\n      orderId: orderItem.order_id\r\n    }\r\n  } catch {\r\n    return { canRate: false, hasRated: false }\r\n  }\r\n}\r\n\r\n/**\r\n * Request a return for an order item (buyer only)\r\n * Minimal wiring: records the request for seller review.\r\n */\r\nexport async function requestReturn(\r\n  orderItemId: string,\r\n  reason: string\r\n): Promise<{ success: boolean; error?: string }> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    const normalizedReason = (reason ?? \"\").trim()\r\n    if (normalizedReason.length < 3) {\r\n      return { success: false, error: \"Please provide a reason\" }\r\n    }\r\n\r\n    const { data: orderItem, error: fetchError } = await supabase\r\n      .from(\"order_items\")\r\n      .select(\r\n        `\r\n          id,\r\n          status,\r\n          seller_id,\r\n          order:orders!inner(id, user_id)\r\n        `\r\n      )\r\n      .eq(\"id\", orderItemId)\r\n      .single<{\r\n        id: string\r\n        status: string | null\r\n        seller_id: string\r\n        order: { id: string; user_id: string }\r\n      }>()\r\n\r\n    if (fetchError || !orderItem) {\r\n      return { success: false, error: \"Order item not found\" }\r\n    }\r\n\r\n    if (orderItem.order.user_id !== user.id) {\r\n      return { success: false, error: \"Not authorized to request a return for this order\" }\r\n    }\r\n\r\n    if (orderItem.status !== \"delivered\") {\r\n      return { success: false, error: \"Return requests are available after delivery\" }\r\n    }\r\n\r\n    const { data: existingRequests, error: existingError } = await supabase\r\n      .from(\"return_requests\")\r\n      .select(\"id,status\")\r\n      .eq(\"order_item_id\", orderItemId)\r\n      .eq(\"buyer_id\", user.id)\r\n      .neq(\"status\", \"cancelled\")\r\n      .limit(1)\r\n\r\n    const existingRequest = existingRequests?.[0] ?? null\r\n\r\n    if (existingError) {\r\n      console.error(\"Error checking return requests:\", existingError)\r\n      return { success: false, error: \"Failed to submit return request\" }\r\n    }\r\n\r\n    if (existingRequest?.id) {\r\n      return { success: false, error: \"Return request already submitted\" }\r\n    }\r\n\r\n    const { error: insertError } = await supabase.from(\"return_requests\").insert({\r\n        order_item_id: orderItemId,\r\n        order_id: orderItem.order.id,\r\n        buyer_id: user.id,\r\n        seller_id: orderItem.seller_id,\r\n        reason: normalizedReason,\r\n        status: \"requested\",\r\n      })\r\n\r\n    if (insertError) {\r\n      console.error(\"Error creating return request:\", insertError)\r\n      return { success: false, error: \"Failed to submit return request\" }\r\n    }\r\n\r\n    revalidateTag(\"orders\", \"max\")\r\n    revalidateTag(\"messages\", \"max\")\r\n    revalidateTag(\"conversations\", \"max\")\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"Error in requestReturn:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// BUYER ORDER MANAGEMENT ACTIONS\r\n// For buyers to manage their orders\r\n// =====================================================\r\n\r\n/**\r\n * Request cancellation of an order item (buyer only)\r\n * Can only cancel items that are not yet shipped\r\n */\r\nexport async function requestOrderCancellation(\r\n  orderItemId: string,\r\n  reason?: string\r\n): Promise<{ success: boolean; error?: string }> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Verify the order item belongs to this user's order and check status\r\n    const { data: orderItem, error: fetchError } = await supabase\r\n      .from('order_items')\r\n      .select(`\r\n        id,\r\n        status,\r\n        seller_id,\r\n        product:products(title),\r\n        order:orders!inner(id, user_id, status)\r\n      `)\r\n      .eq('id', orderItemId)\r\n      .single<{\r\n        id: string\r\n        status: string | null\r\n        seller_id: string\r\n        product: { title: string } | null\r\n        order: { id: string; user_id: string; status: string }\r\n      }>()\r\n\r\n    if (fetchError || !orderItem) {\r\n      return { success: false, error: \"Order item not found\" }\r\n    }\r\n    \r\n    // Verify user owns this order\r\n    if (orderItem.order.user_id !== user.id) {\r\n      return { success: false, error: \"Not authorized to cancel this order\" }\r\n    }\r\n\r\n    // Check if cancellation is allowed (not shipped or delivered)\r\n    const nonCancellableStatuses = ['shipped', 'delivered']\r\n    const currentStatus = orderItem.status || 'pending'\r\n    if (nonCancellableStatuses.includes(currentStatus)) {\r\n      return { \r\n        success: false, \r\n        error: currentStatus === 'shipped' \r\n          ? \"Cannot cancel - item has already been shipped\"\r\n          : \"Cannot cancel - item has already been delivered\"\r\n      }\r\n    }\r\n\r\n    if (currentStatus === 'cancelled') {\r\n      return { success: false, error: \"This item has already been cancelled\" }\r\n    }\r\n\r\n    // Update order item status to cancelled\r\n    const { error: updateError } = await supabase\r\n      .from('order_items')\r\n      .update({ \r\n        status: 'cancelled',\r\n        // Store cancellation reason in a metadata field if needed\r\n      })\r\n      .eq('id', orderItemId)\r\n\r\n    if (updateError) {\r\n      console.error('Error cancelling order item:', updateError)\r\n      return { success: false, error: \"Failed to cancel order\" }\r\n    }\r\n\r\n    // Create a notification for the seller\r\n    const { error: notifyError } = await supabase\r\n      .from('notifications')\r\n      .insert({\r\n        user_id: orderItem.seller_id,\r\n        type: 'order_status',\r\n        title: 'Order Cancellation Request',\r\n        body: `A buyer has cancelled their order${reason ? `: ${reason}` : ''}`,\r\n        data: { \r\n          order_item_id: orderItemId, \r\n          order_id: orderItem.order.id,\r\n          reason \r\n        },\r\n        order_id: orderItem.order.id,\r\n      })\r\n\r\n    if (notifyError) {\r\n      console.error('Error creating cancellation notification:', notifyError)\r\n      // Don't fail the cancellation if notification fails\r\n    }\r\n\r\n    revalidateTag('orders', \"max\")\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error('Error in requestOrderCancellation:', error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Report an issue with an order item (buyer only)\r\n */\r\nexport type IssueType = \r\n  | 'not_received' \r\n  | 'wrong_item' \r\n  | 'damaged' \r\n  | 'not_as_described' \r\n  | 'missing_parts'\r\n  | 'other'\r\n\r\nexport async function reportOrderIssue(\r\n  orderItemId: string,\r\n  issueType: IssueType,\r\n  description: string\r\n): Promise<{ success: boolean; error?: string; conversationId?: string }> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    if (!description || description.trim().length < 10) {\r\n      return { success: false, error: \"Please provide a detailed description (minimum 10 characters)\" }\r\n    }\r\n\r\n    // Verify the order item belongs to this user's order\r\n    const { data: orderItem, error: fetchError } = await supabase\r\n      .from('order_items')\r\n      .select(`\r\n        id,\r\n        status,\r\n        seller_id,\r\n        product:products(id, title),\r\n        order:orders!inner(id, user_id)\r\n      `)\r\n      .eq('id', orderItemId)\r\n      .single<{\r\n        id: string\r\n        status: string | null\r\n        seller_id: string\r\n        product: { id: string; title: string } | null\r\n        order: { id: string; user_id: string }\r\n      }>()\r\n\r\n    if (fetchError || !orderItem) {\r\n      return { success: false, error: \"Order item not found\" }\r\n    }\r\n    \r\n    // Verify user owns this order\r\n    if (orderItem.order.user_id !== user.id) {\r\n      return { success: false, error: \"Not authorized to report issues for this order\" }\r\n    }\r\n\r\n    // Map issue type to readable subject\r\n    const issueSubjects: Record<IssueType, string> = {\r\n      'not_received': 'Item Not Received',\r\n      'wrong_item': 'Wrong Item Received',\r\n      'damaged': 'Item Damaged',\r\n      'not_as_described': 'Item Not As Described',\r\n      'missing_parts': 'Missing Parts',\r\n      'other': 'Order Issue',\r\n    }\r\n\r\n    const subject = `${issueSubjects[issueType]}${orderItem.product?.title ? ` - ${orderItem.product.title}` : ''}`\r\n\r\n    // Create or find existing conversation with the seller\r\n    const { data: existingConversation } = await supabase\r\n      .from('conversations')\r\n      .select('id')\r\n      .eq('buyer_id', user.id)\r\n      .eq('seller_id', orderItem.seller_id)\r\n      .eq('order_id', orderItem.order.id)\r\n      .single()\r\n\r\n    let conversationId = existingConversation?.id\r\n\r\n    if (!conversationId) {\r\n      // Create new conversation\r\n      const { data: newConversation, error: convError } = await supabase\r\n        .from('conversations')\r\n        .insert({\r\n          buyer_id: user.id,\r\n          seller_id: orderItem.seller_id,\r\n          product_id: orderItem.product?.id ?? null,\r\n          order_id: orderItem.order.id,\r\n          subject,\r\n          status: 'open',\r\n          last_message_at: new Date().toISOString(),\r\n          seller_unread_count: 1,\r\n        })\r\n        .select('id')\r\n        .single()\r\n\r\n      if (convError || !newConversation) {\r\n        console.error('Error creating conversation:', convError)\r\n        return { success: false, error: \"Failed to create conversation\" }\r\n      }\r\n\r\n      conversationId = newConversation.id\r\n    }\r\n\r\n    // Send the issue report as a message\r\n    const messageContent = `ΓÜá∩╕Å **Issue Report: ${issueSubjects[issueType]}**\\n\\n${description}`\r\n    \r\n    const { error: messageError } = await supabase\r\n      .from('messages')\r\n      .insert({\r\n        conversation_id: conversationId,\r\n        sender_id: user.id,\r\n        content: messageContent,\r\n        message_type: 'text',\r\n      })\r\n\r\n    if (messageError) {\r\n      console.error('Error creating message:', messageError)\r\n      return { success: false, error: \"Failed to send issue report\" }\r\n    }\r\n\r\n    // Update conversation last_message_at and unread count\r\n    await supabase\r\n      .from('conversations')\r\n      .update({\r\n        last_message_at: new Date().toISOString(),\r\n        seller_unread_count: 1, // Set unread\r\n        status: 'open',\r\n      })\r\n      .eq('id', conversationId)\r\n\r\n    // Create notification for seller\r\n    await supabase\r\n      .from('notifications')\r\n      .insert({\r\n        user_id: orderItem.seller_id,\r\n        type: 'message',\r\n        title: `Issue Report: ${issueSubjects[issueType]}`,\r\n        body: `A buyer has reported an issue with their order`,\r\n        data: { \r\n          order_item_id: orderItemId, \r\n          order_id: orderItem.order.id,\r\n          issue_type: issueType,\r\n          conversation_id: conversationId\r\n        },\r\n        order_id: orderItem.order.id,\r\n        conversation_id: conversationId,\r\n      })\r\n\r\n    revalidateTag('orders', \"max\")\r\n    revalidateTag('messages', \"max\")\r\n    revalidateTag('conversations', \"max\")\r\n\r\n    return { success: true, conversationId }\r\n  } catch (error) {\r\n    console.error('Error in reportOrderIssue:', error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Get detailed order information for a buyer\r\n */\r\nexport async function getBuyerOrderDetails(\n  orderId: string\n): Promise<{ \n  order: {\r\n    id: string\r\n    status: string\r\n    total_amount: number\r\n    shipping_address: Record<string, unknown> | null\r\n    created_at: string\r\n    items: OrderItem[]\r\n  } | null\r\n  error?: string \r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { order: null, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { order: null, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Get order with all items\n    const { data: order, error: orderError } = await supabase\n      .from('orders')\n      .select(`\n        id,\n        status,\n        total_amount,\n        shipping_address,\n        created_at,\n        order_items (\n          ${ORDER_ITEM_DETAIL_SELECT}\n        )\n      `)\n      .eq('id', orderId)\n      .eq('user_id', user.id)\n      .single<{\r\n        id: string\r\n        status: string | null\r\n        total_amount: number\r\n        shipping_address: Record<string, unknown> | null\r\n        created_at: string\r\n        order_items: OrderItem[]\r\n      }>()\r\n\r\n    if (orderError || !order) {\r\n      return { order: null, error: \"Order not found\" }\r\n    }\r\n\r\n    return {\n      order: {\n        id: order.id,\n        status: order.status || 'pending',\n        total_amount: order.total_amount,\n        shipping_address: order.shipping_address,\n        created_at: order.created_at,\n        items: order.order_items.map((item) => ({ ...item, created_at: order.created_at })) as OrderItem[],\n      }\n    }\n  } catch (error) {\n    console.error('Error in getBuyerOrderDetails:', error)\r\n    return { order: null, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\actions\\payments.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"The `{}` (\"empty object\") type allows any non-nullish value, including literals like `0` and `\"\"`.\n- If that's what you want, disable this lint rule with an inline comment or configure the 'allowObjectTypes' rule option.\n- If you want a type meaning \"any object\", you probably want `object` instead.\n- If you want a type meaning \"any value\", you probably want `unknown` instead.","line":22,"column":45,"nodeType":"TSTypeLiteral","messageId":"noEmptyObject","endLine":22,"endColumn":47,"suggestions":[{"messageId":"replaceEmptyObjectType","data":{"replacement":"object"},"fix":{"range":[652,654],"text":"object"},"desc":"Replace `{}` with `object`."},{"messageId":"replaceEmptyObjectType","data":{"replacement":"unknown"},"fix":{"range":[652,654],"text":"unknown"},"desc":"Replace `{}` with `unknown`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use server'\n\nimport { z } from 'zod'\nimport { errorEnvelope, successEnvelope, type Envelope } from '@/lib/api/envelope'\nimport { stripe } from '@/lib/stripe'\nimport { createClient } from '@/lib/supabase/server'\nimport { STRIPE_CUSTOMER_ID_SELECT } from '@/lib/supabase/selects/billing'\nimport { buildLocaleUrl } from '@/lib/stripe-locale'\n\r\nconst NOT_AUTHENTICATED = 'Not authenticated'\r\n\r\nconst paymentMethodInputSchema = z.object({\n  paymentMethodId: z.string().min(1),\n  dbId: z.string().min(1),\n})\n\ntype PaymentSetupSessionResult = Envelope<\n  { url: string | null | undefined },\n  { error: string }\n>\n\ntype PaymentMethodMutationResult = Envelope<{}, { error: string }>\n\nexport async function createPaymentMethodSetupSession(\n  input?: { locale?: 'en' | 'bg' }\n): Promise<PaymentSetupSessionResult> {\n  try {\n    const supabase = await createClient()\n\n    if (!supabase) {\n      return errorEnvelope({ error: NOT_AUTHENTICATED })\n    }\n\n    const {\n      data: { user },\n    } = await supabase.auth.getUser()\n\n    if (!user) {\n      return errorEnvelope({ error: NOT_AUTHENTICATED })\n    }\n\n    const { data: profile } = await supabase\n      .from('private_profiles')\n      .select(STRIPE_CUSTOMER_ID_SELECT)\n      .eq('id', user.id)\n      .single()\n\n    let stripeCustomerId = profile?.stripe_customer_id\n\n    if (!stripeCustomerId) {\n      const customer = await stripe.customers.create({\n        ...(user.email ? { email: user.email } : {}),\n        metadata: {\n          supabase_user_id: user.id,\n        },\n      })\n\n      stripeCustomerId = customer.id\n\n      await supabase\n        .from('private_profiles')\n        .update({ stripe_customer_id: stripeCustomerId })\n        .eq('id', user.id)\n    }\n\n    if (!stripeCustomerId) {\n      return errorEnvelope({ error: 'Stripe customer creation failed' })\n    }\n\n    const locale = input?.locale === 'bg' ? 'bg' : 'en'\n    const successUrl = buildLocaleUrl('account/payments', locale, 'setup=success')\n    const cancelUrl = buildLocaleUrl('account/payments', locale, 'setup=canceled')\n\n    const session = await stripe.checkout.sessions.create({\n      customer: stripeCustomerId,\n      mode: 'setup',\n      payment_method_types: ['card'],\n      success_url: successUrl,\n      cancel_url: cancelUrl,\n      metadata: {\n        user_id: user.id,\n      },\n    })\n\n    return successEnvelope({ url: session.url })\n  } catch (error) {\n    console.error('createPaymentMethodSetupSession error:', error)\n    return errorEnvelope({ error: 'Failed to create setup session' })\n  }\n}\n\nexport async function deletePaymentMethod(\n  input: { paymentMethodId: string; dbId: string }\n): Promise<PaymentMethodMutationResult> {\n  try {\n    const supabase = await createClient()\n\n    if (!supabase) {\n      return errorEnvelope({ error: NOT_AUTHENTICATED })\n    }\n\n    const {\n      data: { user },\n    } = await supabase.auth.getUser()\n\n    if (!user) {\n      return errorEnvelope({ error: NOT_AUTHENTICATED })\n    }\n\n    const parsed = paymentMethodInputSchema.safeParse(input)\n    if (!parsed.success) {\n      return errorEnvelope({ error: 'Invalid input' })\n    }\n\n    const { paymentMethodId, dbId } = parsed.data\n\n    await stripe.paymentMethods.detach(paymentMethodId)\n\n    const { error: deleteError } = await supabase\n      .from('user_payment_methods')\n      .delete()\n      .eq('id', dbId)\n      .eq('user_id', user.id)\n\n    if (deleteError) {\n      return errorEnvelope({ error: 'Failed to delete payment method' })\n    }\n\n    return successEnvelope()\n  } catch (error) {\n    console.error('deletePaymentMethod error:', error)\n    return errorEnvelope({ error: 'Failed to delete payment method' })\n  }\n}\n\nexport async function setDefaultPaymentMethod(\n  input: { paymentMethodId: string; dbId: string }\n): Promise<PaymentMethodMutationResult> {\n  try {\n    const supabase = await createClient()\n\n    if (!supabase) {\n      return errorEnvelope({ error: NOT_AUTHENTICATED })\n    }\n\n    const {\n      data: { user },\n    } = await supabase.auth.getUser()\n\n    if (!user) {\n      return errorEnvelope({ error: NOT_AUTHENTICATED })\n    }\n\n    const parsed = paymentMethodInputSchema.safeParse(input)\n    if (!parsed.success) {\n      return errorEnvelope({ error: 'Invalid input' })\n    }\n\n    const { paymentMethodId, dbId } = parsed.data\n\n    const { data: profile } = await supabase\n      .from('private_profiles')\n      .select(STRIPE_CUSTOMER_ID_SELECT)\n      .eq('id', user.id)\n      .single()\n\n    if (!profile?.stripe_customer_id) {\n      return errorEnvelope({ error: 'No Stripe customer found' })\n    }\n\n    await stripe.customers.update(profile.stripe_customer_id, {\n      invoice_settings: {\n        default_payment_method: paymentMethodId,\n      },\n    })\n\n    const { error: clearDefaultsError } = await supabase\n      .from('user_payment_methods')\n      .update({ is_default: false })\n      .eq('user_id', user.id)\n\n    if (clearDefaultsError) {\n      return errorEnvelope({ error: 'Failed to set default payment method' })\n    }\n\n    const { error: updateError } = await supabase\n      .from('user_payment_methods')\n      .update({ is_default: true })\n      .eq('id', dbId)\n      .eq('user_id', user.id)\n\n    if (updateError) {\n      return errorEnvelope({ error: 'Failed to set default payment method' })\n    }\n\n    return successEnvelope()\n  } catch (error) {\n    console.error('setDefaultPaymentMethod error:', error)\n    return errorEnvelope({ error: 'Failed to set default payment method' })\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\actions\\products.ts","messages":[{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":11,"column":27,"nodeType":"Identifier","messageId":"method","endLine":11,"endColumn":34,"fix":{"range":[380,380],"text":"All"}},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":115,"column":15,"nodeType":"CallExpression","messageId":"array-from","endLine":117,"endColumn":4,"fix":{"range":[4198,4310],"text":"[...new Set(categoryIds.filter((id): id is string => typeof id === \"string\" && id.length > 0))]"}},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":129,"column":10,"nodeType":"CallExpression","messageId":"array-from","endLine":129,"endColumn":36,"fix":{"range":[4611,4637],"text":"[...new Set(slugs)]"}},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":136,"column":15,"nodeType":"CallExpression","messageId":"array-from","endLine":136,"endColumn":102,"fix":{"range":[4790,4877],"text":"[...new Set(productIds.filter((id) => typeof id === \"string\" && id.length > 0))]"}},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":181,"column":21,"nodeType":"CallExpression","messageId":"array-from","endLine":181,"endColumn":46,"fix":{"range":[6165,6190],"text":"[...new Set(tags)]"}},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 9 times.","line":309,"column":37,"nodeType":"Literal","endLine":309,"endColumn":67},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 40 to the 25 allowed.","line":316,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":316,"endColumn":36},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 5 times.","line":337,"column":39,"nodeType":"Literal","endLine":337,"endColumn":58},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 5 times.","line":388,"column":39,"nodeType":"Literal","endLine":388,"endColumn":65},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updateProductStock' is defined but never used.","line":806,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":806,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":10,"fixableErrorCount":0,"fixableWarningCount":5,"source":"\"use server\"\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { revalidateTag } from \"next/cache\"\r\nimport type { SupabaseClient } from \"@supabase/supabase-js\"\nimport type { Database } from \"@/lib/supabase/database.types\"\nimport { z } from \"zod\"\n\nfunction isProbablyJunkTitle(title: string): boolean {\n  const trimmed = title.trim()\n  const compact = trimmed.replace(/\\s+/g, \"\")\n\n  // Minimum meaningful content\n  if (compact.length < 5) return true\n\n  // Pure digits or pure symbols\n  if (/^\\d+$/.test(compact)) return true\n  if (/^[^0-9A-Za-z\\u0400-\\u04FF]+$/.test(compact)) return true\n\n  // Overwhelmingly numeric (e.g. \"123123123123\")\n  const digitCount = (compact.match(/\\d/g) ?? []).length\n  if (compact.length >= 10 && digitCount / compact.length > 0.8) return true\n\n  // Extremely low variety (e.g. \"aaaaaaa\", \"11111111\", \"abababababab\")\n  const uniqueChars = new Set(compact.toLowerCase()).size\n  if (compact.length >= 12 && uniqueChars <= 2) return true\n  if (/^(.)\\1{6,}$/.test(compact)) return true\n\n  return false\n}\n\nconst listingTitleSchema = z\n  .string()\n  .trim()\n  .min(5, \"Title needs at least 5 characters\")\n  .max(255, \"Title can't exceed 255 characters\")\n  .refine((val) => !/[<>{}[\\]\\\\]/.test(val), \"Title contains invalid characters\")\n  .refine((val) => !isProbablyJunkTitle(val), \"Please enter a more descriptive title\")\n\n// Product validation schema - matches database columns\nconst productSchema = z.object({\n  title: listingTitleSchema,\n  description: z.string().optional().nullable(),\n  price: z.coerce.number().min(0, \"Price must be positive\"),\n  compareAtPrice: z.coerce.number().min(0).optional().nullable(), // maps to list_price\n  costPrice: z.coerce.number().min(0).optional().nullable(),\n  sku: z.string().max(100).optional().nullable(),\r\n  barcode: z.string().max(50).optional().nullable(),\r\n  stock: z.coerce.number().int().min(0, \"Stock must be 0 or more\"),\r\n  trackInventory: z.boolean().default(true),\r\n  categoryId: z.string().optional().nullable(),\r\n  status: z.enum([\"active\", \"draft\", \"archived\", \"out_of_stock\"]).default(\"draft\"),\r\n  weight: z.coerce.number().min(0).optional().nullable(),\r\n  weightUnit: z.enum([\"kg\", \"g\", \"lb\", \"oz\"]).default(\"kg\"),\r\n  condition: z.enum([\"new\", \"used\", \"refurbished\", \"like_new\", \"good\", \"fair\"]).default(\"new\"),\r\n  images: z.array(z.string()).default([]),\n})\n\nexport interface ProductAttributeInput {\n  attributeId?: string | null\n  name: string\n  value: string\n  isCustom?: boolean\n}\n\nexport type ProductInput = z.infer<typeof productSchema> & {\n  attributes?: ProductAttributeInput[]\n}\n\r\ninterface ActionResult<T = void> {\r\n  success: boolean\r\n  data?: T\r\n  error?: string\r\n}\r\n\r\nconst setDiscountSchema = z.object({\r\n  productId: z.string().min(1),\r\n  newPrice: z.coerce.number().positive(),\r\n})\r\n\r\nconst clearDiscountSchema = z.object({\r\n  productId: z.string().min(1),\r\n})\r\n\r\ntype ProductFeedType = \"deals\" | \"newest\" | \"bestsellers\" | \"featured\" | \"promo\"\n\nconst LEAF_CATEGORY_ERROR_MESSAGE = \"Please select a more specific category (leaf category)\"\n\nfunction isLeafCategoryError(error: { code?: string | null; message?: string | null } | null | undefined): boolean {\n  return error?.code === \"23514\" && typeof error.message === \"string\" && error.message.includes(\"Category must be a leaf category\")\n}\n\nfunction normalizeProductAttributes(input: unknown): ProductAttributeInput[] {\n  if (!Array.isArray(input)) return []\n  const out: ProductAttributeInput[] = []\n  for (const raw of input) {\n    if (!raw || typeof raw !== \"object\") continue\n    const record = raw as Record<string, unknown>\n    const name = typeof record.name === \"string\" ? record.name.trim() : \"\"\n    const value = typeof record.value === \"string\" ? record.value.trim() : \"\"\n    if (!name || !value) continue\n    const attributeId = typeof record.attributeId === \"string\" && record.attributeId.length > 0\n      ? record.attributeId\n      : null\n    const isCustom = record.isCustom === true\n    out.push({ name, value, attributeId, isCustom })\n  }\n  return out\n}\n\nasync function getCategorySlugsByIds(\n  supabase: SupabaseClient<Database>,\n  categoryIds: Array<string | null | undefined>\n): Promise<string[]> {\n  const ids = Array.from(\r\n    new Set(categoryIds.filter((id): id is string => typeof id === \"string\" && id.length > 0))\r\n  )\r\n  if (ids.length === 0) return []\r\n\r\n  const { data } = await supabase\r\n    .from(\"categories\")\r\n    .select(\"id, slug\")\r\n    .in(\"id\", ids)\r\n\r\n  const slugs = (data ?? [])\r\n    .map((row) => row?.slug)\r\n    .filter((slug): slug is string => typeof slug === \"string\" && slug.length > 0)\r\n\r\n  return Array.from(new Set(slugs))\r\n}\r\n\r\nasync function getCategorySlugsForProducts(\r\n  supabase: SupabaseClient<Database>,\r\n  productIds: string[]\r\n): Promise<string[]> {\r\n  const ids = Array.from(new Set(productIds.filter((id) => typeof id === \"string\" && id.length > 0)))\r\n  if (ids.length === 0) return []\r\n\r\n  const { data: products } = await supabase\r\n    .from(\"products\")\r\n    .select(\"id, category_id\")\r\n    .in(\"id\", ids)\r\n\r\n  const categoryIds = (products ?? [])\r\n    .map((p) => p?.category_id)\r\n    .filter((id): id is string => typeof id === \"string\" && id.length > 0)\r\n\r\n  return getCategorySlugsByIds(supabase, categoryIds)\r\n}\r\n\r\nasync function revalidateProductCaches(params: {\r\n  supabase: SupabaseClient<Database>\r\n  sellerId: string\r\n  productIds?: string[]\r\n  categoryIds?: Array<string | null | undefined>\r\n  invalidateTypes?: ProductFeedType[]\r\n}) {\r\n  const { supabase, sellerId, productIds, categoryIds, invalidateTypes } = params\r\n\r\n  const tags: string[] = []\r\n\r\n  if (Array.isArray(productIds)) {\r\n    for (const id of productIds) {\r\n      if (typeof id === \"string\" && id.length > 0) tags.push(`product:${id}`)\r\n    }\r\n  }\r\n\r\n  if (typeof sellerId === \"string\" && sellerId.length > 0) {\r\n    tags.push(`seller-products-${sellerId}`, `seller-${sellerId}`)\r\n  }\r\n\r\n  const slugs = await getCategorySlugsByIds(supabase, categoryIds ?? [])\r\n  for (const slug of slugs) {\r\n    tags.push(`products:category:${slug}`)\r\n  }\r\n\r\n  for (const type of invalidateTypes ?? []) {\r\n    tags.push(`products:type:${type}`)\r\n  }\r\n\r\n  for (const tag of Array.from(new Set(tags))) {\r\n    revalidateTag(tag, \"max\")\r\n  }\r\n}\r\n\r\n/**\r\n * Create a new product\r\n */\r\nexport async function createProduct(input: ProductInput): Promise<ActionResult<{ id: string }>> {\r\n  try {\r\n    const supabase = await createClient()\r\n    \r\n    // Get current user\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"You must be logged in to create a product\" }\r\n    }\r\n    \r\n    // Validate input\r\n    const validated = productSchema.safeParse(input)\r\n    if (!validated.success) {\r\n      return { success: false, error: validated.error.issues[0]?.message || \"Invalid input\" }\r\n    }\r\n    \r\n    const data = validated.data\n    const attributes = normalizeProductAttributes(input.attributes)\n    \r\n    // Check if user has a username (required to sell)\r\n    const { data: profile, error: profileError } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"id, username\")\r\n      .eq(\"id\", user.id)\r\n      .single()\r\n    \r\n    if (profileError || !profile) {\r\n      return { success: false, error: \"Profile not found\" }\r\n    }\r\n    \r\n    if (!profile.username) {\r\n      return { success: false, error: \"You must set a username before listing products\" }\r\n    }\r\n    \r\n    // Generate slug from title\r\n    const baseSlug = data.title\r\n      .toLowerCase()\r\n      .replaceAll(/[^a-z0-9]+/g, \"-\")\r\n      .replaceAll(/^-|-$/g, \"\")\r\n    \r\n    // Make slug unique by adding timestamp\r\n    const slug = `${baseSlug}-${Date.now().toString(36)}`\r\n    \r\n    // Insert product with all business fields\r\n    const { data: product, error: insertError } = await supabase\r\n      .from(\"products\")\r\n      .insert({\r\n        seller_id: user.id,\r\n        title: data.title,\r\n        description: data.description || null,\r\n        price: data.price,\r\n        list_price: data.compareAtPrice || null,\r\n        stock: data.stock,\r\n        track_inventory: data.trackInventory,\r\n        category_id: data.categoryId || null,\r\n        status: data.status,\r\n        weight: data.weight || null,\r\n        weight_unit: data.weightUnit,\r\n        condition: data.condition,\r\n        images: data.images,\r\n        slug: slug,\r\n      })\r\n      .select(\"id\")\r\n      .single()\r\n    \r\n    if (insertError) {\n      if (isLeafCategoryError(insertError)) {\n        return { success: false, error: LEAF_CATEGORY_ERROR_MESSAGE }\n      }\n      console.error(\"[createProduct] Insert error:\", insertError)\n      return { success: false, error: insertError.message || \"Failed to create product\" }\n    }\n\r\n    const { error: privateError } = await supabase\r\n      .from(\"product_private\")\r\n      .insert({\r\n        product_id: product.id,\r\n        seller_id: user.id,\r\n        cost_price: data.costPrice ?? null,\r\n        sku: data.sku ?? null,\r\n        barcode: data.barcode ?? null,\r\n      })\r\n\r\n    if (privateError) {\n      console.error(\"[createProduct] Product private insert error:\", privateError)\n      await supabase.from(\"products\").delete().eq(\"id\", product.id)\n      return { success: false, error: privateError.message || \"Failed to save seller-only product fields\" }\n    }\n\n    if (attributes.length > 0) {\n      const attributeRows = attributes.map((attr) => ({\n        product_id: product.id,\n        attribute_id: attr.attributeId ?? null,\n        name: attr.name,\n        value: attr.value,\n        is_custom: attr.isCustom ?? false,\n      }))\n\n      const { error: attrError } = await supabase\n        .from(\"product_attributes\")\n        .insert(attributeRows)\n\n      if (attrError) {\n        console.error(\"[createProduct] Product attributes insert error:\", attrError)\n        await supabase.from(\"products\").delete().eq(\"id\", product.id)\n        return { success: false, error: attrError.message || \"Failed to create product\" }\n      }\n    }\n\r\n    await revalidateProductCaches({\r\n      supabase,\r\n      sellerId: user.id,\r\n      productIds: [product.id],\r\n      categoryIds: [data.categoryId],\r\n      invalidateTypes: [\"newest\"],\r\n    })\r\n    \r\n    return { success: true, data: { id: product.id } }\r\n  } catch (error) {\r\n    console.error(\"[createProduct] Error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Update an existing product\r\n */\r\nexport async function updateProduct(\n  productId: string, \n  input: Partial<ProductInput>\n): Promise<ActionResult> {\n  try {\n    const supabase = await createClient()\r\n    \r\n    // Get current user\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"You must be logged in to update a product\" }\r\n    }\r\n    \r\n    // Check product ownership\r\n    const { data: existingProduct, error: fetchError } = await supabase\n      .from(\"products\")\n      .select(\"id, seller_id, category_id, title\")\n      .eq(\"id\", productId)\n      .single()\n    \r\n    if (fetchError || !existingProduct) {\r\n      return { success: false, error: \"Product not found\" }\r\n    }\r\n    \r\n    if (existingProduct.seller_id !== user.id) {\n      return { success: false, error: \"You don't have permission to edit this product\" }\n    }\n\n    // Guard: status transitions to \"active\" must pass listing-quality validation.\n    if (input.status === \"active\") {\n      const nextTitle = input.title ?? existingProduct.title\n      const parsedTitle = listingTitleSchema.safeParse(nextTitle)\n      if (!parsedTitle.success) {\n        return { success: false, error: parsedTitle.error.issues[0]?.message || \"Invalid title\" }\n      }\n    }\n    \n    // Build update object with all business fields\n    const updateData: Record<string, unknown> = {\n      updated_at: new Date().toISOString(),\n    }\n    \n    if (input.title !== undefined) {\n      const parsedTitle = listingTitleSchema.safeParse(input.title)\n      if (!parsedTitle.success) {\n        return { success: false, error: parsedTitle.error.issues[0]?.message || \"Invalid title\" }\n      }\n      updateData.title = parsedTitle.data\n    }\n    if (input.description !== undefined) updateData.description = input.description\n    if (input.price !== undefined) updateData.price = input.price\n    if (input.compareAtPrice !== undefined) updateData.list_price = input.compareAtPrice\n    if (input.stock !== undefined) updateData.stock = input.stock\n    if (input.trackInventory !== undefined) updateData.track_inventory = input.trackInventory\r\n    if (input.categoryId !== undefined) updateData.category_id = input.categoryId\r\n    if (input.status !== undefined) updateData.status = input.status\r\n    if (input.weight !== undefined) updateData.weight = input.weight\r\n    if (input.weightUnit !== undefined) updateData.weight_unit = input.weightUnit\r\n    if (input.condition !== undefined) updateData.condition = input.condition\r\n    if (input.images !== undefined) updateData.images = input.images\r\n    \r\n    // Update product\r\n    const { error: updateError } = await supabase\r\n      .from(\"products\")\r\n      .update(updateData)\r\n      .eq(\"id\", productId)\r\n    \r\n    if (updateError) {\n      if (isLeafCategoryError(updateError)) {\n        return { success: false, error: LEAF_CATEGORY_ERROR_MESSAGE }\n      }\n      console.error(\"[updateProduct] Update error:\", updateError)\n      return { success: false, error: \"Failed to update product\" }\n    }\n\r\n    const privateUpdate: {\r\n      product_id: string\r\n      seller_id: string\r\n      cost_price?: number | null\r\n      sku?: string | null\r\n      barcode?: string | null\r\n    } = { product_id: productId, seller_id: user.id }\r\n    if (input.costPrice !== undefined) privateUpdate.cost_price = input.costPrice\r\n    if (input.sku !== undefined) privateUpdate.sku = input.sku\r\n    if (input.barcode !== undefined) privateUpdate.barcode = input.barcode\r\n\r\n    if (Object.keys(privateUpdate).length > 2) {\n      const { error: privateError } = await supabase\n        .from(\"product_private\")\n        .upsert(privateUpdate, { onConflict: \"product_id\" })\n\n      if (privateError) {\n        console.error(\"[updateProduct] Product private upsert error:\", privateError)\n        return { success: false, error: \"Failed to save seller-only product fields\" }\n      }\n    }\n\n    const shouldUpdateAttributes = Object.prototype.hasOwnProperty.call(input, \"attributes\")\n    if (shouldUpdateAttributes) {\n      const attributes = normalizeProductAttributes((input as ProductInput).attributes)\n\n      const { error: deleteError } = await supabase\n        .from(\"product_attributes\")\n        .delete()\n        .eq(\"product_id\", productId)\n\n      if (deleteError) {\n        console.error(\"[updateProduct] Product attributes delete error:\", deleteError)\n        return { success: false, error: \"Failed to update product\" }\n      }\n\n      if (attributes.length > 0) {\n        const attributeRows = attributes.map((attr) => ({\n          product_id: productId,\n          attribute_id: attr.attributeId ?? null,\n          name: attr.name,\n          value: attr.value,\n          is_custom: attr.isCustom ?? false,\n        }))\n\n        const { error: insertError } = await supabase\n          .from(\"product_attributes\")\n          .insert(attributeRows)\n\n        if (insertError) {\n          console.error(\"[updateProduct] Product attributes insert error:\", insertError)\n          return { success: false, error: \"Failed to update product\" }\n        }\n      }\n    }\n\r\n    const categoryIdsToInvalidate: Array<string | null | undefined> = [existingProduct.category_id]\r\n    if (input.categoryId !== undefined) categoryIdsToInvalidate.push(input.categoryId)\r\n\r\n    const invalidateTypes: ProductFeedType[] = []\r\n    // Price / compare-at changes affect promo list rendering.\r\n    if (input.price !== undefined || input.compareAtPrice !== undefined) invalidateTypes.push(\"promo\")\r\n\r\n    await revalidateProductCaches({\r\n      supabase,\r\n      sellerId: user.id,\r\n      productIds: [productId],\r\n      categoryIds: categoryIdsToInvalidate,\r\n      invalidateTypes,\r\n    })\r\n    \r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"[updateProduct] Error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Delete a product\r\n */\r\nexport async function deleteProduct(productId: string): Promise<ActionResult> {\r\n  try {\r\n    const supabase = await createClient()\r\n    \r\n    // Get current user\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"You must be logged in to delete a product\" }\r\n    }\r\n    \r\n    // Check product ownership\r\n    const { data: existingProduct, error: fetchError } = await supabase\r\n      .from(\"products\")\r\n      .select(\"id, seller_id, category_id\")\r\n      .eq(\"id\", productId)\r\n      .single()\r\n    \r\n    if (fetchError || !existingProduct) {\r\n      return { success: false, error: \"Product not found\" }\r\n    }\r\n    \r\n    if (existingProduct.seller_id !== user.id) {\r\n      return { success: false, error: \"You don't have permission to delete this product\" }\r\n    }\r\n    \r\n    // Delete product\r\n    const { error: deleteError } = await supabase\r\n      .from(\"products\")\r\n      .delete()\r\n      .eq(\"id\", productId)\r\n    \r\n    if (deleteError) {\r\n      console.error(\"[deleteProduct] Delete error:\", deleteError)\r\n      return { success: false, error: \"Failed to delete product\" }\r\n    }\r\n\r\n    await revalidateProductCaches({\r\n      supabase,\r\n      sellerId: user.id,\r\n      productIds: [productId],\r\n      categoryIds: [existingProduct.category_id],\r\n      invalidateTypes: [\"newest\", \"promo\", \"deals\", \"featured\", \"bestsellers\"],\r\n    })\r\n    \r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"[deleteProduct] Error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Bulk update product status\r\n */\r\nexport async function bulkUpdateProductStatus(\n  productIds: string[],\n  status: \"active\" | \"draft\" | \"archived\" | \"out_of_stock\"\n): Promise<ActionResult<{ updated: number }>> {\n  try {\n    const supabase = await createClient()\n    \r\n    // Get current user\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\n      return { success: false, error: \"You must be logged in to update products\" }\n    }\n\n    if (status === \"active\") {\n      const { data: titles, error: titleError } = await supabase\n        .from(\"products\")\n        .select(\"id,title\")\n        .eq(\"seller_id\", user.id)\n        .in(\"id\", productIds)\n\n      if (titleError) {\n        return { success: false, error: \"Failed to validate listing titles\" }\n      }\n\n      const invalidCount = (titles ?? []).filter((row) => {\n        const title = typeof row?.title === \"string\" ? row.title : \"\"\n        return !listingTitleSchema.safeParse(title).success\n      }).length\n\n      if (invalidCount > 0) {\n        return {\n          success: false,\n          error: \"Some listings have invalid titles. Fix titles before publishing.\",\n        }\n      }\n    }\n    \n    // Update products (RLS will ensure user owns them)\n    const { data, error: updateError } = await supabase\n      .from(\"products\")\n      .update({ \n        status, \r\n        updated_at: new Date().toISOString() \r\n      })\r\n      .eq(\"seller_id\", user.id)\r\n      .in(\"id\", productIds)\r\n      .select(\"id\")\r\n    \r\n    if (updateError) {\r\n      console.error(\"[bulkUpdateProductStatus] Update error:\", updateError)\r\n      return { success: false, error: \"Failed to update products\" }\r\n    }\r\n\r\n    const updatedIds = (data ?? [])\r\n      .map((row) => row?.id)\r\n      .filter((id): id is string => typeof id === \"string\" && id.length > 0)\r\n\r\n    const categorySlugs = await getCategorySlugsForProducts(supabase, updatedIds)\r\n    await revalidateProductCaches({\r\n      supabase,\r\n      sellerId: user.id,\r\n      productIds: updatedIds,\r\n      categoryIds: [],\r\n      invalidateTypes: [\"newest\", \"promo\", \"deals\", \"featured\", \"bestsellers\"],\r\n    })\r\n    for (const slug of categorySlugs) {\r\n      revalidateTag(`products:category:${slug}`, \"max\")\r\n    }\r\n    \r\n    return { success: true, data: { updated: data?.length || 0 } }\r\n  } catch (error) {\r\n    console.error(\"[bulkUpdateProductStatus] Error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Set a discounted price for a product.\r\n * - If product is not yet discounted, moves current price into list_price.\r\n * - Sets price to the new discounted price.\r\n */\r\nexport async function setProductDiscountPrice(\r\n  productId: string,\r\n  newPrice: number\r\n): Promise<ActionResult> {\r\n  try {\r\n    const parsed = setDiscountSchema.safeParse({ productId, newPrice })\r\n    if (!parsed.success) {\r\n      return { success: false, error: parsed.error.issues[0]?.message || \"Invalid input\" }\r\n    }\r\n\r\n    const supabase = await createClient()\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"You must be logged in to update a product\" }\r\n    }\r\n\r\n    const { data: product, error: fetchError } = await supabase\r\n      .from(\"products\")\r\n      .select(\"id, seller_id, price, list_price, category_id\")\r\n      .eq(\"id\", parsed.data.productId)\r\n      .single()\r\n\r\n    if (fetchError || !product) {\r\n      return { success: false, error: \"Product not found\" }\r\n    }\r\n    if (product.seller_id !== user.id) {\r\n      return { success: false, error: \"You don't have permission to edit this product\" }\r\n    }\r\n\r\n    const currentPrice = Number(product.price)\r\n    const currentListPrice = product.list_price == null ? null : Number(product.list_price)\r\n    const compareAt = currentListPrice && currentListPrice > currentPrice ? currentListPrice : currentPrice\r\n\r\n    if (!(parsed.data.newPrice < compareAt)) {\r\n      return { success: false, error: \"Discount price must be lower than the original price\" }\r\n    }\r\n\r\n    const nextListPrice = currentListPrice && currentListPrice > currentPrice ? currentListPrice : currentPrice\r\n\r\n    const computedSalePercent = nextListPrice > 0\r\n      ? Math.round(((nextListPrice - parsed.data.newPrice) / nextListPrice) * 100)\r\n      : 0\r\n\r\n    const { error: updateError } = await supabase\r\n      .from(\"products\")\r\n      .update({\r\n        price: parsed.data.newPrice,\r\n        list_price: nextListPrice,\r\n        is_on_sale: true,\r\n        sale_percent: computedSalePercent,\r\n        sale_end_date: null,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", parsed.data.productId)\r\n\r\n    if (updateError) {\r\n      console.error(\"[setProductDiscountPrice] Update error:\", updateError)\r\n      return { success: false, error: updateError.message || \"Failed to update product\" }\r\n    }\r\n\r\n    await revalidateProductCaches({\r\n      supabase,\r\n      sellerId: user.id,\r\n      productIds: [parsed.data.productId],\r\n      categoryIds: [product.category_id],\r\n      invalidateTypes: [\"promo\", \"deals\"],\r\n    })\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"[setProductDiscountPrice] Error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Clear a product discount.\r\n * - Restores price from list_price and sets list_price to null.\r\n */\r\nexport async function clearProductDiscount(\r\n  productId: string\r\n): Promise<ActionResult> {\r\n  try {\r\n    const parsed = clearDiscountSchema.safeParse({ productId })\r\n    if (!parsed.success) {\r\n      return { success: false, error: parsed.error.issues[0]?.message || \"Invalid input\" }\r\n    }\r\n\r\n    const supabase = await createClient()\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"You must be logged in to update a product\" }\r\n    }\r\n\r\n    const { data: product, error: fetchError } = await supabase\r\n      .from(\"products\")\r\n      .select(\"id, seller_id, price, list_price, category_id\")\r\n      .eq(\"id\", parsed.data.productId)\r\n      .single()\r\n\r\n    if (fetchError || !product) {\r\n      return { success: false, error: \"Product not found\" }\r\n    }\r\n    if (product.seller_id !== user.id) {\r\n      return { success: false, error: \"You don't have permission to edit this product\" }\r\n    }\r\n\r\n    if (product.list_price == null) {\r\n      return { success: true }\r\n    }\r\n\r\n    const restorePrice = Number(product.list_price)\r\n\r\n    const { error: updateError } = await supabase\r\n      .from(\"products\")\r\n      .update({\r\n        price: restorePrice,\r\n        list_price: null,\r\n        is_on_sale: false,\r\n        sale_percent: 0,\r\n        sale_end_date: null,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", parsed.data.productId)\r\n\r\n    if (updateError) {\r\n      console.error(\"[clearProductDiscount] Update error:\", updateError)\r\n      return { success: false, error: updateError.message || \"Failed to update product\" }\r\n    }\r\n\r\n    await revalidateProductCaches({\r\n      supabase,\r\n      sellerId: user.id,\r\n      productIds: [parsed.data.productId],\r\n      categoryIds: [product.category_id],\r\n      invalidateTypes: [\"promo\", \"deals\"],\r\n    })\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"[clearProductDiscount] Error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Bulk delete products\r\n */\r\nexport async function bulkDeleteProducts(productIds: string[]): Promise<ActionResult<{ deleted: number }>> {\r\n  try {\r\n    const supabase = await createClient()\r\n    \r\n    // Get current user\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"You must be logged in to delete products\" }\r\n    }\r\n    \r\n    // Delete products (RLS will ensure user owns them)\r\n    const { data, error: deleteError } = await supabase\r\n      .from(\"products\")\r\n      .delete()\r\n      .eq(\"seller_id\", user.id)\r\n      .in(\"id\", productIds)\r\n      .select(\"id\")\r\n    \r\n    if (deleteError) {\r\n      console.error(\"[bulkDeleteProducts] Delete error:\", deleteError)\r\n      return { success: false, error: \"Failed to delete products\" }\r\n    }\r\n\r\n    const deletedIds = (data ?? [])\r\n      .map((row) => row?.id)\r\n      .filter((id): id is string => typeof id === \"string\" && id.length > 0)\r\n\r\n    const categorySlugs = await getCategorySlugsForProducts(supabase, deletedIds)\r\n    await revalidateProductCaches({\r\n      supabase,\r\n      sellerId: user.id,\r\n      productIds: deletedIds,\r\n      categoryIds: [],\r\n      invalidateTypes: [\"newest\", \"promo\", \"deals\", \"featured\", \"bestsellers\"],\r\n    })\r\n    for (const slug of categorySlugs) {\r\n      revalidateTag(`products:category:${slug}`, \"max\")\r\n    }\r\n    \r\n    return { success: true, data: { deleted: data?.length || 0 } }\r\n  } catch (error) {\r\n    console.error(\"[bulkDeleteProducts] Error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Quick update product stock\r\n */\r\nasync function updateProductStock(\r\n  productId: string, \r\n  stock: number\r\n): Promise<ActionResult> {\r\n  try {\r\n    if (stock < 0) {\r\n      return { success: false, error: \"Stock cannot be negative\" }\r\n    }\r\n    \r\n    const supabase = await createClient()\r\n    \r\n    // Get current user\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"You must be logged in to update stock\" }\r\n    }\r\n    \r\n    // Update stock (RLS will ensure user owns the product)\r\n    const { error: updateError } = await supabase\r\n      .from(\"products\")\r\n      .update({ \r\n        stock, \r\n        updated_at: new Date().toISOString() \r\n      })\r\n      .eq(\"id\", productId)\r\n      .eq(\"seller_id\", user.id)\r\n    \r\n    if (updateError) {\r\n      console.error(\"[updateProductStock] Update error:\", updateError)\r\n      return { success: false, error: \"Failed to update stock\" }\r\n    }\r\n\r\n    // Stock changes may affect list badges; invalidate product + seller lists.\r\n    await revalidateProductCaches({\r\n      supabase,\r\n      sellerId: user.id,\r\n      productIds: [productId],\r\n      categoryIds: [],\r\n    })\r\n    \r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"[updateProductStock] Error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Duplicate a product\r\n */\r\n  export async function duplicateProduct(productId: string): Promise<ActionResult<{ id: string }>> {\r\n  try {\r\n    const supabase = await createClient()\r\n    \r\n    // Get current user\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"You must be logged in to duplicate a product\" }\r\n    }\r\n\r\n    const DUPLICATE_PRODUCT_SELECT =\r\n      'title,description,price,list_price,stock,track_inventory,category_id,weight,weight_unit,condition,images' as const\r\n    \r\n    // Fetch original product\r\n    const { data: original, error: fetchError } = await supabase\r\n      .from(\"products\")\r\n      .select(DUPLICATE_PRODUCT_SELECT)\r\n      .eq(\"id\", productId)\r\n      .eq(\"seller_id\", user.id)\r\n      .single()\r\n    \r\n    if (fetchError || !original) {\r\n      return { success: false, error: \"Product not found\" }\r\n    }\r\n    \r\n    const { data: originalPrivate } = await supabase\r\n      .from(\"product_private\")\r\n      .select(\"cost_price, sku\")\r\n      .eq(\"product_id\", productId)\r\n      .eq(\"seller_id\", user.id)\r\n      .maybeSingle()\r\n\r\n    // Generate unique slug for duplicate\r\n    const baseSlug = `${original.title}-copy`\r\n      .toLowerCase()\r\n      .replaceAll(/[^a-z0-9]+/g, \"-\")\r\n      .replaceAll(/^-|-$/g, \"\")\r\n    const newSlug = `${baseSlug}-${Date.now().toString(36)}`\r\n    \r\n    const duplicateInsert = await supabase.from(\"products\").insert({\n        seller_id: user.id,\n        title: `${original.title} (Copy)`,\n        description: original.description,\n        price: original.price,\n        list_price: original.list_price,\n        stock: original.stock,\n        track_inventory: original.track_inventory,\n        category_id: original.category_id,\n        status: \"draft\", // Duplicates start as draft\n        weight: original.weight,\n        weight_unit: original.weight_unit,\n        condition: original.condition,\n        images: original.images,\n        slug: newSlug,\n      })\n      .select(\"id\")\n      .single()\n\n    let duplicate = duplicateInsert.data\n    let insertError = duplicateInsert.error\n\n    // If the original product has a non-leaf category, duplication should still succeed\n    // (draft listing can be re-categorized later).\n    if (insertError && isLeafCategoryError(insertError)) {\n      const fallbackInsert = await supabase\n        .from(\"products\")\n        .insert({\n          seller_id: user.id,\n          title: `${original.title} (Copy)`,\n          description: original.description,\n          price: original.price,\n          list_price: original.list_price,\n          stock: original.stock,\n          track_inventory: original.track_inventory,\n          category_id: null,\n          status: \"draft\",\n          weight: original.weight,\n          weight_unit: original.weight_unit,\n          condition: original.condition,\n          images: original.images,\n          slug: newSlug,\n        })\n        .select(\"id\")\n        .single()\n\n      duplicate = fallbackInsert.data\n      insertError = fallbackInsert.error\n    }\n\n    if (insertError || !duplicate) {\n      console.error(\"[duplicateProduct] Insert error:\", insertError)\n      return { success: false, error: \"Failed to duplicate product\" }\n    }\n\r\n    const { error: privateError } = await supabase\r\n      .from(\"product_private\")\r\n      .insert({\r\n        product_id: duplicate.id,\r\n        seller_id: user.id,\r\n        cost_price: originalPrivate?.cost_price ?? null,\r\n        sku: originalPrivate?.sku ? `${originalPrivate.sku}-COPY` : null,\r\n        barcode: null, // Barcode should be unique, don't copy\r\n      })\r\n\r\n    if (privateError) {\r\n      console.error(\"[duplicateProduct] Product private insert error:\", privateError)\r\n      await supabase.from(\"products\").delete().eq(\"id\", duplicate.id)\r\n      return { success: false, error: \"Failed to duplicate seller-only product fields\" }\r\n    }\r\n\r\n    await revalidateProductCaches({\r\n      supabase,\r\n      sellerId: user.id,\r\n      productIds: [duplicate.id],\r\n      categoryIds: [original.category_id],\r\n    })\r\n    \r\n    return { success: true, data: { id: duplicate.id } }\r\n  } catch (error) {\r\n    console.error(\"[duplicateProduct] Error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\actions\\profile.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getProfile' is defined but never used.","line":44,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":26},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 8 times.","line":62,"column":39,"nodeType":"Literal","endLine":62,"endColumn":70},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 8 times.","line":67,"column":39,"nodeType":"Literal","endLine":67,"endColumn":58},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 8 times.","line":100,"column":37,"nodeType":"Literal","endLine":100,"endColumn":67},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'deleteAccount' is defined but never used.","line":498,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":498,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient, createAdminClient } from \"@/lib/supabase/server\"\r\nimport { revalidateTag } from \"next/cache\"\r\nimport { z } from \"zod\"\r\n\r\n// =====================================================\r\n// PROFILE MANAGEMENT SERVER ACTIONS\r\n// For users to manage their profile, avatar, and account settings\r\n// =====================================================\r\n\r\n// Validation schemas\r\nconst profileSchema = z.object({\r\n  full_name: z.string().min(2, \"Name must be at least 2 characters\").max(100).optional(),\r\n  phone: z.string().max(20).optional().nullable(),\r\n  shipping_region: z.string().max(100).optional().nullable(),\r\n  country_code: z.string().max(2).optional().nullable(),\r\n})\r\n\r\nconst emailSchema = z.object({\r\n  email: z.string().email(\"Invalid email address\"),\r\n})\r\n\r\nconst passwordSchema = z.object({\r\n  currentPassword: z.string().min(1, \"Current password is required\"),\r\n  newPassword: z.string()\r\n    .min(8, \"Password must be at least 8 characters\")\r\n    .regex(/[A-Z]/, \"Password must contain at least one uppercase letter\")\r\n    .regex(/[a-z]/, \"Password must contain at least one lowercase letter\")\r\n    .regex(/[0-9]/, \"Password must contain at least one number\"),\r\n  confirmPassword: z.string(),\r\n}).refine((data) => data.newPassword === data.confirmPassword, {\r\n  message: \"Passwords don't match\",\r\n  path: [\"confirmPassword\"],\r\n})\r\n\r\nconst avatarUrlSchema = z.object({\r\n  avatar_url: z.string().url(\"Invalid avatar URL\").max(500, \"Avatar URL too long\"),\r\n})\r\n\r\n// =====================================================\r\n// GET PROFILE\r\n// =====================================================\r\nasync function getProfile(): Promise<{\r\n  success: boolean\r\n  data?: {\r\n    id: string\r\n    email: string | null\r\n    full_name: string | null\r\n    avatar_url: string | null\r\n    phone: string | null\r\n    shipping_region: string | null\r\n    country_code: string | null\r\n    role: string | null\r\n    created_at: string\r\n  }\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    const [\r\n      { data: profile, error: profileError },\r\n      { data: privateProfile },\r\n    ] = await Promise.all([\r\n      supabase\r\n        .from(\"profiles\")\r\n        .select(\"id, full_name, avatar_url, shipping_region, country_code, role, created_at\")\r\n        .eq(\"id\", user.id)\r\n        .single(),\r\n      supabase\r\n        .from(\"private_profiles\")\r\n        .select(\"phone, email\")\r\n        .eq(\"id\", user.id)\r\n        .maybeSingle(),\r\n    ])\r\n\r\n    if (profileError) {\r\n      return { success: false, error: \"Failed to fetch profile\" }\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        ...profile,\r\n        email: user.email ?? privateProfile?.email ?? null,\r\n        phone: privateProfile?.phone ?? null,\r\n      },\r\n    }\r\n  } catch (error) {\r\n    console.error(\"getProfile error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// UPDATE PROFILE\r\n// =====================================================\r\nexport async function updateProfile(formData: FormData): Promise<{\r\n  success: boolean\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Parse and validate form data\r\n    const rawData = {\r\n      full_name: formData.get(\"full_name\") as string | null,\r\n      phone: formData.get(\"phone\") as string | null,\r\n      shipping_region: formData.get(\"shipping_region\") as string | null,\r\n      country_code: formData.get(\"country_code\") as string | null,\r\n    }\r\n\r\n    const validationResult = profileSchema.safeParse(rawData)\r\n    if (!validationResult.success) {\r\n      return { \r\n        success: false, \r\n        error: validationResult.error.issues[0]?.message || \"Invalid input\" \r\n      }\r\n    }\r\n\r\n    const { data: validatedData } = validationResult\r\n\r\n    const updatedAt = new Date().toISOString()\r\n\r\n    const profileUpdatePayload = {\r\n      ...(validatedData.full_name !== undefined ? { full_name: validatedData.full_name } : {}),\r\n      ...(validatedData.shipping_region !== undefined ? { shipping_region: validatedData.shipping_region } : {}),\r\n      ...(validatedData.country_code !== undefined ? { country_code: validatedData.country_code } : {}),\r\n      updated_at: updatedAt,\r\n    }\r\n\r\n    const privateUpdatePayload = validatedData.phone !== undefined\r\n      ? { phone: validatedData.phone, updated_at: updatedAt }\r\n      : null\r\n\r\n    // Update public profile surface + private phone field\r\n    const [{ error: updateError }, { error: privateError }] = await Promise.all([\r\n      supabase\r\n        .from(\"profiles\")\r\n        .update(profileUpdatePayload)\r\n        .eq(\"id\", user.id),\r\n      privateUpdatePayload\r\n        ? supabase\r\n            .from(\"private_profiles\")\r\n            .upsert({ id: user.id, ...privateUpdatePayload }, { onConflict: \"id\" })\r\n        : Promise.resolve({ error: null }),\r\n    ])\r\n\r\n    if (updateError || privateError) {\r\n      console.error(\"updateProfile error:\", updateError || privateError)\r\n      return { success: false, error: \"Failed to update profile\" }\r\n    }\r\n\r\n    revalidateTag(\"profiles\", \"max\")\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"updateProfile error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// UPLOAD AVATAR\r\n// =====================================================\r\nexport async function uploadAvatar(formData: FormData): Promise<{\r\n  success: boolean\r\n  avatarUrl?: string\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    const file = formData.get(\"avatar\") as File | null\r\n    if (!file || file.size === 0) {\r\n      return { success: false, error: \"No file provided\" }\r\n    }\r\n\r\n    // Validate file\r\n    const maxSize = 5 * 1024 * 1024 // 5MB\r\n    if (file.size > maxSize) {\r\n      return { success: false, error: \"File too large. Maximum size is 5MB\" }\r\n    }\r\n\r\n    const allowedTypes = [\"image/jpeg\", \"image/png\", \"image/webp\", \"image/gif\"]\r\n    if (!allowedTypes.includes(file.type)) {\r\n      return { success: false, error: \"Invalid file type. Only JPEG, PNG, WebP, and GIF are allowed\" }\r\n    }\r\n\r\n    // Get file extension from MIME type\r\n    const extension = file.type.split(\"/\")[1] === \"jpeg\" ? \"jpg\" : file.type.split(\"/\")[1]\r\n    const fileName = `${user.id}-${Date.now()}.${extension}`\r\n    const filePath = `${user.id}/${fileName}`\r\n\r\n    // Convert File to ArrayBuffer for upload\r\n    const arrayBuffer = await file.arrayBuffer()\r\n    const fileBuffer = new Uint8Array(arrayBuffer)\r\n\r\n    // Upload to storage\r\n    const { error: uploadError } = await supabase.storage\r\n      .from(\"avatars\")\r\n      .upload(filePath, fileBuffer, {\r\n        contentType: file.type,\r\n        cacheControl: \"3600\",\r\n        upsert: true,\r\n      })\r\n\r\n    if (uploadError) {\r\n      console.error(\"uploadAvatar storage error:\", uploadError)\r\n      return { success: false, error: \"Failed to upload avatar\" }\r\n    }\r\n\r\n    // Get public URL\r\n    const { data: { publicUrl } } = supabase.storage\r\n      .from(\"avatars\")\r\n      .getPublicUrl(filePath)\r\n\r\n    // Update profile with new avatar URL\r\n    const { error: updateError } = await supabase\r\n      .from(\"profiles\")\r\n      .update({\r\n        avatar_url: publicUrl,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", user.id)\r\n\r\n    if (updateError) {\r\n      console.error(\"uploadAvatar profile update error:\", updateError)\r\n      return { success: false, error: \"Failed to update profile with new avatar\" }\r\n    }\r\n\r\n    revalidateTag(\"profiles\", \"max\")\r\n    return { success: true, avatarUrl: publicUrl }\r\n  } catch (error) {\r\n    console.error(\"uploadAvatar error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// SET AVATAR URL (Preset avatars)\r\n// =====================================================\r\nexport async function setAvatarUrl(formData: FormData): Promise<{\r\n  success: boolean\r\n  avatarUrl?: string\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    const rawData = {\r\n      avatar_url: formData.get(\"avatar_url\") as string | null,\r\n    }\r\n\r\n    const validationResult = avatarUrlSchema.safeParse(rawData)\r\n    if (!validationResult.success) {\r\n      return {\r\n        success: false,\r\n        error: validationResult.error.issues[0]?.message || \"Invalid input\",\r\n      }\r\n    }\r\n\r\n    const avatarUrl = validationResult.data.avatar_url\r\n\r\n    const { error: updateError } = await supabase\r\n      .from(\"profiles\")\r\n      .update({\r\n        avatar_url: avatarUrl,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", user.id)\r\n\r\n    if (updateError) {\r\n      console.error(\"setAvatarUrl error:\", updateError)\r\n      return { success: false, error: \"Failed to update avatar\" }\r\n    }\r\n\r\n    revalidateTag(\"profiles\", \"max\")\r\n    return { success: true, avatarUrl }\r\n  } catch (error) {\r\n    console.error(\"setAvatarUrl error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// DELETE AVATAR\r\n// =====================================================\r\nexport async function deleteAvatar(): Promise<{\r\n  success: boolean\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Get current avatar URL\r\n    const { data: profile } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"avatar_url\")\r\n      .eq(\"id\", user.id)\r\n      .single()\r\n\r\n    // If there's an avatar, try to delete it from storage\r\n    if (profile?.avatar_url) {\r\n      // Extract the file path from the URL\r\n      const url = new URL(profile.avatar_url)\r\n      const pathParts = url.pathname.split(\"/avatars/\")\r\n      if (pathParts.length > 1) {\r\n        const filePath = pathParts[1]\r\n        if (filePath) {\r\n          await supabase.storage.from(\"avatars\").remove([filePath])\r\n        }\r\n      }\r\n    }\r\n\r\n    // Update profile to remove avatar URL\r\n    const { error: updateError } = await supabase\r\n      .from(\"profiles\")\r\n      .update({\r\n        avatar_url: null,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", user.id)\r\n\r\n    if (updateError) {\r\n      return { success: false, error: \"Failed to update profile\" }\r\n    }\r\n\r\n    revalidateTag(\"profiles\", \"max\")\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"deleteAvatar error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// UPDATE EMAIL\r\n// =====================================================\r\nexport async function updateEmail(formData: FormData): Promise<{\r\n  success: boolean\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    const newEmail = formData.get(\"email\") as string\r\n    const validationResult = emailSchema.safeParse({ email: newEmail })\r\n    \r\n    if (!validationResult.success) {\r\n      return { \r\n        success: false, \r\n        error: validationResult.error.issues[0]?.message || \"Invalid email\" \r\n      }\r\n    }\r\n\r\n    // Check if email is already in use\r\n    if (newEmail === user.email) {\r\n      return { success: false, error: \"New email is the same as current email\" }\r\n    }\r\n\r\n    // Update email - Supabase will send a confirmation email\r\n    const { error: updateError } = await supabase.auth.updateUser({\r\n      email: newEmail,\r\n    })\r\n\r\n    if (updateError) {\r\n      console.error(\"updateEmail error:\", updateError)\r\n      if (updateError.message.includes(\"already registered\")) {\r\n        return { success: false, error: \"This email is already registered\" }\r\n      }\r\n      return { success: false, error: \"Failed to update email\" }\r\n    }\r\n\r\n    return { \r\n      success: true, \r\n    }\r\n  } catch (error) {\r\n    console.error(\"updateEmail error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// UPDATE PASSWORD\r\n// =====================================================\r\nexport async function updatePassword(formData: FormData): Promise<{\r\n  success: boolean\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    const rawData = {\r\n      currentPassword: formData.get(\"currentPassword\") as string,\r\n      newPassword: formData.get(\"newPassword\") as string,\r\n      confirmPassword: formData.get(\"confirmPassword\") as string,\r\n    }\r\n\r\n    const validationResult = passwordSchema.safeParse(rawData)\r\n    if (!validationResult.success) {\r\n      return { \r\n        success: false, \r\n        error: validationResult.error.issues[0]?.message || \"Invalid input\" \r\n      }\r\n    }\r\n\r\n    // Verify current password by attempting to sign in\r\n    if (!user.email) {\r\n      return { success: false, error: \"Password update is not available for this account\" }\r\n    }\r\n\r\n    const { error: signInError } = await supabase.auth.signInWithPassword({\r\n      email: user.email,\r\n      password: rawData.currentPassword,\r\n    })\r\n\r\n    if (signInError) {\r\n      return { success: false, error: \"Current password is incorrect\" }\r\n    }\r\n\r\n    // Update password\r\n    const { error: updateError } = await supabase.auth.updateUser({\r\n      password: rawData.newPassword,\r\n    })\r\n\r\n    if (updateError) {\r\n      console.error(\"updatePassword error:\", updateError)\r\n      return { success: false, error: \"Failed to update password\" }\r\n    }\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"updatePassword error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// DELETE ACCOUNT\r\n// =====================================================\r\nasync function deleteAccount(): Promise<{\r\n  success: boolean\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Failed to connect to database\" }\r\n    }\r\n\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    const userId = user.id\r\n\r\n    // Use admin client to delete user\r\n    const adminClient = await createAdminClient()\r\n    if (!adminClient) {\r\n      return { success: false, error: \"Failed to initialize admin client\" }\r\n    }\r\n\r\n    // Delete user from auth (this will cascade to profiles due to RLS)\r\n    const { error: deleteError } = await adminClient.auth.admin.deleteUser(userId)\r\n\r\n    if (deleteError) {\r\n      console.error(\"deleteAccount error:\", deleteError)\r\n      return { success: false, error: \"Failed to delete account\" }\r\n    }\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"deleteAccount error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\actions\\reviews.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\actions\\seller-feedback.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":80,"column":39,"nodeType":"Literal","endLine":80,"endColumn":67},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":196,"column":37,"nodeType":"Literal","endLine":196,"endColumn":67},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updateSellerFeedback' is defined but never used.","line":204,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":204,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'deleteSellerFeedback' is defined but never used.","line":286,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":286,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getSellerFeedback' is defined but never used.","line":353,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":353,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'canUserLeaveFeedback' is defined but never used.","line":547,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":547,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'respondToFeedback' is defined but never used.","line":617,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":617,"endColumn":33}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { revalidateTag } from \"next/cache\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { z } from \"zod\"\r\n\r\n// Types\r\nexport interface SellerFeedback {\r\n  id: string\r\n  buyer_id: string\r\n  seller_id: string\r\n  order_id: string | null\r\n  rating: number\r\n  comment: string | null\r\n  item_as_described: boolean\r\n  shipping_speed: boolean\r\n  communication: boolean\r\n  buyer_response: string | null\r\n  buyer_response_at: string | null\r\n  created_at: string\r\n  updated_at: string\r\n  profiles?: {\r\n    full_name: string | null\r\n    avatar_url: string | null\r\n  } | null\r\n  orders?: {\r\n    id: string\r\n    created_at: string\r\n    total_amount: number\r\n  } | null\r\n}\r\n\r\nexport interface SellerFeedbackStats {\r\n  totalFeedback: number\r\n  averageRating: number\r\n  positivePercentage: number\r\n  itemAsDescribedPercentage: number\r\n  shippingSpeedPercentage: number\r\n  communicationPercentage: number\r\n  ratingDistribution: Record<number, number>\r\n}\r\n\r\n// Validation schemas\r\nconst submitFeedbackSchema = z.object({\r\n  sellerId: z.string().uuid(\"Invalid seller ID\"),\r\n  orderId: z.string().uuid(\"Invalid order ID\").optional().nullable(),\r\n  rating: z.number().int().min(1, \"Rating must be at least 1\").max(5, \"Rating must be at most 5\"),\r\n  comment: z.string().max(1000, \"Comment must be 1000 characters or less\").optional().nullable(),\r\n  itemAsDescribed: z.boolean().default(true),\r\n  shippingSpeed: z.boolean().default(true),\r\n  communication: z.boolean().default(true),\r\n})\r\n\r\nconst updateFeedbackSchema = z.object({\r\n  feedbackId: z.string().uuid(\"Invalid feedback ID\"),\r\n  rating: z.number().int().min(1).max(5).optional(),\r\n  comment: z.string().max(1000).optional().nullable(),\r\n  itemAsDescribed: z.boolean().optional(),\r\n  shippingSpeed: z.boolean().optional(),\r\n  communication: z.boolean().optional(),\r\n})\r\n\r\ninterface ActionResult<T = void> {\r\n  success: boolean\r\n  data?: T\r\n  error?: string\r\n}\r\n\r\n/**\r\n * Submit seller feedback after a completed order\r\n * - Validates buyer has a delivered order from this seller\r\n * - Prevents duplicate feedback for same order\r\n */\r\nexport async function submitSellerFeedback(\r\n  input: z.infer<typeof submitFeedbackSchema>\r\n): Promise<ActionResult<{ id: string }>> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    // Validate input\r\n    const validated = submitFeedbackSchema.safeParse(input)\r\n    if (!validated.success) {\r\n      return { success: false, error: validated.error.issues[0]?.message || \"Invalid input\" }\r\n    }\r\n\r\n    // Get current user\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"You must be signed in to leave feedback\" }\r\n    }\r\n\r\n    const data = validated.data\r\n\r\n    // If orderId provided, verify user owns the order and it's delivered.\r\n    // Delivery is tracked on order_items.status (buyerConfirmDelivery updates the item).\r\n    if (data.orderId) {\r\n      const { data: deliveredItem, error: deliveredError } = await supabase\r\n        .from(\"order_items\")\r\n        .select(\r\n          `\r\n          id,\r\n          status,\r\n          order:orders!inner(id, user_id)\r\n        `\r\n        )\r\n        .eq(\"order_id\", data.orderId)\r\n        .eq(\"seller_id\", data.sellerId)\r\n        .eq(\"orders.user_id\", user.id)\r\n        .eq(\"status\", \"delivered\")\r\n        .limit(1)\r\n        .single()\r\n\r\n      if (deliveredError || !deliveredItem) {\r\n        return { success: false, error: \"You can only leave feedback after order delivery\" }\r\n      }\r\n\r\n      // Check if feedback already exists for this order\r\n      const { data: existingFeedback } = await supabase\r\n        .from(\"seller_feedback\")\r\n        .select(\"id\")\r\n        .eq(\"buyer_id\", user.id)\r\n        .eq(\"order_id\", data.orderId)\r\n        .single()\r\n\r\n      if (existingFeedback) {\r\n        return { success: false, error: \"You have already left feedback for this order\" }\r\n      }\r\n    } else {\r\n      // Without orderId, check if user has ANY delivered order item from this seller\r\n      const { data: anyDeliveredItem } = await supabase\r\n        .from(\"order_items\")\r\n        .select(\r\n          `\r\n          id,\r\n          status,\r\n          orders!inner(id, user_id)\r\n        `\r\n        )\r\n        .eq(\"seller_id\", data.sellerId)\r\n        .eq(\"orders.user_id\", user.id)\r\n        .eq(\"status\", \"delivered\")\r\n        .limit(1)\r\n        .single()\r\n\r\n      if (!anyDeliveredItem) {\r\n        return { success: false, error: \"You can only leave feedback after purchasing from this seller\" }\r\n      }\r\n    }\r\n\r\n    // Insert the feedback\r\n    const { data: feedback, error: insertError } = await supabase\r\n      .from(\"seller_feedback\")\r\n      .insert({\r\n        buyer_id: user.id,\r\n        seller_id: data.sellerId,\r\n        order_id: data.orderId || null,\r\n        rating: data.rating,\r\n        comment: data.comment || null,\r\n        item_as_described: data.itemAsDescribed,\r\n        shipping_speed: data.shippingSpeed,\r\n        communication: data.communication,\r\n      })\r\n      .select(\"id\")\r\n      .single()\r\n\r\n    if (insertError) {\r\n      console.error(\"Error inserting seller feedback:\", insertError)\r\n      if (insertError.code === \"23505\") {\r\n        return { success: false, error: \"You have already left feedback for this order\" }\r\n      }\r\n      return { success: false, error: \"Failed to submit feedback\" }\r\n    }\r\n\r\n    // Update seller stats (trigger should handle this, but we can also do it here)\r\n    await updateSellerStatsFromFeedback(supabase, data.sellerId)\r\n\r\n    // Create notification for seller\r\n    await supabase.from(\"notifications\").insert({\r\n      user_id: data.sellerId,\r\n      type: \"review\",\r\n      title: `New ${data.rating}-star feedback`,\r\n      body: data.comment \r\n        ? `A buyer left ${data.rating}-star feedback: \"${data.comment.slice(0, 100)}${data.comment.length > 100 ? '...' : ''}\"`\r\n        : `A buyer left ${data.rating}-star feedback`,\r\n      data: { rating: data.rating, feedback_id: feedback.id },\r\n    })\r\n\r\n    revalidateTag(`seller-${data.sellerId}`, \"max\")\r\n\r\n    return { success: true, data: { id: feedback.id } }\r\n  } catch (error) {\r\n    console.error(\"Error in submitSellerFeedback:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Update existing feedback\r\n * - Only the feedback author can update within 30 days\r\n */\r\nasync function updateSellerFeedback(\r\n  input: z.infer<typeof updateFeedbackSchema>\r\n): Promise<ActionResult> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    // Validate input\r\n    const validated = updateFeedbackSchema.safeParse(input)\r\n    if (!validated.success) {\r\n      return { success: false, error: validated.error.issues[0]?.message || \"Invalid input\" }\r\n    }\r\n\r\n    // Get current user\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"You must be signed in\" }\r\n    }\r\n\r\n    const data = validated.data\r\n\r\n    // Check feedback ownership and age\r\n    const { data: feedback, error: feedbackError } = await supabase\r\n      .from(\"seller_feedback\")\r\n      .select(\"id, buyer_id, seller_id, created_at\")\r\n      .eq(\"id\", data.feedbackId)\r\n      .single()\r\n\r\n    if (feedbackError || !feedback) {\r\n      return { success: false, error: \"Feedback not found\" }\r\n    }\r\n\r\n    if (feedback.buyer_id !== user.id) {\r\n      return { success: false, error: \"You can only edit your own feedback\" }\r\n    }\r\n\r\n    // Check if feedback is within 30 days\r\n    const feedbackDate = new Date(feedback.created_at || Date.now())\r\n    const thirtyDaysAgo = new Date()\r\n    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)\r\n\r\n    if (feedbackDate < thirtyDaysAgo) {\r\n      return { success: false, error: \"Feedback can only be edited within 30 days\" }\r\n    }\r\n\r\n    // Build update object\r\n    const updateData: Record<string, unknown> = { updated_at: new Date().toISOString() }\r\n    if (data.rating !== undefined) updateData.rating = data.rating\r\n    if (data.comment !== undefined) updateData.comment = data.comment\r\n    if (data.itemAsDescribed !== undefined) updateData.item_as_described = data.itemAsDescribed\r\n    if (data.shippingSpeed !== undefined) updateData.shipping_speed = data.shippingSpeed\r\n    if (data.communication !== undefined) updateData.communication = data.communication\r\n\r\n    // Update the feedback\r\n    const { error: updateError } = await supabase\r\n      .from(\"seller_feedback\")\r\n      .update(updateData)\r\n      .eq(\"id\", data.feedbackId)\r\n\r\n    if (updateError) {\r\n      console.error(\"Error updating feedback:\", updateError)\r\n      return { success: false, error: \"Failed to update feedback\" }\r\n    }\r\n\r\n    // Update seller stats\r\n    await updateSellerStatsFromFeedback(supabase, feedback.seller_id)\r\n\r\n    revalidateTag(`seller-${feedback.seller_id}`, \"max\")\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"Error in updateSellerFeedback:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Delete seller feedback\r\n * - Only the buyer or admin can delete\r\n */\r\nasync function deleteSellerFeedback(feedbackId: string): Promise<ActionResult> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    if (!z.string().uuid().safeParse(feedbackId).success) {\r\n      return { success: false, error: \"Invalid feedback ID\" }\r\n    }\r\n\r\n    // Get current user\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"You must be signed in\" }\r\n    }\r\n\r\n    // Get feedback\r\n    const { data: feedback, error: feedbackError } = await supabase\r\n      .from(\"seller_feedback\")\r\n      .select(\"id, buyer_id, seller_id\")\r\n      .eq(\"id\", feedbackId)\r\n      .single()\r\n\r\n    if (feedbackError || !feedback) {\r\n      return { success: false, error: \"Feedback not found\" }\r\n    }\r\n\r\n    // Check if user is admin\r\n    const { data: profile } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"role\")\r\n      .eq(\"id\", user.id)\r\n      .single()\r\n\r\n    const isAdmin = profile?.role === \"admin\"\r\n\r\n    if (feedback.buyer_id !== user.id && !isAdmin) {\r\n      return { success: false, error: \"You can only delete your own feedback\" }\r\n    }\r\n\r\n    // Delete the feedback\r\n    const { error: deleteError } = await supabase\r\n      .from(\"seller_feedback\")\r\n      .delete()\r\n      .eq(\"id\", feedbackId)\r\n\r\n    if (deleteError) {\r\n      console.error(\"Error deleting feedback:\", deleteError)\r\n      return { success: false, error: \"Failed to delete feedback\" }\r\n    }\r\n\r\n    // Update seller stats\r\n    await updateSellerStatsFromFeedback(supabase, feedback.seller_id)\r\n\r\n    revalidateTag(`seller-${feedback.seller_id}`, \"max\")\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"Error in deleteSellerFeedback:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Get seller feedback with pagination\r\n */\r\nasync function getSellerFeedback(\r\n  sellerId: string,\r\n  options?: {\r\n    limit?: number\r\n    offset?: number\r\n    rating?: number\r\n    sortBy?: \"newest\" | \"oldest\" | \"rating_high\" | \"rating_low\"\r\n  }\r\n): Promise<ActionResult<{ feedback: SellerFeedback[]; total: number; stats: SellerFeedbackStats }>> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    if (!z.string().uuid().safeParse(sellerId).success) {\r\n      return { success: false, error: \"Invalid seller ID\" }\r\n    }\r\n\r\n    const limit = options?.limit || 10\r\n    const offset = options?.offset || 0\r\n\r\n    // Build query\r\n    let query = supabase\r\n      .from(\"seller_feedback\")\r\n      .select(`\r\n        id,\r\n        buyer_id,\r\n        seller_id,\r\n        order_id,\r\n        rating,\r\n        comment,\r\n        item_as_described,\r\n        shipping_speed,\r\n        communication,\r\n        buyer_response,\r\n        buyer_response_at,\r\n        created_at,\r\n        updated_at,\r\n        profiles:buyer_id (\r\n          full_name,\r\n          avatar_url\r\n        )\r\n      `, { count: \"exact\" })\r\n      .eq(\"seller_id\", sellerId)\r\n\r\n    // Apply rating filter\r\n    if (options?.rating && options.rating >= 1 && options.rating <= 5) {\r\n      query = query.eq(\"rating\", options.rating)\r\n    }\r\n\r\n    // Apply sorting\r\n    switch (options?.sortBy) {\r\n      case \"oldest\":\r\n        query = query.order(\"created_at\", { ascending: true })\r\n        break\r\n      case \"rating_high\":\r\n        query = query.order(\"rating\", { ascending: false })\r\n        break\r\n      case \"rating_low\":\r\n        query = query.order(\"rating\", { ascending: true })\r\n        break\r\n      case \"newest\":\r\n      default:\r\n        query = query.order(\"created_at\", { ascending: false })\r\n    }\r\n\r\n    // Apply pagination\r\n    query = query.range(offset, offset + limit - 1)\r\n\r\n    const { data, error, count } = await query\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching seller feedback:\", error)\r\n      return { success: false, error: \"Failed to fetch feedback\" }\r\n    }\r\n\r\n    // Get stats\r\n    const stats = await getSellerFeedbackStats(supabase, sellerId)\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        feedback: ((data || []) as unknown as SellerFeedback[]),\r\n        total: count || 0,\r\n        stats,\r\n      },\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error in getSellerFeedback:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Get seller feedback statistics\r\n */\r\nasync function getSellerFeedbackStats(\r\n  supabase: Awaited<ReturnType<typeof createClient>>,\r\n  sellerId: string\r\n): Promise<SellerFeedbackStats> {\r\n  if (!supabase) {\r\n    return {\r\n      totalFeedback: 0,\r\n      averageRating: 0,\r\n      positivePercentage: 100,\r\n      itemAsDescribedPercentage: 100,\r\n      shippingSpeedPercentage: 100,\r\n      communicationPercentage: 100,\r\n      ratingDistribution: { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 },\r\n    }\r\n  }\r\n\r\n  const { data } = await supabase\r\n    .from(\"seller_feedback\")\r\n    .select(\"rating, item_as_described, shipping_speed, communication\")\r\n    .eq(\"seller_id\", sellerId)\r\n\r\n  if (!data || data.length === 0) {\r\n    return {\r\n      totalFeedback: 0,\r\n      averageRating: 0,\r\n      positivePercentage: 100,\r\n      itemAsDescribedPercentage: 100,\r\n      shippingSpeedPercentage: 100,\r\n      communicationPercentage: 100,\r\n      ratingDistribution: { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 },\r\n    }\r\n  }\r\n\r\n  const totalFeedback = data.length\r\n  const totalRating = data.reduce((sum, f) => sum + f.rating, 0)\r\n  const averageRating = totalRating / totalFeedback\r\n\r\n  // Positive = 4 or 5 stars\r\n  const positiveCount = data.filter(f => f.rating >= 4).length\r\n  const positivePercentage = (positiveCount / totalFeedback) * 100\r\n\r\n  // Category percentages\r\n  const itemDescribedCount = data.filter(f => f.item_as_described).length\r\n  const shippingSpeedCount = data.filter(f => f.shipping_speed).length\r\n  const communicationCount = data.filter(f => f.communication).length\r\n\r\n  const itemAsDescribedPercentage = (itemDescribedCount / totalFeedback) * 100\r\n  const shippingSpeedPercentage = (shippingSpeedCount / totalFeedback) * 100\r\n  const communicationPercentage = (communicationCount / totalFeedback) * 100\r\n\r\n  // Rating distribution\r\n  const ratingDistribution: Record<number, number> = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 }\r\n  data.forEach(f => {\r\n    ratingDistribution[f.rating] = (ratingDistribution[f.rating] || 0) + 1\r\n  })\r\n\r\n  return {\r\n    totalFeedback,\r\n    averageRating: Math.round(averageRating * 10) / 10,\r\n    positivePercentage: Math.round(positivePercentage),\r\n    itemAsDescribedPercentage: Math.round(itemAsDescribedPercentage),\r\n    shippingSpeedPercentage: Math.round(shippingSpeedPercentage),\r\n    communicationPercentage: Math.round(communicationPercentage),\r\n    ratingDistribution,\r\n  }\r\n}\r\n\r\n/**\r\n * Update seller_stats table from feedback data\r\n */\r\nasync function updateSellerStatsFromFeedback(\r\n  supabase: Awaited<ReturnType<typeof createClient>>,\r\n  sellerId: string\r\n): Promise<void> {\r\n  if (!supabase) return\r\n\r\n  const stats = await getSellerFeedbackStats(supabase, sellerId)\r\n\r\n  await supabase\r\n    .from(\"seller_stats\")\r\n    .upsert({\r\n      seller_id: sellerId,\r\n      average_rating: stats.averageRating,\r\n      total_reviews: stats.totalFeedback,\r\n      positive_feedback_pct: stats.positivePercentage,\r\n      item_described_pct: stats.itemAsDescribedPercentage,\r\n      shipping_speed_pct: stats.shippingSpeedPercentage,\r\n      communication_pct: stats.communicationPercentage,\r\n      updated_at: new Date().toISOString(),\r\n    }, {\r\n      onConflict: \"seller_id\",\r\n    })\r\n}\r\n\r\n/**\r\n * Check if user can leave feedback for a seller\r\n */\r\nasync function canUserLeaveFeedback(\r\n  sellerId: string,\r\n  orderId?: string\r\n): Promise<ActionResult<{\r\n  canLeaveFeedback: boolean\r\n  hasExistingFeedback: boolean\r\n  hasQualifyingOrder: boolean\r\n}>> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) {\r\n      return {\r\n        success: true,\r\n        data: { canLeaveFeedback: false, hasExistingFeedback: false, hasQualifyingOrder: false },\r\n      }\r\n    }\r\n\r\n    // Check for existing feedback\r\n    let feedbackQuery = supabase\r\n      .from(\"seller_feedback\")\r\n      .select(\"id\")\r\n      .eq(\"buyer_id\", user.id)\r\n      .eq(\"seller_id\", sellerId)\r\n\r\n    if (orderId) {\r\n      feedbackQuery = feedbackQuery.eq(\"order_id\", orderId)\r\n    }\r\n\r\n    const { data: existingFeedback } = await feedbackQuery.single()\r\n    const hasExistingFeedback = !!existingFeedback\r\n\r\n    // Check for qualifying orders\r\n    const { data: qualifyingOrder } = await supabase\r\n      .from(\"order_items\")\r\n      .select(`\r\n        id,\r\n        orders!inner (\r\n          id,\r\n          user_id,\r\n          status\r\n        )\r\n      `)\r\n      .eq(\"seller_id\", sellerId)\r\n      .eq(\"orders.user_id\", user.id)\r\n      .in(\"orders.status\", [\"delivered\", \"completed\"])\r\n      .limit(1)\r\n      .single()\r\n\r\n    const hasQualifyingOrder = !!qualifyingOrder\r\n    const canLeaveFeedback = !hasExistingFeedback && hasQualifyingOrder\r\n\r\n    return {\r\n      success: true,\r\n      data: { canLeaveFeedback, hasExistingFeedback, hasQualifyingOrder },\r\n    }\r\n  } catch (error) {\r\n    console.error(\"Error in canUserLeaveFeedback:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n/**\r\n * Seller: Respond to feedback (buyer_response field)\r\n * Note: This is for the seller to respond via buyer_response field on seller_feedback\r\n */\r\nasync function respondToFeedback(\r\n  feedbackId: string,\r\n  response: string\r\n): Promise<ActionResult> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    if (!z.string().uuid().safeParse(feedbackId).success) {\r\n      return { success: false, error: \"Invalid feedback ID\" }\r\n    }\r\n\r\n    if (!response || response.trim().length === 0) {\r\n      return { success: false, error: \"Response cannot be empty\" }\r\n    }\r\n\r\n    if (response.length > 500) {\r\n      return { success: false, error: \"Response must be 500 characters or less\" }\r\n    }\r\n\r\n    // Get current user\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"You must be signed in\" }\r\n    }\r\n\r\n    // Get feedback and verify seller\r\n    const { data: feedback, error: feedbackError } = await supabase\r\n      .from(\"seller_feedback\")\r\n      .select(\"id, seller_id, buyer_id\")\r\n      .eq(\"id\", feedbackId)\r\n      .single()\r\n\r\n    if (feedbackError || !feedback) {\r\n      return { success: false, error: \"Feedback not found\" }\r\n    }\r\n\r\n    if (feedback.seller_id !== user.id) {\r\n      return { success: false, error: \"Only the seller can respond to feedback\" }\r\n    }\r\n\r\n    // Update with seller's response (using buyer_response field for seller's reply)\r\n    const { error: updateError } = await supabase\r\n      .from(\"seller_feedback\")\r\n      .update({\r\n        buyer_response: response.trim(),\r\n        buyer_response_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", feedbackId)\r\n\r\n    if (updateError) {\r\n      console.error(\"Error responding to feedback:\", updateError)\r\n      return { success: false, error: \"Failed to submit response\" }\r\n    }\r\n\r\n    // Notify the buyer\r\n    await supabase.from(\"notifications\").insert({\r\n      user_id: feedback.buyer_id,\r\n      type: \"review\",\r\n      title: \"Seller responded to your feedback\",\r\n      body: \"The seller has responded to your feedback\",\r\n      data: { feedback_id: feedbackId },\r\n    })\r\n\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"Error in respondToFeedback:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\actions\\seller-follows.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'toggleFollowSeller' is defined but never used.","line":72,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":72,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { revalidateTag } from \"next/cache\"\r\n\r\n// =====================================================\r\n// SELLER FOLLOWS SERVER ACTIONS\r\n// Mutation actions only - page.tsx handles data fetching\r\n// =====================================================\r\n\r\nexport async function isFollowingSeller(sellerId: string) {\r\n  const supabase = await createClient()\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  \r\n  if (!user) return false\r\n\r\n  const { data } = await supabase\r\n    .from(\"store_followers\")\r\n    .select(\"id\")\r\n    .eq(\"follower_id\", user.id)\r\n    .eq(\"seller_id\", sellerId)\r\n    .maybeSingle()\r\n\r\n  return !!data\r\n}\r\n\r\nexport async function followSeller(sellerId: string) {\r\n  const supabase = await createClient()\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  \r\n  if (!user) {\r\n    return { success: false, error: \"Not authenticated\" }\r\n  }\r\n\r\n  const { error } = await supabase\r\n    .from(\"store_followers\")\r\n    .insert({ follower_id: user.id, seller_id: sellerId })\r\n\r\n  if (error) {\r\n    if (error.code === \"23505\") return { success: true } // Already following\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidateTag(\"follows\", \"max\")\r\n  revalidateTag(\"profiles\", \"max\")\r\n  return { success: true }\r\n}\r\n\r\nexport async function unfollowSeller(sellerId: string) {\r\n  const supabase = await createClient()\r\n  const { data: { user } } = await supabase.auth.getUser()\r\n  \r\n  if (!user) {\r\n    return { success: false, error: \"Not authenticated\" }\r\n  }\r\n\r\n  const { error } = await supabase\r\n    .from(\"store_followers\")\r\n    .delete()\r\n    .eq(\"follower_id\", user.id)\r\n    .eq(\"seller_id\", sellerId)\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message }\r\n  }\r\n\r\n  revalidateTag(\"follows\", \"max\")\r\n  revalidateTag(\"profiles\", \"max\")\r\n  return { success: true }\r\n}\r\n\r\nasync function toggleFollowSeller(sellerId: string) {\r\n  const isFollowing = await isFollowingSeller(sellerId)\r\n  \r\n  if (isFollowing) {\r\n    const result = await unfollowSeller(sellerId)\r\n    return { ...result, isFollowing: false }\r\n  } else {\r\n    const result = await followSeller(sellerId)\r\n    return { ...result, isFollowing: true }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\actions\\subscriptions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getSubscriptionDetails' is defined but never used.","line":324,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":324,"endColumn":38},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getAvailableUpgrades' is defined but never used.","line":535,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":535,"endColumn":36}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { z } from \"zod\"\nimport { errorEnvelope, successEnvelope, type Envelope } from \"@/lib/api/envelope\"\nimport { createAdminClient, createClient } from \"@/lib/supabase/server\"\nimport { stripe } from \"@/lib/stripe\"\nimport { ID_AND_STRIPE_CUSTOMER_ID_SELECT, STRIPE_CUSTOMER_ID_SELECT } from \"@/lib/supabase/selects/billing\"\nimport { revalidateTag } from \"next/cache\"\nimport type Stripe from \"stripe\"\n\r\n// =============================================================================\r\n// TYPES\r\n// =============================================================================\r\n\r\nexport type BillingPeriod = \"monthly\" | \"yearly\"\r\n\r\nconst billingPeriodSchema = z.enum([\"monthly\", \"yearly\"])\r\nconst localeSchema = z.enum([\"en\", \"bg\"]).optional()\r\nconst subscriptionCheckoutArgsSchema = z.object({\r\n  planId: z.string().min(1),\r\n  billingPeriod: billingPeriodSchema,\r\n  locale: localeSchema,\r\n})\r\n\r\nexport interface SubscriptionDetails {\r\n  id: string\r\n  plan_type: string\r\n  status: \"active\" | \"cancelled\" | \"expired\" | \"pending\"\r\n  billing_period: \"monthly\" | \"yearly\"\r\n  price_paid: number\r\n  currency: string\r\n  starts_at: string\r\n  expires_at: string\r\n  auto_renew: boolean\r\n  stripe_subscription_id: string | null\r\n  // Computed\r\n  days_remaining: number\r\n  cancel_at_period_end: boolean\r\n}\r\n\r\nexport type ActionResult<T = void> = Envelope<\n  { data?: T },\n  { error: string }\n>\n\ntype CheckoutSessionResult = Envelope<\n  { url: string },\n  { error: string }\n>\n\ntype BillingPortalSessionResult = Envelope<\n  { url: string },\n  { error: string }\n>\n\ntype DowngradeResult = Envelope<\n  { tier: \"free\" },\n  { error: string }\n>\n\r\nconst SUBSCRIPTION_PLAN_SELECT_FOR_CHECKOUT =\n  \"id,name,tier,is_active,price_monthly,price_yearly,stripe_price_monthly_id,stripe_price_yearly_id,final_value_fee,commission_rate\" as const\nconst SUBSCRIPTION_SELECT_FOR_DETAILS =\r\n  \"id,plan_type,status,billing_period,price_paid,currency,starts_at,expires_at,auto_renew,stripe_subscription_id,stripe_customer_id,created_at\" as const\r\n\r\ntype CheckoutSessionCreateParams = Stripe.Checkout.SessionCreateParams\r\ntype CheckoutLineItem = Stripe.Checkout.SessionCreateParams.LineItem\r\n\r\n// =============================================================================\r\n// HELPERS\r\n// =============================================================================\r\n\r\nfunction getAppUrl() {\r\n  return (\r\n    process.env.NEXT_PUBLIC_APP_URL ||\r\n    process.env.NEXT_PUBLIC_URL ||\r\n    \"http://localhost:3000\"\r\n  )\r\n}\r\n\r\nfunction normalizeLocale(locale: unknown): \"en\" | \"bg\" {\r\n  return locale === \"bg\" ? \"bg\" : \"en\"\r\n}\r\n\r\nfunction getAbsoluteAccountPlansUrl(locale: unknown) {\r\n  const base = getAppUrl().replace(/\\/$/, \"\")\r\n  const safeLocale = normalizeLocale(locale)\r\n  return `${base}/${safeLocale}/account/plans`\r\n}\r\n\r\n// =============================================================================\r\n// CHECKOUT & PORTAL SESSIONS\r\n// =============================================================================\r\n\r\nexport async function createSubscriptionCheckoutSession(args: {\n  planId: string\n  billingPeriod: BillingPeriod\n  locale?: \"en\" | \"bg\"\n}): Promise<CheckoutSessionResult> {\n  if (!process.env.STRIPE_SECRET_KEY) {\n    console.error(\"STRIPE_SECRET_KEY is missing\")\n    return errorEnvelope({ error: \"Stripe configuration is missing. Please check your server logs.\" })\n  }\n\n  const parsedArgs = subscriptionCheckoutArgsSchema.safeParse(args)\n  if (!parsedArgs.success) {\n    return errorEnvelope({ error: \"Invalid input\" })\n  }\n\r\n  const { planId, billingPeriod, locale } = parsedArgs.data\r\n\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    const {\n      data: { user },\n    } = await supabase.auth.getUser()\n\n    if (!user) {\n      return errorEnvelope({ error: \"Unauthorized\" })\n    }\n\r\n    const { data: profile } = await supabase\n      .from(\"private_profiles\")\n      .select(ID_AND_STRIPE_CUSTOMER_ID_SELECT)\n      .eq(\"id\", user.id)\n      .single()\n\r\n    if (!profile) {\n      return errorEnvelope({ error: \"Profile not found\" })\n    }\n\r\n    const { data: plan } = await supabase\r\n      .from(\"subscription_plans\")\r\n      .select(SUBSCRIPTION_PLAN_SELECT_FOR_CHECKOUT)\r\n      .eq(\"id\", planId)\r\n      .eq(\"is_active\", true)\r\n      .single()\r\n\r\n    if (!plan) {\n      return errorEnvelope({ error: \"Plan not found\" })\n    }\n\n    if ((plan.price_monthly ?? 0) === 0) {\n      return errorEnvelope({ error: \"Cannot subscribe to free tier\" })\n    }\n\r\n    const price = billingPeriod === \"yearly\" ? plan.price_yearly : plan.price_monthly\r\n\r\n    let customerId: string | null | undefined = profile.stripe_customer_id\r\n\r\n    if (!customerId) {\r\n      const customer = await stripe.customers.create({\r\n        ...(user.email ? { email: user.email } : {}),\r\n        metadata: {\r\n          profile_id: profile.id,\r\n          supabase_user_id: user.id,\r\n        },\r\n      })\r\n\r\n      customerId = customer.id\r\n\r\n      await supabase\r\n        .from(\"private_profiles\")\r\n        .upsert({ id: profile.id, stripe_customer_id: customerId }, { onConflict: \"id\" })\r\n    }\r\n\r\n    const stripePriceId =\r\n      billingPeriod === \"yearly\" ? plan.stripe_price_yearly_id : plan.stripe_price_monthly_id\r\n\r\n    // Use Stripe Price IDs when available (preferred), fallback to inline EUR pricing\r\n    const useStripePriceId = !!(stripePriceId && stripePriceId.startsWith(\"price_\"))\r\n    \r\n    const lineItems: CheckoutLineItem[] = useStripePriceId\r\n      ? [{ price: stripePriceId, quantity: 1 }]\r\n      : [{\r\n          price_data: {\r\n            currency: \"eur\",\r\n            product_data: {\r\n              name: `${plan.name} Plan`,\r\n              description: `${plan.name} seller subscription - ${billingPeriod}`,\r\n            },\r\n            unit_amount: Math.round(Number(price ?? 0) * 100),\r\n            recurring: {\r\n              interval: billingPeriod === \"yearly\" ? \"year\" : \"month\",\r\n            },\r\n          },\r\n          quantity: 1,\r\n        }]\r\n\r\n    const accountPlansUrl = getAbsoluteAccountPlansUrl(locale)\r\n\r\n    const checkoutParams: Omit<CheckoutSessionCreateParams, \"line_items\"> = {\r\n      ...(customerId ? { customer: customerId } : {}),\r\n      mode: \"subscription\" as const,\r\n      payment_method_types: [\"card\"],\r\n      metadata: {\r\n        profile_id: profile.id,\r\n        plan_id: planId,\r\n        plan_tier: plan.tier,\r\n        billing_period: billingPeriod,\r\n        commission_rate: (plan.final_value_fee ?? plan.commission_rate ?? 12).toString(),\r\n      },\r\n      allow_promotion_codes: true,\r\n      billing_address_collection: \"required\" as const,\r\n      success_url: `${accountPlansUrl}?success=true&session_id={CHECKOUT_SESSION_ID}`,\r\n      cancel_url: `${accountPlansUrl}?canceled=true`,\r\n    }\r\n\r\n    const session = await stripe.checkout.sessions.create({\n      ...checkoutParams,\n      line_items: lineItems,\n    })\n\n    return session.url\n      ? successEnvelope({ url: session.url })\n      : errorEnvelope({ error: \"Failed to start checkout\" })\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : \"Internal server error\"\n    const errorType = error instanceof Error ? error.constructor.name : typeof error\n    console.error(`[subscriptions] ${errorType}: ${errorMessage}`)\n    return errorEnvelope({ error: errorMessage })\n  }\n}\n\nexport async function createBillingPortalSession(\n  args?: { locale?: \"en\" | \"bg\" }\n): Promise<BillingPortalSessionResult> {\n    const accountPlansUrl = getAbsoluteAccountPlansUrl(args?.locale)\n  if (!process.env.STRIPE_SECRET_KEY) {\n    console.error(\"STRIPE_SECRET_KEY is missing\")\n    return errorEnvelope({ error: \"Stripe configuration is missing. Please check your server logs.\" })\n  }\n\r\n  try {\r\n    const supabase = await createClient()\r\n\r\n    const {\n      data: { user },\n    } = await supabase.auth.getUser()\n\n    if (!user) {\n      return errorEnvelope({ error: \"Unauthorized\" })\n    }\n\r\n    const { data: activeSubscription } = await supabase\n      .from(\"subscriptions\")\n      .select(STRIPE_CUSTOMER_ID_SELECT)\n      .eq(\"seller_id\", user.id)\n      .eq(\"status\", \"active\")\n      .single()\n\r\n    const stripeCustomerIdFromSubscription = activeSubscription?.stripe_customer_id\r\n\r\n    const stripeCustomerId = stripeCustomerIdFromSubscription || null\r\n\r\n    if (!stripeCustomerId) {\r\n      // Fallback: profile might have a customer id even if subscription row isn't present\r\n      const { data: profile } = await supabase\n        .from(\"private_profiles\")\n        .select(STRIPE_CUSTOMER_ID_SELECT)\n        .eq(\"id\", user.id)\n        .single()\n\r\n      if (!profile?.stripe_customer_id) {\n        return errorEnvelope({ error: \"No active subscription found\" })\n      }\n\r\n      const portalSession = await stripe.billingPortal.sessions.create({\n        customer: profile.stripe_customer_id,\n        return_url: accountPlansUrl,\n      })\n\n      return successEnvelope({ url: portalSession.url })\n    }\n\r\n    const portalSession = await stripe.billingPortal.sessions.create({\n      customer: stripeCustomerId,\n      return_url: accountPlansUrl,\n    })\n\n    return successEnvelope({ url: portalSession.url })\n  } catch (error) {\n    console.error(\"Portal session error:\", error)\n    return errorEnvelope({ error: \"Failed to create portal session\" })\n  }\n}\n\nexport async function downgradeToFreeTier(): Promise<DowngradeResult> {\n  try {\n    const supabase = await createClient()\n    const adminSupabase = createAdminClient()\n\r\n    const {\n      data: { user },\n    } = await supabase.auth.getUser()\n\n    if (!user) {\n      return errorEnvelope({ error: \"Unauthorized\" })\n    }\n\r\n    const userId = user.id\r\n\r\n    const { error } = await adminSupabase\r\n      .from(\"profiles\")\r\n      .update({ tier: \"free\" })\r\n      .eq(\"id\", userId)\r\n\r\n    if (error) {\n      return errorEnvelope({ error: error.message })\n    }\n\n    return successEnvelope({ tier: \"free\" as const })\n  } catch (error) {\n    console.error(\"Downgrade to free error:\", error)\n    return errorEnvelope({ error: \"Failed to change plan. Please try again.\" })\n  }\n}\n\r\n// =============================================================================\r\n// GET SUBSCRIPTION DETAILS\r\n// =============================================================================\r\n\r\nasync function getSubscriptionDetails(): Promise<ActionResult<SubscriptionDetails | null>> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Get active subscription from database\r\n    const { data: subscription, error } = await supabase\r\n      .from(\"subscriptions\")\r\n      .select(SUBSCRIPTION_SELECT_FOR_DETAILS)\r\n      .eq(\"seller_id\", user.id)\r\n      .in(\"status\", [\"active\", \"cancelled\"]) // Include cancelled but not yet expired\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(1)\r\n      .single()\r\n\r\n    if (error && error.code !== \"PGRST116\") {\r\n      // PGRST116 = no rows found (that's ok, they might be on free tier)\r\n      console.error(\"Error fetching subscription:\", error)\r\n      return { success: false, error: \"Failed to fetch subscription\" }\r\n    }\r\n\r\n    if (!subscription) {\r\n      return { success: true, data: null }\r\n    }\r\n\r\n    // Calculate days remaining\r\n    const expiresAt = new Date(subscription.expires_at)\r\n    const now = new Date()\r\n    const daysRemaining = Math.max(0, Math.ceil((expiresAt.getTime() - now.getTime()) / (1000 * 60 * 60 * 24)))\r\n\r\n    // Check Stripe for cancel_at_period_end status if we have stripe_subscription_id\r\n    let cancelAtPeriodEnd = false\r\n    if (subscription.stripe_subscription_id) {\r\n      try {\r\n        const stripeSubscription = await stripe.subscriptions.retrieve(subscription.stripe_subscription_id)\r\n        cancelAtPeriodEnd = stripeSubscription.cancel_at_period_end\r\n      } catch (stripeError) {\r\n        // Subscription might not exist in Stripe anymore, that's ok\r\n        console.warn(\"Could not fetch Stripe subscription:\", stripeError)\r\n      }\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        id: subscription.id,\r\n        plan_type: subscription.plan_type,\r\n        status: (subscription.status || \"active\") as \"active\" | \"cancelled\" | \"expired\" | \"pending\",\r\n        billing_period: (subscription.billing_period || \"monthly\") as \"monthly\" | \"yearly\",\r\n        price_paid: subscription.price_paid,\r\n        currency: subscription.currency || \"EUR\",\r\n        starts_at: subscription.starts_at || new Date().toISOString(),\r\n        expires_at: subscription.expires_at,\r\n        auto_renew: subscription.auto_renew ?? true,\r\n        stripe_subscription_id: subscription.stripe_subscription_id,\r\n        days_remaining: daysRemaining,\r\n        cancel_at_period_end: cancelAtPeriodEnd,\r\n      },\r\n    }\r\n  } catch (error) {\r\n    console.error(\"getSubscriptionDetails error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// CANCEL SUBSCRIPTION\r\n// Schedule cancellation at end of billing period (NOT immediate)\r\n// User keeps benefits until period ends, then reverts to free tier\r\n// =============================================================================\r\n\r\nexport async function cancelSubscription(): Promise<ActionResult> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Get the active subscription\r\n    const { data: subscription, error: fetchError } = await supabase\r\n      .from(\"subscriptions\")\r\n      .select(\"id,status,auto_renew,expires_at,stripe_subscription_id\")\r\n      .eq(\"seller_id\", user.id)\r\n      .eq(\"status\", \"active\")\r\n      .single()\r\n\r\n    if (fetchError || !subscription) {\r\n      return { success: false, error: \"No active subscription found\" }\r\n    }\r\n\r\n    // If we have a Stripe subscription, cancel it at period end\r\n    if (subscription.stripe_subscription_id) {\r\n      try {\r\n        await stripe.subscriptions.update(subscription.stripe_subscription_id, {\r\n          cancel_at_period_end: true, // KEY: Cancel at END of period, not immediately\r\n        })\r\n      } catch (stripeError) {\r\n        console.error(\"Stripe cancellation error:\", stripeError)\r\n        return { success: false, error: \"Failed to cancel with payment provider\" }\r\n      }\r\n    }\r\n\r\n    // Update our database to reflect cancellation scheduled\r\n    // Status stays 'active' until period actually ends (webhook handles that)\r\n    // We just mark auto_renew = false\r\n    const { error: updateError } = await supabase\r\n      .from(\"subscriptions\")\r\n      .update({\r\n        auto_renew: false,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", subscription.id)\r\n\r\n    if (updateError) {\r\n      console.error(\"Database update error:\", updateError)\r\n      return { success: false, error: \"Failed to update subscription\" }\r\n    }\r\n\r\n    revalidateTag(\"profiles\", \"max\")\r\n    revalidateTag(\"subscriptions\", \"max\")\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"cancelSubscription error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// REACTIVATE SUBSCRIPTION\r\n// If user cancelled but period hasn't ended, they can reactivate\r\n// =============================================================================\r\n\r\nexport async function reactivateSubscription(): Promise<ActionResult> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Get subscription that's active but set to cancel\r\n    const { data: subscription, error: fetchError } = await supabase\r\n      .from(\"subscriptions\")\r\n      .select(\"id,status,auto_renew,expires_at,stripe_subscription_id\")\r\n      .eq(\"seller_id\", user.id)\r\n      .eq(\"status\", \"active\")\r\n      .eq(\"auto_renew\", false)\r\n      .single()\r\n\r\n    if (fetchError || !subscription) {\r\n      return { success: false, error: \"No cancellation to revert\" }\r\n    }\r\n\r\n    // Reactivate in Stripe\r\n    if (subscription.stripe_subscription_id) {\r\n      try {\r\n        await stripe.subscriptions.update(subscription.stripe_subscription_id, {\r\n          cancel_at_period_end: false, // Reactivate auto-renewal\r\n        })\r\n      } catch (stripeError) {\r\n        console.error(\"Stripe reactivation error:\", stripeError)\r\n        return { success: false, error: \"Failed to reactivate with payment provider\" }\r\n      }\r\n    }\r\n\r\n    // Update database\r\n    const { error: updateError } = await supabase\r\n      .from(\"subscriptions\")\r\n      .update({\r\n        auto_renew: true,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", subscription.id)\r\n\r\n    if (updateError) {\r\n      console.error(\"Database update error:\", updateError)\r\n      return { success: false, error: \"Failed to update subscription\" }\r\n    }\r\n\r\n    revalidateTag(\"profiles\", \"max\")\r\n    revalidateTag(\"subscriptions\", \"max\")\r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"reactivateSubscription error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// CHECK IF USER CAN UPGRADE\r\n// Returns the tiers they can upgrade to\r\n// =============================================================================\r\n\r\nconst TIER_ORDER = [\"free\", \"starter\", \"basic\", \"premium\", \"professional\", \"business\", \"enterprise\"]\r\n\r\nasync function getAvailableUpgrades(): Promise<ActionResult<string[]>> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Get user's current tier from profile\r\n    const { data: profile } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"tier, account_type\")\r\n      .eq(\"id\", user.id)\r\n      .single()\r\n\r\n    if (!profile) {\r\n      return { success: true, data: TIER_ORDER.slice(1) } // All paid tiers\r\n    }\r\n\r\n    const currentTierIndex = TIER_ORDER.indexOf(profile.tier || \"free\")\r\n    const upgradeTiers = TIER_ORDER.slice(currentTierIndex + 1)\r\n\r\n    return { success: true, data: upgradeTiers }\r\n  } catch (error) {\r\n    console.error(\"getAvailableUpgrades error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\actions\\username.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 7 times.","line":58,"column":41,"nodeType":"Literal","endLine":58,"endColumn":69},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 5 times.","line":94,"column":39,"nodeType":"Literal","endLine":94,"endColumn":58},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":184,"column":37,"nodeType":"Literal","endLine":184,"endColumn":67}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use server\"\r\n\r\nimport { createAdminClient, createClient } from \"@/lib/supabase/server\"\r\nimport { revalidateTag } from \"next/cache\"\r\nimport { z } from \"zod\"\r\n\r\n// =====================================================\r\n// USERNAME & PUBLIC PROFILE MANAGEMENT\r\n// =====================================================\r\n\r\n// Username validation schema\r\nconst usernameSchema = z\r\n  .string()\r\n  .min(3, \"Username must be at least 3 characters\")\r\n  .max(30, \"Username must be less than 30 characters\")\r\n  .regex(/^[a-z0-9]/, \"Username must start with a letter or number\")\r\n  .regex(/^[a-z0-9_]+$/, \"Username can only contain lowercase letters, numbers, and underscores\")\r\n  .refine((val) => !val.includes(\"__\"), \"Username cannot have consecutive underscores\")\r\n  .refine((val) => !val.endsWith(\"_\"), \"Username cannot end with an underscore\")\r\n\r\n// Reserved usernames that cannot be used\r\nconst RESERVED_USERNAMES = [\r\n  \"admin\", \"administrator\", \"support\", \"help\", \"info\", \"contact\",\r\n  \"treido\", \"store\", \"shop\", \"seller\", \"buyer\", \"user\", \"users\",\r\n  \"account\", \"settings\", \"profile\", \"members\", \"member\", \"api\",\r\n  \"auth\", \"login\", \"signup\", \"register\", \"logout\", \"signout\",\r\n  \"home\", \"index\", \"about\", \"terms\", \"privacy\", \"legal\",\r\n  \"search\", \"explore\", \"discover\", \"trending\", \"popular\",\r\n  \"checkout\", \"cart\", \"order\", \"orders\", \"payment\", \"payments\",\r\n  \"sell\", \"selling\", \"buy\", \"buying\", \"deals\", \"offers\",\r\n  \"messages\", \"notifications\", \"inbox\", \"outbox\",\r\n  \"test\", \"demo\", \"example\", \"null\", \"undefined\", \"root\",\r\n]\r\n\r\n// =====================================================\r\n// CHECK USERNAME AVAILABILITY\r\n// =====================================================\r\nexport async function checkUsernameAvailability(username: string): Promise<{\r\n  available: boolean\r\n  error?: string\r\n}> {\r\n  try {\r\n    const normalizedUsername = username.toLowerCase().trim()\r\n    \r\n    // Validate format\r\n    const validation = usernameSchema.safeParse(normalizedUsername)\r\n    if (!validation.success) {\r\n      return { available: false, error: validation.error.issues[0]?.message ?? \"Invalid username\" }\r\n    }\r\n    \r\n    // Check reserved\r\n    if (RESERVED_USERNAMES.includes(normalizedUsername)) {\r\n      return { available: false, error: \"This username is reserved\" }\r\n    }\r\n    \r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { available: false, error: \"Database connection failed\" }\r\n    }\r\n    \r\n    // Check if taken\r\n    const { data: existing } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"id\")\r\n      .ilike(\"username\", normalizedUsername)\r\n      .maybeSingle()\r\n    \r\n    if (existing) {\r\n      return { available: false, error: \"This username is already taken\" }\r\n    }\r\n    \r\n    return { available: true }\r\n  } catch (error) {\r\n    console.error(\"checkUsernameAvailability error:\", error)\r\n    return { available: false, error: \"Failed to check username\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// SET USERNAME (First time or change)\r\n// =====================================================\r\nexport async function setUsername(username: string): Promise<{\r\n  success: boolean\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n    \r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n    \r\n    const normalizedUsername = username.toLowerCase().trim()\r\n    \r\n    // Validate format\r\n    const validation = usernameSchema.safeParse(normalizedUsername)\r\n    if (!validation.success) {\r\n      return { success: false, error: validation.error.issues[0]?.message ?? \"Invalid username\" }\r\n    }\r\n    \r\n    // Check reserved\r\n    if (RESERVED_USERNAMES.includes(normalizedUsername)) {\r\n      return { success: false, error: \"This username is reserved\" }\r\n    }\r\n    \r\n    // Get current profile\r\n    const { data: profile } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"username, last_username_change\")\r\n      .eq(\"id\", user.id)\r\n      .single()\r\n\r\n    const previousUsername = profile?.username ? profile.username.toLowerCase().trim() : null\r\n    \r\n    // Check if this is a change (not first time)\r\n    if (profile?.username) {\r\n      // Check if change is allowed (14 day cooldown)\r\n      if (profile.last_username_change) {\r\n        const lastChange = new Date(profile.last_username_change)\r\n        const cooldownEnd = new Date(lastChange.getTime() + 14 * 24 * 60 * 60 * 1000)\r\n        \r\n        if (new Date() < cooldownEnd) {\r\n          const daysLeft = Math.ceil((cooldownEnd.getTime() - Date.now()) / (24 * 60 * 60 * 1000))\r\n          return { \r\n            success: false, \r\n            error: `You can change your username in ${daysLeft} day${daysLeft > 1 ? 's' : ''}` \r\n          }\r\n        }\r\n      }\r\n      \r\n      // Record the change in history\r\n      await supabase.from(\"username_history\").insert({\r\n        user_id: user.id,\r\n        old_username: profile.username,\r\n        new_username: normalizedUsername,\r\n      })\r\n    }\r\n    \r\n    // Check availability\r\n    const { data: existing } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"id\")\r\n      .ilike(\"username\", normalizedUsername)\r\n      .neq(\"id\", user.id)\r\n      .maybeSingle()\r\n    \r\n    if (existing) {\r\n      return { success: false, error: \"This username is already taken\" }\r\n    }\r\n    \r\n    // Update username\r\n    const { error: updateError } = await supabase\r\n      .from(\"profiles\")\r\n      .update({\r\n        username: normalizedUsername,\r\n        last_username_change: profile?.username ? new Date().toISOString() : null,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", user.id)\r\n    \r\n    if (updateError) {\r\n      console.error(\"setUsername error:\", updateError)\r\n      return { success: false, error: \"Failed to update username\" }\r\n    }\r\n\r\n    revalidateTag(\"profiles\", \"max\")\r\n    revalidateTag(`profile-${normalizedUsername}`, \"max\")\r\n    revalidateTag(`profile-meta-${normalizedUsername}`, \"max\")\r\n    revalidateTag(`seller-${user.id}`, \"max\")\r\n    revalidateTag(`seller-${normalizedUsername}`, \"max\")\r\n    if (previousUsername) {\r\n      revalidateTag(`profile-${previousUsername}`, \"max\")\r\n      revalidateTag(`profile-meta-${previousUsername}`, \"max\")\r\n      revalidateTag(`seller-${previousUsername}`, \"max\")\r\n    }\r\n    \r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"setUsername error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// UPDATE PUBLIC PROFILE\r\n// =====================================================\r\nconst publicProfileSchema = z.object({\r\n  display_name: z.string().max(50, \"Display name must be less than 50 characters\").optional().nullable(),\r\n  bio: z.string().max(500, \"Bio must be less than 500 characters\").optional().nullable(),\r\n  location: z.string().max(100, \"Location must be less than 100 characters\").optional().nullable(),\r\n  website_url: z.string().url(\"Invalid website URL\").optional().nullable().or(z.literal(\"\")),\r\n  social_links: z.object({\r\n    facebook: z.string().optional().nullable(),\r\n    instagram: z.string().optional().nullable(),\r\n    twitter: z.string().optional().nullable(),\r\n    tiktok: z.string().optional().nullable(),\r\n    youtube: z.string().optional().nullable(),\r\n  }).optional().nullable(),\r\n})\r\n\r\nexport async function updatePublicProfile(data: z.infer<typeof publicProfileSchema>): Promise<{\r\n  success: boolean\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n    \r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n    \r\n    // Validate\r\n    const validation = publicProfileSchema.safeParse(data)\r\n    if (!validation.success) {\r\n      return { success: false, error: validation.error.issues[0]?.message ?? \"Invalid profile data\" }\r\n    }\r\n    \r\n    const updateData: Record<string, unknown> = {\r\n      updated_at: new Date().toISOString(),\r\n    }\r\n    \r\n    if (data.display_name !== undefined) updateData.display_name = data.display_name || null\r\n    if (data.bio !== undefined) updateData.bio = data.bio || null\r\n    if (data.location !== undefined) updateData.location = data.location || null\r\n    if (data.website_url !== undefined) updateData.website_url = data.website_url || null\r\n    if (data.social_links !== undefined) updateData.social_links = data.social_links || {}\r\n    \r\n    const { error: updateError } = await supabase\r\n      .from(\"profiles\")\r\n      .update(updateData)\r\n      .eq(\"id\", user.id)\r\n    \r\n    if (updateError) {\r\n      console.error(\"updatePublicProfile error:\", updateError)\r\n      return { success: false, error: \"Failed to update profile\" }\r\n    }\r\n    \r\n    revalidateTag(\"profiles\", \"max\")\r\n    \r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"updatePublicProfile error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// UPLOAD BANNER IMAGE\r\n// =====================================================\r\nexport async function uploadBanner(formData: FormData): Promise<{\r\n  success: boolean\r\n  bannerUrl?: string\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n    \r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n    \r\n    const file = formData.get(\"banner\") as File | null\r\n    if (!file || file.size === 0) {\r\n      return { success: false, error: \"No file provided\" }\r\n    }\r\n    \r\n    // Validate file\r\n    const maxSize = 5 * 1024 * 1024 // 5MB\r\n    if (file.size > maxSize) {\r\n      return { success: false, error: \"File too large. Maximum size is 5MB\" }\r\n    }\r\n    \r\n    const allowedTypes = [\"image/jpeg\", \"image/png\", \"image/webp\"]\r\n    if (!allowedTypes.includes(file.type)) {\r\n      return { success: false, error: \"Invalid file type. Use JPEG, PNG, or WebP\" }\r\n    }\r\n    \r\n    // Generate filename\r\n    const ext = file.name.split(\".\").pop()?.toLowerCase() || \"jpg\"\r\n    const filename = `${user.id}/banner.${ext}`\r\n    \r\n    // Upload to Supabase Storage\r\n    const { error: uploadError } = await supabase.storage\r\n      .from(\"avatars\") // Reuse avatars bucket for banners\r\n      .upload(filename, file, { upsert: true })\r\n    \r\n    if (uploadError) {\r\n      console.error(\"uploadBanner storage error:\", uploadError)\r\n      return { success: false, error: \"Failed to upload banner\" }\r\n    }\r\n    \r\n    // Get public URL\r\n    const { data: { publicUrl } } = supabase.storage\r\n      .from(\"avatars\")\r\n      .getPublicUrl(filename)\r\n    \r\n    // Add cache-busting query param\r\n    const bannerUrl = `${publicUrl}?t=${Date.now()}`\r\n    \r\n    // Update profile\r\n    const { error: updateError } = await supabase\r\n      .from(\"profiles\")\r\n      .update({ \r\n        banner_url: bannerUrl,\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .eq(\"id\", user.id)\r\n    \r\n    if (updateError) {\r\n      console.error(\"uploadBanner profile error:\", updateError)\r\n      return { success: false, error: \"Failed to save banner URL\" }\r\n    }\r\n\r\n    revalidateTag(\"profiles\", \"max\")\r\n    \r\n    return { success: true, bannerUrl }\r\n  } catch (error) {\r\n    console.error(\"uploadBanner error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// UPGRADE TO BUSINESS ACCOUNT\r\n// =====================================================\r\nconst businessUpgradeSchema = z.object({\r\n  business_name: z.string().min(2, \"Business name must be at least 2 characters\").max(100),\r\n  vat_number: z.string().optional().nullable(),\r\n  business_address: z.object({\r\n    street: z.string().optional(),\r\n    city: z.string().optional(),\r\n    postal_code: z.string().optional(),\r\n    country: z.string().optional(),\r\n  }).optional().nullable(),\r\n  website_url: z.string().url(\"Invalid website URL\").optional().nullable().or(z.literal(\"\")),\r\n  change_username: z.boolean().optional(),\r\n  new_username: z.string().optional(),\r\n})\r\n\r\nexport async function upgradeToBusinessAccount(data: z.infer<typeof businessUpgradeSchema>): Promise<{\r\n  success: boolean\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n    \r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n    \r\n    // Validate\r\n    const validation = businessUpgradeSchema.safeParse(data)\r\n    if (!validation.success) {\r\n      return { success: false, error: validation.error.issues[0]?.message ?? \"Invalid business data\" }\r\n    }\r\n    \r\n    // If changing username with upgrade\r\n    if (data.change_username && data.new_username) {\r\n      const usernameResult = await setUsername(data.new_username)\r\n      if (!usernameResult.success) {\r\n        return { success: false, error: `Username: ${usernameResult.error ?? \"Failed to set username\"}` }\r\n      }\r\n    }\r\n    \r\n    const userId = user.id\r\n\r\n    // Update to business account (public + private surfaces)\r\n    const updatedAt = new Date().toISOString()\r\n    const adminSupabase = createAdminClient()\r\n    const [{ error: updateError }, { error: privateError }] = await Promise.all([\r\n      adminSupabase\r\n        .from(\"profiles\")\r\n        .update({\r\n          account_type: \"business\",\r\n          business_name: data.business_name,\r\n          website_url: data.website_url || null,\r\n          updated_at: updatedAt,\r\n        })\r\n        .eq(\"id\", userId),\r\n      supabase\r\n        .from(\"private_profiles\")\r\n        .upsert(\r\n          { id: userId, vat_number: data.vat_number || null, updated_at: updatedAt },\r\n          { onConflict: \"id\" }\r\n        ),\r\n    ])\r\n    \r\n    if (updateError || privateError) {\r\n      console.error(\"upgradeToBusinessAccount error:\", updateError || privateError)\r\n      return { success: false, error: \"Failed to upgrade account\" }\r\n    }\r\n\r\n    // Create business_verification record for future verification\r\n    await supabase\r\n      .from(\"business_verification\")\r\n      .upsert(\r\n        {\r\n          seller_id: userId,\r\n          legal_name: data.business_name,\r\n          vat_number: data.vat_number || null,\r\n          verification_level: 0,\r\n        },\r\n        { onConflict: \"seller_id\" }\r\n      )\r\n    \r\n    revalidateTag(\"profiles\", \"max\")\r\n    \r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"upgradeToBusinessAccount error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// DOWNGRADE TO PERSONAL ACCOUNT\r\n// =====================================================\r\nexport async function downgradeToPersonalAccount(): Promise<{\r\n  success: boolean\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n    \r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n    if (authError || !user) {\r\n      return { success: false, error: \"Not authenticated\" }\r\n    }\r\n\r\n    // Check for active business subscription\r\n    const { data: subscription } = await supabase\r\n      .from(\"subscriptions\")\r\n      .select(\"id, status, plan_type\")\r\n      .eq(\"seller_id\", user.id)\r\n      .eq(\"status\", \"active\")\r\n      .single()\r\n\r\n    if (subscription && subscription.plan_type !== \"free\") {\r\n      return { \r\n        success: false, \r\n        error: \"Please cancel your business subscription first before downgrading\" \r\n      }\r\n    }\r\n    \r\n    // Update to personal account (reset business-related fields).\r\n    // Uses service role for sensitive profile fields (account_type/tier/is_verified_business).\r\n    const adminSupabase = createAdminClient()\r\n\r\n    const userId = user.id\r\n\r\n    const { error: updateError } = await adminSupabase\r\n      .from(\"profiles\")\r\n      .update({\r\n        account_type: \"personal\",\r\n        is_verified_business: false,\r\n        tier: \"free\",\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"id\", userId)\r\n    \r\n    if (updateError) {\r\n      console.error(\"downgradeToPersonalAccount error:\", updateError)\r\n      return { success: false, error: \"Failed to downgrade account\" }\r\n    }\r\n    \r\n    revalidateTag(\"profiles\", \"max\")\r\n    \r\n    return { success: true }\r\n  } catch (error) {\r\n    console.error(\"downgradeToPersonalAccount error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// GET PUBLIC PROFILE BY USERNAME\r\n// =====================================================\r\nexport async function getPublicProfile(username: string): Promise<{\r\n  success: boolean\r\n  data?: {\r\n    id: string\r\n    username: string | null\r\n    display_name: string | null\r\n    avatar_url: string | null\r\n    banner_url: string | null\r\n    bio: string | null\r\n    account_type: string | null\r\n    is_seller: boolean | null\r\n    is_verified_business: boolean | null\r\n    verified: boolean | null\r\n    location: string | null\r\n    business_name: string | null\r\n    website_url: string | null\r\n    social_links: Record<string, string> | null\r\n    created_at: string\r\n  }\r\n  error?: string\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) {\r\n      return { success: false, error: \"Database connection failed\" }\r\n    }\r\n    \r\n    const { data: profile, error } = await supabase\r\n      .from(\"profiles\")\r\n      .select(`\r\n        id,\r\n        username,\r\n        display_name,\r\n        avatar_url,\r\n        banner_url,\r\n        bio,\r\n        account_type,\r\n        is_seller,\r\n        is_verified_business,\r\n        verified,\r\n        location,\r\n        business_name,\r\n        website_url,\r\n        social_links,\r\n        created_at\r\n      `)\r\n      .ilike(\"username\", username)\r\n      .single()\r\n    \r\n    if (error || !profile) {\r\n      return { success: false, error: \"Profile not found\" }\r\n    }\r\n    \r\n    // Hide business fields if personal account\r\n    const socialLinksData = profile.social_links && typeof profile.social_links === 'object' && !Array.isArray(profile.social_links)\r\n      ? profile.social_links as Record<string, string>\r\n      : null\r\n    \r\n    const publicData = {\r\n      id: profile.id,\r\n      username: profile.username,\r\n      display_name: profile.display_name,\r\n      avatar_url: profile.avatar_url,\r\n      banner_url: profile.banner_url,\r\n      bio: profile.bio,\r\n      account_type: profile.account_type,\r\n      is_seller: profile.is_seller,\r\n      is_verified_business: profile.is_verified_business,\r\n      verified: profile.verified,\r\n      location: profile.location,\r\n      business_name: profile.account_type === \"business\" ? profile.business_name : null,\r\n      website_url: profile.account_type === \"business\" ? profile.website_url : null,\r\n      social_links: profile.account_type === \"business\" ? socialLinksData : null,\r\n      created_at: profile.created_at,\r\n    }\r\n    \r\n    return { success: true, data: publicData }\r\n  } catch (error) {\r\n    console.error(\"getPublicProfile error:\", error)\r\n    return { success: false, error: \"An unexpected error occurred\" }\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// GET CURRENT USER PROFILE (Full)\r\n// =====================================================\r\nexport async function getCurrentUserProfile() {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) return null\r\n    \r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) return null\r\n    \r\n    const { data: profile } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\r\n        [\r\n          \"id\",\r\n          \"username\",\r\n          \"display_name\",\r\n          \"avatar_url\",\r\n          \"banner_url\",\r\n          \"bio\",\r\n          \"account_type\",\r\n          \"is_seller\",\r\n          \"is_verified_business\",\r\n          \"verified\",\r\n          \"location\",\r\n          \"business_name\",\r\n          \"website_url\",\r\n          \"social_links\",\r\n          \"created_at\",\r\n          \"last_username_change\",\r\n          \"tier\",\r\n        ].join(\",\")\r\n      )\r\n      .eq(\"id\", user.id)\r\n      .single()\r\n\r\n    if (!profile) return null\r\n\r\n    const { data: privateProfile } = await supabase\r\n      .from(\"private_profiles\")\r\n      .select(\"vat_number\")\r\n      .eq(\"id\", user.id)\r\n      .maybeSingle()\r\n\r\n    const baseProfile = profile as unknown as Record<string, unknown>\r\n\r\n    return {\r\n      ...baseProfile,\r\n      vat_number: privateProfile?.vat_number ?? null,\r\n    }\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// CHECK IF USERNAME IS SET\r\n// =====================================================\r\nexport async function hasUsername(): Promise<boolean> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) return false\r\n    \r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) return false\r\n    \r\n    const { data: profile } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"username\")\r\n      .eq(\"id\", user.id)\r\n      .single()\r\n    \r\n    return !!profile?.username\r\n  } catch {\r\n    return false\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// GET USERNAME CHANGE COOLDOWN\r\n// =====================================================\r\nexport async function getUsernameChangeCooldown(): Promise<{\r\n  canChange: boolean\r\n  daysRemaining?: number\r\n}> {\r\n  try {\r\n    const supabase = await createClient()\r\n    if (!supabase) return { canChange: false }\r\n    \r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    if (!user) return { canChange: false }\r\n    \r\n    const { data: profile } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"last_username_change\")\r\n      .eq(\"id\", user.id)\r\n      .single()\r\n    \r\n    if (!profile?.last_username_change) {\r\n      return { canChange: true }\r\n    }\r\n    \r\n    const lastChange = new Date(profile.last_username_change)\r\n    const cooldownEnd = new Date(lastChange.getTime() + 14 * 24 * 60 * 60 * 1000)\r\n    \r\n    if (new Date() >= cooldownEnd) {\r\n      return { canChange: true }\r\n    }\r\n    \r\n    const daysRemaining = Math.ceil((cooldownEnd.getTime() - Date.now()) / (24 * 60 * 60 * 1000))\r\n    return { canChange: false, daysRemaining }\r\n  } catch {\r\n    return { canChange: false }\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\admin\\docs\\seed\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\admin\\docs\\seed\\templates.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\assistant\\chat\\route.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 7 times.","line":58,"column":50,"nodeType":"Literal","endLine":58,"endColumn":69},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'usedFallback' is assigned a value but never used.","line":118,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":118,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\"\nimport { streamText, convertToModelMessages, type ModelMessage, type UIMessage } from \"ai\"\nimport { z } from \"zod\"\n\nimport { assistantTools } from \"@/lib/ai/tools/assistant-tools\"\nimport { getAiChatModel, getAiFallbackModel } from \"@/lib/ai/models\"\nimport { isAiAssistantEnabled, getGroqApiKey } from \"@/lib/ai/env\"\nimport { isNextPrerenderInterrupted } from \"@/lib/next/is-next-prerender-interrupted\"\nimport { logger } from \"@/lib/logger\"\nimport { createRouteHandlerClient } from \"@/lib/supabase/server\"\n\nconst AssistantChatRequestSchema = z.object({\n  messages: z.array(z.any()).max(50),\n  locale: z.enum([\"en\", \"bg\"]).optional(),\n})\n\nfunction getSystemPrompt(locale: \"en\" | \"bg\") {\n  const languageLine =\n    locale === \"bg\"\n      ? \"Reply in Bulgarian unless the user explicitly asks for English.\"\n      : \"Reply in English.\"\n\n  return [\n    \"You are Treido's in-app shopping assistant.\",\n    languageLine,\n    \"\",\n    \"Rules:\",\n    \"- You MUST ground product suggestions in tool results (searchListings/getListing).\",\n    \"- If you do not have enough information, ask a short clarifying question.\",\n    \"- Do not claim to browse the web or access external websites.\",\n    \"- Do not invent product details, prices, availability, or URLs.\",\n    \"- Prefer concise answers. When showing results, summarize and let the UI render listing cards.\",\n  ].join(\"\\n\")\n}\n\nfunction isRateLimitError(error: unknown): boolean {\n  if (error instanceof Error) {\n    const msg = error.message.toLowerCase()\n    return (\n      msg.includes(\"rate limit\") ||\n      msg.includes(\"quota\") ||\n      msg.includes(\"429\") ||\n      msg.includes(\"resource exhausted\")\n    )\n  }\n  return false\n}\n\nexport async function POST(request: NextRequest) {\n  const { supabase, applyCookies } = createRouteHandlerClient(request)\n  const json = (body: unknown, init?: Parameters<typeof NextResponse.json>[1]) =>\n    applyCookies(NextResponse.json(body, init))\n\n  const { data: { user } } = await supabase.auth.getUser()\n  if (!user) {\n    return json(\n      { error: { code: \"UNAUTHORIZED\" } },\n      { status: 401, headers: { \"Cache-Control\": \"private, no-store\" } },\n    )\n  }\n\n  if (!isAiAssistantEnabled()) {\n    return json(\n      { error: { code: \"AI_DISABLED\" } },\n      { status: 503, headers: { \"Cache-Control\": \"private, no-store\" } },\n    )\n  }\n\n  try {\n    const body = await request.json()\n    const parsed = AssistantChatRequestSchema.safeParse(body)\n    if (!parsed.success) {\n      return json(\n        { error: { code: \"BAD_REQUEST\" } },\n        { status: 400, headers: { \"Cache-Control\": \"private, no-store\" } },\n      )\n    }\n\n    const locale = parsed.data.locale ?? \"en\"\n    \n    // Check if messages are UIMessage format (from useChat) or simple {role, content} format\n    const rawMessages = parsed.data.messages\n    const isUIMessageFormat = rawMessages.some((m: { parts?: unknown }) => \n      m && typeof m === 'object' && 'parts' in m\n    )\n    \n    // Convert to model messages or use directly\n    const messages: ModelMessage[] = isUIMessageFormat\n      ? await convertToModelMessages(rawMessages as UIMessage[])\n      : rawMessages.map((m: { role: string; content: string }) => ({\n          role: m.role as \"user\" | \"assistant\" | \"system\",\n          content: m.content,\n        }))\n\n    const systemPrompt = getSystemPrompt(locale)\n\n    // Try primary model first, fallback to Groq on rate limit\n    let model = getAiChatModel()\n    let usedFallback = false\n\n    try {\n      const result = streamText({\n        model,\n        system: systemPrompt,\n        messages,\n        tools: assistantTools,\n      })\n\n      return result.toUIMessageStreamResponse({\n        headers: {\n          \"Cache-Control\": \"private, no-store\",\n        },\n      })\n    } catch (primaryError) {\n      // If rate limited and fallback is available, try fallback\n      if (isRateLimitError(primaryError) && getGroqApiKey()) {\n        logger.warn(\"[AI Assistant] Primary model rate limited, trying fallback\")\n        usedFallback = true\n        model = getAiFallbackModel()\n\n        const result = streamText({\n          model,\n          system: systemPrompt,\n          messages,\n          tools: assistantTools,\n        })\n\n        return result.toUIMessageStreamResponse({\n          headers: {\n            \"Cache-Control\": \"private, no-store\",\n            \"X-AI-Fallback\": \"true\",\n          },\n        })\n      }\n\n      throw primaryError\n    }\n  } catch (error) {\n    if (isNextPrerenderInterrupted(error)) throw error\n    logger.error(\"[AI Assistant] chat route error\", error)\n    return json(\n      { error: { code: \"INTERNAL\" } },\n      { status: 500, headers: { \"Cache-Control\": \"private, no-store\" } },\n    )\n  }\n}\n\nexport async function GET() {\n  return NextResponse.json(\n    { error: { code: \"METHOD_NOT_ALLOWED\" } },\n    {\n      status: 405,\n      headers: {\n        Allow: \"POST\",\n        \"Cache-Control\": \"private, no-store\",\n      },\n    },\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\assistant\\find-similar\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\assistant\\sell-autofill\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\auth\\sign-out\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\badges\\[userId]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\badges\\evaluate\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":75,"column":17,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":75,"endColumn":23},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":138,"column":22,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":138,"endColumn":28},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":159,"column":24,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":159,"endColumn":30},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string`.","line":169,"column":22,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":169,"endColumn":28},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 34 to the 25 allowed.","line":233,"column":10,"nodeType":null,"messageId":"refactorFunction","endLine":233,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\"\r\nimport { createRouteHandlerClient } from \"@/lib/supabase/server\"\r\n\r\n// Types for badge evaluation\r\ninterface BadgeCriteria {\r\n  account_type?: string\r\n  min_sales?: number\r\n  min_listings?: number\r\n  min_rating?: number\r\n  min_reviews?: number\r\n  min_positive_feedback_pct?: number\r\n  email_verified?: boolean\r\n  phone_verified?: boolean\r\n  id_verified?: boolean\r\n  min_months?: number\r\n  min_followers?: number\r\n  min_response_rate?: number\r\n  min_repeat_customers_pct?: number\r\n}\r\n\r\ninterface UserStats {\r\n  total_sales?: number\r\n  total_purchases?: number\r\n  total_listings?: number\r\n  average_rating?: number\r\n  total_reviews?: number\r\n  reviews_given?: number\r\n  positive_feedback_pct?: number\r\n  follower_count?: number\r\n  response_rate_pct?: number\r\n  repeat_customer_pct?: number\r\n  created_at?: string\r\n}\r\n\r\ninterface UserVerification {\r\n  email_verified?: boolean | null\r\n  phone_verified?: boolean | null\r\n  id_verified?: boolean | null\r\n  address_verified?: boolean | null\r\n  created_at?: string | null\r\n}\r\n\r\n/**\r\n * POST /api/badges/evaluate\r\n * Evaluates and awards badges to a user based on their current stats\r\n * \r\n * Body: { user_id: string, context?: \"sale\" | \"review\" | \"listing\" | \"signup\" | \"subscription\" }\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  const { supabase, applyCookies } = createRouteHandlerClient(request)\r\n  const json = (body: unknown, init?: Parameters<typeof NextResponse.json>[1]) =>\r\n    applyCookies(NextResponse.json(body, init))\r\n\r\n  try {\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    \r\n    if (!user) {\r\n      return json({ error: \"Unauthorized\" }, { status: 401 })\r\n    }\r\n    \r\n    const body = await request.json()\r\n    const userId = body.user_id || user.id\r\n    const context = body.context || \"general\"\r\n    \r\n    // Security: Only allow users to evaluate their own badges unless admin\r\n    // For now, only self-evaluation is allowed\r\n    if (userId !== user.id) {\r\n      return json({ error: \"Forbidden\" }, { status: 403 })\r\n    }\r\n    \r\n    // Get the user's profile (seller fields are now on profiles)\r\n    const { data: profile } = await supabase\r\n      .from(\"profiles\")\r\n      .select(\"id, account_type\")\r\n      .eq(\"id\", userId)\r\n      .single()\r\n    \r\n    // Get applicable badge definitions based on context\r\n    const BADGE_DEFINITIONS_SELECT =\r\n      \"id,account_type,category,code,color,created_at,criteria,description,description_bg,icon,is_active,is_automatic,name,name_bg,tier\" as const\r\n\r\n    const SELLER_STATS_SELECT =\r\n      \"seller_id,total_sales,total_listings,average_rating,total_reviews,positive_feedback_pct,follower_count,response_rate_pct,repeat_customer_pct,active_listings,total_revenue,five_star_reviews,response_time_hours,communication_pct,item_described_pct,shipped_on_time_pct,shipping_speed_pct,first_sale_at,last_sale_at,updated_at\" as const\r\n\r\n    const BUYER_STATS_SELECT =\r\n      \"user_id,average_rating,conversations_started,disputes_opened,disputes_won,first_purchase_at,last_purchase_at,reviews_written,stores_following,total_orders,total_ratings,total_spent,updated_at,wishlist_count\" as const\r\n\r\n    const USER_VERIFICATION_SELECT =\r\n      \"id,user_id,email_verified,phone_verified,id_verified,address_verified,address_verified_at,id_verified_at,id_document_type,phone_number,trust_score,created_at,updated_at\" as const\r\n\r\n    let badgeQuery = supabase\r\n      .from(\"badge_definitions\")\r\n      .select(BADGE_DEFINITIONS_SELECT)\r\n      .eq(\"is_active\", true)\r\n    \r\n    if (profile) {\r\n      // Seller badges\r\n      if (profile.account_type === \"business\") {\r\n        badgeQuery = badgeQuery.in(\"category\", [\r\n          \"seller_milestone_personal\", \r\n          \"seller_milestone_business\",\r\n          \"seller_sales\",\r\n          \"seller_rating\",\r\n          \"seller_special\",\r\n          \"verification\"\r\n        ])\r\n      } else {\r\n        badgeQuery = badgeQuery.in(\"category\", [\r\n          \"seller_milestone_personal\",\r\n          \"seller_sales\",\r\n          \"seller_rating\",\r\n          \"seller_special\",\r\n          \"verification\"\r\n        ])\r\n      }\r\n    } else {\r\n      // Buyer badges only\r\n      badgeQuery = badgeQuery.in(\"category\", [\r\n        \"buyer_milestone\",\r\n        \"buyer_rating\",\r\n        \"buyer_engagement\",\r\n        \"verification\",\r\n        \"subscription\"\r\n      ])\r\n    }\r\n    \r\n    const { data: badges, error: badgesError } = await badgeQuery\r\n    \r\n    if (badgesError) {\r\n      console.error(\"Failed to fetch badge definitions:\", badgesError)\r\n      return json({ error: \"Failed to fetch badges\" }, { status: 500 })\r\n    }\r\n    \r\n    // Get user's current badges\r\n    const { data: existingBadges } = await supabase\r\n      .from(\"user_badges\")\r\n      .select(\"badge_id\")\r\n      .eq(\"user_id\", userId)\r\n    \r\n    const existingBadgeIds = new Set((existingBadges || []).map(b => b.badge_id))\r\n    \r\n    // Get stats based on user type\r\n    let stats: UserStats | null = null\r\n    \r\n    if (profile) {\r\n      // Get seller stats\r\n      const { data: sellerStats } = await supabase\r\n        .from(\"seller_stats\")\r\n        .select(SELLER_STATS_SELECT)\r\n        .eq(\"seller_id\", profile.id)\r\n        .single()\r\n      \r\n      stats = sellerStats as UserStats | null\r\n    } else {\r\n      // Get buyer stats\r\n      const { data: buyerStats } = await supabase\r\n        .from(\"buyer_stats\")\r\n        .select(BUYER_STATS_SELECT)\r\n        .eq(\"user_id\", userId)\r\n        .single()\r\n      \r\n      stats = buyerStats as UserStats | null\r\n    }\r\n    \r\n    // Get verification status\r\n    const { data: verification } = await supabase\r\n      .from(\"user_verification\")\r\n      .select(USER_VERIFICATION_SELECT)\r\n      .eq(\"user_id\", userId)\r\n      .single()\r\n    \r\n    // Evaluate each badge\r\n    const awardedBadges: string[] = []\r\n    const newBadges: { badge_id: string; badge_code: string }[] = []\r\n    \r\n    for (const badge of badges || []) {\r\n      // Skip if already has this badge\r\n      if (existingBadgeIds.has(badge.id)) continue\r\n      \r\n      // Evaluate criteria\r\n      const criteria = badge.criteria as BadgeCriteria\r\n      let earned = false\r\n      \r\n      if (stats) {\r\n        earned = evaluateCriteria(criteria, stats, verification, profile?.account_type ?? undefined)\r\n      } else if (verification) {\r\n        // Verification-only badges for new users\r\n        earned = evaluateCriteria(criteria, {}, verification, \"personal\")\r\n      }\r\n      \r\n      if (earned) {\r\n        newBadges.push({ badge_id: badge.id, badge_code: badge.code })\r\n      }\r\n    }\r\n    \r\n    // Award new badges\r\n    if (newBadges.length > 0) {\r\n      const badgesToInsert = newBadges.map(b => ({\r\n        user_id: userId,\r\n        badge_id: b.badge_id,\r\n        earned_at: new Date().toISOString(),\r\n        awarded_by: \"system\",\r\n        reason: `Auto-awarded from ${context} event`,\r\n      }))\r\n      \r\n      const { error: insertError } = await supabase\r\n        .from(\"user_badges\")\r\n        .insert(badgesToInsert)\r\n      \r\n      if (insertError) {\r\n        console.error(\"Failed to insert badges:\", insertError)\r\n        return json({ error: \"Failed to award badges\" }, { status: 500 })\r\n      }\r\n      \r\n      awardedBadges.push(...newBadges.map(b => b.badge_code))\r\n    }\r\n    \r\n    return json({\r\n      success: true,\r\n      awarded: awardedBadges,\r\n      total_awarded: awardedBadges.length,\r\n    })\r\n    \r\n  } catch (error) {\r\n    console.error(\"Badge evaluation error:\", error)\r\n    return json({ error: \"Internal server error\" }, { status: 500 })\r\n  }\r\n}\r\n\r\n/**\r\n * Evaluate badge criteria against user stats\r\n */\r\nfunction evaluateCriteria(\r\n  criteria: BadgeCriteria | null | undefined,\r\n  stats: UserStats | null,\r\n  verification: UserVerification | null,\r\n  accountType?: string\r\n): boolean {\r\n  if (!criteria) return false\r\n  \r\n  // Account type check\r\n  if (criteria.account_type && criteria.account_type !== accountType) {\r\n    return false\r\n  }\r\n  \r\n  // Minimum sales\r\n  if (criteria.min_sales !== undefined) {\r\n    const totalSales = stats?.total_sales || stats?.total_purchases || 0\r\n    if (totalSales < criteria.min_sales) return false\r\n  }\r\n  \r\n  // Minimum listings\r\n  if (criteria.min_listings !== undefined && (stats?.total_listings || 0) < criteria.min_listings) return false\r\n  \r\n  // Minimum rating\r\n  if (criteria.min_rating !== undefined && (stats?.average_rating || 0) < criteria.min_rating) return false\r\n  \r\n  // Minimum reviews\r\n  if (criteria.min_reviews !== undefined) {\r\n    const reviews = stats?.total_reviews || stats?.reviews_given || 0\r\n    if (reviews < criteria.min_reviews) return false\r\n  }\r\n  \r\n  // Minimum positive feedback percentage\r\n  if (criteria.min_positive_feedback_pct !== undefined && (stats?.positive_feedback_pct || 0) < criteria.min_positive_feedback_pct) return false\r\n  \r\n  // Email verification\r\n  if (criteria.email_verified && !verification?.email_verified) return false\r\n  \r\n  // Phone verification\r\n  if (criteria.phone_verified && !verification?.phone_verified) return false\r\n  \r\n  // ID verification\r\n  if (criteria.id_verified && !verification?.id_verified) return false\r\n  \r\n  // Minimum months as member\r\n  if (criteria.min_months !== undefined) {\r\n    const createdAt = stats?.created_at || verification?.created_at\r\n    if (createdAt) {\r\n      const monthsSince = Math.floor(\r\n        (Date.now() - new Date(createdAt).getTime()) / (30 * 24 * 60 * 60 * 1000)\r\n      )\r\n      if (monthsSince < criteria.min_months) return false\r\n    } else {\r\n      return false\r\n    }\r\n  }\r\n  \r\n  // Minimum follower count\r\n  if (criteria.min_followers !== undefined && (stats?.follower_count || 0) < criteria.min_followers) return false\r\n  \r\n  // Minimum response rate\r\n  if (criteria.min_response_rate !== undefined && (stats?.response_rate_pct || 0) < criteria.min_response_rate) return false\r\n  \r\n  // Minimum repeat customers percentage\r\n  if (criteria.min_repeat_customers_pct !== undefined && (stats?.repeat_customer_pct || 0) < criteria.min_repeat_customers_pct) return false\r\n  \r\n  // All criteria passed\r\n  return true\r\n}","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\badges\\feature\\[badgeId]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\badges\\route.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 7 times.","line":12,"column":38,"nodeType":"Literal","endLine":12,"endColumn":57}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\"\r\nimport { createRouteHandlerClient } from \"@/lib/supabase/server\"\r\nimport { isNextPrerenderInterrupted } from \"@/lib/next/is-next-prerender-interrupted\"\r\n\r\n/**\r\n * GET /api/badges\r\n * Returns the current user's badges with definitions\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  if (process.env.NEXT_PHASE === 'phase-production-build') {\r\n    const res = NextResponse.json({ skipped: true }, { status: 200 })\r\n    res.headers.set('Cache-Control', 'private, no-store')\r\n    res.headers.set('CDN-Cache-Control', 'private, no-store')\r\n    res.headers.set('Vercel-CDN-Cache-Control', 'private, no-store')\r\n    return res\r\n  }\r\n  try {\r\n    const { supabase, applyCookies } = createRouteHandlerClient(request)\r\n    const json = (body: unknown, init?: Parameters<typeof NextResponse.json>[1]) => {\r\n      const res = NextResponse.json(body, init)\r\n      res.headers.set('Cache-Control', 'private, no-store')\r\n      res.headers.set('CDN-Cache-Control', 'private, no-store')\r\n      res.headers.set('Vercel-CDN-Cache-Control', 'private, no-store')\r\n      return applyCookies(res)\r\n    }\r\n\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    \r\n    if (!user) {\r\n      return json({ badges: [], total: 0 })\r\n    }\r\n    \r\n    // Get user's badges with definitions\r\n    const { data: badges, error } = await supabase\r\n      .from(\"user_badges\")\r\n      .select(`\r\n        id,\r\n        awarded_at,\r\n        badge_definitions (\r\n          id,\r\n          code,\r\n          name,\r\n          description,\r\n          icon,\r\n          color,\r\n          category,\r\n          tier,\r\n          criteria\r\n        )\r\n      `)\r\n      .eq(\"user_id\", user.id)\r\n      .is(\"revoked_at\", null)\r\n      .order(\"awarded_at\", { ascending: false })\r\n    \r\n    if (error) {\r\n      console.error(\"Failed to fetch badges:\", error)\r\n      return json({ error: \"Failed to fetch badges\" }, { status: 500 })\r\n    }\r\n    \r\n    // Transform the data\r\n    const transformedBadges = (badges || []).map(b => ({\r\n      ...b.badge_definitions,\r\n      user_badge_id: b.id,\r\n      awarded_at: b.awarded_at,\r\n    }))\r\n    \r\n    return json({\r\n      badges: transformedBadges,\r\n      total: transformedBadges.length,\r\n    })\r\n    \r\n  } catch (error) {\r\n    if (isNextPrerenderInterrupted(error)) {\r\n      const res = NextResponse.json({ skipped: true }, { status: 200 })\r\n      res.headers.set('Cache-Control', 'private, no-store')\r\n      return res\r\n    }\r\n    console.error(\"Error fetching badges:\", error)\r\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 })\r\n  }\r\n}","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\billing\\invoices\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\boost\\checkout\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\categories\\[slug]\\attributes\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\categories\\[slug]\\children\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\categories\\[slug]\\context\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\categories\\attributes\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\categories\\counts\\route.ts","messages":[{"ruleId":"sonarjs/no-collapsible-if","severity":1,"message":"Merge this if statement with the nested one.","line":73,"column":5,"nodeType":null,"messageId":"mergeNestedIfStatement","endLine":73,"endColumn":7},{"ruleId":"unicorn/no-lonely-if","severity":1,"message":"Unexpected `if` as the only statement in a `if` block without `else`.","line":74,"column":7,"nodeType":"IfStatement","messageId":"no-lonely-if","endLine":76,"endColumn":8,"fix":{"range":[2118,2292],"text":"(statsError && process.env.NODE_ENV === \"development\") {\n        console.debug(\"Category counts: Error fetching category_stats:\", statsError?.message)\n      }"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { getCategoryHierarchy, type CategoryWithChildren } from \"@/lib/data/categories\"\nimport { createStaticClient } from \"@/lib/supabase/server\"\nimport { NextResponse } from \"next/server\"\nimport { cacheLife, cacheTag } from \"next/cache\"\nimport { isNextPrerenderInterrupted } from \"@/lib/next/is-next-prerender-interrupted\"\n\n// This endpoint returns product counts for ALL categories (L0, L1, L2).\n// Used for sidebar category navigation to show listing counts\n\n// Cache for 1 hour, stale for 5 min (counts don't need to be real-time)\nconst CACHE_TTL_SECONDS = 3600\nconst CACHE_STALE_WHILE_REVALIDATE = 300\n\r\ninterface CategoryCount {\n  slug: string\n  count: number\n}\n\ninterface FlatCategoryRef {\n  id: string\n  slug: string\n}\n\nfunction flattenCategories(nodes: CategoryWithChildren[]): FlatCategoryRef[] {\n  const out: FlatCategoryRef[] = []\n  const stack = [...nodes]\n\n  while (stack.length > 0) {\n    const current = stack.pop()\n    if (!current) continue\n\n    out.push({ id: current.id, slug: current.slug })\n\n    if (current.children && current.children.length > 0) {\n      for (const child of current.children) {\n        stack.push(child)\n      }\n    }\n  }\n\n  return out\n}\n\n/**\n * Get product counts for all categories.\n * Reads category scope from canonical hierarchy (L0ΓåÆL2) and merges stats by category_id.\n * Always returns all active scoped categories; missing stats fallback to 0.\n */\nasync function getCategoryCountsCached(): Promise<CategoryCount[]> {\n  'use cache'\n  cacheTag('categories:counts')\n  cacheLife('categories')\n\n  try {\n    const scopedHierarchy = await getCategoryHierarchy(null, 2)\n    if (!scopedHierarchy || scopedHierarchy.length === 0) {\n      return []\n    }\n\n    const scopedCategories = flattenCategories(scopedHierarchy)\n    if (scopedCategories.length === 0) {\n      return []\n    }\n\n    const supabase = createStaticClient()\n    const categoryIds = scopedCategories.map((cat) => cat.id)\n\n    const { data: stats, error: statsError } = await supabase\n      .from('category_stats')\n      .select('category_id, subtree_product_count')\n      .in('category_id', categoryIds)\n\n    if (statsError) {\n      if (process.env.NODE_ENV === \"development\") {\n        console.debug(\"Category counts: Error fetching category_stats:\", statsError?.message)\n      }\n    }\n\n    const countByCategoryId = new Map<string, number>()\n    for (const row of stats ?? []) {\n      if (!row.category_id) continue\n      countByCategoryId.set(row.category_id, row.subtree_product_count ?? 0)\n    }\n\n    return scopedCategories.map((cat) => ({\n      slug: cat.slug,\n      count: countByCategoryId.get(cat.id) ?? 0,\n    }))\n  } catch (error) {\n    // Allow prerender interruptions to propagate\n    if (isNextPrerenderInterrupted(error)) throw error\n    \n    // Log only in development\r\n    if (process.env.NODE_ENV === \"development\") {\r\n      const message = error instanceof Error ? error.message : \"Unknown error\"\r\n      console.debug(\"Category counts: Cache function error:\", message)\r\n    }\r\n    return []\r\n  }\r\n}\r\n\r\nexport async function GET() {\r\n  try {\r\n    const counts = await getCategoryCountsCached()\r\n    \r\n    // Convert to map for easier client-side lookup\r\n    const countsMap = Object.fromEntries(\r\n      counts.map(c => [c.slug, c.count])\r\n    )\r\n\r\n    return NextResponse.json(\r\n      { counts: countsMap },\r\n      {\r\n        headers: {\r\n          'Cache-Control': `public, s-maxage=${CACHE_TTL_SECONDS}, stale-while-revalidate=${CACHE_STALE_WHILE_REVALIDATE}`,\r\n          'CDN-Cache-Control': `public, max-age=${CACHE_TTL_SECONDS}`,\r\n          'Vercel-CDN-Cache-Control': `public, max-age=${CACHE_TTL_SECONDS}`,\r\n        }\r\n      }\r\n    )\r\n  } catch (error) {\r\n    if (isNextPrerenderInterrupted(error)) throw error\r\n    \r\n    // Log only in development to avoid production noise\r\n    if (process.env.NODE_ENV === \"development\") {\r\n      const message = error instanceof Error ? error.message : \"Unknown error\"\r\n      console.debug(\"Category Counts API Error:\", message)\r\n    }\r\n    \r\n    // Return empty counts with success status (graceful degradation)\r\n    // This prevents client-side fetch errors while still indicating no data\r\n    return NextResponse.json(\r\n      { counts: {} },\r\n      {\r\n        headers: {\r\n          // Shorter cache for error responses - allow quick retry\r\n          'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=30',\r\n        }\r\n      }\r\n    )\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\categories\\products\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\categories\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'depth' is defined but never used.","line":269,"column":63,"nodeType":"Identifier","messageId":"unusedVar","endLine":269,"endColumn":68},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'idx' is defined but never used.","line":303,"column":44,"nodeType":"Identifier","messageId":"unusedVar","endLine":303,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createStaticClient } from \"@/lib/supabase/server\"\r\nimport { NextResponse } from \"next/server\"\r\nimport { normalizeOptionalImageUrl } from \"@/lib/normalize-image-url\"\nimport { cacheLife, cacheTag } from \"next/cache\"\nimport { isNextPrerenderInterrupted } from \"@/lib/next/is-next-prerender-interrupted\"\nimport { cachedJsonResponse } from \"@/lib/api/response-helpers\"\nimport { CATEGORY_TREE_NODE_SELECT } from \"@/lib/supabase/selects/categories\"\n\r\n// NOTE: This endpoint serves public data (no user cookies required).\r\n// In Cache Components mode, avoid Dynamic APIs like `connection()` and avoid\r\n// cookie-backed clients in route handlers to keep responses stable.\r\n\r\nconst MAX_CHILDREN_DEPTH = 2\nconst MAX_HIERARCHY_DEPTH = 5\n\r\nfunction clampDepth(input: string | null, max: number) {\r\n  const parsed = Number.parseInt(input || \"\", 10)\r\n  if (!Number.isFinite(parsed)) return 1\r\n  return Math.min(Math.max(parsed, 1), max)\r\n}\r\n\r\n// Type for the RPC return\r\ninterface CategoryHierarchyRow {\r\n  id: string\r\n  name: string\r\n  name_bg: string | null\r\n  slug: string\r\n  parent_id: string | null\r\n  depth: number\r\n  path: string[]\r\n  image_url: string | null\r\n  icon: string | null\r\n  display_order: number | null\r\n}\r\n\r\n// Type for the nested category structure\r\ninterface CategoryWithChildren {\r\n  id: string\r\n  name: string\r\n  name_bg: string | null\r\n  slug: string\r\n  icon: string | null\r\n  image_url: string | null\r\n  display_order: number | null\r\n  children?: CategoryWithChildren[]\r\n}\r\n\r\n// Transform flat RPC results into nested tree structure\r\nfunction buildCategoryTree(rows: CategoryHierarchyRow[]): CategoryWithChildren[] {\r\n  const categoryMap = new Map<string, CategoryWithChildren>()\r\n  const rootCategories: CategoryWithChildren[] = []\r\n  \r\n  // Filter out deprecated categories (display_order >= 9000)\r\n  const activeRows = rows.filter(row => (row.display_order ?? 0) < 9000)\r\n\r\n  // First pass: create all category objects\r\n  for (const row of activeRows) {\r\n    categoryMap.set(row.id, {\r\n      id: row.id,\r\n      name: row.name,\r\n      name_bg: row.name_bg,\r\n      slug: row.slug,\r\n      icon: row.icon,\r\n      image_url: normalizeOptionalImageUrl(row.image_url),\r\n      display_order: row.display_order,\r\n      children: []\r\n    })\r\n  }\r\n\r\n  // Second pass: build tree structure\n  for (const row of activeRows) {\n    const category = categoryMap.get(row.id)\n    if (!category) continue\n\n    if (row.parent_id && categoryMap.has(row.parent_id)) {\n      // Add to parent's children\n      const parent = categoryMap.get(row.parent_id)\n      if (!parent) continue\n      parent.children = parent.children || []\n      parent.children.push(category)\n    } else if (row.depth === 0) {\n      // Root category\n      rootCategories.push(category)\n    }\n  }\n\r\n  // Sort children by display_order, then by name\r\n  function sortChildren(cats: CategoryWithChildren[]): CategoryWithChildren[] {\r\n    cats.sort((a, b) => {\r\n      const orderA = a.display_order ?? 999\r\n      const orderB = b.display_order ?? 999\r\n      if (orderA !== orderB) return orderA - orderB\r\n      return a.name.localeCompare(b.name)\r\n    })\r\n    for (const cat of cats) {\r\n      if (cat.children && cat.children.length > 0) {\r\n        sortChildren(cat.children)\r\n      }\r\n    }\r\n    return cats\r\n  }\r\n\r\n  return sortChildren(rootCategories)\r\n}\r\n\r\nasync function getRootCategoriesCached() {\n  'use cache'\r\n  cacheTag('categories:tree')\r\n  cacheLife('categories')\r\n\r\n  const supabase = createStaticClient()\r\n  if (!supabase) return []\r\n\r\n  const { data, error } = await supabase\n    .from(\"categories\")\n    .select(CATEGORY_TREE_NODE_SELECT)\n    .is(\"parent_id\", null)\n    .lt(\"display_order\", 9000)\r\n    .order(\"display_order\", { ascending: true })\r\n    .order(\"name\", { ascending: true })\r\n\r\n  if (error) throw error\r\n\r\n  return (data || []).map((cat) => ({\r\n    ...cat,\r\n    image_url: normalizeOptionalImageUrl(cat.image_url),\r\n  }))\r\n}\r\n\r\nasync function getRootWithChildrenCached(depth: number) {\r\n  'use cache'\r\n  cacheTag('categories:tree')\r\n  cacheTag(`categories:root-with-children:depth:${depth}`)\r\n  cacheLife('categories')\r\n\r\n  const supabase = createStaticClient()\r\n  if (!supabase) {\r\n    return {\r\n      categories: [],\r\n      _debug: { totalCount: 0, rootCount: 0, rootCategories: [] },\r\n    }\r\n  }\r\n\r\n  const { data: rootCats, error: rootError } = await supabase\n    .from(\"categories\")\n    .select(CATEGORY_TREE_NODE_SELECT)\n    .is(\"parent_id\", null)\n    .lt(\"display_order\", 9000)\r\n    .order(\"display_order\", { ascending: true })\r\n\r\n  if (rootError) throw rootError\r\n\r\n  const rootIds = (rootCats || []).map((c) => c.id)\r\n  const { data: l1Cats, error: l1Error } = await supabase\n    .from(\"categories\")\n    .select(CATEGORY_TREE_NODE_SELECT)\n    .in(\"parent_id\", rootIds)\n    .lt(\"display_order\", 9000)\r\n    .order(\"display_order\", { ascending: true })\r\n\r\n  if (l1Error) throw l1Error\r\n\r\n  let l2Cats: typeof l1Cats = []\r\n  if (depth >= 2 && l1Cats && l1Cats.length > 0) {\r\n    const l1Ids = l1Cats.map((c) => c.id)\r\n    const BATCH_SIZE = 50\r\n    const CONCURRENCY = 4\r\n\r\n    const batches: Array<{ index: number; ids: string[] }> = []\r\n    for (let i = 0; i < l1Ids.length; i += BATCH_SIZE) {\r\n      batches.push({ index: i / BATCH_SIZE, ids: l1Ids.slice(i, i + BATCH_SIZE) })\r\n    }\r\n\r\n    const results: typeof l1Cats = []\r\n    for (let start = 0; start < batches.length; start += CONCURRENCY) {\r\n      const chunk = batches.slice(start, start + CONCURRENCY)\r\n      const chunkResults = await Promise.all(\r\n        chunk.map(async ({ index, ids }) => {\r\n          try {\r\n            const { data: l2Data, error: l2Error } = await supabase\n              .from(\"categories\")\n              .select(CATEGORY_TREE_NODE_SELECT)\n              .in(\"parent_id\", ids)\n              .lt(\"display_order\", 9000)\r\n              .order(\"display_order\", { ascending: true })\r\n\r\n            if (l2Error) {\r\n              console.error(`L2 Categories Query Error (batch ${index}):`, l2Error)\r\n              return []\r\n            }\r\n            return l2Data || []\r\n          } catch (err) {\r\n            const error = err instanceof Error ? err : new Error(String(err))\r\n            console.error(`L2 Categories Batch Error (batch ${index}):`, {\r\n              message: error.message,\r\n              details: error.toString(),\r\n            })\r\n            return []\r\n          }\r\n        })\r\n      )\r\n\r\n      for (const part of chunkResults) results.push(...part)\r\n    }\r\n\r\n    l2Cats = results\r\n  }\r\n\r\n  const cats = [...(rootCats || []), ...(l1Cats || []), ...l2Cats]\r\n\r\n  const categoryMap = new Map<string, CategoryWithChildren>()\r\n  const rootCategories: CategoryWithChildren[] = []\r\n\r\n  for (const cat of cats) {\r\n    categoryMap.set(cat.id, {\r\n      id: cat.id,\r\n      name: cat.name,\r\n      name_bg: cat.name_bg,\r\n      slug: cat.slug,\r\n      icon: cat.icon,\r\n      image_url: normalizeOptionalImageUrl(cat.image_url),\r\n      display_order: cat.display_order,\r\n      children: [],\r\n    })\r\n  }\r\n\r\n  for (const cat of cats) {\n    const category = categoryMap.get(cat.id)\n    if (!category) continue\n    if (cat.parent_id && categoryMap.has(cat.parent_id)) {\n      const parent = categoryMap.get(cat.parent_id)\n      if (!parent) continue\n      parent.children = parent.children || []\n      parent.children.push(category)\n    } else if (!cat.parent_id) {\n      rootCategories.push(category)\n    }\n  }\n\r\n  function sortChildren(categories: CategoryWithChildren[]) {\r\n    categories.sort((a, b) => {\r\n      const orderA = a.display_order ?? 999\r\n      const orderB = b.display_order ?? 999\r\n      if (orderA !== orderB) return orderA - orderB\r\n      return a.name.localeCompare(b.name)\r\n    })\r\n    for (const cat of categories) {\r\n      if (cat.children && cat.children.length > 0) {\r\n        sortChildren(cat.children)\r\n      }\r\n    }\r\n  }\r\n  sortChildren(rootCategories)\r\n\r\n  return {\r\n    categories: rootCategories,\r\n    _debug: {\r\n      totalCount: cats.length,\r\n      rootCount: rootCategories.length,\r\n      rootCategories: rootCategories.map((c) => ({\r\n        name: c.name,\r\n        slug: c.slug,\r\n        display_order: c.display_order,\r\n      })),\r\n    },\r\n  }\r\n}\r\n\r\nasync function getCategoryHierarchyCached(parentSlug: string, depth: number) {\r\n  'use cache'\r\n  cacheTag('categories:tree')\r\n  cacheTag(`category:${parentSlug}`)\r\n  cacheTag(`categories:hierarchy:${parentSlug}`)\r\n  cacheLife('categories')\r\n\r\n  const supabase = createStaticClient()\r\n  if (!supabase) return { categories: [], parent: null }\r\n\r\n  // Use recursive CTE via raw SQL instead of RPC (more efficient, no wrapper overhead)\r\n  // First get the parent category\r\n  const { data: parentCat, error: parentError } = await supabase\r\n    .from('categories')\r\n    .select('id, name, name_bg, slug, parent_id, image_url, icon, display_order')\r\n    .eq('slug', parentSlug)\r\n    .single()\r\n\r\n  if (parentError || !parentCat) {\r\n    return { categories: [], parent: null }\r\n  }\r\n\r\n  cacheTag(`category-children:${parentCat.id}`)\r\n\r\n  // Then get all descendants up to depth\r\n  const { data: descendants, error: descendantsError } = await supabase\r\n    .from('categories')\r\n    .select('id, name, name_bg, slug, parent_id, image_url, icon, display_order')\r\n    .eq('parent_id', parentCat.id)\r\n    .order('display_order')\r\n    .order('name')\r\n\r\n  if (descendantsError) throw descendantsError\r\n\r\n  const rows = (descendants || []).map((c, idx) => ({\r\n    ...c,\r\n    depth: 1,\r\n    path: [parentSlug, c.slug],\r\n  })) as CategoryHierarchyRow[]\r\n\r\n  // Build tree from flat list  \r\n  const tree = buildCategoryTree([\r\n    { ...parentCat, depth: 0, path: [parentSlug] } as CategoryHierarchyRow,\r\n    ...rows,\r\n  ])\r\n\r\n  const root = tree[0]\r\n  if (!root) return { categories: [], parent: null }\r\n\r\n  return {\r\n    categories: root.children ?? [],\r\n    parent: {\r\n      id: root.id,\r\n      name: root.name,\r\n      name_bg: root.name_bg,\r\n      slug: root.slug,\r\n    },\r\n  }\r\n}\r\n\r\nexport async function GET(request: Request) {\r\n  try {\r\n    const { searchParams } = new URL(request.url)\r\n    const parentSlug = searchParams.get(\"parent\")\r\n    const includeChildren = searchParams.get(\"children\") === \"true\"\r\n    const childrenDepth = clampDepth(searchParams.get(\"depth\"), MAX_CHILDREN_DEPTH)\r\n    const hierarchyDepth = clampDepth(searchParams.get(\"depth\"), MAX_HIERARCHY_DEPTH)\r\n\r\n    if (parentSlug) {\r\n      const data = await getCategoryHierarchyCached(parentSlug, hierarchyDepth)\r\n      return cachedJsonResponse(data, \"catalog\")\n    }\r\n\r\n    if (includeChildren) {\r\n      const data = await getRootWithChildrenCached(childrenDepth)\r\n      return cachedJsonResponse(data, \"catalog\")\n    }\r\n\r\n    const categories = await getRootCategoriesCached()\r\n    return cachedJsonResponse({ categories }, \"catalog\")\n  } catch (error) {\r\n    if (isNextPrerenderInterrupted(error)) throw error\r\n    console.error(\"Categories API Error:\", error)\r\n    const message = error instanceof Error ? error.message : \"Internal Server Error\"\r\n    return NextResponse.json({ error: message }, { status: 500 })\r\n  }\r\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\categories\\sell-tree\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\checkout\\webhook\\route.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 10 times.","line":47,"column":14,"nodeType":"Literal","endLine":47,"endColumn":36},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 30 to the 25 allowed.","line":146,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":146,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from 'next/server';\nimport { createAdminClient } from '@/lib/supabase/server';\nimport { stripe } from '@/lib/stripe';\nimport { getStripeWebhookSecrets } from '@/lib/env';\nimport { ensureOrderConversations } from \"@/lib/order-conversations\"\nimport { logError } from \"@/lib/structured-log\"\nimport type Stripe from 'stripe';\nimport { z } from \"zod\"\n\nconst OrderItemSchema = z.object({\n  id: z.string().uuid(),\n  variantId: z.string().uuid().nullable().optional().default(null),\n  qty: z.coerce.number().int().positive().default(1),\n  price: z.coerce.number().nonnegative(),\n})\n\nconst OrderItemsSchema = z.array(OrderItemSchema).max(100)\n\n/**\n * Canonical ownership:\n * - Orders (one-time product checkout): this route\n * - Listing boosts: `app/api/payments/webhook/route.ts`\n * - Subscriptions: `app/api/subscriptions/webhook/route.ts`\r\n * - Connect account events: `app/api/connect/webhook/route.ts`\r\n */\r\n\r\ntype OrderItemPayload = {\n  id: string;\n  variantId?: string | null;\n  qty: number;\n  price: number;\n};\n\nfunction parseOrderItems(session: Stripe.Checkout.Session): OrderItemPayload[] {\n  const rawItems = session.metadata?.items_json;\n  if (!rawItems) {\n    return [];\n  }\n\n  try {\n    const parsed = JSON.parse(rawItems) as unknown\n    const result = OrderItemsSchema.safeParse(parsed)\n    if (!result.success) return []\n    return result.data\n  } catch (err) {\n    logError(\"stripe_checkout_webhook_items_json_parse_failed\", err, {\n      route: \"api/checkout/webhook\",\n      sessionId: session.id,\n    })\n  }\n\n  return [];\n}\n\ntype OrderConversationSeed = { productId: string; sellerId: string }\n\nasync function ensureOrderItems(\n  supabase: ReturnType<typeof createAdminClient>,\n  orderId: string,\n  itemsData: OrderItemPayload[]\n): Promise<OrderConversationSeed[]> {\n  // Avoid duplicate inserts if the webhook retries after order creation.\n  const { data: existingItems, error: existingItemsError } = await supabase\n    .from('order_items')\r\n    .select('product_id, seller_id')\r\n    .eq('order_id', orderId);\n\n  if (existingItemsError) {\n    logError(\"stripe_checkout_webhook_order_items_existing_fetch_failed\", existingItemsError, {\n      route: \"api/checkout/webhook\",\n      orderId,\n    })\n    return [];\n  }\n\n  if (existingItems?.length) {\n    return existingItems.map((item) => ({\n      productId: item.product_id,\r\n      sellerId: item.seller_id,\r\n    }))\r\n  }\r\n\r\n  if (itemsData.length === 0) {\r\n    return []\r\n  }\r\n\r\n  const productIds = itemsData.map(item => item.id).filter(Boolean);\r\n  if (productIds.length === 0) {\r\n    return [];\r\n  }\r\n\r\n  const { data: products, error: productsError } = await supabase\r\n    .from('products')\r\n    .select('id, seller_id')\r\n    .in('id', productIds);\n\n  if (productsError) {\n    logError(\"stripe_checkout_webhook_products_fetch_failed\", productsError, {\n      route: \"api/checkout/webhook\",\n      orderId,\n    })\n  }\n\r\n  const productSellerMap = new Map(\r\n    products?.map((product) => [product.id, product.seller_id]) || []\r\n  );\r\n\r\n  const validItems = itemsData\r\n    .map((item) => {\r\n      if (!item.id) return null\r\n      const sellerId = productSellerMap.get(item.id)\r\n      if (!sellerId) return null\r\n\r\n      return {\r\n        order_id: orderId,\r\n        product_id: item.id,\r\n        seller_id: sellerId,\r\n        quantity: item.qty || 1,\r\n        price_at_purchase: item.price,\r\n        ...(item.variantId ? { variant_id: item.variantId } : {}),\r\n      }\r\n    })\r\n    .filter((item): item is NonNullable<typeof item> => Boolean(item));\r\n\r\n  if (validItems.length === 0) {\r\n    return [];\r\n  }\r\n\r\n  const { error: itemsError } = await supabase\r\n    .from('order_items')\n    .insert(validItems);\n\n  if (itemsError) {\n    logError(\"stripe_checkout_webhook_order_items_insert_failed\", itemsError, {\n      route: \"api/checkout/webhook\",\n      orderId,\n    })\n  }\n\n  return validItems.map((item) => ({\n    productId: item.product_id,\n    sellerId: item.seller_id,\r\n  }))\r\n}\n\nexport async function POST(req: Request) {\n  const supabase = createAdminClient()\n  const body = await req.text();\n  const sig = req.headers.get('stripe-signature');\n\n  if (!sig) {\n    logError(\"stripe_checkout_webhook_missing_signature\", null, {\n      route: \"api/checkout/webhook\",\n    })\n    return NextResponse.json({ error: 'Missing signature' }, { status: 400 });\n  }\n\n  let event: Stripe.Event | undefined;\n\r\n  try {\r\n    const secrets = getStripeWebhookSecrets();\r\n    let lastError: unknown;\r\n\r\n    for (const secret of secrets) {\r\n      try {\r\n        event = stripe.webhooks.constructEvent(body, sig, secret);\r\n        lastError = undefined;\r\n        break;\r\n      } catch (err) {\r\n        lastError = err;\r\n      }\r\n    }\r\n\r\n    if (!event) {\r\n      throw lastError ?? new Error('Unknown error');\r\n    }\n  } catch (err) {\n    const errorMessage = err instanceof Error ? err.message : 'Unknown error';\n    logError(\"stripe_checkout_webhook_signature_verification_failed\", err, {\n      route: \"api/checkout/webhook\",\n      message: errorMessage,\n    })\n    return NextResponse.json(\n      { error: `Webhook Error: ${errorMessage}` },\n      { status: 400 }\n    );\n  }\r\n\r\n  // Handle the checkout.session.completed event\r\n  if (event.type === 'checkout.session.completed') {\r\n    const session = event.data.object as Stripe.Checkout.Session;\r\n\r\n    try {\r\n      // Avoid duplicate processing across webhook endpoints.\r\n      // Boost and subscription sessions are handled by their dedicated webhook routes.\r\n      if (session.metadata?.type === 'listing_boost') {\r\n        return NextResponse.json({ received: true });\r\n      }\r\n      if (session.mode === 'subscription' || session.mode === 'setup') {\r\n        return NextResponse.json({ received: true });\r\n      }\r\n\r\n      const itemsData = parseOrderItems(session);\r\n\r\n      const sessionBuyerId = session.client_reference_id || session.metadata?.user_id\n\n      // Get line items for order details\n      const lineItems = await stripe.checkout.sessions.listLineItems(session.id);\n\r\n      // Create order in database\r\n      const shippingAddr = session.customer_details?.address ? {\r\n        name: session.customer_details.name || null,\r\n        email: session.customer_details.email || null,\r\n        address: {\r\n          city: session.customer_details.address.city || null,\r\n          country: session.customer_details.address.country || null,\r\n          line1: session.customer_details.address.line1 || null,\r\n          line2: session.customer_details.address.line2 || null,\r\n          postal_code: session.customer_details.address.postal_code || null,\r\n          state: session.customer_details.address.state || null,\r\n        },\r\n      } : null\r\n\n      const userId = sessionBuyerId\n      if (!userId) {\n        logError(\"stripe_checkout_webhook_missing_user_id\", null, {\n          route: \"api/checkout/webhook\",\n          sessionId: session.id,\n        })\n        return NextResponse.json({ error: 'No user_id' }, { status: 400 });\n      }\n\r\n      const orderPayload = {\n        user_id: userId,\n        total_amount: (session.amount_total || 0) / 100,\n        status: 'paid',\n        shipping_address: shippingAddr as import(\"@/lib/supabase/database.types\").Json,\n        // Store Stripe payment intent for reference\n        stripe_payment_intent_id: session.payment_intent as string,\n      }\n\n      const { data: order, error: orderError } = session.payment_intent\n        ? await supabase\n          .from('orders')\n          .upsert(orderPayload, { onConflict: \"stripe_payment_intent_id\" })\n          .select(\"id\")\n          .single()\n        : await supabase\n          .from('orders')\n          .insert(orderPayload)\n          .select(\"id\")\n          .single()\n\n      if (orderError) {\n        logError(\"stripe_checkout_webhook_order_insert_failed\", orderError, {\n          route: \"api/checkout/webhook\",\n        })\n        // Don't return error to Stripe - log it and investigate\n        // Stripe will retry on 5xx errors\n        return NextResponse.json({ error: 'Order creation failed' }, { status: 500 });\n      }\n\r\n      // Create order items from line items\n      if (lineItems.data.length > 0) {\n        const conversationSeeds = await ensureOrderItems(supabase, order.id, itemsData);\n        if (conversationSeeds.length > 0) {\n          await ensureOrderConversations(\n            supabase,\n            conversationSeeds.map((seed) => ({\n              orderId: order.id,\r\n              buyerId: userId,\r\n              sellerId: seed.sellerId,\r\n              productId: seed.productId,\r\n            }))\r\n          )\r\n        }\r\n      }\r\n\r\n      // TODO: Send buyer confirmation email when email service is set up\r\n      // await sendOrderConfirmationEmail(session.customer_details?.email, order);\r\n\n    } catch (error) {\n      logError(\"stripe_checkout_webhook_handler_failed\", error, {\n        route: \"api/checkout/webhook\",\n        eventType: event.type,\n      })\n      return NextResponse.json({ error: 'Processing failed' }, { status: 500 });\n    }\n  }\n\r\n  // Handle payment_intent.succeeded for additional verification\r\n  if (event.type === 'payment_intent.succeeded') {\r\n    // Payment verified - order creation handled in checkout.session.completed\r\n  }\r\n\r\n  // Handle payment failures\r\n  if (event.type === 'payment_intent.payment_failed') {\n    const paymentIntent = event.data.object as Stripe.PaymentIntent;\n    logError(\"stripe_checkout_webhook_payment_failed\", null, {\n      route: \"api/checkout/webhook\",\n      paymentIntentId: paymentIntent.id,\n      message: paymentIntent.last_payment_error?.message ?? null,\n    })\n  }\n\r\n  return NextResponse.json({ received: true });\r\n}\r\n\r\n// Note: runtime = 'nodejs' removed as it's not compatible with Next.js 16 cacheComponents\r\n// Stripe webhook signature verification still works with the default runtime\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\connect\\dashboard\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\connect\\onboarding\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\connect\\webhook\\route.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":26,"column":14,"nodeType":"Literal","endLine":26,"endColumn":35},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'application' is assigned a value but never used.","line":109,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":109,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\"\r\nimport { createAdminClient } from \"@/lib/supabase/server\"\r\nimport { stripe } from \"@/lib/stripe\"\r\nimport { getStripeConnectWebhookSecrets } from \"@/lib/env\"\r\nimport { logError, logEvent } from \"@/lib/structured-log\"\r\nimport type Stripe from \"stripe\"\r\n\r\n/**\r\n * POST /api/connect/webhook\r\n * \r\n * Handles Stripe Connect webhook events.\r\n * Updates seller_payout_status when account status changes.\r\n * \r\n * IMPORTANT: This endpoint requires a separate webhook in Stripe Dashboard\r\n * configured for Connect events (account.updated, etc.)\r\n *\r\n * Canonical ownership:\r\n * - Connect account events: this route (separate webhook secret)\r\n */\r\nexport async function POST(req: Request) {\r\n  const body = await req.text()\r\n  const sig = req.headers.get(\"stripe-signature\")\r\n\r\n  if (!sig) {\r\n    logError(\"stripe_connect_webhook_missing_signature\", null, {\r\n      route: \"api/connect/webhook\",\r\n    })\r\n    return NextResponse.json({ error: \"Missing signature\" }, { status: 400 })\r\n  }\r\n\r\n  let event: Stripe.Event | undefined\r\n\r\n  try {\r\n    const secrets = getStripeConnectWebhookSecrets()\r\n    let lastError: unknown\r\n\r\n    for (const secret of secrets) {\r\n      try {\r\n        event = stripe.webhooks.constructEvent(body, sig, secret)\r\n        lastError = undefined\r\n        break\r\n      } catch (err) {\r\n        lastError = err\r\n      }\r\n    }\r\n\r\n    if (!event) {\r\n      throw lastError ?? new Error(\"Unknown error\")\r\n    }\r\n  } catch (err) {\r\n    const errorMessage = err instanceof Error ? err.message : \"Unknown error\"\r\n    logError(\"stripe_connect_webhook_signature_verification_failed\", err, {\r\n      route: \"api/connect/webhook\",\r\n      message: errorMessage,\r\n    })\r\n    return NextResponse.json(\r\n      { error: `Webhook Error: ${errorMessage}` },\r\n      { status: 400 }\r\n    )\r\n  }\r\n\r\n  const supabase = createAdminClient()\r\n\r\n  // Handle account.updated events\r\n  if (event.type === \"account.updated\") {\r\n    const account = event.data.object as Stripe.Account\r\n\r\n    // Get seller_id from account metadata\r\n    const sellerId = account.metadata?.seller_id\r\n    if (!sellerId) {\r\n      logEvent(\"warn\", \"stripe_connect_webhook_missing_seller_metadata\", {\r\n        route: \"api/connect/webhook\",\r\n      })\r\n      // Try to find by account ID\r\n      const { data: existingStatus } = await supabase\r\n        .from(\"seller_payout_status\")\r\n        .select(\"seller_id\")\r\n        .eq(\"stripe_connect_account_id\", account.id)\r\n        .single()\r\n\r\n      if (!existingStatus) {\r\n        logError(\"stripe_connect_webhook_seller_not_found_for_account\", null, {\r\n          route: \"api/connect/webhook\",\r\n        })\r\n        return NextResponse.json({ received: true })\r\n      }\r\n    }\r\n\r\n    // Update seller payout status\r\n    const { error: updateError } = await supabase\r\n      .from(\"seller_payout_status\")\r\n      .update({\r\n        details_submitted: account.details_submitted ?? false,\r\n        charges_enabled: account.charges_enabled ?? false,\r\n        payouts_enabled: account.payouts_enabled ?? false,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq(\"stripe_connect_account_id\", account.id)\r\n\r\n    if (updateError) {\r\n      logError(\"stripe_connect_webhook_update_seller_payout_status_failed\", updateError, {\r\n        route: \"api/connect/webhook\",\r\n      })\r\n    }\r\n  }\r\n\r\n  // Handle account.application.deauthorized - seller disconnected the platform\r\n  if (event.type === \"account.application.deauthorized\") {\r\n    const application = event.data.object as Stripe.Application\r\n    const accountId = event.account // The connected account ID is in the event\r\n\r\n    if (accountId) {\r\n      // Mark account as disconnected\r\n      const { error: updateError } = await supabase\r\n        .from(\"seller_payout_status\")\r\n        .update({\r\n          charges_enabled: false,\r\n          payouts_enabled: false,\r\n          updated_at: new Date().toISOString(),\r\n        })\r\n        .eq(\"stripe_connect_account_id\", accountId)\r\n\r\n      if (updateError) {\r\n        logError(\"stripe_connect_webhook_handle_deauthorization_failed\", updateError, {\r\n          route: \"api/connect/webhook\",\r\n        })\r\n      }\r\n    }\r\n  }\r\n\r\n  return NextResponse.json({ received: true })\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\health\\env\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\orders\\[id]\\ship\\route.ts","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/orders' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":2,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":2,"endColumn":61}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\"\nimport { updateOrderItemStatus } from \"@/app/actions/orders\"\nimport { orderItemIdParamSchema, shipOrderPayloadSchema } from \"@/lib/validation/orders\"\n\n\nexport async function POST(\n  req: Request,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  const paramsResult = orderItemIdParamSchema.safeParse(await params)\n  if (!paramsResult.success) {\n    return NextResponse.json({ error: \"Invalid order item id\" }, { status: 400 })\n  }\n\n  const rawBody = await req.text()\n  let parsedBody: unknown = {}\n  if (rawBody) {\n    try {\n      parsedBody = JSON.parse(rawBody)\n    } catch {\n      return NextResponse.json({ error: \"Invalid JSON\" }, { status: 400 })\n    }\n  }\n\n  const bodyResult = shipOrderPayloadSchema.safeParse(parsedBody)\n  if (!bodyResult.success) {\n    return NextResponse.json({ error: \"Invalid request\" }, { status: 400 })\n  }\n\n  const result = await updateOrderItemStatus(\n    paramsResult.data.id,\n    \"shipped\",\n    bodyResult.data.trackingNumber,\n    bodyResult.data.shippingCarrier\n  )\n\r\n  if (!result.success) {\r\n    return NextResponse.json({ error: result.error || \"Failed\" }, { status: 400 })\r\n  }\r\n\r\n  return NextResponse.json({ ok: true })\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\orders\\[id]\\track\\route.ts","messages":[{"ruleId":"no-restricted-imports","severity":1,"message":"'@/app/actions/orders' import is restricted from being used by a pattern. Shared modules must not import from /app (route code). Move shared logic to /lib, /hooks, or /components and keep route-only code under app/**/_lib or app/**/_components.","line":2,"column":1,"nodeType":"ImportDeclaration","messageId":"patternWithCustomMessage","endLine":2,"endColumn":61}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\"\nimport { updateOrderItemStatus } from \"@/app/actions/orders\"\nimport { orderItemIdParamSchema, trackOrderPayloadSchema } from \"@/lib/validation/orders\"\n\n\nexport async function POST(\n  req: Request,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  const paramsResult = orderItemIdParamSchema.safeParse(await params)\n  if (!paramsResult.success) {\n    return NextResponse.json({ error: \"Invalid order item id\" }, { status: 400 })\n  }\n\n  const rawBody = await req.text()\n  let parsedBody: unknown = {}\n  if (rawBody) {\n    try {\n      parsedBody = JSON.parse(rawBody)\n    } catch {\n      return NextResponse.json({ error: \"Invalid JSON\" }, { status: 400 })\n    }\n  }\n\n  const bodyResult = trackOrderPayloadSchema.safeParse(parsedBody)\n  if (!bodyResult.success) {\n    return NextResponse.json({ error: \"Invalid request\" }, { status: 400 })\n  }\n\n  // Tracking is meaningful once shipped; we use shipped status as the canonical state.\n  const result = await updateOrderItemStatus(\n    paramsResult.data.id,\n    \"shipped\",\n    bodyResult.data.trackingNumber,\n    bodyResult.data.shippingCarrier\n  )\n\r\n  if (!result.success) {\r\n    return NextResponse.json({ error: result.error || \"Failed\" }, { status: 400 })\r\n  }\r\n\r\n  return NextResponse.json({ ok: true })\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\payments\\delete\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\payments\\set-default\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\payments\\setup\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\payments\\webhook\\route.ts","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 54 to the 25 allowed.","line":16,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":16,"endColumn":27},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 7 times.","line":49,"column":20,"nodeType":"Literal","endLine":49,"endColumn":42}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { stripe } from \"@/lib/stripe\"\r\nimport { createAdminClient } from \"@/lib/supabase/server\"\r\nimport { NextResponse } from \"next/server\"\r\nimport { getStripeWebhookSecrets } from \"@/lib/env\"\r\nimport { logError } from \"@/lib/structured-log\"\r\nimport type Stripe from \"stripe\"\r\n\r\n/**\r\n * Canonical ownership:\r\n * - Listing boosts (one-time Checkout sessions with `metadata.type=listing_boost`)\r\n * - Saved card setup (Checkout `mode=setup` + `checkout.session.completed`)\r\n *\r\n * Orders are handled by `app/api/checkout/webhook/route.ts`.\r\n * Subscriptions are handled by `app/api/subscriptions/webhook/route.ts`.\r\n */\r\nexport async function POST(request: Request) {\r\n    // Create admin client inside handler (avoid module-level client in serverless)\r\n    const supabase = createAdminClient()\r\n\r\n    const body = await request.text()\r\n    const signature = request.headers.get(\"stripe-signature\")\r\n\r\n    if (!signature) {\r\n        return NextResponse.json({ error: \"No signature\" }, { status: 400 })\r\n    }\r\n\r\n    let event: Stripe.Event | null = null\r\n\r\n    try {\r\n        const secrets = getStripeWebhookSecrets()\r\n        let lastError: unknown\r\n\r\n        for (const secret of secrets) {\r\n            try {\r\n                event = stripe.webhooks.constructEvent(body, signature, secret)\r\n                lastError = undefined\r\n                break\r\n            } catch (err) {\r\n                lastError = err\r\n            }\r\n        }\r\n\r\n        if (!event) {\r\n            throw lastError ?? new Error(\"Webhook verification failed\")\r\n        }\r\n    } catch (error) {\r\n        const message = error instanceof Error ? error.message : \"Webhook verification failed\"\r\n        logError(\"stripe_webhook_signature_verification_failed\", error, {\r\n            route: \"api/payments/webhook\",\r\n            message,\r\n        })\r\n        return NextResponse.json({ error: message }, { status: 400 })\r\n    }\r\n\r\n    try {\r\n        switch (event.type) {\r\n            case \"checkout.session.completed\": {\r\n                const session = event.data.object as Stripe.Checkout.Session\r\n\r\n                // Handle listing boost payments (DEC-003)\r\n                if (session.mode === \"payment\" && session.metadata?.type === \"listing_boost\") {\r\n                    const productId = session.metadata.product_id\r\n                    const sellerId = session.metadata.profile_id\r\n                    const durationDays = Number.parseInt(session.metadata.duration_days || \"7\", 10)\r\n                    const sessionId = session.id\r\n                    const amountTotal = session.amount_total // in cents\r\n                    const currency = session.currency?.toUpperCase() || \"EUR\"\r\n\r\n                    if (!productId || !sellerId) {\r\n                        logError(\"stripe_webhook_boost_missing_metadata\", null, {\r\n                            route: \"api/payments/webhook\",\r\n                            sessionId,\r\n                        })\r\n                        break\r\n                    }\r\n\r\n                    // Idempotency key: `stripe_checkout_session_id` (unique index in DB).\r\n                    // Use Stripe event timestamp so retries cannot extend boost duration.\r\n                    const eventCreatedSeconds = event.created\r\n                    const startsAt = typeof eventCreatedSeconds === \"number\"\r\n                        ? new Date(eventCreatedSeconds * 1000)\r\n                        : new Date()\r\n\r\n                    const computedExpiresAt = new Date(startsAt.getTime() + durationDays * 24 * 60 * 60 * 1000)\r\n                    let expiresAtIso = computedExpiresAt.toISOString()\r\n\r\n                    const { error: boostInsertError } = await supabase\r\n                        .from('listing_boosts')\r\n                        .insert({\r\n                            product_id: productId,\r\n                            seller_id: sellerId,\r\n                            price_paid: amountTotal ? amountTotal / 100 : 0,\r\n                            currency,\r\n                            duration_days: durationDays,\r\n                            starts_at: startsAt.toISOString(),\r\n                            expires_at: expiresAtIso,\r\n                            is_active: true,\r\n                            stripe_checkout_session_id: sessionId,\r\n                        })\r\n\r\n                    if (boostInsertError) {\r\n                        // If this is a retry, the row may already exist; fetch it so we can still\r\n                        // enforce product flags without extending the boost.\r\n                        const isDuplicate = boostInsertError.code === \"23505\"\r\n                        if (!isDuplicate) {\r\n                            logError(\"stripe_webhook_boost_insert_failed\", boostInsertError, {\r\n                                route: \"api/payments/webhook\",\r\n                                productId,\r\n                                sellerId,\r\n                            })\r\n                            break\r\n                        }\r\n\r\n                        const { data: existingBoost, error: existingBoostError } = await supabase\r\n                            .from(\"listing_boosts\")\r\n                            .select(\"expires_at\")\r\n                            .eq(\"stripe_checkout_session_id\", sessionId)\r\n                            .maybeSingle()\r\n\r\n                        if (existingBoostError || !existingBoost?.expires_at) {\r\n                            logError(\"stripe_webhook_boost_existing_fetch_failed\", existingBoostError, {\r\n                                route: \"api/payments/webhook\",\r\n                                productId,\r\n                                sellerId,\r\n                                sessionId,\r\n                            })\r\n                            break\r\n                        }\r\n\r\n                        expiresAtIso = existingBoost.expires_at\r\n                    }\r\n\r\n                    // Update product: set is_boosted=true and boost_expires_at\r\n                    const { error: productUpdateError } = await supabase\r\n                        .from(\"products\")\r\n                        .update({\r\n                            is_boosted: true,\r\n                            boost_expires_at: expiresAtIso,\r\n                            listing_type: \"boosted\",\r\n                        })\r\n                        .eq(\"id\", productId)\r\n                        .eq(\"seller_id\", sellerId)\r\n\r\n                    if (productUpdateError) {\r\n                        logError(\"stripe_webhook_product_boost_update_failed\", productUpdateError, {\r\n                            route: \"api/payments/webhook\",\r\n                            productId,\r\n                        })\r\n                    }\r\n\r\n                    break\r\n                }\r\n\r\n                // Handle setup mode sessions (saved payment methods)\r\n                if (session.mode !== \"setup\") break\r\n\r\n                const customerId =\r\n                    typeof session.customer === \"string\"\r\n                        ? session.customer\r\n                        : session.customer?.id ?? null\r\n\r\n                const setupIntentId =\r\n                    typeof session.setup_intent === \"string\"\r\n                        ? session.setup_intent\r\n                        : session.setup_intent?.id ?? null\r\n\r\n                const userId = session.metadata?.user_id\r\n\r\n                if (!userId || !setupIntentId || !customerId) break\r\n\r\n                // Get the SetupIntent to find the payment method\r\n                const setupIntent = await stripe.setupIntents.retrieve(setupIntentId)\r\n                const paymentMethodId =\r\n                    typeof setupIntent.payment_method === \"string\"\r\n                        ? setupIntent.payment_method\r\n                        : setupIntent.payment_method?.id ?? null\r\n\r\n                if (!paymentMethodId) break\r\n\r\n                // Get payment method details\r\n                const paymentMethod = await stripe.paymentMethods.retrieve(paymentMethodId)\r\n\r\n                // Check if this payment method already exists\r\n                const { data: existing } = await supabase\r\n                    .from('user_payment_methods')\r\n                    .select('id')\r\n                    .eq('stripe_payment_method_id', paymentMethodId)\r\n                    .maybeSingle()\r\n\r\n                if (existing) break // Already saved\r\n\r\n                // Check if user has any existing payment methods\r\n                const { data: existingMethods } = await supabase\r\n                    .from('user_payment_methods')\r\n                    .select('id')\r\n                    .eq('user_id', userId)\r\n                    .limit(1)\r\n\r\n                const isFirst = !existingMethods || existingMethods.length === 0\r\n\r\n                // Save payment method to database\r\n                const { error: insertError } = await supabase\r\n                    .from('user_payment_methods')\r\n                    .insert({\r\n                        user_id: userId,\r\n                        stripe_payment_method_id: paymentMethodId,\r\n                        stripe_customer_id: customerId,\r\n                        card_brand: paymentMethod.card?.brand || null,\r\n                        card_last4: paymentMethod.card?.last4 || null,\r\n                        card_exp_month: paymentMethod.card?.exp_month || null,\r\n                        card_exp_year: paymentMethod.card?.exp_year || null,\r\n                        is_default: isFirst // First card is default\r\n                    })\r\n\r\n                if (insertError) {\r\n                    logError(\"stripe_webhook_save_payment_method_failed\", insertError, {\r\n                        route: \"api/payments/webhook\",\r\n                        userId,\r\n                    })\r\n                }\r\n\r\n                // If first card, set as default in Stripe too\r\n                if (isFirst) {\r\n                    await stripe.customers.update(customerId, {\r\n                        invoice_settings: {\r\n                            default_payment_method: paymentMethodId\r\n                        }\r\n                    })\r\n                }\r\n\r\n                break\r\n            }\r\n\r\n            case \"payment_method.detached\": {\r\n                const paymentMethod = event.data.object as Stripe.PaymentMethod\r\n                \r\n                // Remove from database if it exists\r\n                await supabase\r\n                    .from('user_payment_methods')\r\n                    .delete()\r\n                    .eq('stripe_payment_method_id', paymentMethod.id)\r\n\r\n                break\r\n            }\r\n        }\r\n\r\n        return NextResponse.json({ received: true })\r\n    } catch (error) {\r\n        logError(\"stripe_webhook_handler_error\", error, {\r\n            route: \"api/payments/webhook\",\r\n            eventType: event.type,\r\n        })\r\n        return NextResponse.json(\r\n            { error: \"Webhook handler failed\" },\r\n            { status: 500 }\r\n        )\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\plans\\route.ts","messages":[{"ruleId":"sonarjs/no-gratuitous-expressions","severity":1,"message":"This always evaluates to truthy. Consider refactoring this code.","line":25,"column":38,"nodeType":"Identifier","endLine":25,"endColumn":43}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from \"next/server\"\nimport { createStaticClient } from \"@/lib/supabase/server\"\nimport { cachedJsonResponse } from \"@/lib/api/response-helpers\"\n\r\nexport async function GET() {\r\n  try {\r\n    const supabase = createStaticClient()\r\n\r\n    if (!supabase) {\r\n      return NextResponse.json({ error: \"Database unavailable\" }, { status: 503 })\r\n    }\r\n    \r\n    const SUBSCRIPTION_PLANS_SELECT =\r\n      \"id,name,tier,account_type,description,description_bg,features,price_monthly,price_yearly,currency,commission_rate,final_value_fee,insertion_fee,per_order_fee,max_listings,boosts_included,analytics_access,badge_type,priority_support,stripe_price_monthly_id,stripe_price_yearly_id,is_active,created_at\" as const\r\n\r\n    const { data: plans, error } = await supabase\r\n      .from(\"subscription_plans\")\r\n      .select(SUBSCRIPTION_PLANS_SELECT)\r\n      .eq(\"is_active\", true)\r\n      .order(\"account_type\", { ascending: true })\r\n      .order(\"price_monthly\", { ascending: true })\r\n\r\n    if (error) {\n      const message =\r\n        typeof error === \"object\" && error && \"message\" in error\r\n          ? String((error as { message?: unknown }).message)\r\n          : \"\"\r\n\r\n      if (message.includes(\"During prerendering, fetch() rejects when the prerender is complete\")) {\n        return cachedJsonResponse([], \"catalog\")\n      }\n\r\n      console.error(\"Error fetching plans:\", error)\r\n      return NextResponse.json({ error: \"Failed to fetch plans\" }, { status: 500 })\r\n    }\n\n    return cachedJsonResponse(plans, \"catalog\")\n  } catch (error) {\n    const message = error instanceof Error ? error.message : String(error)\n    if (message.includes(\"During prerendering, fetch() rejects when the prerender is complete\")) {\n      return cachedJsonResponse([], \"catalog\")\n    }\n\r\n    console.error(\"Plans API error:\", error)\r\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 })\r\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\products\\[id]\\view\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\products\\category\\[slug]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\products\\count\\route.ts","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 36 to the 25 allowed.","line":80,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":80,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\"\nimport { createClient as createSupabaseClient } from \"@supabase/supabase-js\"\nimport type { Database } from \"@/lib/supabase/database.types\"\nimport { getPublicSupabaseEnv } from \"@/lib/supabase/shared\"\nimport { getShippingFilter, parseShippingRegion } from \"@/lib/shipping\"\nimport { normalizeAttributeKey } from \"@/lib/attributes/normalize-attribute-key\"\nimport { logError } from \"@/lib/structured-log\"\nimport { z } from \"zod\"\n\r\n/**\n * POST /api/products/count\n * \n * Live count endpoint for Filter Hub. Returns count-only, no payload.\n * Uses `count: \"planned\"` for fast response (<300ms p95).\n */\n\ninterface CountResponse {\n  count: number\n  timestamp: string\n}\n\nconst CountRequestSchema = z\n  .object({\n    categoryId: z.string().uuid().nullable().optional(),\n    query: z.string().trim().min(1).max(200).nullable().optional(),\n    filters: z\n      .object({\n        minPrice: z.coerce.number().nonnegative().nullable().optional(),\n        maxPrice: z.coerce.number().nonnegative().nullable().optional(),\n        minRating: z.coerce.number().min(0).max(5).nullable().optional(),\n        availability: z.enum([\"instock\"]).nullable().optional(),\n        deals: z.coerce.boolean().nullable().optional(),\n        verified: z.coerce.boolean().nullable().optional(),\n        attributes: z\n          .record(z.string(), z.union([z.string(), z.array(z.string()).max(20)]))\n          .optional(),\n      })\n      .optional(),\n  })\n  .strict()\n\nfunction getAbortErrorMessage(err: unknown): string | null {\n  if (!err) return null\n  if (err instanceof Error && err.name === \"AbortError\") return err.message\n  if (err instanceof Error && /aborted/i.test(err.message)) return err.message\n  if (typeof err === \"object\" && err && \"message\" in err) {\n    const message = (err as { message?: unknown }).message\r\n    if (typeof message === \"string\" && /aborted/i.test(message)) return message\r\n  }\r\n  return null\r\n}\r\n\r\nfunction mergeAbortSignals(a: AbortSignal | undefined, b: AbortSignal | undefined): AbortSignal | undefined {\r\n  if (a?.aborted || b?.aborted) return AbortSignal.abort()\r\n  if (!a) return b\r\n  if (!b) return a\r\n\r\n  const controller = new AbortController()\r\n  const abort = () => controller.abort()\r\n  a.addEventListener(\"abort\", abort, { once: true })\r\n  b.addEventListener(\"abort\", abort, { once: true })\r\n  return controller.signal\r\n}\r\n\r\nfunction fetchWithTimeoutMs(timeoutMs: number, requestSignal?: AbortSignal) {\r\n  return (input: RequestInfo | URL, init?: RequestInit) => {\r\n    const controller = new AbortController()\r\n    const timeoutId = setTimeout(() => controller.abort(), timeoutMs)\r\n\r\n    const merged = mergeAbortSignals(init?.signal ?? undefined, requestSignal)\r\n    if (merged) {\r\n      if (merged.aborted) controller.abort()\r\n      else merged.addEventListener(\"abort\", () => controller.abort(), { once: true })\r\n    }\r\n\r\n    return fetch(input, { ...init, signal: controller.signal }).finally(() => clearTimeout(timeoutId))\r\n  }\r\n}\r\n\nexport async function POST(request: NextRequest): Promise<NextResponse<CountResponse | { error: string }>> {\n  try {\n    const parseResult = CountRequestSchema.safeParse(await request.json())\n    if (!parseResult.success) {\n      return NextResponse.json({ error: \"Invalid request\" }, { status: 400 })\n    }\n\n    const body = parseResult.data\n    const { categoryId, query, filters = {} } = body\n\r\n    const { url, anonKey } = getPublicSupabaseEnv()\r\n    const supabase = createSupabaseClient<Database>(url, anonKey, {\r\n      global: { fetch: fetchWithTimeoutMs(2500, request.signal) },\r\n    })\r\n\r\n    // Build count-only query (select single column, head: true)\n    let countQuery = supabase\n      .from(\"products\")\n      .select(\"id\", { count: \"planned\", head: true })\n      // Public browsing surfaces must not show non-active listings.\n      // Temporary legacy allowance: status can be NULL for older rows.\n      .or(\"status.eq.active,status.is.null\")\n\r\n    // Category filter via category_ancestors (GIN index)\r\n    if (categoryId) {\r\n      countQuery = countQuery.filter(\"category_ancestors\", \"cs\", `{${categoryId}}`)\r\n    }\r\n\r\n    // Search query filter\n    if (query && query.trim()) {\n      const searchTerm = `%${query.trim()}%`\n      countQuery = countQuery.or(`title.ilike.${searchTerm},description.ilike.${searchTerm}`)\n    }\n\r\n    // Shipping zone filter from cookie (shared helper; avoids invalid column names)\r\n    const zone = parseShippingRegion(request.cookies.get(\"user-zone\")?.value)\r\n    const shippingFilter = getShippingFilter(zone)\r\n    if (shippingFilter) {\r\n      countQuery = countQuery.or(shippingFilter)\r\n    }\r\n\r\n    // Price filters\r\n    if (filters.minPrice != null) {\r\n      countQuery = countQuery.gte(\"price\", filters.minPrice)\r\n    }\r\n    if (filters.maxPrice != null) {\r\n      countQuery = countQuery.lte(\"price\", filters.maxPrice)\r\n    }\r\n\r\n    // Rating filter\r\n    if (filters.minRating != null) {\r\n      countQuery = countQuery.gte(\"rating\", filters.minRating)\r\n    }\r\n\r\n    // Availability filter\r\n    if (filters.availability === \"instock\") {\r\n      countQuery = countQuery.gt(\"stock\", 0)\r\n    }\r\n\r\n    // Deals filter (match canonical deal_products semantics: compare-at OR explicit sale)\r\n    if (filters.deals) {\r\n      countQuery = countQuery.or(\"and(is_on_sale.eq.true,sale_percent.gt.0),list_price.not.is.null\")\r\n    }\r\n\r\n    // Attribute filters\n    if (filters.attributes) {\n      for (const [rawAttrName, attrValue] of Object.entries(filters.attributes).slice(0, 25)) {\n        if (!attrValue) continue\n\n        const attrName = normalizeAttributeKey(rawAttrName) || rawAttrName\n\n        if (Array.isArray(attrValue)) {\n          const values = attrValue.filter((v): v is string => typeof v === \"string\" && v.length > 0)\n          if (values.length === 1) {\n            countQuery = countQuery.contains(\"attributes\", { [attrName]: values[0] })\n          } else if (values.length > 1) {\r\n            countQuery = countQuery.in(`attributes->>${attrName}`, values)\r\n          }\r\n        } else if (typeof attrValue === \"string\" && attrValue.length > 0) {\r\n          countQuery = countQuery.contains(\"attributes\", { [attrName]: attrValue })\r\n        }\r\n      }\r\n    }\r\n\r\n    const { count, error } = await countQuery\r\n\r\n    if (error) {\r\n      if (request.signal.aborted) {\r\n        return new NextResponse(null, { status: 499 })\r\n      }\r\n\r\n      const abortMessage = getAbortErrorMessage(error)\r\n      if (abortMessage) {\r\n        // Usually a Supabase fetch timeout or an aborted client request.\r\n        return NextResponse.json({ error: \"Count request timed out\" }, { status: 504 })\r\n      }\r\n\n      logError(\"api_products_count_supabase_error\", error, {\n        route: \"api/products/count\",\n      })\n      return NextResponse.json({ error: \"Failed to get count\" }, { status: 500 })\n    }\n\r\n    return NextResponse.json({\r\n      count: count ?? 0,\r\n      timestamp: new Date().toISOString(),\r\n    })\r\n  } catch (err) {\r\n    if (request.signal.aborted) {\r\n      return new NextResponse(null, { status: 499 })\r\n    }\r\n\r\n    const abortMessage = getAbortErrorMessage(err)\r\n    if (abortMessage) {\r\n      return NextResponse.json({ error: \"Count request timed out\" }, { status: 504 })\r\n    }\r\n\n    logError(\"api_products_count_handler_error\", err, {\n      route: \"api/products/count\",\n    })\n    return NextResponse.json({ error: \"Invalid request\" }, { status: 400 })\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\products\\feed\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\products\\newest\\route.ts","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 82 to the 25 allowed.","line":74,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":74,"endColumn":26},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":101,"column":11,"nodeType":"CallExpression","messageId":"array-from","endLine":101,"endColumn":78,"fix":{"range":[3340,3407],"text":"[...new Set([...(attributeFilters[name] || []), ...values])]"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { NextRequest, NextResponse } from \"next/server\"\r\nimport { createStaticClient } from \"@/lib/supabase/server\"\nimport { toUI, normalizeProductRow } from \"@/lib/data/products\"\nimport { \n  cachedJsonResponse, \n  dbUnavailableResponse, \n  parsePaginationParams \n} from \"@/lib/api/response-helpers\"\nimport { normalizeAttributeKey } from \"@/lib/attributes/normalize-attribute-key\"\n\r\n// Type for the nested select with relations\r\ninterface ProductRowWithRelations {\r\n  id: string\r\n  title: string\r\n  price: number\r\n  list_price: number | null\r\n  rating: number | null\r\n  review_count: number | null\n  images: string[] | null\n  seller_city: string | null\n  product_images?: Array<{\n    image_url: string\r\n    thumbnail_url: string | null\r\n    display_order: number | null\r\n    is_primary: boolean | null\r\n  }> | null\r\n  product_attributes: Array<{ name: string; value: string }> | null\r\n  is_boosted: boolean | null\r\n  boost_expires_at: string | null\r\n  created_at: string\r\n  slug: string | null\r\n  attributes?: Record<string, unknown> | null\r\n  category_ancestors: string[] | null\r\n  seller: { username: string | null } | null\r\n  categories: {\r\n    id: string\r\n    slug: string\r\n    name: string\r\n    name_bg: string | null\r\n    icon: string | null\r\n    parent: {\r\n      id: string\r\n      slug: string\r\n      name: string\r\n      name_bg: string | null\r\n      icon: string | null\r\n      parent: {\r\n        id: string\r\n        slug: string\r\n        name: string\r\n        name_bg: string | null\r\n        icon: string | null\r\n        parent: {\r\n          id: string\r\n          slug: string\r\n          name: string\r\n          name_bg: string | null\r\n          icon: string | null\r\n        } | null\r\n      } | null\r\n    } | null\r\n  } | null\r\n}\r\n\r\n/**\r\n * GET /api/products/newest\r\n * \r\n * Fetch newest products with hierarchical category filtering.\r\n * When filtering by category, returns ALL products in that category\r\n * AND all its descendants (L0 -> L1 -> L2 -> L3 -> L4).\r\n * \r\n * Uses the optimized `category_ancestors` GIN index for O(1) lookups.\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  const searchParams = request.nextUrl.searchParams\r\n  const { page, limit: safeLimit, offset } = parsePaginationParams(searchParams)\r\n  const category = searchParams.get(\"category\")\n  const sort = searchParams.get(\"sort\") || \"newest\"\n  const type = searchParams.get(\"type\") || \"newest\"\n  const city = searchParams.get(\"city\")?.trim() || null\n  const nearby = searchParams.get(\"nearby\") === \"true\"\n  const effectiveCity = nearby && !city ? null : city\n\r\n  const minPrice = searchParams.get(\"minPrice\")\r\n  const maxPrice = searchParams.get(\"maxPrice\")\r\n  const minRating = searchParams.get(\"minRating\")\r\n  const availability = searchParams.get(\"availability\")\r\n\r\n  // Extract attr_* params for attribute filtering.\n  // Keys are stable, canonical attribute keys (e.g. attr_brand=Apple).\n  const attributeFilters: Record<string, string[]> = {}\n  for (const [key] of searchParams.entries()) {\n    if (!key.startsWith('attr_')) continue\n    const rawName = key.slice('attr_'.length)\n    if (!rawName) continue\n\n    const name = normalizeAttributeKey(rawName) || rawName\n    const values = searchParams.getAll(key).filter((v) => v && v.length > 0)\n    if (values.length > 0) {\n      attributeFilters[name] = attributeFilters[name]\n        ? Array.from(new Set([...(attributeFilters[name] || []), ...values]))\n        : values\n    }\n  }\n  \r\n  try {\r\n    const supabase = createStaticClient()\r\n    if (!supabase) {\r\n      return dbUnavailableResponse()\r\n    }\r\n\r\n    let productRows: ProductRowWithRelations[] = []\r\n    let totalCount = 0\r\n\r\n    // Common select fields for product queries\r\n    // OPTIMIZED: Flat category join - no 4-level nesting!\r\n    const productSelect = `\r\n      id, \r\n      title, \r\n      price, \r\n      list_price, \r\n      rating, \r\n      review_count, \r\n      images,\n      free_shipping,\n      seller_city,\n      category_ancestors, \n      is_boosted,\n      boost_expires_at,\n      created_at, \n      slug,\n      seller:profiles(id,username,avatar_url,tier),\r\n      categories(id,slug,name,name_bg,icon)\r\n    `\r\n\r\n    if (category) {\r\n      // =================================================================\r\n      // HIERARCHICAL CATEGORY QUERY\r\n      // Uses category_ancestors array with GIN index for fast containment\r\n      // queries. Returns ALL products where the category is in their\r\n      // ancestor chain (Fashion -> Men -> Clothing -> T-shirts).\r\n      // =================================================================\r\n      \r\n      // Step 1: Get category UUID from slug\r\n      const { data: categoryData, error: categoryError } = await supabase\r\n        .from('categories')\r\n        .select('id')\r\n        .eq('slug', category)\r\n        .limit(1)\r\n        .maybeSingle()\r\n      \r\n      if (categoryError) {\r\n        console.error(\"[API] Category lookup error:\", categoryError.message)\r\n        return NextResponse.json({ \r\n          products: [], \r\n          hasMore: false,\r\n          error: categoryError.message \r\n        }, { status: 500 })\r\n      }\r\n\r\n      if (!categoryData) {\r\n        // Category not found - return empty\r\n        return cachedJsonResponse({\r\n          products: [],\r\n          hasMore: false,\r\n          totalCount: 0,\r\n          page,\r\n        })\r\n      }\r\n\r\n      // Step 2: Query products using .filter() with raw PostgREST syntax\r\n      // 'cs' = contains operator (@>), works with array columns\r\n      // This uses the GIN index on category_ancestors for efficient lookups\r\n      let query = supabase\n        .from('products')\n        .select(productSelect, { count: 'exact' })\n        .filter('category_ancestors', 'cs', `{${categoryData.id}}`)\n        // Public browsing surfaces must not show non-active listings.\n        // Temporary legacy allowance: status can be NULL for older rows.\n        .or('status.eq.active,status.is.null')\n\r\n      // Feed type filters: promoted = active boosts only (is_boosted=true AND boost_expires_at > now)\r\n      if (type === 'promoted') {\r\n        query = query.eq('is_boosted', true)\r\n        query = query.gt('boost_expires_at', new Date().toISOString())\r\n      }\r\n\r\n      // Base filters\n      if (minPrice) query = query.gte('price', Number(minPrice))\n      if (maxPrice) query = query.lte('price', Number(maxPrice))\n      if (minRating) query = query.gte('rating', Number(minRating))\n      if (availability === 'instock') query = query.gt('stock', 0)\n      if (effectiveCity) {\n        // Nearby mode on Home resolves to the same city constraint.\n        query = query.ilike(\"seller_city\", effectiveCity)\n      }\n\r\n      // Attribute filters (JSONB \"attributes\")\r\n      for (const [attrName, values] of Object.entries(attributeFilters)) {\r\n        if (values.length === 1) {\r\n          query = query.contains('attributes', { [attrName]: values[0] })\r\n        } else if (values.length > 1) {\r\n          query = query.in(`attributes->>${attrName}`, values)\r\n        }\r\n      }\r\n\r\n      // Sorting\r\n      switch (sort) {\r\n        case 'price-asc':\r\n          query = query.order('price', { ascending: true })\r\n          break\r\n        case 'price-desc':\r\n          query = query.order('price', { ascending: false })\r\n          break\r\n        case 'rating':\r\n          query = query.order('rating', { ascending: false, nullsFirst: false })\r\n          query = query.order('review_count', { ascending: false })\r\n          break\r\n        case 'newest':\r\n        default:\r\n          query = query.order('created_at', { ascending: false })\r\n      }\r\n\r\n      const { data, error, count } = await query\r\n        .range(offset, offset + safeLimit - 1)\r\n\r\n      if (error) {\r\n        // Range errors (requesting beyond available data) return malformed errors.\r\n        // If page > 1 and we get an error, treat as empty results (hasMore=false).\r\n        if (page > 1) {\r\n          productRows = []\r\n          totalCount = count ?? 0\r\n        } else {\r\n          console.error(\"[API] Products by category error:\", error)\r\n          return NextResponse.json({ \r\n            products: [], \r\n            hasMore: false,\r\n            error: typeof error.message === 'string' ? error.message : 'Query failed'\r\n          }, { status: 500 })\r\n        }\r\n      } else {\r\n        productRows = (data ?? []) as unknown as ProductRowWithRelations[]\r\n        totalCount = count ?? 0\r\n      }\r\n    } else {\r\n      // =================================================================\r\n      // ALL PRODUCTS (no category filter)\r\n      // Simple query with pagination\r\n      // =================================================================\r\n      let query = supabase\n        .from('products')\n        .select(productSelect, { count: 'exact' })\n        // Public browsing surfaces must not show non-active listings.\n        // Temporary legacy allowance: status can be NULL for older rows.\n        .or('status.eq.active,status.is.null')\n\r\n      // Feed type filters: promoted = active boosts only (is_boosted=true AND boost_expires_at > now)\r\n      if (type === 'promoted') {\r\n        query = query.eq('is_boosted', true)\r\n        query = query.gt('boost_expires_at', new Date().toISOString())\r\n      }\r\n\r\n      // Base filters\n      if (minPrice) query = query.gte('price', Number(minPrice))\n      if (maxPrice) query = query.lte('price', Number(maxPrice))\n      if (minRating) query = query.gte('rating', Number(minRating))\n      if (availability === 'instock') query = query.gt('stock', 0)\n      if (effectiveCity) {\n        // Nearby mode on Home resolves to the same city constraint.\n        query = query.ilike(\"seller_city\", effectiveCity)\n      }\n\r\n      // Attribute filters\r\n      for (const [attrName, values] of Object.entries(attributeFilters)) {\r\n        if (values.length === 1) {\r\n          query = query.contains('attributes', { [attrName]: values[0] })\r\n        } else if (values.length > 1) {\r\n          query = query.in(`attributes->>${attrName}`, values)\r\n        }\r\n      }\r\n\r\n      // Sorting\r\n      switch (sort) {\r\n        case 'price-asc':\r\n          query = query.order('price', { ascending: true })\r\n          break\r\n        case 'price-desc':\r\n          query = query.order('price', { ascending: false })\r\n          break\r\n        case 'rating':\r\n          query = query.order('rating', { ascending: false, nullsFirst: false })\r\n          query = query.order('review_count', { ascending: false })\r\n          break\r\n        case 'newest':\r\n        default:\r\n          query = query.order('created_at', { ascending: false })\r\n      }\r\n\r\n      const { data, error, count } = await query\r\n        .range(offset, offset + safeLimit - 1)\r\n\r\n      if (error) {\r\n        // Range errors (requesting beyond available data) return malformed errors.\r\n        // If page > 1 and we get an error, treat as empty results (hasMore=false).\r\n        if (page > 1) {\r\n          productRows = []\r\n          totalCount = count ?? 0\r\n        } else {\r\n          console.error(\"[API] Newest products error:\", error)\r\n          return NextResponse.json({ \r\n            products: [], \r\n            hasMore: false,\r\n            error: typeof error.message === 'string' ? error.message : 'Query failed'\r\n          }, { status: 500 })\r\n        }\r\n      } else {\r\n        productRows = (data ?? []) as unknown as ProductRowWithRelations[]\r\n        totalCount = count ?? 0\r\n      }\r\n    }\r\n\r\n    // Transform to UI format using shared normalizer\r\n    const products = productRows.map((p) => toUI(normalizeProductRow(p)))\r\n\r\n    const hasMore = offset + products.length < totalCount\r\n\r\n    return cachedJsonResponse({\r\n      products,\r\n      hasMore,\r\n      totalCount,\r\n      page,\r\n    })\r\n  } catch (error) {\r\n    console.error(\"[API] Newest products exception:\", error)\r\n    return NextResponse.json({ \r\n      products: [], \r\n      hasMore: false,\r\n      error: \"Internal server error\" \r\n    }, { status: 500 })\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\products\\quick-view\\route.ts","messages":[{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array#slice()`.","line":36,"column":8,"nodeType":"Identifier","messageId":"array-slice","endLine":36,"endColumn":13,"fix":{"range":[1293,1339],"text":"[...(product.product_images ?? [])]"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { NextRequest, NextResponse } from \"next/server\"\r\n\r\nimport { fetchProductByUsernameAndSlug } from \"@/lib/data/product-page\"\r\nimport { isNextPrerenderInterrupted } from \"@/lib/next/is-next-prerender-interrupted\"\r\nimport { PLACEHOLDER_IMAGE_PATH } from \"@/lib/normalize-image-url\"\r\n\r\n// Align CDN cache headers with next.config.ts cacheLife.products\r\nconst CACHE_TTL_SECONDS = 300\r\nconst CACHE_STALE_WHILE_REVALIDATE = 60\r\n\r\n/**\r\n * GET /api/products/quick-view?username={username}&productSlug={slugOrId}\r\n *\r\n * Returns a small JSON payload suitable for client-side \"quick view\" overlays.\r\n * This keeps the browsing URL stable while enabling richer modal content.\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const { searchParams } = new URL(request.url)\r\n    const username = searchParams.get(\"username\")\r\n    const productSlug = searchParams.get(\"productSlug\")\r\n\r\n    if (!username || !productSlug) {\r\n      return NextResponse.json(\r\n        { error: \"username and productSlug are required\" },\r\n        { status: 400 },\r\n      )\r\n    }\r\n\r\n    const product = await fetchProductByUsernameAndSlug(username, productSlug)\r\n    if (!product) {\r\n      return NextResponse.json({ error: \"not_found\" }, { status: 404 })\r\n    }\r\n\r\n    const imagesFromProductImages = (product.product_images ?? [])\r\n      .slice()\r\n      .sort((a, b) => (a.display_order ?? 0) - (b.display_order ?? 0))\r\n      .map((img) => img.image_url)\r\n      .filter((url): url is string => typeof url === \"string\" && url.length > 0)\r\n\r\n    const imagesFromArray = (product.images ?? []).filter(\r\n      (url): url is string => typeof url === \"string\" && url.length > 0,\r\n    )\r\n\r\n    const images = imagesFromProductImages.length ? imagesFromProductImages : imagesFromArray\r\n    const primaryImage = images[0] ?? PLACEHOLDER_IMAGE_PATH\r\n\r\n    const sellerUsername = product.seller?.username ?? null\r\n    const sellerName = product.seller?.display_name || product.seller?.username || null\r\n    const sellerVerified = Boolean(product.seller?.verified)\r\n\r\n    return NextResponse.json(\r\n      {\r\n        id: product.id,\r\n        title: product.title,\r\n        price: product.price,\r\n        image: primaryImage,\r\n        ...(images.length ? { images } : {}),\r\n        ...(product.list_price != null ? { originalPrice: product.list_price } : {}),\r\n        ...(product.description != null ? { description: product.description } : {}),\r\n        ...(product.condition != null ? { condition: product.condition } : {}),\r\n        ...(typeof product.rating === \"number\" ? { rating: product.rating } : {}),\r\n        ...(typeof product.review_count === \"number\" ? { reviews: product.review_count } : {}),\r\n        ...(typeof product.stock === \"number\" ? { inStock: product.stock > 0 } : {}),\r\n        ...(product.slug != null ? { slug: product.slug } : {}),\r\n        ...(sellerUsername != null ? { username: sellerUsername } : {}),\r\n        ...(typeof product.seller?.id === \"string\" ? { sellerId: product.seller.id } : {}),\r\n        ...(sellerName != null ? { sellerName } : {}),\r\n        ...(product.seller?.avatar_url != null ? { sellerAvatarUrl: product.seller.avatar_url } : {}),\r\n        sellerVerified,\r\n      },\r\n      {\r\n        headers: {\r\n          \"Cache-Control\": `public, s-maxage=${CACHE_TTL_SECONDS}, stale-while-revalidate=${CACHE_STALE_WHILE_REVALIDATE}`,\r\n          \"CDN-Cache-Control\": `public, max-age=${CACHE_TTL_SECONDS}`,\r\n          \"Vercel-CDN-Cache-Control\": `public, max-age=${CACHE_TTL_SECONDS}`,\r\n        },\r\n      },\r\n    )\r\n  } catch (error) {\r\n    if (isNextPrerenderInterrupted(error)) throw error\r\n    console.error(\"Quick view API error:\", error)\r\n    return NextResponse.json({ error: \"internal_error\" }, { status: 500 })\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\products\\search\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\revalidate\\route.ts","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 37 to the 25 allowed.","line":61,"column":10,"nodeType":null,"messageId":"refactorFunction","endLine":61,"endColumn":31},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":126,"column":10,"nodeType":"CallExpression","messageId":"array-from","endLine":126,"endColumn":25,"fix":{"range":[4190,4205],"text":"[...out]"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { revalidateTag } from 'next/cache'\nimport { NextRequest, NextResponse } from 'next/server'\nimport { logger } from '@/lib/logger'\n\r\n// =============================================================================\r\n// Cache Revalidation Webhook API (Next.js 16+)\r\n// =============================================================================\r\n// This endpoint allows external services (Supabase webhooks, CMS, admin tools)\r\n// to trigger cache invalidation for specific tags.\r\n//\r\n// Security: Requires REVALIDATION_SECRET environment variable.\r\n// Usage: POST /api/revalidate with JSON body { tag: 'categories', secret: '...' }\r\n// =============================================================================\r\n\r\ntype SupabaseWebhookEvent = {\r\n  type?: 'INSERT' | 'UPDATE' | 'DELETE'\r\n  table?: string\r\n  schema?: string\r\n  record?: Record<string, unknown> | null\r\n  old_record?: Record<string, unknown> | null\r\n}\r\n\r\ntype RevalidateScope =\r\n  | {\r\n      scope: 'categories'\r\n      categorySlug?: string\r\n      parentId?: string\r\n      previousCategorySlug?: string\r\n      previousParentId?: string\r\n    }\r\n  | {\r\n      scope: 'attributes'\r\n      categoryId?: string\r\n      previousCategoryId?: string\r\n    }\r\n\r\ninterface RevalidateRequest {\r\n  secret: string\r\n\r\n  // Raw tags (backward compatible)\r\n  tag?: string\r\n  tags?: string[]\r\n\r\n  // Higher-level invalidation helpers\r\n  scope?: RevalidateScope['scope']\r\n  categorySlug?: string\r\n  parentId?: string\r\n  previousCategorySlug?: string\r\n  previousParentId?: string\r\n  categoryId?: string\r\n  previousCategoryId?: string\r\n\r\n  // Supabase Database Webhooks payload (optional)\r\n  supabase?: SupabaseWebhookEvent\r\n}\r\n\r\nfunction asString(value: unknown): string | null {\r\n  return typeof value === 'string' && value.length > 0 ? value : null\r\n}\r\n\r\nfunction collectTagsForRequest(body: RevalidateRequest): string[] {\r\n  const out = new Set<string>()\r\n\r\n  if (body.tag) out.add(body.tag)\r\n  if (body.tags && body.tags.length > 0) {\r\n    for (const t of body.tags) {\r\n      if (typeof t === 'string' && t.length > 0) out.add(t)\r\n    }\r\n  }\r\n\r\n  if (body.scope === 'categories') {\n    out.add('categories:tree')\n    out.add('categories:sell')\n    out.add('categories:sell:depth:3')\n\r\n    const categorySlug = asString(body.categorySlug)\r\n    const previousCategorySlug = asString(body.previousCategorySlug)\r\n    const parentId = asString(body.parentId)\r\n    const previousParentId = asString(body.previousParentId)\r\n\r\n    if (categorySlug) out.add(`category:${categorySlug}`)\r\n    if (previousCategorySlug) out.add(`category:${previousCategorySlug}`)\r\n\r\n    if (parentId) out.add(`category-children:${parentId}`)\r\n    if (previousParentId) out.add(`category-children:${previousParentId}`)\r\n  }\r\n\r\n  if (body.scope === 'attributes') {\r\n    const categoryId = asString(body.categoryId)\r\n    const previousCategoryId = asString(body.previousCategoryId)\r\n\r\n    if (categoryId) out.add(`attrs:category:${categoryId}`)\r\n    if (previousCategoryId) out.add(`attrs:category:${previousCategoryId}`)\r\n  }\r\n\r\n  const supabase = body.supabase\n  if (supabase?.table === 'categories') {\n    out.add('categories:tree')\n    out.add('categories:sell')\n    out.add('categories:sell:depth:3')\n    const rec: Record<string, unknown> = supabase.record ?? {}\n    const old: Record<string, unknown> = supabase.old_record ?? {}\n\n    const slug = asString(rec[\"slug\"])\n    const oldSlug = asString(old[\"slug\"])\n    const parentId = asString(rec[\"parent_id\"])\n    const oldParentId = asString(old[\"parent_id\"])\n\n    if (slug) out.add(`category:${slug}`)\n    if (oldSlug) out.add(`category:${oldSlug}`)\n    if (parentId) out.add(`category-children:${parentId}`)\n    if (oldParentId) out.add(`category-children:${oldParentId}`)\n  }\n\n  if (supabase?.table === 'category_attributes') {\n    const rec: Record<string, unknown> = supabase.record ?? {}\n    const old: Record<string, unknown> = supabase.old_record ?? {}\n\n    const categoryId = asString(rec[\"category_id\"])\n    const oldCategoryId = asString(old[\"category_id\"])\n\n    if (categoryId) out.add(`attrs:category:${categoryId}`)\n    if (oldCategoryId) out.add(`attrs:category:${oldCategoryId}`)\n  }\n\r\n  return Array.from(out)\r\n}\r\n\r\n/**\r\n * POST /api/revalidate\r\n * Revalidate cache tags via webhook\r\n * \r\n * @body {string} secret - REVALIDATION_SECRET for authentication\r\n * @body {string} tag - Single cache tag to revalidate\r\n * @body {string[]} tags - Multiple cache tags to revalidate\r\n * \r\n * @example\r\n * // Revalidate single tag\r\n * curl -X POST https://example.com/api/revalidate \\\r\n *   -H \"Content-Type: application/json\" \\\r\n *   -d '{\"tag\": \"categories\", \"secret\": \"your-secret\"}'\r\n * \r\n * // Revalidate multiple tags\r\n * curl -X POST https://example.com/api/revalidate \\\r\n *   -H \"Content-Type: application/json\" \\\r\n *   -d '{\"tags\": [\"categories\", \"products\"], \"secret\": \"your-secret\"}'\r\n */\r\nexport async function POST(request: NextRequest) {\n  try {\n    const body: RevalidateRequest = await request.json()\n    const { secret } = body\n    \n    // Validate webhook secret\n    if (!process.env.REVALIDATION_SECRET) {\n      logger.error('[revalidate] REVALIDATION_SECRET not configured')\n      return NextResponse.json(\n        { error: 'Server misconfigured: revalidation secret not set' },\n        { status: 500 }\n      )\n    }\n    \r\n    if (secret !== process.env.REVALIDATION_SECRET) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid secret' },\r\n        { status: 401 }\r\n      )\r\n    }\r\n    \r\n    const tagsToRevalidate = collectTagsForRequest(body)\r\n    if (tagsToRevalidate.length === 0) {\r\n      return NextResponse.json(\r\n        { error: 'No tags resolved. Provide tag/tags, scope fields, or a supabase webhook payload.' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n    \r\n    const revalidatedTags: string[] = []\r\n    const failedTags: string[] = []\r\n    \r\n    for (const t of tagsToRevalidate) {\n      try {\n        revalidateTag(t, 'max')\n        revalidatedTags.push(t)\n      } catch (error) {\n        logger.error('[revalidate] Failed to revalidate tag', error, { tag: t })\n        failedTags.push(t)\n      }\n    }\n    \r\n    return NextResponse.json({\r\n      revalidated: true,\r\n      tags: revalidatedTags,\r\n      failed: failedTags.length > 0 ? failedTags : undefined,\r\n      timestamp: new Date().toISOString()\r\n    })\r\n    \r\n  } catch (error) {\n    logger.error('[revalidate] Unexpected error', error)\n    return NextResponse.json(\n      { error: 'Invalid request body' },\n      { status: 400 }\n    )\n  }\n}\n\r\n/**\r\n * GET /api/revalidate\r\n * Health check for the revalidation endpoint\r\n */\r\nexport async function GET() {\r\n  return NextResponse.json({\r\n    status: 'ok',\r\n    endpoint: '/api/revalidate',\r\n    method: 'POST',\r\n    description: 'Cache revalidation webhook',\r\n    requiredFields: {\r\n      secret: 'REVALIDATION_SECRET environment variable',\r\n      tag: 'Single cache tag (optional if tags provided)',\r\n      tags: 'Array of cache tags (optional if tag provided)',\r\n      scope: 'Optional helper: \"categories\" or \"attributes\"',\r\n      supabase: 'Optional Supabase Database Webhooks payload (table/record/old_record)'\r\n    },\r\n    note: 'Tags are defined by your app. This endpoint can revalidate any tag used by next/cache (cacheTag).',\r\n    examples: {\r\n      categories: {\r\n        scope: 'categories',\r\n        categorySlug: 'electronics',\r\n        parentId: 'uuid',\r\n      },\r\n      attributes: {\r\n        scope: 'attributes',\r\n        categoryId: 'uuid',\r\n      },\r\n      supabaseWebhook: {\r\n        supabase: {\r\n          type: 'UPDATE',\r\n          table: 'categories',\r\n          record: { id: 'uuid', slug: 'electronics', parent_id: null },\r\n          old_record: { id: 'uuid', slug: 'electronics-old', parent_id: null },\r\n        },\r\n      },\r\n      rawTags: {\r\n        tags: ['categories:tree', 'category:electronics', 'category-children:uuid', 'attrs:category:uuid'],\r\n      },\r\n    }\r\n  })\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\sales\\export\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\seller\\limits\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\subscriptions\\checkout\\route.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'session' is never reassigned. Use 'const' instead.","line":138,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":138,"endColumn":12}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { errorEnvelope, successEnvelope } from '@/lib/api/envelope'\nimport { stripe } from '@/lib/stripe'\nimport { createRouteHandlerClient } from '@/lib/supabase/server'\nimport { ID_AND_STRIPE_CUSTOMER_ID_SELECT } from '@/lib/supabase/selects/billing'\nimport { buildLocaleUrl, inferLocaleFromRequest } from '@/lib/stripe-locale'\nimport type Stripe from 'stripe'\n\nconst SUBSCRIPTION_PLAN_SELECT_FOR_CHECKOUT =\n  'id,tier,name,price_monthly,price_yearly,stripe_price_monthly_id,stripe_price_yearly_id,commission_rate,final_value_fee'\n\r\ntype CheckoutSessionCreateParams = Stripe.Checkout.SessionCreateParams\r\ntype CheckoutLineItem = Stripe.Checkout.SessionCreateParams.LineItem\r\n\r\nexport async function POST(req: NextRequest) {\r\n  // Parse body early to get locale for error URLs\r\n  let body: { planId?: string; billingPeriod?: 'monthly' | 'yearly'; locale?: 'en' | 'bg' } = {}\r\n  try {\n    body = await req.json()\n  } catch {\n    return NextResponse.json(errorEnvelope({ error: 'Invalid JSON body' }), { status: 400 })\n  }\n\r\n  const { planId, billingPeriod, locale } = body\r\n  const resolvedLocale = inferLocaleFromRequest(req, locale)\r\n  const accountPlansUrl = buildLocaleUrl('account/plans', resolvedLocale)\r\n\r\n  // Validate required fields (4xx for bad input)\n  if (!planId || typeof planId !== 'string') {\n    return NextResponse.json(errorEnvelope({ error: 'Missing or invalid planId' }), { status: 400 })\n  }\n  if (!billingPeriod || (billingPeriod !== 'monthly' && billingPeriod !== 'yearly')) {\n    return NextResponse.json(\n      errorEnvelope({ error: 'Missing or invalid billingPeriod (expected \"monthly\" or \"yearly\")' }),\n      { status: 400 }\n    )\n  }\n\r\n  const { supabase, applyCookies } = createRouteHandlerClient(req)\r\n  const json = (body: unknown, init?: Parameters<typeof NextResponse.json>[1]) =>\r\n    applyCookies(NextResponse.json(body, init))\r\n\r\n  try {\r\n    const { data: { user } } = await supabase.auth.getUser()\n    \n    if (!user) {\n      return json(errorEnvelope({ error: 'Unauthorized' }), { status: 401 })\n    }\n\n    // Get profile info\n    const { data: profile } = await supabase\n      .from('private_profiles')\n      .select(ID_AND_STRIPE_CUSTOMER_ID_SELECT)\n      .eq('id', user.id)\n      .single()\n\r\n    if (!profile) {\n      return json(errorEnvelope({ error: 'Profile not found' }), { status: 404 })\n    }\n\r\n    // Get the subscription plan by ID\r\n    const { data: plan } = await supabase\r\n      .from('subscription_plans')\r\n      .select(SUBSCRIPTION_PLAN_SELECT_FOR_CHECKOUT)\r\n      .eq('id', planId)\r\n      .eq('is_active', true)\r\n      .single()\r\n\r\n    if (!plan) {\n      return json(errorEnvelope({ error: 'Plan not found' }), { status: 404 })\n    }\n\r\n    // Can't subscribe to free tier via Stripe\r\n    if (plan.price_monthly === 0) {\n      return json(errorEnvelope({ error: 'Cannot subscribe to free tier' }), { status: 400 })\n    }\n\r\n    const price = billingPeriod === 'yearly' ? plan.price_yearly : plan.price_monthly\r\n    const stripePriceId = billingPeriod === 'yearly' ? plan.stripe_price_yearly_id : plan.stripe_price_monthly_id\r\n\r\n    // Use Stripe Price IDs when available (preferred), fallback to inline EUR pricing\r\n    const useStripePriceId = !!(stripePriceId && stripePriceId.startsWith('price_'))\r\n\r\n    // Create or get Stripe customer\r\n    let customerId = profile.stripe_customer_id\r\n\r\n    if (!customerId) {\n      const customer = await stripe.customers.create({\n        ...(user.email ? { email: user.email } : {}),\n        metadata: {\n          profile_id: profile.id,\r\n          supabase_user_id: user.id,\r\n        },\r\n      })\r\n      customerId = customer.id\n\n      await supabase\n        .from('private_profiles')\n        .update({ stripe_customer_id: customerId })\n        .eq('id', profile.id)\n    }\n\r\n    const lineItems: CheckoutLineItem[] = useStripePriceId\r\n      ? [{ price: stripePriceId, quantity: 1 }]\r\n      : [{\r\n          price_data: {\r\n            currency: 'eur',\r\n            product_data: {\r\n              name: `${plan.name} Plan`,\r\n              description: `${plan.name} seller subscription - ${billingPeriod}`,\r\n            },\r\n            unit_amount: Math.round(price * 100),\r\n            recurring: {\r\n              interval: billingPeriod === 'yearly' ? 'year' : 'month',\r\n            },\r\n          },\r\n          quantity: 1,\r\n        }]\r\n\r\n    const checkoutParams: Omit<CheckoutSessionCreateParams, 'line_items'> = {\r\n      customer: customerId,\r\n      mode: 'subscription',\r\n      payment_method_types: ['card'],\r\n      metadata: {\r\n        profile_id: profile.id,\r\n        plan_id: planId,\r\n        plan_tier: plan.tier,\r\n        billing_period: billingPeriod,\r\n        commission_rate: (plan.final_value_fee ?? plan.commission_rate ?? 12).toString(),\r\n      },\r\n      allow_promotion_codes: true,\r\n      billing_address_collection: 'required',\r\n      success_url: `${accountPlansUrl}?success=true&session_id={CHECKOUT_SESSION_ID}`,\r\n      cancel_url: `${accountPlansUrl}?canceled=true`,\r\n    }\r\n\r\n    let session: Awaited<ReturnType<typeof stripe.checkout.sessions.create>>\r\n    session = await stripe.checkout.sessions.create({\r\n      ...checkoutParams,\r\n      line_items: lineItems,\r\n    })\r\n\r\n    return json(successEnvelope({ sessionId: session.id, url: session.url }))\n  } catch (error) {\n    // Log error details server-side (no secrets - Stripe SDK doesn't expose keys in errors)\r\n    // Sanitize: only log error type + message, not full stack with potential request data\r\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error'\r\n    const errorType = error instanceof Error ? error.constructor.name : typeof error\r\n    console.error(`[checkout] ${errorType}: ${errorMessage}`)\r\n\r\n    // Determine if this is a Stripe error vs other failure\r\n    const isStripeError = error instanceof Error &&\r\n      (error.message.includes('Stripe') || 'type' in error || 'statusCode' in error)\r\n\r\n    return json(\n      errorEnvelope({\n        error: isStripeError ? 'Payment service error. Please try again.' : 'Internal server error'\n      }),\n      { status: 500 }\n    )\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\subscriptions\\portal\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\subscriptions\\webhook\\route.ts","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 105 to the 25 allowed.","line":67,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":67,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from 'next/server'\r\nimport { createAdminClient } from '@/lib/supabase/server'\r\nimport { stripe } from '@/lib/stripe'\r\nimport { getStripeSubscriptionWebhookSecrets } from '@/lib/env'\r\nimport type Stripe from 'stripe'\r\n\r\n/**\r\n * Canonical ownership:\r\n * - Subscriptions + invoices: this route (separate webhook secret)\r\n *\r\n * Orders are handled by `app/api/checkout/webhook/route.ts`.\r\n * Listing boosts + card setup are handled by `app/api/payments/webhook/route.ts`.\r\n */\r\nconst SUBSCRIPTION_SELECT_FOR_UPDATES = 'id,seller_id,status,expires_at'\r\nconst SUBSCRIPTION_PLAN_SELECT_FOR_WEBHOOK =\r\n  'id,tier,price_monthly,price_yearly,stripe_price_monthly_id,stripe_price_yearly_id,commission_rate,final_value_fee,insertion_fee,per_order_fee'\r\n\r\n/** Sanitized error logging - never log full objects or secrets */\r\nfunction logWebhookError(context: string, err: unknown): void {\r\n  const type = err instanceof Error ? err.constructor.name : typeof err\r\n  const message = err instanceof Error ? err.message : 'Unknown error'\r\n  // Only log type + message, never full stack/object\r\n  console.error(`[webhook/${context}] ${type}: ${message}`)\r\n}\r\n\r\n/** Safe Stripe subscription retrieval - returns null on failure instead of throwing */\r\nasync function safeRetrieveSubscription(\r\n  subscriptionId: string\r\n): Promise<Stripe.Subscription | null> {\r\n  try {\r\n    return await stripe.subscriptions.retrieve(subscriptionId, {\r\n      expand: ['items.data.price'],\r\n    })\r\n  } catch (err) {\r\n    logWebhookError('stripe-retrieve', err)\r\n    return null\r\n  }\r\n}\r\n\r\nasync function getFreeTierFeesForProfile(\r\n  supabase: ReturnType<typeof createAdminClient>,\r\n  profileId: string\r\n): Promise<{ finalValueFee: number; insertionFee: number; perOrderFee: number }> {\r\n  const { data: profile } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"account_type\")\r\n    .eq(\"id\", profileId)\r\n    .single()\r\n\r\n  const accountType = profile?.account_type === \"business\" ? \"business\" : \"personal\"\r\n\r\n  const { data: freePlan } = await supabase\r\n    .from(\"subscription_plans\")\r\n    .select(\"final_value_fee,commission_rate,insertion_fee,per_order_fee\")\r\n    .eq(\"tier\", \"free\")\r\n    .eq(\"account_type\", accountType)\r\n    .eq(\"is_active\", true)\r\n    .single()\r\n\r\n  const finalValueFee = Number(freePlan?.final_value_fee ?? freePlan?.commission_rate ?? 0)\r\n  const insertionFee = Number(freePlan?.insertion_fee ?? 0)\r\n  const perOrderFee = Number(freePlan?.per_order_fee ?? 0)\r\n\r\n  return { finalValueFee, insertionFee, perOrderFee }\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  // Create admin client inside handler (not at module level)\r\n  const supabase = createAdminClient()\r\n\r\n  let body: string\r\n  try {\r\n    body = await req.text()\r\n  } catch (err) {\r\n    logWebhookError('body-read', err)\r\n    return NextResponse.json({ received: true })\r\n  }\r\n\r\n  const sig = req.headers.get('stripe-signature')\r\n\r\n  if (!sig) {\r\n    return NextResponse.json({ error: 'Missing signature' }, { status: 400 })\r\n  }\r\n\r\n  let event: Stripe.Event | undefined\r\n\r\n  try {\r\n    const secrets = getStripeSubscriptionWebhookSecrets()\r\n    let lastError: unknown\r\n\r\n    for (const secret of secrets) {\r\n      try {\r\n        event = stripe.webhooks.constructEvent(body, sig, secret)\r\n        lastError = undefined\r\n        break\r\n      } catch (err) {\r\n        lastError = err\r\n      }\r\n    }\r\n\r\n    if (!event) {\r\n      throw lastError ?? new Error('Invalid signature')\r\n    }\r\n  } catch (err) {\r\n    logWebhookError('signature', err)\r\n    return NextResponse.json({ error: 'Invalid signature' }, { status: 400 })\r\n  }\r\n\r\n  // Process events - always return 200 { received: true } after signature verification\r\n  // to prevent Stripe retries from causing load spikes\r\n  try {\r\n    switch (event.type) {\r\n      case 'checkout.session.completed': {\r\n        const session = event.data.object as Stripe.Checkout.Session\r\n\r\n        // NOTE: Listing boost payments are handled by app/api/payments/webhook/route.ts\r\n        // to avoid duplicate processing. Do not add boost handling here.\r\n\r\n        // ============================================================\r\n        // HANDLE SUBSCRIPTION PAYMENTS (recurring)\r\n        // ============================================================\r\n        if (session.mode === 'subscription') {\r\n          const profileId = session.metadata?.profile_id || session.metadata?.seller_id // Support both for backwards compat\r\n          const planId = session.metadata?.plan_id\r\n          const billingPeriodRaw = session.metadata?.billing_period\r\n          const billingPeriod =\r\n            billingPeriodRaw === 'monthly' || billingPeriodRaw === 'yearly'\r\n              ? (billingPeriodRaw as 'monthly' | 'yearly')\r\n              : undefined\r\n          const subscriptionId = typeof session.subscription === 'string' ? session.subscription : null\r\n\r\n          // Safe no-op if required metadata is missing\r\n          if (!profileId || !planId || !billingPeriod || !subscriptionId) {\r\n            logWebhookError('subscription-checkout', new Error('Missing required metadata (profile_id/plan_id/billing_period/subscription_id)'))\r\n            break\r\n          }\r\n\r\n          // Get subscription details from Stripe (for period end + price id)\r\n          // Safe retrieval - returns null on failure, doesn't throw\r\n          const subscriptionResponse = await safeRetrieveSubscription(subscriptionId)\r\n          if (!subscriptionResponse) {\r\n            logWebhookError('subscription-checkout', new Error('Failed to retrieve subscription from Stripe'))\r\n            break\r\n          }\r\n\r\n          const currentPeriodEnd = (subscriptionResponse as unknown as { current_period_end: number }).current_period_end\r\n          const expiresAt = new Date(currentPeriodEnd * 1000).toISOString()\r\n          const stripePriceId = subscriptionResponse.items?.data?.[0]?.price?.id ?? null\n          const startsAt = new Date(subscriptionResponse.start_date * 1000).toISOString()\n\r\n          // Get plan details by ID (this is the source of truth)\r\n          const { data: plan } = await supabase\r\n            .from('subscription_plans')\r\n            .select(SUBSCRIPTION_PLAN_SELECT_FOR_WEBHOOK)\r\n            .eq('id', planId)\r\n            .eq('is_active', true)\r\n            .single()\r\n\r\n          if (!plan) {\r\n            logWebhookError('subscription-checkout', new Error('Plan not found for plan_id'))\r\n            break\r\n          }\r\n\r\n          // Plan consistency check: if plan has explicit Stripe price IDs,\r\n          // ensure the subscription item price matches the expected billing period.\r\n          const expectedStripePriceId =\r\n            billingPeriod === 'monthly'\r\n              ? plan.stripe_price_monthly_id\r\n              : plan.stripe_price_yearly_id\r\n\r\n          if (expectedStripePriceId && stripePriceId && stripePriceId !== expectedStripePriceId) {\r\n            logWebhookError(\r\n              'subscription-price-mismatch',\r\n              new Error(\r\n                `Stripe price mismatch for plan_id=${planId} period=${billingPeriod}: got=${stripePriceId} expected=${expectedStripePriceId}`\r\n              )\r\n            )\r\n            break\r\n          }\r\n\r\n          const pricePaid = billingPeriod === 'yearly' ? plan.price_yearly : plan.price_monthly\r\n\r\n          // Verify Stripe price amount matches the plan (defense-in-depth against tampered metadata)\r\n          const stripeUnitAmount = subscriptionResponse.items?.data?.[0]?.price?.unit_amount\r\n          if (typeof stripeUnitAmount === 'number' && Number.isFinite(pricePaid)) {\r\n            const expectedUnitAmount = Math.round(pricePaid * 100)\r\n            if (expectedUnitAmount !== stripeUnitAmount) {\r\n              logWebhookError(\r\n                'subscription-price-mismatch',\r\n                new Error(`Expected unit_amount ${expectedUnitAmount}, got ${stripeUnitAmount}`)\r\n              )\r\n              break\r\n            }\r\n          }\r\n\r\n          const { error: subError } = await supabase\n            .from('subscriptions')\n            .upsert({\n              seller_id: profileId,\n              plan_type: plan.tier,\n              status: 'active',\n              price_paid: pricePaid,\n              billing_period: billingPeriod,\n              starts_at: startsAt,\n              expires_at: expiresAt,\n              stripe_customer_id: (typeof session.customer === 'string' ? session.customer : null),\n              stripe_subscription_id: subscriptionId,\n              stripe_price_id: stripePriceId,\n              updated_at: new Date().toISOString(),\n            }, { onConflict: 'stripe_subscription_id' })\n\n          if (subError) {\n            logWebhookError('subscription-upsert', subError)\n          }\n\r\n          // Update profile tier (public surface) and fee fields (private surface) from plan\r\n          const finalValueFee = Number(plan.final_value_fee ?? plan.commission_rate ?? 0)\r\n          const [{ error: profileError }, { error: privateError }] = await Promise.all([\r\n            supabase\r\n              .from('profiles')\r\n              .update({ tier: plan.tier })\r\n              .eq('id', profileId),\r\n            supabase\r\n              .from('private_profiles')\r\n              .upsert({\r\n                id: profileId,\r\n                commission_rate: finalValueFee,\r\n                final_value_fee: finalValueFee,\r\n                insertion_fee: plan.insertion_fee ?? 0,\r\n                per_order_fee: plan.per_order_fee ?? 0,\r\n              }, { onConflict: 'id' }),\r\n          ])\r\n\r\n          if (profileError) logWebhookError('profile-update', profileError)\r\n          if (privateError) logWebhookError('private-profile-update', privateError)\r\n        }\r\n        break\r\n      }\r\n\r\n      case 'customer.subscription.updated': {\r\n        const subscriptionEvent = event.data.object as Stripe.Subscription\r\n        const stripeSubId = subscriptionEvent.id\r\n\r\n        // Find the subscription in our database\r\n        const { data: existingSub } = await supabase\r\n          .from('subscriptions')\r\n          .select(SUBSCRIPTION_SELECT_FOR_UPDATES)\r\n          .eq('stripe_subscription_id', stripeSubId)\r\n          .single()\r\n\r\n        if (existingSub) {\r\n          // Map Stripe status to our status\r\n          // KEY: Don't downgrade when cancel_at_period_end is true - user keeps access until expiry\r\n          const stripeStatus = subscriptionEvent.status\r\n          const newStatus = stripeStatus === 'active' ? 'active' \r\n            : stripeStatus === 'canceled' ? 'cancelled'\r\n            : stripeStatus === 'past_due' ? 'expired'\r\n            : existingSub.status\r\n\r\n          const expiresAt = new Date((subscriptionEvent as unknown as { current_period_end: number }).current_period_end * 1000).toISOString()\r\n          \r\n          // Track auto_renew based on cancel_at_period_end\r\n          const autoRenew = !subscriptionEvent.cancel_at_period_end\r\n\r\n          await supabase\r\n            .from('subscriptions')\r\n            .update({\r\n              status: newStatus,\r\n              expires_at: expiresAt,\r\n              auto_renew: autoRenew,\r\n              updated_at: new Date().toISOString(),\r\n            })\r\n            .eq('id', existingSub.id)\r\n\r\n          // IMPORTANT: Only downgrade profile when subscription is ACTUALLY cancelled/expired\r\n          // NOT when cancel_at_period_end is set (user still has access until period ends)\r\n          if (newStatus === 'cancelled' || newStatus === 'expired') {\r\n            const { finalValueFee, insertionFee, perOrderFee } = await getFreeTierFeesForProfile(\r\n              supabase,\r\n              existingSub.seller_id\r\n            )\r\n            await Promise.all([\r\n              supabase\r\n                .from('profiles')\r\n                .update({ tier: 'free' })\r\n                .eq('id', existingSub.seller_id),\r\n              supabase\r\n                .from('private_profiles')\r\n                .upsert({\r\n                  id: existingSub.seller_id,\r\n                  commission_rate: finalValueFee,\r\n                  final_value_fee: finalValueFee,\r\n                  insertion_fee: insertionFee,\r\n                  per_order_fee: perOrderFee,\r\n                }, { onConflict: 'id' }),\r\n            ])\r\n          }\r\n        }\r\n        break\r\n      }\r\n\r\n      case 'customer.subscription.deleted': {\r\n        // This fires when subscription period actually ends (after cancel_at_period_end)\r\n        const subscriptionEvent = event.data.object as Stripe.Subscription\r\n        const stripeSubId = subscriptionEvent.id\r\n\r\n        // Update subscription status\r\n        const { data: existingSub } = await supabase\r\n          .from('subscriptions')\r\n          .select(SUBSCRIPTION_SELECT_FOR_UPDATES)\r\n          .eq('stripe_subscription_id', stripeSubId)\r\n          .single()\r\n\r\n        if (existingSub) {\r\n          await supabase\r\n            .from('subscriptions')\r\n            .update({\r\n              status: 'expired', // Subscription has ended\r\n              auto_renew: false,\r\n              updated_at: new Date().toISOString(),\r\n            })\r\n            .eq('id', existingSub.id)\r\n\r\n          // NOW downgrade profile to free tier (subscription has actually ended)\r\n          const { finalValueFee, insertionFee, perOrderFee } = await getFreeTierFeesForProfile(\r\n            supabase,\r\n            existingSub.seller_id\r\n          )\r\n          await Promise.all([\r\n            supabase\r\n              .from('profiles')\r\n              .update({ tier: 'free' })\r\n              .eq('id', existingSub.seller_id),\r\n            supabase\r\n              .from('private_profiles')\r\n              .upsert({\r\n                id: existingSub.seller_id,\r\n                commission_rate: finalValueFee,\r\n                final_value_fee: finalValueFee,\r\n                insertion_fee: insertionFee,\r\n                per_order_fee: perOrderFee,\r\n              }, { onConflict: 'id' }),\r\n          ])\r\n        }\r\n        break\r\n      }\r\n\r\n      case 'invoice.paid': {\r\n        // Successful recurring payment - extend subscription\r\n        const invoice = event.data.object\r\n        // Extract subscription ID safely - can be string, Subscription object, or null\r\n        const subField = 'subscription' in invoice ? invoice.subscription : null\r\n        let subscriptionId: string | null = null\r\n        if (typeof subField === 'string') {\r\n          subscriptionId = subField\r\n        } else if (subField && typeof subField === 'object' && 'id' in subField && typeof subField.id === 'string') {\r\n          subscriptionId = subField.id\r\n        }\r\n\r\n        if (subscriptionId) {\r\n          const { data: existingSub } = await supabase\r\n            .from('subscriptions')\r\n            .select(SUBSCRIPTION_SELECT_FOR_UPDATES)\r\n            .eq('stripe_subscription_id', subscriptionId)\r\n            .single()\r\n\r\n          if (existingSub) {\r\n            // Get the period end from invoice lines\r\n            const invoiceLines = 'lines' in invoice ? invoice.lines : null\r\n            const firstLine = invoiceLines?.data?.[0]\r\n            const periodEnd = firstLine?.period?.end\r\n            const newExpiresAt = periodEnd \r\n              ? new Date(periodEnd * 1000).toISOString()\r\n              : existingSub.expires_at\r\n\r\n            await supabase\r\n              .from('subscriptions')\r\n              .update({\r\n                status: 'active',\r\n                expires_at: newExpiresAt,\r\n                updated_at: new Date().toISOString(),\r\n              })\r\n              .eq('id', existingSub.id)\r\n          }\r\n        }\r\n        break\r\n      }\r\n\r\n      case 'invoice.payment_failed': {\r\n        const invoice = event.data.object\r\n        // Extract subscription ID safely - can be string, Subscription object, or null\r\n        const subField = 'subscription' in invoice ? invoice.subscription : null\r\n        let subscriptionId: string | null = null\r\n        if (typeof subField === 'string') {\r\n          subscriptionId = subField\r\n        } else if (subField && typeof subField === 'object' && 'id' in subField && typeof subField.id === 'string') {\r\n          subscriptionId = subField.id\r\n        }\r\n\r\n        if (subscriptionId) {\r\n          const { data: existingSub } = await supabase\r\n            .from('subscriptions')\r\n            .select(SUBSCRIPTION_SELECT_FOR_UPDATES)\r\n            .eq('stripe_subscription_id', subscriptionId)\r\n            .single()\r\n\r\n          if (existingSub) {\r\n            // Mark as expired/pending\r\n            await supabase\r\n              .from('subscriptions')\r\n              .update({\r\n                status: 'expired',\r\n                updated_at: new Date().toISOString(),\r\n              })\r\n              .eq('id', existingSub.id)\r\n          }\r\n        }\r\n        break\r\n      }\r\n    }\r\n\r\n    return NextResponse.json({ received: true })\r\n  } catch (error) {\r\n    // Always return 200 after signature verification to prevent Stripe retry storms\r\n    // Log sanitized error for debugging, never log full object/stack\r\n    logWebhookError('processing', error)\r\n    return NextResponse.json({ received: true })\r\n  }\r\n}\r\n\r\n// Note: runtime = 'nodejs' removed as it's not compatible with Next.js 16 cacheComponents\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\upload-chat-image\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\upload-image\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\api\\wishlist\\[token]\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\auth\\callback\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\auth\\confirm\\route.ts","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 31 to the 25 allowed.","line":43,"column":23,"nodeType":null,"messageId":"refactorFunction","endLine":43,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createRouteHandlerClient } from \"@/lib/supabase/server\"\nimport { NextResponse, type NextRequest } from \"next/server\"\nimport type { EmailOtpType } from \"@supabase/supabase-js\"\r\n\r\nfunction safeNextPath(input: string | null | undefined): string {\r\n  if (!input) return \"/\"\r\n  if (!input.startsWith(\"/\")) return \"/\"\r\n  if (input.startsWith(\"//\")) return \"/\"\r\n  return input\r\n}\r\n\r\nfunction withLocalePrefix(locale: string, path: string): string {\r\n  const normalized = path.startsWith(\"/\") ? path : `/${path}`\r\n  if (normalized === \"/\") return `/${locale}`\r\n  if (normalized.startsWith(`/${locale}/`) || normalized === `/${locale}`) return normalized\r\n  return `/${locale}${normalized}`\r\n}\r\n\r\nfunction resolveLocaleFromRequest(searchParams: URLSearchParams, nextPath: string): string {\r\n  const qpLocale = searchParams.get(\"locale\")\r\n  if (qpLocale && /^[a-z]{2}(-[A-Z]{2})?$/.test(qpLocale)) return qpLocale\r\n\r\n  // If next already contains a locale prefix (/en/..., /bg/...), respect it.\r\n  const m = nextPath.match(/^\\/([a-z]{2})(?:\\/|$)/)\r\n  if (m?.[1]) return m[1]\r\n\r\n  return \"en\"\r\n}\r\n\r\n/**\r\n * Handles email confirmation links from Supabase Auth.\r\n * \r\n * Supabase can send links in two formats:\r\n * 1. PKCE flow: /auth/confirm?code=xxx (default for email confirmations)\r\n * 2. Token hash flow: /auth/confirm?token_hash=xxx&type=email\r\n * \r\n * This route handles both and exchanges them for a session.\r\n * \r\n * Post-confirmation behavior:\r\n * - New users (onboarding_completed=false): Redirect to home with ?onboarding=true\r\n * - Existing users: Redirect to intended destination\r\n */\r\nexport async function GET(request: NextRequest) {\n  const { searchParams, origin } = new URL(request.url)\r\n  \r\n  // Get parameters - Supabase uses either code (PKCE) or token_hash\r\n  const code = searchParams.get(\"code\")\r\n  const token_hash = searchParams.get(\"token_hash\")\r\n  const type = searchParams.get(\"type\") as EmailOtpType | null\r\n  const next = safeNextPath(searchParams.get(\"next\"))\r\n  const locale = resolveLocaleFromRequest(searchParams, next)\r\n  \r\n  // Handle the redirect URL for production vs development\r\n  const forwardedHost = request.headers.get(\"x-forwarded-host\")\r\n  const isLocalEnv = process.env.NODE_ENV === \"development\"\r\n  \r\n  let redirectTo: string\r\n  if (isLocalEnv) {\r\n    redirectTo = origin\r\n  } else if (forwardedHost) {\r\n    redirectTo = `https://${forwardedHost}`\r\n  } else {\r\n    // Fallback to NEXT_PUBLIC_SITE_URL or origin\r\n    redirectTo = process.env.NEXT_PUBLIC_SITE_URL || origin\r\n  }\r\n  \r\n  const { supabase, applyCookies } = createRouteHandlerClient(request)\n  const redirectWithCookies = (url: string) => applyCookies(NextResponse.redirect(url))\n  \r\n  // Handle PKCE flow (code parameter) - this is what Supabase sends for email confirmation\r\n  if (code) {\r\n    const { error } = await supabase.auth.exchangeCodeForSession(code)\r\n    \r\n    if (!error) {\r\n      // Check if this is a new user (first time confirming email)\r\n      const { data: { user } } = await supabase.auth.getUser()\r\n      \r\n      if (user) {\r\n        // Check if user has completed onboarding\r\n        const { data: profile } = await supabase\r\n          .from(\"profiles\")\r\n          .select(\"onboarding_completed\")\r\n          .eq(\"id\", user.id)\r\n          .single()\r\n        \r\n        // Cast to expected shape (column may not be in generated types yet)\r\n        const profileData = profile as { onboarding_completed?: boolean | null } | null\r\n        \r\n        // If onboarding not completed, redirect to home with onboarding modal trigger\r\n        if (!profileData?.onboarding_completed) {\r\n          return redirectWithCookies(`${redirectTo}${withLocalePrefix(locale, \"/\")}/?onboarding=true`)\n        }\n      }\n      \n      // Otherwise redirect to intended destination\n      return redirectWithCookies(`${redirectTo}${withLocalePrefix(locale, next)}`)\n    }\n    \n    console.error(\"Code exchange error:\", error.message)\n    return redirectWithCookies(`${redirectTo}${withLocalePrefix(locale, \"/auth/error\")}?error=invalid_code`)\n  }\n  \r\n  // Handle token_hash flow (older method)\r\n  if (token_hash && type) {\r\n    const { error } = await supabase.auth.verifyOtp({\r\n      type,\r\n      token_hash,\r\n    })\r\n    \r\n    if (!error) {\r\n      // Email verified successfully\r\n      if (type === \"signup\" || type === \"email\") {\r\n        // Check if user needs onboarding\r\n        const { data: { user } } = await supabase.auth.getUser()\r\n        if (user) {\r\n          const { data: profile } = await supabase\r\n            .from(\"profiles\")\r\n            .select(\"onboarding_completed\")\r\n            .eq(\"id\", user.id)\r\n            .single()\r\n          \r\n          // Cast to expected shape\r\n          const profileData = profile as { onboarding_completed?: boolean | null } | null\r\n          \r\n          if (!profileData?.onboarding_completed) {\n            return redirectWithCookies(`${redirectTo}${withLocalePrefix(locale, \"/\")}/?onboarding=true`)\n          }\n        }\n        return redirectWithCookies(`${redirectTo}${withLocalePrefix(locale, next)}`)\n      } else if (type === \"recovery\") {\n        return redirectWithCookies(`${redirectTo}${withLocalePrefix(locale, \"/auth/reset-password\")}`)\n      } else if (type === \"email_change\") {\n        return redirectWithCookies(`${redirectTo}${withLocalePrefix(locale, \"/account/settings\")}?email_changed=true`)\n      }\n      \n      return redirectWithCookies(`${redirectTo}${withLocalePrefix(locale, next)}`)\n    }\n    \r\n    console.error(\"Email verification error:\", error.message)\r\n  }\r\n  \r\n  // If verification fails, redirect to an error page\r\n  return redirectWithCookies(`${redirectTo}${withLocalePrefix(locale, \"/auth/error\")}?error=verification_failed`)\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\favicon.ico\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\global-error.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\global-not-found.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\app\\sitemap.ts","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 40 to the 25 allowed.","line":12,"column":31,"nodeType":null,"messageId":"refactorFunction","endLine":12,"endColumn":38}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { MetadataRoute } from 'next'\r\nimport { createStaticClient } from '@/lib/supabase/server'\r\n\r\n// =============================================================================\r\n// DYNAMIC SITEMAP GENERATION FOR SEO\r\n// Generates sitemap.xml with all products, categories, and profiles\r\n// =============================================================================\r\n\r\nconst BASE_URL = process.env.NEXT_PUBLIC_SITE_URL || 'https://treido.eu'\r\nconst LOCALES = ['en', 'bg']\r\n\r\nexport default async function sitemap(): Promise<MetadataRoute.Sitemap> {\r\n  const supabase = createStaticClient()\r\n  \r\n  if (!supabase) {\r\n    // Return basic sitemap if no database connection\r\n    return getStaticPages()\r\n  }\r\n\r\n  const entries: MetadataRoute.Sitemap = []\r\n\r\n  // Add static pages\r\n  entries.push(...getStaticPages())\r\n\r\n  // Add categories\r\n  const { data: categories } = await supabase\r\n    .from('categories')\r\n    .select('slug, created_at')\r\n    .order('name')\r\n\r\n  if (categories) {\r\n    for (const category of categories) {\r\n      for (const locale of LOCALES) {\r\n        entries.push({\r\n          url: `${BASE_URL}/${locale}/categories/${category.slug}`,\r\n          lastModified: category.created_at ? new Date(category.created_at) : new Date(),\r\n          changeFrequency: 'daily',\r\n          priority: 0.8,\r\n        })\r\n      }\r\n    }\r\n  }\r\n\r\n  // Add seller profiles (users with is_seller = true)\r\n  const { data: sellers } = await supabase\r\n    .from('profiles')\r\n    .select('username, updated_at')\r\n    .eq('is_seller', true)\r\n    .not('username', 'is', null)\r\n\r\n  if (sellers) {\r\n    for (const seller of sellers) {\r\n      if (!seller.username) continue\r\n      for (const locale of LOCALES) {\r\n        entries.push({\r\n          url: `${BASE_URL}/${locale}/${seller.username}`,\r\n          lastModified: seller.updated_at ? new Date(seller.updated_at) : new Date(),\r\n          changeFrequency: 'weekly',\r\n          priority: 0.7,\r\n        })\r\n      }\r\n    }\r\n  }\r\n\r\n  // Add products (active products with slugs)\r\n  // Fetch products with their seller's username for SEO URLs\r\n  const { data: products } = await supabase\r\n    .from('products')\r\n    .select(`\r\n      slug,\r\n      updated_at,\r\n      seller:profiles!products_seller_id_fkey(username)\r\n    `)\r\n    .eq('status', 'active')\r\n    .not('slug', 'is', null)\r\n    .limit(50000) // Sitemap limit\r\n\r\n  if (products) {\r\n    for (const product of products) {\r\n      if (!product.slug) continue\r\n      const username = (product.seller as { username: string | null } | null)?.username\r\n      if (!username) continue\r\n\r\n      for (const locale of LOCALES) {\r\n        entries.push({\r\n          url: `${BASE_URL}/${locale}/${username}/${product.slug}`,\r\n          lastModified: product.updated_at ? new Date(product.updated_at) : new Date(),\r\n          changeFrequency: 'daily',\r\n          priority: 0.9, // Products are highest priority for e-commerce\r\n        })\r\n      }\r\n    }\r\n  }\r\n\r\n  return entries\r\n}\r\n\r\n// Static pages that should always be in the sitemap\r\nfunction getStaticPages(): MetadataRoute.Sitemap {\r\n  const staticPages = [\r\n    { path: '', priority: 1.0, changeFrequency: 'daily' as const },\r\n    { path: '/categories', priority: 0.9, changeFrequency: 'daily' as const },\r\n    { path: '/search', priority: 0.8, changeFrequency: 'hourly' as const },\r\n    { path: '/todays-deals', priority: 0.8, changeFrequency: 'hourly' as const },\r\n    { path: '/sellers', priority: 0.7, changeFrequency: 'weekly' as const },\r\n    { path: '/sell', priority: 0.6, changeFrequency: 'monthly' as const },\r\n    { path: '/about', priority: 0.5, changeFrequency: 'monthly' as const },\r\n    { path: '/contact', priority: 0.5, changeFrequency: 'monthly' as const },\r\n    { path: '/help', priority: 0.5, changeFrequency: 'monthly' as const },\r\n    { path: '/terms', priority: 0.3, changeFrequency: 'yearly' as const },\r\n    { path: '/privacy', priority: 0.3, changeFrequency: 'yearly' as const },\r\n    { path: '/cookies', priority: 0.3, changeFrequency: 'yearly' as const },\r\n    { path: '/returns', priority: 0.4, changeFrequency: 'yearly' as const },\r\n  ]\r\n\r\n  const entries: MetadataRoute.Sitemap = []\r\n\r\n  for (const page of staticPages) {\r\n    for (const locale of LOCALES) {\r\n      entries.push({\r\n        url: `${BASE_URL}/${locale}${page.path}`,\r\n        lastModified: new Date(),\r\n        changeFrequency: page.changeFrequency,\r\n        priority: page.priority,\r\n      })\r\n    }\r\n  }\r\n\r\n  return entries\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\capacitor.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\auth\\auth-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\auth\\login-form-body.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\auth\\sign-up-form-body.tsx","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 5 times.","line":195,"column":57,"nodeType":"Literal","endLine":195,"endColumn":77},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":214,"column":60,"nodeType":"Identifier","messageId":"method","endLine":214,"endColumn":67,"fix":{"range":[7118,7118],"text":"All"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\"\n\nimport { useActionState, useEffect, useMemo, useRef, useState } from \"react\"\nimport { Check, CheckCircle, Eye, EyeSlash, SpinnerGap, X } from \"@phosphor-icons/react\"\nimport { useTranslations } from \"next-intl\"\n\nimport { SubmitButton } from \"@/components/auth/submit-button\"\nimport { Field, FieldContent, FieldError, FieldLabel } from \"@/components/shared/field\"\nimport { Input } from \"@/components/ui/input\"\nimport { Link } from \"@/i18n/routing\"\nimport { cn } from \"@/lib/utils\"\nimport { getPasswordStrength } from \"@/lib/validation/password-strength\"\nimport { Button } from \"@/components/ui/button\"\n\ntype AuthActionState = {\n  error?: string\n  fieldErrors?: Record<string, string>\n  success?: boolean\n}\n\ntype BoundSignUpAction = (\n  prevState: AuthActionState,\n  formData: FormData\n) => Promise<AuthActionState>\n\ntype CheckUsernameAvailabilityAction = (username: string) => Promise<{ available: boolean }>\n\ninterface SignUpFormBodyProps {\n  action: BoundSignUpAction\n  checkUsernameAvailabilityAction: CheckUsernameAvailabilityAction\n  onSuccess?: () => void\n  onSwitchToSignIn?: () => void\n  onNavigateAway?: () => void\n  showSignInCta?: boolean\n  showLegalText?: boolean\n  className?: string\n}\n\nexport function SignUpFormBody({\n  action,\n  checkUsernameAvailabilityAction,\n  onSuccess,\n  onSwitchToSignIn,\n  onNavigateAway,\n  showSignInCta = true,\n  showLegalText = true,\n  className,\n}: SignUpFormBodyProps) {\n  const t = useTranslations(\"Auth\")\n  const handledSuccess = useRef(false)\n\n  const [name, setName] = useState(\"\")\n  const [email, setEmail] = useState(\"\")\n  const [confirmPassword, setConfirmPassword] = useState(\"\")\n\n  const [showPassword, setShowPassword] = useState(false)\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false)\n  const [password, setPassword] = useState(\"\")\n\n  const [username, setUsername] = useState(\"\")\n  const [isCheckingUsername, setIsCheckingUsername] = useState(false)\n  const [usernameAvailable, setUsernameAvailable] = useState<boolean | null>(null)\n\n  const initialState = useMemo<AuthActionState>(() => ({ fieldErrors: {}, success: false }), [])\n  const [state, formAction] = useActionState(action, initialState)\n\n  useEffect(() => {\n    if (state?.success && !handledSuccess.current) {\n      handledSuccess.current = true\n      onSuccess?.()\n    }\n    if (!state?.success) {\n      handledSuccess.current = false\n    }\n  }, [state?.success, onSuccess])\n\n  useEffect(() => {\n    let cancelled = false\n    const timeoutId: ReturnType<typeof setTimeout> = setTimeout(async () => {\n      const cleaned = username.trim().toLowerCase()\n      if (!cleaned || cleaned.length < 3) {\n        if (!cancelled) setUsernameAvailable(null)\n        return\n      }\n\n      if (!cancelled) setIsCheckingUsername(true)\n      try {\n        const res = await checkUsernameAvailabilityAction(cleaned)\n        if (!cancelled) setUsernameAvailable(res.available)\n      } finally {\n        if (!cancelled) setIsCheckingUsername(false)\n      }\n    }, 500)\n\n    return () => {\n      cancelled = true\n      clearTimeout(timeoutId)\n    }\n  }, [username, checkUsernameAvailabilityAction])\n\n  const strength = useMemo(() => getPasswordStrength(password), [password])\n  const strengthUi = useMemo(() => {\n    if (strength.score <= 2) {\n      return { color: \"bg-destructive\", width: \"w-1/4\" }\n    }\n    if (strength.score <= 4) {\n      return { color: \"bg-status-warning\", width: \"w-2/4\" }\n    }\n    if (strength.score <= 5) {\n      return { color: \"bg-status-success\", width: \"w-3/4\" }\n    }\n    return { color: \"bg-status-success\", width: \"w-full\" }\n  }, [strength.score])\n\n  const requirements = useMemo(\n    () => [\n      { label: t(\"reqMinChars\"), met: password.length >= 8 },\n      { label: t(\"reqUppercase\"), met: /[A-Z]/.test(password) },\n      { label: t(\"reqLowercase\"), met: /[a-z]/.test(password) },\n      { label: t(\"reqNumber\"), met: /[0-9]/.test(password) },\n    ],\n    [password, t]\n  )\n\n  const usernameIndicator = (() => {\n    if (!username || username.trim().length < 3) return null\n    if (isCheckingUsername) {\n      return (\n        <span data-testid=\"username-availability\" role=\"status\" aria-live=\"polite\">\n          <span className=\"sr-only\">{t(\"usernameAvailabilityChecking\")}</span>\n          <SpinnerGap className=\"size-4 animate-spin text-muted-foreground\" weight=\"bold\" />\n        </span>\n      )\n    }\n    if (usernameAvailable === true) {\n      return (\n        <span data-testid=\"username-availability\" role=\"status\" aria-live=\"polite\">\n          <span className=\"sr-only\">{t(\"usernameAvailabilityAvailable\")}</span>\n          <CheckCircle className=\"size-4 text-success\" weight=\"fill\" />\n        </span>\n      )\n    }\n    if (usernameAvailable === false) {\n      return (\n        <span data-testid=\"username-availability\" role=\"status\" aria-live=\"polite\">\n          <span className=\"sr-only\">{t(\"usernameAvailabilityUnavailable\")}</span>\n          <X className=\"size-4 text-destructive\" />\n        </span>\n      )\n    }\n    return null\n  })()\n\n  const canSubmit =\n    name.trim().length >= 2 &&\n    username.trim().length >= 3 &&\n    email.trim().includes(\"@\") &&\n    password.length >= 8 &&\n    confirmPassword.length >= 1 &&\n    password === confirmPassword\n\n  return (\n    <div className={className}>\n      <form\n        action={formAction}\n        className=\"space-y-4\"\n        onSubmit={() => {\n          try {\n            sessionStorage.setItem(\"lastSignupEmail\", email.trim().toLowerCase())\n          } catch {\n            // Ignore storage access errors\n          }\n        }}\n      >\n        {state?.error && (\n          <div className=\"rounded-xl border border-destructive bg-destructive-subtle p-3 text-sm text-destructive\">\n            {t(state.error as never)}\n          </div>\n        )}\n\n        {/* Name Field */}\n        <Field data-invalid={!!state?.fieldErrors?.name}>\n          <FieldContent>\n            <FieldLabel htmlFor=\"name\">{t(\"yourName\")}</FieldLabel>\n            <Input\n              id=\"name\"\n              name=\"name\"\n              type=\"text\"\n              autoComplete=\"name\"\n              required\n              placeholder={t(\"namePlaceholder\")}\n              onChange={(e) => setName(e.target.value)}\n              aria-invalid={!!state?.fieldErrors?.name}\n              aria-describedby={state?.fieldErrors?.name ? \"name-error\" : undefined}\n              className={cn(state?.fieldErrors?.name && \"border-destructive\")}\n            />\n            <FieldError id=\"name-error\">\n              {state?.fieldErrors?.name ? t(state.fieldErrors.name as never) : null}\n            </FieldError>\n          </FieldContent>\n        </Field>\n\n        {/* Username Field */}\n        <Field data-invalid={!!state?.fieldErrors?.username}>\n          <FieldContent>\n            <FieldLabel htmlFor=\"username\">{t(\"username\")}</FieldLabel>\n            <div className=\"relative\">\n              <Input\n                id=\"username\"\n                name=\"username\"\n                type=\"text\"\n                value={username}\n                onChange={(e) =>\n                  setUsername(e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, \"\"))\n                }\n                autoComplete=\"username\"\n                required\n                placeholder={t(\"usernamePlaceholder\")}\n                aria-invalid={!!state?.fieldErrors?.username}\n                aria-describedby={state?.fieldErrors?.username ? \"username-error\" : undefined}\n                className={cn(\"pr-10\", state?.fieldErrors?.username && \"border-destructive\")}\n              />\n              <div className=\"absolute right-3 top-1/2 -translate-y-1/2\">{usernameIndicator}</div>\n            </div>\n            <FieldError id=\"username-error\">\n              {state?.fieldErrors?.username ? t(state.fieldErrors.username as never) : null}\n            </FieldError>\n          </FieldContent>\n        </Field>\n\n        {/* Email Field */}\n        <Field data-invalid={!!state?.fieldErrors?.email}>\n          <FieldContent>\n            <FieldLabel htmlFor=\"email\">{t(\"email\")}</FieldLabel>\n            <Input\n              id=\"email\"\n              name=\"email\"\n              type=\"email\"\n              autoComplete=\"email\"\n              required\n              placeholder={t(\"emailPlaceholder\")}\n              onChange={(e) => setEmail(e.target.value)}\n              aria-invalid={!!state?.fieldErrors?.email}\n              aria-describedby={state?.fieldErrors?.email ? \"email-error\" : undefined}\n              className={cn(state?.fieldErrors?.email && \"border-destructive\")}\n            />\n            <FieldError id=\"email-error\">\n              {state?.fieldErrors?.email ? t(state.fieldErrors.email as never) : null}\n            </FieldError>\n          </FieldContent>\n        </Field>\n\n        {/* Password Field */}\n        <Field data-invalid={!!state?.fieldErrors?.password}>\n          <FieldContent>\n            <FieldLabel htmlFor=\"password\">{t(\"password\")}</FieldLabel>\n            <div className=\"relative\">\n              <Input\n                id=\"password\"\n                name=\"password\"\n                type={showPassword ? \"text\" : \"password\"}\n                autoComplete=\"new-password\"\n                required\n                placeholder={t(\"createPasswordPlaceholder\")}\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                aria-invalid={!!state?.fieldErrors?.password}\n                aria-describedby={state?.fieldErrors?.password ? \"password-error\" : undefined}\n                className={cn(\"pr-12\", state?.fieldErrors?.password && \"border-destructive\")}\n              />\n              <button\n                type=\"button\"\n                onClick={() => setShowPassword((v) => !v)}\n                className=\"absolute right-0 top-1/2 -translate-y-1/2 size-11 inline-flex items-center justify-center text-muted-foreground hover:text-foreground rounded-xl transition-colors focus-visible:ring-2 focus-visible:ring-focus-ring\"\n                aria-label={showPassword ? t(\"hidePassword\") : t(\"showPassword\")}\n              >\n                {showPassword ? <EyeSlash className=\"size-5\" /> : <Eye className=\"size-5\" />}\n              </button>\n            </div>\n            {password && (\n              <div className=\"mt-1.5 space-y-1\">\n                <div className=\"h-1 w-full bg-muted rounded-full overflow-hidden\">\n                  <div\n                    className={`h-full transition-all duration-300 rounded-full ${strengthUi.color} ${strengthUi.width}`}\n                  />\n                </div>\n                <p className=\"text-xs text-muted-foreground\">\n                  {t(\"passwordStrength\")}: {t(strength.labelKey)}\n                </p>\n              </div>\n            )}\n            {password && (\n              <div className=\"mt-2 grid grid-cols-2 gap-x-2 gap-y-1\">\n                {requirements.map((req, i) => (\n                  <div\n                    key={i}\n                    className={`flex items-center gap-1.5 text-xs transition-colors ${req.met ? \"text-foreground\" : \"text-muted-foreground\"}`}\n                  >\n                    {req.met ? <Check className=\"size-3\" weight=\"bold\" /> : <X className=\"size-3\" />}\n                    <span>{req.label}</span>\n                  </div>\n                ))}\n              </div>\n            )}\n            <FieldError id=\"password-error\" className=\"mt-1\">\n              {state?.fieldErrors?.password ? t(state.fieldErrors.password as never) : null}\n            </FieldError>\n          </FieldContent>\n        </Field>\n\n        {/* Confirm Password Field */}\n        <Field data-invalid={!!state?.fieldErrors?.confirmPassword}>\n          <FieldContent>\n            <FieldLabel htmlFor=\"confirmPassword\">{t(\"confirmPassword\")}</FieldLabel>\n            <div className=\"relative\">\n              <Input\n                id=\"confirmPassword\"\n                name=\"confirmPassword\"\n                type={showConfirmPassword ? \"text\" : \"password\"}\n                autoComplete=\"new-password\"\n                required\n                placeholder={t(\"confirmPasswordPlaceholder\")}\n                onChange={(e) => setConfirmPassword(e.target.value)}\n                aria-invalid={!!state?.fieldErrors?.confirmPassword}\n                aria-describedby={\n                  state?.fieldErrors?.confirmPassword ? \"confirmPassword-error\" : undefined\n                }\n                className={cn(\"pr-12\", state?.fieldErrors?.confirmPassword && \"border-destructive\")}\n              />\n              <button\n                type=\"button\"\n                onClick={() => setShowConfirmPassword((v) => !v)}\n                className=\"absolute right-0 top-1/2 -translate-y-1/2 size-11 inline-flex items-center justify-center text-muted-foreground hover:text-foreground rounded-xl transition-colors focus-visible:ring-2 focus-visible:ring-focus-ring\"\n                aria-label={showConfirmPassword ? t(\"hidePassword\") : t(\"showPassword\")}\n              >\n                {showConfirmPassword ? <EyeSlash className=\"size-5\" /> : <Eye className=\"size-5\" />}\n              </button>\n            </div>\n            <FieldError id=\"confirmPassword-error\">\n              {state?.fieldErrors?.confirmPassword\n                ? t(state.fieldErrors.confirmPassword as never)\n                : null}\n            </FieldError>\n          </FieldContent>\n        </Field>\n\n        <SubmitButton\n          label={t(\"createYourAccount\")}\n          pendingLabel={t(\"creatingAccount\")}\n          disabled={!canSubmit}\n        />\n      </form>\n\n      {showLegalText && (\n        <p className=\"text-xs text-muted-foreground mt-4 leading-relaxed\">\n          {t(\"byCreatingAccount\")}{\" \"}\n          <Link href=\"/terms\" className=\"text-primary hover:underline\" onClick={onNavigateAway}>\n            {t(\"conditionsOfUse\")}\n          </Link>{\" \"}\n          {t(\"and\")}{\" \"}\n          <Link href=\"/privacy\" className=\"text-primary hover:underline\" onClick={onNavigateAway}>\n            {t(\"privacyNotice\")}\n          </Link>\n          .\n        </p>\n      )}\n\n      {showSignInCta && (\n        <div className=\"mt-6 text-center text-sm text-muted-foreground\">\n          {t(\"alreadyHaveAccount\")}{\" \"}\n          {onSwitchToSignIn ? (\n            <Button\n              type=\"button\"\n              variant=\"link\"\n              className=\"h-auto p-0 font-medium text-primary hover:underline\"\n              onClick={onSwitchToSignIn}\n            >\n              {t(\"signInArrow\")}\n            </Button>\n          ) : (\n            <Link\n              href=\"/auth/login\"\n              className=\"text-primary hover:underline font-medium\"\n              onClick={onNavigateAway}\n            >\n              {t(\"signInArrow\")}\n            </Link>\n          )}\n        </div>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\auth\\submit-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\category\\category-breadcrumb-trail.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\category\\subcategory-circles.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 29 to the 25 allowed.","line":42,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":42,"endColumn":35},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'title' is defined but never used.","line":45,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":45,"endColumn":8},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'isValidCategory' to the outer scope.","line":69,"column":43,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":69,"endColumn":45},{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":84,"column":58,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":84,"endColumn":75}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport { Link } from \"@/i18n/routing\"\nimport { cn } from \"@/lib/utils\"\nimport { useLocale, useTranslations } from \"next-intl\"\nimport { CategoryCircleVisual } from \"@/components/shared/category/category-circle-visual\"\n\ninterface Category {\n  id: string\n  name: string\n  name_bg: string | null\n  slug: string\n  parent_id: string | null\n  image_url?: string | null\n  /** Subtree product count from category_stats (optional, DEC-002) */\n  subtree_product_count?: number\n}\n\ninterface SubcategoryCirclesProps {\n  subcategories: Category[]\n  currentCategory?: Category | null\n  title?: string\n  className?: string\n  basePath?: string // \"/categories\" or undefined for \"/search?category=\"\n  /** Pre-serialized search params string (without leading '?') to preserve during navigation */\n  searchParamsString?: string\n  /** Variant: desktop = larger circles for desktop layout */\n  variant?: \"default\" | \"desktop\"\n  /** Slug of the currently active subcategory (for desktop highlighting) */\n  activeSubcategorySlug?: string | null | undefined\n  /** Show product counts under category names (DEC-002 curated browse UX) */\n  showCounts?: boolean\n  /** Optional: handle selection locally (no navigation). When set, renders buttons instead of links. */\n  onSelectCategory?: (category: Category) => void\n  /** Optional: special handler for the \\\"All\\\" circle when onSelectCategory is set. */\n  onSelectAll?: () => void\n  /** When true, always show Phosphor icons instead of images. */\n  preferIcon?: boolean\n}\n\nexport function SubcategoryCircles({\n  subcategories,\n  currentCategory,\n  title,\n  className,\n  basePath,\n  searchParamsString = \"\",\n  variant = \"default\",\n  activeSubcategorySlug = null,\n  showCounts = false,\n  onSelectCategory,\n  onSelectAll,\n  preferIcon = true, // Default to Phosphor icons\n}: SubcategoryCirclesProps) {\n  // Force icons for now (preferIcon default is true in visual component)\n  const locale = useLocale()\n  const tCommon = useTranslations(\"Common\")\n  const tSearch = useTranslations(\"SearchFilters\")\n\n  const getCategoryName = (cat: Category) => {\n    if (locale === 'bg' && cat.name_bg) {\n      return cat.name_bg\n    }\n    return cat.name\n  }\n\n  // Filter out deprecated/moved categories\n  const isValidCategory = (cat: Category) => {\n    const name = cat.name.toLowerCase()\n    return !name.includes('[deprecated]') &&\n      !name.includes('[moved]') &&\n      !name.includes('[duplicate]')\n  }\n\n  const validSubcategories = subcategories.filter(isValidCategory)\n\n  // Build URL - supports both /categories/slug and /search?category=slug\n  const buildUrl = (categorySlug: string) => {\n    if (basePath) {\n      const params = new URLSearchParams(searchParamsString)\n      params.delete(\"category\")\n      const queryString = params.toString()\n      return `${basePath}/${categorySlug}${queryString ? `?${queryString}` : ''}`\n    }\n    const params = new URLSearchParams(searchParamsString)\n    params.set(\"category\", categorySlug)\n    return `/search?${params.toString()}`\n  }\n\n  if (validSubcategories.length === 0) return null\n\n  const isDesktop = variant === \"desktop\"\n  const isInteractive = typeof onSelectCategory === \"function\"\n\n  const handleAllClick = () => {\n    if (!currentCategory) return\n    if (onSelectAll) {\n      onSelectAll()\n      return\n    }\n    onSelectCategory?.(currentCategory)\n  }\n\n  return (\n    <div className={cn(\"relative w-full overflow-x-hidden\", className)}>\n      {/* Title removed as requested */}\n\n      {/* Container with circles - horizontal scroll on mobile, wrap on larger screens */}\n      <div className=\"relative\">\n        <div\n          className={cn(\n            \"flex gap-1.5 py-1 pb-2 pr-4 overflow-x-auto scrollbar-hide\",\n            isDesktop ? \"gap-2.5 flex-wrap overflow-x-visible\" : \"sm:flex-wrap sm:overflow-x-visible\"\n          )}\n          style={{ scrollbarWidth: \"none\", msOverflowStyle: \"none\" }}\n        >\n          {/* \"All in Category\" circle - first item */}\n          {currentCategory && (\n            isInteractive ? (\n              <button\n                type=\"button\"\n                onClick={handleAllClick}\n                aria-current={isDesktop && !activeSubcategorySlug ? \"page\" : undefined}\n                className={cn(\n                  \"flex flex-col items-center gap-1 group shrink-0 touch-manipulation\",\n                  \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background\",\n                  isDesktop\n                    ? \"min-w-(--spacing-category-item-desktop) gap-2\"\n                    : \"min-w-(--spacing-category-item-lg)\"\n                )}\n              >\n                {/* Treido muted \"All\" circle - active when no subcategory selected (desktop only) */}\n                <div className={cn(\n                  \"rounded-full flex items-center justify-center overflow-hidden\",\n                  \"transition-all group-active:opacity-90\",\n                  isDesktop && !activeSubcategorySlug\n                    ? \"bg-selected border border-selected-border ring-2 ring-ring ring-offset-2 ring-offset-background\"\n                    : \"bg-surface-subtle border border-border\",\n                  isDesktop\n                    ? \"size-(--spacing-category-circle-desktop)\"\n                    : \"size-(--spacing-category-circle) shrink-0\"\n                )}>\n                  <span className={cn(\n                    \"font-medium text-center px-1 leading-tight text-foreground\",\n                    isDesktop ? \"text-sm\" : \"text-tiny\"\n                  )}>\n                    {tCommon(\"all\")}\n                  </span>\n                </div>\n\n                {/* Label */}\n                <span className={cn(\n                  \"font-medium text-center text-foreground px-1 leading-tight line-clamp-2\",\n                  isDesktop\n                    ? \"text-sm max-w-(--spacing-category-item-desktop)\"\n                    : \"text-tiny max-w-(--spacing-category-item-lg)\"\n                )}>\n                  {tSearch(\"allProducts\")}\n                </span>\n              </button>\n            ) : (\n              <Link\n                href={buildUrl(currentCategory.slug)}\n                prefetch={true}\n                className={cn(\n                  \"flex flex-col items-center gap-1 group shrink-0 touch-manipulation\",\n                  isDesktop\n                    ? \"min-w-(--spacing-category-item-desktop) gap-2\"\n                    : \"min-w-(--spacing-category-item-lg)\"\n                )}\n              >\n              {/* Treido muted \"All\" circle - active when no subcategory selected (desktop only) */}\n              <div className={cn(\n                \"rounded-full flex items-center justify-center overflow-hidden\",\n                \"transition-all group-active:opacity-90\",\n                isDesktop && !activeSubcategorySlug\n                  ? \"bg-selected border border-selected-border ring-2 ring-ring ring-offset-2 ring-offset-background\"\n                  : \"bg-surface-subtle border border-border\",\n                isDesktop\n                  ? \"size-(--spacing-category-circle-desktop)\"\n                  : \"size-(--spacing-category-circle) shrink-0\"\n              )}>\n                <span className={cn(\n                  \"font-medium text-center px-1 leading-tight text-foreground\",\n                  isDesktop ? \"text-sm\" : \"text-tiny\"\n                )}>\n                  {tCommon(\"all\")}\n                </span>\n              </div>\n\n              {/* Label */}\n              <span className={cn(\n                \"font-medium text-center text-foreground px-1 leading-tight line-clamp-2\",\n                isDesktop\n                  ? \"text-sm max-w-(--spacing-category-item-desktop)\"\n                  : \"text-tiny max-w-(--spacing-category-item-lg)\"\n              )}>\n                {tSearch(\"allProducts\")}\n              </span>\n              </Link>\n            )\n          )}\n\n          {/* Subcategory circles */}\n          {validSubcategories.map((subcat) => {\n            const isActive = isDesktop && activeSubcategorySlug === subcat.slug\n\n            const itemClasses = cn(\n              \"flex flex-col items-center group shrink-0 touch-manipulation\",\n              isDesktop\n                ? \"min-w-(--spacing-category-item-desktop) gap-2\"\n                : \"min-w-(--spacing-category-item-lg) gap-1.5\"\n            )\n\n            const circle = (\n              <CategoryCircleVisual\n                category={subcat}\n                active={isActive}\n                className={cn(\n                  \"shrink-0 group-active:opacity-90 transition-all\",\n                  isDesktop\n                    ? \"size-(--spacing-category-circle-desktop)\"\n                    : \"size-(--spacing-category-circle)\"\n                )}\n                fallbackIconSize={isDesktop ? 28 : 24}\n                fallbackIconWeight=\"bold\"\n                variant={isActive ? \"rail\" : \"muted\"}\n                preferIcon={preferIcon}\n              />\n            )\n\n            const label = (\n              <span className={cn(\n                \"font-medium text-center text-foreground px-1 leading-tight line-clamp-2 w-full\",\n                isDesktop\n                  ? \"text-sm max-w-(--spacing-category-item-desktop)\"\n                  : \"text-tiny max-w-(--spacing-category-item-lg)\"\n              )}>\n                {getCategoryName(subcat)}\n                {showCounts && typeof subcat.subtree_product_count === 'number' && (\n                  <span className=\"block text-muted-foreground font-normal text-xs\">\n                    ({subcat.subtree_product_count})\n                  </span>\n                )}\n              </span>\n            )\n\n            if (isInteractive) {\n              return (\n                <button\n                  key={subcat.id}\n                  type=\"button\"\n                  onClick={() => onSelectCategory?.(subcat)}\n                  aria-current={isActive ? \"page\" : undefined}\n                  className={cn(\n                    itemClasses,\n                    \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background\"\n                  )}\n                >\n                  {circle}\n                  {label}\n                </button>\n              )\n            }\n\n            return (\n              <Link\n                key={subcat.id}\n                href={buildUrl(subcat.slug)}\n                prefetch={true}\n                aria-current={isActive ? \"page\" : undefined}\n                className={itemClasses}\n              >\n                {circle}\n\n                {/* Category Name + Count (hide zero counts per DEC-002) */}\n                {label}\n              </Link>\n            )\n          })}\n        </div>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\category\\subcategory-tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\category-attribute-dropdowns.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'locale' is defined but never used.","line":38,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":38,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\n\nimport { useTranslations } from \"next-intl\";\nimport { cn } from \"@/lib/utils\";\nimport { CaretDown, Check } from \"@phosphor-icons/react\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuPortal,\n  DropdownMenuSeparator,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { pillActive, pillBase, pillInactive } from \"./feed-toolbar-pill\";\nimport type { FilterState } from \"./feed-toolbar\";\n\ntype FilterOption = { value: string; label: string };\n\nexport type CategoryFilterDef = {\n  id: string;\n  label: string;\n  name: string;\n  options: FilterOption[];\n};\n\ninterface CategoryAttributeDropdownsProps {\n  locale: string;\n  filters: FilterState;\n  onFiltersChange: (next: FilterState) => void;\n  inlineFilters: CategoryFilterDef[];\n  overflowFilters: CategoryFilterDef[];\n}\n\nexport function CategoryAttributeDropdowns({\n  locale,\n  filters,\n  onFiltersChange,\n  inlineFilters,\n  overflowFilters,\n}: CategoryAttributeDropdownsProps) {\n  const t = useTranslations(\"TabbedProductFeed\");\n  const overflowSelectedCount = overflowFilters.filter((f) => Boolean(filters.attributes[f.id])).length;\n\n  if (inlineFilters.length === 0 && overflowFilters.length === 0) return null;\n\n  return (\n    <>\n      <div className=\"h-6 w-px bg-border shrink-0\" />\n      <div className=\"flex items-center gap-2 shrink-0\">\n        {inlineFilters.map((filter) => {\n          const selectedValue = filters.attributes[filter.id];\n          const hasValue = Boolean(selectedValue);\n          const displayLabel = hasValue\n            ? filter.options.find((o) => o.value === selectedValue)?.label ?? selectedValue\n            : filter.label;\n\n          return (\n            <DropdownMenu key={filter.id}>\n              <DropdownMenuTrigger asChild>\n                <button type=\"button\" className={cn(pillBase, hasValue ? pillActive : pillInactive)}>\n                  <span className=\"max-w-28 truncate\">{displayLabel}</span>\n                  <CaretDown className=\"size-4 opacity-60 shrink-0\" />\n                </button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"start\" className=\"min-w-40 max-h-72 overflow-y-auto\">\n                {filter.options.map((opt) => {\n                  const isSelected = selectedValue === opt.value;\n                  return (\n                    <DropdownMenuItem\n                      key={opt.value}\n                      onClick={() => {\n                        const newAttributes = { ...filters.attributes };\n                        if (isSelected) {\n                          delete newAttributes[filter.id];\n                        } else {\n                          newAttributes[filter.id] = opt.value;\n                        }\n                        onFiltersChange({ ...filters, attributes: newAttributes });\n                      }}\n                      className={cn(isSelected && \"bg-accent\")}\n                    >\n                      <span className=\"flex-1\">{opt.label}</span>\n                      {isSelected && <Check className=\"size-4 text-primary\" />}\n                    </DropdownMenuItem>\n                  );\n                })}\n                {hasValue && (\n                  <>\n                    <DropdownMenuSeparator />\n                    <DropdownMenuItem\n                      onClick={() => {\n                        const newAttributes = { ...filters.attributes };\n                        delete newAttributes[filter.id];\n                        onFiltersChange({ ...filters, attributes: newAttributes });\n                      }}\n                      variant=\"destructive\"\n                    >\n                      {t(\"clear\")}\n                    </DropdownMenuItem>\n                  </>\n                )}\n              </DropdownMenuContent>\n            </DropdownMenu>\n          );\n        })}\n\n        {overflowFilters.length > 0 && (\n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <button type=\"button\" className={cn(pillBase, overflowSelectedCount > 0 ? pillActive : pillInactive)}>\n                <span>{t(\"tabs.moreFilters\", { count: overflowFilters.length })}</span>\n                <CaretDown className=\"size-3 opacity-50 shrink-0\" />\n              </button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"start\" className=\"min-w-44\">\n              {overflowFilters.map((filter) => {\n                const selectedValue = filters.attributes[filter.id];\n                const hasValue = Boolean(selectedValue);\n\n                return (\n                  <DropdownMenuSub key={filter.id}>\n                    <DropdownMenuSubTrigger className={cn(hasValue && \"font-medium\")}>\n                      <span className=\"flex-1\">{filter.label}</span>\n                      {hasValue && (\n                        <span className=\"text-xs text-primary ml-2\">\n                          {filter.options.find((o) => o.value === selectedValue)?.label ?? selectedValue}\n                        </span>\n                      )}\n                    </DropdownMenuSubTrigger>\n                    <DropdownMenuPortal>\n                      <DropdownMenuSubContent className=\"min-w-36 max-h-64 overflow-y-auto\">\n                        {filter.options.map((opt) => {\n                          const isSelected = selectedValue === opt.value;\n                          return (\n                            <DropdownMenuItem\n                              key={opt.value}\n                              onClick={() => {\n                                const newAttributes = { ...filters.attributes };\n                                if (isSelected) {\n                                  delete newAttributes[filter.id];\n                                } else {\n                                  newAttributes[filter.id] = opt.value;\n                                }\n                                onFiltersChange({ ...filters, attributes: newAttributes });\n                              }}\n                              className={cn(isSelected && \"bg-accent\")}\n                            >\n                              <span className=\"flex-1\">{opt.label}</span>\n                              {isSelected && <Check className=\"size-4 text-primary\" />}\n                            </DropdownMenuItem>\n                          );\n                        })}\n                        {hasValue && (\n                          <>\n                            <DropdownMenuSeparator />\n                            <DropdownMenuItem\n                              onClick={() => {\n                                const newAttributes = { ...filters.attributes };\n                                delete newAttributes[filter.id];\n                                onFiltersChange({ ...filters, attributes: newAttributes });\n                              }}\n                              variant=\"destructive\"\n                            >\n                              {t(\"clear\")}\n                            </DropdownMenuItem>\n                          </>\n                        )}\n                      </DropdownMenuSubContent>\n                    </DropdownMenuPortal>\n                  </DropdownMenuSub>\n                );\n              })}\n            </DropdownMenuContent>\n          </DropdownMenu>\n        )}\n      </div>\n    </>\n  );\n}\n\nexport type { CategoryAttributeDropdownsProps };\n\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\category-sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\desktop-filter-modal.tsx","messages":[{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":99,"column":12,"nodeType":"CallExpression","messageId":"array-from","endLine":105,"endColumn":6,"fix":{"range":[3515,3737],"text":"[...new Set([\n        ...searchParams.getAll(`attr_${attrKey}`),\n        // Backward-compat: old links used the raw name (e.g. attr_Brand).\n        ...searchParams.getAll(`attr_${attr.name}`),\n      ])]"}},{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":166,"column":39,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":166,"endColumn":50}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useEffect has missing dependencies: 'currentMaxPrice', 'currentMinPrice', 'currentRating', 'filterableAttributes', and 'getCurrentAttrValues'. Either include them or remove the dependency array.","line":124,"column":6,"nodeType":"ArrayExpression","endLine":124,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [currentMaxPrice, currentMinPrice, currentRating, filterableAttributes, getCurrentAttrValues, isOpen]","fix":{"range":[4392,4400],"text":"[currentMaxPrice, currentMinPrice, currentRating, filterableAttributes, getCurrentAttrValues, isOpen]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook React.useMemo has missing dependencies: 'currentMaxPrice', 'currentMinPrice', 'currentRating', and 'getCurrentAttrValues'. Either include them or remove the dependency array.","line":136,"column":6,"nodeType":"ArrayExpression","endLine":136,"endColumn":42,"suggestions":[{"desc":"Update the dependencies array to be: [filterableAttributes, currentMinPrice, currentMaxPrice, currentRating, getCurrentAttrValues]","fix":{"range":[4775,4811],"text":"[filterableAttributes, currentMinPrice, currentMaxPrice, currentRating, getCurrentAttrValues]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"'use client'\r\n\r\nimport * as React from 'react'\r\nimport { useSearchParams } from 'next/navigation'\r\nimport { useRouter, usePathname } from '@/i18n/routing'\r\nimport { \r\n  Sliders, \r\n  X, \r\n  Star, \r\n  Check, \r\n  MagnifyingGlass, \r\n  Tag,\r\n  CaretDown\r\n} from '@phosphor-icons/react'\r\nimport { useTranslations, useLocale } from 'next-intl'\r\nimport { cn } from '@/lib/utils'\r\nimport { Button } from '@/components/ui/button'\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n  DialogClose,\r\n  DialogDescription,\r\n} from '@/components/ui/dialog'\r\nimport { Checkbox } from '@/components/ui/checkbox'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Switch } from '@/components/ui/switch'\r\nimport { Slider } from '@/components/ui/slider'\r\nimport { useFilterCount } from '@/hooks/use-filter-count'\nimport type { CategoryAttribute } from '@/lib/types/categories'\nimport { getCategoryAttributeKey, getCategoryAttributeLabel, getCategoryAttributeOptions } from '@/lib/filters/category-attribute'\n\r\ninterface DesktopFilterModalProps {\r\n  attributes?: CategoryAttribute[]\r\n  categorySlug?: string | undefined\r\n  categoryId?: string | undefined\r\n  className?: string\r\n  /** Custom trigger element - if not provided, uses default button */\r\n  trigger?: React.ReactNode\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function DesktopFilterModal({ \r\n  attributes = [], \r\n  categorySlug,\r\n  categoryId,\r\n  className,\r\n  trigger\r\n}: DesktopFilterModalProps) {\r\n  const router = useRouter()\r\n  const pathname = usePathname()\r\n  const searchParams = useSearchParams()\r\n  const t = useTranslations('SearchFilters')\r\n  const tHub = useTranslations('FilterHub')\r\n  const locale = useLocale()\r\n  \r\n  const [isOpen, setIsOpen] = React.useState(false)\r\n  \r\n  // Pending filter states\r\n  const [pendingFilters, setPendingFilters] = React.useState<Record<string, string[]>>({})\r\n  const [pendingPrice, setPendingPrice] = React.useState<{ min: string; max: string }>({ min: '', max: '' })\r\n  const [pendingRating, setPendingRating] = React.useState<number | null>(null)\r\n  \r\n  // Filter only filterable attributes\r\n  const filterableAttributes = attributes.filter(attr => attr.is_filterable)\r\n  \r\n  // Build the base path\r\n  const basePath = categorySlug ? pathname : '/search'\r\n\r\n  // Current URL values\r\n  const currentMinPrice = searchParams.get('minPrice')\r\n  const currentMaxPrice = searchParams.get('maxPrice')\r\n  const currentRating = searchParams.get('minRating')\r\n\r\n  // Build count params for live count (only when modal is open)\r\n  const countParams = React.useMemo(() => ({\r\n    categoryId: categoryId ?? null,\r\n    filters: {\r\n      minPrice: pendingPrice.min ? Number(pendingPrice.min) : null,\r\n      maxPrice: pendingPrice.max ? Number(pendingPrice.max) : null,\r\n      minRating: pendingRating ?? null,\r\n      attributes: pendingFilters,\r\n    },\r\n  }), [categoryId, pendingPrice, pendingRating, pendingFilters])\r\n\r\n  // Live count via debounced hook (only active when modal is open)\r\n  const { count: liveCount, isLoading: isCountLoading } = useFilterCount(\r\n    isOpen ? countParams : { categoryId: null, filters: {} }\r\n  )\r\n\r\n  // Get current filter values from URL\n  const getCurrentAttrValues = (attr: CategoryAttribute): string[] => {\n    const attrKey = getCategoryAttributeKey(attr)\n    return Array.from(\n      new Set([\n        ...searchParams.getAll(`attr_${attrKey}`),\n        // Backward-compat: old links used the raw name (e.g. attr_Brand).\n        ...searchParams.getAll(`attr_${attr.name}`),\n      ]),\n    )\n  }\n\r\n  // Initialize pending state when modal opens\r\n  React.useEffect(() => {\r\n    if (isOpen) {\r\n      const initial: Record<string, string[]> = {}\n      filterableAttributes.forEach(attr => {\n        const attrKey = getCategoryAttributeKey(attr)\n        const values = getCurrentAttrValues(attr)\n        if (values.length > 0) {\n          initial[attrKey] = values\n        }\n      })\n      setPendingFilters(initial)\n      setPendingPrice({ min: currentMinPrice || '', max: currentMaxPrice || '' })\r\n      setPendingRating(currentRating ? Number.parseInt(currentRating) : null)\r\n    }\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [isOpen])\r\n\r\n  // Count active filters\r\n  const activeFilterCount = React.useMemo(() => {\r\n    let count = 0\n    filterableAttributes.forEach(attr => {\n      if (getCurrentAttrValues(attr).length > 0) count++\n    })\n    if (currentMinPrice || currentMaxPrice) count++\r\n    if (currentRating) count++\r\n    return count\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [searchParams, filterableAttributes])\r\n\r\n  // Handlers\r\n  const handleAttrChange = (attrName: string, values: string[]) => {\r\n    setPendingFilters(prev => ({ ...prev, [attrName]: values }))\r\n  }\r\n\r\n  const handleBooleanAttr = (attrName: string, checked: boolean) => {\r\n    setPendingFilters(prev => ({ ...prev, [attrName]: checked ? ['true'] : [] }))\r\n  }\r\n\r\n  // Apply filters\r\n  const applyFilters = () => {\r\n    const params = new URLSearchParams()\r\n    \r\n    searchParams.forEach((value, key) => {\r\n      if (!key.startsWith('attr_') && !['minPrice', 'maxPrice', 'minRating'].includes(key)) {\r\n        params.append(key, value)\r\n      }\r\n    })\r\n    \r\n    Object.entries(pendingFilters).forEach(([name, values]) => {\r\n      values.forEach(v => params.append(`attr_${name}`, v))\r\n    })\r\n    \r\n    if (pendingPrice.min) params.set('minPrice', pendingPrice.min)\r\n    if (pendingPrice.max) params.set('maxPrice', pendingPrice.max)\r\n    if (pendingRating) params.set('minRating', pendingRating.toString())\r\n    \r\n    const query = params.toString()\r\n    router.push(`${basePath}${query ? `?${query}` : ''}`)\r\n    setIsOpen(false)\r\n  }\r\n\r\n  // Clear all\r\n  const clearAll = () => {\r\n    setPendingFilters({})\r\n    setPendingPrice({ min: '', max: '' })\r\n    setPendingRating(null)\r\n  }\r\n\r\n  const hasPendingFilters = \r\n    Object.values(pendingFilters).some(v => v.length > 0) ||\r\n    Boolean(pendingPrice.min) || Boolean(pendingPrice.max) ||\r\n    pendingRating !== null\r\n\r\n  const priceRanges = [\r\n    { label: t('under25'), min: '', max: '25' },\r\n    { label: t('range2550'), min: '25', max: '50' },\r\n    { label: t('range50100'), min: '50', max: '100' },\r\n    { label: t('range100200'), min: '100', max: '200' },\r\n    { label: t('above200'), min: '200', max: '' }\r\n  ]\r\n\r\n  // Default trigger if none provided\r\n  const defaultTrigger = (\r\n    <Button\n      variant=\"ghost\"\n      className={cn(\n        'h-9 px-4 rounded-full gap-2 bg-secondary/50 hover:bg-secondary',\n        activeFilterCount > 0 && 'bg-selected text-primary hover:bg-hover',\n        className\n      )}\n    >\n      <Sliders size={16} weight=\"regular\" />\r\n      <span>{t('filters')}</span>\r\n      {activeFilterCount > 0 && (\r\n        <Badge variant=\"default\" className=\"h-5 min-w-5 px-1.5 text-xs\">\r\n          {activeFilterCount}\r\n        </Badge>\r\n      )}\r\n    </Button>\r\n  )\r\n\r\n  return (\r\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\r\n      <DialogTrigger asChild>\r\n        {trigger ?? defaultTrigger}\r\n      </DialogTrigger>\r\n\r\n      <DialogContent \r\n        className=\"sm:max-w-(--container-modal-lg) h-(--dialog-h-85vh) max-h-(--dialog-h-85vh) p-0 gap-0 flex flex-col overflow-hidden\"\r\n        showCloseButton={false}\r\n      >\r\n        <DialogDescription className=\"sr-only\">{t('filterProductsByAttributes')}</DialogDescription>\r\n        \r\n        {/* Header - fixed at top with subtle shadow */}\n        <div className=\"flex shrink-0 items-center justify-between px-6 py-5 border-b bg-background\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"p-2.5 rounded-md bg-selected\">\n              <Sliders size={22} className=\"text-primary\" weight=\"duotone\" />\n            </div>\n            <div>\n              <DialogTitle className=\"text-lg font-semibold tracking-tight\">{t('filters')}</DialogTitle>\n              <p className=\"text-xs text-muted-foreground mt-0.5\">\n                {t('customizeSearchResults')}\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <DialogClose asChild>\r\n            <Button \r\n              variant=\"ghost\" \r\n              size=\"icon\" \r\n              className=\"rounded-full hover:bg-muted\"\r\n              aria-label={t('closeFilters')}\r\n            >\r\n              <X size={20} weight=\"bold\" aria-hidden=\"true\" />\r\n            </Button>\r\n          </DialogClose>\r\n        </div>\r\n\r\n        {/* Content - scrollable with scroll shadow indicator */}\r\n        <div className=\"flex-1 min-h-0 overflow-y-auto overscroll-contain scroll-smooth scrollbar-soft\">\r\n          <div className=\"p-4 space-y-4\">\r\n            \r\n            {/* Row 1: Price & Rating - 2 columns 50/50 */}\r\n            <div className=\"grid grid-cols-2 gap-4\">\r\n              {/* Price Card - Compact */}\r\n              <div className=\"p-4 rounded-md border border-border/50 bg-secondary/20\">\r\n                <h4 className=\"text-sm font-semibold flex items-center gap-2 mb-3\">\r\n                  <Tag size={15} className=\"text-primary\" weight=\"duotone\" />\r\n                  {t('price')}\r\n                </h4>\r\n                <div className=\"flex flex-wrap gap-1.5 mb-3\">\r\n                  {priceRanges.map(({ label, min, max }) => {\r\n                    const isActive = pendingPrice.min === min && pendingPrice.max === max\r\n                    return (\r\n                      <button\r\n                        key={label}\r\n                        type=\"button\"\r\n                        onClick={() => setPendingPrice(isActive ? { min: '', max: '' } : { min, max })}\r\n                        className={cn(\r\n                          \"px-2.5 py-1 rounded-full text-xs font-medium transition-all\",\r\n                          isActive \r\n                            ? \"bg-primary text-primary-foreground\" \r\n                            : \"bg-background hover:bg-muted text-muted-foreground\"\r\n                        )}\r\n                      >\r\n                        {label}\r\n                      </button>\r\n                    )\r\n                  })}\r\n                </div>\r\n                <div className=\"flex items-center gap-2\">\r\n                  <div className=\"relative flex-1\">\r\n                    <span className=\"absolute left-2.5 top-1/2 -translate-y-1/2 text-muted-foreground text-xs\">$</span>\r\n                    <Input\r\n                      type=\"number\"\r\n                      placeholder={t('min')}\r\n                      value={pendingPrice.min}\r\n                      onChange={(e) => setPendingPrice(p => ({ ...p, min: e.target.value }))}\r\n                      className=\"pl-6 h-8 text-sm bg-background border-border/50\"\r\n                    />\r\n                  </div>\r\n                  <span className=\"text-muted-foreground text-sm\">ΓÇô</span>\r\n                  <div className=\"relative flex-1\">\r\n                    <span className=\"absolute left-2.5 top-1/2 -translate-y-1/2 text-muted-foreground text-xs\">$</span>\r\n                    <Input\r\n                      type=\"number\"\r\n                      placeholder={t('max')}\r\n                      value={pendingPrice.max}\r\n                      onChange={(e) => setPendingPrice(p => ({ ...p, max: e.target.value }))}\r\n                      className=\"pl-6 h-8 text-sm bg-background border-border/50\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Rating Card - Compact */}\r\n              <div className=\"p-4 rounded-md border border-border/50 bg-secondary/20\">\r\n                <h4 className=\"text-sm font-semibold flex items-center gap-2 mb-3\">\r\n                  <Star size={15} className=\"text-rating\" weight=\"fill\" />\r\n                  {t('customerReviews')}\r\n                </h4>\r\n                <div className=\"grid grid-cols-4 gap-1.5\">\r\n                  {[4, 3, 2, 1].map((stars) => {\r\n                    const isActive = pendingRating === stars\r\n                    return (\r\n                      <button\r\n                        key={stars}\r\n                        type=\"button\"\r\n                        onClick={() => setPendingRating(isActive ? null : stars)}\r\n                        className={cn(\r\n                          \"flex flex-col items-center gap-0.5 py-2 px-1 rounded-lg transition-all\",\r\n                          isActive \r\n                            ? \"bg-accent\" \r\n                            : \"bg-background hover:bg-muted text-muted-foreground\"\r\n                        )}\r\n                      >\r\n                        <div className=\"flex\">\r\n                          {[...Array(stars)].map((_, i) => (\r\n                            <Star \r\n                              key={i} \r\n                              size={10} \r\n                              weight=\"fill\" \r\n                              className=\"text-rating\"\r\n                            />\r\n                          ))}\r\n                        </div>\r\n                        <span className=\"text-2xs font-medium text-muted-foreground\">{t('andUp')}</span>\r\n                      </button>\r\n                    )\r\n                  })}\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Row 3+: Category Attributes - 3 columns */}\r\n            <div className=\"grid grid-cols-2 lg:grid-cols-3 gap-4\">\r\n              {filterableAttributes.map((attr) => {\r\n                const attrName = getCategoryAttributeLabel(attr, locale)\r\n                const options = getCategoryAttributeOptions(attr, locale) ?? []\r\n                    const attrKey = getCategoryAttributeKey(attr)\n                    const currentValues = pendingFilters[attrKey] || []\n                const selectedCount = currentValues.length\r\n\r\n                // Boolean filter\r\n                if (attr.attribute_type === 'boolean') {\r\n                  const isChecked = currentValues.includes('true')\r\n                  return (\r\n                    <div key={attr.id} className=\"p-4 rounded-md border border-border/50 bg-secondary/20\">\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <h5 className=\"text-sm font-semibold\">{attrName}</h5>\r\n                        <Switch\r\n                          checked={isChecked}\r\n                          onCheckedChange={(c) => handleBooleanAttr(attrKey, c)}\n                        />\r\n                      </div>\r\n                    </div>\r\n                  )\r\n                }\r\n\r\n                // Number filter\r\n                if (attr.attribute_type === 'number') {\r\n                  const min = attr.min_value ?? 0\r\n                  const max = attr.max_value ?? 100\r\n                  const value = currentValues[0] ? Number.parseInt(currentValues[0]) : min\r\n                  return (\r\n                    <div key={attr.id} className=\"p-4 rounded-md border border-border/50 bg-secondary/20 space-y-3\">\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <h5 className=\"text-sm font-semibold\">{attrName}</h5>\r\n                        <span className=\"text-sm font-bold text-primary\">{value}</span>\r\n                      </div>\r\n                      <Slider\r\n                        min={min}\r\n                        max={max}\r\n                        value={[value]}\r\n                        onValueChange={(values) => {\r\n                          const v = values[0]\r\n                          if (v === undefined) return\r\n                          handleAttrChange(attrKey, [v.toString()])\n                        }}\r\n                      />\r\n                      <div className=\"flex justify-between text-2xs text-muted-foreground\">\r\n                        <span>{min}</span>\r\n                        <span>{max}</span>\r\n                      </div>\r\n                    </div>\r\n                  )\r\n                }\r\n\r\n                // Select/Multiselect - ALL get search now for consistency\r\n                if ((attr.attribute_type === 'select' || attr.attribute_type === 'multiselect') && options.length > 0) {\r\n                  const isSingleSelect = attr.attribute_type === 'select'\r\n\r\n                  return (\r\n                    <div key={attr.id} className=\"p-4 rounded-md border border-border/50 bg-secondary/20 space-y-3\">\r\n                      <div className=\"flex items-center justify-between\">\r\n                        <h5 className=\"text-sm font-semibold\">{attrName}</h5>\r\n                        {selectedCount > 0 && (\r\n                          <Badge className=\"h-5 min-w-5 px-1.5 text-xs bg-primary\">{selectedCount}</Badge>\r\n                        )}\r\n                      </div>\r\n                      \r\n                      {/* Always show search input for consistency */}\r\n                      <FilterSearch\r\n                        options={options}\r\n                        selectedValues={currentValues}\r\n                        onChange={(vals) => handleAttrChange(attrKey, isSingleSelect ? vals.slice(-1) : vals)}\n                        placeholder={t('searchAttributePlaceholder', { attribute: attrName })}\r\n                        isSingleSelect={isSingleSelect}\r\n                      />\r\n                    </div>\r\n                  )\r\n                }\r\n\r\n                return null\r\n              })}\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Footer with Live Count CTA */}\r\n        <div className=\"shrink-0 px-6 py-4 border-t bg-background flex items-center justify-between\">\r\n          <button\r\n            type=\"button\"\r\n            onClick={clearAll}\r\n            disabled={!hasPendingFilters}\r\n            className={cn(\r\n              \"text-sm font-medium transition-colors px-4 py-2 rounded-lg\",\r\n              hasPendingFilters \n                ? \"text-destructive hover:bg-destructive-subtle\"\n                : \"text-muted-foreground cursor-not-allowed opacity-50\"\n            )}\n          >\n            {t('clearAllFilters')}\r\n          </button>\r\n          <Button \r\n            onClick={applyFilters} \r\n            size=\"lg\"\r\n            disabled={liveCount === 0 && hasPendingFilters}\r\n            className=\"px-8 rounded-full transition-colors min-w-40\"\r\n          >\r\n            {isCountLoading ? (\r\n              <span className=\"animate-pulse\">{tHub('showResults', { count: '...' })}</span>\r\n            ) : liveCount === 0 && hasPendingFilters ? (\r\n              tHub('noResults')\r\n            ) : (\r\n              tHub('showResults', { count: liveCount.toLocaleString() })\r\n            )}\r\n          </Button>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}// =============================================================================\r\n// Filter Search Component (for long option lists)\r\n// =============================================================================\r\n\r\nfunction FilterSearch({\r\n  options,\r\n  selectedValues,\r\n  onChange,\r\n  placeholder,\r\n  isSingleSelect\r\n}: {\r\n  options: string[]\r\n  selectedValues: string[]\r\n  onChange: (values: string[]) => void\r\n  placeholder: string\r\n  isSingleSelect: boolean\r\n}) {\r\n  const t = useTranslations('SearchFilters')\r\n  const [search, setSearch] = React.useState('')\r\n  const [isExpanded, setIsExpanded] = React.useState(false)\r\n\r\n  const filteredOptions = search\r\n    ? options.filter(opt => opt.toLowerCase().includes(search.toLowerCase()))\r\n    : options\r\n\r\n  const visibleOptions = isExpanded ? filteredOptions : filteredOptions.slice(0, 5)\r\n  const hasMore = filteredOptions.length > 5\r\n\r\n  return (\r\n    <div className=\"space-y-2.5\">\r\n      <div className=\"relative\">\r\n        <MagnifyingGlass className=\"absolute left-3 top-1/2 -translate-y-1/2 size-4 text-muted-foreground\" />\r\n        <Input\n          type=\"text\"\n          placeholder={placeholder}\n          value={search}\n          onChange={(e) => setSearch(e.target.value)}\n          className=\"pl-9 h-9 text-sm bg-surface-subtle border-input\"\n        />\n      </div>\n      <div className=\"space-y-1 max-h-(--spacing-scroll-sm) overflow-y-auto\">\n        {visibleOptions.map((option) => {\n          const isChecked = selectedValues.includes(option)\n          return (\r\n            <label\r\n              key={option}\r\n              className={cn(\n                \"flex items-center gap-2.5 py-2 px-2.5 rounded-lg cursor-pointer transition-colors\",\n                \"hover:bg-muted\",\n                isChecked && \"bg-selected hover:bg-hover\"\n              )}\n            >\n              {isSingleSelect ? (\r\n                <div\r\n                  onClick={() => onChange(isChecked ? [] : [option])}\r\n                  className={cn(\r\n                    \"size-4 rounded-full border-2 flex items-center justify-center cursor-pointer transition-colors\",\r\n                    isChecked ? \"border-primary bg-primary\" : \"border-border\"\r\n                  )}\r\n                >\r\n                  {isChecked && <div className=\"size-1.5 rounded-full bg-primary-foreground\" />}\r\n                </div>\r\n              ) : (\r\n                <Checkbox\r\n                  checked={isChecked}\r\n                  onCheckedChange={(checked) => {\r\n                    if (checked) {\r\n                      onChange([...selectedValues, option])\r\n                    } else {\r\n                      onChange(selectedValues.filter(v => v !== option))\r\n                    }\r\n                  }}\r\n                  className=\"size-4\"\r\n                />\r\n              )}\r\n              <span className=\"text-sm flex-1 truncate\">{option}</span>\r\n              {isChecked && <Check size={14} className=\"text-primary shrink-0\" />}\r\n            </label>\r\n          )\r\n        })}\r\n        {visibleOptions.length === 0 && (\r\n          <p className=\"text-sm text-muted-foreground py-3 text-center\">{t('noMatchesFound')}</p>\r\n        )}\r\n      </div>\r\n      {hasMore && !search && (\n        <button\n          type=\"button\"\n          onClick={() => setIsExpanded(!isExpanded)}\n          className=\"text-sm text-link hover:text-link-hover font-medium w-full text-center py-2 flex items-center justify-center gap-1.5 rounded-lg hover:bg-hover transition-colors\"\n        >\n          {isExpanded ? t('showLess') : t('showAllCount', { count: filteredOptions.length })}\n          <CaretDown size={14} className={cn(\"transition-transform\", isExpanded && \"rotate-180\")} />\n        </button>\n      )}\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\desktop-filter-toolbar.tsx","messages":[{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":126,"column":47,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":126,"endColumn":64},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 35 to the 25 allowed.","line":158,"column":41,"nodeType":null,"messageId":"refactorFunction","endLine":158,"endColumn":43}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { useMemo, useCallback } from \"react\"\r\nimport { useSearchParams } from \"next/navigation\"\r\nimport { usePathname, useRouter } from \"@/i18n/routing\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport type { CategoryAttribute } from \"@/lib/data/categories\"\nimport { Button } from \"@/components/ui/button\"\nimport { Badge } from \"@/components/ui/badge\"\nimport {\n  CaretDown,\n  SquaresFour,\n  Rows,\n  Check,\n  Package,\n  Star,\n  Percent,\n  Sliders,\n  DotsThree,\n} from \"@phosphor-icons/react\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport { ToggleGroup, ToggleGroupItem } from \"@/components/ui/toggle-group\"\r\nimport { SortSelect } from \"@/components/shared/search/sort-select\"\r\nimport { DesktopFilterModal } from \"@/components/desktop/desktop-filter-modal\"\r\nimport { getFilterPillsForCategory } from \"@/components/shared/filters/_lib/filter-priority\"\nimport { getCategoryAttributeKey } from \"@/lib/filters/category-attribute\"\r\n\r\n// =============================================================================\r\n// TYPES\r\n// =============================================================================\r\n\r\n/** Quick filter toggle IDs - URL query param based */\r\nexport type QuickFilterId = \"deals\" | \"nearby\" | \"top_rated\" | \"free_shipping\"\r\n\r\nexport interface DesktopFilterToolbarProps {\r\n  locale: string\r\n  /** Current product count to display */\r\n  productCount?: number\r\n  /** Category name for display */\r\n  categoryName?: string\r\n  /** Category slug for filter context */\r\n  categorySlug?: string\r\n  /** Category ID for filter queries */\r\n  categoryId?: string\r\n  /** Category attributes for dynamic filter dropdowns */\r\n  attributes?: CategoryAttribute[]\r\n  /** Optional additional class */\r\n  className?: string\r\n}\r\n\r\n// =============================================================================\r\n// QUICK FILTER (GENERIC) CONFIG - Now shown in overflow dropdown\r\n// =============================================================================\r\n\r\nconst QUICK_FILTERS: Array<{\r\n  id: QuickFilterId\r\n  labelKey: string\r\n  icon: typeof Percent\r\n  paramKey: string\r\n  paramValue: string\r\n}> = [\r\n  { id: \"deals\", labelKey: \"tabs.deals\", icon: Percent, paramKey: \"tag\", paramValue: \"deal\" },\r\n  { id: \"top_rated\", labelKey: \"tabs.top_rated\", icon: Star, paramKey: \"minRating\", paramValue: \"4\" },\r\n  { id: \"free_shipping\", labelKey: \"tabs.free_shipping\", icon: Package, paramKey: \"freeShipping\", paramValue: \"true\" },\r\n]\r\n\r\n// =============================================================================\r\n// PILL STYLING (treido-ui token-safe)\r\n// =============================================================================\r\n\r\nconst pillBase = cn(\n  \"h-11 px-4 gap-2 rounded-full\",\n  \"text-sm font-medium whitespace-nowrap\",\n  \"flex items-center justify-center\",\n  \"border transition-colors\",\n  \"focus-visible:ring-2 focus-visible:ring-focus-ring\"\n)\nconst pillInactive = cn(\n  \"border-border bg-muted text-muted-foreground\",\n  \"hover:bg-hover hover:text-foreground\"\n)\nconst pillActive = cn(\n  \"border-selected-border bg-selected text-primary\"\n)\n\r\n// =============================================================================\r\n// MAIN COMPONENT\r\n// =============================================================================\r\n\r\nexport function DesktopFilterToolbar({\r\n  locale,\r\n  productCount,\r\n  categoryName,\r\n  categorySlug,\r\n  categoryId,\r\n  attributes = [],\r\n  className,\r\n}: DesktopFilterToolbarProps) {\r\n  const router = useRouter()\r\n  const pathname = usePathname()\r\n  const searchParams = useSearchParams()\r\n  const t = useTranslations(\"TabbedProductFeed\")\r\n  const tFilters = useTranslations(\"SearchFilters\")\r\n  const tViewMode = useTranslations(\"ViewMode\")\r\n\r\n  // Current view mode from URL or default to grid\r\n  const viewMode = (searchParams.get(\"view\") as \"grid\" | \"list\") || \"grid\"\r\n\r\n  // Helper to update URL params\r\n  const updateParams = useCallback(\r\n    (updates: Record<string, string | null>) => {\r\n      const params = new URLSearchParams(searchParams.toString())\r\n      for (const [key, value] of Object.entries(updates)) {\r\n        if (value === null) params.delete(key)\r\n        else params.set(key, value)\r\n      }\r\n      const queryString = params.toString()\r\n      router.push(`${pathname}${queryString ? `?${queryString}` : \"\"}`)\r\n    },\r\n    [router, pathname, searchParams]\r\n  )\r\n\r\n  // Check which quick filters are active\r\n  const activeQuickFilters = useMemo(() => {\r\n    const active: QuickFilterId[] = []\r\n    for (const filter of QUICK_FILTERS) {\r\n      if (searchParams.get(filter.paramKey) === filter.paramValue) {\r\n        active.push(filter.id)\r\n      }\r\n    }\r\n    return active\r\n  }, [searchParams])\r\n\r\n  // Toggle quick filter\r\n  const toggleQuickFilter = useCallback(\r\n    (filter: typeof QUICK_FILTERS[number]) => {\r\n      const isActive = searchParams.get(filter.paramKey) === filter.paramValue\r\n      updateParams({ [filter.paramKey]: isActive ? null : filter.paramValue })\r\n    },\r\n    [searchParams, updateParams]\r\n  )\r\n\r\n  // Get priority filters for this category (up to 4)\r\n  const priorityFilters = useMemo(\n    () => getFilterPillsForCategory(categorySlug, attributes),\n    [categorySlug, attributes]\n  )\n\r\n  // Build attribute dropdowns - show ALL filterable attributes with options, ordered by priority\r\n  const attributeDropdowns = useMemo(() => {\r\n    if (!attributes.length) return []\r\n\r\n    const result: Array<{\r\n      key: string\r\n      label: string\r\n      paramKey: string\r\n      options: Array<{ value: string; label: string }>\r\n    }> = []\r\n    \r\n    const usedKeys = new Set<string>()\r\n\r\n    // First: add priority filters that exist in attributes\r\n    for (const filterKey of priorityFilters) {\r\n      if (filterKey === \"price\" || filterKey === \"category\") continue\r\n\r\n      const attr = attributes.find(\r\n        (a) => getCategoryAttributeKey(a).toLowerCase() === filterKey.toLowerCase()\r\n      )\r\n      if (attr) {\r\n        const attrKey = getCategoryAttributeKey(attr)\r\n        if (usedKeys.has(attrKey)) continue\r\n        \r\n        const options = (locale === \"bg\" && attr.options_bg?.length ? attr.options_bg : attr.options || [])\r\n          .slice(0, 10)\r\n          .map((opt) => ({ value: opt, label: opt }))\r\n\r\n        if (options.length > 0) {\r\n          usedKeys.add(attrKey)\r\n          result.push({\r\n            key: attrKey,\r\n            label: locale === \"bg\" && attr.name_bg ? attr.name_bg : attr.name,\r\n            paramKey: `attr_${attrKey}`,\r\n            options,\r\n          })\r\n        }\r\n      }\r\n    }\r\n    \r\n    // Then: add remaining filterable attributes with options (up to 6 total pills)\r\n    for (const attr of attributes) {\r\n      if (result.length >= 6) break\r\n      \r\n      const attrKey = getCategoryAttributeKey(attr)\r\n      if (usedKeys.has(attrKey)) continue\r\n      \r\n      const options = (locale === \"bg\" && attr.options_bg?.length ? attr.options_bg : attr.options || [])\r\n        .slice(0, 10)\r\n        .map((opt) => ({ value: opt, label: opt }))\r\n\r\n      if (options.length > 0) {\r\n        usedKeys.add(attrKey)\r\n        result.push({\r\n          key: attrKey,\r\n          label: locale === \"bg\" && attr.name_bg ? attr.name_bg : attr.name,\r\n          paramKey: `attr_${attrKey}`,\r\n          options,\r\n        })\r\n      }\r\n    }\r\n\r\n    return result.slice(0, 6) // Max 6 attribute pills\r\n  }, [attributes, priorityFilters, locale])\r\n\r\n  // Count active attribute filters\r\n  const activeAttributeCount = useMemo(() => {\r\n    let count = 0\r\n    for (const key of searchParams.keys()) {\r\n      if (key.startsWith(\"attr_\")) count++\r\n    }\r\n    // Also count price/rating\r\n    if (searchParams.get(\"minPrice\") || searchParams.get(\"maxPrice\")) count++\r\n    if (searchParams.get(\"minRating\")) count++\r\n    return count\r\n  }, [searchParams])\r\n\r\n  // Total active filter count for badge\n  const totalActiveFilters = activeQuickFilters.length + activeAttributeCount\n  const overflowCount =\n    activeQuickFilters.length > 0 ? activeQuickFilters.length : QUICK_FILTERS.length\n\n  return (\n    <div\n      className={cn(\n        \"flex items-center gap-3 mb-4 pb-3 border-b border-border\",\r\n        className\r\n      )}\r\n    >\r\n      {/* LEFT: Sort dropdown */}\r\n      <div className=\"shrink-0\">\r\n        <SortSelect />\r\n      </div>\r\n\r\n      {/* Product count */}\r\n      {typeof productCount === \"number\" && (\r\n        <>\r\n          <div className=\"h-5 w-px bg-border shrink-0\" />\r\n          <p className=\"text-sm text-muted-foreground whitespace-nowrap shrink-0\">\r\n            <span className=\"font-semibold text-foreground\">{productCount.toLocaleString(locale)}</span>\r\n            {\" \"}{tFilters(\"results\")}\r\n            {categoryName && (\r\n              <>\r\n                {\" \"}{tFilters(\"in\")}{\" \"}\r\n                <span className=\"font-medium text-foreground\">{categoryName}</span>\r\n              </>\r\n            )}\r\n          </p>\r\n        </>\r\n      )}\r\n\r\n      {/* CENTER: Category-specific attribute filters FIRST (Size, Brand, Color, etc.) */}\r\n      <div className=\"flex items-center gap-1.5 overflow-x-auto no-scrollbar ml-auto\">\r\n        {/* Category attribute dropdowns - shown FIRST for better UX */}\r\n        {attributeDropdowns.map((dropdown) => {\r\n          const selectedValue = searchParams.get(dropdown.paramKey)\r\n          const hasValue = Boolean(selectedValue)\r\n\r\n          return (\r\n            <DropdownMenu key={dropdown.key}>\r\n              <DropdownMenuTrigger asChild>\r\n            <Button\n              variant=\"ghost\"\n              size=\"default\"\n              className={cn(pillBase, hasValue ? pillActive : pillInactive)}\n            >\n                  <span className=\"max-w-20 truncate\">\r\n                    {hasValue ? selectedValue : dropdown.label}\r\n                  </span>\r\n                  <CaretDown className=\"size-3 opacity-50 shrink-0\" />\r\n                </Button>\r\n              </DropdownMenuTrigger>\r\n              <DropdownMenuContent align=\"start\" className=\"min-w-36 max-h-64 overflow-y-auto\">\r\n                {dropdown.options.map((opt) => {\r\n                  const isSelected = selectedValue === opt.value\r\n                  return (\r\n                    <DropdownMenuItem\r\n                      key={opt.value}\r\n                      onClick={() => {\r\n                        updateParams({\r\n                          [dropdown.paramKey]: isSelected ? null : opt.value,\r\n                        })\r\n                      }}\r\n                      className={cn(isSelected && \"bg-accent\")}\r\n                    >\r\n                      <span className=\"flex-1\">{opt.label}</span>\r\n                      {isSelected && <Check className=\"size-4 text-primary\" />}\r\n                    </DropdownMenuItem>\r\n                  )\r\n                })}\r\n                {hasValue && (\r\n                  <>\r\n                    <DropdownMenuSeparator />\r\n                    <DropdownMenuItem\r\n                      onClick={() => updateParams({ [dropdown.paramKey]: null })}\r\n                      variant=\"destructive\"\r\n                    >\r\n                      {tFilters(\"clear\")}\r\n                    </DropdownMenuItem>\r\n                  </>\r\n                )}\r\n              </DropdownMenuContent>\r\n            </DropdownMenu>\r\n          )\r\n        })}\r\n\r\n        {/* All Filters button - opens modal for all filters */}\r\n        {attributes.length > 0 && categorySlug && (\n          <DesktopFilterModal\n            attributes={attributes}\n            categorySlug={categorySlug}\n            categoryId={categoryId}\n            trigger={\n              <Button\n                variant=\"ghost\"\n                size=\"default\"\n                className={cn(pillBase, totalActiveFilters > 0 ? pillActive : pillInactive)}\n              >\n                <Sliders size={14} weight=\"regular\" className=\"shrink-0\" />\n                <span>{tFilters(\"filters\")}</span>\n                {totalActiveFilters > 0 && (\n                  <Badge variant=\"default\" className=\"h-4 min-w-4 px-1 text-2xs rounded-full\">\n                    {totalActiveFilters}\n                  </Badge>\n                )}\n              </Button>\n            }\n          />\n        )}\n\n        {/* Generic quick filters in overflow dropdown (Deals, Top Rated, Free Shipping) */}\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"default\"\n              className={cn(pillBase, activeQuickFilters.length > 0 ? pillActive : pillInactive)}\n            >\n              <DotsThree size={14} weight=\"bold\" className=\"shrink-0\" />\n              <span>{t(\"tabs.moreFilters\", { count: overflowCount })}</span>\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"end\" className=\"min-w-44\">\r\n            {QUICK_FILTERS.map((filter) => {\r\n              const Icon = filter.icon\r\n              const isActive = activeQuickFilters.includes(filter.id)\r\n              return (\r\n                <DropdownMenuItem\r\n                  key={filter.id}\r\n                  onClick={() => toggleQuickFilter(filter)}\r\n                  className={cn(isActive && \"bg-accent\")}\r\n                >\r\n                  <Icon size={16} weight={isActive ? \"fill\" : \"regular\"} className=\"shrink-0 mr-2\" />\r\n                  <span className=\"flex-1\">{t(filter.labelKey)}</span>\r\n                  {isActive && <Check className=\"size-4 text-primary\" />}\r\n                </DropdownMenuItem>\r\n              )\r\n            })}\r\n          </DropdownMenuContent>\r\n        </DropdownMenu>\r\n      </div>\r\n\r\n      {/* RIGHT: View toggle */}\r\n      <div className=\"h-5 w-px bg-border shrink-0\" />\n      <ToggleGroup\n        type=\"single\"\n        value={viewMode}\n        onValueChange={(value) => value && updateParams({ view: value })}\n        className=\"h-11 bg-muted p-0 rounded-full shrink-0 border border-border\"\n      >\n        <ToggleGroupItem\n          value=\"grid\"\n          aria-label={tViewMode(\"gridView\")}\n          className=\"size-11 p-0 rounded-full data-[state=on]:bg-background\"\n        >\n          <SquaresFour size={16} weight={viewMode === \"grid\" ? \"fill\" : \"regular\"} />\n        </ToggleGroupItem>\n        <ToggleGroupItem\n          value=\"list\"\n          aria-label={tViewMode(\"listView\")}\n          className=\"size-11 p-0 rounded-full data-[state=on]:bg-background\"\n        >\n          <Rows size={16} weight={viewMode === \"list\" ? \"fill\" : \"regular\"} />\n        </ToggleGroupItem>\n      </ToggleGroup>\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\desktop-home.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is defined but never used.","line":102,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":102,"endColumn":7},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `SetStateAction<boolean>`.","line":286,"column":20,"nodeType":"LogicalExpression","messageId":"unsafeArgument","endLine":286,"endColumn":64},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'activeCategorySlug', 'activeTab', 'fetchProducts', 'filters.quickFilters', and 'userCity'. Either include them or remove the dependency array.","line":303,"column":6,"nodeType":"ArrayExpression","endLine":303,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [activeCategorySlug, activeTab, fetchProducts, filters.quickFilters, userCity]","fix":{"range":[11858,11860],"text":"[activeCategorySlug, activeTab, fetchProducts, filters.quickFilters, userCity]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_cat' is defined but never used.","line":327,"column":67,"nodeType":"Identifier","messageId":"unusedVar","endLine":327,"endColumn":71}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\n/**\r\n * Desktop Home\r\n * \r\n * The desktop homepage layout with unified header + content approach where:\r\n * - Logo and user actions stay in a slim top bar\r\n * - Search is integrated INTO the content area (inline with sidebar + grid)\r\n * - Categories sidebar and product grid share a container\r\n * - The whole thing feels like one cohesive surface, not header + body\r\n * \r\n * Design principles:\r\n * - Header is minimal - just logo + user actions\r\n * - Search lives WHERE the content is (contextual, not global)\r\n * - Lighter background (muted/30) for the container vs white cards\r\n * - Grid borders create visual rhythm without heavy separation\r\n */\r\n\r\nimport * as React from \"react\"\nimport { useState, useCallback, useMemo, useRef, useEffect } from \"react\"\n\nimport { useTranslations } from \"next-intl\"\nimport { Button } from \"@/components/ui/button\"\nimport { EmptyStateCTA } from \"@/components/shared/empty-state-cta\"\nimport { useCategoryCounts } from \"@/hooks/use-category-counts\"\nimport { useCategoryAttributes } from \"@/hooks/use-category-attributes\"\nimport { useViewMode } from \"@/hooks/use-view-mode\"\nimport type { CategoryTreeNode } from \"@/lib/category-tree\"\r\nimport { getCategoryName, type CategoryDisplay } from \"@/lib/category-display\"\r\n// Extracted components\r\nimport { FeedToolbar, type FeedTab, type FilterState } from \"@/components/desktop/feed-toolbar\"\r\nimport { CompactCategorySidebar, type CategoryPath } from \"@/components/desktop/category-sidebar\"\r\nimport { FiltersSidebar } from \"@/components/desktop/filters-sidebar\"\r\nimport { ProductGridSkeleton } from \"@/components/shared/product/product-grid-skeleton\"\r\nimport { PromotedSection } from \"@/components/desktop/promoted-section\"\r\nimport { DesktopShell, DesktopShellSkeleton } from \"@/components/layout/desktop-shell\"\r\nimport { ProductGrid, type ProductGridProduct } from \"@/components/grid\"\r\nimport { SubcategoryCircles } from \"@/components/category/subcategory-circles\"\r\nimport type { UIProduct } from \"@/lib/data/products\"\r\n\r\nimport type { User } from \"@supabase/supabase-js\"\r\n\r\n// =============================================================================\r\n// TYPES\r\n// =============================================================================\r\n\r\ninterface Product {\r\n  id: string\r\n  title: string\r\n  price: number\r\n  listPrice?: number\r\n  isOnSale?: boolean\r\n  salePercent?: number\r\n  saleEndDate?: string | null\r\n  createdAt?: string | null\r\n  image: string\r\n  rating?: number\r\n  reviews?: number\r\n  slug?: string | null\r\n  storeSlug?: string | null\r\n  sellerId?: string | null\r\n  sellerName?: string | null\r\n  sellerAvatarUrl?: string | null\r\n  sellerVerified?: boolean\r\n  location?: string\r\n  condition?: string\r\n  isBoosted?: boolean\r\n  boostExpiresAt?: string | null\r\n  tags?: string[]\r\n  // Category & attributes for contextual display\r\n  categoryRootSlug?: string\r\n  categoryPath?: { slug: string; name: string; nameBg?: string | null; icon?: string | null }[]\r\n  attributes?: Record<string, unknown>\r\n}\r\n\r\ninterface CuratedSections {\r\n  deals: UIProduct[]\r\n  fashion: UIProduct[]\r\n  electronics: UIProduct[]\r\n  automotive: UIProduct[]\r\n}\r\n\r\ninterface DesktopHomeProps {\r\n  locale: string\r\n  categories: CategoryTreeNode[]\r\n  initialProducts?: Product[]\r\n  promotedProducts?: Product[]\r\n  curatedSections?: CuratedSections\r\n  user?: User | null\r\n}\r\n\r\n// =============================================================================\r\n// MAIN COMPONENT\r\n// =============================================================================\r\n\r\nexport function DesktopHome({\n  locale,\n  categories,\n  initialProducts = [],\n  promotedProducts = [],\n  // curatedSections not used on desktop - category discovery via sidebar\n  user,\n}: DesktopHomeProps) {\n  const t = useTranslations(\"TabbedProductFeed\")\n\n  // State\n  const [activeTab, setActiveTab] = useState<FeedTab>(\"newest\")\n  const [categoryPath, setCategoryPath] = useState<CategoryPath[]>([])\n  const [products, setProducts] = useState<Product[]>(initialProducts)\n  const [isLoading, setIsLoading] = useState(false)\r\n  const [page, setPage] = useState(1)\r\n  const [hasMore, setHasMore] = useState(true)\r\n  const [filters, setFilters] = useState<FilterState>({\r\n    priceMin: \"\",\r\n    priceMax: \"\",\r\n    condition: null,\r\n    attributes: {},\r\n    quickFilters: [],\r\n  })\r\n  const [viewMode, setViewMode] = useViewMode(\"grid\")\r\n  \r\n  // User's city for nearby filtering (persisted in localStorage)\r\n  const [userCity, setUserCity] = useState<string>(\"sofia\")\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const savedCity = localStorage.getItem(\"treido_user_city\")\r\n      if (savedCity) setUserCity(savedCity)\r\n    } catch {\r\n      // Ignore storage access errors\r\n    }\r\n  }, [])\r\n  \r\n  const handleCityChange = useCallback((city: string) => {\r\n    setUserCity(city)\r\n    if (typeof window !== \"undefined\") {\r\n      localStorage.setItem(\"treido_user_city\", city)\r\n    }\r\n  }, [])\r\n\r\n  const { counts: categoryCounts } = useCategoryCounts()\r\n  const pageSize = 24\r\n\r\n  const activeCategorySlug = useMemo(() => {\r\n    if (categoryPath.length > 0) return categoryPath[categoryPath.length - 1]?.slug ?? null\r\n    return null\r\n  }, [categoryPath])\r\n\r\n  const activeCategoryNode = useMemo(() => {\r\n    if (categoryPath.length === 0) return null\r\n\r\n    let nodes = categories\r\n    let current: CategoryTreeNode | undefined\r\n\r\n    for (const step of categoryPath) {\r\n      current = nodes.find((c) => c.slug === step.slug)\r\n      if (!current) return null\r\n      nodes = current.children ?? []\r\n    }\r\n\r\n    return current ?? null\r\n  }, [categories, categoryPath])\r\n\r\n  // Compute sibling categories for leaf-level navigation\r\n  // Siblings are other children of the same parent (for when we're at a leaf with no children)\r\n  const siblingCategories = useMemo(() => {\r\n    if (categoryPath.length === 0) return []\r\n    if (!activeCategoryNode) return []\r\n    // Only compute siblings if active node has no children (leaf level)\r\n    if (activeCategoryNode.children && activeCategoryNode.children.length > 0) return []\r\n    \r\n    // Find the parent node by traversing path up to second-to-last\r\n    if (categoryPath.length === 1) {\r\n      // Parent is root - siblings are root categories\r\n      return categories\r\n    }\r\n    \r\n    // Navigate to parent node\r\n    let nodes = categories\r\n    let parentNode: CategoryTreeNode | undefined\r\n    \r\n    for (let i = 0; i < categoryPath.length - 1; i++) {\r\n      const step = categoryPath[i]\r\n      if (!step) continue\r\n      const found = nodes.find((c) => c.slug === step.slug)\r\n      if (!found) return []\r\n      parentNode = found\r\n      nodes = found.children ?? []\r\n    }\r\n    \r\n    // Siblings are all children of parent (including current)\r\n    return parentNode?.children ?? []\r\n  }, [categories, categoryPath, activeCategoryNode])\r\n\r\n  const { attributes: categoryAttributes, isLoading: isLoadingAttributes } = useCategoryAttributes(activeCategorySlug)\r\n\r\n  // Clear attribute filters when category changes\r\n  useEffect(() => {\r\n    setFilters(prev => ({ ...prev, attributes: {} }))\r\n  }, [activeCategorySlug])\r\n\r\n  const handleSubcategorySelect = useCallback(\r\n    (category: CategoryDisplay) => {\r\n      setCategoryPath((prev) => {\r\n        const lastSlug = prev[prev.length - 1]?.slug\r\n        if (lastSlug === category.slug) return prev\r\n        return [...prev, { slug: category.slug, name: getCategoryName(category, locale) }]\r\n      })\r\n      setPage(1)\r\n    },\r\n    [locale]\r\n  )\r\n\r\n  // Handle sibling category selection (replaces current level, not appends)\r\n  const handleSiblingSelect = useCallback(\r\n    (category: CategoryDisplay) => {\r\n      setCategoryPath((prev) => {\r\n        if (prev.length === 0) return prev\r\n        const lastSlug = prev[prev.length - 1]?.slug\r\n        if (lastSlug === category.slug) return prev\r\n        // Replace the last element with the new sibling\r\n        const newPath = prev.slice(0, -1)\r\n        return [...newPath, { slug: category.slug, name: getCategoryName(category, locale) }]\r\n      })\r\n      setPage(1)\r\n    },\r\n    [locale]\r\n  )\r\n\r\n  // Fetch products\r\n  const fetchProducts = useCallback(\r\n    async (tab: FeedTab, pageNum: number, limit: number, append = false, catSlug?: string | null, city?: string | null, quickFilters: string[] = []) => {\r\n      setIsLoading(true)\r\n      try {\r\n        const params = new URLSearchParams({\r\n          sort: tab,\r\n          page: String(pageNum),\r\n          limit: String(limit),\r\n        })\r\n        if (catSlug) params.set(\"category\", catSlug)\r\n        // Pass city for nearby filter\r\n        if (quickFilters.includes(\"nearby\") && city) params.set(\"city\", city)\r\n        // Pass quick filters\r\n        if (quickFilters.length > 0) params.set(\"filters\", quickFilters.join(\",\"))\r\n\r\n        const res = await fetch(`/api/products/feed?${params.toString()}`)\r\n        if (!res.ok) return\r\n\r\n        const data = await res.json()\r\n        if (!Array.isArray(data.products)) return\r\n\r\n        const transformed: Product[] = data.products.map((p: Record<string, unknown>) => ({\r\n          id: p.id as string,\r\n          title: p.title as string,\r\n          price: typeof p.price === \"number\" ? p.price : Number(p.price ?? 0),\r\n          image: (p.image as string) ?? (Array.isArray(p.images) ? (p.images as string[])[0] : \"/placeholder.svg\") ?? \"/placeholder.svg\",\r\n          slug: (p.slug as string | null) ?? null,\r\n          storeSlug: (p.storeSlug as string | null) ?? (p.store_slug as string | null) ?? null,\r\n          sellerId: typeof p.sellerId === \"string\" ? p.sellerId : null,\r\n          sellerName: typeof p.sellerName === \"string\" ? p.sellerName : null,\r\n          sellerAvatarUrl: typeof p.sellerAvatarUrl === \"string\" ? p.sellerAvatarUrl : null,\r\n          sellerVerified: Boolean(p.sellerVerified),\r\n          isBoosted: Boolean(p.isBoosted || p.is_boosted),\r\n          listPrice: typeof p.listPrice === \"number\" ? p.listPrice : typeof p.list_price === \"number\" ? p.list_price : undefined,\r\n          rating: typeof p.rating === \"number\" ? p.rating : undefined,\r\n          reviews: typeof p.reviews === \"number\" ? p.reviews : undefined,\r\n          createdAt: typeof p.createdAt === \"string\" ? p.createdAt : typeof p.created_at === \"string\" ? p.created_at : null,\r\n          tags: Array.isArray(p.tags) ? (p.tags as string[]) : [],\r\n          // Category-aware data for contextual smart badges\r\n          categoryRootSlug: typeof p.categoryRootSlug === \"string\" ? p.categoryRootSlug : undefined,\r\n          categoryPath: Array.isArray(p.categoryPath) ? p.categoryPath as { slug: string; name: string; nameBg?: string | null }[] : undefined,\r\n          attributes: (p.attributes && typeof p.attributes === \"object\" && !Array.isArray(p.attributes)) ? p.attributes as Record<string, unknown> : undefined,\r\n          // Extra fields for product display\r\n          location: typeof p.location === \"string\" ? p.location : undefined,\r\n          condition: typeof p.condition === \"string\" ? p.condition : undefined,\r\n          isOnSale: Boolean(p.isOnSale),\r\n          salePercent: typeof p.salePercent === \"number\" ? p.salePercent : undefined,\r\n          saleEndDate: typeof p.saleEndDate === \"string\" ? p.saleEndDate : null,\r\n        }))\r\n\r\n        if (append) {\r\n          setProducts((prev) => [...prev, ...transformed])\r\n        } else {\r\n          setProducts(transformed)\r\n        }\r\n        setHasMore(data.hasMore ?? transformed.length === limit)\r\n      } catch {\r\n        // Silent\r\n      } finally {\r\n        setIsLoading(false)\r\n      }\r\n    },\r\n    []\r\n  )\r\n\r\n  // Initial fetch\r\n  const initialFetchDone = useRef(initialProducts.length > 0)\r\n  useEffect(() => {\r\n    if (!initialFetchDone.current) {\r\n      initialFetchDone.current = true\r\n      fetchProducts(activeTab, 1, pageSize, false, activeCategorySlug, userCity, filters.quickFilters)\r\n    }\r\n  }, [])\r\n\r\n  // Fetch on tab/category/city/filters change\r\n  const prevTab = useRef(activeTab)\r\n  const prevCat = useRef<string | null>(null)\r\n  const prevCity = useRef<string | null>(userCity)\r\n  const prevQuickFilters = useRef<string[]>([])\r\n  useEffect(() => {\r\n    const tabChanged = prevTab.current !== activeTab\r\n    const catChanged = prevCat.current !== activeCategorySlug\r\n    const nearbyActive = filters.quickFilters?.includes(\"nearby\") ?? false\r\n    const cityChanged = nearbyActive && prevCity.current !== userCity\r\n    const quickFiltersChanged = JSON.stringify(prevQuickFilters.current) !== JSON.stringify(filters.quickFilters)\r\n    prevTab.current = activeTab\r\n    prevCat.current = activeCategorySlug\r\n    prevCity.current = userCity\r\n    prevQuickFilters.current = filters.quickFilters ?? []\r\n\r\n    if (tabChanged || catChanged || cityChanged || quickFiltersChanged) {\r\n      setPage(1)\r\n      fetchProducts(activeTab, 1, pageSize, false, activeCategorySlug, userCity, filters.quickFilters)\r\n    }\r\n  }, [activeTab, activeCategorySlug, userCity, filters.quickFilters, fetchProducts])\r\n\r\n  const handleCategorySelect = useCallback((path: CategoryPath[], _cat: CategoryTreeNode | null) => {\n    // Keep category browsing on the desktop landing page (no route change).\n    // This preserves the \"circles + feed\" UX and hides promoted content when filtered.\n    setCategoryPath(path)\n  }, [])\n\r\n  const loadMore = () => {\r\n    if (!isLoading && hasMore) {\r\n      const next = page + 1\r\n      setPage(next)\r\n      fetchProducts(activeTab, next, pageSize, true, activeCategorySlug, userCity, filters.quickFilters)\r\n    }\r\n  }\r\n\r\n  // Convert products to ProductGridProduct format\r\n  const gridProducts: ProductGridProduct[] = products.map((product) => ({\r\n    id: product.id,\r\n    title: product.title,\r\n    price: product.price,\r\n    image: product.image,\r\n    listPrice: product.listPrice,\r\n    isOnSale: product.isOnSale,\r\n    salePercent: product.salePercent,\r\n    saleEndDate: product.saleEndDate,\r\n    createdAt: product.createdAt,\r\n    slug: product.slug,\r\n    storeSlug: product.storeSlug,\r\n    sellerId: product.sellerId,\r\n    sellerName: product.sellerName,\r\n    sellerAvatarUrl: product.sellerAvatarUrl,\r\n    sellerVerified: product.sellerVerified,\r\n    location: product.location,\r\n    condition: product.condition,\r\n    isBoosted: product.isBoosted,\r\n    rating: product.rating,\r\n    reviews: product.reviews,\r\n    tags: product.tags,\r\n    categoryRootSlug: product.categoryRootSlug,\r\n    categoryPath: product.categoryPath,\r\n    attributes: product.attributes,\r\n  }))\r\n\r\n  const activePromotedProducts = useMemo(() => {\r\n    const now = Date.now()\r\n    return promotedProducts.filter((p) => {\r\n      if (!p.isBoosted) return false\r\n      if (!p.boostExpiresAt) return false\r\n      const expiresAt = Date.parse(p.boostExpiresAt)\r\n      return Number.isFinite(expiresAt) && expiresAt > now\r\n    })\r\n  }, [promotedProducts])\r\n\r\n  // ALWAYS merge promoted products into the grid (unified container design)\r\n  // Promoted products appear first with promo badge, regular products follow\r\n  const finalGridProducts: ProductGridProduct[] = useMemo(() => {\r\n    if (activePromotedProducts.length > 0) {\r\n      // Inject promoted products at the start of the grid\r\n      const promotedGridProducts: ProductGridProduct[] = activePromotedProducts.map((p) => ({\r\n        id: p.id,\r\n        title: p.title,\r\n        price: p.price,\r\n        image: p.image,\r\n        listPrice: p.listPrice,\r\n        isOnSale: p.isOnSale,\r\n        salePercent: p.salePercent,\r\n        saleEndDate: p.saleEndDate,\r\n        createdAt: p.createdAt,\r\n        slug: p.slug,\r\n        storeSlug: p.storeSlug,\r\n        sellerId: p.sellerId,\r\n        sellerName: p.sellerName,\r\n        sellerAvatarUrl: p.sellerAvatarUrl,\r\n        sellerVerified: p.sellerVerified,\r\n        location: p.location,\r\n        condition: p.condition,\r\n        isBoosted: true, // Mark as promoted for badge display\r\n        rating: p.rating,\r\n        reviews: p.reviews,\r\n        tags: p.tags,\r\n        categoryRootSlug: p.categoryRootSlug,\r\n        categoryPath: p.categoryPath,\r\n        attributes: p.attributes,\r\n      }))\r\n      // Remove duplicates (in case a promoted product is also in regular products)\r\n      const regularFiltered = gridProducts.filter(\r\n        (p) => !promotedGridProducts.some((promo) => promo.id === p.id)\r\n      )\r\n      return [...promotedGridProducts, ...regularFiltered]\r\n    }\r\n    return gridProducts\r\n  }, [activePromotedProducts, gridProducts])\r\n\r\n  // Sidebar content\r\n  const sidebarContent = (\r\n    <>\r\n      <CompactCategorySidebar\r\n        categories={categories}\r\n        locale={locale}\r\n        selectedPath={categoryPath}\r\n        onCategorySelect={handleCategorySelect}\r\n        categoryCounts={categoryCounts}\r\n      />\r\n      {categoryPath.length > 0 && (\r\n        <FiltersSidebar\r\n          locale={locale}\r\n          filters={filters}\r\n          onFiltersChange={setFilters}\r\n          onApply={() => fetchProducts(activeTab, 1, pageSize, false, activeCategorySlug, userCity)}\r\n        />\r\n      )}\r\n    </>\r\n  )\r\n\r\n  return (\r\n    <DesktopShell\r\n      variant=\"muted\"\r\n      sidebar={sidebarContent}\r\n      sidebarSticky\r\n    >\r\n      {/* CATEGORY HEADER + CIRCLES: Always on top when category selected */}\r\n      {activeCategoryNode && (\r\n        <div className=\"rounded-xl bg-card border border-border p-4 mb-4\">\r\n          <div className=\"flex items-start justify-between gap-3\">\r\n            <div className=\"min-w-0\">\r\n              <h2 className=\"text-lg font-semibold text-foreground leading-tight\">\r\n                {getCategoryName(activeCategoryNode, locale)}\r\n              </h2>\r\n              <p className=\"text-sm text-muted-foreground\">\r\n                {finalGridProducts.length.toLocaleString(locale)}{\" \"}\r\n                {t(\"sectionAriaLabel\").toLocaleLowerCase(locale)}\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Show subcategories if available, otherwise show siblings for navigation */}\r\n          {Array.isArray(activeCategoryNode.children) && activeCategoryNode.children.length > 0 ? (\r\n            <SubcategoryCircles\r\n              className=\"mt-3\"\r\n              variant=\"desktop\"\r\n              currentCategory={{\r\n                id: activeCategoryNode.id,\r\n                name: activeCategoryNode.name,\r\n                name_bg: activeCategoryNode.name_bg,\r\n                slug: activeCategoryNode.slug,\r\n                parent_id: activeCategoryNode.parent_id ?? null,\r\n                image_url: activeCategoryNode.image_url ?? null,\r\n                ...(typeof categoryCounts[activeCategoryNode.slug] === \"number\"\r\n                  ? { subtree_product_count: categoryCounts[activeCategoryNode.slug] }\r\n                  : {}),\r\n              }}\r\n              subcategories={activeCategoryNode.children.map((c) => ({\r\n                id: c.id,\r\n                name: c.name,\r\n                name_bg: c.name_bg,\r\n                slug: c.slug,\r\n                parent_id: c.parent_id ?? activeCategoryNode.id ?? null,\r\n                image_url: c.image_url ?? null,\r\n                ...(typeof categoryCounts[c.slug] === \"number\" ? { subtree_product_count: categoryCounts[c.slug] } : {}),\r\n              }))}\r\n              onSelectCategory={handleSubcategorySelect}\r\n            />\r\n          ) : siblingCategories.length > 0 ? (\r\n            // At leaf level - show sibling categories for navigation\r\n            <SubcategoryCircles\r\n              className=\"mt-3\"\r\n              variant=\"desktop\"\r\n              currentCategory={{\r\n                id: activeCategoryNode.id,\r\n                name: activeCategoryNode.name,\r\n                name_bg: activeCategoryNode.name_bg,\r\n                slug: activeCategoryNode.slug,\r\n                parent_id: activeCategoryNode.parent_id ?? null,\r\n                image_url: activeCategoryNode.image_url ?? null,\r\n                ...(typeof categoryCounts[activeCategoryNode.slug] === \"number\"\r\n                  ? { subtree_product_count: categoryCounts[activeCategoryNode.slug] }\r\n                  : {}),\r\n              }}\r\n              subcategories={siblingCategories.map((c) => ({\r\n                id: c.id,\r\n                name: c.name,\r\n                name_bg: c.name_bg,\r\n                slug: c.slug,\r\n                parent_id: c.parent_id ?? null,\r\n                image_url: c.image_url ?? null,\r\n                ...(typeof categoryCounts[c.slug] === \"number\" ? { subtree_product_count: categoryCounts[c.slug] } : {}),\r\n              }))}\r\n              activeSubcategorySlug={activeCategoryNode.slug}\r\n              onSelectCategory={handleSiblingSelect}\r\n            />\r\n          ) : null}\r\n        </div>\r\n      )}\r\n\r\n      {/* PROMOTED SECTION: Only on homepage \"All\" view - standalone section on top */}\r\n      {!activeCategorySlug && activePromotedProducts.length > 0 && (\r\n        <PromotedSection \r\n          products={activePromotedProducts} \r\n          locale={locale}\r\n          maxProducts={5}\r\n        />\r\n      )}\r\n\r\n      {/* Feed toolbar: count + category pills (left) | sort + view toggle (right) */}\r\n      <FeedToolbar\r\n        locale={locale}\r\n        productCount={products.length}\r\n        showCount={categoryPath.length === 0}\r\n        activeTab={activeTab}\r\n        onTabChange={setActiveTab}\r\n        viewMode={viewMode}\r\n        onViewModeChange={setViewMode}\r\n        categorySlug={activeCategorySlug}\r\n        userCity={userCity}\r\n        onCityChange={handleCityChange}\r\n        filters={filters}\r\n        onFiltersChange={setFilters}\r\n        categoryAttributes={categoryAttributes}\r\n        isLoadingAttributes={isLoadingAttributes}\r\n      />\r\n\r\n      {/* Product Grid */}\r\n      <div className=\"rounded-xl bg-card border border-border p-4\">\r\n        {finalGridProducts.length === 0 && isLoading ? (\r\n          <ProductGridSkeleton viewMode={viewMode} />\r\n        ) : finalGridProducts.length === 0 ? (\r\n          <EmptyStateCTA\r\n            variant={activeCategorySlug ? \"no-category\" : \"no-listings\"}\r\n            {...(activeCategorySlug ? { categoryName: activeCategorySlug } : {})}\r\n          />\r\n        ) : (\r\n          <>\r\n            <ProductGrid\r\n              products={finalGridProducts}\r\n              viewMode={viewMode}\r\n            />\r\n\r\n            {hasMore && (\r\n              <div className=\"mt-8 text-center\">\r\n                <Button onClick={loadMore} disabled={isLoading} size=\"lg\" className=\"min-w-36\">\r\n                  {isLoading ? (\r\n                    <span className=\"flex items-center gap-2\">\r\n                      <span className=\"size-4 border-2 border-current border-t-transparent rounded-full animate-spin\" />\r\n                      {t(\"loading\")}\r\n                    </span>\r\n                  ) : (\r\n                    t(\"loadMore\")\r\n                  )}\r\n                </Button>\r\n              </div>\r\n            )}\r\n          </>\r\n        )}\r\n      </div>\r\n    </DesktopShell>\r\n  )\r\n}\r\n\r\nexport function DesktopHomeSkeleton() {\r\n  return <DesktopShellSkeleton showSidebar sidebarItems={15} contentRows={16} />\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\desktop-search.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'cn' is defined but never used.","line":12,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":12,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"cn"},"fix":{"range":[518,550],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\nimport { useRef, useCallback, useEffect } from \"react\"\nimport Image from \"next/image\"\r\nimport { MagnifyingGlass, Clock, TrendUp, Package, X, ArrowRight, Eye, Robot } from \"@phosphor-icons/react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Switch } from \"@/components/ui/switch\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { FieldLabel } from \"@/components/shared/field\"\r\nimport { SearchAiChat } from \"@/components/shared/search/search-ai-chat\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport {\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverAnchor,\r\n} from \"@/components/ui/popover\"\r\nimport { Link, useRouter } from \"@/i18n/routing\"\r\nimport { useTranslations, useLocale } from \"next-intl\"\r\nimport { useRecentlyViewed } from \"@/hooks/use-recently-viewed\"\r\nimport { useProductSearch } from \"@/hooks/use-product-search\"\r\n\r\nexport function DesktopSearch() {\r\n  const router = useRouter()\r\n  const locale = useLocale()\r\n  const tNav = useTranslations(\"Navigation\")\n  const tSearch = useTranslations(\"SearchOverlay\")\n  const inputRef = useRef<HTMLInputElement>(null)\n  const formRef = useRef<HTMLFormElement>(null)\n  const searchInputId = \"treido-desktop-search-input\"\n\r\n  const buildSearchHref = useCallback((q: string) => {\r\n    const trimmed = q.trim()\r\n    if (!trimmed) return \"/search\"\r\n    return `/search?q=${encodeURIComponent(trimmed)}`\r\n  }, [])\r\n  \r\n  const [isOpen, setIsOpen] = React.useState(false)\r\n  const [aiMode, setAiMode] = React.useState(false)\r\n  const [popoverWidth, setPopoverWidth] = React.useState(0)\r\n  \r\n  const { products: recentlyViewed, clearProducts: clearRecentlyViewed } = useRecentlyViewed()\r\n  \r\n  // Use shared search hook\r\n  const {\r\n    query,\r\n    setQuery,\r\n    products,\r\n    isSearching,\r\n    recentProducts,\r\n    trendingSearches,\r\n    formatPrice,\r\n    saveSearch,\r\n    saveProduct,\r\n    clearRecentProducts,\r\n    minSearchLength,\r\n  } = useProductSearch(6)\r\n\r\n  const handleSearch = useCallback((e: React.FormEvent<HTMLFormElement>) => {\r\n    // Navigate via next-intl router so we always land on /[locale]/search.\r\n    // This also avoids relying on middleware redirects in dev/E2E.\r\n    const raw = new FormData(e.currentTarget).get(\"q\")\r\n    const q = (typeof raw === \"string\" ? raw : (inputRef.current?.value ?? query)).trim()\r\n    if (!q) {\r\n      e.preventDefault()\r\n      return\r\n    }\r\n\r\n    e.preventDefault()\r\n    saveSearch(q)\r\n    setIsOpen(false)\r\n    router.push(buildSearchHref(q))\r\n  }, [buildSearchHref, query, router, saveSearch])\r\n\r\n  const handleSelectSearch = useCallback((search: string) => {\r\n    setQuery(search)\r\n    saveSearch(search)\r\n    setIsOpen(false)\r\n    router.push(buildSearchHref(search))\r\n  }, [setQuery, saveSearch, router, buildSearchHref])\r\n\r\n  // Build SEO-friendly product URL\r\n  const buildProductUrl = useCallback((product: { slug?: string; storeSlug?: string | null; id: string }) => {\r\n    if (!product.storeSlug) return \"#\"\r\n    return `/${product.storeSlug}/${product.slug || product.id}`\r\n  }, [])\r\n\r\n  const handleSelectProduct = useCallback((product: { id: string; slug?: string; storeSlug?: string | null; title: string; price: number; images: string[] }) => {\r\n    if (product) {\r\n      // Ensure slug has a fallback for saveProduct which expects required slug\r\n      saveProduct({ ...product, slug: product.slug || product.id })\r\n    }\r\n    setIsOpen(false)\r\n    setQuery(\"\")\r\n    router.push(buildProductUrl(product))\r\n  }, [setQuery, router, saveProduct, buildProductUrl])\r\n\r\n  const handleKeyDown = useCallback((e: React.KeyboardEvent) => {\r\n    if (e.key === \"Escape\") {\r\n      setIsOpen(false)\r\n      inputRef.current?.blur()\r\n    }\r\n  }, [])\r\n\r\n  const handleClearInput = useCallback(() => {\r\n    setQuery(\"\")\r\n    inputRef.current?.focus()\r\n  }, [setQuery])\r\n\r\n  // Measure form width for popover to match search bar width\r\n  useEffect(() => {\r\n    const measureWidth = () => {\r\n      if (formRef.current) {\r\n        setPopoverWidth(formRef.current.offsetWidth)\r\n      }\r\n    }\r\n    measureWidth()\r\n    window.addEventListener(\"resize\", measureWidth)\r\n    return () => window.removeEventListener(\"resize\", measureWidth)\r\n  }, [])\r\n\r\n\r\n\r\n  return (\r\n    <div className=\"w-full\" data-desktop-search>\r\n      <Popover open={isOpen} onOpenChange={setIsOpen}>\r\n        <PopoverAnchor asChild>\r\n          <form \r\n            ref={formRef}\r\n            onSubmit={handleSearch}\r\n            action={`/${locale}/search`}\r\n            method=\"get\"\r\n            className=\"relative flex h-11 w-full items-center rounded-full bg-search-bg border border-search-border transition-colors focus-within:border-search-focus-border focus-within:ring-search-focus-ring/30 focus-within:ring-2 focus-within:bg-background\"\r\n          >\r\n            <MagnifyingGlass\r\n              size={18}\r\n              weight=\"regular\"\r\n              className=\"absolute left-4 text-search-placeholder pointer-events-none\"\r\n            />\r\n\r\n              <FieldLabel htmlFor={searchInputId} className=\"sr-only\">\r\n                {tNav(\"search\")}\r\n              </FieldLabel>\r\n              <Input\r\n                id={searchInputId}\r\n              ref={inputRef}\r\n              type=\"search\"\r\n              inputMode=\"search\"\r\n              enterKeyHint=\"search\"\r\n              name=\"q\"\r\n                placeholder={tNav(\"searchPlaceholder\")}\r\n              className=\"h-full w-full rounded-full border-0 bg-transparent pl-11 pr-24 text-sm text-search-text placeholder:text-search-placeholder focus-visible:border-0 focus-visible:ring-0\"\r\n              value={query}\r\n              onChange={(e) => setQuery(e.target.value)}\r\n              onFocus={() => setIsOpen(true)}\r\n              onClick={() => setIsOpen(true)}\r\n              onKeyDown={handleKeyDown}\r\n              autoComplete=\"off\"\r\n                aria-label={tNav(\"search\")}\r\n            />\r\n\r\n            {query && (\r\n                <button\r\n                type=\"button\"\r\n                onClick={handleClearInput}\r\n                  aria-label={tNav(\"clearSearch\")}\r\n                className=\"absolute right-24 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\r\n              >\r\n                <X size={16} weight=\"regular\" />\r\n              </button>\r\n            )}\r\n\r\n            <div className=\"absolute right-10 top-1/2 -translate-y-1/2 flex items-center gap-1.5\">\r\n              <Robot size={14} weight={aiMode ? \"fill\" : \"regular\"} className={aiMode ? \"text-primary\" : \"text-muted-foreground\"} />\r\n              <Switch\r\n                checked={aiMode}\r\n                onCheckedChange={(checked) => { setAiMode(checked); setIsOpen(true); }}\r\n                aria-label={tSearch(\"aiMode\")}\r\n              />\r\n            </div>\r\n\r\n            <Button\r\n              type=\"submit\"\r\n              variant=\"black\"\r\n              size=\"icon-sm\"\r\n              aria-label={tNav(\"search\")}\r\n              className=\"absolute right-1 top-1/2 -translate-y-1/2 rounded-full focus-visible:outline-none\"\r\n            >\r\n              <MagnifyingGlass size={16} weight=\"bold\" />\r\n            </Button>\r\n          </form>\r\n        </PopoverAnchor>\r\n\r\n        <PopoverContent\r\n          className=\"p-0 border border-border rounded-lg overflow-hidden\"\r\n          style={{ width: popoverWidth > 0 ? popoverWidth : undefined }}\r\n          align=\"start\"\r\n          sideOffset={4}\r\n          onOpenAutoFocus={(e) => e.preventDefault()}\r\n        >\r\n          {aiMode ? (\r\n            <SearchAiChat \r\n              onClose={() => setIsOpen(false)} \r\n              className=\"h-96\"\r\n            />\r\n          ) : (\r\n          <>\r\n          <div className=\"max-h-(--spacing-scroll-xl) overflow-y-auto\">\r\n            {/* Live Product Results */}\r\n            {products.length > 0 && (\r\n              <div className=\"border-b border-border\">\r\n                <div className=\"flex items-center justify-between px-4 py-2.5 bg-surface-subtle\">\r\n                  <span className=\"flex items-center gap-2 text-xs font-medium text-muted-foreground uppercase tracking-wide\">\r\n                    <Package size={14} weight=\"regular\" />\r\n                    {tSearch(\"products\")}\r\n                  </span>\r\n                  <Link \r\n                    href={buildSearchHref(query)}\r\n                    className=\"text-xs text-primary flex items-center gap-1\"\r\n                    onClick={() => setIsOpen(false)}\r\n                  >\r\n                    {tSearch(\"viewAll\")}\r\n                    <ArrowRight size={12} weight=\"regular\" />\r\n                  </Link>\r\n                </div>\r\n                <div className=\"p-2\">\r\n                  {products.map((product) => (\r\n                    <button\r\n                      key={product.id}\r\n                      onClick={() => handleSelectProduct(product)}\r\n                      className=\"w-full flex items-center gap-3 p-2.5 hover:bg-muted rounded-lg text-left group\"\r\n                    >\r\n                      <div className=\"w-12 h-12 bg-muted rounded-lg overflow-hidden shrink-0 ring-1 ring-border\">\r\n                        {product.images?.[0] ? (\r\n                          <Image\r\n                            src={product.images[0]}\r\n                            alt={product.title}\r\n                            width={48}\r\n                            height={48}\r\n                            className=\"w-full h-full object-cover\"\r\n                          />\r\n                        ) : (\r\n                          <div className=\"w-full h-full flex items-center justify-center\">\r\n                            <Package size={20} weight=\"regular\" className=\"text-muted-foreground\" />\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                      <div className=\"flex-1 min-w-0\">\r\n                        <p className=\"text-sm font-medium truncate text-foreground group-hover:text-primary\">\r\n                          {product.title}\r\n                        </p>\r\n                        <p className=\"text-sm font-bold text-price-sale\">\r\n                          {formatPrice(product.price)}\r\n                        </p>\r\n                      </div>\r\n                      <ArrowRight size={16} weight=\"regular\" className=\"text-muted-foreground opacity-0 group-hover:opacity-100\" />\r\n                    </button>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Recently Viewed Products */}\r\n            {recentlyViewed.length > 0 && !query && (\r\n              <div className=\"border-b border-border\">\r\n                <div className=\"flex items-center justify-between px-4 py-2.5 bg-surface-subtle\">\r\n                  <span className=\"flex items-center gap-2 text-xs font-medium text-muted-foreground uppercase tracking-wide\">\r\n                    <Eye size={14} weight=\"regular\" />\r\n                    {tSearch(\"recentlyViewed\")}\r\n                  </span>\r\n                  <button\r\n                    onClick={clearRecentlyViewed}\r\n                    className=\"text-xs text-muted-foreground hover:text-foreground\"\r\n                  >\r\n                    {tSearch(\"clear\")}\r\n                  </button>\r\n                </div>\r\n                <div className=\"p-2\">\r\n                  <div className=\"flex gap-2 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-muted scrollbar-track-transparent\">\r\n                    {recentlyViewed.slice(0, 6).map((product) => (\r\n                      <Link\r\n                        key={product.id}\r\n                        href={buildProductUrl(product)}\r\n                        onClick={() => setIsOpen(false)}\r\n                        className=\"shrink-0 w-24 group\"\r\n                      >\r\n                        <div className=\"w-24 h-24 bg-muted rounded-lg overflow-hidden ring-1 ring-border\">\r\n                          {product.image ? (\r\n                            <Image\r\n                              src={product.image}\r\n                              alt={product.title}\r\n                              width={96}\r\n                              height={96}\r\n                              className=\"w-full h-full object-cover\"\r\n                            />\r\n                          ) : (\r\n                            <div className=\"w-full h-full flex items-center justify-center\">\r\n                              <Package size={24} weight=\"regular\" className=\"text-muted-foreground\" />\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                        <p className=\"mt-1.5 text-xs text-foreground line-clamp-2 group-hover:text-primary group-hover:underline\">\r\n                          {product.title}\r\n                        </p>\r\n                        <p className=\"text-xs font-semibold text-price-sale\">\r\n                          {formatPrice(product.price)}\r\n                        </p>\r\n                      </Link>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Recent Searched Products */}\r\n            {recentProducts.length > 0 && !query && (\r\n              <div className=\"border-b border-border\">\r\n                <div className=\"flex items-center justify-between px-4 py-2.5 bg-surface-subtle\">\r\n                  <span className=\"flex items-center gap-2 text-xs font-medium text-muted-foreground uppercase tracking-wide\">\r\n                    <Clock size={14} weight=\"regular\" />\r\n                    {tSearch(\"recentSearches\")}\r\n                  </span>\r\n                  <button\r\n                    onClick={clearRecentProducts}\r\n                    className=\"text-xs text-muted-foreground hover:text-foreground\"\r\n                  >\r\n                    {tSearch(\"clear\")}\r\n                  </button>\r\n                </div>\r\n                <div className=\"p-2\">\r\n                  <div className=\"flex gap-2 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-muted scrollbar-track-transparent\">\r\n                    {recentProducts.map((product) => (\r\n                      <Link\r\n                        key={product.id}\r\n                        href={buildProductUrl(product)}\r\n                        onClick={() => setIsOpen(false)}\r\n                        className=\"shrink-0 w-24 group\"\r\n                      >\r\n                        <div className=\"w-24 h-24 bg-muted rounded-lg overflow-hidden ring-1 ring-border\">\r\n                          {product.image ? (\r\n                            <Image\r\n                              src={product.image}\r\n                              alt={product.title}\r\n                              width={96}\r\n                              height={96}\r\n                              className=\"w-full h-full object-cover\"\r\n                            />\r\n                          ) : (\r\n                            <div className=\"w-full h-full flex items-center justify-center\">\r\n                              <Package size={24} weight=\"regular\" className=\"text-muted-foreground\" />\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                        <p className=\"mt-1.5 text-xs text-foreground line-clamp-2 group-hover:text-primary group-hover:underline\">\r\n                          {product.title}\r\n                        </p>\r\n                        <p className=\"text-xs font-semibold text-price-sale\">\r\n                          {formatPrice(product.price)}\r\n                        </p>\r\n                      </Link>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Trending Searches */}\r\n            {!query && (\r\n              <div>\r\n                <div className=\"flex items-center gap-2 px-4 py-2.5 bg-surface-subtle\">\r\n                  <span className=\"flex items-center gap-2 text-xs font-medium text-muted-foreground uppercase tracking-wide\">\r\n                    <TrendUp size={14} weight=\"regular\" />\r\n                    {tSearch(\"trending\")}\r\n                  </span>\r\n                </div>\r\n                <div className=\"p-1\">\r\n                  {trendingSearches.map((search, i) => (\r\n                    <button\r\n                      key={`trending-${i}`}\r\n                      onClick={() => handleSelectSearch(search)}\r\n                      className=\"w-full flex items-center gap-3 px-3 py-2 hover:bg-muted rounded-md text-left group\"\r\n                    >\r\n                      <div className=\"w-5 h-5 rounded-full bg-primary flex items-center justify-center text-xs font-bold text-primary-foreground\">\r\n                        {i + 1}\r\n                      </div>\r\n                      <span className=\"text-sm text-foreground group-hover:text-primary flex-1\">\r\n                        {search}\r\n                      </span>\r\n                      <ArrowRight size={14} weight=\"regular\" className=\"text-muted-foreground opacity-0 group-hover:opacity-100\" />\r\n                    </button>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Loading State */}\r\n            {isSearching && query && (\r\n              <div className=\"px-4 py-8 text-center\">\r\n                <div className=\"inline-flex items-center gap-2 text-sm text-muted-foreground\">\r\n                  <div className=\"size-4 border-2 border-border border-t-primary rounded-full\" />\r\n                  {tSearch(\"searching\")}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* No Results */}\r\n            {!isSearching && query && query.length >= minSearchLength && products.length === 0 && (\r\n              <div className=\"px-4 py-8 text-center\">\r\n                <Package size={40} weight=\"regular\" className=\"text-muted-foreground mx-auto mb-2\" />\r\n                <p className=\"text-sm text-muted-foreground\">\r\n                  {tSearch(\"noResultsFor\", { query })}\r\n                </p>\r\n                <p className=\"text-xs text-muted-foreground mt-1\">\r\n                  {tSearch(\"tryDifferent\")}\r\n                </p>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Keyboard Hint */}\r\n          <div className=\"px-4 py-2 bg-surface-subtle border-t border-border flex items-center justify-between text-xs text-muted-foreground\">\r\n            <span>\r\n              {tSearch(\"press\")} {\" \"}\r\n              <kbd className=\"px-1.5 py-0.5 bg-background rounded border text-xs font-mono\">\r\n                Enter\r\n              </kbd>{\" \"}\r\n              {tSearch(\"toSearch\")}\r\n            </span>\r\n            <span>\r\n              <kbd className=\"px-1.5 py-0.5 bg-background rounded border text-xs font-mono\">\r\n                Esc\r\n              </kbd>{\" \"}\r\n              {tSearch(\"toClose\")}\r\n            </span>\r\n          </div>\r\n          </>\r\n          )}\r\n        </PopoverContent>\r\n      </Popover>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\feed-toolbar-pill.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\feed-toolbar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isLoadingAttributes' is defined but never used.","line":102,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":102,"endColumn":22},{"ruleId":"sonarjs/prefer-single-boolean-return","severity":1,"message":"Replace this if-then-else flow by a single return statement.","line":116,"column":7,"nodeType":"IfStatement","messageId":"replaceIfThenElseByReturn","endLine":116,"endColumn":83,"suggestions":[{"messageId":"suggest","fix":{"range":[3778,3873],"text":"return !(attr.name.toLowerCase() === \"gender\" && isGenderedCategory);"},"desc":"Replace with single return statement"}]},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":135,"column":35,"nodeType":"Identifier","messageId":"method","endLine":135,"endColumn":42,"fix":{"range":[4509,4509],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":142,"column":34,"nodeType":"Identifier","messageId":"method","endLine":142,"endColumn":41,"fix":{"range":[4840,4840],"text":"All"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":2,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { useMemo } from \"react\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport type { CategoryAttribute } from \"@/lib/data/categories\"\r\nimport { ToggleGroup, ToggleGroupItem } from \"@/components/ui/toggle-group\"\r\nimport {\r\n  CaretDown,\r\n  SquaresFour,\r\n  Rows,\r\n  Check,\r\n  ArrowsDownUp,\r\n} from \"@phosphor-icons/react\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport { QuickFilterPills } from \"./quick-filter-pills\"\r\nimport { CategoryAttributeDropdowns, type CategoryFilterDef } from \"./category-attribute-dropdowns\"\r\nimport { pillBase, pillInactive } from \"./feed-toolbar-pill\"\r\n\r\n// =============================================================================\r\n// TYPES\r\n// =============================================================================\r\n\r\nexport type FeedTab =\r\n  | \"newest\"\r\n  | \"popular\"\r\n  | \"price_low\"\r\n  | \"price_high\"\r\n\r\nexport type QuickFilter = \"deals\" | \"nearby\" | \"top_rated\" | \"free_shipping\"\r\n\r\nexport interface FilterState {\r\n  priceMin: string\r\n  priceMax: string\r\n  condition: string | null\r\n  /** Dynamic attribute filters: attributeName -> selected value */\r\n  attributes: Record<string, string | null>\r\n  /** Active quick filters */\r\n  quickFilters: QuickFilter[]\r\n}\r\n\r\n// Re-export the CategoryAttribute type for consumers\r\nexport type { CategoryAttribute }\r\n\r\nexport interface FeedToolbarProps {\r\n  locale: string\r\n  productCount: number\r\n  /** Show the count label to the left of the tabs (desktop home shows a dedicated category header). */\r\n  showCount?: boolean\r\n  activeTab: FeedTab\r\n  onTabChange: (tab: FeedTab) => void\r\n  viewMode: \"grid\" | \"list\"\r\n  onViewModeChange: (mode: \"grid\" | \"list\") => void\r\n  categorySlug: string | null\r\n  /** User's city for nearby filtering */\r\n  userCity?: string | null\r\n  /** Callback when user wants to change city */\r\n  onCityChange?: (city: string) => void\r\n  filters: FilterState\r\n  onFiltersChange: (f: FilterState) => void\r\n  categoryAttributes: CategoryAttribute[]\r\n  isLoadingAttributes: boolean\r\n}\r\n\r\n// =============================================================================\r\n// CONSTANTS\r\n// =============================================================================\r\n\r\nconst MAX_INLINE_ATTRS = 2\r\n\r\nconst SORT_OPTIONS: Array<{ id: FeedTab; labelKey: string }> = [\r\n  { id: \"newest\", labelKey: \"tabs.newest\" },\r\n  { id: \"popular\", labelKey: \"tabs.best_sellers\" },\r\n  { id: \"price_low\", labelKey: \"tabs.price_low\" },\r\n  { id: \"price_high\", labelKey: \"tabs.price_high\" },\r\n]\r\n\r\n// =============================================================================\r\n// FEED TOOLBAR - Single row unified filter bar\r\n// =============================================================================\r\n\r\nexport function FeedToolbar({\r\n  locale,\r\n  productCount,\r\n  showCount = true,\r\n  activeTab,\r\n  onTabChange,\r\n  viewMode,\r\n  onViewModeChange,\r\n  categorySlug,\r\n  userCity,\r\n  onCityChange,\r\n  filters,\r\n  onFiltersChange,\r\n  categoryAttributes,\r\n  isLoadingAttributes,\r\n}: FeedToolbarProps) {\r\n  const t = useTranslations(\"TabbedProductFeed\")\r\n  const tViewMode = useTranslations(\"ViewMode\")\r\n\r\n  // Build contextual filter pills from category attributes (max 4 for single row)\r\n  const categoryFilters = useMemo<CategoryFilterDef[]>(() => {\r\n    if (!categorySlug || categoryAttributes.length === 0) return []\r\n\r\n    // Skip Gender when already in a gendered category\r\n    const isGenderedCategory = /^(men|women|kids|boys|girls)-/.test(categorySlug) ||\r\n      categorySlug.includes(\"-mens\") || categorySlug.includes(\"-womens\")\r\n    \r\n    const filtered = categoryAttributes.filter(attr => {\r\n      if (attr.name.toLowerCase() === \"gender\" && isGenderedCategory) return false\r\n      return true\r\n    })\r\n\r\n    // Priority order: Condition first, then Size, Color, then by sortOrder\r\n    const priorityMap: Record<string, number> = {\r\n      \"condition\": 0,\r\n      \"size\": 1,\r\n      \"color\": 2,\r\n      \"brand\": 3,\r\n    }\r\n    const sorted = [...filtered].sort((a, b) => {\r\n      const aPriority = priorityMap[a.name.toLowerCase()] ?? (a.sort_order ?? 999)\r\n      const bPriority = priorityMap[b.name.toLowerCase()] ?? (b.sort_order ?? 999)\r\n      return aPriority - bPriority\r\n    })\r\n\r\n    // Return all sorted attributes for inline + overflow handling\r\n    return sorted.map((attr) => ({\r\n      id: attr.name.toLowerCase().replace(/\\s+/g, \"_\"),\r\n      label: locale === \"bg\" && attr.name_bg ? attr.name_bg : attr.name,\r\n      name: attr.name,\r\n      options: (locale === \"bg\" && attr.options_bg && attr.options_bg.length > 0\r\n        ? attr.options_bg\r\n        : attr.options || []\r\n      ).slice(0, 10).map((opt) => ({\r\n        value: opt.toLowerCase().replace(/\\s+/g, \"_\"),\r\n        label: opt,\r\n      })),\r\n    }))\r\n  }, [categorySlug, categoryAttributes, locale])\r\n\r\n  // Split category filters into inline (visible) and overflow (\"+N more\" dropdown)\r\n  const inlineFilters = categoryFilters.slice(0, MAX_INLINE_ATTRS)\r\n  const overflowFilters = categoryFilters.slice(MAX_INLINE_ATTRS)\r\n\r\n  // Toggle quick filter\r\n  const toggleQuickFilter = (id: QuickFilter) => {\r\n    const current = filters.quickFilters || []\r\n    const newFilters = current.includes(id)\r\n      ? current.filter(f => f !== id)\r\n      : [...current, id]\r\n    onFiltersChange({ ...filters, quickFilters: newFilters })\r\n  }\r\n\r\n  const activeQuickFilters = filters.quickFilters || []\r\n\r\n  // Get current sort label\r\n  const currentSortLabel = SORT_OPTIONS.find(s => s.id === activeTab)?.labelKey ?? \"tabs.newest\"\r\n\r\n  return (\r\n    <div className=\"flex items-center gap-3 mb-4 pb-4 border-b border-border\">\r\n      {/* LEFT: Sort dropdown */}\r\n      <DropdownMenu>\r\n        <DropdownMenuTrigger asChild>\r\n          <button type=\"button\" className={cn(pillBase, pillInactive)}>\r\n            <ArrowsDownUp size={16} weight=\"regular\" className=\"shrink-0\" />\r\n            <span>{t(currentSortLabel)}</span>\r\n            <CaretDown className=\"size-4 opacity-60 shrink-0\" />\r\n          </button>\r\n        </DropdownMenuTrigger>\r\n        <DropdownMenuContent align=\"start\" className=\"min-w-44\">\r\n          {SORT_OPTIONS.map((opt) => {\r\n            const isSelected = activeTab === opt.id\r\n            return (\r\n              <DropdownMenuItem\r\n                key={opt.id}\r\n                onClick={() => onTabChange(opt.id)}\r\n                className={cn(isSelected && \"bg-accent\")}\r\n              >\r\n                <span className=\"flex-1\">{t(opt.labelKey)}</span>\r\n                {isSelected && <Check className=\"size-4 text-primary\" />}\r\n              </DropdownMenuItem>\r\n            )\r\n          })}\r\n        </DropdownMenuContent>\r\n      </DropdownMenu>\r\n\r\n      {/* Product count */}\r\n      {showCount && (\r\n        <>\r\n          <div className=\"h-6 w-px bg-border shrink-0\" />\r\n          <span className=\"text-sm text-muted-foreground whitespace-nowrap shrink-0\">\r\n            <span className=\"font-semibold text-foreground\">{productCount.toLocaleString(locale)}</span>\r\n            {\" \"}{t(\"sectionAriaLabel\").toLowerCase()}\r\n          </span>\r\n        </>\r\n      )}\r\n\r\n      {/* Category-specific filter dropdowns OR generic quick pills */}\r\n      {categorySlug && categoryFilters.length > 0 ? (\r\n        // Category selected: show category-specific filters (Size, Brand, Color, etc.)\r\n        <CategoryAttributeDropdowns\r\n          locale={locale}\r\n          filters={filters}\r\n          onFiltersChange={onFiltersChange}\r\n          inlineFilters={inlineFilters}\r\n          overflowFilters={overflowFilters}\r\n        />\r\n      ) : (\r\n        // No category: show generic quick filter pills (Deals, Nearby, Top Rated)\r\n        <QuickFilterPills\r\n          locale={locale}\r\n          activeQuickFilters={activeQuickFilters}\r\n          onToggleQuickFilter={toggleQuickFilter}\r\n          userCity={userCity ?? null}\r\n          {...(onCityChange ? { onCityChange } : {})}\r\n        />\r\n      )}\r\n\r\n      {/* View Toggle */}\r\n      <div className=\"h-6 w-px bg-border shrink-0\" />\r\n      <ToggleGroup\r\n        type=\"single\"\r\n        value={viewMode}\r\n        onValueChange={(value) => value && onViewModeChange(value as \"grid\" | \"list\")}\r\n        className=\"h-9 bg-surface-subtle p-0.5 rounded-lg shrink-0 border border-border\"\r\n      >\r\n        <ToggleGroupItem\r\n          value=\"grid\"\r\n          aria-label={tViewMode(\"gridView\")}\r\n          className=\"size-8 p-0 rounded-md data-[state=on]:bg-background data-[state=on]:shadow-sm\"\r\n        >\r\n          <SquaresFour size={18} weight={viewMode === \"grid\" ? \"fill\" : \"regular\"} />\r\n        </ToggleGroupItem>\r\n        <ToggleGroupItem\r\n          value=\"list\"\r\n          aria-label={tViewMode(\"listView\")}\r\n          className=\"size-8 p-0 rounded-md data-[state=on]:bg-background data-[state=on]:shadow-sm\"\r\n        >\r\n          <Rows size={18} weight={viewMode === \"list\" ? \"fill\" : \"regular\"} />\r\n        </ToggleGroupItem>\r\n      </ToggleGroup>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\filters-sidebar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\product\\desktop-buy-box.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Image' is defined but never used.","line":18,"column":8,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":13,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Image"},"fix":{"range":[756,786],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"sonarjs/no-identical-functions","severity":1,"message":"Update this function so that its implementation is not identical to the one on line 135.","line":145,"column":27,"nodeType":null,"endLine":145,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\n// =============================================================================\r\n// DESKTOP BUY BOX - Sticky with Embedded Seller\n// =============================================================================\r\n// Based on V2 demo design - the winner from our audit.\r\n// Key features:\r\n// - Sticky positioning on scroll\r\n// - Seller card embedded inside (not separate)\r\n// - Category-adaptive CTAs (Buy Now vs Contact Agent vs Test Drive)\r\n// - Quantity selector (hidden for real-estate/automotive)\r\n// - Shipping/Returns info section\r\n// =============================================================================\r\n\r\nimport { useState } from \"react\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { useLocale } from \"next-intl\"\r\nimport Image from \"next/image\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport {\r\n  Heart,\r\n  MessageCircle,\r\n  Minus,\r\n  Plus,\r\n  Share2,\r\n  ShieldCheck,\r\n  Package,\r\n  Truck,\r\n  Clock,\r\n  MapPin,\r\n  ShoppingCart,\r\n  Zap,\r\n  BadgeCheck,\r\n  RotateCcw,\r\n  Store,\r\n} from \"lucide-react\"\r\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { IconButton } from \"@/components/ui/icon-button\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { UserAvatar } from \"@/components/shared/user-avatar\"\nimport { useCart } from \"@/components/providers/cart-context\"\r\nimport { useWishlist } from \"@/components/providers/wishlist-context\"\r\nimport { useToast } from \"@/hooks/use-toast\"\r\nimport type { CategoryType } from \"@/lib/utils/category-type\"\r\n\r\ninterface SellerInfo {\r\n  id: string\r\n  name: string\r\n  username?: string | null\r\n  avatarUrl?: string | null\r\n  verified?: boolean\r\n  rating?: number | null\r\n  reviewCount?: number | null\r\n  responseTime?: string | null\r\n  ordersCompleted?: number | null\r\n  location?: string | null\r\n}\r\n\r\nexport interface DesktopBuyBoxProps {\n  productId: string\n  productSlug: string\n  title: string\n  price: number\r\n  originalPrice?: number | null\r\n  currency?: string\r\n  condition?: string | null\r\n  stock?: number | null\r\n  seller: SellerInfo\r\n  categoryType?: CategoryType\r\n  freeShipping?: boolean\r\n  location?: string | null\r\n  primaryImage?: string | null\n  className?: string\n}\n\nexport function DesktopBuyBox({\n  productId,\n  productSlug,\n  title,\n  price,\n  originalPrice,\r\n  currency = \"EUR\",\r\n  condition,\r\n  stock,\r\n  seller,\r\n  categoryType = \"default\",\r\n  freeShipping = false,\n  location,\n  primaryImage,\n  className,\n}: DesktopBuyBoxProps) {\n  const t = useTranslations(\"Product\")\r\n  const locale = useLocale()\r\n  const { addToCart } = useCart()\r\n  const { isInWishlist, toggleWishlist } = useWishlist()\r\n  const { toast } = useToast()\r\n\r\n  const [quantity, setQuantity] = useState(1)\r\n\r\n  const isRealEstate = categoryType === \"real-estate\"\r\n  const isAutomotive = categoryType === \"automotive\"\r\n  const showQuantity = !isRealEstate && !isAutomotive\r\n\r\n  const isOutOfStock = stock === 0\r\n  const isLowStock = stock != null && stock > 0 && stock <= 5\r\n  const productInWishlist = isInWishlist(productId)\r\n\r\n  // Calculate discount percentage\r\n  const discount =\r\n    originalPrice && originalPrice > price\r\n      ? Math.round(((originalPrice - price) / originalPrice) * 100)\r\n      : 0\r\n\r\n  // Format price\r\n  const formatPrice = (amount: number) => {\r\n    return new Intl.NumberFormat(locale, {\r\n      style: \"currency\",\r\n      currency,\r\n      minimumFractionDigits: 2,\r\n    }).format(amount)\r\n  }\r\n\r\n  // Cart product info\r\n  const cartProduct = {\r\n    id: productId,\r\n    title,\r\n    price,\r\n    image: primaryImage ?? \"\",\r\n    slug: productSlug,\r\n    ...(seller.username ? { username: seller.username } : {}),\r\n  }\r\n\r\n  // Handle add to cart\r\n  const handleAddToCart = () => {\r\n    if (isOutOfStock) return\r\n    addToCart({ ...cartProduct, quantity })\r\n    toast({\r\n      title: t(\"addedToCart\"),\r\n      description: `${quantity}x ${title}`,\r\n    })\r\n  }\r\n\r\n  // Handle buy now\r\n  const handleBuyNow = () => {\r\n    if (isOutOfStock) return\r\n    addToCart({ ...cartProduct, quantity })\r\n    // Navigate to checkout would happen here\r\n    toast({\r\n      title: t(\"addedToCart\"),\r\n      description: `${quantity}x ${title}`,\r\n    })\r\n  }\r\n\r\n  // Category-adaptive CTA labels\r\n  const getPrimaryCTA = () => {\r\n    if (isRealEstate) return { label: t(\"contactAgent\"), icon: MessageCircle }\r\n    if (isAutomotive) return { label: t(\"contactSeller\"), icon: MessageCircle }\r\n    return { label: t(\"addToCart\"), icon: ShoppingCart }\r\n  }\r\n\r\n  const getSecondaryCTA = () => {\r\n    if (isRealEstate) return t(\"scheduleVisit\")\r\n    if (isAutomotive) return t(\"testDrive\")\r\n    return t(\"buyNow\")\r\n  }\r\n\r\n  const primaryCTA = getPrimaryCTA()\r\n\r\n  return (\n    <div\n      className={cn(\n        \"sticky top-24 rounded-xl border border-border bg-card p-4 space-y-3\",\n        className\n      )}\n    >\n      {/* Stock Status + Actions */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div className=\"flex items-center gap-1.5\">\r\n          {isOutOfStock ? (\r\n            <>\r\n              <span className=\"size-1.5 rounded-full bg-destructive\" />\r\n              <span className=\"text-sm font-medium text-destructive\">\r\n                {t(\"outOfStock\")}\r\n              </span>\r\n            </>\r\n          ) : isLowStock ? (\r\n            <>\r\n              <span className=\"size-1.5 rounded-full bg-warning\" />\r\n              <span className=\"text-sm font-medium text-warning\">\r\n                {t(\"lowStock\", { count: stock })}\r\n              </span>\r\n            </>\r\n          ) : (\r\n            <>\r\n              <span className=\"size-1.5 rounded-full bg-success\" />\r\n              <span className=\"text-sm font-medium text-success\">\r\n                {t(\"inStock\")}\r\n              </span>\r\n            </>\r\n          )}\r\n        </div>\r\n        <div className=\"flex items-center gap-0.5\">\n          <IconButton\n            type=\"button\"\n            variant=\"ghost\"\n            onClick={() => toggleWishlist(cartProduct)}\n            aria-label={\n              productInWishlist ? t(\"removeFromWatchlist\") : t(\"addToWatchlist\")\n            }\n            className=\"text-muted-foreground hover:text-foreground\"\n          >\n            <Heart\n              className={cn(\n                productInWishlist\n                  ? \"fill-destructive text-destructive\"\n                  : \"text-muted-foreground\"\n              )}\n            />\n          </IconButton>\n          <IconButton\n            type=\"button\"\n            variant=\"ghost\"\n            aria-label={t(\"share\")}\n            className=\"text-muted-foreground hover:text-foreground\"\n          >\n            <Share2 />\n          </IconButton>\n        </div>\n      </div>\n\r\n      {/* Price Block */}\r\n      <div className=\"space-y-1\">\r\n        <div className=\"flex items-baseline gap-2 flex-wrap\">\r\n          <span className=\"text-2xl font-bold text-foreground\">\r\n            {formatPrice(price)}\r\n          </span>\r\n          {originalPrice && originalPrice > price && (\r\n            <>\r\n              <span className=\"text-base text-muted-foreground line-through\">\r\n                {formatPrice(originalPrice)}\r\n              </span>\r\n              <Badge\r\n                variant=\"destructive\"\r\n                className=\"text-xs px-1.5 py-0 h-5\"\r\n              >\r\n                -{discount}%\r\n              </Badge>\r\n            </>\r\n          )}\r\n        </div>\r\n        {condition && (\n          <Badge variant=\"condition\">{condition}</Badge>\n        )}\n      </div>\n\n      {/* Shipping/Location Info */}\n      <div className=\"rounded-xl border border-border bg-surface-subtle p-2.5 space-y-1.5\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2 text-sm\">\n            {isRealEstate ? (\n              <>\n                <MapPin className=\"size-4 text-foreground\" />\n                <span className=\"font-medium text-foreground\">\r\n                  {location || t(\"locationTBA\")}\r\n                </span>\r\n              </>\r\n            ) : (\n              <>\n                <Truck\n                  className=\"size-4 text-muted-foreground\"\n                />\n                <span\n                  className=\"font-medium text-foreground\"\n                >\n                  {freeShipping ? t(\"freeShipping\") : t(\"shippingAvailable\")}\n                </span>\n              </>\n            )}\n          </div>\r\n        </div>\r\n        {!isRealEstate && (\r\n          <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\r\n            <span className=\"flex items-center gap-1\">\r\n              <Clock className=\"size-3\" />\r\n              {isAutomotive ? t(\"pickupAvailable\") : t(\"delivery2to3Days\")}\r\n            </span>\r\n            {location && (\r\n              <span className=\"flex items-center gap-1\">\r\n                <MapPin className=\"size-3\" />\r\n                {location}\r\n              </span>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Quantity Selector (for applicable categories) */}\r\n      {showQuantity && !isOutOfStock && (\n        <div className=\"flex items-center justify-between gap-3 py-2 border-y border-border\">\n          <div className=\"flex items-center gap-2\">\n            <span className=\"text-sm text-muted-foreground\">{t(\"qty\")}</span>\n            <div className=\"flex items-center border border-border rounded-xl\">\n              <IconButton\n                type=\"button\"\n                size=\"icon-lg\"\n                variant=\"ghost\"\n                className=\"hover:bg-muted\"\n                onClick={() => setQuantity(Math.max(1, quantity - 1))}\n                disabled={quantity <= 1}\n                aria-label={t(\"decreaseQuantity\")}\n              >\n                <Minus\n                  className={cn(\n                    quantity <= 1 ? \"text-muted-foreground opacity-40\" : \"text-foreground\"\n                  )}\n                />\n              </IconButton>\n              <span className=\"px-3 py-1 text-sm font-medium min-w-touch text-center\">\n                {quantity}\n              </span>\n              <IconButton\n                type=\"button\"\n                size=\"icon-lg\"\n                variant=\"ghost\"\n                className=\"hover:bg-muted\"\n                onClick={() => setQuantity(Math.min(99, quantity + 1))}\n                aria-label={t(\"increaseQuantity\")}\n              >\n                <Plus className=\"text-foreground\" />\n              </IconButton>\n            </div>\n          </div>\n          <div className=\"text-right\">\n            <span className=\"text-xs text-muted-foreground\">{t(\"total\")}</span>\r\n            <div className=\"text-lg font-bold text-foreground\">\r\n              {formatPrice(price * quantity)}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* CTA Buttons - Category Adaptive */}\r\n      <div className=\"flex gap-2\">\r\n        {isRealEstate || isAutomotive ? (\r\n          <>\r\n            <Button\r\n              size=\"lg\"\r\n              className=\"flex-1 font-semibold\"\r\n              disabled={isOutOfStock}\r\n            >\r\n              <primaryCTA.icon className=\"size-4\" />\r\n              {primaryCTA.label}\r\n            </Button>\r\n            <Button variant=\"outline\" size=\"lg\" className=\"px-4\">\r\n              {getSecondaryCTA()}\r\n            </Button>\r\n          </>\r\n        ) : (\r\n          <>\r\n            <Button\r\n              size=\"lg\"\r\n              className=\"flex-1 font-semibold\"\r\n              onClick={handleAddToCart}\r\n              disabled={isOutOfStock}\r\n            >\r\n              <ShoppingCart className=\"size-4\" />\r\n              {t(\"addToCart\")}\r\n            </Button>\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"icon-lg\"\r\n              onClick={handleBuyNow}\r\n              disabled={isOutOfStock}\r\n              title={t(\"buyNow\")}\r\n              aria-label={t(\"buyNow\")}\r\n            >\r\n              <Zap />\r\n            </Button>\r\n          </>\r\n        )}\r\n      </div>\n\n      {/* Protection Badges */}\n      <div className=\"flex items-center justify-center gap-3 text-xs text-muted-foreground\">\n        <span className=\"flex items-center gap-1\">\n          <ShieldCheck className=\"size-3 text-muted-foreground\" />\n          {t(\"buyerProtection\")}\n        </span>\n        <span className=\"text-muted-foreground\">|</span>\n        <span className=\"flex items-center gap-1\">\n          <RotateCcw className=\"size-3\" />\n          {isRealEstate ? t(\"verifiedListing\") : t(\"easyReturns\")}\n        </span>\n      </div>\n\n      {/* Embedded Seller Card */}\n      <div className=\"rounded-xl border border-border bg-surface-subtle p-3\">\n        <div className=\"flex items-center gap-2.5\">\n          <UserAvatar\n            name={seller.name}\n            avatarUrl={seller.avatarUrl ?? null}\n            className=\"size-10 border border-border bg-muted\"\r\n            fallbackClassName=\"text-xs font-medium bg-muted\"\r\n          />\r\n          <div className=\"flex-1 min-w-0\">\r\n            <div className=\"flex items-center gap-1\">\r\n              <span className=\"font-semibold text-foreground text-sm truncate\">\n                {seller.name}\n              </span>\n              {seller.verified && (\n                <BadgeCheck className=\"size-3.5 text-muted-foreground shrink-0\" />\n              )}\n            </div>\n            {seller.rating != null && (\n              <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground\">\n                <span className=\"text-muted-foreground\">Γÿà</span>\n                <span>{seller.rating.toFixed(1)}</span>\n                {seller.reviewCount != null && (\n                  <>\n                    <span>ΓÇó</span>\n                    <span>\n                      {t(\"reviews\", { count: seller.reviewCount })}\n                    </span>\n                  </>\n                )}\n              </div>\n            )}\n          </div>\r\n        </div>\r\n\r\n        {/* Seller Stats */}\r\n        {(seller.responseTime || seller.ordersCompleted || seller.location) && (\n          <div className=\"flex items-center justify-between mt-2 pt-2 border-t border-border-subtle text-xs text-muted-foreground\">\n            {seller.responseTime && (\n              <span className=\"flex items-center gap-1\">\n                <Clock className=\"size-2.5\" />\n                {seller.responseTime}\n              </span>\r\n            )}\r\n            {seller.ordersCompleted != null && (\r\n              <span className=\"flex items-center gap-1\">\r\n                <Package className=\"size-2.5\" />\r\n                {seller.ordersCompleted.toLocaleString()} {t(\"orders\")}\r\n              </span>\r\n            )}\r\n            {seller.location && (\r\n              <span className=\"flex items-center gap-1\">\r\n                <MapPin className=\"size-2.5\" />\r\n                {seller.location.split(\",\")[0]}\r\n              </span>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Seller Actions */}\r\n        <div className=\"flex gap-2 mt-2.5\">\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            className=\"flex-1 gap-1 text-xs bg-background\"\r\n          >\r\n            <MessageCircle className=\"size-3\" />\r\n            {t(\"message\")}\r\n          </Button>\r\n          {seller.username && (\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              className=\"flex-1 text-xs bg-background\"\r\n              asChild\r\n            >\r\n              <Link href={`/${seller.username}`}>\r\n                <Store className=\"size-3 mr-1\" />\r\n                {t(\"viewStore\")}\r\n              </Link>\r\n            </Button>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\product\\desktop-gallery.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\product\\desktop-specs-accordion.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\product\\product-quick-view-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\promoted-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\desktop\\quick-filter-pills.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\dropdowns\\account-dropdown.tsx","messages":[{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":97,"column":134,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":97,"endColumn":200}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { HoverCard, HoverCardContent, HoverCardTrigger } from \"@/components/ui/hover-card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { User } from \"@supabase/supabase-js\"\r\nimport { SpinnerGap, UserCircle, Package, Storefront, ChatCircle, Gear, SignOut, CaretRight, CaretDown, Bell } from \"@phosphor-icons/react\"\r\nimport { useState } from \"react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { CountBadge } from \"@/components/shared/count-badge\"\r\n\r\ninterface AccountDropdownProps {\r\n  user: User | null\r\n  variant?: \"icon\" | \"full\"\r\n  className?: string\r\n  /** Notification count to display as badge on avatar */\r\n  notificationCount?: number\r\n}\r\n\r\nexport function AccountDropdown({ user, variant = \"icon\", notificationCount = 0, className }: AccountDropdownProps) {\r\n  const t = useTranslations(\"Header\")\r\n  const tAccount = useTranslations(\"Account\")\r\n  const tAccountDrawer = useTranslations(\"AccountDrawer\")\r\n  const tNotifications = useTranslations(\"NotificationsDropdown\")\r\n  const [isSigningOut, setIsSigningOut] = useState(false)\r\n\r\n  // For non-authenticated users with icon variant, show a simple Sign In link\r\n  if (!user && variant === \"icon\") {\r\n    return (\r\n      <Link href=\"/auth/login\">\r\n        <Button\r\n          variant=\"header-ghost\"\r\n          className={cn(\"h-10 px-3 text-sm font-medium\", className)}\r\n        >\r\n          {t(\"signIn\")}\r\n        </Button>\r\n      </Link>\r\n    )\r\n  }\r\n\r\n  const displayName = user ? (user.user_metadata?.full_name || user.email?.split(\"@\")[0] || \"User\") : t(\"signIn\")\r\n\r\n  const triggerContent = variant === \"full\" ? (\r\n    <div\r\n      className={cn(\r\n        \"h-11 px-3 text-sm font-semibold leading-none rounded-md text-header-text hover:bg-header-hover transition-all flex items-center cursor-pointer gap-1\",\r\n        className\r\n      )}\r\n    >\r\n      <div className=\"flex items-center gap-2\" aria-hidden=\"true\">\r\n        {/* Avatar with notification badge */}\r\n        <div className=\"relative flex items-center justify-center text-header-text-muted\">\r\n          <UserCircle weight=\"fill\" className=\"size-7\" />\r\n          {notificationCount > 0 && (\r\n            <CountBadge\r\n              count={notificationCount}\r\n              className=\"absolute -top-0.5 -right-0.5 bg-notification text-primary-foreground ring-2 ring-header-bg h-4 min-w-4 px-1 text-2xs\"\r\n              aria-hidden=\"true\"\r\n            />\r\n          )}\r\n        </div>\r\n        <div className=\"flex flex-col items-start leading-none gap-0.5\">\r\n          <span className=\"text-xs text-header-text-muted font-normal\">\r\n            {t(\"hello\")}\r\n          </span>\r\n          <span className=\"text-sm font-bold truncate max-w-24 lg:max-w-36\">\r\n            {displayName}\r\n          </span>\r\n        </div>\r\n      </div>\r\n      {/* Dropdown arrow indicator */}\r\n      <CaretDown weight=\"bold\" className=\"size-3 text-header-text-muted ml-0.5\" />\r\n    </div>\r\n  ) : (\r\n    <div\r\n      className={cn(\"inline-flex items-center justify-center rounded-md text-header-text hover:bg-header-hover relative size-11 [&_svg]:size-6 cursor-pointer transition-colors\", className)}\r\n    >\r\n      <UserCircle weight=\"fill\" />\r\n      {notificationCount > 0 && (\r\n        <CountBadge\r\n          count={notificationCount}\r\n          className=\"absolute -top-0.5 -right-0.5 bg-notification text-primary-foreground ring-2 ring-header-bg h-4 min-w-4 px-1 text-2xs\"\r\n          aria-hidden=\"true\"\r\n        />\r\n      )}\r\n    </div>\r\n  )\r\n\r\n  // For authenticated users OR full variant, show the dropdown\r\n  return (\r\n    <HoverCard openDelay={100} closeDelay={200}>\r\n      <HoverCardTrigger asChild>\r\n        <Link\r\n          href={user ? \"/account\" : \"/auth/login\"}\r\n          className=\"block rounded-md outline-none focus-visible:outline-2 focus-visible:outline-ring\"\r\n          aria-label={`${t(\"hello\")}, ${user?.email?.split(\"@\")[0] || t(\"signIn\")}. ${t(\"accountAndLists\")}${notificationCount > 0 ? ` (${notificationCount} ${tNotifications(\"title\").toLowerCase()})` : \"\"}`}\r\n        >\r\n          {triggerContent}\r\n        </Link>\r\n      </HoverCardTrigger>\r\n      <HoverCardContent\r\n        className=\"w-56 p-0 bg-popover text-popover-foreground border border-border z-50 rounded-md overflow-hidden shadow-dropdown\"\r\n        align={variant === \"full\" ? \"start\" : \"end\"}\r\n        sideOffset={8}\r\n        collisionPadding={10}\r\n      >\r\n        {!user ? (\r\n          <div className=\"p-3\">\r\n            <Link href=\"/auth/login\" className=\"block\">\r\n              <Button className=\"w-full bg-primary hover:bg-interactive-hover text-primary-foreground\">\r\n                {t(\"signIn\")}\r\n              </Button>\r\n            </Link>\r\n            <p className=\"text-xs text-muted-foreground text-center mt-2\">\r\n              {t(\"newCustomer\")} <Link href=\"/auth/sign-up\" className=\"text-primary hover:underline\">{t(\"startHere\")}</Link>\r\n            </p>\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {/* User info */}\r\n            <div className=\"px-3 py-2.5 border-b border-border bg-surface-subtle\">\r\n              <p className=\"text-sm font-medium text-foreground truncate\">\r\n                {user.user_metadata?.full_name || user.email?.split(\"@\")[0]}\r\n              </p>\r\n              <p className=\"text-xs text-muted-foreground truncate\">{user.email}</p>\r\n            </div>\r\n\r\n            {/* Navigation links */}\r\n            <nav className=\"py-1\">\r\n              {/* Notifications link with badge */}\r\n              <Link href=\"/account/notifications\" className=\"flex items-center justify-between px-3 py-2 text-sm text-foreground hover:bg-accent\">\r\n                <span className=\"flex items-center gap-2.5\">\r\n                  <Bell size={16} weight=\"regular\" className=\"text-muted-foreground\" />\r\n                  {tNotifications(\"title\")}\r\n                </span>\r\n                {notificationCount > 0 && (\r\n                  <span className=\"text-2xs bg-notification text-primary-foreground px-1.5 py-0.5 rounded-full\">\r\n                    {notificationCount}\r\n                  </span>\r\n                )}\r\n              </Link>\r\n              <Link href=\"/account/orders\" className=\"flex items-center gap-2.5 px-3 py-2 text-sm text-foreground hover:bg-accent\">\r\n                <Package size={16} weight=\"regular\" className=\"text-muted-foreground\" />\r\n                {tAccount(\"header.orders\")}\r\n              </Link>\r\n              <Link href=\"/account/sales\" className=\"flex items-center gap-2.5 px-3 py-2 text-sm text-foreground hover:bg-accent\">\r\n                <Storefront size={16} weight=\"regular\" className=\"text-muted-foreground\" />\r\n                {tAccount(\"header.sales\")}\r\n              </Link>\r\n              <Link href=\"/chat\" className=\"flex items-center gap-2.5 px-3 py-2 text-sm text-foreground hover:bg-accent\">\r\n                <ChatCircle size={16} weight=\"regular\" className=\"text-muted-foreground\" />\r\n                {t(\"messages\")}\r\n              </Link>\r\n              <Link href=\"/account/settings\" className=\"flex items-center gap-2.5 px-3 py-2 text-sm text-foreground hover:bg-accent\">\r\n                <Gear size={16} weight=\"regular\" className=\"text-muted-foreground\" />\r\n                {tAccountDrawer(\"settings\")}\r\n              </Link>\r\n            </nav>\r\n\r\n            {/* Account link */}\r\n            <div className=\"border-t border-border py-1\">\r\n              <Link href=\"/account\" className=\"flex items-center justify-between px-3 py-2 text-sm text-foreground hover:bg-accent\">\r\n                <span>{tAccount(\"header.myAccount\")}</span>\r\n                <CaretRight size={14} weight=\"regular\" className=\"text-muted-foreground\" />\r\n              </Link>\r\n            </div>\r\n\r\n            {/* Sign out */}\r\n            <div className=\"border-t border-border p-2\">\r\n              <form action=\"/api/auth/sign-out\" method=\"post\" onSubmit={() => setIsSigningOut(true)}>\r\n                <Button\r\n                  type=\"submit\"\r\n                  variant=\"ghost\"\r\n                  disabled={isSigningOut}\r\n                  className=\"w-full h-8 justify-start gap-2.5 text-sm text-muted-foreground hover:text-foreground\"\r\n                >\r\n                  {isSigningOut ? (\r\n                    <SpinnerGap size={16} className=\"animate-spin\" />\r\n                  ) : (\r\n                    <SignOut size={16} weight=\"regular\" />\r\n                  )}\r\n                  {t(\"signOut\")}\r\n                </Button>\r\n              </form>\r\n            </div>\r\n          </>\r\n        )}\r\n      </HoverCardContent>\r\n    </HoverCard>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\dropdowns\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\dropdowns\\messages-dropdown.tsx","messages":[{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":100,"column":57,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":100,"endColumn":76}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useCallback } from \"react\"\r\nimport { HoverCard, HoverCardContent, HoverCardTrigger } from \"@/components/ui/hover-card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { User } from \"@supabase/supabase-js\"\r\nimport { ChatCircle, CaretRight } from \"@phosphor-icons/react\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport { CountBadge } from \"@/components/shared/count-badge\"\r\n\r\ninterface MessagesDropdownProps {\r\n  user: User | null\r\n}\r\n\r\nexport function MessagesDropdown({ user }: MessagesDropdownProps) {\r\n  const t = useTranslations(\"MessagesDropdown\")\r\n  const [unreadCount, setUnreadCount] = useState(0)\r\n  const [isOpen, setIsOpen] = useState(false)\r\n\r\n  const fetchUnreadCount = useCallback(async () => {\r\n    if (!user) return\r\n\r\n    try {\r\n      const supabase = createClient()\r\n      const { data, error } = await supabase.rpc(\"get_total_unread_messages\")\r\n      if (!error && typeof data === \"number\") {\r\n        setUnreadCount(data)\r\n      }\r\n    } catch {\r\n      // Keep resilient\r\n    }\r\n  }, [user])\r\n\r\n  // Initial fetch\r\n  useEffect(() => {\r\n    fetchUnreadCount()\r\n  }, [fetchUnreadCount])\r\n\r\n  // Refresh on open\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      fetchUnreadCount()\r\n    }\r\n  }, [isOpen, fetchUnreadCount])\r\n\r\n  // Realtime subscription for conversation updates\r\n  useEffect(() => {\r\n    if (!user) return\r\n\r\n    const supabase = createClient()\r\n    const refresh = () => void fetchUnreadCount()\r\n\r\n    const buyerChannel = supabase\r\n      .channel(`messages-unread-buyer:${user.id}`)\r\n      .on(\r\n        \"postgres_changes\",\r\n        {\r\n          event: \"UPDATE\",\r\n          schema: \"public\",\r\n          table: \"conversations\",\r\n          filter: `buyer_id=eq.${user.id}`,\r\n        },\r\n        refresh\r\n      )\r\n      .subscribe()\r\n\r\n    const sellerChannel = supabase\r\n      .channel(`messages-unread-seller:${user.id}`)\r\n      .on(\r\n        \"postgres_changes\",\r\n        {\r\n          event: \"UPDATE\",\r\n          schema: \"public\",\r\n          table: \"conversations\",\r\n          filter: `seller_id=eq.${user.id}`,\r\n        },\r\n        refresh\r\n      )\r\n      .subscribe()\r\n\r\n    return () => {\r\n      supabase.removeChannel(buyerChannel)\r\n      supabase.removeChannel(sellerChannel)\r\n    }\r\n  }, [user, fetchUnreadCount])\r\n\r\n  if (!user) {\r\n    return null\r\n  }\r\n\r\n  return (\r\n    <HoverCard open={isOpen} onOpenChange={setIsOpen} openDelay={100} closeDelay={200}>\r\n      <HoverCardTrigger asChild>\r\n        <Link\r\n          href=\"/chat\"\r\n          data-testid=\"messages-dropdown\"\r\n          className=\"block rounded-md outline-none focus-visible:outline-2 focus-visible:outline-ring\"\r\n          aria-label={`${t(\"title\")}${unreadCount > 0 ? ` (${unreadCount})` : \"\"}`}\r\n        >\r\n          <div className=\"inline-flex items-center justify-center border border-transparent hover:border-header-text/20 rounded-md text-header-text hover:text-header-text hover:bg-header-hover relative size-11 [&_svg]:size-6 cursor-pointer\">\r\n          <span className=\"relative\" aria-hidden=\"true\">\r\n            <ChatCircle weight=\"regular\" />\r\n            {unreadCount > 0 && (\n              <CountBadge\n                count={unreadCount}\n                className=\"absolute -top-1 -right-1 bg-notification text-primary-foreground ring-2 ring-header-bg h-4.5 min-w-4.5 px-1 text-2xs shadow-sm\"\n                aria-hidden=\"true\"\n              />\n            )}\n          </span>\r\n          </div>\r\n        </Link>\r\n      </HoverCardTrigger>\r\n      <HoverCardContent\r\n        className=\"w-64 p-0 bg-popover text-popover-foreground border border-border z-50 rounded-md overflow-hidden shadow-dropdown\"\r\n        align=\"end\"\r\n        sideOffset={8}\r\n        collisionPadding={10}\r\n      >\r\n        {/* Header */}\r\n        <div className=\"flex items-center gap-2 p-4 bg-muted border-b border-border\">\r\n          <ChatCircle size={20} weight=\"regular\" className=\"text-muted-foreground\" />\r\n          <h3 className=\"font-semibold text-base text-foreground\">{t(\"title\")}</h3>\n          {unreadCount > 0 && (\n            <span className=\"text-xs bg-notification text-primary-foreground px-2 py-0.5 rounded-full\">\n              {unreadCount}\n            </span>\n          )}\n        </div>\n\r\n        {/* Content */}\r\n        <div className=\"p-4\">\r\n          <p className=\"text-sm text-muted-foreground mb-3\">\r\n            {unreadCount > 0\r\n              ? t(\"unreadDescription\", { count: unreadCount })\r\n              : t(\"noMessages\")}\r\n          </p>\r\n        </div>\r\n\r\n        {/* Footer */}\n        <div className=\"p-3 bg-muted border-t border-border\">\n          <Link href=\"/chat\" onClick={() => setIsOpen(false)}>\n            <Button variant=\"cta\" className=\"w-full h-9 text-sm\">\n              {t(\"openInbox\")}\n              <CaretRight size={14} className=\"ml-1\" />\n            </Button>\n          </Link>\n        </div>\n      </HoverCardContent>\r\n    </HoverCard>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\dropdowns\\wishlist-dropdown.tsx","messages":[{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":47,"column":75,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":47,"endColumn":95}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { HoverCard, HoverCardContent, HoverCardTrigger } from \"@/components/ui/hover-card\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useLocale, useTranslations } from \"next-intl\"\r\nimport { Heart } from \"@phosphor-icons/react\"\r\nimport { useEffect, useMemo, useState } from \"react\"\r\n\r\nimport { useWishlist, type WishlistItem } from \"@/components/providers/wishlist-context\"\r\nimport { CountBadge } from \"@/components/shared/count-badge\"\r\nimport { DropdownProductItem } from \"@/components/shared/dropdown-product-item\"\r\n\r\nfunction buildProductUrl(item: WishlistItem) {\r\n  if (!item.username) return \"#\"\r\n  return `/${item.username}/${item.slug || item.product_id}`\r\n}\r\n\r\nexport function WishlistDropdown() {\r\n  const { items, totalItems, removeFromWishlist, isLoading } = useWishlist()\r\n  const t = useTranslations(\"WishlistDropdown\")\r\n  const tNav = useTranslations(\"Navigation\")\r\n  const locale = useLocale()\r\n\r\n  const [mounted, setMounted] = useState(false)\r\n  useEffect(() => {\r\n    setMounted(true)\r\n  }, [])\r\n\r\n  const displayItems = mounted ? totalItems : 0\r\n\r\n  const formatPrice = (price: number) => {\r\n    return new Intl.NumberFormat(locale === \"bg\" ? \"bg-BG\" : \"en-US\", {\r\n      style: \"currency\",\r\n      currency: \"EUR\",\r\n    }).format(price)\r\n  }\r\n\r\n  const topItems = useMemo(() => items.slice(0, 4), [items])\r\n\r\n  return (\r\n    <HoverCard openDelay={100} closeDelay={200}>\r\n      <HoverCardTrigger asChild>\r\n        <Link\r\n          href=\"/account/wishlist\"\r\n          className=\"block rounded-md outline-none focus-visible:outline-2 focus-visible:outline-ring\"\r\n          aria-label={`${tNav(\"wishlist\")}${mounted && displayItems > 0 ? ` (${displayItems})` : \"\"}`}\r\n        >\r\n          <div\r\n            className=\"inline-flex items-center justify-center border border-transparent hover:border-header-text/20 rounded-md text-header-text hover:bg-header-hover relative size-11 [&_svg]:size-6 cursor-pointer\"\r\n          >\r\n            <span className=\"relative\" aria-hidden=\"true\">\r\n              <Heart weight=\"regular\" />\r\n              {mounted && displayItems > 0 && (\r\n                <CountBadge\n                  count={displayItems}\n                  className=\"absolute -top-1 -right-1.5 bg-wishlist-active text-primary-foreground ring-2 ring-header-bg h-4 min-w-4 px-1 text-2xs\"\n                  aria-hidden=\"true\"\n                />\n              )}\n            </span>\n          </div>\r\n        </Link>\r\n      </HoverCardTrigger>\r\n\r\n      <HoverCardContent\r\n        className=\"w-72 p-0 bg-popover text-popover-foreground border border-border z-50 rounded-md overflow-hidden shadow-dropdown\"\r\n        align=\"end\"\r\n        sideOffset={8}\r\n        collisionPadding={10}\r\n      >\r\n        <div className=\"flex items-center justify-between px-3 py-2 bg-muted border-b border-border\">\r\n          <div className=\"flex items-center gap-1.5\">\r\n            <Heart size={16} weight=\"regular\" className=\"text-muted-foreground\" />\r\n            <h3 className=\"font-semibold text-sm text-foreground\">{t(\"title\")}</h3>\r\n            <span className=\"text-xs text-muted-foreground\">({totalItems})</span>\r\n          </div>\r\n        </div>\r\n\r\n        {isLoading ? (\r\n          <div className=\"p-4 text-center text-muted-foreground text-sm\">{t(\"loading\")}</div>\r\n        ) : items.length === 0 ? (\r\n          <div className=\"p-4 text-center\">\r\n            <Heart size={36} weight=\"light\" className=\"text-muted-foreground mx-auto mb-2\" />\r\n            <p className=\"text-muted-foreground text-sm mb-3\">{t(\"empty\")}</p>\r\n            <Link href=\"/search\">\r\n              <Button variant=\"cta\" size=\"default\" className=\"w-full\">\r\n                {t(\"startBrowsing\")}\r\n              </Button>\r\n            </Link>\r\n          </div>\r\n        ) : (\r\n          <>\r\n            <div className=\"max-h-(--spacing-scroll-md) overflow-y-auto\">\r\n              {topItems.map((item) => (\r\n                <DropdownProductItem\r\n                  key={item.id}\r\n                  item={{\r\n                    id: item.id,\r\n                    title: item.title,\r\n                    price: item.price,\r\n                    image: item.image,\r\n                    href: buildProductUrl(item),\r\n                  }}\r\n                  formatPrice={formatPrice}\r\n                  onRemove={() => removeFromWishlist(item.product_id)}\r\n                  removeLabel={t(\"remove\")}\r\n                />\r\n              ))}\r\n              {items.length > 4 && (\r\n                <div className=\"px-2 py-1.5 text-center text-xs text-muted-foreground bg-muted\">\r\n                  +{items.length - 4} {t(\"moreItems\")}\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"px-3 py-2 bg-muted border-t border-border\">\r\n              <Link href=\"/account/wishlist\" className=\"w-full\">\r\n                <Button variant=\"cta\" size=\"default\" className=\"w-full\">\r\n                  {t(\"viewAll\")}\r\n                </Button>\r\n              </Link>\r\n            </div>\r\n          </>\r\n        )}\r\n      </HoverCardContent>\r\n    </HoverCard>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\grid\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\grid\\product-grid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\cookie-consent.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\desktop-shell.server.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'sidebarCollapsible' is assigned a value but never used.","line":44,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * DesktopShell ΓÇö Unified desktop layout with CSS Grid + named areas\n *\n * Server version: keep server pages lean (no forced client boundary).\n * Client surfaces should continue importing `@/components/layout/desktop-shell`.\n */\n\nimport * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nexport interface DesktopShellProps extends React.ComponentProps<\"div\"> {\n  /** Main content (required) */\n  children: React.ReactNode\n  /** Sidebar content - hidden on mobile */\n  sidebar?: React.ReactNode\n  /** Footer content */\n  footer?: React.ReactNode\n  /** Whether sidebar is visible (lg+ only) */\n  sidebarVisible?: boolean\n  /** Whether sidebar is sticky */\n  sidebarSticky?: boolean\n  /** Whether sidebar can be collapsed to icon mode */\n  sidebarCollapsible?: boolean\n  /** Whether sidebar is currently collapsed */\n  sidebarCollapsed?: boolean\n  /** Container variant for background */\n  variant?: \"default\" | \"muted\"\n  /** Additional className for the shell */\n  className?: string\n}\n\nconst variantStyles = {\n  default: \"bg-background\",\n  muted: \"bg-background\",\n} as const\n\nexport function DesktopShell({\n  children,\n  sidebar,\n  footer,\n  sidebarVisible = true,\n  sidebarSticky = true,\n  sidebarCollapsible = false,\n  sidebarCollapsed = false,\n  variant = \"default\",\n  className,\n  ...props\n}: DesktopShellProps) {\n  const hasSidebar = sidebar && sidebarVisible\n  const sidebarWidth = sidebarCollapsed\n    ? \"var(--layout-sidebar-w-collapsed)\"\n    : \"var(--layout-sidebar-w)\"\n\n  return (\n    <div\n      data-slot=\"desktop-shell\"\n      data-sidebar={hasSidebar ? \"visible\" : \"hidden\"}\n      data-sidebar-collapsed={sidebarCollapsed}\n      className={cn(\"min-h-dvh\", variantStyles[variant], className)}\n      style={\n        {\n          \"--shell-sidebar-w\": hasSidebar ? sidebarWidth : \"0px\",\n        } as React.CSSProperties\n      }\n      {...props}\n    >\n      <div className=\"container py-4\">\n        <div\n          className={cn(\n            \"grid items-start\",\n            hasSidebar\n              ? \"grid-cols-1 lg:grid-cols-shell gap-4 lg:gap-(--layout-gap)\"\n              : \"grid-cols-1\",\n          )}\n        >\n          {hasSidebar && (\n            <aside\n              id=\"shell-sidebar\"\n              data-slot=\"shell-sidebar\"\n              className={cn(\n                \"hidden lg:flex flex-col shrink-0 gap-3\",\n                sidebarSticky && [\n                  \"sticky\",\n                  \"top-(--sticky-top)\",\n                  \"self-start\",\n                  \"max-h-(--sidebar-max-h)\",\n                  \"overflow-y-auto\",\n                ],\n              )}\n              tabIndex={-1}\n            >\n              {sidebar}\n            </aside>\n          )}\n\n          <main\n            data-slot=\"shell-content\"\n            className=\"flex-1 min-w-0 @container flex flex-col gap-4\"\n          >\n            {children}\n          </main>\n        </div>\n\n        {footer && (\n          <footer data-slot=\"shell-footer\" className=\"mt-8\">\n            {footer}\n          </footer>\n        )}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\desktop-shell.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'sidebarCollapsible' is assigned a value but never used.","line":69,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":69,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * DesktopShell ΓÇö Unified desktop layout with CSS Grid + named areas\n *\n * This component provides a consistent shell for all desktop pages with:\n * - Named CSS Grid areas for header, sidebar, content, and footer\r\n * - Responsive collapse (sidebar hidden on mobile)\r\n * - Sticky sidebar with safe viewport calculations\r\n * - Container query support on main content area\r\n *\r\n * Grid Template (Desktop lg+):\r\n * ΓöîΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÉ\r\n * Γöé                        [header]                                 Γöé\r\n * Γö£ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓö¼ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöñ\r\n * Γöé   [sidebar]  Γöé                  [content]                       Γöé\r\n * Γöé              Γöé                                                  Γöé\r\n * Γöé              Γöé                                                  Γöé\r\n * Γö£ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓö╝ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöñ\r\n * Γöé   [sidebar]  Γöé                  [footer]                        Γöé\r\n * ΓööΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓö┤ΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÇΓöÿ\r\n *\r\n * Usage:\r\n * ```tsx\r\n * <DesktopShell\r\n *   sidebar={<CategorySidebar />}\r\n *   sidebarSticky\r\n * >\r\n *   <ProductGrid products={products} />\r\n * </DesktopShell>\r\n * ```\n */\n\n\"use client\";\n\nimport * as React from \"react\";\nimport { cn } from \"@/lib/utils\";\n\r\nexport interface DesktopShellProps extends React.ComponentProps<\"div\"> {\r\n  /** Main content (required) */\r\n  children: React.ReactNode;\r\n  /** Sidebar content - hidden on mobile */\r\n  sidebar?: React.ReactNode;\r\n  /** Footer content */\r\n  footer?: React.ReactNode;\r\n  /** Whether sidebar is visible (lg+ only) */\r\n  sidebarVisible?: boolean;\r\n  /** Whether sidebar is sticky */\r\n  sidebarSticky?: boolean;\r\n  /** Whether sidebar can be collapsed to icon mode */\r\n  sidebarCollapsible?: boolean;\r\n  /** Whether sidebar is currently collapsed */\r\n  sidebarCollapsed?: boolean;\r\n  /** Container variant for background */\r\n  variant?: \"default\" | \"muted\";\r\n  /** Additional className for the shell */\r\n  className?: string;\r\n}\r\n\r\nconst variantStyles = {\r\n  default: \"bg-background\",\r\n  muted: \"bg-background\", // Clean white - same as default now\r\n} as const;\r\n\r\nexport function DesktopShell({\r\n  children,\r\n  sidebar,\r\n  footer,\r\n  sidebarVisible = true,\r\n  sidebarSticky = true,\r\n  sidebarCollapsible = false,\r\n  sidebarCollapsed = false,\r\n  variant = \"default\",\r\n  className,\r\n  ...props\r\n}: DesktopShellProps) {\r\n  const hasSidebar = sidebar && sidebarVisible;\r\n  const sidebarWidth = sidebarCollapsed\r\n    ? \"var(--layout-sidebar-w-collapsed)\"\r\n    : \"var(--layout-sidebar-w)\";\r\n\r\n  return (\r\n    <div\r\n      data-slot=\"desktop-shell\"\r\n      data-sidebar={hasSidebar ? \"visible\" : \"hidden\"}\r\n      data-sidebar-collapsed={sidebarCollapsed}\r\n      className={cn(\r\n        \"min-h-dvh\",\r\n        variantStyles[variant],\r\n        className\r\n      )}\r\n      style={\r\n        {\r\n          \"--shell-sidebar-w\": hasSidebar ? sidebarWidth : \"0px\",\r\n        } as React.CSSProperties\r\n      }\r\n      {...props}\r\n    >\r\n      <div className=\"container py-4\">\r\n        <div\r\n          className={cn(\r\n            \"grid items-start\",\n            hasSidebar\n              ? \"grid-cols-1 lg:grid-cols-shell gap-4 lg:gap-(--layout-gap)\"\n              : \"grid-cols-1\"\n          )}\n        >\n          {/* SIDEBAR */}\r\n          {hasSidebar && (\r\n            <aside\r\n              id=\"shell-sidebar\"\r\n              data-slot=\"shell-sidebar\"\r\n              className={cn(\r\n                \"hidden lg:flex flex-col shrink-0 gap-3\",\r\n                sidebarSticky && [\r\n                  \"sticky\",\r\n                  \"top-(--sticky-top)\",\r\n                  \"self-start\",\r\n                  \"max-h-(--sidebar-max-h)\",\r\n                  \"overflow-y-auto\",\r\n                ]\r\n              )}\r\n              tabIndex={-1}\r\n            >\r\n              {sidebar}\r\n            </aside>\r\n          )}\r\n\r\n          {/* MAIN CONTENT */}\r\n          <main\r\n            data-slot=\"shell-content\"\r\n            className=\"flex-1 min-w-0 @container flex flex-col gap-4\"\r\n          >\r\n            {children}\r\n          </main>\r\n        </div>\r\n\r\n        {/* FOOTER */}\r\n        {footer && (\r\n          <footer data-slot=\"shell-footer\" className=\"mt-8\">\r\n            {footer}\r\n          </footer>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n/**\r\n * DesktopShellSkeleton ΓÇö Loading state for DesktopShell\r\n */\r\nexport function DesktopShellSkeleton({\r\n  showSidebar = true,\r\n  sidebarItems = 12,\r\n  contentRows = 16,\r\n}: {\r\n  showSidebar?: boolean;\r\n  sidebarItems?: number;\r\n  contentRows?: number;\r\n}) {\r\n  return (\r\n    <div className=\"min-h-dvh bg-background\">\r\n      <div className=\"container py-4\">\r\n        <div\r\n          className={cn(\r\n            \"grid items-start\",\n            showSidebar\n              ? \"grid-cols-1 lg:grid-cols-layout-sidebar gap-4 lg:gap-(--layout-gap)\"\n              : \"grid-cols-1\"\n          )}\n        >\n          {/* Sidebar skeleton */}\r\n          {showSidebar && (\r\n            <aside className=\"hidden lg:flex flex-col shrink-0\">\r\n              <div className=\"rounded-lg border border-border bg-card p-1.5\">\r\n                {Array.from({ length: sidebarItems }).map((_, i) => (\r\n                  <div\r\n                    key={i}\r\n                    className=\"h-(--sidebar-item-h) w-full rounded-md mb-1 bg-muted animate-pulse\"\r\n                  />\r\n                ))}\r\n              </div>\r\n            </aside>\r\n          )}\r\n\r\n          {/* Content skeleton */}\r\n          <div className=\"flex-1 min-w-0 flex flex-col gap-4\">\r\n            {/* Toolbar skeleton */}\r\n            <div className=\"flex items-center justify-between gap-3\">\r\n              <div className=\"h-5 w-24 bg-muted rounded animate-pulse\" />\r\n              <div className=\"flex items-center gap-2\">\r\n                <div className=\"h-8 w-28 bg-muted rounded-md animate-pulse\" />\r\n                <div className=\"h-8 w-20 bg-muted rounded-md animate-pulse\" />\r\n              </div>\r\n            </div>\r\n\r\n            {/* Product grid skeleton */}\r\n            <div className=\"rounded-xl bg-card border border-border p-4\">\r\n              <div className=\"grid gap-4 grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4\">\r\n                {Array.from({ length: contentRows }).map((_, i) => (\r\n                  <div key={i} className=\"space-y-2\">\r\n                    <div className=\"aspect-square w-full rounded-md bg-muted animate-pulse\" />\r\n                    <div className=\"h-4 w-full bg-muted rounded animate-pulse\" />\r\n                    <div className=\"h-4 w-2/3 bg-muted rounded animate-pulse\" />\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\footer\\site-footer.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'scrollToTop' to the outer scope.","line":85,"column":28,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":85,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Link, usePathname } from \"@/i18n/routing\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport {\r\n    Accordion,\r\n    AccordionContent,\r\n    AccordionItem,\r\n    AccordionTrigger,\r\n} from \"@/components/ui/accordion\"\r\nimport { CaretUp } from \"@phosphor-icons/react\"\r\n\r\n// Social Media Icons (inline SVGs for better performance)\r\nconst FacebookIcon = () => (\r\n    <svg viewBox=\"0 0 24 24\" fill=\"currentColor\" className=\"size-5\">\r\n        <path d=\"M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z\"/>\r\n    </svg>\r\n)\r\n\r\nconst InstagramIcon = () => (\r\n    <svg viewBox=\"0 0 24 24\" fill=\"currentColor\" className=\"size-5\">\r\n        <path d=\"M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z\"/>\r\n    </svg>\r\n)\r\n\r\nconst XIcon = () => (\r\n    <svg viewBox=\"0 0 24 24\" fill=\"currentColor\" className=\"size-5\">\r\n        <path d=\"M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z\"/>\r\n    </svg>\r\n)\r\n\r\nconst YouTubeIcon = () => (\r\n    <svg viewBox=\"0 0 24 24\" fill=\"currentColor\" className=\"size-5\">\r\n        <path d=\"M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z\"/>\r\n    </svg>\r\n)\r\n\r\nconst TikTokIcon = () => (\r\n    <svg viewBox=\"0 0 24 24\" fill=\"currentColor\" className=\"size-5\">\r\n        <path d=\"M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z\"/>\r\n    </svg>\r\n)\r\n\r\nconst PinterestIcon = () => (\r\n    <svg viewBox=\"0 0 24 24\" fill=\"currentColor\" className=\"size-5\">\r\n        <path d=\"M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.162-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.099.12.112.225.085.345-.09.375-.293 1.199-.334 1.363-.053.225-.172.271-.401.165-1.495-.69-2.433-2.878-2.433-4.646 0-3.776 2.748-7.252 7.92-7.252 4.158 0 7.392 2.967 7.392 6.923 0 4.135-2.607 7.462-6.233 7.462-1.214 0-2.354-.629-2.758-1.379l-.749 2.848c-.269 1.045-1.004 2.352-1.498 3.146 1.123.345 2.306.535 3.55.535 6.607 0 11.985-5.365 11.985-11.987C23.97 5.39 18.592.026 11.985.026L12.017 0z\"/>\r\n    </svg>\r\n)\r\n\r\nexport function SiteFooter() {\r\n    const t = useTranslations('Footer')\r\n    const pathname = usePathname()\r\n\r\n    // ==========================================================================\r\n    // 2026 Modern Mobile UX Pattern: App-like Footer Visibility\r\n    // ==========================================================================\r\n    // - Landing/Marketing pages: Full footer visible (for SEO, trust signals)\r\n    // - App pages (browsing, product, cart): Footer HIDDEN on mobile (tab bar replaces it)\r\n    // - Legal/Support pages: Footer visible (EU compliance requirement)\r\n    // - Desktop: Always visible (enough screen real estate)\r\n    //\r\n    // This mimics native e-commerce apps (Vinted, Depop, eBay) that hide\r\n    // traditional footers on mobile to maximize browsing space and use\r\n    // bottom tab bars for navigation instead.\r\n    // ==========================================================================\r\n    \r\n    // Strip locale prefix for route detection\r\n    const pathWithoutLocale = pathname.replace(/^\\/(en|bg)/, \"\") || \"/\"\r\n    \r\n    // Routes where footer should be visible on mobile\n    const footerVisibleRoutes = [\n        \"/\", // Homepage/landing\n        \"/about\", // Company\n        \"/terms\", \"/privacy\", \"/cookies\", \"/accessibility\", // Legal\n        \"/customer-service\", \"/contact\", \"/help\", \"/returns\", \"/security\", \"/feedback\", // Support\n        \"/sellers\", // Business\n    ]\n    \r\n    // Check if current route should show footer on mobile\r\n    const isFooterVisibleOnMobile = footerVisibleRoutes.some(route => {\r\n        if (route === \"/\") return pathWithoutLocale === \"/\"\r\n        return pathWithoutLocale.startsWith(route)\r\n    })\r\n\r\n    const scrollToTop = () => {\r\n        window.scrollTo({ top: 0, behavior: \"smooth\" })\r\n    }\r\n\r\n    const footerSections = [\r\n        {\n            id: \"company\",\n            title: t('company'),\n            links: [\n                { label: t('aboutUsLink'), href: \"/about\" },\n            ]\n        },\n        {\r\n            id: \"help\",\r\n            title: t('help'),\r\n            links: [\r\n                { label: t('helpCenter'), href: \"/customer-service\" },\r\n                { label: t('returns'), href: \"/returns\" },\r\n                { label: t('trackOrders'), href: \"/account/orders\" },\r\n                { label: t('contactUs'), href: \"/contact\" },\r\n                { label: t('securityFraud'), href: \"/security\" },\r\n                { label: t('feedback'), href: \"/feedback\" },\r\n            ]\r\n        },\r\n        {\n            id: \"business\",\n            title: t('sellAndBusiness'),\n            links: [\n                { label: t('sellWithUs'), href: \"/sell\" },\n            ]\n        },\n        {\n            id: \"services\",\n            title: t('services'),\n            links: [\n                { label: t('membershipProgram'), href: \"/plans\" },\n                { label: t('giftCards'), href: \"/gift-cards\" },\n                { label: t('giftRegistry'), href: \"/registry\" },\n                { label: t('accessibility'), href: \"/accessibility\" },\n            ]\n        },\n    ]\r\n\r\n    const socialLinks = [\r\n        { name: \"Pinterest\", href: process.env.NEXT_PUBLIC_SOCIAL_PINTEREST_URL, icon: PinterestIcon },\r\n        { name: \"Facebook\", href: process.env.NEXT_PUBLIC_SOCIAL_FACEBOOK_URL, icon: FacebookIcon },\r\n        { name: \"Instagram\", href: process.env.NEXT_PUBLIC_SOCIAL_INSTAGRAM_URL, icon: InstagramIcon },\r\n        { name: \"X\", href: process.env.NEXT_PUBLIC_SOCIAL_X_URL, icon: XIcon },\r\n        { name: \"YouTube\", href: process.env.NEXT_PUBLIC_SOCIAL_YOUTUBE_URL, icon: YouTubeIcon },\r\n        { name: \"TikTok\", href: process.env.NEXT_PUBLIC_SOCIAL_TIKTOK_URL, icon: TikTokIcon },\r\n    ].filter((social): social is { name: string; href: string; icon: () => React.ReactElement } => {\r\n        return typeof social.href === \"string\" && social.href.trim().length > 0 && social.href.trim() !== \"#\"\r\n    })\r\n\r\n    const legalLinks = [\r\n        { label: t('terms'), href: \"/terms\" },\r\n        { label: t('privacyPolicy'), href: \"/privacy\" },\r\n        { label: t('cookiePolicy'), href: \"/cookies\" },\r\n        { label: t('odr'), href: \"https://ec.europa.eu/consumers/odr\", external: true },\r\n    ]\r\n\r\n    return (\r\n        <footer \n            id=\"footerHeader\" \n            className={`bg-foreground text-background mt-auto w-full pb-tabbar-safe ${\n                isFooterVisibleOnMobile ? '' : 'hidden md:block'\n            }`}\n            role=\"contentinfo\"\n            aria-label={t('footerLabel')}\n        >\n            {/* Back to Top */}\r\n            <button\r\n                className=\"hidden lg:block w-full bg-foreground/90 hover:bg-foreground/80 py-3.5 text-center transition-colors tap-transparent focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-foreground group\"\r\n                onClick={scrollToTop}\r\n                aria-label={t('backToTop')}\r\n            >\r\n                <span className=\"text-sm font-normal text-background inline-flex items-center gap-1.5\">\r\n                    <CaretUp size={16} weight=\"regular\" />\r\n                    {t('backToTop')}\r\n                </span>\r\n            </button>\r\n\r\n            {/* Mobile/Tablet Footer - Accordion */}\r\n            <div className=\"lg:hidden px-4 py-6\">\r\n                <Accordion type=\"single\" collapsible defaultValue=\"help\" className=\"w-full\">\r\n                    {footerSections.map((section) => (\r\n                        <AccordionItem key={section.id} value={section.id} className=\"border-border/20\">\r\n                            <AccordionTrigger className=\"text-sm font-medium text-background hover:no-underline py-4 hover:text-background\">\r\n                                {section.title}\r\n                            </AccordionTrigger>\r\n                            <AccordionContent>\r\n                                <nav aria-label={section.title}>\r\n                                    <ul className=\"flex flex-col gap-3 pb-2\">\r\n                                        {section.links.map((link, linkIndex) => (\r\n                                            <li key={linkIndex}>\r\n                                                <Link \r\n                                                    href={link.href} \r\n                                                    className=\"text-sm text-background/90 hover:text-background transition-colors tap-transparent py-1 inline-block\"\r\n                                                >\r\n                                                    {link.label}\r\n                                                </Link>\r\n                                            </li>\r\n                                        ))}\r\n                                    </ul>\r\n                                </nav>\r\n                            </AccordionContent>\r\n                        </AccordionItem>\r\n                    ))}\r\n                </Accordion>\r\n            </div>\r\n\r\n            {/* Desktop Footer Links - 4-Column Grid */}\r\n            <div className=\"hidden lg:block border-b border-border/20\">\r\n                <div className=\"container py-12\">\r\n                    <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-10\">\r\n                        {footerSections.map((section) => (\r\n                            <div key={section.id}>\r\n                                <h4 className=\"font-medium text-background text-sm mb-4 pb-2 border-b border-border/10\">\r\n                                    {section.title}\r\n                                </h4>\r\n                                <nav aria-label={section.title}>\r\n                                    <ul className=\"space-y-2.5\">\r\n                                        {section.links.map((link, linkIndex) => (\r\n                                            <li key={linkIndex}>\r\n                                                <Link \r\n                                                    href={link.href} \r\n                                                    className=\"text-sm text-background/90 hover:text-background hover:underline underline-offset-2 transition-colors inline-block\"\r\n                                                >\r\n                                                    {link.label}\r\n                                                </Link>\r\n                                            </li>\r\n                                        ))}\r\n                                    </ul>\r\n                                </nav>\r\n                            </div>\r\n                        ))}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Brand Logo, Social Media & Legal Section */}\r\n            <div className=\"container py-10\">\r\n                {/* Logo */}\r\n                <div className=\"flex justify-center mb-4\">\r\n                    <Link href=\"/\" className=\"inline-block group\" aria-label={t('homePage')}>\r\n                        <span className=\"text-3xl font-semibold text-background tracking-tight group-hover:text-background transition-colors\">\r\n                            Treido\r\n                        </span>\r\n                    </Link>\r\n                </div>\r\n\r\n                {/* Social Media Icons (only render if links exist) */}\r\n                {socialLinks.length > 0 ? (\r\n                    <nav aria-label={t('socialMedia')} className=\"flex justify-center gap-3 mb-4\">\r\n                        {socialLinks.map((social) => (\r\n                            <a\r\n                                key={social.name}\r\n                                href={social.href}\r\n                                target=\"_blank\"\r\n                                rel=\"noopener noreferrer\"\r\n                                className=\"size-11 rounded-full bg-background/10 hover:bg-background/20 flex items-center justify-center text-background/70 hover:text-background tap-transparent focus:outline-none focus-visible:ring-2 focus-visible:ring-ring\"\r\n                                aria-label={social.name}\r\n                            >\r\n                                <social.icon />\r\n                            </a>\r\n                        ))}\r\n                    </nav>\r\n                ) : null}\r\n\r\n                {/* Legal Links */}\r\n                <nav aria-label={t('legalLinks')} className=\"flex flex-wrap justify-center gap-x-3 gap-y-1 text-xs text-background/90 mb-3\">\r\n                    {legalLinks.map((link, index) => \r\n                        'external' in link && link.external ? (\r\n                            <a \r\n                                key={index}\r\n                                href={link.href}\r\n                                target=\"_blank\"\r\n                                rel=\"noopener noreferrer\"\r\n                                className=\"min-h-9 flex items-center px-2 hover:text-background hover:underline underline-offset-2 transition-colors whitespace-nowrap\"\r\n                            >\r\n                                {link.label}\r\n                            </a>\r\n                        ) : (\r\n                            <Link \r\n                                key={index}\r\n                                href={link.href} \r\n                                className=\"min-h-9 flex items-center px-2 hover:text-background hover:underline underline-offset-2 transition-colors whitespace-nowrap\"\r\n                            >\r\n                                {link.label}\r\n                            </Link>\r\n                        )\r\n                    )}\r\n                </nav>\r\n\r\n                {/* Company Info - EU Requirement */}\r\n                <p className=\"text-xs text-background/70 text-center mb-4\">\r\n                    {t('companyInfo')}\r\n                </p>\r\n\r\n                {/* Copyright */}\r\n                <p className=\"text-xs text-background/80 text-center\">\r\n                    {t('copyright', { year: new Date().getFullYear() })}\r\n                </p>\r\n            </div>\r\n        </footer>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\app-header.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'hideSubheader' is assigned a value but never used.","line":187,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":187,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'searchPlaceholder' is assigned a value but never used.","line":247,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":247,"endColumn":26},{"ruleId":"sonarjs/no-duplicated-branches","severity":1,"message":"This case's code block is the same as the block for the case on line 296.","line":359,"column":7,"nodeType":"SwitchCase","messageId":"sameConditionalBlock","endLine":371,"endColumn":10}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\n// =============================================================================\r\n// APP HEADER ΓÇö Main entry point for all header variants\r\n//\r\n// Single source of truth for headers across the app.\r\n// Uses CSS-based responsive design (md:hidden / hidden md:block).\r\n// Auto-detects route via usePathname() and renders appropriate variant.\r\n// Uses HeaderContext for dynamic props from pages.\r\n//\r\n// Variants:\r\n// - default:    Standard pages (hamburger + logo + search below + actions)\r\n// - homepage:   Homepage (inline search + category pills on mobile)\r\n// - product:    Product pages (back + seller + share on mobile)\r\n// - contextual: Category browsing (back + title + subcategory circles)\r\n// - minimal:    Auth/checkout (just logo)\r\n// =============================================================================\r\n\r\nimport {\r\n  MobileHomepageHeader,\r\n  MobileProductHeader,\r\n  MobileContextualHeader,\r\n  MobileProfileHeader,\r\n  MobileMinimalHeader,\r\n} from \"./mobile\"\r\nimport {\r\n  DesktopStandardHeader,\r\n  DesktopMinimalHeader,\r\n} from \"./desktop\"\r\nimport { MobileSearchOverlay } from \"@/components/shared/search/mobile-search-overlay\"\r\nimport { useHeaderOptional } from \"@/components/providers/header-context\"\r\nimport { useAuthOptional } from \"@/components/providers/auth-state-manager\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { useEffect, useRef, useState } from \"react\"\r\nimport { useRouter, usePathname } from \"@/i18n/routing\"\r\nimport { useLocale, useTranslations } from \"next-intl\"\r\nimport type { User } from \"@supabase/supabase-js\"\r\nimport type { CategoryTreeNode } from \"@/lib/category-tree\"\r\nimport type { UserListingStats } from \"@/components/layout/sidebar/sidebar-menu\"\r\nimport type { HeaderVariant } from \"./types\"\r\n\r\n// =============================================================================\r\n// Props\r\n// =============================================================================\r\n\r\nexport interface AppHeaderProps {\r\n  /** Header rendering variant */\r\n  variant?: HeaderVariant\r\n  /** Authenticated user */\r\n  user: User | null\r\n  /** Categories for navigation */\r\n  categories?: CategoryTreeNode[]\r\n  /** User listing stats for hamburger menu footer */\r\n  userStats?: UserListingStats\r\n  \r\n  // Homepage variant props\r\n  /** Active category slug for homepage pills */\r\n  activeCategory?: string\r\n  /** Callback when category pill is selected */\r\n  onCategorySelect?: (slug: string) => void\r\n  /** Callback to open search overlay */\r\n  onSearchOpen?: () => void\r\n  \r\n  // Product variant props\r\n  /** Product title for product header */\r\n  productTitle?: string | null\r\n  /** Seller name for product header */\r\n  sellerName?: string | null\r\n  /** Seller username for profile link */\r\n  sellerUsername?: string | null\r\n  /** Seller avatar URL */\r\n  sellerAvatarUrl?: string | null\r\n  /** Product ID for wishlist */\r\n  productId?: string | null\r\n  /** Product price for wishlist */\r\n  productPrice?: number | null\r\n  /** Product image for wishlist */\r\n  productImage?: string | null\r\n  \r\n  // Contextual variant props\r\n  /** Title for contextual header (category name) */\r\n  contextualTitle?: string\r\n  /** Active category slug (for subtle active highlight during instant navigation). */\r\n  contextualActiveSlug?: string\r\n  /** Back href for contextual header */\r\n  contextualBackHref?: string\r\n  /** Back handler for instant navigation */\r\n  onContextualBack?: () => void\r\n  /** Subcategories for contextual circles */\r\n  contextualSubcategories?: CategoryTreeNode[]\r\n  /** Callback when subcategory circle is clicked */\r\n  onSubcategoryClick?: (cat: CategoryTreeNode) => void\r\n  \r\n  // Legacy props (for gradual migration)\r\n  hideSubheader?: boolean\r\n  hideOnMobile?: boolean\r\n  hideOnDesktop?: boolean\r\n}\r\n\r\n// Re-export types\r\nexport type { HeaderVariant } from \"./types\"\r\n\r\n// =============================================================================\r\n// Route Detection Helper\r\n// =============================================================================\r\n\r\ntype RouteConfig = {\r\n  variant: HeaderVariant\r\n}\r\n\r\nfunction detectRouteConfig(pathname: string, explicitVariant?: HeaderVariant): RouteConfig {\r\n  // If explicit variant is provided, use it\r\n  if (explicitVariant) {\r\n    return { variant: explicitVariant }\r\n  }\r\n  \r\n  // Strip locale prefix (e.g., /en, /bg)\r\n  const pathWithoutLocale = pathname.replace(/^\\/(en|bg)/, \"\") || \"/\"\r\n  \r\n  // Homepage: / or empty\r\n  if (pathWithoutLocale === \"/\" || pathWithoutLocale === \"\") {\r\n    return { variant: \"homepage\" }\r\n  }\r\n  \r\n  // Categories: /categories or /categories/* \r\n  if (pathWithoutLocale.startsWith(\"/categories\")) {\r\n    return { variant: \"contextual\" }\r\n  }\r\n  \r\n  // Assistant: /assistant - AI shopping assistant\r\n  if (pathWithoutLocale.startsWith(\"/assistant\")) {\r\n    return { variant: \"contextual\" }\r\n  }\r\n\r\n  // Search: reuse the homepage mobile header (inline search) to avoid the legacy \"search bar under header\" layout\r\n  if (pathWithoutLocale.startsWith(\"/search\")) {\r\n    return { variant: \"homepage\" }\r\n  }\r\n  \r\n  // Known routes start with: /search, /cart, /checkout, /account, /sell, /plans, /auth\r\n  const segments = pathWithoutLocale.split(\"/\").filter(Boolean)\r\n  const knownRoutes = [\"search\", \"cart\", \"checkout\", \"account\", \"sell\", \"plans\", \"auth\", \"categories\", \"api\", \"assistant\"]\r\n  \r\n  // Product pages: /{username}/{productSlug} (2+ segments, not a known route)\r\n  if (segments.length >= 2 && segments[0] && !knownRoutes.includes(segments[0])) {\r\n    return { variant: \"product\" }\r\n  }\r\n  \r\n  // Profile pages: /{username} (1 segment, not a known route) - use profile header\r\n  if (segments.length === 1 && segments[0] && !knownRoutes.includes(segments[0])) {\r\n    return { variant: \"profile\" }\r\n  }\r\n  \r\n  // Default for everything else\r\n  return { variant: \"default\" }\r\n}\r\n\r\n// =============================================================================\r\n// Main Component\r\n// =============================================================================\r\n\r\nexport function AppHeader({\r\n  variant: explicitVariant,\r\n  user,\r\n  categories = [],\r\n  userStats,\r\n  // Homepage props\r\n  activeCategory = \"all\",\r\n  onCategorySelect,\r\n  onSearchOpen,\r\n  // Product props\r\n  productTitle,\r\n  sellerName,\r\n  sellerUsername,\r\n  sellerAvatarUrl,\r\n  productId,\r\n  productPrice,\r\n  productImage,\r\n  // Contextual props\r\n  contextualTitle,\r\n  contextualActiveSlug,\r\n  contextualBackHref = \"/categories\",\r\n  onContextualBack,\r\n  contextualSubcategories = [],\r\n  onSubcategoryClick,\r\n  // Legacy\r\n  hideSubheader = false,\r\n  hideOnMobile = false,\r\n  hideOnDesktop = false,\r\n}: AppHeaderProps) {\r\n  const auth = useAuthOptional()\r\n  const effectiveUser = auth ? (auth.isLoading ? user : auth.user) : user\r\n\r\n  const [isMobileSearchOpen, setIsMobileSearchOpen] = useState(false)\r\n  const [isHydrated, setIsHydrated] = useState(false)\r\n  const headerRef = useRef<HTMLElement>(null)\r\n  const locale = useLocale()\r\n  const tNav = useTranslations(\"Navigation\")\r\n  const router = useRouter()\r\n  const pathname = usePathname()\r\n  \r\n  // Get dynamic header state from context (if provided by pages)\r\n  const headerContext = useHeaderOptional()\r\n  \r\n  // Auto-detect route config from pathname\r\n  const routeConfig = detectRouteConfig(pathname, explicitVariant)\r\n  const variant = routeConfig.variant\r\n\r\n  // Merge props with context values (context takes precedence for dynamic state)\r\n  const effectiveHomepageCategory = headerContext?.homepageHeader?.activeCategory ?? activeCategory\r\n  const effectiveHomepageCategorySelect = headerContext?.homepageHeader?.onCategorySelect ?? onCategorySelect\r\n  const effectiveHomepageSearchOpen = headerContext?.homepageHeader?.onSearchOpen ?? onSearchOpen\r\n  const effectiveHomepageCategories = headerContext?.homepageHeader?.categories ?? categories\r\n  \r\n  // Avoid hydration mismatch when other client boundaries update HeaderProvider state\r\n  // before the header boundary itself hydrates (e.g., ProductHeaderSync on PDP).\r\n  const hydratedContextualHeader = isHydrated ? headerContext?.contextualHeader : null\r\n  const effectiveContextualTitle = hydratedContextualHeader?.title ?? contextualTitle\r\n  const effectiveContextualActiveSlug =\r\n    hydratedContextualHeader?.activeSlug ?? contextualActiveSlug\r\n  const effectiveContextualBackHref = hydratedContextualHeader?.backHref ?? contextualBackHref\r\n  const effectiveContextualBack = hydratedContextualHeader?.onBack ?? onContextualBack\r\n  const effectiveContextualSubcategories =\r\n    hydratedContextualHeader?.subcategories ?? contextualSubcategories\r\n  const effectiveContextualSubcategoryClick =\r\n    hydratedContextualHeader?.onSubcategoryClick ?? onSubcategoryClick\r\n  const effectiveContextualHideActions = hydratedContextualHeader?.hideActions ?? false\r\n\r\n  const hydratedProductHeader = isHydrated ? headerContext?.productHeader : null\r\n  const effectiveProductTitle = hydratedProductHeader?.productTitle ?? productTitle\r\n  const effectiveSellerName = hydratedProductHeader?.sellerName ?? sellerName\r\n  const effectiveSellerUsername = hydratedProductHeader?.sellerUsername ?? sellerUsername\r\n  const effectiveSellerAvatarUrl = hydratedProductHeader?.sellerAvatarUrl ?? sellerAvatarUrl\r\n  const effectiveProductId = hydratedProductHeader?.productId ?? productId\r\n  const effectiveProductPrice = hydratedProductHeader?.productPrice ?? productPrice\r\n  const effectiveProductImage = hydratedProductHeader?.productImage ?? productImage\r\n\r\n  // Profile header context (for profile pages)\r\n  const hydratedProfileHeader = isHydrated ? headerContext?.profileHeader : null\r\n  const effectiveProfileDisplayName = hydratedProfileHeader?.displayName ?? null\r\n  const effectiveProfileUsername = hydratedProfileHeader?.username ?? null\r\n  const effectiveProfileAvatarUrl = hydratedProfileHeader?.avatarUrl ?? null\r\n  const effectiveProfileIsOwn = hydratedProfileHeader?.isOwnProfile ?? false\r\n  const effectiveProfileIsFollowing = hydratedProfileHeader?.isFollowing ?? false\r\n  const effectiveProfileSellerId = hydratedProfileHeader?.sellerId ?? null\r\n\r\n  const searchPlaceholder = tNav(\"searchPlaceholderShort\")\r\n\r\n  // Mark header as hydrated for E2E tests\r\n  useEffect(() => {\r\n    headerRef.current?.setAttribute(\"data-hydrated\", \"true\")\r\n    setIsHydrated(true)\r\n  }, [])\r\n\r\n  // Mobile header is fixed (not sticky) to avoid scroll-lock breaking sticky positioning\r\n  // when drawers/sheets open. Keep content alignment via a measured CSS var.\r\n  useEffect(() => {\r\n    const headerEl = headerRef.current\r\n    if (!headerEl) return\r\n\r\n    const updateOffset = () => {\r\n      const height = headerEl.getBoundingClientRect().height\r\n      if (!Number.isFinite(height) || height <= 0) return\r\n      document.documentElement.style.setProperty(\"--app-header-offset\", `${Math.ceil(height)}px`)\r\n    }\r\n\r\n    updateOffset()\r\n\r\n    const ro = new ResizeObserver(() => {\r\n      updateOffset()\r\n    })\r\n    ro.observe(headerEl)\r\n\r\n    return () => {\r\n      ro.disconnect()\r\n    }\r\n  }, [])\r\n\r\n  // Handle search open\r\n  const handleSearchOpen = () => {\r\n    if (effectiveHomepageSearchOpen) {\r\n      effectiveHomepageSearchOpen()\r\n    } else if (onSearchOpen) {\r\n      onSearchOpen()\r\n    } else {\r\n      setIsMobileSearchOpen(true)\r\n    }\r\n  }\r\n\r\n  // ==========================================================================\r\n  // MOBILE HEADER VARIANTS\r\n  // ==========================================================================\r\n\r\n  const renderMobileHeader = () => {\r\n    switch (variant) {\r\n      case \"homepage\":\r\n        return (\r\n          <MobileHomepageHeader\r\n            user={effectiveUser}\r\n            categories={effectiveHomepageCategories}\r\n            userStats={userStats}\r\n            activeCategory={effectiveHomepageCategory}\r\n            onCategorySelect={effectiveHomepageCategorySelect}\r\n            onSearchOpen={handleSearchOpen}\r\n            locale={locale}\r\n          />\r\n        )\r\n      case \"product\":\r\n        return (\r\n          <MobileProductHeader\r\n            user={effectiveUser}\r\n            categories={categories}\r\n            userStats={userStats}\r\n            productTitle={effectiveProductTitle}\r\n            sellerName={effectiveSellerName}\r\n            sellerUsername={effectiveSellerUsername}\r\n            sellerAvatarUrl={effectiveSellerAvatarUrl}\r\n            productId={effectiveProductId}\r\n            productPrice={effectiveProductPrice}\r\n            productImage={effectiveProductImage}\r\n            onBack={() => router.back()}\r\n            locale={locale}\r\n          />\r\n        )\r\n      case \"profile\":\r\n        return (\r\n          <MobileProfileHeader\r\n            user={effectiveUser}\r\n            categories={categories}\r\n            userStats={userStats}\r\n            displayName={effectiveProfileDisplayName}\r\n            username={effectiveProfileUsername}\r\n            avatarUrl={effectiveProfileAvatarUrl}\r\n            isOwnProfile={effectiveProfileIsOwn}\r\n            isFollowing={effectiveProfileIsFollowing}\r\n            sellerId={effectiveProfileSellerId}\r\n            onBack={() => router.back()}\r\n            locale={locale}\r\n          />\r\n        )\r\n      case \"contextual\":\r\n        return (\r\n          <MobileContextualHeader\r\n            user={effectiveUser}\r\n            categories={categories}\r\n            userStats={userStats}\r\n            title={effectiveContextualTitle}\r\n            activeSlug={effectiveContextualActiveSlug}\r\n            backHref={effectiveContextualBackHref}\r\n            onBack={effectiveContextualBack}\r\n            subcategories={effectiveContextualSubcategories}\r\n            onSubcategoryClick={effectiveContextualSubcategoryClick}\r\n            hideActions={effectiveContextualHideActions}\r\n            locale={locale}\r\n          />\r\n        )\r\n      case \"minimal\":\r\n        return <MobileMinimalHeader locale={locale} />\r\n      default:\r\n        // Fallback to homepage header (inline search + pills)\r\n        return (\r\n          <MobileHomepageHeader\r\n            user={effectiveUser}\r\n            categories={effectiveHomepageCategories}\r\n            userStats={userStats}\r\n            activeCategory={effectiveHomepageCategory}\r\n            onCategorySelect={effectiveHomepageCategorySelect}\r\n            onSearchOpen={handleSearchOpen}\r\n            locale={locale}\r\n          />\r\n        )\r\n    }\r\n  }\r\n\r\n  // ==========================================================================\r\n  // DESKTOP HEADER VARIANTS\r\n  // ==========================================================================\r\n\r\n  const renderDesktopHeader = () => {\r\n    // Minimal shows simplified desktop header\r\n    if (variant === \"minimal\") return <DesktopMinimalHeader locale={locale} />\r\n    // Homepage, contextual, and default use standard desktop layout\r\n    return <DesktopStandardHeader user={effectiveUser} locale={locale} />\r\n  }\r\n\r\n  // ==========================================================================\r\n  // RENDER\r\n  // ==========================================================================\r\n\r\n  // Hide conditions\r\n  const shouldHide = hideOnMobile && hideOnDesktop\r\n\r\n  if (shouldHide) return null\r\n\r\n  return (\r\n    <>\r\n      <header\r\n        ref={headerRef}\r\n        data-slot=\"app-header\"\r\n        className={cn(\r\n          \"fixed inset-x-0 top-0 z-40 w-full flex flex-col md:sticky\",\r\n          variant !== \"homepage\" && variant !== \"contextual\" && \"bg-header-bg\",\r\n          hideOnMobile && \"hidden md:flex md:flex-col\",\r\n          hideOnDesktop && \"md:hidden\"\r\n        )}\r\n      >\r\n        {renderMobileHeader()}\r\n        {renderDesktopHeader()}\r\n      </header>\r\n\r\n      {/* Search Overlay - for variants that use internal search state */}\r\n      {(variant === \"default\" || (!effectiveHomepageSearchOpen && !onSearchOpen)) && (\r\n        <MobileSearchOverlay\r\n          hideDefaultTrigger\r\n          externalOpen={isMobileSearchOpen}\r\n          onOpenChange={setIsMobileSearchOpen}\r\n        />\r\n      )}\r\n    </>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\cart\\cart-dropdown.tsx","messages":[{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":45,"column":71,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":45,"endColumn":138}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { HoverCard, HoverCardContent, HoverCardTrigger } from \"@/components/ui/hover-card\"\nimport { Button } from \"@/components/ui/button\"\nimport { IconButton } from \"@/components/ui/icon-button\"\nimport { Link } from \"@/i18n/routing\"\nimport { useTranslations, useLocale } from \"next-intl\"\nimport { useCart, type CartItem } from \"@/components/providers/cart-context\"\nimport { ShoppingCart, Package, Minus, Plus, Trash } from \"@phosphor-icons/react\"\nimport Image from \"next/image\"\r\nimport { useState, useEffect, useCallback } from \"react\"\r\nimport { CountBadge } from \"@/components/shared/count-badge\"\r\n\r\nexport function CartDropdown() {\n  const { items, totalItems, isReady, subtotal, removeFromCart, updateQuantity } = useCart()\n  const t = useTranslations(\"CartDropdown\")\n  const tNav = useTranslations(\"Navigation\")\n  const locale = useLocale()\n  const [mounted, setMounted] = useState(false)\n  useEffect(() => {\n    setMounted(true)\n  }, [])\n\n  const displayItems = mounted && isReady ? totalItems : 0\n\r\n  const buildProductUrl = useCallback((item: CartItem) => {\r\n    const sellerSlug = item.username ?? item.storeSlug\r\n    if (!sellerSlug) return \"#\"\r\n    return `/${sellerSlug}/${item.slug || item.id}`\r\n  }, [])\r\n\r\n  const formatPrice = (price: number) => {\r\n    return new Intl.NumberFormat(locale === \"bg\" ? \"bg-BG\" : \"en-US\", {\r\n      style: \"currency\",\r\n      currency: \"EUR\",\r\n    }).format(price)\r\n  }\r\n\r\n  return (\r\n    <HoverCard openDelay={100} closeDelay={200}>\r\n      <HoverCardTrigger asChild>\r\n        <Link\r\n          href=\"/cart\"\r\n          className=\"block rounded-md outline-none focus-visible:outline-2 focus-visible:outline-ring\"\r\n          aria-label={`${tNav(\"cart\")}${mounted && displayItems > 0 ? ` (${displayItems} ${displayItems === 1 ? t(\"item\") : t(\"items\")})` : \"\"}`}\r\n        >\r\n          <div className=\"inline-flex items-center justify-center border border-transparent hover:border-header-text/20 rounded-md text-header-text hover:bg-header-hover relative size-10 [&_svg]:size-6 cursor-pointer\">\r\n            <span className=\"relative\" aria-hidden=\"true\">\r\n              <ShoppingCart weight=\"regular\" />\r\n              {mounted && displayItems > 0 && (\n                <CountBadge\n                  count={displayItems}\n                  className=\"absolute -top-1 -right-1.5 bg-cart-badge text-primary-foreground ring-2 ring-header-bg h-4 min-w-4 px-1 text-2xs\"\n                  aria-hidden=\"true\"\n                />\n              )}\n            </span>\n          </div>\n        </Link>\n      </HoverCardTrigger>\n      <HoverCardContent\r\n        className=\"w-80 p-0 bg-popover text-popover-foreground border border-border z-50 rounded-md overflow-hidden shadow-dropdown\"\r\n        align=\"end\"\r\n        sideOffset={8}\r\n        collisionPadding={10}\r\n      >\r\n        <div className=\"flex items-center justify-between px-3 py-2 bg-muted border-b border-border\">\r\n          <div className=\"flex items-center gap-1.5\">\n            <ShoppingCart size={16} weight=\"regular\" className=\"text-muted-foreground\" />\n            <h3 className=\"font-semibold text-sm text-foreground\">{t(\"title\")}</h3>\n            <span className=\"text-xs text-muted-foreground\">({displayItems})</span>\n          </div>\n        </div>\n\r\n        {items.length === 0 ? (\r\n          <div className=\"p-3 text-center\">\n            <ShoppingCart size={36} weight=\"light\" className=\"text-muted-foreground mx-auto mb-2\" />\r\n            <p className=\"text-muted-foreground text-sm mb-3\">{t(\"empty\")}</p>\r\n            <Button variant=\"cta\" size=\"default\" className=\"w-full\" asChild>\r\n              <Link href=\"/search\">\r\n                {t(\"startShopping\")}\r\n              </Link>\r\n            </Button>\r\n          </div>\r\n        ) : (\r\n          <>\r\n            <div className=\"max-h-(--spacing-scroll-md) overflow-y-auto\">\r\n              {items.slice(0, 4).map((item) => (\r\n                <div key={`${item.id}:${item.variantId ?? \"\"}`} className=\"flex gap-1.5 p-1.5 border-b border-border hover:bg-hover active:bg-active\">\n                  <Link href={buildProductUrl(item)} className=\"shrink-0\">\r\n                    <div className=\"size-12 bg-muted rounded-md overflow-hidden border border-border\">\r\n                      {item.image ? (\r\n                        <Image\r\n                          src={item.image}\r\n                          alt={item.title}\r\n                          width={48}\r\n                          height={48}\r\n                          className=\"size-full object-cover\"\r\n                        />\r\n                      ) : (\r\n                        <div className=\"size-full flex items-center justify-center text-muted-foreground\">\r\n                          <Package size={18} weight=\"regular\" />\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  </Link>\r\n                  <div className=\"flex-1 min-w-0\">\r\n                    <Link\n                      href={buildProductUrl(item)}\n                      className=\"text-sm text-foreground hover:text-primary line-clamp-2 leading-snug\"\n                    >\n                      {item.title}\n                    </Link>\n                    {item.variantName && (\r\n                      <div className=\"text-xs text-muted-foreground mt-0.5 line-clamp-1\">\r\n                        {item.variantName}\r\n                      </div>\r\n                    )}\r\n                    <div className=\"mt-1 flex items-center gap-1\">\n                      <span className=\"text-sm font-semibold text-foreground\">{formatPrice(item.price)}</span>\r\n                    </div>\r\n                    <div className=\"flex items-center justify-between gap-2 mt-1\">\n                      <div className=\"flex items-center gap-1\">\n                        <IconButton\n                          onClick={(e) => {\n                            e.preventDefault()\n                            if (item.quantity > 1) {\n                              updateQuantity(item.id, item.quantity - 1, item.variantId)\n                            } else {\n                              removeFromCart(item.id, item.variantId)\n                            }\n                          }}\n                          size=\"icon-lg\"\n                          variant=\"ghost\"\n                          className=\"hover:bg-muted text-muted-foreground hover:text-foreground\"\n                          aria-label={t(\"decreaseQuantity\")}\n                        >\n                          <Minus weight=\"bold\" />\n                        </IconButton>\n                        <span className=\"text-xs font-medium text-foreground min-w-touch text-center\">\n                          {item.quantity}\n                        </span>\n                        <IconButton\n                          onClick={(e) => {\n                            e.preventDefault()\n                            updateQuantity(item.id, item.quantity + 1, item.variantId)\n                          }}\n                          size=\"icon-lg\"\n                          variant=\"ghost\"\n                          className=\"hover:bg-muted text-muted-foreground hover:text-foreground\"\n                          aria-label={t(\"increaseQuantity\")}\n                        >\n                          <Plus weight=\"bold\" />\n                        </IconButton>\n                      </div>\n                      <IconButton\n                        onClick={(e) => {\n                          e.preventDefault()\n                          removeFromCart(item.id, item.variantId)\n                        }}\n                        size=\"icon-lg\"\n                        variant=\"ghost\"\n                        className=\"hover:bg-destructive-subtle text-muted-foreground hover:text-destructive\"\n                        aria-label={t(\"removeItem\")}\n                      >\n                        <Trash weight=\"regular\" />\n                      </IconButton>\n                    </div>\n                  </div>\r\n                </div>\r\n              ))}\r\n              {items.length > 4 && (\r\n                <div className=\"px-2 py-1.5 text-center text-xs text-muted-foreground bg-muted\">\r\n                  +{items.length - 4} {t(\"moreItems\")}\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"px-3 py-2 bg-muted border-t border-border\">\r\n              <div className=\"flex items-center justify-between mb-2\">\r\n                <span className=\"text-xs text-muted-foreground\">{t(\"subtotal\")}</span>\r\n                <span className=\"text-base font-semibold text-foreground\">{formatPrice(subtotal)}</span>\r\n              </div>\r\n              <div className=\"flex gap-1.5\">\n                <Button variant=\"outline\" size=\"default\" className=\"w-full flex-1\" asChild>\r\n                  <Link href=\"/cart\">\r\n                    {t(\"viewCart\")}\r\n                  </Link>\r\n                </Button>\r\n                <Button variant=\"cta\" size=\"default\" className=\"w-full flex-1\" asChild>\r\n                  <Link href=\"/checkout\">\r\n                    {t(\"checkout\")}\r\n                  </Link>\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </>\r\n        )}\r\n      </HoverCardContent>\r\n    </HoverCard>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\cart\\mobile-cart-dropdown.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\dashboard-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\desktop\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\desktop\\minimal-header.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'locale' is defined but never used.","line":13,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":46}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Link } from \"@/i18n/routing\"\r\nimport type { MinimalHeaderProps } from \"../types\"\r\n\r\n/**\r\n * Desktop Minimal Header\r\n * \r\n * Minimal desktop header with just the logo centered.\r\n * \r\n * Used for: Auth pages, checkout (desktop only)\r\n */\r\nexport function DesktopMinimalHeader({ locale }: MinimalHeaderProps) {\r\n  return (\r\n    <div className=\"hidden md:block bg-header-bg border-b border-header-border\">\r\n      <div className=\"container h-16 flex items-center justify-center\">\r\n        <Link href=\"/\">\r\n          <span className=\"text-xl font-bold tracking-tight text-header-text\">treido.</span>\r\n        </Link>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\desktop\\standard-header.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'locale' is defined but never used.","line":30,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":30,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport {\r\n  AccountDropdown,\r\n  MessagesDropdown,\r\n  WishlistDropdown,\r\n} from \"@/components/dropdowns\"\r\nimport { CartDropdown } from \"@/components/layout/header/cart/cart-dropdown\"\r\nimport { DesktopSearch } from \"@/components/desktop/desktop-search\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Camera } from \"@phosphor-icons/react\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { useNotificationCount } from \"@/hooks/use-notification-count\"\r\nimport type { BaseHeaderProps } from \"../types\"\r\n\r\n/**\r\n * Desktop Standard Header\r\n * \r\n * Production-ready desktop header with:\r\n * - Logo + Account (with notification badge + arrow) on left\r\n * - Search bar in center (dominant element)\r\n * - Messages, Wishlist, Cart, Sell CTA on right\r\n * \r\n * Design: Subtle background tint + bottom border for visual containment\r\n * Pattern: Notification badge merged into Account avatar (saves icon slot)\r\n */\r\nexport function DesktopStandardHeader({\r\n  user,\r\n  locale,\r\n}: BaseHeaderProps) {\r\n  const t = useTranslations(\"Navigation\")\r\n  const notificationCount = useNotificationCount(user)\r\n\r\n  return (\r\n    <header className=\"hidden md:block bg-header-bg text-header-text border-b border-header-border\">\r\n      <div className=\"container h-16 flex items-center justify-between gap-6\">\r\n        {/* Left: Logo + Account (with notification badge) */}\r\n        <div className=\"flex items-center gap-3\">\r\n          <Link href=\"/\" className=\"flex items-center shrink-0\">\r\n            <span className=\"text-xl font-bold tracking-tight text-header-text\">treido.</span>\r\n          </Link>\r\n          <div className=\"hidden lg:block\">\r\n            <AccountDropdown user={user} variant=\"full\" notificationCount={notificationCount} />\r\n          </div>\r\n        </div>\r\n\r\n        {/* Center: Search (dominant element) */}\r\n        <div className=\"flex-1 max-w-2xl\">\r\n          <DesktopSearch />\r\n        </div>\r\n\r\n        {/* Right: Actions */}\r\n        <div className=\"flex items-center gap-1\">\r\n          {user ? (\r\n            <>\r\n              {/* Messages */}\r\n              <MessagesDropdown user={user} />\r\n              \r\n              {/* Commerce: Wishlist + Cart */}\r\n              <WishlistDropdown />\r\n              <CartDropdown />\r\n              \r\n              {/* Primary CTA: Create Listing */}\r\n              <Button variant=\"secondary\" size=\"sm\" className=\"ml-2\" asChild>\r\n                <Link href=\"/sell\">\r\n                  <Camera weight=\"regular\" className=\"size-4\" />\r\n                  <span className=\"hidden xl:inline\">{t(\"createListing\")}</span>\r\n                </Link>\r\n              </Button>\r\n              \r\n              {/* Account on medium screens (when full variant is hidden) */}\r\n              <div className=\"hidden md:block lg:hidden ml-1\">\r\n                <AccountDropdown user={user} notificationCount={notificationCount} />\r\n              </div>\r\n            </>\r\n          ) : (\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button variant=\"header-ghost\" size=\"sm\" asChild>\r\n                <Link href=\"/auth/login\">{t(\"signIn\")}</Link>\r\n              </Button>\r\n              <Button variant=\"secondary\" size=\"sm\" asChild>\r\n                <Link href=\"/auth/sign-up\">{t(\"register\")}</Link>\r\n              </Button>\r\n              <CartDropdown />\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </header>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\minimal-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\mobile\\contextual-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\mobile\\homepage-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\mobile\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\mobile\\minimal-header.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'locale' is defined but never used.","line":13,"column":39,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Link } from \"@/i18n/routing\"\r\nimport type { MinimalHeaderProps } from \"../types\"\r\n\r\n/**\r\n * Mobile Minimal Header\r\n * \r\n * Minimal header with just the logo centered.\r\n * \r\n * Used for: Auth pages, checkout (mobile only)\r\n */\r\nexport function MobileMinimalHeader({ locale }: MinimalHeaderProps) {\n  return (\n    <div className=\"border-b border-border-subtle bg-background pt-safe md:hidden\">\n      <div className=\"flex h-(--control-primary) items-center justify-center px-4\">\n        <Link href=\"/\">\n          <span className=\"text-lg font-extrabold tracking-tight text-foreground\">treido.</span>\n        </Link>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\mobile\\product-header.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'locale' is defined but never used.","line":32,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":32,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { IconButton } from \"@/components/ui/icon-button\"\r\nimport { UserAvatar } from \"@/components/shared/user-avatar\"\r\nimport { ArrowLeft, Export, Heart } from \"@phosphor-icons/react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { useWishlist } from \"@/components/providers/wishlist-context\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport type { ProductHeaderProps } from \"../types\"\r\n\r\n/**\r\n * Mobile Product Header - Premium E-commerce Design\r\n * \r\n * A polished, modern product page header inspired by top marketplace apps.\r\n * Features glass morphism, micro-interactions, and thoughtful UX.\r\n * \r\n * Layout: [Back] [Avatar ΓÇó Title] [Wishlist] [Share/More]\r\n * \r\n * Design principles:\r\n * - Glass background with premium blur\r\n * - Semantic h1 for SEO/accessibility\r\n * - Micro-interactions on all touch targets\r\n * - Trust indicator via seller avatar\r\n * - Native share API integration\r\n */\r\nexport function MobileProductHeader({\r\n  productTitle,\r\n  sellerName,\r\n  sellerUsername,\r\n  sellerAvatarUrl,\r\n  locale,\r\n  onBack,\r\n  productId,\r\n  productPrice,\r\n  productImage,\r\n}: ProductHeaderProps) {\r\n  const tProduct = useTranslations(\"Product\")\r\n\r\n  // Seller display\r\n  const profileHref = sellerUsername ? `/${sellerUsername}` : \"#\"\r\n  const hasSellerInfo = sellerUsername || sellerAvatarUrl\r\n\r\n  // Wishlist state\r\n  const { isInWishlist, toggleWishlist } = useWishlist()\r\n  const isWishlisted = productId ? isInWishlist(productId) : false\r\n\r\n  const handleWishlistToggle = () => {\r\n    if (!productId || !productTitle) return\r\n    toggleWishlist({\r\n      id: productId,\r\n      title: productTitle,\r\n      price: productPrice ?? 0,\r\n      image: productImage ?? \"\",\r\n    })\r\n  }\r\n\r\n  // Native share with fallback\r\n  const handleShare = async () => {\r\n    if (navigator.share) {\r\n      try {\r\n        await navigator.share({ \r\n          title: productTitle || document.title, \r\n          url: window.location.href \r\n        })\r\n      } catch {\r\n        // User cancelled or share failed\r\n      }\r\n    } else {\r\n      // Fallback: copy to clipboard\r\n      await navigator.clipboard?.writeText(window.location.href)\r\n    }\r\n  }\r\n\r\n  return (\n    <header \n      className={cn(\n        \"sticky top-0 z-50 border-b border-border-subtle bg-background pt-safe md:hidden\"\n      )}\n    >\n      <div className=\"flex h-(--control-primary) items-center px-1\">\n        {/* Back Button - Large touch target */}\n        <IconButton\n          type=\"button\"\n          variant=\"ghost\"\n          className={cn(\n            \"shrink-0 border border-transparent text-foreground hover:bg-hover active:bg-active\"\n          )}\n          aria-label={tProduct(\"back\")}\n          onClick={onBack}\n        >\r\n          <ArrowLeft className=\"size-icon-sm\" weight=\"bold\" />\r\n        </IconButton>\r\n\r\n        {/* Center Content: Avatar + Title */}\r\n        <div className=\"flex-1 flex items-center gap-2.5 min-w-0 pl-0.5 pr-1\">\r\n          {/* Seller Avatar - Trust indicator */}\r\n          {hasSellerInfo && (\r\n            <Link \n              href={profileHref} \n              className={cn(\n                \"shrink-0 rounded-full\",\n                \"ring-1 ring-border-subtle\"\n              )}\n            >\n              <UserAvatar\r\n                name={sellerName || tProduct(\"seller\")}\r\n                avatarUrl={sellerAvatarUrl ?? null}\r\n                size=\"sm\"\r\n                className=\"size-8\"\r\n                fallbackClassName=\"text-xs font-semibold bg-muted text-muted-foreground\"\r\n              />\r\n            </Link>\r\n          )}\r\n          \r\n          {/* Product Title */}\r\n          {productTitle && (\r\n            <h1 \r\n              className={cn(\r\n                \"text-sm font-semibold leading-tight\",\r\n                \"text-foreground\",\r\n                \"truncate\"\r\n              )}\r\n            >\r\n              {productTitle}\r\n            </h1>\r\n          )}\r\n        </div>\r\n\r\n        {/* Action Buttons */}\r\n        <div className=\"flex items-center shrink-0\">\r\n          {/* Wishlist Button */}\r\n          {productId && (\r\n            <IconButton\n              type=\"button\"\n              variant=\"ghost\"\n              className={cn(\n                \"border border-transparent hover:bg-hover active:bg-active\"\n              )}\n              aria-label={isWishlisted ? tProduct(\"removeFromWishlist\") : tProduct(\"addToWishlist\")}\n              aria-pressed={isWishlisted}\n              onClick={handleWishlistToggle}\r\n            >\r\n              <Heart \r\n              className={cn(\n                  \"size-icon-sm transition-colors\",\n                  isWishlisted \n                    ? \"fill-wishlist-active text-wishlist-active\" \n                    : \"text-foreground\"\n                )} \n                weight={isWishlisted ? \"fill\" : \"regular\"}\n              />\r\n            </IconButton>\r\n          )}\r\n\r\n          {/* Share Button */}\r\n            <IconButton\n              type=\"button\"\n              variant=\"ghost\"\n              className={cn(\n              \"border border-transparent text-foreground hover:bg-hover active:bg-active\"\n            )}\n            aria-label={tProduct(\"share\")}\n            onClick={handleShare}\n          >\r\n            <Export className=\"size-icon-sm\" weight=\"bold\" />\r\n          </IconButton>\r\n        </div>\r\n      </div>\r\n    </header>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\mobile\\profile-header.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isFollowing' is defined but never used.","line":28,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { IconButton } from \"@/components/ui/icon-button\"\r\nimport { ArrowLeft, Export, Gear, ChatCircle } from \"@phosphor-icons/react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport type { ProfileHeaderProps } from \"../types\"\r\n\r\n/**\r\n * Mobile Profile Header - Premium E-commerce Design\r\n * \r\n * A clean, contextual header for user profile pages.\r\n * Features back navigation, user info, and context-aware actions.\r\n * \r\n * Layout: [Back] [Avatar ΓÇó DisplayName] [Share] [Settings/Follow]\r\n * \r\n * Design principles:\r\n * - Glass background with premium blur (matches product header)\r\n * - Context-aware actions based on profile ownership\r\n * - Native share API integration\r\n * - Semantic structure for accessibility\r\n */\r\nexport function MobileProfileHeader({\r\n  displayName,\r\n  username,\r\n  isOwnProfile,\r\n  isFollowing,\r\n  sellerId,\r\n  onBack,\r\n}: ProfileHeaderProps) {\r\n  const tProfile = useTranslations(\"ProfilePage\")\r\n  const tNav = useTranslations(\"Navigation\")\r\n\r\n  const title = displayName || username || tProfile(\"profile\")\r\n  const profileUrl = typeof window !== \"undefined\" ? window.location.href : \"\"\r\n\r\n  // Native share with fallback\r\n  const handleShare = async () => {\r\n    if (typeof navigator !== \"undefined\" && navigator.share) {\r\n      try {\r\n        await navigator.share({\r\n          title,\r\n          url: profileUrl,\r\n        })\r\n      } catch {\r\n        // User cancelled or share failed - silently ignore\r\n      }\r\n    } else if (typeof navigator !== \"undefined\" && navigator.clipboard) {\r\n      // Fallback: copy to clipboard\r\n      await navigator.clipboard.writeText(profileUrl)\r\n    }\r\n  }\r\n\r\n  return (\n    <header\n      className={cn(\n        \"sticky top-0 z-50 border-b border-border-subtle bg-background pt-safe md:hidden\"\n      )}\n    >\n      <div className=\"flex h-(--control-primary) items-center px-2\">\n        {/* Back Button */}\r\n        {onBack ? (\r\n          <IconButton\r\n            type=\"button\"\r\n            variant=\"ghost\"\n            className={cn(\n              \"shrink-0 text-foreground hover:bg-hover active:bg-active\"\n            )}\n            aria-label={tNav(\"back\")}\n            onClick={onBack}\n          >\r\n            <ArrowLeft className=\"size-icon-sm\" weight=\"bold\" />\r\n          </IconButton>\r\n        ) : null}\r\n\r\n        {/* Title */}\r\n        <h1 className={cn(\"flex-1 min-w-0 px-2 text-sm font-semibold text-foreground truncate\")}>\r\n          {title}\r\n        </h1>\r\n\r\n        {/* Action Buttons */}\r\n        <div className=\"flex items-center shrink-0\">\r\n          {/* Share Button */}\r\n          <IconButton\n            type=\"button\"\n            variant=\"ghost\"\n            className={cn(\n              \"text-foreground hover:bg-hover active:bg-active\"\n            )}\n            aria-label={tProfile(\"share\")}\n            onClick={handleShare}\n          >\r\n            <Export className=\"size-icon-sm\" weight=\"bold\" />\r\n          </IconButton>\r\n\r\n          {/* Context-aware action: Account for own profile, Follow for others */}\r\n          {isOwnProfile ? (\r\n            <IconButton\r\n              asChild\r\n              variant=\"ghost\"\n              className={cn(\n                \"text-foreground hover:bg-hover active:bg-active\"\n              )}\n              aria-label={tProfile(\"settings\")}\n            >\n                <Link href=\"/account\">\r\n                  <Gear className=\"size-icon-sm\" weight=\"bold\" />\r\n                </Link>\r\n            </IconButton>\r\n          ) : (\r\n            <>\r\n              {/* Message Button */}\r\n              {sellerId && (\r\n                <IconButton\r\n                  asChild\r\n                  variant=\"ghost\"\n                  className={cn(\n                    \"text-foreground hover:bg-hover active:bg-active\"\n                  )}\n                  aria-label={tProfile(\"message\")}\n                >\n                  <Link href={`/chat?to=${sellerId}`}>\r\n                    <ChatCircle className=\"size-icon-sm\" weight=\"bold\" />\r\n                  </Link>\r\n                </IconButton>\r\n              )}\r\n            </>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </header>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\header\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\nav-main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\nav-secondary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\nav-user.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\sidebar\\sidebar-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\layout\\sidebar\\sidebar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SidebarRail' is defined but never used.","line":308,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":308,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SidebarInput' is defined but never used.","line":348,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":348,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SidebarSeparator' is defined but never used.","line":384,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":384,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SidebarGroupAction' is defined but never used.","line":444,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":444,"endColumn":28},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 5 times.","line":459,"column":9,"nodeType":"Literal","endLine":459,"endColumn":47},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SidebarMenuAction' is defined but never used.","line":575,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":575,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SidebarMenuBadge' is defined but never used.","line":607,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":607,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SidebarMenuSkeleton' is defined but never used.","line":629,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":629,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SidebarMenuSub' is defined but never used.","line":673,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":673,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SidebarMenuSubItem' is defined but never used.","line":688,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":688,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SidebarMenuSubButton' is defined but never used.","line":702,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":702,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * @fileoverview Sidebar primitives (shadcn/ui-based)\r\n * \r\n * This is THE ONLY sidebar primitive file in the codebase.\r\n * Based on shadcn/ui sidebar with project-specific customizations.\r\n * \r\n * ARCHITECTURE:\n * - components/layout/sidebar/sidebar.tsx   ΓåÉ YOU ARE HERE (primitives)\n * - components/layout/sidebar/sidebar-menu.tsx ΓåÉ Composed mobile menu (uses Drawer, not these primitives)\n * \n * DO NOT:\n * - Create duplicate sidebar primitives in components/ui/\r\n * - Import sidebar from any other location\r\n * \r\n * All app sidebars (account, admin, business) compose from these primitives.\r\n */\r\n\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { Slot } from \"@radix-ui/react-slot\"\r\nimport { cva, type VariantProps } from \"class-variance-authority\"\r\nimport { PanelLeftIcon } from \"lucide-react\"\r\nimport { useTranslations } from \"next-intl\"\r\n\r\nimport { useIsMobile } from \"@/hooks/use-mobile\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport {\r\n  Sheet,\r\n  SheetContent,\r\n  SheetDescription,\r\n  SheetHeader,\r\n  SheetTitle,\r\n} from \"@/components/ui/sheet\"\r\nimport { Skeleton } from \"@/components/ui/skeleton\"\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from \"@/components/ui/tooltip\"\r\n\r\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\r\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\r\nconst SIDEBAR_WIDTH = \"16rem\"\r\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\r\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\r\nconst SIDEBAR_OFFSET = \"calc(var(--sidebar-width) * -1)\"\r\nconst SIDEBAR_ICON_GAP = \"calc(var(--sidebar-width-icon) + (--spacing(4)))\"\r\nconst SIDEBAR_ICON_GAP_FLOATING = \"calc(var(--sidebar-width-icon) + (--spacing(4)) + 2px)\"\r\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\r\n\r\ntype SidebarContextProps = {\r\n  state: \"expanded\" | \"collapsed\"\r\n  open: boolean\r\n  setOpen: (open: boolean) => void\r\n  openMobile: boolean\r\n  setOpenMobile: (open: boolean) => void\r\n  isMobile: boolean\r\n  toggleSidebar: () => void\r\n}\r\n\r\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\r\n\r\nfunction useSidebar() {\r\n  const context = React.useContext(SidebarContext)\r\n  if (!context) {\r\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\r\n  }\r\n\r\n  return context\r\n}\r\n\r\nfunction SidebarProvider({\r\n  defaultOpen = true,\r\n  open: openProp,\r\n  onOpenChange: setOpenProp,\r\n  className,\r\n  style,\r\n  children,\r\n  ...props\r\n}: React.ComponentProps<\"div\"> & {\r\n  defaultOpen?: boolean\r\n  open?: boolean\r\n  onOpenChange?: (open: boolean) => void\r\n}) {\r\n  const isMobile = useIsMobile()\r\n  const [openMobile, setOpenMobile] = React.useState(false)\r\n\r\n  // This is the internal state of the sidebar.\r\n  // We use openProp and setOpenProp for control from outside the component.\r\n  const [_open, _setOpen] = React.useState(defaultOpen)\r\n  const open = openProp ?? _open\r\n  const setOpen = React.useCallback(\r\n    (value: boolean | ((value: boolean) => boolean)) => {\r\n      const openState = typeof value === \"function\" ? value(open) : value\r\n      if (setOpenProp) {\r\n        setOpenProp(openState)\r\n      } else {\r\n        _setOpen(openState)\r\n      }\r\n\r\n      // This sets the cookie to keep the sidebar state.\r\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\r\n    },\r\n    [setOpenProp, open]\r\n  )\r\n\r\n  // Helper to toggle the sidebar.\r\n  const toggleSidebar = React.useCallback(() => {\r\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\r\n  }, [isMobile, setOpen, setOpenMobile])\r\n\r\n  // Adds a keyboard shortcut to toggle the sidebar.\r\n  React.useEffect(() => {\r\n    const handleKeyDown = (event: KeyboardEvent) => {\r\n      if (\r\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\r\n        (event.metaKey || event.ctrlKey)\r\n      ) {\r\n        event.preventDefault()\r\n        toggleSidebar()\r\n      }\r\n    }\r\n\r\n    window.addEventListener(\"keydown\", handleKeyDown)\r\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\r\n  }, [toggleSidebar])\r\n\r\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\r\n  // This makes it easier to style the sidebar with Tailwind classes.\r\n  const state = open ? \"expanded\" : \"collapsed\"\r\n\r\n  const contextValue = React.useMemo<SidebarContextProps>(\r\n    () => ({\r\n      state,\r\n      open,\r\n      setOpen,\r\n      isMobile,\r\n      openMobile,\r\n      setOpenMobile,\r\n      toggleSidebar,\r\n    }),\r\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\r\n  )\r\n\r\n  return (\r\n    <SidebarContext.Provider value={contextValue}>\r\n      <TooltipProvider delayDuration={0}>\r\n        <div\r\n          data-slot=\"sidebar-wrapper\"\r\n          style={\r\n            {\r\n              \"--sidebar-width\": SIDEBAR_WIDTH,\r\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\r\n              \"--sidebar-offset\": SIDEBAR_OFFSET,\r\n              \"--sidebar-icon-gap\": SIDEBAR_ICON_GAP,\r\n              \"--sidebar-icon-gap-floating\": SIDEBAR_ICON_GAP_FLOATING,\r\n              ...style,\r\n            } as React.CSSProperties\r\n          }\r\n          className={cn(\r\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\r\n            className\r\n          )}\r\n          {...props}\r\n        >\r\n          {children}\r\n        </div>\r\n      </TooltipProvider>\r\n    </SidebarContext.Provider>\r\n  )\r\n}\r\n\r\nfunction Sidebar({\r\n  side = \"left\",\r\n  variant = \"sidebar\",\r\n  collapsible = \"offcanvas\",\r\n  className,\r\n  children,\r\n  ...props\r\n}: React.ComponentProps<\"div\"> & {\r\n  side?: \"left\" | \"right\"\r\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\r\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\r\n}) {\r\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\r\n  const t = useTranslations(\"Sidebar\")\r\n\r\n  if (collapsible === \"none\") {\r\n    return (\r\n      <div\r\n        data-slot=\"sidebar\"\r\n        className={cn(\r\n          \"bg-sidebar text-sidebar-foreground flex h-full w-(--sidebar-width) flex-col\",\r\n          className\r\n        )}\r\n        {...props}\r\n      >\r\n        {children}\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (isMobile) {\r\n    return (\r\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\r\n        <SheetContent\r\n          data-sidebar=\"sidebar\"\r\n          data-slot=\"sidebar\"\r\n          data-mobile=\"true\"\r\n          className=\"bg-sidebar text-sidebar-foreground w-(--sidebar-width) p-0 [&>button]:hidden\"\r\n          style={\r\n            {\r\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\r\n            } as React.CSSProperties\r\n          }\r\n          side={side}\r\n          closeLabel={t(\"close\")}\r\n        >\r\n          <SheetHeader className=\"sr-only\">\r\n            <SheetTitle>{t(\"title\")}</SheetTitle>\r\n            <SheetDescription>{t(\"mobileDescription\")}</SheetDescription>\r\n          </SheetHeader>\r\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\r\n        </SheetContent>\r\n      </Sheet>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div\r\n      className=\"group peer text-sidebar-foreground hidden md:block\"\r\n      data-state={state}\r\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\r\n      data-variant={variant}\r\n      data-side={side}\r\n      data-slot=\"sidebar\"\r\n    >\r\n      {/* This is what handles the sidebar gap on desktop */}\r\n      <div\r\n        data-slot=\"sidebar-gap\"\r\n        className={cn(\r\n          \"relative w-(--sidebar-width) bg-transparent transition-all duration-200 ease-linear\",\r\n          \"group-data-[collapsible=offcanvas]:w-0\",\r\n          \"group-data-[side=right]:rotate-180\",\r\n          variant === \"floating\" || variant === \"inset\"\r\n            ? \"group-data-[collapsible=icon]:w-(--sidebar-icon-gap)\"\r\n            : \"group-data-[collapsible=icon]:w-(--sidebar-width-icon)\"\r\n        )}\r\n      />\r\n      <div\r\n        data-slot=\"sidebar-container\"\r\n        className={cn(\r\n          \"fixed inset-y-0 z-10 hidden h-svh w-(--sidebar-width) transition-all duration-200 ease-linear md:flex\",\r\n          side === \"left\"\r\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-(--sidebar-offset)\"\r\n            : \"right-0 group-data-[collapsible=offcanvas]:right-(--sidebar-offset)\",\r\n          // Adjust the padding for floating and inset variants.\r\n          variant === \"floating\" || variant === \"inset\"\r\n            ? \"p-2 group-data-[collapsible=icon]:w-(--sidebar-icon-gap-floating)\"\r\n            : \"group-data-[collapsible=icon]:w-(--sidebar-width-icon) group-data-[side=left]:border-r group-data-[side=right]:border-l\",\r\n          className\r\n        )}\r\n        {...props}\r\n      >\r\n        <div\r\n          data-sidebar=\"sidebar\"\r\n          data-slot=\"sidebar-inner\"\r\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\r\n        >\r\n          {children}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction SidebarTrigger({\r\n  className,\r\n  onClick,\r\n  ...props\r\n}: React.ComponentProps<typeof Button>) {\r\n  const { toggleSidebar } = useSidebar()\r\n  const t = useTranslations(\"Sidebar\")\r\n\r\n  return (\r\n    <Button\r\n      data-sidebar=\"trigger\"\r\n      data-slot=\"sidebar-trigger\"\r\n      variant=\"ghost\"\r\n      size=\"icon\"\r\n      className={cn(\"size-7\", className)}\r\n      onClick={(event) => {\r\n        onClick?.(event)\r\n        toggleSidebar()\r\n      }}\r\n      {...props}\r\n    >\r\n      <PanelLeftIcon />\r\n      <span className=\"sr-only\">{t(\"toggleSidebar\")}</span>\r\n    </Button>\r\n  )\r\n}\r\n\r\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\r\n  const { toggleSidebar } = useSidebar()\r\n  const t = useTranslations(\"Sidebar\")\r\n\r\n  return (\r\n    <button\r\n      data-sidebar=\"rail\"\r\n      data-slot=\"sidebar-rail\"\r\n      aria-label={t(\"toggleSidebar\")}\r\n      tabIndex={-1}\r\n      onClick={toggleSidebar}\r\n      title={t(\"toggleSidebar\")}\r\n      className={cn(\r\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-0.5 sm:flex\",\r\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\r\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\r\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\r\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\r\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\r\n  return (\r\n    <main\r\n      data-slot=\"sidebar-inset\"\r\n      className={cn(\r\n        \"bg-background relative flex w-full flex-1 flex-col\",\r\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-md md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarInput({\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<typeof Input>) {\r\n  return (\r\n    <Input\r\n      data-slot=\"sidebar-input\"\r\n      data-sidebar=\"input\"\r\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-header\"\r\n      data-sidebar=\"header\"\r\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-footer\"\r\n      data-sidebar=\"footer\"\r\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarSeparator({\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<typeof Separator>) {\r\n  return (\r\n    <Separator\r\n      data-slot=\"sidebar-separator\"\r\n      data-sidebar=\"separator\"\r\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-content\"\r\n      data-sidebar=\"content\"\r\n      className={cn(\r\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-group\"\r\n      data-sidebar=\"group\"\r\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarGroupLabel({\r\n  className,\r\n  asChild = false,\r\n  ...props\r\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\r\n  const Comp = asChild ? Slot : \"div\"\r\n\r\n  return (\r\n    <Comp\r\n      data-slot=\"sidebar-group-label\"\r\n      data-sidebar=\"group-label\"\r\n      className={cn(\r\n        \"text-sidebar-muted-foreground ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-all duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\r\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarGroupAction({\r\n  className,\r\n  asChild = false,\r\n  ...props\r\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\r\n  const Comp = asChild ? Slot : \"button\"\r\n\r\n  return (\r\n    <Comp\r\n      data-slot=\"sidebar-group-action\"\r\n      data-sidebar=\"group-action\"\r\n      className={cn(\r\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\r\n        // Increases the hit area of the button on mobile.\r\n        \"after:absolute after:-inset-2 md:after:hidden\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarGroupContent({\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<\"div\">) {\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-group-content\"\r\n      data-sidebar=\"group-content\"\r\n      className={cn(\"w-full text-sm\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\r\n  return (\r\n    <ul\r\n      data-slot=\"sidebar-menu\"\r\n      data-sidebar=\"menu\"\r\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\r\n  return (\r\n    <li\r\n      data-slot=\"sidebar-menu-item\"\r\n      data-sidebar=\"menu-item\"\r\n      className={cn(\"group/menu-item relative\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nconst sidebarMenuButtonVariants = cva(\r\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-all hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\r\n  {\r\n    variants: {\r\n      variant: {\r\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\r\n        outline:\r\n          \"bg-background ring-1 ring-sidebar-border hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:ring-sidebar-accent\",\r\n      },\r\n      size: {\r\n        default: \"h-8 text-sm\",\r\n        sm: \"h-7 text-xs\",\r\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\r\n      },\r\n    },\r\n    defaultVariants: {\r\n      variant: \"default\",\r\n      size: \"default\",\r\n    },\r\n  }\r\n)\r\n\r\nfunction SidebarMenuButton({\r\n  asChild = false,\r\n  isActive = false,\r\n  variant = \"default\",\r\n  size = \"default\",\r\n  tooltip,\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<\"button\"> & {\r\n  asChild?: boolean\r\n  isActive?: boolean\r\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\r\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\r\n  const Comp = asChild ? Slot : \"button\"\r\n  const { isMobile, state } = useSidebar()\r\n\r\n  const button = (\r\n    <Comp\r\n      data-slot=\"sidebar-menu-button\"\r\n      data-sidebar=\"menu-button\"\r\n      data-size={size}\r\n      data-active={isActive}\r\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\r\n      {...props}\r\n    />\r\n  )\r\n\r\n  if (!tooltip) {\r\n    return button\r\n  }\r\n\r\n  if (typeof tooltip === \"string\") {\r\n    tooltip = {\r\n      children: tooltip,\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Tooltip>\r\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\r\n      <TooltipContent\r\n        side=\"right\"\r\n        align=\"center\"\r\n        hidden={state !== \"collapsed\" || isMobile}\r\n        {...tooltip}\r\n      />\r\n    </Tooltip>\r\n  )\r\n}\r\n\r\nfunction SidebarMenuAction({\r\n  className,\r\n  asChild = false,\r\n  showOnHover = false,\r\n  ...props\r\n}: React.ComponentProps<\"button\"> & {\r\n  asChild?: boolean\r\n  showOnHover?: boolean\r\n}) {\r\n  const Comp = asChild ? Slot : \"button\"\r\n\r\n  return (\r\n    <Comp\r\n      data-slot=\"sidebar-menu-action\"\r\n      data-sidebar=\"menu-action\"\r\n      className={cn(\r\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\r\n        // Increases the hit area of the button on mobile.\r\n        \"after:absolute after:-inset-2 md:after:hidden\",\r\n        \"peer-data-[size=sm]/menu-button:top-1\",\r\n        \"peer-data-[size=default]/menu-button:top-1.5\",\r\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        showOnHover &&\r\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarMenuBadge({\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<\"div\">) {\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-menu-badge\"\r\n      data-sidebar=\"menu-badge\"\r\n      className={cn(\r\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\r\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\r\n        \"peer-data-[size=sm]/menu-button:top-1\",\r\n        \"peer-data-[size=default]/menu-button:top-1.5\",\r\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarMenuSkeleton({\r\n  className,\r\n  showIcon = false,\r\n  ...props\r\n}: React.ComponentProps<\"div\"> & {\r\n  showIcon?: boolean\r\n}) {\r\n  const skeletonId = React.useId()\r\n  // Deterministic width to avoid SSR/CSR mismatch.\r\n  const width = React.useMemo(() => {\r\n    const widths = [\"55%\", \"65%\", \"75%\", \"85%\"]\r\n    let hash = 0\r\n    for (let i = 0; i < skeletonId.length; i += 1) {\r\n      hash = (hash + skeletonId.charCodeAt(i)) % widths.length\r\n    }\r\n    return widths[hash]\r\n  }, [skeletonId])\r\n\r\n  return (\r\n    <div\r\n      data-slot=\"sidebar-menu-skeleton\"\r\n      data-sidebar=\"menu-skeleton\"\r\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\r\n      {...props}\r\n    >\r\n      {showIcon && (\r\n        <Skeleton\r\n          className=\"size-4 rounded-md\"\r\n          data-sidebar=\"menu-skeleton-icon\"\r\n        />\r\n      )}\r\n      <Skeleton\r\n        className=\"h-4 max-w-(--skeleton-width) flex-1\"\r\n        data-sidebar=\"menu-skeleton-text\"\r\n        style={\r\n          {\r\n            \"--skeleton-width\": width,\r\n          } as React.CSSProperties\r\n        }\r\n      />\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\r\n  return (\r\n    <ul\r\n      data-slot=\"sidebar-menu-sub\"\r\n      data-sidebar=\"menu-sub\"\r\n      className={cn(\r\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarMenuSubItem({\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<\"li\">) {\r\n  return (\r\n    <li\r\n      data-slot=\"sidebar-menu-sub-item\"\r\n      data-sidebar=\"menu-sub-item\"\r\n      className={cn(\"group/menu-sub-item relative\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction SidebarMenuSubButton({\r\n  asChild = false,\r\n  size = \"md\",\r\n  isActive = false,\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<\"a\"> & {\r\n  asChild?: boolean\r\n  size?: \"sm\" | \"md\"\r\n  isActive?: boolean\r\n}) {\r\n  const Comp = asChild ? Slot : \"a\"\r\n\r\n  return (\r\n    <Comp\r\n      data-slot=\"sidebar-menu-sub-button\"\r\n      data-sidebar=\"menu-sub-button\"\r\n      data-size={size}\r\n      data-active={isActive}\r\n      className={cn(\r\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline-hidden focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\r\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\r\n        size === \"sm\" && \"text-xs\",\r\n        size === \"md\" && \"text-sm\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarProvider,\n  SidebarTrigger,\n  useSidebar,\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\category-nav\\category-circles-simple.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'itemState' to the outer scope.","line":71,"column":39,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":71,"endColumn":41},{"ruleId":"sonarjs/no-all-duplicated-branches","severity":1,"message":"This conditional operation returns the same value whether the condition is \"true\" or \"false\".","line":84,"column":29,"nodeType":"ConditionalExpression","messageId":"returnsTheSameValue","endLine":84,"endColumn":75},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 5 times.","line":84,"column":38,"nodeType":"Literal","endLine":84,"endColumn":55}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport type { CategoryTreeNode } from \"@/lib/category-tree\"\nimport { getCategoryName, getCategorySlugKey } from \"@/lib/category-display\"\nimport { cn } from \"@/lib/utils\"\nimport { useTranslations } from \"next-intl\"\nimport { DotsThree } from \"@phosphor-icons/react\"\nimport { Link } from \"@/i18n/routing\"\nimport { getCategoryIcon } from \"@/components/shared/category/category-icons\"\n\nimport { useCategoryDrawerOptional } from \"./category-drawer-context\"\n\n// =============================================================================\n// Types\n// =============================================================================\n\nexport interface CategoryCirclesSimpleProps {\n  /** L0 root categories to display */\n  categories: CategoryTreeNode[]\n  /** Locale for name display */\n  locale: string\n  /** Additional class name */\n  className?: string\n  /** Called when a category is selected (for non-drawer mode) */\n  onCategorySelect?: (category: CategoryTreeNode) => void\n  /** Maximum number of root categories visible in the homepage rail */\n  maxVisible?: number\n}\n\n// =============================================================================\n// Component\n// =============================================================================\n\n/**\n * Simple horizontal category circles for homepage (icon + label below).\n *\n * - Horizontal scroll with momentum, no visible scrollbar\n * - Active state uses a clear ring (native app feel)\n * - Tapping opens the CategoryBrowseDrawer (when available)\n */\nexport function CategoryCirclesSimple({\n  categories,\n  locale,\n  className,\n  onCategorySelect,\n  maxVisible = 7,\n}: CategoryCirclesSimpleProps) {\n  const tCategories = useTranslations(\"Categories\")\n  const tMobile = useTranslations(\"Home.mobile\")\n  const drawer = useCategoryDrawerOptional()\n\n  const handleCategoryClick = React.useCallback(\n    (category: CategoryTreeNode) => {\n      if (drawer) {\n        drawer.openCategory(category)\n      } else {\n        onCategorySelect?.(category)\n      }\n    },\n    [drawer, onCategorySelect]\n  )\n\n  if (categories.length === 0) return null\n\n  const itemWidth = \"flex-none w-(--spacing-category-item-nav)\"\n  const iconShellSize = \"size-(--control-compact)\"\n  const labelClass = \"text-xs font-semibold leading-tight tracking-normal\"\n  const itemBase =\n    \"group inline-flex min-h-(--spacing-touch-md) flex-col items-center justify-start gap-1.5 rounded-xl border px-2 py-2 tap-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-focus-ring focus-visible:ring-offset-1\"\n  const itemState = (active: boolean) =>\n    active\n      ? \"border-foreground bg-foreground text-background\"\n      : \"border-border-subtle bg-surface-subtle text-foreground hover:border-hover-border hover:bg-hover active:bg-active\"\n  const iconShellState = (active: boolean) =>\n    cn(\n      \"flex items-center justify-center rounded-lg transition-colors\",\n      iconShellSize,\n      active\n        ? \"bg-background text-foreground\"\n        : \"bg-background text-foreground group-hover:bg-hover group-hover:text-foreground\"\n    )\n  const iconTone = (active: boolean) =>\n    cn(\"transition-colors\", active ? \"text-foreground\" : \"text-foreground\")\n  const moreIconShellState = (active: boolean) =>\n    cn(\n      \"flex items-center justify-center rounded-lg bg-background transition-colors\",\n      iconShellSize,\n      active ? \"text-foreground\" : \"text-muted-foreground group-hover:text-foreground\"\n    )\n\n  const rootActive = Boolean(drawer?.isOpen && drawer.path.length === 0)\n  const rootLabel = tCategories(\"all\")\n  const rootHref = \"/categories\" as const\n  const visibleCategories = categories.slice(0, Math.max(1, maxVisible))\n\n  return (\n    <div className={cn(\"overflow-x-auto px-(--spacing-home-inset) py-2 no-scrollbar\", className)}>\n      <div className=\"flex snap-x snap-mandatory items-start gap-2\">\n        {/* Root / Categories */}\n        {drawer ? (\n          <button\n            type=\"button\"\n            onClick={drawer.openRoot}\n            className={cn(itemBase, itemState(rootActive), itemWidth)}\n            aria-pressed={rootActive}\n            aria-label={rootLabel}\n          >\n            <span className={iconShellState(rootActive)}>\n              {getCategoryIcon(\"categories\", {\n                size: 20,\n                weight: rootActive ? \"fill\" : \"regular\",\n                className: iconTone(rootActive),\n              })}\n            </span>\n            <span className={cn(labelClass, \"w-full truncate text-center\", rootActive ? \"text-background\" : \"text-foreground\")}>\n              {rootLabel}\n            </span>\n          </button>\n        ) : (\n          <Link\n            href={rootHref}\n            prefetch={true}\n            className={cn(itemBase, itemState(false), itemWidth)}\n            aria-label={rootLabel}\n          >\n            <span className={iconShellState(false)}>\n              {getCategoryIcon(\"categories\", {\n                size: 20,\n                weight: \"regular\",\n                className: iconTone(false),\n              })}\n            </span>\n            <span className={cn(labelClass, \"w-full truncate text-center text-foreground\")}>\n              {rootLabel}\n            </span>\n          </Link>\n        )}\n\n        {/* Top L0 categories */}\n        {visibleCategories.map((category) => {\n          const isActive = Boolean(drawer?.isOpen && drawer.path[0]?.slug === category.slug)\n          const label = tCategories(\"shortName\", {\n            slug: getCategorySlugKey(category.slug),\n            name: getCategoryName(category, locale),\n          })\n\n          if (drawer) {\n            return (\n              <button\n                key={category.slug}\n                type=\"button\"\n                onClick={() => handleCategoryClick(category)}\n                className={cn(itemBase, itemState(Boolean(isActive)), itemWidth)}\n                aria-pressed={Boolean(isActive)}\n                aria-label={label}\n              >\n                <span className={iconShellState(Boolean(isActive))}>\n                  {getCategoryIcon(category.slug, {\n                    size: 20,\n                    weight: isActive ? \"fill\" : \"regular\",\n                    className: iconTone(Boolean(isActive)),\n                  })}\n                </span>\n                <span className={cn(labelClass, \"w-full truncate text-center\", isActive ? \"text-background\" : \"text-foreground\")}>\n                  {label}\n                </span>\n              </button>\n            )\n          }\n\n          return (\n            <Link\n              key={category.slug}\n              href={`/categories/${category.slug}` as const}\n              prefetch={true}\n              className={cn(itemBase, itemState(false), itemWidth)}\n              aria-label={label}\n            >\n              <span className={iconShellState(false)}>\n                {getCategoryIcon(category.slug, {\n                  size: 20,\n                  weight: \"regular\",\n                  className: iconTone(false),\n                })}\n              </span>\n              <span className={cn(labelClass, \"w-full truncate text-center text-foreground\")}>\n                {label}\n              </span>\n            </Link>\n          )\n        })}\n\n        {/* Explicit \"More\" affordance keeps the above-the-fold rail focused. */}\n        {drawer ? (\n          <button\n            type=\"button\"\n            onClick={drawer.openRoot}\n            className={cn(\n              itemBase,\n              itemState(false),\n              itemWidth\n            )}\n            aria-label={tMobile(\"moreCategories\")}\n          >\n            <span className={moreIconShellState(false)}>\n              <DotsThree size={22} weight=\"bold\" className=\"text-foreground\" />\n            </span>\n            <span className={cn(labelClass, \"w-full truncate text-center text-foreground\")}>\n              {tMobile(\"moreCategories\")}\n            </span>\n          </button>\n        ) : (\n          <Link\n            href={rootHref}\n            prefetch={true}\n            className={cn(itemBase, itemState(false), itemWidth)}\n            aria-label={tMobile(\"moreCategories\")}\n          >\n            <span className={moreIconShellState(false)}>\n              <DotsThree size={22} weight=\"bold\" className=\"text-foreground\" />\n            </span>\n            <span className={cn(labelClass, \"w-full truncate text-center text-foreground\")}>\n              {tMobile(\"moreCategories\")}\n            </span>\n          </Link>\n        )}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\category-nav\\category-drawer-context.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\category-nav\\filter-sort-bar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SORT_OPTIONS' is assigned a value but only used as a type.","line":52,"column":7,"nodeType":"Identifier","messageId":"usedOnlyAsType","endLine":52,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useMemo, useCallback } from \"react\"\r\nimport { useSearchParams, type ReadonlyURLSearchParams } from \"next/navigation\"\r\nimport { SlidersHorizontal, ArrowUpDown, MapPin } from \"lucide-react\"\nimport { cn } from \"@/lib/utils\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { SortModal } from \"@/components/shared/filters/sort-modal\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport type { CategoryAttribute } from \"@/lib/data/categories\"\r\nimport { getCategoryAttributeKey } from \"@/lib/filters/category-attribute\"\r\n\r\n// =============================================================================\r\n// FILTER/SORT BAR ΓÇö Clean 50/50 Split Design\r\n//\r\n// OLX/Vinted/Depop inspired: Two equal tab-style buttons\r\n// - Left: \"Filters\" with active count badge ΓåÆ opens FilterHub drawer\r\n// - Right: \"Sort\" showing current sort ΓåÆ opens sort bottom sheet\r\n//\r\n// Design system compliance (.codex/project/DESIGN.md):\r\n// - h-11 touch targets (44px Treido standard)\r\n// - Semantic tokens only (text-muted-foreground, bg-muted)\r\n// - Tailwind v4 best practices\r\n// - lucide-react icons (repo standard)\r\n// =============================================================================\r\nexport interface FilterSortBarProps {\n  /** Current locale for i18n */\r\n  locale: string\r\n  /** Called when \"Filters\" button is clicked (opens FilterHub) */\r\n  onAllFiltersClick: () => void\r\n  /** Optional externally-controlled applied params (for instant, non-navigating flows) */\r\n  appliedSearchParams?: URLSearchParams | ReadonlyURLSearchParams | undefined\r\n  /** Filterable attributes from category (used for counting active filters) */\r\n  attributes?: CategoryAttribute[]\r\n  /** Sticky position top offset (after header + pills) */\r\n  stickyTop?: number | string\r\n  /** Whether this bar is sticky (default: true). */\r\n  sticky?: boolean\r\n  /** Override base path for sort query params */\r\n  basePath?: string | undefined\r\n  /** Additional CSS classes */\n  className?: string\n  /** Optional compact location button shown above filter/sort row */\n  locationChipLabel?: string | null\n  /** Whether location has explicit city/nearby filters applied */\n  locationChipActive?: boolean\n  /** Called when location chip is clicked */\n  onLocationChipClick?: () => void\n}\n\r\n/** Sort option keys */\r\nconst SORT_OPTIONS = [\"featured\", \"price-asc\", \"price-desc\", \"rating\", \"newest\"] as const\r\ntype SortOption = (typeof SORT_OPTIONS)[number]\r\n\r\nexport function FilterSortBar({\r\n  locale,\r\n  onAllFiltersClick,\r\n  appliedSearchParams,\r\n  attributes = [],\r\n  stickyTop = 80,\r\n  sticky = true,\n  basePath,\n  className,\n  locationChipLabel,\n  locationChipActive = false,\n  onLocationChipClick,\n}: FilterSortBarProps) {\n  const t = useTranslations(\"SearchFilters\")\r\n  const searchParamsFromRouter = useSearchParams()\r\n  const searchParams = appliedSearchParams ?? searchParamsFromRouter\r\n\r\n  const [sortOpen, setSortOpen] = useState(false)\r\n\r\n  // Count active filters (memoized for perf)\r\n  const activeFilterCount = useMemo(() => {\r\n    let count = 0\r\n    if (searchParams.get(\"minPrice\") || searchParams.get(\"maxPrice\")) count++\r\n    if (searchParams.get(\"minRating\")) count++\r\n    if (searchParams.get(\"availability\")) count++\n    if (searchParams.get(\"deals\") === \"true\") count++\n    if (searchParams.get(\"verified\") === \"true\") count++\n    if (searchParams.get(\"city\")) count++\n    if (searchParams.get(\"nearby\") === \"true\") count++\n    // Count attribute filters\n    for (const attr of attributes) {\n      if (searchParams.getAll(`attr_${getCategoryAttributeKey(attr)}`).length > 0) count++\n    }\r\n    return count\r\n  }, [searchParams, attributes])\r\n\r\n  // Current sort value\r\n  const currentSort = (searchParams.get(\"sort\") || \"featured\") as SortOption\r\n  const isSorted = currentSort !== \"featured\"\r\n\r\n  // Sort labels (memoized to avoid recreating on each render)\r\n  const sortLabels = useMemo<Record<SortOption, string>>(\r\n    () => ({\r\n      featured: t(\"featured\"),\r\n      \"price-asc\": t(\"priceLowHigh\"),\r\n      \"price-desc\": t(\"priceHighLow\"),\r\n      rating: t(\"avgReview\"),\r\n      newest: t(\"newestArrivals\"),\r\n    }),\r\n    [t]\r\n  )\r\n\r\n  const openSort = useCallback(() => setSortOpen(true), [])\r\n\r\n  const hasActiveFilters = activeFilterCount > 0\r\n\r\n  return (\r\n    <>\r\n      <div\n        className={cn(\n          \"bg-background px-inset py-2\",\n          sticky && \"sticky z-20\",\n          className\n        )}\n        style={sticky ? { top: stickyTop } : undefined}\n        data-testid=\"mobile-filter-sort-bar\"\n      >\n        {onLocationChipClick && locationChipLabel && (\n          <button\n            type=\"button\"\n            onClick={onLocationChipClick}\n            className={cn(\n              \"mb-2 inline-flex min-h-10 max-w-full items-center gap-1.5 rounded-full border px-3 text-sm font-medium\",\n              \"transition-colors tap-transparent focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring\",\n              locationChipActive\n                ? \"border-selected-border bg-selected text-selected-foreground\"\n                : \"border-border-subtle bg-surface-subtle text-muted-foreground hover:bg-hover hover:text-foreground active:bg-active\"\n            )}\n            aria-haspopup=\"dialog\"\n            data-testid=\"mobile-location-chip\"\n          >\n            <MapPin className=\"size-4 shrink-0\" aria-hidden=\"true\" />\n            <span className=\"min-w-0 truncate\">{locationChipLabel}</span>\n          </button>\n        )}\n\n        {/* 50/50 Tab Bar */}\n        <div className=\"flex items-stretch gap-2\" role=\"group\" aria-label={t(\"filters\")}>\n          {/* Filters Tab */}\r\n          <Button\r\n            type=\"button\"\r\n            variant=\"outline\"\r\n            onClick={onAllFiltersClick}\r\n            className={cn(\r\n              \"flex-1 h-11 rounded-full px-4 gap-2 font-semibold\",\r\n              hasActiveFilters && \"bg-selected border-selected-border text-selected-foreground\"\r\n            )}\r\n            aria-haspopup=\"dialog\"\r\n            aria-expanded={false}\r\n          >\r\n            <SlidersHorizontal className=\"size-4 shrink-0\" aria-hidden=\"true\" />\r\n            <span>{t(\"filters\")}</span>\r\n            {hasActiveFilters && (\r\n              <span className=\"inline-flex items-center justify-center size-5 rounded-full bg-foreground text-background text-xs font-bold tabular-nums\">\r\n                {activeFilterCount}\r\n              </span>\r\n            )}\r\n          </Button>\r\n\r\n          {/* Sort Tab */}\r\n          <Button\r\n            type=\"button\"\r\n            variant=\"outline\"\r\n            onClick={openSort}\r\n            className={cn(\r\n              \"flex-1 h-11 rounded-full px-4 gap-2 font-semibold min-w-0\",\r\n              isSorted && \"bg-selected border-selected-border text-selected-foreground\"\r\n            )}\r\n            aria-haspopup=\"dialog\"\r\n            aria-expanded={sortOpen}\r\n            aria-label={`${t(\"sortBy\")}: ${sortLabels[currentSort]}`}\r\n          >\r\n            <ArrowUpDown className=\"size-4 shrink-0\" aria-hidden=\"true\" />\r\n            <span className=\"truncate min-w-0\">\r\n              {isSorted ? sortLabels[currentSort] : t(\"sortBy\")}\r\n            </span>\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Sort Bottom Sheet */}\r\n      <SortModal\r\n        open={sortOpen}\r\n        onOpenChange={setSortOpen}\r\n        locale={locale}\r\n        basePath={basePath}\r\n      />\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\category-nav\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\drawers\\account-drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\drawers\\auth-drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\drawers\\cart-drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\drawers\\category-browse-drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\drawers\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\drawers\\messages-drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\drawers\\product-quick-view-drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\drawers\\seller-profile-drawer.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ChevronRight' is defined but never used.","line":23,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":23,"endColumn":15,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ChevronRight"},"fix":{"range":[809,826],"text":""},"desc":"Remove unused variable \"ChevronRight\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used.","line":28,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":28,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Link"},"fix":{"range":[897,902],"text":""},"desc":"Remove unused variable \"Link\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'cn' is defined but never used.","line":42,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":42,"endColumn":12,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"cn"},"fix":{"range":[1304,1336],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":280,"column":17,"nodeType":"JSXOpeningElement","endLine":284,"endColumn":19,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\n// =============================================================================\r\n// SELLER PROFILE DRAWER\r\n// =============================================================================\r\n// Mobile drawer showing seller profile info without leaving the current page.\r\n// Opens when user taps \"View Profile\" on seller preview card.\r\n// Contains: header, stats, bio, listings, and action buttons.\r\n// =============================================================================\r\n\r\nimport * as React from \"react\"\r\nimport { useState, useEffect } from \"react\"\r\nimport { useTranslations, useLocale } from \"next-intl\"\r\nimport { formatDistanceToNow } from \"date-fns\"\r\nimport { bg, enUS } from \"date-fns/locale\"\r\nimport {\r\n  Star,\r\n  CheckCircle2,\r\n  Calendar,\r\n  Package,\r\n  Users,\r\n  MessageCircle,\r\n  ChevronRight,\r\n  Sparkles,\r\n  X,\r\n  ExternalLink,\r\n} from \"lucide-react\"\r\nimport { Link, useRouter } from \"@/i18n/routing\"\r\nimport {\n  Drawer,\n  DrawerBody,\n  DrawerClose,\n  DrawerContent,\r\n  DrawerDescription,\r\n  DrawerFooter,\r\n  DrawerTitle,\r\n} from \"@/components/ui/drawer\"\nimport { Button } from \"@/components/ui/button\"\nimport { IconButton } from \"@/components/ui/icon-button\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { UserAvatar } from \"@/components/shared/user-avatar\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\n// -----------------------------------------------------------------------------\r\n// Types\r\n// -----------------------------------------------------------------------------\r\n\r\nexport interface SellerProfileData {\r\n  id: string\r\n  name: string\r\n  username: string | null\r\n  avatarUrl: string | null\r\n  verified: boolean\r\n  rating: number | null\r\n  reviewCount: number | null\r\n  positivePercent?: number | null\r\n  totalSales: number | null\r\n  responseTimeHours: number | null\r\n  followers?: number | null\r\n  listingsCount?: number | null\r\n  joinedAt: string | null\r\n  joinedYear?: string | null\r\n  bio?: string | null\r\n}\r\n\r\nexport interface SellerProduct {\r\n  id: string\r\n  title: string\r\n  price: number\r\n  originalPrice?: number | null\r\n  image?: string | null\r\n  slug?: string | null\r\n  storeSlug?: string | null\r\n}\r\n\r\ninterface SellerProfileDrawerProps {\r\n  open: boolean\r\n  onOpenChange: (open: boolean) => void\r\n  seller: SellerProfileData | null\r\n  /** Products from this seller to show in drawer */\r\n  products?: SellerProduct[]\r\n  /** Callback for chat action */\r\n  onChat?: () => void\r\n  /** Callback for follow action */\r\n  onFollow?: () => void\r\n  /** Whether user is following this seller */\r\n  isFollowing?: boolean\r\n}\r\n\r\n// -----------------------------------------------------------------------------\r\n// Sub-components\r\n// -----------------------------------------------------------------------------\r\n\r\n/** Check if seller is \"new\" (no sales or feedback) */\r\nfunction isNewSeller(seller: SellerProfileData): boolean {\r\n  return (seller.totalSales ?? 0) === 0 || (seller.positivePercent ?? 0) === 0\r\n}\r\n\r\n/** Seller Profile Header */\r\nfunction SellerHeader({ seller }: { seller: SellerProfileData }) {\r\n  const t = useTranslations(\"Product\")\r\n  const tVerif = useTranslations(\"SellerVerification\")\r\n\r\n  const showNewSellerBadge = isNewSeller(seller)\r\n\r\n  return (\r\n    <div className=\"flex items-start gap-3\">\r\n      {/* Avatar */}\r\n      <div className=\"relative shrink-0\">\r\n        <UserAvatar\r\n          name={seller.name}\r\n          avatarUrl={seller.avatarUrl}\r\n          size=\"xl\"\r\n          className=\"size-16\"\r\n        />\r\n        {seller.verified && (\r\n          <span className=\"absolute -bottom-1 -right-1 size-5 bg-primary rounded-full ring-2 ring-background flex items-center justify-center\">\r\n            <CheckCircle2 className=\"size-3 text-primary-foreground\" fill=\"currentColor\" />\r\n          </span>\r\n        )}\r\n      </div>\r\n\r\n      {/* Name & Meta */}\r\n      <div className=\"flex-1 min-w-0 space-y-0.5\">\r\n        <div className=\"flex items-center gap-1.5 flex-wrap\">\r\n          <h2 className=\"text-base font-bold text-foreground truncate\">{seller.name}</h2>\r\n          {seller.verified && (\n            <Badge variant=\"verified-personal\" className=\"shrink-0 text-2xs px-1.5 py-0\">\n              {t(\"verified\")}\n            </Badge>\n          )}\n          {showNewSellerBadge && (\r\n            <Badge variant=\"secondary\" className=\"shrink-0 text-2xs px-1.5 py-0 gap-1\">\r\n              <Sparkles className=\"size-2.5\" />\r\n              {tVerif(\"newSeller\")}\r\n            </Badge>\r\n          )}\r\n        </div>\r\n        {seller.username && (\r\n          <p className=\"text-sm text-muted-foreground\">@{seller.username}</p>\r\n        )}\r\n        {/* Rating */}\r\n        {seller.rating != null && seller.rating > 0 && (\r\n          <div className=\"flex items-center gap-1 mt-0.5\">\r\n            <Star className=\"size-3.5 fill-warning text-warning\" />\r\n            <span className=\"text-sm font-semibold text-foreground\">\r\n              {seller.rating.toFixed(1)}\r\n            </span>\r\n            {seller.reviewCount != null && seller.reviewCount > 0 && (\r\n              <span className=\"text-xs text-muted-foreground\">\r\n                ({seller.reviewCount})\r\n              </span>\r\n            )}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n/** Stats Row */\r\nfunction SellerStats({ seller }: { seller: SellerProfileData }) {\r\n  const t = useTranslations(\"Seller\")\r\n  const locale = useLocale()\r\n  const [mounted, setMounted] = useState(false)\r\n  useEffect(() => setMounted(true), [])\r\n\r\n  const joinedText = mounted && seller.joinedAt\r\n    ? formatDistanceToNow(new Date(seller.joinedAt), {\r\n        addSuffix: false,\r\n        locale: locale === \"bg\" ? bg : enUS,\r\n      })\r\n    : seller.joinedYear ?? null\r\n\r\n  const isNew = isNewSeller(seller)\r\n\r\n  return (\r\n    <div className=\"rounded-xl bg-muted px-3 py-2.5 space-y-1.5\">\r\n      {/* Stats Grid */}\r\n      <div className=\"flex items-center gap-4 text-sm\">\r\n        {seller.listingsCount != null && seller.listingsCount > 0 && (\r\n          <div className=\"text-center\">\r\n            <p className=\"font-semibold text-foreground\">{seller.listingsCount}</p>\r\n            <p className=\"text-xs text-muted-foreground\">{t(\"listings\")}</p>\r\n          </div>\r\n        )}\r\n        {seller.totalSales != null && seller.totalSales > 0 && (\r\n          <div className=\"text-center\">\r\n            <p className=\"font-semibold text-foreground\">{seller.totalSales}</p>\r\n            <p className=\"text-xs text-muted-foreground\">{t(\"itemsSold\")}</p>\r\n          </div>\r\n        )}\r\n        {!isNew && seller.positivePercent != null && (\r\n          <div className=\"text-center\">\r\n            <p className=\"font-semibold text-foreground\">{seller.positivePercent}%</p>\r\n            <p className=\"text-xs text-muted-foreground\">{t(\"positive\")}</p>\r\n          </div>\r\n        )}\r\n        {seller.responseTimeHours != null && seller.responseTimeHours > 0 && (\r\n          <div className=\"text-center\">\r\n            <p className=\"font-semibold text-foreground\">\r\n              {seller.responseTimeHours <= 1 ? \"<1h\" : `${Math.round(seller.responseTimeHours)}h`}\r\n            </p>\r\n            <p className=\"text-xs text-muted-foreground\">{t(\"response\")}</p>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      {/* Joined Date */}\r\n      {joinedText && (\r\n        <div className=\"flex items-center gap-1.5 text-xs text-muted-foreground pt-1 border-t border-border-subtle\">\n          <Calendar className=\"size-3\" strokeWidth={1.5} />\n          <span>{t(\"memberSince\", { date: joinedText })}</span>\n        </div>\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\n/** Seller Bio */\r\nfunction SellerBio({ bio }: { bio: string | null | undefined }) {\r\n  const t = useTranslations(\"Seller\")\r\n\r\n  if (!bio) return null\r\n\r\n  return (\r\n    <div className=\"space-y-2\">\r\n      <h3 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wide\">\r\n        {t(\"aboutThisSeller\")}\r\n      </h3>\r\n      <p className=\"text-sm text-muted-foreground leading-relaxed\">{bio}</p>\r\n    </div>\r\n  )\r\n}\r\n\r\n/** Seller Listings Grid */\r\nfunction SellerListings({\r\n  products,\r\n  sellerUsername,\r\n  onClose,\r\n}: {\r\n  products: SellerProduct[]\r\n  sellerUsername: string | null\r\n  onClose: () => void\r\n}) {\r\n  const t = useTranslations(\"Product\")\r\n  const router = useRouter()\r\n\r\n  if (!products || products.length === 0) return null\r\n\r\n  const getProductHref = (product: SellerProduct) => {\r\n    const resolvedSellerSlug = product.storeSlug || sellerUsername\r\n    const resolvedProductSlug = product.slug || product.id\r\n    return resolvedSellerSlug ? `/${resolvedSellerSlug}/${resolvedProductSlug}` : \"#\"\r\n  }\r\n\r\n  const handleProductClick = (href: string) => {\r\n    onClose()\r\n    router.push(href)\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-3\">\r\n      <h3 className=\"text-xs font-semibold text-muted-foreground uppercase tracking-wide\">\r\n        {t(\"moreFromSeller\")}\r\n      </h3>\r\n\r\n      {/* Horizontal scroll of products */}\r\n      <div className=\"flex gap-2 overflow-x-auto pb-2 -mx-4 px-4 hide-scrollbar\">\r\n        {products.slice(0, 8).map((product) => (\n          <button\n            key={product.id}\n            onClick={() => handleProductClick(getProductHref(product))}\n            className=\"shrink-0 w-28 rounded-lg border border-border-subtle bg-card overflow-hidden text-left transition-colors hover:bg-hover\"\n          >\n            {/* Image */}\r\n            <div className=\"aspect-square relative bg-muted\">\r\n              {product.image ? (\r\n                // eslint-disable-next-line @next/next/no-img-element\r\n                <img\r\n                  src={product.image}\r\n                  alt={product.title}\r\n                  className=\"w-full h-full object-cover\"\r\n                />\r\n              ) : (\r\n                <div className=\"w-full h-full flex items-center justify-center\">\r\n                  <Package className=\"size-6 text-muted-foreground\" />\r\n                </div>\r\n              )}\r\n            </div>\r\n            {/* Info */}\r\n            <div className=\"p-2\">\r\n              <p className=\"text-xs font-bold text-foreground\">\r\n                Γé¼{product.price.toLocaleString()}\r\n              </p>\r\n              <p className=\"text-2xs text-muted-foreground line-clamp-1 mt-0.5\">\r\n                {product.title}\r\n              </p>\r\n            </div>\r\n          </button>\r\n        ))}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n// -----------------------------------------------------------------------------\r\n// Main Component\r\n// -----------------------------------------------------------------------------\r\n\r\nexport function SellerProfileDrawer({\r\n  open,\r\n  onOpenChange,\r\n  seller,\r\n  products = [],\r\n  onChat,\r\n  onFollow,\r\n  isFollowing = false,\r\n}: SellerProfileDrawerProps) {\r\n  const t = useTranslations(\"Product\")\r\n  const router = useRouter()\r\n\r\n  const handleClose = () => onOpenChange(false)\r\n\r\n  const handleChat = () => {\r\n    onChat?.()\r\n    handleClose()\r\n  }\r\n\r\n  const handleFollow = () => {\r\n    onFollow?.()\r\n    // Don't close - user may want to continue browsing\r\n  }\r\n\r\n  const handleViewFullProfile = () => {\r\n    if (seller?.username) {\r\n      handleClose()\r\n      router.push(`/${seller.username}`)\r\n    }\r\n  }\r\n\r\n  if (!seller) return null\r\n\r\n  return (\r\n    <Drawer open={open} onOpenChange={onOpenChange}>\r\n      <DrawerContent\r\n        aria-label={seller.name}\r\n        showHandle\r\n        overlayBlur=\"sm\"\r\n      >\r\n        {/* Header with close button */}\r\n        <div className=\"flex items-center justify-between px-4 pb-2 border-b border-border-subtle\">\n          <DrawerTitle className=\"text-sm font-semibold text-foreground\">\n            {t(\"sellerInfo\")}\n          </DrawerTitle>\n          <DrawerClose asChild>\n            <IconButton\n              aria-label={t(\"close\")}\n              variant=\"ghost\"\n              size=\"icon-compact\"\n              className=\"shrink-0 -mr-2 rounded-full hover:bg-muted touch-manipulation\"\n            >\n              <X className=\"size-4\" />\n            </IconButton>\n          </DrawerClose>\n        </div>\n        <DrawerDescription className=\"sr-only\">\r\n          {t(\"seller.viewProfile\")} - {seller.name}\r\n        </DrawerDescription>\r\n\r\n        {/* Scrollable body */}\r\n        <DrawerBody className=\"space-y-4 py-4\">\r\n          {/* Profile Header */}\r\n          <SellerHeader seller={seller} />\r\n\r\n          {/* Stats */}\r\n          <SellerStats seller={seller} />\r\n\r\n          {/* Bio */}\r\n          <SellerBio bio={seller.bio} />\r\n\r\n          {/* Listings */}\r\n          <SellerListings\r\n            products={products}\r\n            sellerUsername={seller.username}\r\n            onClose={handleClose}\r\n          />\r\n        </DrawerBody>\r\n\r\n        {/* Footer with actions */}\r\n        <DrawerFooter className=\"border-t border-border-subtle\">\n          {/* Action buttons */}\r\n          <div className=\"flex gap-2\">\r\n            <Button\n              variant={isFollowing ? \"secondary\" : \"outline\"}\n              size=\"default\"\n              className=\"flex-1 gap-1.5\"\n              onClick={handleFollow}\n            >\n              <Users className=\"size-4\" />\r\n              {isFollowing ? t(\"seller.following\") : t(\"seller.follow\")}\r\n            </Button>\r\n            <Button\n              variant=\"default\"\n              size=\"default\"\n              className=\"flex-1 gap-1.5\"\n              onClick={handleChat}\n            >\n              <MessageCircle className=\"size-4\" />\r\n              {t(\"chat\")}\r\n            </Button>\r\n          </div>\r\n\r\n          {/* View full profile link */}\r\n          {seller.username && (\r\n            <Button\n              variant=\"ghost\"\n              size=\"compact\"\n              className=\"w-full text-sm text-primary\"\n              onClick={handleViewFullProfile}\n            >\n              {t(\"viewFullProfile\")}\r\n              <ExternalLink className=\"size-3.5 ml-1\" />\r\n            </Button>\r\n          )}\r\n        </DrawerFooter>\r\n      </DrawerContent>\r\n    </Drawer>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\filters\\mobile-filter-controls.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\home-section-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\home-sticky-category-pills.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\mobile-category-browser-contextual.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'handleBack' and 'handleCircleClick'. Either include them or remove the dependency array.","line":149,"column":6,"nodeType":"ArrayExpression","endLine":157,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [instant.categoryTitle, contextualInitialTitle, backHref, instant.activeSlug, instant.children, contextualSubcategories, setContextualHeader, handleBack, handleCircleClick]","fix":{"range":[5114,5296],"text":"[instant.categoryTitle, contextualInitialTitle, backHref, instant.activeSlug, instant.children, contextualSubcategories, setContextualHeader, handleBack, handleCircleClick]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect } from \"react\";\nimport type { CategoryTreeNode } from \"@/lib/category-tree\";\r\nimport type { UIProduct } from \"@/lib/data/products\";\r\nimport type { CategoryAttribute } from \"@/lib/data/categories\";\r\nimport { useRouter } from \"@/i18n/routing\";\nimport { useHeader } from \"@/components/providers/header-context\";\nimport { useInstantCategoryBrowse } from \"@/hooks/use-instant-category-browse\";\nimport { ProductFeed } from \"@/components/shared/product/product-feed\";\nimport { PageShell } from \"@/components/shared/page-shell\";\nimport { MobileFilterControls } from \"@/components/mobile/filters/mobile-filter-controls\";\n\r\ntype Category = CategoryTreeNode;\r\n\r\ninterface MobileCategoryBrowserContextualProps {\r\n  locale: string;\r\n  initialProducts: UIProduct[];\r\n  /** Which category slug the initialProducts are for. Defaults to \"all\" for homepage. */\r\n  initialProductsSlug: string;\r\n  /**\r\n   * Current category name for contextual header (localized).\r\n   * Required when contextualMode is true.\r\n   */\r\n  contextualCategoryName?: string;\r\n  /**\r\n   * Back navigation href for contextual header.\r\n   * Defaults to parent category or /categories.\r\n   */\r\n  contextualBackHref?: string;\r\n  /**\r\n   * Subcategories to display as horizontal pills in contextual mode.\r\n   * Replaces circles for compact navigation.\r\n   */\r\n  contextualSubcategories: Category[];\r\n  /** Filterable attributes for the current category (for filter drawer) */\r\n  filterableAttributes: CategoryAttribute[];\r\n  /** Current category ID for filter context. */\r\n  categoryId?: string;\r\n  /**\r\n   * Parent category of the current category.\r\n   * Used to determine if we're on L0 (null), L1 (parent is L0), or deeper.\r\n   */\r\n  parentCategory?: {\r\n    id: string;\r\n    slug: string;\r\n    parent_id: string | null;\r\n    name?: string;\r\n    name_bg?: string | null;\r\n  } | null;\r\n}\r\n\r\nexport function MobileCategoryBrowserContextual({\r\n  locale,\r\n  initialProducts,\r\n  initialProductsSlug,\r\n  contextualCategoryName,\r\n  contextualBackHref,\r\n  contextualSubcategories,\r\n  filterableAttributes,\r\n  categoryId,\r\n  parentCategory,\r\n}: MobileCategoryBrowserContextualProps) {\r\n  const router = useRouter();\r\n  const { setContextualHeader } = useHeader();\r\n\r\n  const contextualInitialTitle = contextualCategoryName || \"\";\n\r\n  // Convert CategoryTreeNode[] to CategoryLite[] for the hook\r\n  const initialChildrenForHook = contextualSubcategories.map((cat) => ({\r\n    id: cat.id,\r\n    name: cat.name,\r\n    name_bg: cat.name_bg,\r\n    slug: cat.slug,\r\n    parent_id: cat.parent_id ?? null,\r\n    icon: cat.icon ?? null,\r\n    image_url: cat.image_url ?? null,\r\n  }));\r\n\r\n  const instant = useInstantCategoryBrowse({\r\n    enabled: true,\r\n    locale,\r\n    initialSlug: initialProductsSlug,\r\n    initialTitle: contextualInitialTitle,\r\n    initialCategoryId: categoryId,\r\n    initialParent: parentCategory\r\n      ? {\r\n          id: parentCategory.id,\r\n          slug: parentCategory.slug,\r\n          parent_id: parentCategory.parent_id,\r\n          name: parentCategory.name ?? parentCategory.slug,\r\n          name_bg: parentCategory.name_bg ?? null,\r\n        }\r\n      : null,\r\n    initialChildren: initialChildrenForHook,\r\n    initialAttributes: filterableAttributes,\r\n    initialProducts,\r\n  });\r\n\r\n  const backHref = contextualBackHref || `/categories`;\r\n\r\n  const handleBack = async () => {\r\n    // Use instant client-side navigation (no page reload)\r\n    if (instant.parent?.slug) {\r\n      await instant.setCategorySlug(instant.parent.slug, { clearAttrFilters: true });\r\n      return;\r\n    }\r\n    // Only use router.push for going back to /categories index (no parent)\r\n    router.push(backHref);\r\n  };\r\n\r\n  // Use instant client-side navigation for circle clicks\r\n  const handleCircleClick = async (cat: CategoryTreeNode) => {\r\n    if (cat?.slug) {\r\n      await instant.setCategorySlug(cat.slug, { clearAttrFilters: true });\r\n    }\r\n  };\r\n\r\n  const handleApplyFilters = async (next: { queryString: string; finalPath: string }) => {\r\n    // finalPath is ignored in instant mode; URL sync is handled by the hook.\r\n    const params = new URLSearchParams(next.queryString);\r\n    await instant.setFilters(params);\r\n  };\r\n\r\n  // Remove a single filter (for FilterChips in instant mode)\r\n  const handleRemoveFilter = async (key: string, key2?: string) => {\r\n    const params = new URLSearchParams(instant.appliedSearchParams?.toString() ?? \"\");\r\n    params.delete(key);\r\n    if (key2) params.delete(key2);\r\n    await instant.setFilters(params);\r\n  };\r\n\r\n  // Clear all filters\r\n  const handleClearAllFilters = async () => {\r\n    await instant.setFilters(new URLSearchParams());\r\n  };\r\n\r\n  // Provide contextual header state to layout via context\r\n  useEffect(() => {\r\n    setContextualHeader({\r\n      title: instant.categoryTitle || contextualInitialTitle,\r\n      backHref,\r\n      onBack: handleBack,\r\n      activeSlug: instant.activeSlug,\r\n      subcategories: instant.children.length ? instant.children : contextualSubcategories,\r\n      onSubcategoryClick: handleCircleClick,\r\n    });\r\n    return () => setContextualHeader(null);\r\n  }, [\r\n    instant.categoryTitle,\r\n    contextualInitialTitle,\r\n    backHref,\r\n    instant.activeSlug,\r\n    instant.children,\r\n    contextualSubcategories,\r\n    setContextualHeader,\r\n  ]);\r\n\r\n  return (\n    <PageShell variant=\"muted\" className=\"w-full\">\n      {/* Header is rendered by layout with variant=\"contextual\" */}\n\n      <MobileFilterControls\n        locale={locale}\n        attributes={instant.attributes.length ? instant.attributes : filterableAttributes}\n        {...(instant.categorySlug !== \"all\" ? { categorySlug: instant.categorySlug } : {})}\n        {...(instant.categoryId ? { categoryId: instant.categoryId } : {})}\n        subcategories={(instant.children.length ? instant.children : contextualSubcategories).map((child) => ({\n          id: child.id,\n          name: child.name,\n          name_bg: child.name_bg,\n          slug: child.slug,\n        }))}\n        {...(instant.activeCategoryName ? { categoryName: instant.activeCategoryName } : {})}\n        basePath={`/categories/${instant.categorySlug}`}\n        appliedSearchParams={instant.appliedSearchParams}\n        onApply={handleApplyFilters}\n        onRemoveFilter={handleRemoveFilter}\n        onClearAll={handleClearAllFilters}\n        stickyTop=\"var(--app-header-offset)\"\n        sticky={true}\n        className=\"z-30\"\n      />\n\n      {/* Product Feed */}\n      <ProductFeed\n        products={instant.feed.products}\r\n        hasMore={instant.feed.hasMore}\r\n        isLoading={instant.isLoading}\r\n        activeSlug={instant.activeSlug}\r\n        locale={locale}\r\n        isAllTab={false}\r\n        activeCategoryName={instant.activeCategoryName}\r\n        onLoadMore={instant.loadMore}\n        showLoadingOverlay={true}\n      />\n    </PageShell>\n  );\n}\n\r\nexport type { MobileCategoryBrowserContextualProps };\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\mobile-category-browser.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\mobile-home.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_slug' is defined but never used.","line":86,"column":51,"nodeType":"Identifier","messageId":"unusedVar","endLine":86,"endColumn":56}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\"\nimport { PageShell } from \"@/components/shared/page-shell\"\nimport { MobileSearchOverlay } from \"@/components/shared/search/mobile-search-overlay\"\nimport { ProductCard } from \"@/components/shared/product/product-card\"\nimport { useHeader } from \"@/components/providers/header-context\"\nimport type { UIProduct } from \"@/lib/types/products\"\nimport type { CategoryTreeNode } from \"@/lib/category-tree\"\nimport { useTranslations } from \"next-intl\"\nimport { Link } from \"@/i18n/routing\"\nimport { CaretRight } from \"@phosphor-icons/react\"\nimport { HomeSectionHeader } from \"@/components/mobile/home-section-header\"\nimport { cn } from \"@/lib/utils\"\n\nimport { CategoryCirclesSimple } from \"@/components/mobile/category-nav\"\nimport { PromotedListingsStrip } from \"@/components/shared/promoted-listings-strip\"\nimport { HomeStickyCategoryPills } from \"@/components/mobile/home-sticky-category-pills\"\n\n// =============================================================================\n// Types\n// =============================================================================\n\ninterface CuratedSections {\n  deals: UIProduct[]\n  fashion: UIProduct[]\n  electronics: UIProduct[]\n  automotive: UIProduct[]\n}\n\ninterface MobileHomeProps {\n  initialProducts: UIProduct[]\n  promotedProducts?: UIProduct[]\n  curatedSections?: CuratedSections\n  initialCategories: CategoryTreeNode[]\n  locale: string\n  user?: { id: string } | null\n}\n\ntype CuratedRailKey = keyof CuratedSections\n\ninterface HomeCardConfig {\n  appearance: \"card\" | \"tile\"\n  media: \"square\" | \"portrait\" | \"landscape\"\n  titleLines: 1 | 2\n  showCategoryBadge: boolean\n  radius: \"xl\" | \"2xl\"\n  maxOverlayBadges: number\n}\n\ninterface HomeBannerConfig {\n  testId: string\n  href: string\n  title: string\n  cta: string\n  variant: \"promoted\" | \"forYou\"\n}\n\nconst CURATED_RAIL_PRIORITY: CuratedRailKey[] = [\"fashion\", \"electronics\", \"automotive\", \"deals\"]\n\nconst CURATED_RAIL_HREF: Record<CuratedRailKey, string> = {\n  fashion: \"/categories/fashion\",\n  electronics: \"/categories/electronics\",\n  automotive: \"/categories/automotive\",\n  deals: \"/todays-deals\",\n}\n\n// =============================================================================\n// Main Component\n// =============================================================================\n\nexport function MobileHome({\n  initialProducts,\n  promotedProducts,\n  curatedSections,\n  initialCategories,\n  locale,\n}: MobileHomeProps) {\n  const t = useTranslations(\"Home\")\n  const tMobile = useTranslations(\"Home.mobile\")\n  const [searchOpen, setSearchOpen] = useState(false)\n  const [showStickyCategoryPills, setShowStickyCategoryPills] = useState(false)\n  const categoryCirclesRef = useRef<HTMLDivElement | null>(null)\n\n  // Homepage category navigation is drawer-based; avoid legacy `?tab=` URL state.\n  const handleHeaderCategorySelect = useCallback((_slug: string) => {}, [])\n\n  const activePromotedProducts = useMemo(() => {\n    const now = Date.now()\n    return (promotedProducts ?? []).filter((p) => {\n      if (!p.isBoosted) return false\n      if (!p.boostExpiresAt) return false\n      const expiresAt = Date.parse(p.boostExpiresAt)\n      return Number.isFinite(expiresAt) && expiresAt > now\n    })\n  }, [promotedProducts])\n\n  const promotedRail = useMemo(() => activePromotedProducts.slice(0, 10), [activePromotedProducts])\n\n  const curatedRail = useMemo(() => {\n    const sections = curatedSections ?? {\n      deals: [],\n      fashion: [],\n      electronics: [],\n      automotive: [],\n    }\n\n    for (const key of CURATED_RAIL_PRIORITY) {\n      const products = sections[key]\n      if (Array.isArray(products) && products.length > 0) {\n        return { key, products, href: CURATED_RAIL_HREF[key] }\n      }\n    }\n\n    return null\n  }, [curatedSections])\n\n  const renderHomeCard = useCallback(\n    (product: UIProduct, index: number, config: HomeCardConfig) => (\n      <ProductCard\n        key={product.id}\n        id={product.id}\n        title={product.title}\n        price={product.price}\n        createdAt={product.createdAt ?? null}\n        originalPrice={product.listPrice ?? null}\n        image={product.image}\n        rating={product.rating}\n        reviews={product.reviews}\n        {...(product.freeShipping === true ? { freeShipping: true } : {})}\n        {...(product.isBoosted ? { isBoosted: true } : {})}\n        {...(product.boostExpiresAt ? { boostExpiresAt: product.boostExpiresAt } : {})}\n        index={index}\n        slug={product.slug ?? null}\n        username={product.storeSlug ?? null}\n        sellerId={product.sellerId ?? null}\n        {...((product.sellerName || product.storeSlug)\n          ? { sellerName: product.sellerName || product.storeSlug || \"\" }\n          : {})}\n        sellerAvatarUrl={product.sellerAvatarUrl || null}\n        sellerTier={product.sellerTier ?? \"basic\"}\n        sellerVerified={Boolean(product.sellerVerified)}\n        sellerEmailVerified={Boolean(product.sellerEmailVerified)}\n        sellerPhoneVerified={Boolean(product.sellerPhoneVerified)}\n        sellerIdVerified={Boolean(product.sellerIdVerified)}\n        {...(product.condition ? { condition: product.condition } : {})}\n        {...(product.brand ? { brand: product.brand } : {})}\n        {...(product.categorySlug ? { categorySlug: product.categorySlug } : {})}\n        {...(product.categoryRootSlug ? { categoryRootSlug: product.categoryRootSlug } : {})}\n        {...(product.categoryPath ? { categoryPath: product.categoryPath } : {})}\n        {...(product.make ? { make: product.make } : {})}\n        {...(product.model ? { model: product.model } : {})}\n        {...(product.year ? { year: product.year } : {})}\n        {...(product.location ? { location: product.location } : {})}\n        {...(product.attributes ? { attributes: product.attributes } : {})}\n        appearance={config.appearance}\n        media={config.media}\n        density=\"compact\"\n        titleLines={config.titleLines}\n        uiVariant=\"mobile-clean\"\n        showCategoryBadge={config.showCategoryBadge}\n        radius={config.radius}\n        maxOverlayBadges={config.maxOverlayBadges}\n      />\n    ),\n    []\n  )\n\n  const renderHomeBanner = useCallback(\n    ({ testId, href, title, cta, variant }: HomeBannerConfig) => (\n      <div\n        data-testid={testId}\n        className={cn(\n          \"w-full border-y\",\n          variant === \"promoted\"\n            ? \"border-foreground bg-foreground\"\n            : \"border-border-subtle bg-surface-subtle\"\n        )}\n      >\n        <Link\n          href={href}\n          className={cn(\n            \"group block tap-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-focus-ring\",\n            variant === \"promoted\"\n              ? \"hover:bg-foreground active:opacity-95\"\n              : \"hover:bg-hover active:bg-active\"\n          )}\n        >\n          <div className=\"flex min-h-(--control-primary) items-center gap-3 px-(--spacing-home-inset)\">\n            <span\n              aria-hidden=\"true\"\n              className={cn(\n                \"h-5 w-0.5 shrink-0 rounded-full\",\n                variant === \"promoted\" ? \"bg-background/75\" : \"bg-foreground/35\"\n              )}\n            />\n            <p\n              className={cn(\n                \"min-w-0 flex-1 truncate text-base font-semibold leading-tight tracking-tight\",\n                variant === \"promoted\" ? \"text-background\" : \"text-foreground\"\n              )}\n            >\n              {title}\n            </p>\n            <span\n              className={cn(\n                \"inline-flex shrink-0 items-center text-sm font-semibold transition-colors\",\n                variant === \"promoted\"\n                  ? \"text-background/90 group-hover:text-background\"\n                  : \"text-muted-foreground group-hover:text-foreground\"\n              )}\n            >\n              <span>{cta}</span>\n            </span>\n          </div>\n        </Link>\n      </div>\n    ),\n    []\n  )\n\n  // Get header context to provide dynamic state to layout's header\n  const { setHomepageHeader } = useHeader()\n\n  // Provide homepage header state to layout via context\n  useEffect(() => {\n    setHomepageHeader({\n      activeCategory: \"all\",\n      onCategorySelect: handleHeaderCategorySelect,\n      onSearchOpen: () => setSearchOpen(true),\n      categories: initialCategories,\n    })\n    return () => setHomepageHeader(null)\n  }, [handleHeaderCategorySelect, initialCategories, setHomepageHeader])\n\n  useEffect(() => {\n    const target = categoryCirclesRef.current\n    if (!target || typeof window === \"undefined\") return\n\n    let rafId = 0\n\n    const updateStickyVisibility = () => {\n      rafId = 0\n      const rect = target.getBoundingClientRect()\n      // Show only after circles are fully out of viewport.\n      const shouldShow = rect.bottom <= 0\n      setShowStickyCategoryPills((prev) => (prev === shouldShow ? prev : shouldShow))\n    }\n\n    const queueUpdate = () => {\n      if (rafId !== 0) return\n      rafId = window.requestAnimationFrame(updateStickyVisibility)\n    }\n\n    updateStickyVisibility()\n    window.addEventListener(\"scroll\", queueUpdate, { passive: true })\n    window.addEventListener(\"resize\", queueUpdate)\n\n    return () => {\n      window.removeEventListener(\"scroll\", queueUpdate)\n      window.removeEventListener(\"resize\", queueUpdate)\n      if (rafId !== 0) {\n        window.cancelAnimationFrame(rafId)\n      }\n    }\n  }, [])\n\n  return (\n    <PageShell variant=\"default\" className=\"pb-4\">\n      {/* Search Overlay */}\n      <MobileSearchOverlay\n        hideDefaultTrigger\n        externalOpen={searchOpen}\n        onOpenChange={setSearchOpen}\n      />\n\n      {/* Header is rendered by layout - passes variant=\"homepage\" with category pills */}\n      <div\n        ref={categoryCirclesRef}\n        data-testid=\"home-category-circles\"\n        className=\"bg-background\"\n      >\n        <CategoryCirclesSimple\n          categories={initialCategories}\n          locale={locale}\n          maxVisible={7}\n        />\n      </div>\n\n      <HomeStickyCategoryPills\n        visible={showStickyCategoryPills}\n        categories={initialCategories}\n        locale={locale}\n      />\n\n      {/* Main Content */}\n      <div className=\"pt-0 pb-4 space-y-2\">\n        <section\n          data-testid=\"home-section-promoted-banner\"\n          className=\"pt-1.5\"\n        >\n          {renderHomeBanner({\n            testId: \"home-section-promoted-banner-link\",\n            href: \"/search?promoted=true&sort=newest\",\n            title: tMobile(\"promoBannerTitle\"),\n            cta: tMobile(\"promoBannerCta\"),\n            variant: \"promoted\",\n          })}\n        </section>\n\n        {promotedRail.length > 0 && (\n          <PromotedListingsStrip\n            products={promotedRail}\n            layout=\"strip\"\n            maxItems={10}\n            showHeader={false}\n            showQuickScopes={false}\n            className=\"pt-1.5\"\n          />\n        )}\n\n        {initialProducts.length > 0 && (\n          <section data-testid=\"home-section-newest\" className=\"pt-1\">\n            {renderHomeBanner({\n              testId: \"home-section-for-you-banner\",\n              href: \"/search?sort=newest\",\n              title: tMobile(\"forYouBannerTitle\"),\n              cta: tMobile(\"forYouBannerCta\"),\n              variant: \"forYou\",\n            })}\n\n            <div className=\"mt-2 grid grid-cols-2 gap-(--spacing-home-card-gap) px-(--spacing-home-inset) pb-1\">\n              {initialProducts.map((product, index) =>\n                renderHomeCard(product, index, {\n                  appearance: \"card\",\n                  media: \"landscape\",\n                  titleLines: 1,\n                  showCategoryBadge: true,\n                  radius: \"2xl\",\n                  maxOverlayBadges: 2,\n                })\n              )}\n            </div>\n          </section>\n        )}\n\n        {curatedRail && (\n          <section data-testid=\"home-section-curated-rail\" className=\"pt-(--spacing-home-section-gap)\">\n            <HomeSectionHeader\n              title={t(`sections.${curatedRail.key}`)}\n              href={curatedRail.href}\n              actionLabel={tMobile(\"seeAll\")}\n            />\n\n            <div className=\"overflow-x-auto scroll-smooth no-scrollbar\">\n              <div className=\"flex snap-x snap-mandatory gap-(--spacing-home-card-gap) px-(--spacing-home-inset) pb-1.5\">\n                {curatedRail.products.slice(0, 10).map((product, index) => (\n                  <div\n                    key={product.id}\n                    className=\"w-(--spacing-home-card-column-w) shrink-0 snap-start\"\n                  >\n                    {renderHomeCard(product, index, {\n                      appearance: \"card\",\n                      media: \"landscape\",\n                      titleLines: 1,\n                      showCategoryBadge: true,\n                      radius: \"2xl\",\n                      maxOverlayBadges: 2,\n                    })}\n                  </div>\n                ))}\n              </div>\n            </div>\n          </section>\n        )}\n\n        {/* Final CTA: Browse all listings */}\n        <section className=\"px-(--spacing-home-inset) pt-1\">\n          <Link\n            href=\"/search?sort=newest\"\n            className=\"inline-flex min-h-(--spacing-touch-md) w-full items-center justify-between gap-3 rounded-xl border border-border-subtle bg-background px-4 py-3 text-sm font-semibold text-foreground transition-colors hover:bg-hover active:bg-active\"\n          >\n            <span className=\"min-w-0 truncate\">{tMobile(\"allListings\")}</span>\n            <CaretRight size={18} weight=\"bold\" className=\"text-muted-foreground shrink-0\" aria-hidden=\"true\" />\n          </Link>\n        </section>\n      </div>\n    </PageShell>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\mobile-tab-bar.tsx","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An empty interface declaration allows any non-nullish value, including literals like `0` and `\"\"`.\n- If that's what you want, disable this lint rule with an inline comment or configure the 'allowInterfaces' rule option.\n- If you want a type meaning \"any object\", you probably want `object` instead.\n- If you want a type meaning \"any value\", you probably want `unknown` instead.","line":14,"column":11,"nodeType":"Identifier","messageId":"noEmptyInterface","endLine":14,"endColumn":28,"suggestions":[{"messageId":"replaceEmptyInterface","data":{"replacement":"object"},"fix":{"range":[638,668],"text":"type MobileTabBarProps = object"},"desc":"Replace empty interface with `object`."},{"messageId":"replaceEmptyInterface","data":{"replacement":"unknown"},"fix":{"range":[638,668],"text":"type MobileTabBarProps = unknown"},"desc":"Replace empty interface with `unknown`."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is defined but never used.","line":16,"column":30,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":31}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useState } from \"react\"\nimport { House, SquaresFour, ChatCircle, UserCircle, Plus } from \"@phosphor-icons/react\"\nimport { Link, usePathname, useRouter } from \"@/i18n/routing\"\nimport { cn } from \"@/lib/utils\"\nimport { CountBadge } from \"@/components/shared/count-badge\"\nimport { useTranslations } from \"next-intl\"\nimport { useMessages } from \"@/components/providers/message-context\"\nimport { useDrawer } from \"@/components/providers/drawer-context\"\nimport { useCategoryDrawerOptional } from \"@/components/mobile/category-nav\"\nimport { useAuthOptional } from \"@/components/providers/auth-state-manager\"\n\ninterface MobileTabBarProps {}\n\nexport function MobileTabBar(_: MobileTabBarProps) {\n  const [mounted, setMounted] = useState(false)\n  useEffect(() => setMounted(true), [])\n\n  const router = useRouter()\n  const pathname = usePathname()\n  const t = useTranslations(\"Navigation\")\n  const categoryDrawer = useCategoryDrawerOptional()\n  const auth = useAuthOptional()\n\r\n  // Get unread message count from message context\n  const { totalUnreadCount } = useMessages()\n  const unreadCount = totalUnreadCount\n\n  // Get drawer actions for chat/account/auth buttons\n  const { openMessages, openAccount, openAuth, state: drawerState } = useDrawer()\n\r\n  // Avoid SSR/hydration mismatches caused by client-only UI (drawers/portals).\r\n  if (!mounted) return null\r\n\r\n  // Hide tab bar on product pages - they have their own sticky buy box\r\n  // Product pages use canonical format: /{locale}/{username}/{productSlug}\r\n  // (with or without locale in usePathname(), depending on next-intl config)\r\n  // Also hide on cart page - it has its own sticky checkout footer\r\n  // Also hide on assistant page - it has its own chat input\r\n  const rawSegments = pathname.split('/').filter(Boolean)\r\n  const pathSegments = (() => {\r\n    const segments = [...rawSegments]\r\n    const maybeLocale = segments[0]\r\n    if (maybeLocale && /^[a-z]{2}(-[A-Z]{2})?$/i.test(maybeLocale)) {\r\n      segments.shift()\r\n    }\r\n    return segments\r\n  })()\r\n  const knownRoutes = ['categories', 'cart', 'checkout', 'account', 'chat', 'sell', 'help', 'auth', 'search', 'admin', 'dashboard', 'plans', 'wishlist', 'orders', 'settings', 'notifications', 'assistant']\n  // /{username}/{slug-or-id} pattern: exactly 2 segments AND first segment is not a known route\r\n  const firstSegment = pathSegments.at(0)\r\n  const isProductPage = (pathSegments.length === 2 && !!firstSegment && !knownRoutes.includes(firstSegment))\r\n  // Cart page has its own sticky footer\r\n  const isCartPage = firstSegment === 'cart'\r\n  // Assistant page has its own chat input\r\n  const isAssistantPage = firstSegment === 'assistant'\r\n\r\n  const isActive = (path: string) => {\n    if (path === \"/\") return pathname === \"/\"\n    return pathname.startsWith(path)\n  }\n  const activeTextClass = \"text-foreground\"\n  const inactiveTextClass = \"text-muted-foreground\"\n  const iconClass = (active: boolean) =>\n    cn(\"transition-colors\", active ? activeTextClass : inactiveTextClass)\n  const isHomeActive = pathname === \"/\"\n  const isCategoriesActive = isActive(\"/categories\") || Boolean(categoryDrawer?.isOpen)\n  const isSellActive = isActive(\"/sell\")\n  const isChatActive = isActive(\"/chat\")\n  const chatAriaLabel = unreadCount > 0 ? `${t(\"chat\")} (${unreadCount})` : t(\"chat\")\n\n  const tabItemBase = cn(\n    \"flex min-h-(--control-default) w-full flex-col items-center justify-center gap-0 rounded-xl border border-transparent px-1.5 py-0.5\",\n    \"tap-transparent transition-colors\",\n    \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-focus-ring\"\n  )\n\n  const tabItemClass = (active: boolean) =>\n    cn(\n      tabItemBase,\n      active\n        ? \"bg-surface-subtle text-foreground\"\n        : \"text-muted-foreground hover:bg-hover active:bg-active\"\n    )\n\n  const tabLabelClass = (active: boolean) =>\n    cn(\n      \"text-2xs font-medium leading-none tracking-tight\",\n      active ? activeTextClass : inactiveTextClass\n    )\n\n  const isAuthenticated = Boolean(auth?.user)\n  const isProfileActive = drawerState.account.open || drawerState.auth.open || isActive(\"/account\")\n\r\n  // Don't render on product pages - let the sticky buy box take over\r\n  // Don't render on cart page - it has its own sticky checkout footer\r\n  // Don't render on assistant page - it has its own chat input\r\n  if (isProductPage || isCartPage || isAssistantPage) return null\r\n\r\n  return (\r\n    <>\r\n      <nav\n        className=\"pointer-events-none fixed inset-x-0 bottom-0 z-40 md:hidden\"\n        role=\"navigation\"\n        aria-label={t(\"mobileNavigation\")}\n        data-testid=\"mobile-tab-bar\"\n      >\n        <div className=\"mx-auto max-w-screen-sm px-2\">\n          <div\n            data-testid=\"mobile-tab-bar-dock\"\n            className=\"pointer-events-auto rounded-xl border border-border-subtle bg-surface-elevated px-1 py-0.5 pb-safe shadow-sm\"\n          >\n            <div className=\"grid grid-cols-5 items-end gap-0.5\">\n          {/* Home */}\n          <Link\n            href=\"/\"\n            prefetch={true}\n            className={tabItemClass(isHomeActive)}\n            aria-label={t(\"home\")}\n            aria-current={isHomeActive ? \"page\" : undefined}\n          >\n            <House \n              size={20}\n              weight={isHomeActive ? \"fill\" : \"regular\"}\n              className={iconClass(isHomeActive)} \n            />\n            <span className={cn(\n              tabLabelClass(isHomeActive)\n            )}>{t(\"home\")}</span>\n          </Link>\n\n          {/* Categories - Opens drawer sheet */}\n          <button\n            type=\"button\"\n            onClick={() => {\n              if (categoryDrawer) {\n                categoryDrawer.openRoot()\n                return\n              }\n              router.push(\"/categories\")\n            }}\n            className={tabItemClass(isCategoriesActive)}\n            aria-label={t(\"categories\")}\n            aria-haspopup=\"dialog\"\n            aria-expanded={categoryDrawer?.isOpen}\n          >\n            <SquaresFour \n              size={20}\n              weight={isCategoriesActive ? \"fill\" : \"regular\"}\n              className={iconClass(isCategoriesActive)} \n            />\n            <span className={cn(\n              tabLabelClass(isCategoriesActive)\n            )}>{t(\"categories\")}</span>\n          </button>\n\n          {/* Sell */}\n          <Link\n            href=\"/sell\"\n            prefetch={true}\n            className={cn(\n              tabItemBase,\n              isSellActive\n                ? \"bg-surface-subtle text-foreground\"\n                : \"text-muted-foreground hover:bg-hover active:bg-active\"\n            )}\n            aria-label={t(\"sell\")}\n            aria-current={isSellActive ? \"page\" : undefined}\n            data-testid=\"mobile-tab-sell\"\n          >\n            <span\n              className={cn(\n                \"inline-flex size-(--control-default) items-center justify-center rounded-full border transition-colors\",\n                isActive(\"/sell\")\n                  ? \"border-foreground bg-foreground text-background\"\n                  : \"border-border-subtle bg-background text-foreground hover:bg-hover active:bg-active\"\n              )}\n            >\n              <Plus\n                size={17}\n                weight=\"bold\"\n                className={cn(\"transition-colors\", isSellActive ? \"text-background\" : activeTextClass)}\n              />\n            </span>\n          </Link>\n\r\n          {/* Chat - Opens messages drawer */}\r\n          <button\n            type=\"button\"\n            onClick={openMessages}\n            className={tabItemClass(isChatActive)}\n            aria-label={chatAriaLabel}\n            aria-haspopup=\"dialog\"\n          >\n            <span className=\"relative\">\n              <ChatCircle \n                size={20}\n                weight={isChatActive ? \"fill\" : \"regular\"}\n                className={iconClass(isChatActive)} \n              />\n              {unreadCount > 0 && (\n                <CountBadge\n                  count={unreadCount}\n                  className=\"absolute -top-1 -right-1.5 h-3.5 min-w-3.5 bg-notification px-0.5 text-2xs text-primary-foreground\"\n                  aria-hidden=\"true\"\n                />\n              )}\n            </span>\n            <span className={cn(\n              tabLabelClass(isChatActive)\n            )}>{t(\"chat\")}</span>\n          </button>\n\r\n          {/* Profile - Authenticated opens account drawer; guest opens auth drawer */}\n          <button\n            type=\"button\"\n            onClick={() => {\n              if (isAuthenticated) {\n                openAccount()\n                return\n              }\n              openAuth({ mode: \"login\", entrypoint: \"profile_tab\" })\n            }}\n            className={tabItemClass(isProfileActive)}\n            aria-label={t(\"profile\")}\n            aria-haspopup=\"dialog\"\n            aria-expanded={drawerState.account.open || drawerState.auth.open}\n            data-testid=\"mobile-tab-profile\"\n          >\n            <UserCircle\n              size={20}\n              weight={isProfileActive ? \"fill\" : \"regular\"}\n              className={iconClass(isProfileActive)}\n            />\n            <span\n              className={cn(\n                tabLabelClass(isProfileActive)\n              )}\n            >\n              {t(\"profile\")}\n            </span>\n          </button>\n            </div>\n          </div>\n        </div>\n      </nav>\n    </>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\product\\mobile-bottom-bar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'discount' is assigned a value but never used.","line":74,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":74,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\n// =============================================================================\r\n// MOBILE BOTTOM BAR - Category-Adaptive Sticky Action Bar\n// =============================================================================\r\n// Based on V2 demo design. Key features:\r\n// - Category-adaptive CTAs:\r\n//   - Default: Chat + Add to Cart\r\n//   - Automotive: Call + Contact Seller\r\n//   - Real-estate: Schedule Visit + Contact Agent\r\n// - Safe area padding for mobile devices\r\n// - Subtle top border with shadow\r\n// =============================================================================\r\n\r\nimport { MessageCircle, ShoppingCart, Phone, Calendar, User } from \"lucide-react\"\nimport { Button } from \"@/components/ui/button\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { useCart } from \"@/components/providers/cart-context\"\r\nimport { useRouter } from \"@/i18n/routing\"\r\nimport { useTranslations, useLocale } from \"next-intl\"\r\nimport type { CategoryType } from \"@/lib/utils/category-type\"\r\n\r\nexport interface MobileBottomBarProps {\n  categoryType: CategoryType\n  /** Product info for cart and navigation */\n  product: {\n    id: string\r\n    title: string\r\n    price: number\r\n    originalPrice?: number | null\r\n    currency?: string\r\n    image: string\r\n    slug?: string\r\n    username?: string\r\n  }\r\n  /** Seller info for contact actions */\r\n  seller?: {\r\n    id: string\r\n    displayName: string\r\n    phone?: string\r\n  }\r\n  className?: string\r\n}\n\r\n/**\r\n * Mobile Bottom Bar\n * \n * Sticky action bar with category-adaptive CTAs:\n * - default: Chat + Add to Cart (e-commerce)\n * - automotive: Call Seller + Contact Seller (vehicle listings)\n * - real-estate: Schedule Visit + Contact Agent (property listings)\n */\nexport function MobileBottomBar({\n  categoryType,\n  product,\n  seller,\n  className,\n}: MobileBottomBarProps) {\n  const t = useTranslations(\"Product\")\r\n  const locale = useLocale()\r\n  const router = useRouter()\r\n  const { addToCart } = useCart()\r\n\r\n  // Price formatting\r\n  const currency = product.currency || \"EUR\"\r\n  const formatPrice = (p: number) =>\r\n    new Intl.NumberFormat(locale === \"bg\" ? \"bg-BG\" : \"en-IE\", {\r\n      style: \"currency\",\r\n      currency,\r\n      minimumFractionDigits: currency === \"BGN\" ? 0 : 2,\r\n      maximumFractionDigits: currency === \"BGN\" ? 0 : 2,\r\n    }).format(p)\r\n\r\n  const discount = product.originalPrice\r\n    ? Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100)\r\n    : 0\r\n\r\n  // Navigate to chat\r\n  const handleChat = () => {\r\n    if (!seller?.id) return\r\n    const params = new URLSearchParams({ seller: seller.id })\r\n    if (product.id) params.set(\"product\", product.id)\r\n    router.push(`/chat?${params.toString()}`)\r\n  }\r\n\r\n  // Add to cart\r\n  const handleAddToCart = () => {\r\n    addToCart({\r\n      id: product.id,\r\n      title: product.title,\r\n      price: product.price,\r\n      image: product.image,\r\n      quantity: 1,\r\n      ...(product.username ? { username: product.username } : {}),\r\n    })\r\n  }\r\n\r\n  // Call seller\r\n  const handleCall = () => {\r\n    if (!seller?.phone) return\r\n    window.location.href = `tel:${seller.phone}`\r\n  }\r\n\r\n  // Contact seller/agent (opens chat or contact form)\r\n  const handleContact = () => {\r\n    if (!seller?.id) return\r\n    // Include product ID for context in the conversation\r\n    const params = new URLSearchParams({ seller: seller.id })\r\n    if (product.id) params.set(\"product\", product.id)\r\n    router.push(`/chat?${params.toString()}`)\r\n  }\r\n\r\n  // Schedule visit (opens contact with inquiry type)\r\n  const handleScheduleVisit = () => {\r\n    if (!seller?.id) return\r\n    const params = new URLSearchParams({ seller: seller.id, type: \"visit\" })\r\n    if (product.id) params.set(\"product\", product.id)\r\n    router.push(`/chat?${params.toString()}`)\r\n  }\r\n\r\n  // Render appropriate buttons based on category type\r\n  const renderButtons = () => {\r\n    switch (categoryType) {\r\n      case \"automotive\":\r\n        return (\r\n          <>\r\n            <Button\n              variant=\"outline\"\n              size=\"primary\"\n              className=\"flex-1 gap-2\"\n              onClick={handleCall}\n              disabled={!seller?.phone}\n            >\n              <Phone className=\"size-5\" />\r\n              <span>{t(\"callSeller\")}</span>\r\n            </Button>\r\n            <Button\n              size=\"primary\"\n              className=\"flex-1 gap-2\"\n              onClick={handleContact}\n              disabled={!seller}\n            >\n              <User className=\"size-5\" />\r\n              <span>{t(\"contactSeller\")}</span>\r\n            </Button>\r\n          </>\r\n        )\r\n\r\n      case \"real-estate\":\r\n        return (\r\n          <>\r\n            <Button\n              variant=\"outline\"\n              size=\"primary\"\n              className=\"flex-1 gap-2\"\n              onClick={handleScheduleVisit}\n              disabled={!seller}\n            >\n              <Calendar className=\"size-5\" />\r\n              <span>{t(\"scheduleVisit\")}</span>\r\n            </Button>\r\n            <Button\n              size=\"primary\"\n              className=\"flex-1 gap-2\"\n              onClick={handleContact}\n              disabled={!seller}\n            >\n              <User className=\"size-5\" />\r\n              <span>{t(\"contactAgent\")}</span>\r\n            </Button>\r\n          </>\r\n        )\r\n\r\n      default:\r\n        return (\r\n          <>\r\n            <Button\n              variant=\"outline\"\n              size=\"primary\"\n              className=\"flex-1 gap-2\"\n              onClick={handleChat}\n              disabled={!seller}\n            >\n              <MessageCircle className=\"size-5\" />\r\n              <span>{t(\"chat\")}</span>\r\n            </Button>\r\n            <Button\n              size=\"primary\"\n              className=\"flex-[1.5] gap-2\"\n              onClick={handleAddToCart}\n            >\n              <ShoppingCart className=\"size-5\" />\r\n              <span>{t(\"add\")} ┬╖ {formatPrice(product.price)}</span>\r\n            </Button>\r\n          </>\r\n        )\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div\r\n      className={cn(\n        \"fixed bottom-0 left-0 right-0 z-50\",\n        \"border-t border-border bg-background\",\n        \"pb-safe\",\n        className\n      )}\n    >\r\n      <div className=\"px-3 py-2.5 max-w-lg mx-auto\">\r\n        <div className=\"flex gap-2\">\r\n          {renderButtons()}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\product\\mobile-gallery.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\product\\mobile-product-single-scroll.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ResolvedHeroSpec' is defined but never used.","line":35,"column":37,"nodeType":"Identifier","messageId":"unusedVar","endLine":35,"endColumn":53,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ResolvedHeroSpec"},"fix":{"range":[2013,2031],"text":""},"desc":"Remove unused variable \"ResolvedHeroSpec\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\n// =============================================================================\r\n// MOBILE PRODUCT PAGE - Single Scroll Layout (TradeSphere Pattern)\r\n// =============================================================================\r\n// Clean, modern mobile product page with single continuous scroll.\r\n// No tabs - all content flows naturally for optimal mobile UX.\r\n// =============================================================================\r\n\r\nimport { useState, useEffect } from \"react\";\r\nimport { useTranslations, useLocale } from \"next-intl\";\r\nimport { formatDistanceToNow } from \"date-fns\";\r\nimport { bg, enUS } from \"date-fns/locale\";\r\n\r\n// Mobile-specific components\nimport { MobileGallery } from \"./mobile-gallery\";\nimport { MobileBottomBar } from \"./mobile-bottom-bar\";\nimport { MobileSellerPreviewCard } from \"./mobile-seller-preview-card\";\nimport { MobileSafetyTips, MobileReportButton } from \"./mobile-trust-sections\";\nimport { SellerProfileDrawer } from \"@/components/mobile/drawers/seller-profile-drawer\";\n\r\n// Shared product components\r\nimport { MetaRow, type CategorySummary } from \"@/components/shared/product/meta-row\";\nimport { ProductHeader } from \"@/components/shared/product/product-header\";\nimport { SpecificationsList } from \"@/components/shared/product/specifications-list\";\nimport { ProductDescription } from \"@/components/shared/product/product-description\";\nimport { DeliveryOptions } from \"@/components/shared/product/delivery-options\";\nimport { ShippingReturnsInfo } from \"@/components/shared/product/shipping-returns-info\";\nimport { SimilarItemsGrid } from \"@/components/shared/product/similar-items-grid\";\nimport { RecentlyViewedTracker } from \"@/components/shared/product/recently-viewed-tracker\";\nimport { PageShell } from \"@/components/shared/page-shell\";\nimport { HeroSpecs } from \"@/components/shared/product/hero-specs\";\r\nimport { CustomerReviewsHybrid } from \"@/components/shared/product/customer-reviews-hybrid\";\r\n\r\nimport type { ProductPageViewModel, ResolvedHeroSpec } from \"@/lib/view-models/product-page\";\r\nimport type { Database } from \"@/lib/supabase/database.types\";\r\nimport type { CustomerReview } from \"@/components/shared/product/customer-reviews-hybrid\";\r\nimport type { SubmitReviewFn } from \"@/components/shared/product/write-review-dialog\";\r\n\r\ntype ProductRow = Database[\"public\"][\"Tables\"][\"products\"][\"Row\"];\r\ntype SellerStatsRow = Database[\"public\"][\"Tables\"][\"seller_stats\"][\"Row\"];\r\ntype ProductVariantRow = Database[\"public\"][\"Tables\"][\"product_variants\"][\"Row\"];\r\n\r\ntype ProductWithSellerStats = ProductRow & {\r\n  seller_stats?: Partial<SellerStatsRow> | null;\r\n  viewers_count?: number | null;\r\n  sold_count?: number | null;\r\n  is_negotiable?: boolean;\r\n};\r\n\r\ntype SellerSummary = {\r\n  id: string;\r\n  username?: string | null;\r\n  display_name?: string | null;\r\n  avatar_url?: string | null;\r\n  verified?: boolean | null;\r\n  created_at?: string | null;\r\n};\r\n\r\ninterface MobileProductSingleScrollProps {\n  locale: string;\n  username: string;\n  productSlug: string;\n  product: ProductWithSellerStats;\n  seller: SellerSummary;\n  category: CategorySummary | null;\r\n  parentCategory: CategorySummary | null;\r\n  rootCategory: CategorySummary | null;\r\n  relatedProducts: ProductPageViewModel[\"relatedProducts\"];\r\n  reviews: CustomerReview[];\r\n  viewModel: ProductPageViewModel;\r\n  variants?: ProductVariantRow[];\r\n  submitReview?: SubmitReviewFn;\n  favoritesCount?: number | null;\n}\n\n// -----------------------------------------------------------------------------\n// Main Component\n// -----------------------------------------------------------------------------\n\r\nexport function MobileProductSingleScroll(props: MobileProductSingleScrollProps) {\r\n  const t = useTranslations(\"Product\");\r\n  const currentLocale = useLocale();\r\n  const {\r\n    locale,\r\n    username,\r\n    product,\r\n    seller,\r\n    category,\r\n    rootCategory,\r\n    relatedProducts,\r\n    reviews,\r\n    viewModel,\r\n    variants,\r\n    submitReview,\r\n  } = props;\r\n\r\n  const safeVariants = Array.isArray(variants) ? variants : [];\r\n  const defaultVariant = safeVariants.find((v) => v.is_default) ?? safeVariants[0] ?? null;\r\n\r\n  const primaryImageSrc = viewModel.galleryImages?.[0]?.src ?? null;\r\n\r\n  // Cart/wishlist product info\r\n  const cartProduct = {\r\n    id: String(product.id),\r\n    title: String(product.title ?? \"\"),\r\n    price: Number(product.price ?? 0),\r\n    image: primaryImageSrc ?? \"\",\r\n    slug: product.slug || product.id,\r\n    username: seller?.username || username,\r\n  };\r\n\r\n  // Base/display prices\r\n  const basePrice = Number(product.price ?? 0);\r\n  const displayPrice =\r\n    safeVariants.length > 0\r\n      ? basePrice + Number(defaultVariant?.price_adjustment ?? 0)\r\n      : basePrice;\r\n  const displayRegularPrice = product.list_price != null ? Number(product.list_price) : null;\r\n\r\n  // Time ago formatting\r\n  const [mounted, setMounted] = useState(false);\r\n  const [sellerDrawerOpen, setSellerDrawerOpen] = useState(false);\r\n  useEffect(() => setMounted(true), []);\r\n\r\n  const timeAgo =\r\n    mounted && product.created_at\r\n      ? formatDistanceToNow(new Date(product.created_at), {\r\n          addSuffix: false,\r\n          locale: currentLocale === \"bg\" ? bg : enUS,\r\n        })\r\n      : null;\r\n\r\n  // View/favorites counts\r\n  const viewCount = product.view_count ?? product.viewers_count ?? null;\r\n\r\n  // Seller preview info\r\n  const sellerPreview = {\r\n    id: seller.id,\r\n    name:\r\n      viewModel.sellerName || seller?.display_name || seller?.username || username || t(\"seller\"),\r\n    username: seller?.username ?? null,\r\n    avatarUrl: viewModel.sellerAvatarUrl ?? seller?.avatar_url ?? null,\r\n    verified: Boolean(viewModel.sellerVerified || seller?.verified),\r\n    rating:\r\n      product.seller_stats?.average_rating != null\r\n        ? Number(product.seller_stats.average_rating)\r\n        : null,\r\n    reviewCount:\r\n      product.seller_stats?.total_reviews != null\r\n        ? Number(product.seller_stats.total_reviews)\r\n        : null,\r\n    responseTimeHours:\r\n      product.seller_stats?.response_time_hours != null\r\n        ? Number(product.seller_stats.response_time_hours)\r\n        : null,\r\n    listingsCount:\r\n      product.seller_stats?.active_listings != null\r\n        ? Number(product.seller_stats.active_listings)\r\n        : null,\r\n    totalSales:\r\n      product.seller_stats?.total_sales != null ? Number(product.seller_stats.total_sales) : null,\r\n    positivePercent:\r\n      product.seller_stats?.positive_feedback_pct != null\r\n        ? Number(product.seller_stats.positive_feedback_pct)\r\n        : null,\r\n    joinedAt: seller?.created_at ?? null,\r\n    joinedYear: seller?.created_at ? new Date(seller.created_at).getFullYear().toString() : null,\r\n    bio: null as string | null, // TODO: Add seller bio when available\r\n  };\r\n\r\n  // Convert relatedProducts to drawer-compatible format\r\n  const sellerProducts = relatedProducts.map((p) => ({\r\n    id: p.id,\r\n    title: p.title,\r\n    price: p.price,\r\n    originalPrice: p.originalPrice,\r\n    image: p.image,\r\n    slug: p.slug ?? null,\r\n    storeSlug: p.storeSlug ?? null,\r\n  }));\r\n\r\n  // Handle report (placeholder)\r\n  const handleReport = () => {\r\n    // TODO: Implement report modal/flow\r\n    console.log(\"Report listing:\", product.id);\r\n  };\r\n\r\n  const pickupOnly = product.pickup_only ?? false;\r\n  const freeShipping = product.free_shipping === true;\n  const isNegotiable = Boolean(product.is_negotiable);\r\n\r\n  return (\r\n    <PageShell variant=\"muted\" className=\"pb-20 md:pb-28 lg:hidden\">\r\n      {/* JSON-LD Structured Data for SEO */}\r\n      <script\r\n        type=\"application/ld+json\"\r\n        dangerouslySetInnerHTML={{ __html: JSON.stringify(viewModel.jsonLd) }}\r\n      />\r\n      <script\r\n        type=\"application/ld+json\"\r\n        dangerouslySetInnerHTML={{ __html: JSON.stringify(viewModel.breadcrumbJsonLd) }}\r\n      />\r\n\r\n      {/* Track Recently Viewed */}\r\n      <RecentlyViewedTracker\r\n        product={{\r\n          id: product.id,\r\n          title: product.title,\r\n          price: Number(product.price ?? 0),\r\n          image: primaryImageSrc,\r\n          slug: product.slug || product.id,\r\n          username: seller?.username ?? null,\r\n        }}\r\n      />\r\n\r\n      {/* ========== GALLERY ========== */}\r\n      <MobileGallery images={viewModel.galleryImages} product={cartProduct} />\n\r\n      {/* ========== CONTENT (Single Scroll) ========== */}\r\n      <div className=\"bg-card space-y-4 py-4\">\r\n        {/* Meta Row: Category + Time/Views */}\r\n        <div className=\"px-4\">\r\n          <MetaRow\r\n            category={category}\r\n            rootCategory={rootCategory}\r\n            timeAgo={timeAgo}\r\n            viewCount={viewCount}\r\n            locale={currentLocale}\r\n          />\r\n        </div>\r\n\r\n        {/* Price + Title + Badges (compact TradeSphere pattern) */}\r\n        <div className=\"px-4\">\r\n          <ProductHeader\r\n            title={product.title ?? \"\"}\r\n            condition={product.condition}\r\n            freeShipping={freeShipping}\r\n            price={displayPrice}\r\n            currency=\"EUR\"\r\n            isNegotiable={isNegotiable}\r\n            locale={currentLocale}\r\n          />\r\n        </div>\r\n\r\n        {/* Hero Specs */}\r\n        {viewModel.heroSpecs.length > 0 && (\r\n          <div className=\"px-4\">\r\n            <HeroSpecs specs={viewModel.heroSpecs.slice(0, 4)} variant=\"mobile\" />\r\n          </div>\r\n        )}\r\n\r\n        {/* Specifications */}\r\n        <div className=\"px-4\">\r\n          <SpecificationsList specifications={viewModel.itemSpecifics.details || []} />\r\n        </div>\r\n\r\n        {/* Description */}\r\n        <div className=\"px-4\">\r\n          <ProductDescription description={product.description} />\r\n        </div>\r\n\r\n        {/* Delivery Options */}\r\n        <div className=\"px-4\">\r\n          <DeliveryOptions pickupOnly={pickupOnly} freeShipping={freeShipping} />\r\n        </div>\r\n\r\n        {/* Shipping & Returns */}\r\n        <div className=\"px-4\">\r\n          <ShippingReturnsInfo pickupOnly={pickupOnly} />\r\n        </div>\r\n\r\n        {/* Seller Preview Card (above reviews) */}\r\n        <div className=\"px-4\">\r\n          <MobileSellerPreviewCard \r\n            seller={sellerPreview} \r\n            onViewProfile={() => setSellerDrawerOpen(true)}\r\n          />\r\n        </div>\r\n\r\n        {/* Customer Reviews */}\r\n        <div className=\"px-4 pt-2\">\r\n          <CustomerReviewsHybrid\r\n            rating={Number(product.rating ?? 0)}\r\n            reviewCount={Number(product.review_count ?? 0)}\r\n            reviews={reviews}\r\n            productId={product.id}\r\n            productTitle={product.title ?? \"\"}\r\n            locale={locale}\r\n            {...(submitReview && { submitReview })}\r\n          />\r\n        </div>\r\n\r\n        {/* Safety Tips */}\r\n        <div className=\"px-4 pt-2\">\r\n          <MobileSafetyTips />\r\n        </div>\r\n\r\n        {/* Report Listing */}\r\n        <div className=\"px-4\">\r\n          <MobileReportButton onReport={handleReport} />\r\n        </div>\r\n      </div>\r\n\r\n      {/* ========== SIMILAR ITEMS ========== */}\r\n      <SimilarItemsGrid products={relatedProducts} rootCategory={rootCategory} />\r\n\r\n      {/* ========== BOTTOM BAR ========== */}\r\n      <MobileBottomBar\n        categoryType={viewModel.categoryType}\n        product={{\n          id: cartProduct.id,\n          title: cartProduct.title,\r\n          price: displayPrice,\r\n          originalPrice: displayRegularPrice,\r\n          currency: \"EUR\",\r\n          image: cartProduct.image,\r\n          slug: cartProduct.slug,\r\n          username: cartProduct.username,\r\n        }}\r\n        seller={{\r\n          id: seller.id,\r\n          displayName: sellerPreview.name,\r\n        }}\r\n      />\r\n\r\n      {/* ========== SELLER PROFILE DRAWER ========== */}\r\n      <SellerProfileDrawer\r\n        open={sellerDrawerOpen}\r\n        onOpenChange={setSellerDrawerOpen}\r\n        seller={sellerPreview}\r\n        products={sellerProducts}\r\n      />\r\n    </PageShell>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\product\\mobile-seller-preview-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\mobile\\product\\mobile-trust-sections.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\providers\\_lib\\analytics-drawer.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\providers\\auth-state-manager.tsx","messages":[{"ruleId":"unicorn/prefer-optional-catch-binding","severity":1,"message":"Remove unused catch binding `error`.","line":67,"column":16,"nodeType":"Identifier","messageId":"with-name","endLine":67,"endColumn":21,"fix":{"range":[1709,1717],"text":""}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":67,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":67,"endColumn":21},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'refreshSession'. Either include it or remove the dependency array.","line":140,"column":6,"nodeType":"ArrayExpression","endLine":140,"endColumn":37,"suggestions":[{"desc":"Update the dependencies array to be: [pathname, refreshSession, refreshWithThrottle]","fix":{"range":[3744,3775],"text":"[pathname, refreshSession, refreshWithThrottle]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useContext\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":179,"column":25,"nodeType":"Identifier","endLine":179,"endColumn":35,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useContext\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":183,"column":19,"nodeType":"Identifier","endLine":183,"endColumn":29,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\"\n\nimport {\n  createContext,\n  useContext,\n  useEffect,\n  useState,\n  useCallback,\n  useRef,\n  type ReactNode,\n  type Context,\n} from \"react\"\nimport { usePathname } from \"next/navigation\"\nimport { createClient } from \"@/lib/supabase/client\"\nimport type { User, Session, AuthChangeEvent } from \"@supabase/supabase-js\"\n\r\ninterface AuthState {\r\n  user: User | null\r\n  session: Session | null\r\n  isLoading: boolean\r\n  isAuthenticated: boolean\r\n}\r\n\r\ninterface AuthContextType extends AuthState {\r\n  signOut: () => Promise<void>\r\n  refreshSession: () => Promise<void>\r\n}\r\n\r\nconst AuthContext = createContext<AuthContextType | null>(null)\r\n\r\nexport function AuthStateManager({ children }: { children: ReactNode }) {\n  const [state, setState] = useState<AuthState>({\n    user: null,\n    session: null,\n    isLoading: true,\n    isAuthenticated: false,\n  })\n\n  const pathname = usePathname()\n  const isInitializedRef = useRef(false)\n  const pendingRefreshRef = useRef<Promise<void> | null>(null)\n  const lastPathnameRef = useRef<string | null>(null)\n  const lastRefreshRef = useRef<number>(0)\n\r\n  const refreshSession = useCallback(async () => {\n    // Prevent concurrent refreshes\r\n    if (pendingRefreshRef.current) {\r\n      return pendingRefreshRef.current\r\n    }\r\n\r\n    pendingRefreshRef.current = (async () => {\r\n      try {\r\n        const supabase = createClient()\r\n        const {\r\n          data: { session },\r\n          error,\r\n        } = await supabase.auth.getSession()\r\n\r\n        if (error) throw error\r\n\r\n        setState({\r\n          user: session?.user ?? null,\r\n          session: session,\r\n          isLoading: false,\r\n          isAuthenticated: !!session?.user,\r\n        })\r\n      } catch (error) {\n        // Avoid logging raw error objects in client (can contain request details).\n        console.error(\"Failed to refresh session\")\n        setState((prev) => ({ ...prev, isLoading: false }))\n      } finally {\n        pendingRefreshRef.current = null\n      }\n    })()\n\r\n    return pendingRefreshRef.current\r\n  }, [])\n\n  const refreshWithThrottle = useCallback(async () => {\n    const now = Date.now()\n    if (now - lastRefreshRef.current < 30_000) return\n    lastRefreshRef.current = now\n    await refreshSession()\n  }, [refreshSession])\n\r\n  const signOut = useCallback(async () => {\r\n    const supabase = createClient()\r\n    await supabase.auth.signOut()\r\n    // State will be updated by onAuthStateChange\r\n  }, [])\r\n\r\n  useEffect(() => {\n    if (isInitializedRef.current) return\n    isInitializedRef.current = true\n\n    const supabase = createClient()\n\n    // SINGLE auth state listener for the entire app\n    const {\n      data: { subscription },\n    } = supabase.auth.onAuthStateChange(\n      async (_event: AuthChangeEvent, session: Session | null) => {\n        setState({\r\n          user: session?.user ?? null,\r\n          session: session,\r\n          isLoading: false,\r\n          isAuthenticated: !!session?.user,\r\n        })\r\n\r\n      }\n    )\n\r\n    return () => {\n      subscription.unsubscribe()\n    }\n  }, [refreshSession])\n\n  // Sync session on navigation when leaving auth routes. This fixes cases where auth is\n  // performed on the server (server actions setting cookies), which won't trigger the\n  // browser client's onAuthStateChange event.\n  useEffect(() => {\n    if (!pathname) return\n\n    const previous = lastPathnameRef.current\n    if (previous === pathname) return\n    lastPathnameRef.current = pathname\n\n    // First load: always fetch once.\n    if (!previous) {\n      void refreshSession()\n      return\n    }\n\n    const wasAuthRoute = previous.includes(\"/auth\")\n    const isAuthRoute = pathname.includes(\"/auth\")\n\n    if (wasAuthRoute && !isAuthRoute) {\n      void refreshWithThrottle()\n    }\n  }, [pathname, refreshWithThrottle])\n\n  useEffect(() => {\n    if (!state.isAuthenticated) return\n\n    const handleVisibility = () => {\n      if (document.visibilityState === \"visible\") {\n        void refreshWithThrottle()\n      }\n    }\n\n    const interval = window.setInterval(() => {\n      void refreshWithThrottle()\n    }, 10 * 60 * 1000)\n\n    document.addEventListener(\"visibilitychange\", handleVisibility)\n\n    return () => {\n      clearInterval(interval)\n      document.removeEventListener(\"visibilitychange\", handleVisibility)\n    }\n  }, [state.isAuthenticated, refreshWithThrottle])\n\n  return (\n    <AuthContext.Provider value={{ ...state, signOut, refreshSession }}>\n      {children}\n    </AuthContext.Provider>\n  )\n}\n\nexport function useAuth(): AuthContextType {\n  // In Storybook, use the mock context if available\n  const storybookAuthContext =\n    typeof window !== \"undefined\"\n      ? (window as unknown as { __STORYBOOK_AUTH_CONTEXT__?: unknown }).__STORYBOOK_AUTH_CONTEXT__\n      : undefined\n\n  if (storybookAuthContext) {\n    // eslint-disable-next-line react-hooks/rules-of-hooks\n    const mockContext = useContext(storybookAuthContext as Context<AuthContextType | null>)\n    if (mockContext) return mockContext\n  }\n  // eslint-disable-next-line react-hooks/rules-of-hooks\n  const context = useContext(AuthContext)\n  if (!context) {\n    throw new Error(\"useAuth must be used within AuthStateManager\")\n  }\r\n  return context\r\n}\r\n\r\n/**\r\n * Optional hook for components that might be rendered outside AuthStateManager.\r\n * Returns null if not within the provider, allowing graceful degradation.\r\n */\r\nexport function useAuthOptional() {\r\n  return useContext(AuthContext)\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\providers\\cart-context.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'activeUserId' is defined but never used.","line":193,"column":52,"nodeType":"Identifier","messageId":"unusedVar","endLine":193,"endColumn":64}],"suppressedMessages":[{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useContext\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":479,"column":25,"nodeType":"Identifier","endLine":479,"endColumn":35,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useContext\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":485,"column":19,"nodeType":"Identifier","endLine":485,"endColumn":29,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport type React from \"react\"\r\nimport { createContext, useCallback, useContext, useEffect, useState, useRef } from \"react\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport { safeJsonParse } from \"@/lib/safe-json\"\r\nimport { useAuth } from \"./auth-state-manager\"\r\n\r\nexport interface CartItem {\r\n  id: string\r\n  /** Optional product variant id (for listings with variants). */\r\n  variantId?: string\r\n  /** Optional variant display name for UX (cart rendering). */\r\n  variantName?: string\r\n  title: string\r\n  price: number\r\n  image: string\r\n  quantity: number\r\n  slug?: string\r\n  /** Seller username for SEO-friendly URLs */\r\n  username?: string\r\n  /** @deprecated Use 'username' instead */\r\n  storeSlug?: string | null\r\n}\r\n\r\ninterface CartContextType {\r\n  items: CartItem[]\r\n  /** True once initial cart hydration + auth sync has completed. */\r\n  isReady: boolean\r\n  addToCart: (item: CartItem) => void\r\n  removeFromCart: (id: string, variantId?: string) => void\r\n  updateQuantity: (id: string, quantity: number, variantId?: string) => void\r\n  clearCart: () => void\r\n  totalItems: number\r\n  subtotal: number\r\n}\r\n\r\nconst CartContext = createContext<CartContextType | undefined>(undefined)\r\nconst MAX_CART_QUANTITY = 99\r\n\r\nfunction toRecord(value: unknown): Record<string, unknown> | null {\r\n  return value && typeof value === \"object\" ? (value as Record<string, unknown>) : null\r\n}\r\n\r\nfunction asString(value: unknown): string | null {\r\n  return typeof value === \"string\" ? value : null\r\n}\r\n\r\nfunction asNumber(value: unknown): number | null {\r\n  if (typeof value === \"number\") return Number.isFinite(value) ? value : null\r\n  if (typeof value === \"string\") {\r\n    const parsed = Number(value)\r\n    return Number.isFinite(parsed) ? parsed : null\r\n  }\r\n  return null\r\n}\r\n\r\nfunction asStringArray(value: unknown): string[] | null {\r\n  if (!Array.isArray(value)) return null\r\n  const out: string[] = []\r\n  for (const item of value) {\r\n    if (typeof item !== \"string\") return null\r\n    out.push(item)\r\n  }\r\n  return out\r\n}\r\n\r\nfunction normalizeQuantity(value: unknown): number | null {\r\n  const numeric = asNumber(value)\r\n  if (numeric === null) return null\r\n  const rounded = Math.floor(numeric)\r\n  if (!Number.isSafeInteger(rounded) || rounded <= 0) return null\r\n  return Math.min(rounded, MAX_CART_QUANTITY)\r\n}\r\n\r\nfunction normalizePrice(value: unknown): number | null {\r\n  const numeric = asNumber(value)\r\n  if (numeric === null || numeric < 0) return null\r\n  return numeric\r\n}\r\n\r\nfunction normalizeSellerSlugs(item: { username?: string | undefined; storeSlug?: string | null | undefined }): Pick<CartItem, \"username\" | \"storeSlug\"> {\r\n  const username = item.username ?? (item.storeSlug || undefined)\r\n  const storeSlug = item.storeSlug || item.username || undefined\r\n\r\n  return {\r\n    ...(username ? { username } : {}),\r\n    ...(storeSlug ? { storeSlug } : {}),\r\n  }\r\n}\r\n\r\nfunction sanitizeCartItems(rawItems: CartItem[]): CartItem[] {\r\n  const sanitized: CartItem[] = []\r\n  for (const item of rawItems) {\r\n    if (!item?.id) continue\r\n    const price = normalizePrice(item.price)\r\n    const quantity = normalizeQuantity(item.quantity)\r\n    if (price === null || quantity === null) continue\r\n    const sellerSlugs = normalizeSellerSlugs({\r\n      username: item.username,\r\n      storeSlug: item.storeSlug ?? null,\r\n    })\r\n    sanitized.push({\r\n      ...item,\r\n      ...sellerSlugs,\r\n      price,\r\n      quantity,\r\n    })\r\n  }\r\n  return sanitized\r\n}\r\n\r\nexport function CartProvider({ children }: { children: React.ReactNode }) {\r\n  const { user, isLoading: authLoading } = useAuth()\n  const [items, setItems] = useState<CartItem[]>([])\n  const hasSyncedRef = useRef<string | null>(null)\n  const lastUserIdRef = useRef<string | null>(null)\n  const [storageLoaded, setStorageLoaded] = useState(false)\n  const [serverSyncDone, setServerSyncDone] = useState(false)\n\r\n  const loadServerCart = useCallback(async (activeUserId: string) => {\r\n    const supabase = createClient()\r\n\r\n    // Note: cart_items is introduced via migration; keep runtime-safe casts.\r\n    const { data, error } = await supabase\r\n      .from(\"cart_items\")\r\n      .select(`\r\n        product_id,\r\n        variant_id,\r\n        quantity,\r\n        products (\r\n          title,\r\n          price,\r\n          images,\r\n          slug,\r\n          seller:profiles!products_seller_id_fkey(username)\r\n        ),\r\n        variant:product_variants!cart_items_variant_id_fkey(\r\n          id,\r\n          name\r\n        )\r\n      `)\r\n      .eq(\"user_id\", activeUserId)\r\n      .order(\"created_at\", { ascending: false })\r\n\r\n    if (error) {\r\n      console.error(\"Error fetching server cart:\", error)\r\n      return\r\n    }\r\n\r\n    const rows: unknown[] = Array.isArray(data) ? data : []\r\n    const nextItems = rows.map((row): CartItem | null => {\r\n      const record = toRecord(row)\r\n      const productId = asString(record?.product_id) ?? \"\"\r\n      const variantId = asString(record?.variant_id) ?? undefined\r\n      const quantity = normalizeQuantity(record?.quantity)\r\n\r\n      const products = toRecord(record?.products)\r\n      const title = asString(products?.title) ?? \"Unknown Product\"\r\n      const price = normalizePrice(products?.price)\r\n\r\n      const images = asStringArray(products?.images)\r\n      const image = images?.[0] ?? \"/placeholder.svg\"\r\n\r\n      const slug = asString(products?.slug)\r\n      const seller = toRecord(products?.seller)\r\n      const username = asString(seller?.username)\r\n\r\n      const variant = toRecord(record?.variant)\r\n      const variantName = asString(variant?.name) ?? undefined\r\n\r\n      if (!productId || quantity === null || price === null) {\r\n        return null\r\n      }\r\n\r\n      return {\r\n        id: productId,\r\n        ...(variantId ? { variantId } : {}),\r\n        ...(variantName ? { variantName } : {}),\r\n        title,\r\n        price,\r\n        image,\r\n        quantity,\r\n        ...(slug ? { slug } : {}),\r\n        ...(username ? { username, storeSlug: username } : {}),\r\n      }\r\n    })\r\n    .filter((item): item is CartItem => Boolean(item))\r\n\r\n    setItems(nextItems)\n  }, [])\n\r\n  const syncLocalCartToServer = useCallback(async (activeUserId: string) => {\r\n    const savedCart = localStorage.getItem(\"cart\")\r\n    const localItems = safeJsonParse<CartItem[]>(savedCart) || []\r\n    const sanitizedItems = sanitizeCartItems(localItems)\r\n\r\n    if (sanitizedItems.length === 0) {\r\n      if (localItems.length > 0) {\r\n        localStorage.removeItem(\"cart\")\r\n      }\r\n      return\r\n    }\r\n\r\n    if (sanitizedItems.length !== localItems.length) {\r\n      localStorage.setItem(\"cart\", JSON.stringify(sanitizedItems))\r\n    }\r\n\r\n    const supabase = createClient()\r\n\r\n    // Best-effort merge: add/increment each item via RPC.\r\n    // If the RPC isn't deployed yet, we keep localStorage as-is.\r\n    for (const item of sanitizedItems) {\r\n      const qty = normalizeQuantity(item.quantity)\r\n      if (!item.id || qty === null) continue\r\n\r\n      const { error } = await supabase.rpc(\"cart_add_item\", {\r\n        p_product_id: item.id,\r\n        p_quantity: qty,\r\n        ...(item.variantId ? { p_variant_id: item.variantId } : {}),\r\n      })\r\n\r\n      if (error) {\r\n        // RPC may not be deployed - silently skip sync (keep localStorage)\r\n        if (process.env.NODE_ENV === \"development\") {\r\n          console.warn(\"Cart sync skipped (RPC unavailable):\", error.message || error.code || \"unknown\")\r\n        }\r\n        return\r\n      }\r\n    }\r\n\r\n    // Only clear local cart if sync succeeded.\r\n    localStorage.removeItem(\"cart\")\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    try {\r\n      const savedCart = localStorage.getItem(\"cart\")\r\n      const parsed = safeJsonParse<CartItem[]>(savedCart)\r\n      if (parsed) {\r\n        const sanitized = sanitizeCartItems(parsed)\r\n        if (sanitized.length > 0) {\r\n          setItems(sanitized)\r\n          localStorage.setItem(\"cart\", JSON.stringify(sanitized))\r\n        } else if (savedCart) {\r\n          // Corrupt/partial data: clear it so it can't break the app or tests.\r\n          localStorage.removeItem(\"cart\")\r\n        }\r\n      } else if (savedCart) {\r\n        // Corrupt/partial data: clear it so it can't break the app or tests.\r\n        localStorage.removeItem(\"cart\")\r\n      }\r\n    } catch {\r\n      // Ignore storage access errors\r\n    } finally {\r\n      setStorageLoaded(true)\r\n    }\r\n  }, [])\r\n\r\n  // Sync with server when auth state settles\r\n  useEffect(() => {\r\n    if (!storageLoaded) return\r\n    if (authLoading) return // Wait for auth to settle\r\n\r\n    const syncCart = async () => {\n      const activeUserId = user?.id ?? null\n      const previousUserId = lastUserIdRef.current\n\n      if (!activeUserId) {\n        if (previousUserId) {\n          // Signed out: clear local + in-memory cart to avoid cross-account drift.\n          hasSyncedRef.current = null\n          setItems([])\n          try {\n            localStorage.removeItem(\"cart\")\n          } catch {\n            // Ignore storage access errors\n          }\n        }\n\n        lastUserIdRef.current = null\n        setServerSyncDone(true)\n        return\n      }\n\n      if (previousUserId && previousUserId !== activeUserId) {\n        // Switching accounts: reset sync state and local cache.\n        hasSyncedRef.current = null\n        setItems([])\n        try {\n          localStorage.removeItem(\"cart\")\n        } catch {\n          // Ignore storage access errors\n        }\n      }\n\n      lastUserIdRef.current = activeUserId\n\n      // Already synced for this user\n      if (hasSyncedRef.current === activeUserId) {\n        setServerSyncDone(true)\n        return\n      }\n      hasSyncedRef.current = activeUserId\n      setServerSyncDone(false)\n\n      try {\n        // Sync local ΓåÆ server\n        await syncLocalCartToServer(activeUserId)\n        // Load server ΓåÆ state\n        await loadServerCart(activeUserId)\n      } finally {\n        setServerSyncDone(true)\n      }\n    }\r\n\r\n    syncCart()\r\n  }, [storageLoaded, user, authLoading, loadServerCart, syncLocalCartToServer])\r\n\r\n  // Save cart to local storage whenever it changes.\r\n  // This keeps the cart resilient across route-group layout boundaries and\r\n  // provides an immediate UX even if server sync is delayed.\r\n  useEffect(() => {\r\n    if (!storageLoaded) return\r\n    try {\r\n      localStorage.setItem(\"cart\", JSON.stringify(items))\r\n    } catch {\r\n      // Ignore storage access errors\r\n    }\r\n  }, [items, storageLoaded])\r\n\r\n  const addToCart = (newItem: CartItem) => {\r\n    const normalizedPrice = normalizePrice(newItem.price)\r\n    const normalizedQuantity = normalizeQuantity(newItem.quantity ?? 1)\r\n\r\n    if (!newItem.id || normalizedPrice === null || normalizedQuantity === null) {\r\n      console.error(\"Invalid cart item:\", newItem)\r\n      return\r\n    }\r\n\r\n    const itemWithValidPrice = {\r\n      ...newItem,\r\n      ...normalizeSellerSlugs({ username: newItem.username, storeSlug: newItem.storeSlug ?? null }),\r\n      price: normalizedPrice,\r\n      quantity: normalizedQuantity,\r\n    }\r\n\r\n    setItems((prevItems) => {\r\n      const existingItem = prevItems.find((item) =>\r\n        item.id === itemWithValidPrice.id && (item.variantId ?? null) === (itemWithValidPrice.variantId ?? null)\r\n      )\r\n      if (existingItem) {\r\n        return prevItems.map((item) =>\r\n          item.id === itemWithValidPrice.id && (item.variantId ?? null) === (itemWithValidPrice.variantId ?? null)\r\n            ? { ...item, quantity: item.quantity + itemWithValidPrice.quantity }\r\n            : item,\r\n        )\r\n      }\r\n      return [...prevItems, itemWithValidPrice]\r\n    })\r\n\r\n    // Server-side cart (best-effort)\r\n    if (user?.id) {\r\n      const qty = itemWithValidPrice.quantity\r\n      void (async () => {\r\n        const supabase = createClient()\r\n        const { error } = await supabase.rpc(\"cart_add_item\", {\r\n          p_product_id: itemWithValidPrice.id,\r\n          p_quantity: qty,\r\n          ...(itemWithValidPrice.variantId ? { p_variant_id: itemWithValidPrice.variantId } : {}),\r\n        })\r\n\r\n        if (error) {\r\n          console.error(\"Error adding to server cart:\", error)\r\n        }\r\n      })()\r\n    }\r\n  }\r\n\r\n  const removeFromCart = (id: string, variantId?: string) => {\r\n    setItems((prevItems) => prevItems.filter((item) => !(item.id === id && (item.variantId ?? null) === (variantId ?? null))))\r\n\r\n    if (user?.id) {\r\n      void (async () => {\r\n        const supabase = createClient()\r\n        const { error } = await supabase.rpc(\"cart_set_quantity\", {\r\n          p_product_id: id,\r\n          p_quantity: 0,\r\n          ...(variantId ? { p_variant_id: variantId } : {}),\r\n        })\r\n\r\n        if (error) {\r\n          console.error(\"Error removing from server cart:\", error)\r\n        }\r\n      })()\r\n    }\r\n  }\r\n\r\n  const updateQuantity = (id: string, quantity: number, variantId?: string) => {\r\n    if (quantity <= 0) {\r\n      removeFromCart(id, variantId)\r\n      return\r\n    }\r\n    setItems((prevItems) => prevItems.map((item) =>\r\n      item.id === id && (item.variantId ?? null) === (variantId ?? null)\r\n        ? { ...item, quantity }\r\n        : item\r\n    ))\r\n\r\n    if (user?.id) {\r\n      void (async () => {\r\n        const supabase = createClient()\r\n        const { error } = await supabase.rpc(\"cart_set_quantity\", {\r\n          p_product_id: id,\r\n          p_quantity: quantity,\r\n          ...(variantId ? { p_variant_id: variantId } : {}),\r\n        })\r\n\r\n        if (error) {\r\n          console.error(\"Error updating server cart quantity:\", error)\r\n        }\r\n      })()\r\n    }\r\n  }\r\n\r\n  const clearCart = () => {\r\n    setItems([])\r\n\r\n    if (user?.id) {\r\n      void (async () => {\r\n        const supabase = createClient()\r\n        const { error } = await supabase.rpc(\"cart_clear\")\r\n        if (error) {\r\n          console.error(\"Error clearing server cart:\", error)\r\n        }\r\n      })()\r\n    }\r\n  }\r\n\r\n  const totalItems = items.reduce((total, item) => {\r\n    const quantity = normalizeQuantity(item.quantity) ?? 0\r\n    return total + quantity\r\n  }, 0)\r\n  const subtotal = items.reduce((total, item) => {\r\n    const price = normalizePrice(item.price) ?? 0\r\n    const quantity = normalizeQuantity(item.quantity) ?? 0\r\n    return total + price * quantity\r\n  }, 0)\r\n\r\n  const isReady = storageLoaded && !authLoading && serverSyncDone\r\n\r\n  return (\r\n    <CartContext.Provider\r\n      value={{\r\n        items,\r\n        isReady,\r\n        addToCart,\r\n        removeFromCart,\r\n        updateQuantity,\r\n        clearCart,\r\n        totalItems,\r\n        subtotal,\r\n      }}\r\n    >\r\n      {children}\r\n    </CartContext.Provider>\r\n  )\r\n}\r\n\r\nexport function useCart(): CartContextType {\r\n  // In Storybook, use the mock context if available\r\n  const storybookCartContext =\r\n    typeof window !== \"undefined\"\r\n      ? (window as unknown as { __STORYBOOK_CART_CONTEXT__?: unknown }).__STORYBOOK_CART_CONTEXT__\r\n      : undefined\r\n\r\n  if (storybookCartContext) {\r\n    // eslint-disable-next-line react-hooks/rules-of-hooks\r\n    const mockContext = useContext(\r\n      storybookCartContext as React.Context<CartContextType | undefined>\r\n    )\r\n    if (mockContext) return mockContext\r\n  }\r\n  // eslint-disable-next-line react-hooks/rules-of-hooks\r\n  const context = useContext(CartContext)\r\n  if (context === undefined) {\r\n    throw new Error(\"useCart must be used within a CartProvider\")\r\n  }\r\n  return context\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\providers\\currency-context.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\providers\\drawer-context.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useContext\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":332,"column":25,"nodeType":"Identifier","endLine":332,"endColumn":35,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useContext\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":338,"column":19,"nodeType":"Identifier","endLine":338,"endColumn":29,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\providers\\header-context.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useCallback' is defined but never used.","line":24,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":58,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useCallback"},"fix":{"range":[600,613],"text":""},"desc":"Remove unused variable \"useCallback\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\n/**\r\n * Header Context\r\n * \r\n * Allows pages to provide dynamic header props to the layout-rendered header.\r\n * This enables the \"layout owns header\" pattern while supporting dynamic content.\r\n * \r\n * Usage in pages:\r\n * ```tsx\r\n * const { setContextualHeader } = useHeader()\r\n * \r\n * useEffect(() => {\r\n *   setContextualHeader({\r\n *     title: categoryName,\r\n *     backHref: `/categories/${parentSlug}`,\r\n *     onBack: handleBack,\r\n *   })\r\n *   return () => setContextualHeader(null)\r\n * }, [categoryName, parentSlug])\r\n * ```\r\n */\r\n\r\nimport { createContext, useContext, useState, useCallback, type ReactNode } from \"react\"\r\nimport type { CategoryTreeNode } from \"@/lib/category-tree\"\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\nexport interface HomepageHeaderState {\r\n  activeCategory: string\r\n  onCategorySelect: (slug: string) => void\r\n  onSearchOpen: () => void\r\n  categories: CategoryTreeNode[]\r\n}\r\n\r\nexport interface ContextualHeaderState {\r\n  title: string\r\n  backHref: string\r\n  onBack?: () => void\r\n  /** Active category slug (for subtle active highlight during instant navigation). */\r\n  activeSlug?: string\r\n  subcategories?: CategoryTreeNode[]\r\n  onSubcategoryClick?: (cat: CategoryTreeNode) => void\r\n  hideActions?: boolean\r\n}\r\n\r\nexport interface ProductHeaderState {\r\n  productTitle: string | null\r\n  sellerName: string | null\r\n  sellerUsername: string | null\r\n  sellerAvatarUrl: string | null\r\n  productId?: string | null\r\n  productPrice?: number | null\r\n  productImage?: string | null\r\n}\r\n\r\nexport interface ProfileHeaderState {\r\n  displayName: string | null\r\n  username: string | null\r\n  avatarUrl: string | null\r\n  isOwnProfile: boolean\r\n  isFollowing: boolean\r\n  sellerId: string | null\r\n}\r\n\r\ninterface HeaderContextValue {\r\n  // Homepage header state\r\n  homepageHeader: HomepageHeaderState | null\r\n  setHomepageHeader: (state: HomepageHeaderState | null) => void\r\n  \r\n  // Contextual header state (categories)\r\n  contextualHeader: ContextualHeaderState | null\r\n  setContextualHeader: (state: ContextualHeaderState | null) => void\r\n  \r\n  // Product header state\r\n  productHeader: ProductHeaderState | null\r\n  setProductHeader: (state: ProductHeaderState | null) => void\r\n  \r\n  // Profile header state\r\n  profileHeader: ProfileHeaderState | null\r\n  setProfileHeader: (state: ProfileHeaderState | null) => void\r\n}\r\n\r\n// =============================================================================\r\n// Context\r\n// =============================================================================\r\n\r\nconst HeaderContext = createContext<HeaderContextValue | null>(null)\r\n\r\nexport function HeaderProvider({ children }: { children: ReactNode }) {\r\n  const [homepageHeader, setHomepageHeader] = useState<HomepageHeaderState | null>(null)\r\n  const [contextualHeader, setContextualHeader] = useState<ContextualHeaderState | null>(null)\r\n  const [productHeader, setProductHeader] = useState<ProductHeaderState | null>(null)\r\n  const [profileHeader, setProfileHeader] = useState<ProfileHeaderState | null>(null)\r\n\r\n  return (\r\n    <HeaderContext.Provider\r\n      value={{\r\n        homepageHeader,\r\n        setHomepageHeader,\r\n        contextualHeader,\r\n        setContextualHeader,\r\n        productHeader,\r\n        setProductHeader,\r\n        profileHeader,\r\n        setProfileHeader,\r\n      }}\r\n    >\r\n      {children}\r\n    </HeaderContext.Provider>\r\n  )\r\n}\r\n\r\nexport function useHeader() {\r\n  const context = useContext(HeaderContext)\r\n  if (!context) {\r\n    throw new Error(\"useHeader must be used within a HeaderProvider\")\r\n  }\r\n  return context\r\n}\r\n\r\n// Optional hook that doesn't throw - useful for layout where context may not be set yet\r\nexport function useHeaderOptional() {\r\n  return useContext(HeaderContext)\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\providers\\message-context.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\providers\\messages\\use-messages-actions.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_attachmentUrl' is defined but never used.","line":78,"column":29,"nodeType":"Identifier","messageId":"unusedVar","endLine":78,"endColumn":43}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useCallback } from \"react\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport type { Conversation, Message } from \"@/lib/types/messages\"\r\nimport {\r\n  sendMessageToConversation,\r\n  markConversationRead,\r\n  closeConversationInDb,\r\n  getOrCreateConversation,\r\n  fetchSenderProfile,\r\n} from \"@/lib/supabase/messages\"\r\nimport {\r\n  addMessageOptimistic,\r\n  markMessagesAsReadInState,\r\n  resetUnreadCount,\r\n  updateConversationLastMessage,\r\n} from \"./use-messages-state\"\r\n\r\ninterface UseMessagesActionsParams {\r\n  currentUserId: string | null\r\n  currentConversation: Conversation | null\r\n  // State updaters\r\n  setMessages: React.Dispatch<React.SetStateAction<Message[]>>\r\n  setConversations: React.Dispatch<React.SetStateAction<Conversation[]>>\r\n  setCurrentConversation: React.Dispatch<React.SetStateAction<Conversation | null>>\r\n  setError: (error: string | null) => void\r\n  // Callbacks\r\n  refreshUnreadCount: () => Promise<void>\r\n  loadConversations: () => Promise<void>\r\n}\r\n\r\n/**\r\n * Hook to manage message actions (send, mark read, close, start)\r\n */\r\nexport function useMessagesActions({\r\n  currentUserId,\r\n  currentConversation,\r\n  setMessages,\r\n  setConversations,\r\n  setCurrentConversation,\r\n  setError,\r\n  refreshUnreadCount,\r\n  loadConversations,\r\n}: UseMessagesActionsParams) {\r\n  const supabase = createClient()\r\n\r\n  // =============================================================================\r\n  // MARK AS READ\r\n  // =============================================================================\r\n\r\n  const markAsRead = useCallback(\r\n    async (conversationId: string) => {\r\n      if (!currentUserId) return\r\n\r\n      try {\r\n        await markConversationRead(supabase, conversationId)\r\n\r\n        // Update local state\r\n        setMessages((prev) => markMessagesAsReadInState(prev, conversationId))\r\n        setConversations((prev) =>\r\n          resetUnreadCount(prev, conversationId, currentUserId)\r\n        )\r\n\r\n        await refreshUnreadCount()\r\n      } catch (err) {\r\n        console.error(\"Error marking messages as read:\", err)\r\n      }\r\n    },\r\n    [supabase, currentUserId, refreshUnreadCount, setMessages, setConversations]\r\n  )\r\n\r\n  // =============================================================================\r\n  // SEND MESSAGE\r\n  // =============================================================================\r\n\r\n  const sendMessage = useCallback(\r\n    async (content: string, _attachmentUrl?: string) => {\r\n      if (!currentConversation || !currentUserId || !content.trim()) return\r\n\r\n      try {\r\n        const newMsgRow = await sendMessageToConversation(\r\n          supabase,\r\n          currentConversation.id,\r\n          currentUserId,\r\n          content\r\n        )\r\n\r\n        // Fetch sender profile\r\n        const senderProfile = await fetchSenderProfile(supabase, currentUserId)\r\n\r\n        // Create full message with sender\r\n        const baseMsg = {\r\n          id: newMsgRow.id,\r\n          conversation_id: newMsgRow.conversation_id,\r\n          sender_id: newMsgRow.sender_id,\r\n          content: newMsgRow.content,\r\n          message_type: newMsgRow.message_type as \"text\" | \"image\" | \"system\",\r\n          is_read: newMsgRow.is_read,\r\n          read_at: newMsgRow.read_at,\r\n          created_at: newMsgRow.created_at,\r\n        }\r\n\r\n        const fullMsg: Message = senderProfile\r\n          ? {\r\n              ...baseMsg,\r\n              sender: {\r\n                id: senderProfile.id,\r\n                full_name: senderProfile.full_name,\r\n                avatar_url: senderProfile.avatar_url,\r\n              },\r\n            }\r\n          : baseMsg\r\n\r\n        // Add to local state immediately (optimistic update)\r\n        setMessages((prev) => addMessageOptimistic(prev, fullMsg))\r\n\r\n        // Update conversation list\r\n        setConversations((prev) =>\r\n          updateConversationLastMessage(\r\n            prev,\r\n            currentConversation.id,\r\n            content.trim(),\r\n            currentUserId\r\n          )\r\n        )\r\n      } catch (err) {\r\n        console.error(\"Error sending message:\", err)\r\n        setError(\"Failed to send message\")\r\n        throw err\r\n      }\r\n    },\r\n    [\r\n      supabase,\r\n      currentConversation,\r\n      currentUserId,\r\n      setMessages,\r\n      setConversations,\r\n      setError,\r\n    ]\r\n  )\r\n\r\n  // =============================================================================\r\n  // START CONVERSATION\r\n  // =============================================================================\r\n\r\n  const startConversation = useCallback(\r\n    async (sellerId: string, productId?: string, subject?: string): Promise<string> => {\r\n      try {\r\n        const conversationId = await getOrCreateConversation(\r\n          supabase,\r\n          sellerId,\r\n          productId,\r\n          subject\r\n        )\r\n\r\n        // Reload conversations to include the new one\r\n        await loadConversations()\r\n\r\n        return conversationId\r\n      } catch (err) {\r\n        console.error(\"Error starting conversation:\", err)\r\n        setError(\"Failed to start conversation\")\r\n        throw err\r\n      }\r\n    },\r\n    [supabase, loadConversations, setError]\r\n  )\r\n\r\n  // =============================================================================\r\n  // CLOSE CONVERSATION\r\n  // =============================================================================\r\n\r\n  const closeConversation = useCallback(\r\n    async (conversationId: string) => {\r\n      try {\r\n        await closeConversationInDb(supabase, conversationId)\r\n\r\n        // Update local state\r\n        setConversations((prev) =>\r\n          prev.map((conv) =>\r\n            conv.id === conversationId\r\n              ? { ...conv, status: \"closed\" as const }\r\n              : conv\r\n          )\r\n        )\r\n\r\n        if (currentConversation?.id === conversationId) {\r\n          setCurrentConversation((prev) =>\r\n            prev ? { ...prev, status: \"closed\" as const } : null\r\n          )\r\n        }\r\n      } catch (err) {\r\n        console.error(\"Error closing conversation:\", err)\r\n        setError(\"Failed to close conversation\")\r\n      }\r\n    },\r\n    [\r\n      supabase,\r\n      currentConversation,\r\n      setConversations,\r\n      setCurrentConversation,\r\n      setError,\r\n    ]\r\n  )\r\n\r\n  return {\r\n    markAsRead,\r\n    sendMessage,\r\n    startConversation,\r\n    closeConversation,\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\providers\\messages\\use-messages-realtime.ts","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The ref value 'typingTimeoutRef.current' will likely have changed by the time this effect cleanup function runs. If this ref points to a node rendered by React, copy 'typingTimeoutRef.current' to a variable inside the effect, and use that variable in the cleanup function.","line":191,"column":39,"nodeType":"Identifier","endLine":191,"endColumn":46}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useRef, useCallback } from \"react\"\r\nimport type { RealtimeChannel } from \"@supabase/supabase-js\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport type { Conversation, Message, MessageType } from \"@/lib/types/messages\"\r\nimport { fetchSenderProfile } from \"@/lib/supabase/messages\"\r\nimport { addMessageOptimistic, incrementUnreadCount } from \"./use-messages-state\"\r\n\r\ninterface RealtimeMessagePayload {\r\n  id: string\r\n  conversation_id: string\r\n  sender_id: string\r\n  content: string\r\n  message_type: string\r\n  is_read: boolean\r\n  created_at: string\r\n}\r\n\r\ninterface UseMessagesRealtimeParams {\r\n  currentUserId: string | null\r\n  conversations: Conversation[]\r\n  currentConversationId: string | null\r\n  // State updaters\r\n  setMessages: React.Dispatch<React.SetStateAction<Message[]>>\r\n  setConversations: React.Dispatch<React.SetStateAction<Conversation[]>>\r\n  setTotalUnreadCount: React.Dispatch<React.SetStateAction<number>>\r\n  // Callbacks\r\n  loadConversations: () => Promise<void>\r\n  markAsRead: (conversationId: string) => Promise<void>\r\n}\r\n\r\n/**\r\n * Hook to manage realtime subscriptions for messages\r\n */\r\nexport function useMessagesRealtime({\r\n  currentUserId,\r\n  conversations,\r\n  currentConversationId,\r\n  setMessages,\r\n  setConversations,\r\n  setTotalUnreadCount,\r\n  loadConversations,\r\n  markAsRead,\r\n}: UseMessagesRealtimeParams) {\r\n  const supabase = createClient()\r\n\r\n  // Refs to avoid stale closures\r\n  const channelRef = useRef<RealtimeChannel | null>(null)\r\n  const currentConversationIdRef = useRef<string | null>(null)\r\n  const conversationIdsRef = useRef<string[]>([])\r\n\r\n  // Keep refs in sync\r\n  useEffect(() => {\r\n    currentConversationIdRef.current = currentConversationId\r\n  }, [currentConversationId])\r\n\r\n  useEffect(() => {\r\n    conversationIdsRef.current = conversations.map((c) => c.id)\r\n  }, [conversations])\r\n\r\n  // =============================================================================\r\n  // REALTIME SUBSCRIPTION - Single channel, stable dependencies\r\n  // =============================================================================\r\n\r\n  useEffect(() => {\r\n    if (!currentUserId) return\r\n\r\n    // Clean up existing channel\r\n    if (channelRef.current) {\r\n      supabase.removeChannel(channelRef.current)\r\n      channelRef.current = null\r\n    }\r\n\r\n    // Create a single channel for all messages\r\n    const channel = supabase\r\n      .channel(`chat-${currentUserId}`)\r\n      .on(\r\n        \"postgres_changes\",\r\n        {\r\n          event: \"INSERT\",\r\n          schema: \"public\",\r\n          table: \"messages\",\r\n        },\r\n        async (payload) => {\r\n          const newMessage = payload.new as RealtimeMessagePayload\r\n\r\n          // Skip our own messages (already added optimistically)\r\n          if (newMessage.sender_id === currentUserId) return\r\n\r\n          // Check if this belongs to one of our conversations using ref\r\n          const isOurConversation = conversationIdsRef.current.includes(\r\n            newMessage.conversation_id\r\n          )\r\n\r\n          if (!isOurConversation) {\r\n            // New conversation - reload all\r\n            await loadConversations()\r\n            return\r\n          }\r\n\r\n          // If viewing this conversation, add the message\r\n          if (currentConversationIdRef.current === newMessage.conversation_id) {\r\n            // Fetch sender profile\r\n            const senderProfile = await fetchSenderProfile(\r\n              supabase,\r\n              newMessage.sender_id\r\n            )\r\n\r\n            const baseMsg = {\r\n              id: newMessage.id,\r\n              conversation_id: newMessage.conversation_id,\r\n              sender_id: newMessage.sender_id,\r\n              content: newMessage.content,\r\n              message_type: newMessage.message_type as MessageType,\r\n              is_read: newMessage.is_read,\r\n              read_at: null,\r\n              created_at: newMessage.created_at,\r\n            }\r\n\r\n            const fullMsg: Message = senderProfile\r\n              ? {\r\n                  ...baseMsg,\r\n                  sender: {\r\n                    id: senderProfile.id,\r\n                    full_name: senderProfile.full_name,\r\n                    avatar_url: senderProfile.avatar_url,\r\n                  },\r\n                }\r\n              : baseMsg\r\n\r\n            setMessages((prev) => addMessageOptimistic(prev, fullMsg))\r\n\r\n            // Mark as read since we're viewing\r\n            await markAsRead(newMessage.conversation_id)\r\n          } else {\r\n            // Not viewing - increment unread count\r\n            setConversations((prev) =>\r\n              incrementUnreadCount(prev, newMessage.conversation_id, currentUserId, {\r\n                content: newMessage.content,\r\n                sender_id: newMessage.sender_id,\r\n                message_type: newMessage.message_type,\r\n                created_at: newMessage.created_at,\r\n              })\r\n            )\r\n\r\n            setTotalUnreadCount((prev) => prev + 1)\r\n          }\r\n        }\r\n      )\r\n      .subscribe()\r\n\r\n    channelRef.current = channel\r\n\r\n    return () => {\r\n      if (channelRef.current) {\r\n        supabase.removeChannel(channelRef.current)\r\n        channelRef.current = null\r\n      }\r\n    }\r\n  }, [\r\n    supabase,\r\n    currentUserId,\r\n    loadConversations,\r\n    markAsRead,\r\n    setMessages,\r\n    setConversations,\r\n    setTotalUnreadCount,\r\n  ])\r\n}\r\n\r\n/**\r\n * Hook to manage typing indicator state\r\n */\r\nexport function useTypingIndicator() {\r\n  const lastTypingSentRef = useRef<number>(0)\r\n  const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null)\r\n\r\n  const sendTypingIndicator = useCallback(() => {\r\n    // Throttle typing events\r\n    const now = Date.now()\r\n    if (now - lastTypingSentRef.current < 2000) return\r\n    lastTypingSentRef.current = now\r\n    // Typing indicator via broadcast could be added here if needed\r\n  }, [])\r\n\r\n  // Cleanup typing timeout on unmount\r\n  useEffect(() => {\r\n    return () => {\r\n      if (typingTimeoutRef.current) {\r\n        clearTimeout(typingTimeoutRef.current)\r\n      }\r\n    }\r\n  }, [])\r\n\r\n  return { sendTypingIndicator }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\providers\\messages\\use-messages-state.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'fetchSenderProfile' is defined but never used.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"fetchSenderProfile"},"fix":{"range":[265,288],"text":""},"desc":"Remove unused variable \"fetchSenderProfile\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useCallback, useEffect } from \"react\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport type { Conversation, Message } from \"@/lib/types/messages\"\r\nimport {\r\n  fetchConversations,\r\n  fetchConversation,\r\n  fetchMessages,\r\n  fetchSenderProfile,\r\n  fetchTotalUnreadCount,\r\n} from \"@/lib/supabase/messages\"\r\n\r\nexport interface MessagesState {\r\n  currentUserId: string | null\r\n  conversations: Conversation[]\r\n  currentConversation: Conversation | null\r\n  messages: Message[]\r\n  totalUnreadCount: number\r\n  isLoading: boolean\r\n  isLoadingMessages: boolean\r\n  error: string | null\r\n  isOtherUserTyping: boolean\r\n}\r\n\r\nexport interface MessagesStateActions {\r\n  setCurrentUserId: (id: string | null) => void\r\n  setConversations: React.Dispatch<React.SetStateAction<Conversation[]>>\r\n  setCurrentConversation: React.Dispatch<React.SetStateAction<Conversation | null>>\r\n  setMessages: React.Dispatch<React.SetStateAction<Message[]>>\r\n  setTotalUnreadCount: React.Dispatch<React.SetStateAction<number>>\r\n  setIsLoading: (loading: boolean) => void\r\n  setIsLoadingMessages: (loading: boolean) => void\r\n  setError: (error: string | null) => void\r\n  setIsOtherUserTyping: (typing: boolean) => void\r\n}\r\n\r\nexport interface UseMessagesStateReturn extends MessagesState, MessagesStateActions {\r\n  // Data fetching\r\n  loadConversations: () => Promise<void>\r\n  selectConversation: (conversationId: string) => Promise<void>\r\n  refreshUnreadCount: () => Promise<void>\r\n}\r\n\r\n/**\r\n * Hook to manage messages state - state management + data fetching\r\n */\r\nexport function useMessagesState(): UseMessagesStateReturn {\r\n  const supabase = createClient()\r\n\r\n  // Core state\r\n  const [currentUserId, setCurrentUserId] = useState<string | null>(null)\r\n  const [conversations, setConversations] = useState<Conversation[]>([])\r\n  const [currentConversation, setCurrentConversation] = useState<Conversation | null>(null)\r\n  const [messages, setMessages] = useState<Message[]>([])\r\n  const [totalUnreadCount, setTotalUnreadCount] = useState(0)\r\n  // Start as true - we're always loading initially until we check auth\r\n  const [isLoading, setIsLoading] = useState(true)\r\n  const [isLoadingMessages, setIsLoadingMessages] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n  const [isOtherUserTyping, setIsOtherUserTyping] = useState(false)\r\n\r\n  // =============================================================================\r\n  // FETCH USER ID ON MOUNT\r\n  // =============================================================================\r\n\r\n  useEffect(() => {\r\n    const getUser = async () => {\r\n      const {\r\n        data: { user },\r\n      } = await supabase.auth.getUser()\r\n      if (user) {\r\n        setCurrentUserId(user.id)\r\n      } else {\r\n        // No user - stop loading as there won't be any conversations\r\n        setIsLoading(false)\r\n      }\r\n    }\r\n    getUser()\r\n  }, [supabase])\r\n\r\n  // =============================================================================\r\n  // REFRESH UNREAD COUNT\r\n  // =============================================================================\r\n\r\n  const refreshUnreadCount = useCallback(async () => {\r\n    if (!currentUserId) return\r\n\r\n    try {\r\n      const count = await fetchTotalUnreadCount(supabase)\r\n      setTotalUnreadCount(count)\r\n    } catch (err) {\r\n      console.error(\"Error fetching unread count:\", err)\r\n    }\r\n  }, [supabase, currentUserId])\r\n\r\n  // =============================================================================\r\n  // LOAD CONVERSATIONS\r\n  // =============================================================================\r\n\r\n  const loadConversations = useCallback(async () => {\r\n    if (!currentUserId) return\r\n\r\n    setIsLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const result = await fetchConversations(supabase, currentUserId)\r\n      setConversations(result.conversations)\r\n      setTotalUnreadCount(result.unreadCount)\r\n    } catch (err) {\r\n      console.error(\"Error loading conversations:\", err)\r\n      setError(\"Failed to load conversations\")\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }, [supabase, currentUserId])\r\n\r\n  // =============================================================================\r\n  // SELECT CONVERSATION & LOAD MESSAGES\r\n  // =============================================================================\r\n\r\n  const selectConversation = useCallback(\r\n    async (conversationId: string) => {\r\n      setIsLoadingMessages(true)\r\n      setError(null)\r\n\r\n      try {\r\n        // Find in existing conversations or fetch fresh\r\n        let conv = conversations.find((c) => c.id === conversationId)\r\n\r\n        if (!conv) {\r\n          conv = await fetchConversation(supabase, conversationId)\r\n        }\r\n\r\n        setCurrentConversation(conv)\r\n\r\n        // Load messages\r\n        const msgs = await fetchMessages(supabase, conversationId)\r\n        setMessages(msgs)\r\n      } catch (err) {\r\n        console.error(\"Error loading messages:\", err)\r\n        setError(\"Failed to load messages\")\r\n      } finally {\r\n        setIsLoadingMessages(false)\r\n      }\r\n    },\r\n    [supabase, conversations]\r\n  )\r\n\r\n  // =============================================================================\r\n  // LOAD CONVERSATIONS ON MOUNT / USER CHANGE\r\n  // =============================================================================\r\n\r\n  useEffect(() => {\r\n    if (currentUserId) {\r\n      loadConversations()\r\n    }\r\n  }, [currentUserId, loadConversations])\r\n\r\n  return {\r\n    // State\r\n    currentUserId,\r\n    conversations,\r\n    currentConversation,\r\n    messages,\r\n    totalUnreadCount,\r\n    isLoading,\r\n    isLoadingMessages,\r\n    error,\r\n    isOtherUserTyping,\r\n    // Setters\r\n    setCurrentUserId,\r\n    setConversations,\r\n    setCurrentConversation,\r\n    setMessages,\r\n    setTotalUnreadCount,\r\n    setIsLoading,\r\n    setIsLoadingMessages,\r\n    setError,\r\n    setIsOtherUserTyping,\r\n    // Data fetching\r\n    loadConversations,\r\n    selectConversation,\r\n    refreshUnreadCount,\r\n  }\r\n}\r\n\r\n/**\r\n * Helper to add a message to the local state (optimistic update)\r\n */\r\nexport function addMessageOptimistic(prev: Message[], newMsg: Message): Message[] {\r\n  if (prev.some((m) => m.id === newMsg.id)) return prev\r\n  return [...prev, newMsg]\r\n}\r\n\r\n/**\r\n * Helper to update messages as read\r\n */\r\nexport function markMessagesAsReadInState(\r\n  prev: Message[],\r\n  conversationId: string\r\n): Message[] {\r\n  return prev.map((msg) =>\r\n    msg.conversation_id === conversationId && !msg.is_read\r\n      ? { ...msg, is_read: true, read_at: new Date().toISOString() }\r\n      : msg\r\n  )\r\n}\r\n\r\n/**\r\n * Helper to update conversation unread counts\r\n */\r\nexport function resetUnreadCount(\r\n  prev: Conversation[],\r\n  conversationId: string,\r\n  currentUserId: string\r\n): Conversation[] {\r\n  return prev.map((conv) => {\r\n    if (conv.id !== conversationId) return conv\r\n    if (conv.buyer_id === currentUserId) {\r\n      return { ...conv, buyer_unread_count: 0 }\r\n    }\r\n    return { ...conv, seller_unread_count: 0 }\r\n  })\r\n}\r\n\r\n/**\r\n * Helper to update conversation with new last message\r\n */\r\nexport function updateConversationLastMessage(\r\n  prev: Conversation[],\r\n  conversationId: string,\r\n  content: string,\r\n  senderId: string\r\n): Conversation[] {\r\n  return prev\r\n    .map((conv) =>\r\n      conv.id === conversationId\r\n        ? {\r\n            ...conv,\r\n            last_message_at: new Date().toISOString(),\r\n            last_message: {\r\n              content,\r\n              sender_id: senderId,\r\n              message_type: \"text\",\r\n              created_at: new Date().toISOString(),\r\n            },\r\n          }\r\n        : conv\r\n    )\r\n    .sort(\r\n      (a, b) =>\r\n        new Date(b.last_message_at || b.created_at).getTime() -\r\n        new Date(a.last_message_at || a.created_at).getTime()\r\n    )\r\n}\r\n\r\n/**\r\n * Helper to increment unread count for a conversation\r\n */\r\nexport function incrementUnreadCount(\r\n  prev: Conversation[],\r\n  conversationId: string,\r\n  currentUserId: string,\r\n  newMessage: {\r\n    content: string\r\n    sender_id: string\r\n    message_type: string\r\n    created_at: string\r\n  }\r\n): Conversation[] {\r\n  return prev\r\n    .map((conv) => {\r\n      if (conv.id !== conversationId) return conv\r\n      const isBuyer = conv.buyer_id === currentUserId\r\n      return {\r\n        ...conv,\r\n        last_message_at: newMessage.created_at,\r\n        last_message: newMessage,\r\n        ...(isBuyer\r\n          ? { buyer_unread_count: (conv.buyer_unread_count || 0) + 1 }\r\n          : { seller_unread_count: (conv.seller_unread_count || 0) + 1 }),\r\n      }\r\n    })\r\n    .sort(\r\n      (a, b) =>\r\n        new Date(b.last_message_at || b.created_at).getTime() -\r\n        new Date(a.last_message_at || a.created_at).getTime()\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\providers\\sonner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\providers\\theme-provider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\providers\\wishlist-context.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useContext\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":326,"column":25,"nodeType":"Identifier","endLine":326,"endColumn":35,"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/rules-of-hooks","severity":2,"message":"React Hook \"useContext\" is called conditionally. React Hooks must be called in the exact same order in every component render.","line":332,"column":19,"nodeType":"Identifier","endLine":332,"endColumn":29,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\auth\\auth-gate-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\auth\\guest-sell-cta.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\category\\category-circle-visual.tsx","messages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":90,"column":11,"nodeType":"JSXOpeningElement","endLine":96,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\nimport { getCategoryIcon, getCategoryColor, type IconSize } from \"@/components/shared/category/category-icons\"\r\nimport { PLACEHOLDER_IMAGE_PATH } from \"@/lib/normalize-image-url\"\r\n\r\ntype CategoryLike = {\r\n  slug: string\r\n  image_url?: string | null\r\n  icon?: string | null\r\n}\r\n\r\nfunction hasMeaningfulImageUrl(url: string | null | undefined): url is string {\r\n  if (!url) return false\r\n  if (url === PLACEHOLDER_IMAGE_PATH) return false\r\n  // Some parts of the app still use placeholder.svg; treat as missing.\r\n  if (/\\/placeholder\\.(svg|png|jpg|jpeg)$/i.test(url)) return false\r\n  if (/placeholder/i.test(url)) return false\r\n  return true\r\n}\r\n\r\nfunction hasMeaningfulIcon(icon: string | null | undefined): icon is string {\r\n  return !!icon && icon.trim().length > 0\r\n}\r\n\r\nexport interface CategoryCircleVisualProps {\r\n  category: CategoryLike\r\n  active?: boolean\r\n  /** Tailwind size class is expected from caller (e.g. `size-12`, `size-14`). */\r\n  className?: string\r\n  /** Icon size when falling back to Phosphor mapping. */\r\n  fallbackIconSize?: IconSize\r\n  /** Phosphor icon weight when falling back. */\r\n  fallbackIconWeight?: \"thin\" | \"light\" | \"regular\" | \"bold\" | \"fill\" | \"duotone\"\r\n  /** Visual style per surface. */\r\n  variant?: \"muted\" | \"menu\" | \"rail\" | \"colorful\"\r\n  /** \r\n   * When true, always show Phosphor icon instead of image_url.\r\n   * Use this to prefer icons over photos for cleaner visual hierarchy.\r\n   */\r\n  preferIcon?: boolean\r\n}\r\n\r\nexport function CategoryCircleVisual({\n  category,\n  active = false,\n  className,\n  fallbackIconSize = 24,\n  fallbackIconWeight = \"bold\", // Bold for better visibility\n  variant = \"rail\",\n  preferIcon = true, // Default to Phosphor icons (set to false to show images/emojis)\n}: CategoryCircleVisualProps) {\n  // When preferIcon is true, skip image_url AND icon (emoji) checks - go straight to Phosphor\r\n  const imageUrl = !preferIcon && hasMeaningfulImageUrl(category.image_url) ? category.image_url : null\r\n  const icon = !preferIcon && hasMeaningfulIcon(category.icon) ? category.icon : null\r\n  \r\n  // Get category-specific colors\n  const colors = getCategoryColor(category.slug)\n  \n  const isColorful = variant === \"colorful\"\n  const surfaceClass = (() => {\n    if (variant === \"colorful\") return colors.bg\n    if (active) return \"bg-selected\"\n    return \"bg-surface-subtle group-hover:bg-hover\"\n  })()\n  const iconColorClass = isColorful ? colors.text : \"text-foreground\"\n  const ringClass = active\n    ? cn(\"ring-2 ring-offset-1 ring-offset-background\", isColorful ? colors.ring : \"ring-selected-border\")\n    : cn(\n        \"ring-1 ring-border-subtle\",\n        isColorful ? colors.hoverRing : \"group-hover:ring-hover-border\"\n      )\n\n  // Filled circles for app-like browsing. No visible outlines.\n  const depthClass = active ? \"shadow-sm\" : \"shadow-2xs\"\n\n  return (\n    <div\n      className={cn(\n        \"rounded-full flex items-center justify-center overflow-hidden\",\n        surfaceClass,\n        \"transition-shadow duration-150\",\n        ringClass,\n        depthClass,\n        className\n      )}\n    >\r\n      {\r\n        imageUrl ? (\r\n          <img\r\n            src={imageUrl}\r\n            alt=\"\"\r\n            loading=\"lazy\"\r\n            decoding=\"async\"\r\n            className=\"h-full w-full object-cover\"\r\n          />\r\n        ) : icon ? (\r\n          <span className={cn(\"text-lg leading-none\", iconColorClass)} aria-hidden=\"true\">\r\n            {icon}\r\n          </span>\r\n        ) : (\r\n          <span aria-hidden=\"true\">\r\n            {getCategoryIcon(category.slug, {\r\n              size: fallbackIconSize,\r\n              weight: fallbackIconWeight,\r\n              className: iconColorClass,\r\n            })}\r\n          </span>\r\n        )\r\n      }\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\category\\category-circle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\category\\category-icons.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ShoppingBag' is defined but never used.","line":13,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"ShoppingBag"},"fix":{"range":[233,249],"text":""},"desc":"Remove unused variable \"ShoppingBag\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Storefront' is defined but never used.","line":51,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Storefront"},"fix":{"range":[707,722],"text":""},"desc":"Remove unused variable \"Storefront\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Tag' is defined but never used.","line":52,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":52,"endColumn":6,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Tag"},"fix":{"range":[722,730],"text":""},"desc":"Remove unused variable \"Tag\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Plant' is defined but never used.","line":57,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":57,"endColumn":8,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Plant"},"fix":{"range":[780,790],"text":""},"desc":"Remove unused variable \"Plant\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Cpu' is defined but never used.","line":58,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":58,"endColumn":6,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Cpu"},"fix":{"range":[790,798],"text":""},"desc":"Remove unused variable \"Cpu\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'User' is defined but never used.","line":59,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":59,"endColumn":7,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"User"},"fix":{"range":[798,807],"text":""},"desc":"Remove unused variable \"User\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UserCircle' is defined but never used.","line":60,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":60,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"UserCircle"},"fix":{"range":[807,822],"text":""},"desc":"Remove unused variable \"UserCircle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'GenderIntersex' is defined but never used.","line":64,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":64,"endColumn":17,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"GenderIntersex"},"fix":{"range":[864,883],"text":""},"desc":"Remove unused variable \"GenderIntersex\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Armchair' is defined but never used.","line":71,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":71,"endColumn":11,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Armchair"},"fix":{"range":[947,960],"text":""},"desc":"Remove unused variable \"Armchair\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Bed' is defined but never used.","line":72,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":72,"endColumn":6,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Bed"},"fix":{"range":[960,968],"text":""},"desc":"Remove unused variable \"Bed\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Bathtub' is defined but never used.","line":73,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":73,"endColumn":10,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Bathtub"},"fix":{"range":[968,980],"text":""},"desc":"Remove unused variable \"Bathtub\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CookingPot' is defined but never used.","line":74,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":74,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CookingPot"},"fix":{"range":[980,995],"text":""},"desc":"Remove unused variable \"CookingPot\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Knife' is defined but never used.","line":75,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":75,"endColumn":8,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Knife"},"fix":{"range":[995,1005],"text":""},"desc":"Remove unused variable \"Knife\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Lamp' is defined but never used.","line":76,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":76,"endColumn":7,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Lamp"},"fix":{"range":[1005,1014],"text":""},"desc":"Remove unused variable \"Lamp\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Bicycle' is defined but never used.","line":78,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":78,"endColumn":10,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Bicycle"},"fix":{"range":[1029,1041],"text":""},"desc":"Remove unused variable \"Bicycle\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Basketball' is defined but never used.","line":79,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":79,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Basketball"},"fix":{"range":[1041,1056],"text":""},"desc":"Remove unused variable \"Basketball\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Football' is defined but never used.","line":80,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":80,"endColumn":11,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Football"},"fix":{"range":[1056,1069],"text":""},"desc":"Remove unused variable \"Football\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SoccerBall' is defined but never used.","line":81,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":81,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SoccerBall"},"fix":{"range":[1069,1084],"text":""},"desc":"Remove unused variable \"SoccerBall\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TennisBall' is defined but never used.","line":82,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":82,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"TennisBall"},"fix":{"range":[1084,1099],"text":""},"desc":"Remove unused variable \"TennisBall\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Wine' is defined but never used.","line":83,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":83,"endColumn":7,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Wine"},"fix":{"range":[1099,1108],"text":""},"desc":"Remove unused variable \"Wine\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CoffeeBean' is defined but never used.","line":84,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":84,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CoffeeBean"},"fix":{"range":[1108,1123],"text":""},"desc":"Remove unused variable \"CoffeeBean\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Carrot' is defined but never used.","line":85,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":85,"endColumn":9,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Carrot"},"fix":{"range":[1123,1134],"text":""},"desc":"Remove unused variable \"Carrot\"."}]},{"ruleId":"sonarjs/no-collapsible-if","severity":1,"message":"Merge this if statement with the nested one.","line":232,"column":5,"nodeType":null,"messageId":"mergeNestedIfStatement","endLine":232,"endColumn":7},{"ruleId":"unicorn/no-lonely-if","severity":1,"message":"Unexpected `if` as the only statement in a `if` block without `else`.","line":233,"column":7,"nodeType":"IfStatement","messageId":"no-lonely-if","endLine":233,"endColumn":70,"fix":{"range":[4670,4798],"text":"((slugKey.includes(key) || key.includes(slugKey)) && (!best || key.length > best.key.length)) best = { key, icon }"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":24,"fixableErrorCount":0,"fixableWarningCount":1,"source":"/**\r\n * Category Icons\r\n *\r\n * Shared icon mappings for category navigation components.\r\n * Extracted to avoid duplication across multiple category UIs.\r\n */\r\n\r\nimport * as React from \"react\"\r\nimport {\r\n  Monitor,\r\n  Laptop,\r\n  House,\r\n  ShoppingBag,\r\n  GameController,\r\n  TShirt,\r\n  Baby,\r\n  Heart,\r\n  Wrench,\r\n  Car,\r\n  Gift,\r\n  BookOpen,\r\n  Barbell,\r\n  Dog,\r\n  Lightbulb,\r\n  DeviceMobile,\r\n  DeviceTablet,\r\n  Watch,\r\n  Headphones,\r\n  Camera,\r\n  Television,\r\n  MusicNotes,\r\n  Briefcase,\r\n  ForkKnife,\r\n  Leaf,\r\n  Code,\r\n  ShoppingCart,\r\n  Diamond,\r\n  Palette,\r\n  Pill,\r\n  GraduationCap,\r\n  Guitar,\r\n  FilmStrip,\r\n  Flask,\r\n  Trophy,\r\n  Hammer,\r\n  Flower,\r\n  PaintBrush,\r\n  Package,\r\n  Buildings,\r\n  Ticket,\r\n  Storefront,\r\n  Tag,\r\n  Truck,\r\n  Flag,\r\n  DesktopTower,\r\n  Lightning,\r\n  Plant,\r\n  Cpu,\r\n  User,\r\n  UserCircle,\r\n  Users,\r\n  GenderMale,\r\n  GenderFemale,\r\n  GenderIntersex,\r\n  Sneaker,\r\n  Dress,\r\n  Hoodie,\r\n  Pants,\r\n  Boot,\r\n  Handbag,\r\n  Armchair,\r\n  Bed,\r\n  Bathtub,\r\n  CookingPot,\r\n  Knife,\r\n  Lamp,\r\n  CoatHanger,\r\n  Bicycle,\r\n  Basketball,\r\n  Football,\r\n  SoccerBall,\r\n  TennisBall,\r\n  Wine,\r\n  CoffeeBean,\r\n  Carrot,\r\n  SquaresFour,\r\n} from \"@phosphor-icons/react/ssr\"\r\n\r\ntype PhosphorIcon = typeof Monitor\r\n\r\n// Component-level icon mapping used by card/circle UIs.\r\n// Returns the icon component so callers can control size/weight/className.\r\nconst categoryIconComponents: Record<string, PhosphorIcon> = {\r\n  // Navigation / Meta\r\n  all: SquaresFour,\r\n  categories: SquaresFour,\r\n\r\n  // Electronics & Computers\r\n  electronics: Monitor,\r\n  computers: Laptop,\r\n  laptop: Laptop,\r\n  laptops: Laptop,\r\n  notebook: Laptop,\r\n  notebooks: Laptop,\r\n  tablet: DeviceTablet,\r\n  tablets: DeviceTablet,\r\n  monitor: Monitor,\r\n  monitors: Monitor,\r\n  desktop: DesktopTower,\r\n  desktops: DesktopTower,\r\n  \"desktop-computer\": DesktopTower,\r\n  \"desktop-computers\": DesktopTower,\r\n  \"desktop-pc\": DesktopTower,\r\n  \"desktop-pcs\": DesktopTower,\r\n  pc: DesktopTower,\r\n  pcs: DesktopTower,\r\n  \"smart-home\": Lightbulb,\r\n  phones: DeviceMobile,\r\n  smartphone: DeviceMobile,\r\n  smartphones: DeviceMobile,\r\n  tv: Television,\r\n  audio: Headphones,\r\n  cameras: Camera,\r\n  software: Code,\r\n  \"software-services\": Code,\r\n\r\n  // Fashion & Accessories\r\n  fashion: TShirt,\r\n  \"jewelry-watches\": Diamond,\r\n  watches: Watch,\r\n  // Fashion subcategories (gender) - match actual DB slugs\r\n  \"fashion-mens\": GenderMale,\r\n  \"fashion-womens\": GenderFemale,\r\n  \"fashion-kids\": Baby,\r\n  \"fashion-unisex\": Users,\r\n  // Alternative slug patterns\r\n  men: GenderMale,\r\n  mens: GenderMale,\r\n  \"men-fashion\": GenderMale,\r\n  \"mens-fashion\": GenderMale,\r\n  women: GenderFemale,\r\n  womens: GenderFemale,\r\n  \"women-fashion\": GenderFemale,\r\n  \"womens-fashion\": GenderFemale,\r\n  kids: Baby,\r\n  children: Baby,\r\n  \"kids-fashion\": Baby,\r\n  \"childrens-fashion\": Baby,\r\n  unisex: Users,\r\n  \"unisex-fashion\": Users,\r\n  // Fashion items\r\n  shoes: Sneaker,\r\n  sneakers: Sneaker,\r\n  boots: Boot,\r\n  dresses: Dress,\r\n  shirts: TShirt,\r\n  pants: Pants,\r\n  coats: Hoodie,\r\n  jackets: Hoodie,\r\n  bags: Handbag,\r\n  handbags: Handbag,\r\n  accessories: CoatHanger,\r\n\r\n  // Home & Living\r\n  home: House,\r\n  \"home-kitchen\": ForkKnife,\r\n  garden: Leaf,\r\n  \"garden-outdoor\": Flower,\r\n  tools: Wrench,\r\n  \"tools-home\": Hammer,\r\n  lighting: Lightbulb,\r\n  \"real-estate\": Buildings,\r\n\r\n  // Sports & Gaming\r\n  gaming: GameController,\r\n  sports: Barbell,\r\n  \"sports-outdoors\": Barbell,\r\n\r\n  // Health & Beauty\r\n  beauty: PaintBrush,\r\n  health: Heart,\r\n  \"health-wellness\": Pill,\r\n  \"cbd-wellness\": Leaf,\r\n\r\n  // Family & Pets\r\n  baby: Baby,\r\n  \"baby-kids\": Baby,\r\n  pets: Dog,\r\n  \"pet-supplies\": Dog,\r\n  toys: Gift,\r\n\r\n  // Media & Entertainment\r\n  books: BookOpen,\r\n  music: MusicNotes,\r\n  \"musical-instruments\": Guitar,\r\n  \"movies-music\": FilmStrip,\r\n\r\n  // Business & Office\r\n  office: Briefcase,\r\n  \"office-school\": GraduationCap,\r\n  \"industrial-scientific\": Flask,\r\n  services: Briefcase,\r\n\r\n  // Shopping & Deals\r\n  grocery: ShoppingCart,\r\n  handmade: Palette,\r\n  collectibles: Trophy,\r\n  \"gift-cards\": Gift,\r\n  tickets: Ticket,\r\n\r\n  // Automotive & Transport\r\n  automotive: Car,\r\n  \"e-mobility\": Lightning,\r\n  wholesale: Truck,\r\n\r\n  // Regional & Special\r\n  \"bulgarian-traditional\": Flag,\r\n  hobbies: Guitar,\r\n\r\n  // Default fallback\r\n  default: Package,\r\n}\r\n\r\nfunction getCategoryIconForSlug(slug: string): PhosphorIcon {\r\n  const slugKey = slug.toLowerCase()\r\n  const direct = categoryIconComponents[slugKey]\r\n  if (direct) return direct\r\n\r\n  let best: { key: string; icon: PhosphorIcon } | null = null\r\n  for (const [key, icon] of Object.entries(categoryIconComponents)) {\r\n    if (key === \"default\") continue\r\n    if (slugKey.includes(key) || key.includes(slugKey)) {\r\n      if (!best || key.length > best.key.length) best = { key, icon }\r\n    }\r\n  }\r\n\r\n  return best?.icon ?? categoryIconComponents.default ?? Package\r\n}\r\n\r\nexport type IconSize = 14 | 16 | 18 | 20 | 24 | 26 | 28 | 32 | 36 | 40\r\n\r\ninterface CategoryIconOptions {\r\n  size?: IconSize\r\n  className?: string\r\n  weight?: \"thin\" | \"light\" | \"regular\" | \"bold\" | \"fill\" | \"duotone\"\r\n}\r\n\r\n/**\r\n * Get the appropriate icon for a category slug\r\n */\r\nexport function getCategoryIcon(slug: string, options: CategoryIconOptions = {}): React.ReactNode {\r\n  const { size = 20, className = \"\", weight = \"bold\" } = options\r\n\r\n  const Icon = getCategoryIconForSlug(slug)\r\n  return <Icon size={size} weight={weight} className={className} />\r\n}\r\n\r\n// ============================================================================\r\n// CATEGORY COLORS - Semantic tokens\r\n// ============================================================================\r\n\r\nexport type CategoryColorScheme = {\n  bg: string // Background color class\n  text: string // Icon/text color class\n  ring: string // Active ring color class\n  hoverRing: string // Hover ring color class\n}\n\nexport type CategoryTone =\n  | \"all\"\n  | \"tech\"\n  | \"fashion\"\n  | \"home\"\n  | \"sports\"\n  | \"gaming\"\n  | \"beauty\"\n  | \"family\"\n  | \"media\"\n  | \"business\"\n  | \"lifestyle\"\n  | \"auto\"\n\nconst categoryToneRules: Array<{ tone: Exclude<CategoryTone, \"all\">; keys: string[] }> = [\n  {\n    tone: \"tech\",\n    keys: [\"electronic\", \"computer\", \"laptop\", \"phone\", \"tablet\", \"monitor\", \"desktop\", \"software\", \"smart-home\", \"camera\", \"audio\", \"tv\"],\n  },\n  {\n    tone: \"fashion\",\n    keys: [\"fashion\", \"jewelry\", \"watch\", \"shoe\", \"sneaker\", \"dress\", \"shirt\", \"pant\", \"coat\", \"jacket\", \"bag\", \"accessor\"],\n  },\n  {\n    tone: \"home\",\n    keys: [\"home\", \"kitchen\", \"garden\", \"lighting\", \"tool\", \"furniture\", \"real-estate\", \"property\"],\n  },\n  {\n    tone: \"sports\",\n    keys: [\"sport\", \"outdoor\", \"fitness\", \"barbell\", \"bicycle\", \"football\", \"basketball\", \"tennis\"],\n  },\n  {\n    tone: \"gaming\",\n    keys: [\"gaming\", \"console\", \"playstation\", \"xbox\", \"nintendo\"],\n  },\n  {\n    tone: \"beauty\",\n    keys: [\"beauty\", \"health\", \"wellness\", \"cbd\", \"cosmetic\", \"makeup\", \"skincare\"],\n  },\n  {\n    tone: \"family\",\n    keys: [\"baby\", \"kid\", \"children\", \"pet\", \"toy\", \"parent\"],\n  },\n  {\n    tone: \"media\",\n    keys: [\"book\", \"music\", \"movie\", \"film\", \"instrument\", \"hobb\", \"collectible\"],\n  },\n  {\n    tone: \"lifestyle\",\n    keys: [\"grocery\", \"handmade\", \"gift\", \"ticket\", \"food\", \"coffee\", \"wine\"],\n  },\n  {\n    tone: \"auto\",\n    keys: [\"automotive\", \"vehicle\", \"car\", \"motor\", \"e-mobility\", \"scooter\", \"wholesale\", \"truck\"],\n  },\n  {\n    tone: \"business\",\n    keys: [\"office\", \"services\", \"industrial\", \"scientific\", \"graduation\", \"school\", \"business\"],\n  },\n]\n\nconst categoryColors = {\n  all: {\n    bg: \"bg-surface-subtle\",\n    text: \"text-foreground\",\n    ring: \"ring-category-ring\",\n    hoverRing: \"group-hover:ring-category-ring\",\n  },\n  tech: {\n    bg: \"bg-category-tech-bg\",\n    text: \"text-category-tech-fg\",\n    ring: \"ring-category-tech-ring\",\n    hoverRing: \"group-hover:ring-category-tech-ring\",\n  },\n  fashion: {\n    bg: \"bg-category-fashion-bg\",\n    text: \"text-category-fashion-fg\",\n    ring: \"ring-category-fashion-ring\",\n    hoverRing: \"group-hover:ring-category-fashion-ring\",\n  },\n  home: {\n    bg: \"bg-category-home-bg\",\n    text: \"text-category-home-fg\",\n    ring: \"ring-category-home-ring\",\n    hoverRing: \"group-hover:ring-category-home-ring\",\n  },\n  sports: {\n    bg: \"bg-category-sports-bg\",\n    text: \"text-category-sports-fg\",\n    ring: \"ring-category-sports-ring\",\n    hoverRing: \"group-hover:ring-category-sports-ring\",\n  },\n  gaming: {\n    bg: \"bg-category-gaming-bg\",\n    text: \"text-category-gaming-fg\",\n    ring: \"ring-category-gaming-ring\",\n    hoverRing: \"group-hover:ring-category-gaming-ring\",\n  },\n  beauty: {\n    bg: \"bg-category-beauty-bg\",\n    text: \"text-category-beauty-fg\",\n    ring: \"ring-category-beauty-ring\",\n    hoverRing: \"group-hover:ring-category-beauty-ring\",\n  },\n  family: {\n    bg: \"bg-category-family-bg\",\n    text: \"text-category-family-fg\",\n    ring: \"ring-category-family-ring\",\n    hoverRing: \"group-hover:ring-category-family-ring\",\n  },\n  media: {\n    bg: \"bg-category-media-bg\",\n    text: \"text-category-media-fg\",\n    ring: \"ring-category-media-ring\",\n    hoverRing: \"group-hover:ring-category-media-ring\",\n  },\n  business: {\n    bg: \"bg-category-business-bg\",\n    text: \"text-category-business-fg\",\n    ring: \"ring-category-business-ring\",\n    hoverRing: \"group-hover:ring-category-business-ring\",\n  },\n  lifestyle: {\n    bg: \"bg-category-lifestyle-bg\",\n    text: \"text-category-lifestyle-fg\",\n    ring: \"ring-category-lifestyle-ring\",\n    hoverRing: \"group-hover:ring-category-lifestyle-ring\",\n  },\n  auto: {\n    bg: \"bg-category-auto-bg\",\n    text: \"text-category-auto-fg\",\n    ring: \"ring-category-auto-ring\",\n    hoverRing: \"group-hover:ring-category-auto-ring\",\n  },\n} satisfies Record<CategoryTone, CategoryColorScheme>\n\nexport function resolveCategoryTone(slug: string): CategoryTone {\n  const slugKey = slug.toLowerCase()\n  if (slugKey === \"all\" || slugKey === \"categories\") return \"all\"\n\n  for (const rule of categoryToneRules) {\n    if (rule.keys.some((key) => slugKey.includes(key))) {\n      return rule.tone\n    }\n  }\n\n  return \"business\"\n}\n\n/**\n * Get the color scheme for a category slug.\n */\nexport function getCategoryColor(slug: string): CategoryColorScheme {\n  return categoryColors[resolveCategoryTone(slug)]\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\charts\\chart-area-interactive.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\charts\\chart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\coming-soon-page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\count-badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\dropdown-product-item.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\empty-state-cta.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\error-boundary-ui.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\field.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\_lib\\filter-priority.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\color-swatches.tsx","messages":[{"ruleId":"unicorn/prefer-number-properties","severity":1,"message":"Prefer `Number.parseInt` over `parseInt`.","line":65,"column":13,"nodeType":"Identifier","messageId":"error","endLine":65,"endColumn":21,"fix":{"range":[1597,1605],"text":"Number.parseInt"}},{"ruleId":"unicorn/prefer-number-properties","severity":1,"message":"Prefer `Number.parseInt` over `parseInt`.","line":66,"column":13,"nodeType":"Identifier","messageId":"error","endLine":66,"endColumn":21,"fix":{"range":[1640,1648],"text":"Number.parseInt"}},{"ruleId":"unicorn/prefer-number-properties","severity":1,"message":"Prefer `Number.parseInt` over `parseInt`.","line":67,"column":13,"nodeType":"Identifier","messageId":"error","endLine":67,"endColumn":21,"fix":{"range":[1683,1691],"text":"Number.parseInt"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":3,"source":"\"use client\"\r\n\r\nimport { Check } from \"@phosphor-icons/react\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\n// =============================================================================\r\n// COLOR SWATCHES ΓÇö Circle-based color selector for Filter Hub\r\n//\r\n// Per UI_UX_CODEX.md:\r\n// - Color: swatches (circles), not text-only\r\n// - Touch targets >= 44x44\r\n// =============================================================================\r\n\r\ninterface ColorSwatchesProps {\r\n  options: string[]\r\n  selected: string[]\r\n  onSelect: (values: string[]) => void\r\n  multiSelect?: boolean\r\n}\r\n\r\n// Common color name to hex mapping\r\nconst COLOR_MAP: Record<string, string> = {\r\n  // Basic colors\r\n  black: \"#000000\",\r\n  white: \"#FFFFFF\",\r\n  red: \"#EF4444\",\r\n  blue: \"#3B82F6\",\r\n  green: \"#22C55E\",\r\n  yellow: \"#EAB308\",\r\n  orange: \"#F97316\",\r\n  purple: \"#A855F7\",\r\n  pink: \"#EC4899\",\r\n  brown: \"#92400E\",\r\n  gray: \"#6B7280\",\r\n  grey: \"#6B7280\",\r\n  navy: \"#1E3A5F\",\r\n  beige: \"#D4C4A8\",\r\n  cream: \"#FFFDD0\",\r\n  gold: \"#FFD700\",\r\n  silver: \"#C0C0C0\",\r\n  bronze: \"#CD7F32\",\r\n  // Bulgarian translations\r\n  ╤ç╨╡╤Ç╨╡╨╜: \"#000000\",\r\n  ╨▒╤Å╨╗: \"#FFFFFF\",\r\n  ╤ç╨╡╤Ç╨▓╨╡╨╜: \"#EF4444\",\r\n  ╤ü╨╕╨╜: \"#3B82F6\",\r\n  ╨╖╨╡╨╗╨╡╨╜: \"#22C55E\",\r\n  ╨╢╤è╨╗╤é: \"#EAB308\",\r\n  ╨╛╤Ç╨░╨╜╨╢╨╡╨▓: \"#F97316\",\r\n  ╨╗╨╕╨╗╨░╨▓: \"#A855F7\",\r\n  ╤Ç╨╛╨╖╨╛╨▓: \"#EC4899\",\r\n  ╨║╨░╤ä╤Å╨▓: \"#92400E\",\r\n  ╤ü╨╕╨▓: \"#6B7280\",\r\n  ╨▒╨╡╨╢╨╛╨▓: \"#D4C4A8\",\r\n  ╨╖╨╗╨░╤é╨╡╨╜: \"#FFD700\",\r\n  ╤ü╤Ç╨╡╨▒╤è╤Ç╨╡╨╜: \"#C0C0C0\",\r\n}\r\n\r\nfunction getColorHex(colorName: string): string | null {\r\n  const normalized = colorName.toLowerCase().trim()\r\n  return COLOR_MAP[normalized] ?? null\r\n}\r\n\r\nfunction isLightColor(hex: string): boolean {\r\n  const r = parseInt(hex.slice(1, 3), 16)\r\n  const g = parseInt(hex.slice(3, 5), 16)\r\n  const b = parseInt(hex.slice(5, 7), 16)\r\n  // Relative luminance formula\r\n  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255\r\n  return luminance > 0.7\r\n}\r\n\r\nexport function ColorSwatches({\r\n  options,\r\n  selected,\r\n  onSelect,\r\n  multiSelect = true,\r\n}: ColorSwatchesProps) {\r\n  const handleSelect = (option: string) => {\r\n    if (!multiSelect) {\r\n      onSelect(selected.includes(option) ? [] : [option])\r\n      return\r\n    }\r\n    const newValues = selected.includes(option)\r\n      ? selected.filter((v) => v !== option)\r\n      : [...selected, option]\r\n    onSelect(newValues)\r\n  }\r\n\r\n  return (\r\n    <div className=\"grid grid-cols-4 gap-3\">\r\n      {options.map((option) => {\r\n        const isActive = selected.includes(option)\r\n        const hex = getColorHex(option)\r\n        const isLight = hex ? isLightColor(hex) : false\r\n\r\n        return (\r\n          <button\r\n            key={option}\r\n            type=\"button\"\r\n            onClick={() => handleSelect(option)}\r\n              className={cn(\n                \"flex flex-col items-center gap-1.5 p-2 rounded-lg transition-colors\",\n                \"min-h-touch min-w-touch\",\n              isActive ? \"bg-secondary\" : \"active:bg-active\"\n            )}\n            aria-pressed={isActive}\n          >\n            {/* Color circle */}\r\n            <div\r\n              className={cn(\r\n                \"size-8 rounded-full border-2 flex items-center justify-center transition-all\",\r\n                isActive ? \"border-primary ring-2 ring-primary\" : \"border-border\",\n                !hex && \"bg-muted\"\r\n              )}\r\n              style={hex ? { backgroundColor: hex } : undefined}\r\n            >\r\n              {isActive && (\r\n                <Check\n                  size={16}\n                  weight=\"bold\"\n                  className={cn(\n                    hex && isLight ? \"text-foreground\" : \"text-overlay-text\",\n                    !hex && \"text-primary\"\n                  )}\n                />\n              )}\n            </div>\r\n            {/* Color name */}\r\n            <span\r\n              className={cn(\r\n                \"text-xs text-center line-clamp-1\",\r\n                isActive ? \"text-primary font-medium\" : \"text-muted-foreground\"\r\n              )}\r\n            >\r\n              {option}\r\n            </span>\r\n          </button>\r\n        )\r\n      })}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\desktop-filters.tsx","messages":[{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":52,"column":45,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":52,"endColumn":62}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useSearchParams } from \"next/navigation\"\r\nimport { usePathname, useRouter } from \"@/i18n/routing\"\r\nimport { Star, Sliders, Check, CurrencyDollar } from \"@phosphor-icons/react\"\r\nimport { ChevronDown } from \"lucide-react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuGroup,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\"\r\nimport { DesktopFilterModal } from \"@/components/desktop/desktop-filter-modal\"\r\nimport type { CategoryAttribute } from \"@/lib/data/categories\"\r\n\r\ninterface DesktopFiltersProps {\r\n  attributes?: CategoryAttribute[]\r\n  categorySlug?: string\r\n  categoryId?: string\r\n}\r\n\r\n// =============================================================================\r\n// Desktop Filters ΓÇö Clean dropdown menus following shadcn patterns\r\n// Matches SortSelect styling for visual consistency\r\n// =============================================================================\r\n\r\nexport function DesktopFilters({ attributes = [], categorySlug, categoryId }: DesktopFiltersProps) {\r\n  const router = useRouter()\r\n  const pathname = usePathname()\r\n  const searchParams = useSearchParams()\r\n  const t = useTranslations('SearchFilters')\r\n\r\n  const currentMinPrice = searchParams.get(\"minPrice\")\r\n  const currentMaxPrice = searchParams.get(\"maxPrice\")\r\n  const currentRating = searchParams.get(\"minRating\")\r\n\r\n  const basePath = categorySlug ? pathname : '/search'\r\n\r\n  const updateParams = (updates: Record<string, string | null>) => {\r\n    const params = new URLSearchParams(searchParams.toString())\r\n    for (const [key, value] of Object.entries(updates)) {\r\n      if (value === null) params.delete(key)\r\n      else params.set(key, value)\r\n    }\r\n    const queryString = params.toString()\r\n    router.push(`${basePath}${queryString ? `?${queryString}` : ''}`)\r\n  }\r\n\r\n  const priceRanges = [\r\n    { label: t('under25'), min: null, max: \"25\" },\r\n    { label: t('range2550'), min: \"25\", max: \"50\" },\r\n    { label: t('range50100'), min: \"50\", max: \"100\" },\r\n    { label: t('range100200'), min: \"100\", max: \"200\" },\r\n    { label: t('above200'), min: \"200\", max: null }\r\n  ]\r\n\r\n  const getPriceLabel = () => {\r\n    if (currentMinPrice && currentMaxPrice) return `$${currentMinPrice}ΓÇô$${currentMaxPrice}`\r\n    if (currentMinPrice) return `$${currentMinPrice}+`\r\n    if (currentMaxPrice) return `${t('under')} $${currentMaxPrice}`\r\n    return t('price')\r\n  }\r\n\r\n  const getRatingLabel = () => {\r\n    if (currentRating) return `${currentRating}Γÿà ${t('andUp')}`\r\n    return t('customerReviews')\r\n  }\r\n\r\n  const hasPriceFilter = currentMinPrice || currentMaxPrice\r\n  const hasRatingFilter = !!currentRating\r\n  const hasAttributes = attributes.length > 0\r\n\r\n  // Count all active filters for badge\r\n  const activeFilterCount = (() => {\r\n    let count = 0\r\n    if (hasPriceFilter) count++\r\n    if (hasRatingFilter) count++\r\n    // Count attr_* params\r\n    for (const key of searchParams.keys()) {\r\n      if (key.startsWith('attr_')) count++\r\n    }\r\n    return count\r\n  })()\r\n\r\n  // Shared trigger styling (matches SortSelect)\n  const triggerClass = cn(\n    \"h-8 px-3 gap-1.5 rounded-lg\",\n    \"bg-surface-subtle hover:bg-hover border border-border\",\n    \"text-xs font-medium text-foreground\",\n    \"focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-ring\",\n  )\n  const triggerActiveClass = \"bg-selected text-primary border-selected-border hover:bg-hover\"\n\r\n  return (\r\n    <div className=\"flex items-center gap-2\">\r\n      {/* Price Filter */}\r\n      <DropdownMenu>\r\n        <DropdownMenuTrigger asChild>\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            className={cn(triggerClass, hasPriceFilter && triggerActiveClass)}\r\n          >\r\n            <CurrencyDollar size={14} weight=\"regular\" className=\"shrink-0\" />\r\n            <span className=\"max-w-24 truncate\">{getPriceLabel()}</span>\r\n            <ChevronDown className=\"size-3 opacity-50 shrink-0\" />\r\n          </Button>\r\n        </DropdownMenuTrigger>\r\n        <DropdownMenuContent align=\"start\" className=\"w-48\">\r\n          <DropdownMenuGroup>\r\n            {priceRanges.map(({ label, min, max }) => {\r\n              const isActive = currentMinPrice === min && currentMaxPrice === max\r\n              return (\r\n                <DropdownMenuItem\r\n                  key={label}\r\n                  onClick={() => updateParams({ minPrice: min, maxPrice: max })}\r\n                  className={cn(isActive && \"bg-accent\")}\r\n                >\r\n                  <span className=\"flex-1\">{label}</span>\r\n                  {isActive && <Check className=\"size-4 text-primary\" />}\r\n                </DropdownMenuItem>\r\n              )\r\n            })}\r\n          </DropdownMenuGroup>\r\n          {hasPriceFilter && (\r\n            <>\r\n              <DropdownMenuSeparator />\r\n              <DropdownMenuItem\r\n                onClick={() => updateParams({ minPrice: null, maxPrice: null })}\r\n                variant=\"destructive\"\r\n              >\r\n                {t('clearPrice')}\r\n              </DropdownMenuItem>\r\n            </>\r\n          )}\r\n        </DropdownMenuContent>\r\n      </DropdownMenu>\r\n\r\n      {/* Rating Filter */}\r\n      <DropdownMenu>\r\n        <DropdownMenuTrigger asChild>\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            className={cn(triggerClass, hasRatingFilter && triggerActiveClass)}\r\n          >\r\n            <Star size={14} weight={hasRatingFilter ? \"fill\" : \"regular\"} className=\"shrink-0 text-rating\" />\r\n            <span className=\"max-w-28 truncate\">{getRatingLabel()}</span>\r\n            <ChevronDown className=\"size-3 opacity-50 shrink-0\" />\r\n          </Button>\r\n        </DropdownMenuTrigger>\r\n        <DropdownMenuContent align=\"start\" className=\"w-52\">\r\n          <DropdownMenuGroup>\r\n            {[4, 3, 2, 1].map((stars) => {\r\n              const isActive = currentRating === stars.toString()\r\n              return (\r\n                <DropdownMenuItem\r\n                  key={stars}\r\n                  onClick={() => updateParams({ minRating: isActive ? null : stars.toString() })}\r\n                  className={cn(\"gap-2\", isActive && \"bg-accent\")}\r\n                >\r\n                  <span className=\"flex text-rating\">\r\n                    {[...Array(5)].map((_, i) => (\r\n                      <Star key={i} size={14} weight={i < stars ? \"fill\" : \"regular\"} />\r\n                    ))}\r\n                  </span>\r\n                  <span className=\"text-muted-foreground\">{t('andUp')}</span>\r\n                  {isActive && <Check className=\"size-4 ml-auto text-primary\" />}\r\n                </DropdownMenuItem>\r\n              )\r\n            })}\r\n          </DropdownMenuGroup>\r\n          {hasRatingFilter && (\r\n            <>\r\n              <DropdownMenuSeparator />\r\n              <DropdownMenuItem\r\n                onClick={() => updateParams({ minRating: null })}\r\n                variant=\"destructive\"\r\n              >\r\n                {t('clearRating')}\r\n              </DropdownMenuItem>\r\n            </>\r\n          )}\r\n        </DropdownMenuContent>\r\n      </DropdownMenu>\r\n\r\n      {/* All Filters - Only show when we have category attributes */}\r\n      {hasAttributes && categorySlug && (\r\n        <DesktopFilterModal\r\n          attributes={attributes}\r\n          categorySlug={categorySlug}\r\n          categoryId={categoryId}\r\n          trigger={\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              className={cn(triggerClass, activeFilterCount > 0 && triggerActiveClass)}\r\n            >\r\n              <Sliders size={14} weight=\"regular\" className=\"shrink-0\" />\r\n              <span>{t('filters')}</span>\r\n              {activeFilterCount > 0 && (\r\n                <Badge variant=\"default\" className=\"h-4 min-w-4 px-1 text-2xs rounded-full\">\r\n                  {activeFilterCount}\r\n                </Badge>\r\n              )}\r\n            </Button>\r\n          }\r\n        />\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\filter-attribute-config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\filter-attribute-section-content.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\filter-availability-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\filter-category-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\filter-checkbox-item.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\filter-chips.tsx","messages":[{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":105,"column":49,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":105,"endColumn":66}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useMemo, useCallback } from \"react\"\nimport { useSearchParams, type ReadonlyURLSearchParams } from \"next/navigation\"\nimport { useRouter } from \"@/i18n/routing\"\nimport { X, Star, Truck, Package, Percent, Tag, MapPin, Navigation } from \"lucide-react\"\nimport { cn } from \"@/lib/utils\"\nimport { useLocale, useTranslations } from \"next-intl\"\nimport { BULGARIAN_CITIES } from \"@/lib/bulgarian-cities\"\n\r\n// =============================================================================\r\n// ACTIVE FILTER CHIPS ΓÇö Removable pills showing applied filters\r\n//\r\n// Design system compliance (.codex/project/DESIGN.md):\r\n// - Consistent chip height (h-touch-sm = 36px)\r\n// - rounded-full for pill shape (per token reference)\r\n// - Semantic tokens (bg-secondary, text-muted-foreground)\r\n// - lucide-react icons (repo standard)\r\n// - Hover state shows X more prominently\r\n// =============================================================================\r\n\r\ninterface FilterChipsProps {\r\n  /** Current category context (shown as removable chip) */\r\n  currentCategory?: { name: string; slug: string } | null\r\n  /** Base path for URL updates (e.g., \"/categories/electronics\") */\r\n  basePath?: string\r\n  /** External search params (for instant-apply flows without URL navigation) */\r\n  appliedSearchParams?: URLSearchParams | ReadonlyURLSearchParams\r\n  /** Callback when filters are removed (for instant-apply mode) */\r\n  onRemoveFilter?: (key: string, key2?: string) => void\r\n  /** Callback to clear all filters (for instant-apply mode) */\r\n  onClearAll?: () => void\r\n  /** Additional CSS classes */\r\n  className?: string\r\n}\r\n\r\nexport function FilterChips({\n  currentCategory,\r\n  basePath,\r\n  appliedSearchParams,\r\n  onRemoveFilter,\r\n  onClearAll,\r\n  className,\r\n}: FilterChipsProps) {\n  const router = useRouter()\n  const searchParamsFromRouter = useSearchParams()\n  const searchParams = appliedSearchParams ?? searchParamsFromRouter\n  const t = useTranslations(\"SearchFilters\")\n  const locale = useLocale()\n\r\n  // Determine if we're in \"instant\" mode (external params + callbacks)\r\n  const isInstantMode = Boolean(appliedSearchParams && onRemoveFilter)\r\n\r\n  const currentMinPrice = searchParams.get(\"minPrice\")\r\n  const currentMaxPrice = searchParams.get(\"maxPrice\")\r\n  const currentRating = searchParams.get(\"minRating\")\r\n  const currentDeals = searchParams.get(\"deals\")\n  const currentAvailability = searchParams.get(\"availability\")\n  const currentFreeShipping = searchParams.get(\"freeShipping\")\n  const currentCity = searchParams.get(\"city\")\n  const currentNearby = searchParams.get(\"nearby\") === \"true\"\n\r\n  // Collect all attr_* params for attribute filter chips\r\n  const attributeFilters = useMemo(() => {\r\n    const attrs: Array<{ name: string; values: string[] }> = []\r\n    for (const key of searchParams.keys()) {\r\n      if (key.startsWith(\"attr_\")) {\r\n        const attrName = key.replace(\"attr_\", \"\")\r\n        const values = searchParams.getAll(key)\r\n        if (values.length > 0) {\r\n          attrs.push({ name: attrName, values })\r\n        }\r\n      }\r\n    }\r\n    return attrs\r\n  }, [searchParams])\r\n\r\n  const removeParam = useCallback(\r\n    (key: string, key2?: string) => {\r\n      // Instant mode: delegate to callback\r\n      if (isInstantMode && onRemoveFilter) {\r\n        onRemoveFilter(key, key2)\r\n        return\r\n      }\r\n\r\n      // Handle Category Chip Removal\r\n      if (key === \"category\") {\r\n        if (basePath) {\r\n          router.push(\"/categories\")\r\n        } else {\r\n          const params = new URLSearchParams(searchParams.toString())\r\n          params.delete(\"category\")\r\n          params.delete(\"page\")\r\n          router.push(`/search?${params.toString()}`)\r\n        }\r\n        return\r\n      }\r\n\r\n      const params = new URLSearchParams(searchParams.toString())\r\n      params.delete(key)\r\n      if (key2) params.delete(key2)\r\n      params.delete(\"page\")\r\n      const queryString = params.toString()\r\n      if (basePath) {\r\n        router.push(`${basePath}${queryString ? `?${queryString}` : \"\"}`)\r\n      } else {\r\n        router.push(`/search?${queryString}`)\r\n      }\r\n    },\r\n    [isInstantMode, onRemoveFilter, basePath, router, searchParams]\r\n  )\r\n\r\n  const chips: Array<{\r\n    key: string\r\n    key2?: string\r\n    label: string\r\n    icon?: React.ReactNode\r\n    color?: string\r\n  }> = []\r\n\r\n  // Current Category Chip\r\n  if (currentCategory) {\r\n    chips.push({\r\n      key: \"category\",\r\n      label: currentCategory.name,\r\n      icon: <Tag className=\"size-3.5\" />,\r\n    })\r\n  }\r\n\r\n  // Free Shipping chip\r\n  if (currentFreeShipping === \"true\") {\r\n    chips.push({\r\n      key: \"freeShipping\",\r\n      label: t(\"freeShipping\"),\r\n      icon: <Truck className=\"size-3.5\" />,\r\n    })\r\n  }\r\n\r\n  // Rating chip\r\n  if (currentRating) {\r\n    chips.push({\r\n      key: \"minRating\",\r\n      label: `${currentRating}+ ${t(\"stars\")}`,\r\n      icon: <Star className=\"size-3.5 fill-current\" />,\r\n    })\r\n  }\r\n\r\n  // Price chip\r\n  if (currentMinPrice || currentMaxPrice) {\r\n    let priceLabel = \"\"\r\n    if (currentMinPrice && currentMaxPrice) {\r\n      priceLabel = `Γé¼${currentMinPrice} ΓÇô Γé¼${currentMaxPrice}`\r\n    } else if (currentMinPrice) {\r\n      priceLabel = `Γé¼${currentMinPrice}+`\r\n    } else if (currentMaxPrice) {\r\n      priceLabel = `${t(\"under\")} Γé¼${currentMaxPrice}`\r\n    }\r\n    chips.push({\r\n      key: \"minPrice\",\r\n      key2: \"maxPrice\",\r\n      label: priceLabel,\r\n    })\r\n  }\r\n\r\n  // Deals chip\n  if (currentDeals === \"true\") {\n    chips.push({\r\n      key: \"deals\",\r\n      label: t(\"todaysDeals\"),\r\n      icon: <Percent className=\"size-3.5\" />,\r\n    })\r\n  }\r\n\r\n  // Availability chip\n  if (currentAvailability === \"instock\") {\n    chips.push({\r\n      key: \"availability\",\r\n      label: t(\"inStock\"),\r\n      icon: <Package className=\"size-3.5\" />,\n    })\n  }\n\n  if (currentCity) {\n    const city = BULGARIAN_CITIES.find((entry) => entry.value === currentCity)\n    const cityLabel = city\n      ? (locale === \"bg\" ? city.labelBg : city.label)\n      : currentCity\n    chips.push({\n      key: \"city\",\n      label: cityLabel,\n      icon: <MapPin className=\"size-3.5\" />,\n    })\n  }\n\n  if (currentNearby) {\n    chips.push({\n      key: \"nearby\",\n      label: t(\"nearMe\"),\n      icon: <Navigation className=\"size-3.5\" />,\n    })\n  }\n\r\n  // Attribute filter chips (attr_*)\r\n  for (const { name, values } of attributeFilters) {\r\n    const displayName = name.charAt(0).toUpperCase() + name.slice(1)\r\n    const label =\r\n      values.length === 1\r\n        ? `${displayName}: ${values[0]}`\r\n        : `${displayName}: ${values.length}`\r\n\r\n    chips.push({\r\n      key: `attr_${name}`,\r\n      label,\r\n      icon: <Tag className=\"size-3.5\" />,\r\n    })\r\n  }\r\n\r\n  const handleClearAll = useCallback(() => {\r\n    if (isInstantMode && onClearAll) {\r\n      onClearAll()\r\n      return\r\n    }\r\n    if (basePath) {\r\n      router.push(basePath)\r\n    } else {\r\n      const params = new URLSearchParams()\r\n      const q = searchParams.get(\"q\")\r\n      const category = searchParams.get(\"category\")\r\n      if (q) params.set(\"q\", q)\r\n      if (category) params.set(\"category\", category)\r\n      router.push(`/search?${params.toString()}`)\r\n    }\r\n  }, [isInstantMode, onClearAll, basePath, router, searchParams])\r\n\r\n  // Don't render if no active filters\r\n  if (chips.length === 0) return null\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"flex items-center gap-1.5 overflow-x-auto no-scrollbar\",\r\n        \"-mx-4 px-4 lg:mx-0 lg:px-0 lg:flex-wrap\",\r\n        className\r\n      )}\r\n      role=\"list\"\r\n      aria-label={t(\"activeFilters\")}\r\n    >\r\n      {chips.map((chip) => (\r\n        <button\r\n          key={chip.key}\r\n          type=\"button\"\r\n          onClick={() => removeParam(chip.key, chip.key2)}\r\n          className={cn(\r\n            // Layout\r\n            \"inline-flex items-center gap-1 h-touch-sm pl-2.5 pr-1.5 shrink-0\",\r\n            // Shape (pill per .codex/project/DESIGN.md)\r\n            \"rounded-full\",\r\n            // Colors (neutral, inverted on hover)\r\n            \"bg-secondary text-foreground\",\r\n            \"hover:bg-destructive hover:text-destructive-foreground\",\r\n            // Typography\r\n            \"text-xs font-medium whitespace-nowrap\",\r\n            // Interaction\n            \"transition-colors duration-150\",\n            \"tap-transparent\",\n            \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1\",\n            \"group\"\n          )}\n          role=\"listitem\"\r\n          aria-label={`${t(\"removeFilter\")}: ${chip.label}`}\r\n        >\r\n          {chip.icon && <span aria-hidden=\"true\">{chip.icon}</span>}\r\n          <span>{chip.label}</span>\r\n          <span\r\n            className={cn(\r\n              \"size-4 rounded-full inline-flex items-center justify-center\",\r\n              \"bg-muted group-hover:bg-destructive-subtle\",\r\n              \"transition-colors\"\r\n            )}\r\n            aria-hidden=\"true\"\r\n          >\r\n            <X className=\"size-3\" />\r\n          </span>\r\n        </button>\r\n      ))}\r\n\r\n      {/* Clear All button when multiple filters */}\r\n      {chips.length > 1 && (\r\n        <button\r\n          type=\"button\"\r\n          onClick={handleClearAll}\r\n          className={cn(\r\n            \"inline-flex items-center gap-1 h-touch-sm px-2.5 shrink-0\",\r\n            \"rounded-full\",\r\n            \"text-xs font-medium whitespace-nowrap\",\r\n            \"text-muted-foreground hover:text-destructive\",\n            \"transition-colors duration-150\",\n            \"tap-transparent\",\n            \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-1\"\n          )}\n        >\r\n          <X className=\"size-3.5\" aria-hidden=\"true\" />\r\n          <span>{t(\"clearAllFilters\")}</span>\r\n        </button>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\filter-hub.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SquaresFour' is defined but never used.","line":10,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":10,"endColumn":14,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SquaresFour"},"fix":{"range":[279,295],"text":""},"desc":"Remove unused variable \"SquaresFour\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Checkbox' is defined but never used.","line":16,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":18,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Checkbox"},"fix":{"range":[517,568],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'categorySlug' is defined but never used.","line":142,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":142,"endColumn":15},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":298,"column":23,"nodeType":"CallExpression","messageId":"array-from","endLine":298,"endColumn":48,"fix":{"range":[9776,9801],"text":"[...params.keys()]"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 42 to the 25 allowed.","line":341,"column":45,"nodeType":null,"messageId":"refactorFunction","endLine":341,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\"\r\n\r\nimport { useState, useCallback, useEffect, useMemo, startTransition } from \"react\"\r\nimport { useSearchParams, type ReadonlyURLSearchParams } from \"next/navigation\"\r\nimport { usePathname, useRouter } from \"@/i18n/routing\"\nimport {\r\n  CaretLeft,\r\n  CaretRight,\r\n  X,\r\n  SquaresFour,\r\n} from \"@phosphor-icons/react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { useFilterCount } from \"@/hooks/use-filter-count\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Checkbox } from \"@/components/ui/checkbox\"\r\nimport {\r\n  Drawer,\r\n  DrawerBody,\r\n  DrawerContent,\r\n  DrawerFooter,\r\n  DrawerHeader,\r\n  DrawerTitle,\r\n} from \"@/components/ui/drawer\"\r\nimport type { CategoryAttribute } from \"@/lib/data/categories\"\nimport {\n  getCategoryAttributeKey,\n  getCategoryAttributeLabel,\n  getCategoryAttributeOptions,\n  shouldForceMultiSelectCategoryAttribute,\n} from \"@/lib/filters/category-attribute\"\nimport { BULGARIAN_CITIES } from \"@/lib/bulgarian-cities\"\nimport { usePendingFilters } from \"./use-pending-filters\"\nimport { FilterAttributeSectionContent } from \"./filter-attribute-section-content\"\nimport { PriceSlider } from \"./price-slider\"\nimport { FilterRatingSection } from \"./filter-rating-section\"\nimport { FilterAvailabilitySection } from \"./filter-availability-section\"\nimport { FilterCategorySection } from \"./filter-category-section\"\nimport { FilterCheckboxItem } from \"./filter-checkbox-item\"\nimport { FilterRadioGroup, FilterRadioItem } from \"./filter-radio-group\"\nimport {\n  isHiddenFilterAttribute,\n} from \"./filter-attribute-config\"\n\r\n// =============================================================================\r\n// FILTER HUB ΓÇö Main filtering modal with pending/applied state\r\n//\r\n// Per UI_UX_CODEX.md:\r\n// - Bottom sheet, height: up to 90dvh\r\n// - Rounded top corners: rounded-t-3xl\r\n// - Drill-down navigation (Apple Settings style)\r\n// - pending selections change inside the hub\r\n// - applied selections are what the grid uses\r\n// - Only Apply updates the grid and URL\r\n// - Live result count on sticky CTA\r\n// - L2+ category refinement lives inside the hub (Phase 3)\r\n// =============================================================================\r\n\r\n/** Subcategory for L2+ drill-down in Filter Hub */\nexport interface FilterHubSubcategory {\n  id: string\r\n  name: string\r\n  name_bg: string | null\r\n  slug: string\r\n  icon?: string | null\r\n}\r\n\r\n/** Mode: \"full\" = normal list view, \"single\" = one section only (for quick pills) */\r\nexport type FilterHubMode = \"full\" | \"single\"\r\n\r\n/** Section identifiers for initialSection prop */\r\nexport type FilterHubSection =\n  | \"category\"\n  | \"rating\"\n  | \"price\"\n  | \"location\"\n  | \"availability\"\n  | `attr_${string}`\n\r\ninterface FilterHubProps {\n  open: boolean\r\n  onOpenChange: (open: boolean) => void\r\n  locale: string\r\n  resultsCount?: number\r\n  categorySlug?: string | undefined\r\n  categoryId?: string | undefined\r\n  /** Search query text (for /search page) */\r\n  searchQuery?: string | undefined\r\n  attributes?: CategoryAttribute[]\r\n  basePath?: string | undefined\r\n  /** Subcategories for L2+ drill-down (passed from parent) */\r\n  subcategories?: FilterHubSubcategory[]\r\n  /** Current category name for display */\r\n  categoryName?: string\r\n  /** Optional externally-controlled applied params (for instant, non-navigating flows) */\r\n  appliedSearchParams?: URLSearchParams | ReadonlyURLSearchParams | undefined\r\n  /** Optional apply handler to avoid router navigation */\r\n  onApply?: (next: {\r\n    queryString: string\r\n    finalPath: string\r\n    pendingCategorySlug?: string | null\r\n  }) => void\r\n  /**\r\n   * Mode: \"full\" (default) shows list view + drill-down\r\n   * \"single\" shows only the initialSection with compact header\r\n   */\r\n  mode?: FilterHubMode\r\n  /**\r\n   * When mode=\"single\", which section to display\r\n   * (e.g., \"price\", \"rating\", \"category\", \"attr_brand\")\r\n   */\r\n  initialSection?: FilterHubSection | null\n}\n\n// =============================================================================\n// Types\n// =============================================================================\n\r\ntype BaseFilterSection = {\r\n  id: string\r\n  label: string\r\n  attribute?: undefined\r\n}\r\n\r\ntype AttrFilterSection = {\r\n  id: string\r\n  label: string\r\n  attribute: CategoryAttribute\r\n}\r\n\r\ntype FilterSection = BaseFilterSection | AttrFilterSection\r\n\r\n// =============================================================================\r\n// Component\r\n// =============================================================================\r\n\r\nexport function FilterHub({\r\n  open,\r\n  onOpenChange,\r\n  locale,\r\n  resultsCount = 0,\r\n  categorySlug,\r\n  categoryId,\r\n  searchQuery,\r\n  attributes = [],\r\n  basePath,\r\n  subcategories = [],\r\n  categoryName,\r\n  appliedSearchParams,\r\n  onApply,\r\n  mode = \"full\",\r\n  initialSection = null,\r\n}: FilterHubProps) {\r\n  const t = useTranslations(\"SearchFilters\")\r\n  const tHub = useTranslations(\"FilterHub\")\r\n  const tCommon = useTranslations(\"Common\")\r\n  const router = useRouter()\r\n  const pathname = usePathname()\r\n  const searchParamsFromRouter = useSearchParams()\r\n  const searchParams = appliedSearchParams ?? searchParamsFromRouter\r\n\r\n  // Filter out hidden attributes\r\n  const visibleAttributes = useMemo(\n    () => attributes.filter((attr) => !isHiddenFilterAttribute(attr.name)),\n    [attributes]\n  )\n\r\n  // Active section for drill-down navigation\r\n  const [activeSection, setActiveSection] = useState<string | null>(null)\r\n\r\n  // Pending category slug (for L2+ refinement - Phase 3)\n  const [pendingCategorySlug, setPendingCategorySlug] = useState<string | null>(null)\n\n  const {\n    pending,\n    setPending,\n    getPendingAttrValues,\n    setPendingAttrValues,\n    clearPendingFilters,\n    hasPendingFilterValues,\n  } = usePendingFilters({\n    open,\n    searchParams,\n    attributes: visibleAttributes,\n    includeExtendedFields: true,\n  })\n\r\n  // Build count params for live count hook\r\n  // Use pending category if selected, otherwise current category\r\n  const effectiveCategoryId = useMemo(() => {\r\n    if (pendingCategorySlug) {\r\n      const subcat = subcategories.find((s) => s.slug === pendingCategorySlug)\r\n      return subcat?.id ?? categoryId ?? null\r\n    }\r\n    return categoryId ?? null\r\n  }, [pendingCategorySlug, subcategories, categoryId])\r\n\r\n  const countParams = useMemo(\r\n    () => ({\r\n      categoryId: effectiveCategoryId,\r\n      query: searchQuery ?? null,\r\n      filters: {\r\n        minPrice: pending.minPrice ? Number(pending.minPrice) : null,\r\n        maxPrice: pending.maxPrice ? Number(pending.maxPrice) : null,\r\n        minRating: pending.minRating ? Number(pending.minRating) : null,\r\n        availability: pending.availability as \"instock\" | null,\r\n        attributes: pending.attributes,\r\n      },\r\n    }),\r\n    [effectiveCategoryId, searchQuery, pending]\r\n  )\r\n\r\n  // Live count via debounced hook (only active when modal is open)\r\n  const { count: liveCount, isLoading: isCountLoading } = useFilterCount(\r\n    open ? countParams : { categoryId: null, filters: {} }\r\n  )\r\n\r\n  // Resolve base path\r\n  const resolvedBasePath = basePath ?? pathname\r\n\r\n  // Initialize pending state from URL when modal opens\r\n  useEffect(() => {\n    if (!open) return\n\n    // In single mode, start directly at the initialSection\n    // In full mode, start at the list view (null)\n    setActiveSection(mode === \"single\" && initialSection ? initialSection : null)\n    setPendingCategorySlug(null) // Reset pending category\n  }, [open, mode, initialSection])\n\r\n  // Build filter sections\r\n  const filterSections: FilterSection[] = useMemo(() => {\r\n    const sections: BaseFilterSection[] = []\r\n\r\n    // Add category section if subcategories exist (Phase 3: L2+ in Filter Hub)\r\n    if (subcategories.length > 0) {\r\n      sections.push({ id: \"category\", label: tHub(\"category\") })\r\n    }\r\n\r\n    // Base filter sections\r\n    sections.push(\r\n      { id: \"rating\", label: t(\"customerReviews\") },\r\n      { id: \"price\", label: t(\"price\") },\r\n      { id: \"location\", label: t(\"location\") },\r\n      { id: \"availability\", label: t(\"availability\") }\r\n    )\r\n\r\n    const attrSections: AttrFilterSection[] = visibleAttributes.map((attr) => ({\r\n      id: `attr_${attr.id}`,\r\n      label: getCategoryAttributeLabel(attr, locale),\r\n      attribute: attr,\r\n    }))\r\n\r\n    return [...sections, ...attrSections]\r\n  }, [t, tHub, visibleAttributes, locale, subcategories.length])\r\n\r\n  // Check if attribute should allow multi-select\r\n  const shouldForceMultiSelect = useCallback((attr: CategoryAttribute) => {\r\n    return shouldForceMultiSelectCategoryAttribute(attr)\r\n  }, [])\r\n\r\n  // Get attribute options for current locale\r\n  const getAttrOptions = useCallback(\r\n    (attr: CategoryAttribute) => {\r\n      return getCategoryAttributeOptions(attr, locale)\r\n    },\r\n    [locale]\r\n  )\r\n\r\n  // Pending state helpers\r\n  // Clear all pending filters (including pending category)\n  const clearAllPending = useCallback(() => {\n    setPendingCategorySlug(null)\n    clearPendingFilters()\n  }, [clearPendingFilters])\n\n  // Check if any pending filters or category is set\n  const hasPendingFilters = useMemo(() => {\n    return pendingCategorySlug !== null || hasPendingFilterValues\n  }, [pendingCategorySlug, hasPendingFilterValues])\n\r\n  // Apply pending filters to URL\r\n  const applyFilters = useCallback(() => {\r\n    const params = new URLSearchParams(searchParams.toString())\r\n\r\n    // Remove all filter params\r\n    params.delete(\"minPrice\")\r\n    params.delete(\"maxPrice\")\r\n    params.delete(\"minRating\")\r\n    params.delete(\"availability\")\r\n    params.delete(\"deals\")\r\n    params.delete(\"verified\")\r\n    params.delete(\"city\")\r\n    params.delete(\"nearby\")\r\n    params.delete(\"page\")\r\n\r\n    // Remove all attr_* params\r\n    for (const key of Array.from(params.keys())) {\r\n      if (key.startsWith(\"attr_\")) {\r\n        params.delete(key)\r\n      }\r\n    }\r\n\r\n    // Apply pending base filters\r\n    if (pending.minPrice) params.set(\"minPrice\", pending.minPrice)\r\n    if (pending.maxPrice) params.set(\"maxPrice\", pending.maxPrice)\r\n    if (pending.minRating) params.set(\"minRating\", pending.minRating)\r\n    if (pending.availability) params.set(\"availability\", pending.availability)\r\n    if (pending.deals) params.set(\"deals\", pending.deals)\r\n    if (pending.verified) params.set(\"verified\", pending.verified)\r\n    if (pending.city) params.set(\"city\", pending.city)\r\n    if (pending.nearby) params.set(\"nearby\", pending.nearby)\r\n\r\n    // Apply pending attribute filters\r\n    for (const [attrName, values] of Object.entries(pending.attributes)) {\r\n      for (const v of values) {\r\n        if (v) params.append(`attr_${attrName}`, v)\r\n      }\r\n    }\r\n\r\n    // Determine final path - navigate to subcategory if pending category selected\r\n    let finalPath = resolvedBasePath\r\n    if (pendingCategorySlug) {\r\n      finalPath = `/categories/${pendingCategorySlug}`\r\n    }\r\n\r\n    const queryString = params.toString()\r\n    if (onApply) {\r\n      onApply({ queryString, finalPath, pendingCategorySlug })\r\n    } else {\r\n      // Replace instead of push: avoids history spam and reduces the feeling of a full reload.\r\n      startTransition(() => {\r\n        router.replace(queryString ? `${finalPath}?${queryString}` : finalPath)\r\n      })\r\n    }\r\n    onOpenChange(false)\r\n  }, [pending, pendingCategorySlug, searchParams, resolvedBasePath, router, onOpenChange, onApply])\r\n\r\n  // Get selected summary for a section (for main list view)\r\n  const getSelectedSummary = useCallback(\r\n    (section: FilterSection): string | null => {\r\n      // Category section - show selected subcategory name\r\n      if (section.id === \"category\") {\r\n        if (!pendingCategorySlug) return null\r\n        const subcat = subcategories.find((s) => s.slug === pendingCategorySlug)\r\n        if (!subcat) return null\r\n        return locale === \"bg\" && subcat.name_bg ? subcat.name_bg : subcat.name\r\n      }\r\n      if (section.id === \"rating\") {\r\n        return pending.minRating ? `${pending.minRating}+ ${t(\"stars\")}` : null\r\n      }\r\n      if (section.id === \"price\") {\r\n        if (pending.minPrice && pending.maxPrice) {\r\n          return `$${pending.minPrice} - $${pending.maxPrice}`\r\n        }\r\n        if (pending.minPrice) return `$${pending.minPrice}+`\r\n        if (pending.maxPrice) return `${t(\"under\")} $${pending.maxPrice}`\r\n        return null\r\n      }\r\n      if (section.id === \"availability\") {\r\n        return pending.availability === \"instock\" ? t(\"inStock\") : null\r\n      }\r\n      if (section.id === \"location\") {\r\n        const parts: string[] = []\r\n        if (pending.city) {\r\n          const cityData = BULGARIAN_CITIES.find((c) => c.value === pending.city)\r\n          if (cityData) {\r\n            parts.push(locale === \"bg\" ? cityData.labelBg : cityData.label)\r\n          }\r\n        }\r\n        if (pending.nearby === \"true\") {\r\n          parts.push(t(\"nearMe\"))\r\n        }\r\n        return parts.length > 0 ? parts.join(\", \") : null\r\n      }\r\n      if (\"attribute\" in section && section.attribute) {\r\n        const values = getPendingAttrValues(getCategoryAttributeKey(section.attribute))\r\n        if (values.length === 0) return null\r\n        if (values.length === 1) return values[0] ?? null\r\n        return `${values.length} ${tHub(\"selected\")}`\r\n      }\r\n      return null\r\n    },\r\n    [pending, pendingCategorySlug, subcategories, locale, t, tHub, getPendingAttrValues]\r\n  )\r\n\r\n  // Display count - use live count when modal is open\r\n  const displayCount = open ? liveCount : resultsCount\r\n\r\n  // In single mode, we're always \"in\" a section\r\n  const isSingleMode = mode === \"single\" && initialSection\r\n\r\n  // Get current section label for single mode header\r\n  const currentSectionLabel = useMemo(() => {\r\n    if (!activeSection) return null\r\n    return filterSections.find((s) => s.id === activeSection)?.label ?? null\r\n  }, [activeSection, filterSections])\r\n\r\n  return (\r\n    <Drawer open={open} onOpenChange={onOpenChange}>\r\n      <DrawerContent\r\n        aria-label={tHub(\"refineSearch\")}\r\n        className=\"max-h-dialog flex flex-col rounded-t-2xl px-0 pb-0 bg-background lg:hidden\"\r\n      >\r\n        {/* Header */}\r\n        <DrawerHeader\r\n          className={cn(\r\n            \"px-inset pb-3 border-b border-border\",\r\n            activeSection || isSingleMode ? \"pt-4\" : \"pt-3\"\r\n          )}\r\n        >\r\n          <div className=\"flex items-center justify-between min-h-touch-sm\">\r\n            {/* Single mode: show title + close button */}\r\n            {isSingleMode ? (\r\n              <>\r\n                <DrawerTitle className=\"text-base font-semibold\">\r\n                  {currentSectionLabel}\r\n                </DrawerTitle>\r\n                <div className=\"flex items-center gap-2\">\r\n                  {hasPendingFilters && (\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={clearAllPending}\r\n                      className=\"text-sm font-medium text-primary active:opacity-70 transition-opacity\"\r\n                    >\r\n                      {tHub(\"clearAll\")}\r\n                    </button>\r\n                  )}\r\n                  <button\n                    type=\"button\"\n                    onClick={() => onOpenChange(false)}\n                    className=\"size-11 flex items-center justify-center rounded-full hover:bg-hover active:bg-active transition-colors\"\n                    aria-label={tHub(\"close\")}\n                  >\n                    <X size={18} weight=\"bold\" />\n                  </button>\n                </div>\r\n              </>\r\n            ) : activeSection ? (\r\n              /* Full mode: sub-section with back button */\r\n              <button\r\n                type=\"button\"\r\n                onClick={() => setActiveSection(null)}\r\n                className=\"flex items-center gap-2 text-foreground font-semibold active:opacity-70 transition-opacity\"\r\n              >\r\n                <CaretLeft size={20} weight=\"bold\" />\r\n                <span className=\"text-base\">\r\n                  {currentSectionLabel}\r\n                </span>\r\n              </button>\r\n            ) : (\r\n              /* Full mode: main list view */\r\n              <DrawerTitle className=\"text-base font-semibold\">\r\n                {tHub(\"refineSearch\")}\r\n              </DrawerTitle>\r\n            )}\r\n\r\n            {/* Clear all button (full mode, list view only) */}\r\n            {!isSingleMode && hasPendingFilters && !activeSection && (\r\n              <button\r\n                type=\"button\"\r\n                onClick={clearAllPending}\r\n                className=\"text-sm font-medium text-primary active:opacity-70 transition-opacity\"\r\n              >\r\n                {tHub(\"clearAll\")}\r\n              </button>\r\n            )}\r\n          </div>\r\n        </DrawerHeader>\r\n\r\n        {/* Filter Content */}\r\n        <DrawerBody className=\"px-0 bg-background\">\r\n          {/* In single mode, always show the section content directly */}\r\n          {/* In full mode, show list view when no section is active */}\r\n          {!activeSection && !isSingleMode ? (\r\n            /* Main List View (full mode only) */\r\n            <div className=\"divide-y divide-border\">\r\n              {filterSections.map((section) => {\r\n                const summary = getSelectedSummary(section)\r\n                return (\r\n                  <button\n                    key={section.id}\n                    type=\"button\"\n                    onClick={() => setActiveSection(section.id)}\n                    className=\"w-full flex items-center justify-between px-inset h-11 active:bg-active transition-colors text-left\"\n                  >\n                    <div className=\"flex flex-col\">\r\n                      <span className=\"text-sm text-foreground\">\r\n                        {section.label}\r\n                      </span>\r\n                      {summary && (\r\n                        <span className=\"text-xs text-muted-foreground truncate\">\r\n                          {summary}\r\n                        </span>\r\n                      )}\r\n                    </div>\r\n                    <CaretRight\r\n                      size={16}\r\n                      weight=\"bold\"\r\n                      className=\"text-muted-foreground\"\r\n                    />\r\n                  </button>\r\n                )\r\n              })}\r\n            </div>\r\n          ) : (\r\n            /* Sub-view for specific filter (full mode drill-down or single mode) */\r\n            <div className=\"px-inset py-4 space-y-2\">\r\n              {/* Ratings */}\r\n              {activeSection === \"rating\" && (\r\n                <FilterRatingSection\r\n                  minRating={pending.minRating}\r\n                  onChange={(minRating) => setPending((prev) => ({ ...prev, minRating }))}\r\n                />\r\n              )}\r\n\r\n              {/* Price */}\r\n              {activeSection === \"price\" && (\r\n                <PriceSlider\r\n                  value={{ min: pending.minPrice, max: pending.maxPrice }}\r\n                  onChange={({ min, max }) =>\r\n                    setPending((prev) => ({ ...prev, minPrice: min, maxPrice: max }))\r\n                  }\r\n                />\r\n              )}\r\n\r\n              {/* Availability */}\r\n              {activeSection === \"availability\" && (\r\n                <FilterAvailabilitySection\r\n                  availability={pending.availability}\r\n                  onChange={(availability) => setPending((prev) => ({ ...prev, availability }))}\r\n                />\r\n              )}\r\n\r\n              {/* Location */}\r\n              {activeSection === \"location\" && (\r\n                <div className=\"space-y-4\">\r\n                  {/* City selector */}\r\n                  <div className=\"-mx-inset\">\r\n                    <FilterRadioGroup\r\n                      value={pending.city ?? \"\"}\r\n                      onValueChange={(value) => setPending((prev) => ({ ...prev, city: value || null }))}\r\n                    >\r\n                      {/* Any location option */}\r\n                      <FilterRadioItem value=\"\" fullBleed>\r\n                        {t(\"anyLocation\")}\r\n                      </FilterRadioItem>\r\n                      \r\n                      {/* City options */}\r\n                      {BULGARIAN_CITIES.filter(c => c.value !== \"other\").slice(0, 15).map((city) => (\r\n                        <FilterRadioItem\r\n                          key={city.value}\r\n                          value={city.value}\r\n                          fullBleed\r\n                        >\r\n                          {locale === \"bg\" ? city.labelBg : city.label}\r\n                        </FilterRadioItem>\r\n                      ))}\r\n                    </FilterRadioGroup>\r\n                  </div>\r\n                  \r\n                  {/* Nearby toggle */}\r\n                  <div className=\"-mx-inset\">\r\n                    <FilterCheckboxItem\r\n                      checked={pending.nearby === \"true\"}\r\n                      onCheckedChange={(checked) => setPending((prev) => ({ \r\n                        ...prev, \r\n                        nearby: checked ? \"true\" : null \r\n                      }))}\r\n                      fullBleed\r\n                    >\r\n                      {t(\"nearMe\")}\r\n                    </FilterCheckboxItem>\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {/* Category Section - L2+ drill-down (Phase 3) */}\r\n              {activeSection === \"category\" && subcategories.length > 0 && (\r\n                <FilterCategorySection\r\n                  locale={locale}\r\n                  categoryName={categoryName ?? \"\"}\r\n                  pendingCategorySlug={pendingCategorySlug}\r\n                  onChangePendingCategorySlug={setPendingCategorySlug}\r\n                  subcategories={subcategories}\r\n                  onCloseHub={() => onOpenChange(false)}\r\n                />\r\n              )}\r\n\r\n              {/* Category Attribute Filters */}\r\n              {(() => {\n                const section = filterSections.find(\n                  (s) => s.id === activeSection\n                ) as AttrFilterSection | undefined\n                if (!section?.attribute) return null\n\n                const attr = section.attribute\n                const attrKey = getCategoryAttributeKey(attr)\n                const options = getAttrOptions(attr) ?? []\n\n                return (\n                  <FilterAttributeSectionContent\n                    attribute={attr}\n                    attrKey={attrKey}\n                    options={options}\n                    selectedValues={getPendingAttrValues(attrKey)}\n                    onSelectedValuesChange={(values) => setPendingAttrValues(attrKey, values)}\n                    shouldForceMultiSelect={shouldForceMultiSelect}\n                    yesLabel={tCommon(\"yes\")}\n                    checkboxListClassName=\"-mx-inset\"\n                    checkboxItemsFullBleed\n                    booleanFullBleed\n                  />\n                )\n              })()}\n            </div>\n          )}\n        </DrawerBody>\r\n\r\n        {/* Footer with Apply CTA + Live Count */}\r\n        <DrawerFooter className=\"px-inset border-t border-border bg-background\">\r\n          <Button\r\n            className=\"w-full h-11 rounded-full text-sm font-bold\"\r\n            onClick={applyFilters}\r\n            disabled={displayCount === 0 && hasPendingFilters}\r\n          >\r\n            {isCountLoading ? (\r\n              <span className=\"animate-pulse\">{tHub(\"showResults\", { count: \"...\" })}</span>\r\n            ) : displayCount === 0 && hasPendingFilters ? (\r\n              tHub(\"noResults\")\r\n            ) : (\r\n              tHub(\"showResults\", { count: displayCount.toLocaleString() })\r\n            )}\r\n          </Button>\r\n        </DrawerFooter>\r\n      </DrawerContent>\r\n    </Drawer>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\filter-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\filter-radio-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\filter-rating-section.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\price-slider.tsx","messages":[{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":87,"column":28,"nodeType":"Identifier","messageId":"method","endLine":87,"endColumn":35,"fix":{"range":[2758,2758],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":93,"column":28,"nodeType":"Identifier","messageId":"method","endLine":93,"endColumn":35,"fix":{"range":[2966,2966],"text":"All"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":2,"source":"\"use client\"\r\n\r\nimport { useEffect, useMemo, useState } from \"react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { Slider } from \"@/components/ui/slider\"\r\n\r\ntype PriceValue = string | null\r\n\r\nfunction clamp(value: number, min: number, max: number) {\r\n  return Math.min(Math.max(value, min), max)\r\n}\r\n\r\nfunction parseNonNegativeInt(value: string): number | null {\r\n  const trimmed = value.trim()\r\n  if (!trimmed) return null\r\n  if (!/^[0-9]+$/.test(trimmed)) return null\r\n  const n = Number(trimmed)\r\n  if (!Number.isFinite(n) || n < 0) return null\r\n  return Math.floor(n)\r\n}\r\n\r\nfunction formatValue(value: number | null): PriceValue {\r\n  if (value === null) return null\r\n  return String(value)\r\n}\r\n\r\nexport interface PriceSliderValue {\r\n  min: PriceValue\r\n  max: PriceValue\r\n}\r\n\r\ninterface PriceSliderProps {\r\n  value: PriceSliderValue\r\n  onChange: (value: PriceSliderValue) => void\r\n  /** Inclusive maximum bound for the slider. If omitted, it grows with user input. */\r\n  maxLimit?: number\r\n  /** Step for the range inputs (defaults to 5) */\r\n  step?: number\r\n  className?: string\r\n}\r\n\r\nexport function PriceSlider({\r\n  value,\r\n  onChange,\r\n  maxLimit,\r\n  step = 5,\r\n  className,\r\n}: PriceSliderProps) {\r\n  const t = useTranslations(\"SearchFilters\")\r\n\r\n  const parsedMin = useMemo(() => parseNonNegativeInt(value.min ?? \"\"), [value.min])\r\n  const parsedMax = useMemo(() => parseNonNegativeInt(value.max ?? \"\"), [value.max])\r\n\r\n  const computedMaxLimit = useMemo(() => {\r\n    const base = maxLimit ?? 500\r\n    const maxCandidate = Math.max(base, parsedMin ?? 0, parsedMax ?? 0)\r\n    const rounded = Math.ceil(maxCandidate / step) * step\r\n    return Math.max(step, rounded)\r\n  }, [maxLimit, parsedMin, parsedMax, step])\r\n\r\n  const [minText, setMinText] = useState(value.min ?? \"\")\r\n  const [maxText, setMaxText] = useState(value.max ?? \"\")\r\n\r\n  useEffect(() => setMinText(value.min ?? \"\"), [value.min])\r\n  useEffect(() => setMaxText(value.max ?? \"\"), [value.max])\r\n\r\n  const minForSlider = clamp(parsedMin ?? 0, 0, computedMaxLimit)\r\n  const maxForSlider = clamp(parsedMax ?? computedMaxLimit, 0, computedMaxLimit)\r\n\r\n  const normalizedMin = Math.min(minForSlider, maxForSlider)\r\n  const normalizedMax = Math.max(minForSlider, maxForSlider)\r\n\r\n  const commit = (next: { min: number | null; max: number | null }, changed: \"min\" | \"max\") => {\r\n    let nextMin = next.min\r\n    let nextMax = next.max\r\n\r\n    if (nextMin !== null && nextMax !== null && nextMin > nextMax) {\r\n      if (changed === \"min\") nextMax = nextMin\r\n      else nextMin = nextMax\r\n    }\r\n\r\n    onChange({ min: formatValue(nextMin), max: formatValue(nextMax) })\r\n  }\r\n\r\n  const handleMinInput = (raw: string) => {\r\n    const digitsOnly = raw.replace(/[^0-9]/g, \"\")\r\n    setMinText(digitsOnly)\r\n    commit({ min: parseNonNegativeInt(digitsOnly), max: parsedMax }, \"min\")\r\n  }\r\n\r\n  const handleMaxInput = (raw: string) => {\r\n    const digitsOnly = raw.replace(/[^0-9]/g, \"\")\r\n    setMaxText(digitsOnly)\r\n    commit({ min: parsedMin, max: parseNonNegativeInt(digitsOnly) }, \"max\")\r\n  }\r\n\r\n  const handleSlider = (values: number[]) => {\r\n    const nextMinRaw = clamp(values[0] ?? 0, 0, computedMaxLimit)\r\n    const nextMaxRaw = clamp(values[1] ?? computedMaxLimit, 0, computedMaxLimit)\r\n\r\n    const nextMin = nextMinRaw <= 0 ? null : nextMinRaw\r\n    const nextMax = nextMaxRaw >= computedMaxLimit ? null : nextMaxRaw\r\n\r\n    onChange({ min: formatValue(nextMin), max: formatValue(nextMax) })\r\n  }\r\n\r\n  return (\r\n    <div className={cn(\"space-y-4\", className)}>\r\n      <div className=\"grid grid-cols-2 gap-3\">\r\n        <label className=\"space-y-1\">\r\n          <span className=\"text-xs font-medium text-muted-foreground\">{t(\"min\")}</span>\r\n          <input\r\n            inputMode=\"numeric\"\r\n            pattern=\"[0-9]*\"\r\n            value={minText}\r\n            onChange={(e) => handleMinInput(e.target.value)}\r\n            placeholder=\"0\"\r\n            className={cn(\n              \"w-full h-10 px-3 rounded-md\",\n              \"bg-surface-subtle border border-border/50\",\n              \"text-sm placeholder:text-muted-foreground\",\n              \"focus:outline-none focus:ring-2 focus:ring-focus-ring focus:border-primary\"\n            )}\n            aria-label={t(\"min\")}\r\n          />\r\n        </label>\r\n        <label className=\"space-y-1\">\r\n          <span className=\"text-xs font-medium text-muted-foreground\">{t(\"max\")}</span>\r\n          <input\r\n            inputMode=\"numeric\"\r\n            pattern=\"[0-9]*\"\r\n            value={maxText}\r\n            onChange={(e) => handleMaxInput(e.target.value)}\r\n            placeholder={String(computedMaxLimit)}\r\n            className={cn(\n              \"w-full h-10 px-3 rounded-md\",\n              \"bg-surface-subtle border border-border/50\",\n              \"text-sm placeholder:text-muted-foreground\",\n              \"focus:outline-none focus:ring-2 focus:ring-focus-ring focus:border-primary\"\n            )}\n            aria-label={t(\"max\")}\r\n          />\r\n        </label>\r\n      </div>\r\n\r\n      <div className=\"space-y-2\">\r\n        <Slider\r\n          min={0}\r\n          max={computedMaxLimit}\r\n          step={step}\r\n          value={[normalizedMin, normalizedMax]}\r\n          onValueChange={handleSlider}\r\n          thumbLabels={[t(\"min\"), t(\"max\")]}\r\n        />\r\n\r\n        <p className=\"text-xs text-muted-foreground\">\r\n          {t(\"min\")}: {value.min ?? \"ΓÇö\"} ┬╖ {t(\"max\")}: {value.max ?? \"ΓÇö\"}\r\n        </p>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\size-tiles.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Check' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":15,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Check"},"fix":{"range":[16,61],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Check } from \"@phosphor-icons/react\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\n// =============================================================================\r\n// SIZE TILES ΓÇö Tile grid for size selection (no dropdowns)\r\n//\r\n// Per UI_UX_CODEX.md:\r\n// - Size: tile grid (4 columns on mobile)\r\n// - Touch targets >= 44x44\r\n// =============================================================================\r\n\r\ninterface SizeTilesProps {\r\n  options: string[]\r\n  selected: string[]\r\n  onSelect: (values: string[]) => void\r\n  multiSelect?: boolean\r\n}\r\n\r\nexport function SizeTiles({\r\n  options,\r\n  selected,\r\n  onSelect,\r\n  multiSelect = true,\r\n}: SizeTilesProps) {\r\n  const handleSelect = (option: string) => {\r\n    if (!multiSelect) {\r\n      onSelect(selected.includes(option) ? [] : [option])\r\n      return\r\n    }\r\n    const newValues = selected.includes(option)\r\n      ? selected.filter((v) => v !== option)\r\n      : [...selected, option]\r\n    onSelect(newValues)\r\n  }\r\n\r\n  return (\r\n    <div className=\"grid grid-cols-4 gap-2\">\r\n      {options.map((option) => {\r\n        const isActive = selected.includes(option)\r\n\r\n        return (\r\n          <button\r\n            key={option}\r\n            type=\"button\"\r\n            onClick={() => handleSelect(option)}\r\n            className={cn(\r\n              \"flex items-center justify-center\",\r\n              \"min-h-touch rounded-md border text-sm font-medium\",\r\n              \"transition-colors\",\r\n              isActive\r\n                ? \"bg-primary text-primary-foreground border-primary\"\r\n                : \"bg-background text-foreground border-border active:bg-muted\"\r\n            )}\r\n            aria-pressed={isActive}\r\n          >\r\n            {option}\r\n          </button>\r\n        )\r\n      })}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\sort-modal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'locale' is defined but never used.","line":48,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":48,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useCallback } from \"react\"\r\nimport { useSearchParams } from \"next/navigation\"\r\nimport { usePathname, useRouter } from \"@/i18n/routing\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport {\r\n  Drawer,\r\n  DrawerContent,\r\n  DrawerHeader,\r\n  DrawerTitle,\r\n} from \"@/components/ui/drawer\"\r\nimport { FilterRadioGroup, FilterRadioItem } from \"./filter-radio-group\"\r\n\r\n// =============================================================================\r\n// SORT MODAL ΓÇö Bottom sheet for sort options\r\n//\r\n// Per UI_UX_CODEX.md:\r\n// - Sort opens a small bottom menu\r\n// - Selection applies immediately and closes the modal\r\n// =============================================================================\r\n\r\ninterface SortModalProps {\n  open: boolean\n  onOpenChange: (open: boolean) => void\n  locale: string\n  /** Override base path for sort query params */\n  basePath?: string | undefined\n  /** Sort options to hide from the list (e.g., when already handled by UI tabs) */\n  excludeOptions?: string[] | undefined\n  /** Controlled selected sort value (non-navigation mode). */\n  value?: string | undefined\n  /** Controlled change callback (non-navigation mode). */\n  onValueChange?: ((value: string) => void) | undefined\n}\n\r\nconst SORT_OPTIONS = [\r\n  { value: \"featured\", labelKey: \"featured\" },\r\n  { value: \"price-asc\", labelKey: \"priceLowHigh\" },\r\n  { value: \"price-desc\", labelKey: \"priceHighLow\" },\r\n  { value: \"rating\", labelKey: \"avgReview\" },\r\n  { value: \"newest\", labelKey: \"newestArrivals\" },\r\n] as const\r\n\r\nexport function SortModal({\n  open,\n  onOpenChange,\n  locale,\n  basePath,\n  excludeOptions = [],\n  value,\n  onValueChange,\n}: SortModalProps) {\n  const t = useTranslations(\"SearchFilters\")\n  const router = useRouter()\n  const pathname = usePathname()\n  const searchParams = useSearchParams()\n\n  const currentSort = value ?? searchParams.get(\"sort\") ?? \"featured\"\n  \r\n  // Filter out excluded options\r\n  const visibleOptions = SORT_OPTIONS.filter(\r\n    (option) => !excludeOptions.includes(option.value)\r\n  )\r\n\r\n  // Resolve the base path (strip locale if present)\r\n  const resolvedBasePath = basePath || (() => {\r\n    const segments = pathname.split(\"/\").filter(Boolean)\r\n    const maybeLocale = segments[0]\r\n    if (maybeLocale && /^[a-z]{2}(-[A-Z]{2})?$/i.test(maybeLocale)) {\r\n      segments.shift()\r\n    }\r\n    return `/${segments.join(\"/\")}` || \"/\"\r\n  })()\r\n\r\n  const handleSortChange = useCallback(\n    (value: string) => {\n      if (onValueChange) {\n        onValueChange(value)\n        onOpenChange(false)\n        return\n      }\n\n      const params = new URLSearchParams(searchParams.toString())\n\n      if (value === \"featured\") {\n        params.delete(\"sort\")\n      } else {\n        params.set(\"sort\", value)\r\n      }\r\n\r\n      // Reset to page 1 when sort changes\r\n      params.delete(\"page\")\r\n\r\n      const queryString = params.toString()\n      router.push(queryString ? `${resolvedBasePath}?${queryString}` : resolvedBasePath)\n      onOpenChange(false)\n    },\n    [onValueChange, onOpenChange, router, resolvedBasePath, searchParams]\n  )\n\r\n  return (\r\n    <Drawer open={open} onOpenChange={onOpenChange}>\r\n      <DrawerContent className=\"max-h-dialog-sm rounded-t-2xl lg:hidden\">\r\n        <DrawerHeader className=\"px-inset pt-4 pb-3 border-b border-border/50\">\r\n          <DrawerTitle className=\"text-base font-semibold text-center\">\r\n            {t(\"sortBy\")}\r\n          </DrawerTitle>\r\n        </DrawerHeader>\r\n\r\n        <div className=\"overflow-y-auto py-2 pb-safe-max px-inset\">\r\n          <FilterRadioGroup\r\n            value={currentSort}\r\n            onValueChange={handleSortChange}\r\n            className=\"-mx-inset\"\r\n          >\r\n            {visibleOptions.map((option) => (\r\n              <FilterRadioItem\r\n                key={option.value}\r\n                value={option.value}\r\n                fullBleed\r\n              >\r\n                {t(option.labelKey)}\r\n              </FilterRadioItem>\r\n            ))}\r\n          </FilterRadioGroup>\r\n        </div>\r\n      </DrawerContent>\r\n    </Drawer>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\filters\\use-pending-filters.ts","messages":[{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":67,"column":20,"nodeType":"CallExpression","messageId":"array-from","endLine":73,"endColumn":6,"fix":{"range":[1933,2161],"text":"[...new Set([\n        ...searchParams.getAll(`attr_${attrKey}`),\n        // Backward compatibility for legacy links that used raw attribute names.\n        ...searchParams.getAll(`attr_${attr.name}`),\n      ])]"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\"\n\nimport { useCallback, useEffect, useMemo, useState } from \"react\"\nimport type { ReadonlyURLSearchParams } from \"next/navigation\"\nimport type { CategoryAttribute } from \"@/lib/data/categories\"\nimport { getCategoryAttributeKey } from \"@/lib/filters/category-attribute\"\nimport { setPendingAttributeValues } from \"@/lib/filters/pending-attributes\"\n\nexport interface PendingFilters {\n  minPrice: string | null\n  maxPrice: string | null\n  minRating: string | null\n  availability: string | null\n  deals: string | null\n  verified: string | null\n  city: string | null\n  nearby: string | null\n  attributes: Record<string, string[]>\n}\n\ninterface UsePendingFiltersOptions {\n  open: boolean\n  searchParams: URLSearchParams | ReadonlyURLSearchParams\n  attributes?: CategoryAttribute[]\n  includeExtendedFields?: boolean\n}\n\nfunction createEmptyPendingFilters(): PendingFilters {\n  return {\n    minPrice: null,\n    maxPrice: null,\n    minRating: null,\n    availability: null,\n    deals: null,\n    verified: null,\n    city: null,\n    nearby: null,\n    attributes: {},\n  }\n}\n\nexport function buildPendingFiltersFromSearchParams({\n  searchParams,\n  attributes = [],\n  includeExtendedFields = true,\n}: {\n  searchParams: URLSearchParams | ReadonlyURLSearchParams\n  attributes?: CategoryAttribute[]\n  includeExtendedFields?: boolean\n}): PendingFilters {\n  const pending = createEmptyPendingFilters()\n\n  pending.minPrice = searchParams.get(\"minPrice\")\n  pending.maxPrice = searchParams.get(\"maxPrice\")\n  pending.minRating = searchParams.get(\"minRating\")\n  pending.availability = searchParams.get(\"availability\")\n\n  if (includeExtendedFields) {\n    pending.deals = searchParams.get(\"deals\")\n    pending.verified = searchParams.get(\"verified\")\n    pending.city = searchParams.get(\"city\")\n    pending.nearby = searchParams.get(\"nearby\")\n  }\n\n  for (const attr of attributes) {\n    const attrKey = getCategoryAttributeKey(attr)\n    const values = Array.from(\n      new Set([\n        ...searchParams.getAll(`attr_${attrKey}`),\n        // Backward compatibility for legacy links that used raw attribute names.\n        ...searchParams.getAll(`attr_${attr.name}`),\n      ])\n    ).filter((value) => Boolean(value))\n\n    if (values.length > 0) {\n      pending.attributes[attrKey] = values\n    }\n  }\n\n  return pending\n}\n\nexport function usePendingFilters({\n  open,\n  searchParams,\n  attributes = [],\n  includeExtendedFields = true,\n}: UsePendingFiltersOptions) {\n  const [pending, setPending] = useState<PendingFilters>(() => createEmptyPendingFilters())\n\n  const resetPendingFromSearchParams = useCallback(() => {\n    setPending(\n      buildPendingFiltersFromSearchParams({\n        searchParams,\n        attributes,\n        includeExtendedFields,\n      })\n    )\n  }, [searchParams, attributes, includeExtendedFields])\n\n  useEffect(() => {\n    if (!open) return\n    resetPendingFromSearchParams()\n  }, [open, resetPendingFromSearchParams])\n\n  const clearPendingFilters = useCallback(() => {\n    setPending(createEmptyPendingFilters())\n  }, [])\n\n  const getPendingAttrValues = useCallback(\n    (attrName: string): string[] => pending.attributes[attrName] || [],\n    [pending.attributes]\n  )\n\n  const setPendingAttrValues = useCallback((attrName: string, values: string[]) => {\n    setPending((prev) => ({\n      ...prev,\n      attributes: setPendingAttributeValues(prev.attributes, attrName, values),\n    }))\n  }, [])\n\n  const hasPendingFilterValues = useMemo(() => {\n    if (pending.minPrice !== null) return true\n    if (pending.maxPrice !== null) return true\n    if (pending.minRating !== null) return true\n    if (pending.availability !== null) return true\n    if (includeExtendedFields) {\n      if (pending.deals !== null) return true\n      if (pending.verified !== null) return true\n      if (pending.city !== null) return true\n      if (pending.nearby !== null) return true\n    }\n    return Object.keys(pending.attributes).length > 0\n  }, [pending, includeExtendedFields])\n\n  return {\n    pending,\n    setPending,\n    getPendingAttrValues,\n    setPendingAttrValues,\n    resetPendingFromSearchParams,\n    clearPendingFilters,\n    hasPendingFilterValues,\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\geo-welcome-modal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\locale-switcher.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\modal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\navigation\\app-breadcrumb.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\orders\\order-status-badge.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'OrderStatusDot' is defined but never used.","line":46,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":46,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { cn } from \"@/lib/utils\"\nimport { ORDER_STATUS_CONFIG } from \"@/components/shared/orders/order-status-config\"\nimport type { OrderItemStatus } from \"@/lib/order-status\"\nimport { useTranslations } from \"next-intl\"\n\r\ninterface OrderStatusBadgeProps {\r\n  status: OrderItemStatus\r\n  showIcon?: boolean\r\n  size?: 'sm' | 'md' | 'lg'\r\n  className?: string\r\n}\r\n\r\nexport function OrderStatusBadge({ \n  status, \n  showIcon = true,\n  size = 'md',\n  className \n}: OrderStatusBadgeProps) {\n  const t = useTranslations(\"Orders\")\n  const config = ORDER_STATUS_CONFIG[status] || ORDER_STATUS_CONFIG.pending\n\r\n  const sizeClasses = {\r\n    sm: 'px-2 py-0.5 text-xs',\r\n    md: 'px-2.5 py-1 text-sm',\r\n    lg: 'px-3 py-1.5 text-base'\r\n  }\r\n\r\n  return (\r\n    <span\r\n      className={cn(\r\n        \"inline-flex items-center gap-1.5 font-medium rounded-full border\",\r\n        config.bgColor,\r\n        config.color,\r\n        config.borderColor,\r\n        sizeClasses[size],\r\n        className\r\n      )}\n    >\n      {showIcon && <span className=\"shrink-0\">{config.icon}</span>}\n      <span>{t(config.labelKey)}</span>\n    </span>\n  )\n}\n\n// Compact version for tables\nfunction OrderStatusDot({ status }: { status: OrderItemStatus }) {\n  const t = useTranslations(\"Orders\")\n  const config = ORDER_STATUS_CONFIG[status] || ORDER_STATUS_CONFIG.pending\n  \r\n  const dotColors: Record<OrderItemStatus, string> = {\r\n    pending: 'bg-order-pending',\r\n    received: 'bg-order-received',\r\n    processing: 'bg-order-processing',\r\n    shipped: 'bg-order-shipped',\r\n    delivered: 'bg-order-delivered',\r\n    cancelled: 'bg-order-cancelled',\r\n  }\r\n\r\n  return (\n    <span className=\"inline-flex items-center gap-2\">\n      <span className={cn(\"w-2 h-2 rounded-full\", dotColors[status])} />\n      <span className=\"text-sm text-muted-foreground\">{t(config.labelKey)}</span>\n    </span>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\orders\\order-status-config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\page-container.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\page-shell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\_lib\\condition-badges.ts","messages":[{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":12,"column":46,"nodeType":"Identifier","messageId":"method","endLine":12,"endColumn":53,"fix":{"range":[376,376],"text":"All"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"export type ConditionBadgeVariant =\n  | \"condition-new\"\n  | \"condition-likenew\"\n  | \"condition-good\"\n  | \"condition-fair\"\n  | \"condition-used\"\n  | \"condition-refurb\"\n  | \"condition\"\n\nexport function getConditionBadgeVariant(condition: string | null | undefined): ConditionBadgeVariant {\n  if (!condition) return \"condition\"\n  const normalized = condition.toLowerCase().replace(/[\\s_-]/g, \"\")\n  switch (normalized) {\n    case \"new\":\n    case \"newwithtags\":\n      return \"condition-new\"\n    case \"likenew\":\n    case \"usedexcellent\":\n      return \"condition-likenew\"\n    case \"good\":\n    case \"usedgood\":\n      return \"condition-good\"\n    case \"fair\":\n    case \"usedfair\":\n      return \"condition-fair\"\n    case \"used\":\n      return \"condition-used\"\n    case \"refurbished\":\n    case \"refurb\":\n      return \"condition-refurb\"\n    default:\n      return \"condition\"\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\_lib\\condition.ts","messages":[{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":2,"column":42,"nodeType":"Identifier","messageId":"method","endLine":2,"endColumn":49,"fix":{"range":[112,112],"text":"All"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"export function getConditionKey(value: string): string | null {\n  const normalized = value.toLowerCase().replace(/[\\s_-]/g, \"\")\n\n  switch (normalized) {\n    case \"new\":\n    case \"novo\":\n    case \"╨╜╨╛╨▓╨╛\":\n      return \"condition.new\"\n    case \"newwithtags\":\n      return \"condition.newWithTags\"\n    case \"newwithouttags\":\n      return \"condition.newWithoutTags\"\n    case \"likenew\":\n    case \"usedlikenew\":\n    case \"╨║╨░╤é╨╛╨╜╨╛╨▓╨╛\":\n      return \"condition.likeNew\"\n    case \"usedexcellent\":\n      return \"condition.usedExcellent\"\n    case \"usedgood\":\n      return \"condition.usedGood\"\n    case \"usedfair\":\n      return \"condition.usedFair\"\n    case \"refurbished\":\n    case \"refurb\":\n    case \"╤Ç╨╡╤ä╤è╤Ç╨▒╨╕╤ê\":\n      return \"condition.refurbished\"\n    case \"used\":\n    case \"╤â╨┐╨╛╤é╤Ç╨╡╨▒╤Å╨▓╨░╨╜╨╛\":\n      return \"condition.used\"\n    case \"good\":\n      return \"condition.good\"\n    case \"fair\":\n      return \"condition.fair\"\n    default:\n      return null\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\_lib\\mobile-card-rules.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\_lib\\product-card-hero-attributes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\category-badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\customer-reviews-hybrid.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'initials' is defined but never used.","line":42,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":42,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { Star, PencilLine } from \"lucide-react\";\r\nimport { useTranslations } from \"next-intl\";\r\nimport { useRouter } from \"@/i18n/routing\";\r\n\r\nimport { UserAvatar } from \"@/components/shared/user-avatar\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Progress } from \"@/components/ui/progress\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { WriteReviewDialog, type SubmitReviewFn } from \"./write-review-dialog\";\r\n\r\nexport interface CustomerReview {\r\n  id: string;\r\n  rating: number;\r\n  comment: string | null;\r\n  created_at: string;\r\n  user: {\r\n    display_name: string | null;\r\n    username: string | null;\r\n    avatar_url: string | null;\r\n  } | null;\r\n}\r\n\r\ninterface CustomerReviewsHybridProps {\r\n  rating: number;\r\n  reviewCount: number;\r\n  reviews: CustomerReview[];\r\n  productId?: string;\r\n  productTitle?: string;\r\n  locale?: string;\r\n  /** Server action to submit review - must be passed from route-level component */\r\n  submitReview?: SubmitReviewFn;\r\n}\r\n\r\nfunction formatDate(value: string) {\r\n  const d = new Date(value);\r\n  if (Number.isNaN(d.getTime())) return \"\";\r\n  return d.toLocaleDateString(undefined, { year: \"numeric\", month: \"short\", day: \"numeric\" });\r\n}\r\n\r\nfunction initials(name: string) {\r\n  const parts = name.trim().split(/\\s+/).slice(0, 2);\r\n  return parts.map((p) => p.slice(0, 1).toUpperCase()).join(\"\");\r\n}\r\n\r\nexport function CustomerReviewsHybrid({ \r\n  rating, \r\n  reviewCount, \r\n  reviews,\r\n  productId,\r\n  productTitle,\r\n  locale = \"en\",\r\n  submitReview,\r\n}: CustomerReviewsHybridProps) {\r\n  const router = useRouter();\r\n  \r\n  // Use reviews array as source of truth - if no reviews exist, show 0 rating\r\n  // This prevents the contradiction where rating shows 4.7 but reviews show \"No reviews yet\"\r\n  const hasReviews = reviews.length > 0;\r\n  const safeRating = hasReviews && Number.isFinite(rating) ? rating : 0;\r\n  const safeCount = hasReviews ? (Number.isFinite(reviewCount) ? reviewCount : reviews.length) : 0;\r\n\r\n  const distribution = [1, 2, 3, 4, 5].map((s) => reviews.filter((r) => r.rating === s).length);\r\n\r\n  const t = useTranslations(\"Reviews\");\n\n  return (\n    <section className=\"mt-4 rounded-xl bg-surface-subtle p-3 border border-border-subtle\">\n      <div className=\"flex items-center justify-between mb-3 gap-3 flex-wrap\">\n        <h2 className=\"text-lg font-bold text-foreground tracking-tight\">{t(\"customerReviews\")}</h2>\n        <div className=\"flex items-center gap-3\">\n          {productId && submitReview && (\n            <WriteReviewDialog\r\n              productId={productId}\r\n              {...(productTitle ? { productTitle } : {})}\r\n              locale={locale}\r\n              submitReview={submitReview}\n              onReviewSubmitted={() => router.refresh()}\n              trigger={\n                <Button variant=\"default\" size=\"default\" className=\"gap-2\">\n                  <PencilLine className=\"h-4 w-4\" />\n                  {t(\"writeReview\")}\n                </Button>\n              }\n            />\n          )}\r\n          <div className=\"text-xs text-muted-foreground font-semibold uppercase tracking-widest\">\r\n            {t(\"globalRatings\", { count: safeCount })}\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"flex flex-col gap-4 lg:flex-row\">\n        {/* Summary */}\n        <div className=\"space-y-3 lg:w-60 lg:shrink-0\">\n          <div className=\"flex items-center gap-2.5\">\n            <div className=\"relative flex h-12 w-12 items-center justify-center rounded-full border-2 border-border text-xl font-bold text-foreground\">\n              {safeRating.toFixed(1)}\n            </div>\n             <div>\n               <div className=\"flex gap-0.5 text-muted-foreground mb-1\" aria-label={`${safeRating.toFixed(1)} ${t(\"outOf5\")}`}>\n                 {[...Array(5)].map((_, i) => (\n                  <Star key={i} className={`h-4 w-4 ${i < Math.round(safeRating) ? \"fill-current\" : \"text-border\"}`} />\n                  ))}\n                </div>\n                <div className=\"text-2xs text-muted-foreground font-medium\">\n                  {t(\"globalRatings\", { count: safeCount })}\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"space-y-2 bg-background p-3 rounded-xl border border-border\">\n            {[5, 4, 3, 2, 1].map((star) => {\n              const count = distribution[star - 1] ?? 0;\n              const pct = safeCount > 0 ? (count / safeCount) * 100 : 0;\n              return (\n                <div key={star} className=\"flex items-center gap-2 text-xs\">\n                  <div className=\"flex items-center gap-0.5 w-8\">\n                    <Star className=\"h-3 w-3 fill-current text-muted-foreground\" />\n                    <span className=\"font-medium text-foreground\">{star}</span>\n                  </div>\n                  <Progress value={pct} className=\"h-1.5 flex-1 bg-muted\" indicatorClassName=\"bg-muted-foreground\" />\n                  <span className=\"w-6 text-right text-muted-foreground text-2xs\">{count}</span>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n\n        {/* Reviews */}\n        <div className=\"lg:flex-1\">\n          {reviews.length === 0 ? (\n            <div className=\"rounded-xl border border-border-subtle bg-background p-3 text-center\">\n              <p className=\"text-sm text-muted-foreground mb-3\">{t(\"noReviews\")}</p>\n              {productId && submitReview && (\n                <WriteReviewDialog\n                  productId={productId}\n                  {...(productTitle ? { productTitle } : {})}\r\n                  locale={locale}\r\n                  submitReview={submitReview}\n                  onReviewSubmitted={() => router.refresh()}\n                  trigger={\n                    <Button variant=\"outline\" size=\"default\">\n                      {t(\"beFirst\")}\n                    </Button>\n                  }\n                />\n              )}\n            </div>\n          ) : (\n            <div className=\"grid grid-cols-1 gap-3 md:grid-cols-2\">\n              {reviews.map((review) => {\n                const author =\n                  review.user?.display_name ||\n                  review.user?.username ||\n                  t(\"anonymousUser\");\n                return (\n                  <Card key={review.id} className=\"border border-border-subtle bg-background overflow-hidden\">\n                    <CardContent className=\"p-3\">\n                      <div className=\"flex items-center justify-between mb-2\">\n                        <div className=\"flex text-muted-foreground gap-0.5\" aria-label={`${review.rating} ${t(\"outOf5\")}`}>\n                          {[...Array(5)].map((_, i) => (\n                            <Star key={i} className={`h-3 w-3 ${i < review.rating ? \"fill-current\" : \"text-border\"}`} />\n                          ))}\n                        </div>\n                        <span className=\"text-2xs text-muted-foreground\">\n                          {formatDate(review.created_at)}\n                        </span>\r\n                      </div>\r\n\r\n                      <div className=\"flex items-center gap-2 mb-2\">\r\n                        <UserAvatar\r\n                          name={author}\r\n                          avatarUrl={review.user?.avatar_url ?? null}\r\n                          className=\"size-6 border border-border bg-muted\"\r\n                          fallbackClassName=\"text-2xs bg-muted\"\r\n                        />\r\n                        <span className=\"font-medium text-foreground text-sm truncate\">{author}</span>\r\n                      </div>\r\n\r\n                      {review.comment ? (\r\n                        <p className=\"text-sm text-muted-foreground leading-relaxed whitespace-pre-line\">\r\n                          {review.comment}\r\n                        </p>\r\n                      ) : (\r\n                        <p className=\"text-sm text-muted-foreground\">{t(\"noWrittenComment\")}</p>\r\n                      )}\r\n                    </CardContent>\r\n                  </Card>\r\n                );\r\n              })}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </section>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\delivery-options.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\freshness-indicator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\hero-specs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\meta-row.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-card-actions.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-card-image.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-card-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-card-price.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-card-social-proof.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-card.tsx","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 9 times.","line":106,"column":17,"nodeType":"Literal","endLine":106,"endColumn":43},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 8 times.","line":118,"column":16,"nodeType":"Literal","endLine":118,"endColumn":80},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 45 to the 25 allowed.","line":247,"column":10,"nodeType":null,"messageId":"refactorFunction","endLine":247,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport * as React from \"react\"\nimport { Link } from \"@/i18n/routing\"\nimport { useLocale, useTranslations } from \"next-intl\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Badge } from \"@/components/ui/badge\"\nimport { Surface } from \"@/components/ui/surface\"\nimport { Lightning } from \"@phosphor-icons/react\"\nimport { useDrawer, type QuickViewProduct } from \"@/components/providers/drawer-context\"\nimport { isBoostActiveNow } from \"@/lib/boost/boost-status\"\nimport { shouldShowConditionBadge } from \"@/lib/badges/category-badge-specs\"\nimport { getListingOverlayBadgeVariants } from \"@/lib/ui/badge-intent\"\n\nimport { ProductCardActions } from \"./product-card-actions\"\nimport { ProductCardImage } from \"./product-card-image\"\nimport { ProductCardPrice } from \"./product-card-price\"\nimport { ProductCardSocialProof } from \"./product-card-social-proof\"\nimport { FreshnessIndicator } from \"./freshness-indicator\"\nimport { VerifiedSellerBadge } from \"./verified-seller-badge\"\nimport { getConditionKey } from \"./_lib/condition\"\nimport { resolveMobileTrustSignal } from \"./_lib/mobile-card-rules\"\nimport type { ProductCardData, ProductCardViewConfig } from \"./product-card.types\"\n\n// =============================================================================\n// CVA VARIANTS\n// =============================================================================\n\nconst productCardVariants = cva(\n  \"tap-highlight tap-transparent group relative flex h-full min-w-0 cursor-pointer flex-col\",\n  {\n    variants: {\n      variant: {\n        default: \"\",\n        featured: \"\",\n      },\n      state: {\n        default: \"\",\n        promoted: \"\",\n        sale: \"\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      state: \"default\",\n    },\n  }\n)\n\ntype ProductCardPresetKey =\n  `${NonNullable<ProductCardViewConfig[\"uiVariant\"]>}:${NonNullable<ProductCardViewConfig[\"appearance\"]>}:${NonNullable<ProductCardViewConfig[\"density\"]>}`\n\ninterface ProductCardPreset {\n  surfaceVariant: \"card\" | \"tile\"\n  surfaceInteractive: boolean\n  showImageDivider: boolean\n  bodyClass: string\n  titleClass: string\n  metaClass: string\n  priceEmphasis: \"default\" | \"strong\"\n  pricePresentation: \"default\" | \"soft-strip\"\n  discountAsBadge: boolean\n}\n\nconst PRODUCT_CARD_PRESETS: Record<ProductCardPresetKey, ProductCardPreset> = {\n  \"default:card:default\": {\n    surfaceVariant: \"card\",\n    surfaceInteractive: true,\n    showImageDivider: true,\n    bodyClass: \"space-y-1.5 p-2.5 pt-2.5\",\n    titleClass: \"text-sm font-semibold\",\n    metaClass: \"mt-1 flex min-w-0 items-center gap-1.5 text-tiny text-muted-foreground\",\n    priceEmphasis: \"default\",\n    pricePresentation: \"default\",\n    discountAsBadge: false,\n  },\n  \"default:card:compact\": {\n    surfaceVariant: \"card\",\n    surfaceInteractive: true,\n    showImageDivider: true,\n    bodyClass: \"space-y-1.5 p-2.5 pt-2.5\",\n    titleClass: \"text-compact font-semibold\",\n    metaClass: \"mt-1 flex min-w-0 items-center gap-1.5 text-tiny text-muted-foreground\",\n    priceEmphasis: \"default\",\n    pricePresentation: \"default\",\n    discountAsBadge: false,\n  },\n  \"default:tile:default\": {\n    surfaceVariant: \"tile\",\n    surfaceInteractive: false,\n    showImageDivider: false,\n    bodyClass: \"space-y-1 px-1.5 pb-2 pt-2\",\n    titleClass: \"text-sm font-medium\",\n    metaClass: \"mt-1 flex min-w-0 items-center gap-1 text-2xs text-muted-foreground\",\n    priceEmphasis: \"default\",\n    pricePresentation: \"default\",\n    discountAsBadge: false,\n  },\n  \"default:tile:compact\": {\n    surfaceVariant: \"tile\",\n    surfaceInteractive: false,\n    showImageDivider: false,\n    bodyClass: \"space-y-1 px-1.5 pb-2 pt-2\",\n    titleClass: \"text-compact font-medium\",\n    metaClass: \"mt-1 flex min-w-0 items-center gap-1 text-2xs text-muted-foreground\",\n    priceEmphasis: \"default\",\n    pricePresentation: \"default\",\n    discountAsBadge: false,\n  },\n  \"home:card:default\": {\n    surfaceVariant: \"tile\",\n    surfaceInteractive: false,\n    showImageDivider: false,\n    bodyClass: \"flex flex-col gap-1.5 px-1 pt-2 pb-1\",\n    titleClass: \"text-compact font-medium\",\n    metaClass: \"flex min-w-0 items-center gap-1 text-2xs text-muted-foreground\",\n    priceEmphasis: \"strong\",\n    pricePresentation: \"soft-strip\",\n    discountAsBadge: false,\n  },\n  \"home:card:compact\": {\n    surfaceVariant: \"tile\",\n    surfaceInteractive: false,\n    showImageDivider: false,\n    bodyClass: \"flex flex-col gap-1.5 px-1 pt-2 pb-1\",\n    titleClass: \"text-compact font-medium\",\n    metaClass: \"flex min-w-0 items-center gap-1 text-2xs text-muted-foreground\",\n    priceEmphasis: \"strong\",\n    pricePresentation: \"soft-strip\",\n    discountAsBadge: false,\n  },\n  \"home:tile:default\": {\n    surfaceVariant: \"tile\",\n    surfaceInteractive: false,\n    showImageDivider: false,\n    bodyClass: \"flex flex-col gap-1.5 px-1 pt-2 pb-1\",\n    titleClass: \"text-compact font-medium\",\n    metaClass: \"flex min-w-0 items-center gap-1 text-2xs text-muted-foreground\",\n    priceEmphasis: \"strong\",\n    pricePresentation: \"soft-strip\",\n    discountAsBadge: false,\n  },\n  \"home:tile:compact\": {\n    surfaceVariant: \"tile\",\n    surfaceInteractive: false,\n    showImageDivider: false,\n    bodyClass: \"flex flex-col gap-1.5 px-1 pt-2 pb-1\",\n    titleClass: \"text-compact font-medium\",\n    metaClass: \"flex min-w-0 items-center gap-1 text-2xs text-muted-foreground\",\n    priceEmphasis: \"strong\",\n    pricePresentation: \"soft-strip\",\n    discountAsBadge: false,\n  },\n  \"mobile-clean:card:default\": {\n    surfaceVariant: \"tile\",\n    surfaceInteractive: false,\n    showImageDivider: false,\n    bodyClass: \"flex flex-col gap-1 px-1 pt-1.5 pb-1\",\n    titleClass: \"text-compact font-medium\",\n    metaClass: \"flex min-w-0 items-center gap-1 text-2xs text-muted-foreground\",\n    priceEmphasis: \"strong\",\n    pricePresentation: \"default\",\n    discountAsBadge: false,\n  },\n  \"mobile-clean:card:compact\": {\n    surfaceVariant: \"tile\",\n    surfaceInteractive: false,\n    showImageDivider: false,\n    bodyClass: \"flex flex-col gap-1 px-1 pt-1.5 pb-1\",\n    titleClass: \"text-compact font-medium\",\n    metaClass: \"flex min-w-0 items-center gap-1 text-2xs text-muted-foreground\",\n    priceEmphasis: \"strong\",\n    pricePresentation: \"default\",\n    discountAsBadge: false,\n  },\n  \"mobile-clean:tile:default\": {\n    surfaceVariant: \"tile\",\n    surfaceInteractive: false,\n    showImageDivider: false,\n    bodyClass: \"flex flex-col gap-1 px-1 pt-1.5 pb-1\",\n    titleClass: \"text-compact font-medium\",\n    metaClass: \"flex min-w-0 items-center gap-1 text-2xs text-muted-foreground\",\n    priceEmphasis: \"strong\",\n    pricePresentation: \"default\",\n    discountAsBadge: false,\n  },\n  \"mobile-clean:tile:compact\": {\n    surfaceVariant: \"tile\",\n    surfaceInteractive: false,\n    showImageDivider: false,\n    bodyClass: \"flex flex-col gap-1 px-1 pt-1.5 pb-1\",\n    titleClass: \"text-compact font-medium\",\n    metaClass: \"flex min-w-0 items-center gap-1 text-2xs text-muted-foreground\",\n    priceEmphasis: \"strong\",\n    pricePresentation: \"default\",\n    discountAsBadge: false,\n  },\n}\n\n// =============================================================================\n// TYPES - Essential props + B2B support\n// =============================================================================\n\ninterface ProductCardProps\n  extends ProductCardData,\n    ProductCardViewConfig,\n    VariantProps<typeof productCardVariants> {\n  // NOTE: ProductCardData + ProductCardViewConfig are the preferred input contracts.\n  // ProductCardProps remains as a compatibility superset during incremental migration.\n  // Context\n  index?: number\n  currentUserId?: string | null\n  className?: string\n\n  // Rating & social proof (Pro Commerce style)\n  showBuyerProtection?: boolean\n\n  // B2B specific\n  minOrderQuantity?: number\n  bulkPricing?: { qty: number; price: number }[]\n  businessVerified?: boolean\n  samplesAvailable?: boolean\n\n  // Legacy props (accepted but ignored for backwards compat)\n  brand?: string\n  tags?: string[]\n  location?: string\n  categorySlug?: string\n  make?: string | null\n  model?: string | null\n  year?: string | number | null\n  color?: string | null\n  size?: string | null\n  sellerRating?: number\n  sellerTier?: \"basic\" | \"premium\" | \"business\"\n  initialIsFollowingSeller?: boolean\n  saleEndDate?: string | null\n  showRating?: boolean\n}\n\n// =============================================================================\n// PRODUCT CARD COMPONENT - Pro Commerce: Temu Density + eBay Trust + Shein Polish\n// =============================================================================\n\nfunction ProductCard({\n  id,\n  title,\n  price,\n  image,\n  images,\n  description,\n  originalPrice,\n  isOnSale,\n  salePercent,\n  createdAt,\n  categoryPath,\n  categoryRootSlug,\n  sellerId,\n  sellerName,\n  sellerAvatarUrl,\n  sellerVerified,\n  freeShipping = false,\n  slug,\n  username,\n  variant = \"default\",\n  state,\n  showWishlist = true,\n  showCategoryBadge = true,\n  disableQuickView = false,\n  appearance = \"card\",\n  media = \"square\",\n  density = \"default\",\n  titleLines = 1,\n  uiVariant = \"default\",\n  radius = \"xl\",\n  maxOverlayBadges,\n  index = 0,\n  currentUserId,\n  inStock = true,\n  className,\n  ref,\n  rating,\n  reviews,\n  soldCount,\n  condition,\n  location,\n  categorySlug,\n  // Promotion\n  isBoosted,\n  boostExpiresAt,\n}: ProductCardProps & { ref?: React.Ref<HTMLDivElement> }) {\n  const t = useTranslations(\"Product\")\n  const locale = useLocale()\n  const { openProductQuickView, enabledDrawers, isDrawerSystemEnabled } = useDrawer()\n  const isQuickViewEnabled = isDrawerSystemEnabled && enabledDrawers.productQuickView\n\n  const isCompact = density === \"compact\"\n  const isTile = appearance === \"tile\"\n  const isLegacyHomeUi = uiVariant === \"home\"\n  const isMobileCleanUi = uiVariant === \"mobile-clean\" || isLegacyHomeUi\n  const mediaRatio = media === \"landscape\" ? 4 / 3 : media === \"square\" ? 1 : 4 / 5\n  const radiusClass = radius === \"2xl\" ? \"rounded-2xl\" : \"rounded-xl\"\n  const actionSize = \"icon-compact\"\n  const radiusTopClass = radius === \"2xl\" ? \"rounded-t-2xl\" : \"rounded-t-xl\"\n  const presetKey = `${uiVariant}:${appearance}:${density}` as ProductCardPresetKey\n  const visualPreset = PRODUCT_CARD_PRESETS[presetKey] ?? PRODUCT_CARD_PRESETS[\"default:card:default\"]\n\n  // Derived values\n  const hasDiscount = originalPrice && originalPrice > price\n  const discountPercent = hasDiscount\n    ? Math.round(((originalPrice - price) / originalPrice) * 100)\n    : (salePercent ?? 0)\n\n  const hasRating = typeof rating === \"number\" && rating > 0\n  const showRating = hasRating\n  const hasSoldCount = typeof soldCount === \"number\" && soldCount > 0\n  const mobileTrustSignal = isMobileCleanUi\n    ? resolveMobileTrustSignal({ rating, reviews })\n    : null\n  const showMobileRatingSignal = mobileTrustSignal === \"rating\"\n  const hasSocialProof = isMobileCleanUi\n    ? showMobileRatingSignal\n    : (showRating || hasSoldCount)\n\n  const shouldShowCondition =\n    condition != null &&\n    (categorySlug || categoryRootSlug\n      ? shouldShowConditionBadge(categorySlug ?? null, categoryRootSlug ?? null)\n      : true)\n\n  const conditionLabel = React.useMemo(() => {\n    if (!condition || !shouldShowCondition) return null\n    const key = getConditionKey(condition)\n    if (key) return t(key)\n    return condition\n  }, [condition, shouldShowCondition, t])\n\n  const locationLabel = React.useMemo(() => location?.trim() || null, [location])\n  const hasFreshness = !!createdAt\n  const showFreshness = hasFreshness && !isMobileCleanUi\n  const showMobileFreshness = hasFreshness\n\n  const rootCategoryBadge = React.useMemo(() => {\n    const root = categoryPath?.[0]\n    if (!root) return null\n    return {\n      slug: root.slug,\n      name: root.name,\n      name_bg: root.nameBg ?? null,\n      icon: root.icon ?? null,\n    }\n  }, [categoryPath])\n\n  const rootCategoryLabel = React.useMemo(() => {\n    if (!rootCategoryBadge) return null\n    return locale === \"bg\" && rootCategoryBadge.name_bg\n      ? rootCategoryBadge.name_bg\n      : rootCategoryBadge.name\n  }, [locale, rootCategoryBadge])\n\n  // Resolve state\n  const resolvedState = state ?? (isOnSale || hasDiscount ? \"sale\" : \"default\")\n\n  const isBoostedActive = React.useMemo(() => {\n    if (!isBoosted) return false\n    if (!boostExpiresAt) return true\n    return isBoostActiveNow({ is_boosted: true, boost_expires_at: boostExpiresAt })\n  }, [boostExpiresAt, isBoosted])\n\n  const overlayBadgeVariants = React.useMemo(\n    () =>\n      getListingOverlayBadgeVariants({\n        isPromoted: isBoostedActive,\n        discountPercent,\n        minDiscountPercent: 5,\n      }),\n    [discountPercent, isBoostedActive]\n  )\n  const resolvedMaxOverlayBadges = Math.max(\n    0,\n    maxOverlayBadges ?? 2\n  )\n  const visibleOverlayBadgeVariants = React.useMemo(\n    () =>\n      overlayBadgeVariants\n        .slice(0, resolvedMaxOverlayBadges)\n        .filter((variant) => !(isMobileCleanUi && variant === \"discount\")),\n    [isMobileCleanUi, overlayBadgeVariants, resolvedMaxOverlayBadges]\n  )\n  const showVerifiedInMeta = sellerVerified && !isMobileCleanUi\n  const showMobileVerifiedInText = isMobileCleanUi && sellerVerified\n  const showMobileTopRow =\n    Boolean(showMobileFreshness || showMobileVerifiedInText) ||\n    Boolean(showCategoryBadge && rootCategoryLabel)\n  const hasTrustSignals = Boolean(freeShipping || showVerifiedInMeta)\n  const hasInfoMeta =\n    isMobileCleanUi\n      ? false\n      : Boolean(conditionLabel || locationLabel || hasTrustSignals)\n  const showInlineDiscount = false\n\n  // URLs\n  const productUrl = username ? `/${username}/${slug || id}` : \"#\"\n  const shouldUseDrawerQuickView = isQuickViewEnabled && !disableQuickView\n\n  // Check if own product\n  const isOwnProduct = !!(currentUserId && sellerId && currentUserId === sellerId)\n\n  // Quick view handler (no URL change)\n  // - Standard click: open quick view overlay\n  // - Modified click: keep normal link behavior\n  const handleCardClick = React.useCallback(\n    (e: React.MouseEvent) => {\n      if (!shouldUseDrawerQuickView) return\n\n      // Allow expected link behaviors (new tab/window, copy link, etc.)\n      if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return\n\n      e.preventDefault()\n      // Build quick view data, only including defined properties\n      // (exactOptionalPropertyTypes requires this pattern)\n      const quickViewData: QuickViewProduct = {\n        id,\n        title,\n        price,\n        image,\n        ...(typeof window !== \"undefined\" ? { sourceScrollY: window.scrollY } : {}),\n        ...(images ? { images } : {}),\n        ...(originalPrice != null ? { originalPrice } : {}),\n        ...(description != null ? { description } : {}),\n        ...(categoryPath ? { categoryPath } : {}),\n        ...(condition != null ? { condition } : {}),\n        ...(location != null ? { location } : {}),\n        ...(freeShipping !== undefined ? { freeShipping } : {}),\n        ...(rating !== undefined ? { rating } : {}),\n        ...(reviews !== undefined ? { reviews } : {}),\n        ...(inStock !== undefined ? { inStock } : {}),\n        ...(slug != null ? { slug } : {}),\n        ...(username != null ? { username } : {}),\n        ...(sellerId != null ? { sellerId } : {}),\n        ...(sellerName != null ? { sellerName } : {}),\n        ...(sellerAvatarUrl != null ? { sellerAvatarUrl } : {}),\n        ...(sellerVerified !== undefined ? { sellerVerified } : {}),\n      }\n      openProductQuickView(quickViewData)\n    },\n    [\n      shouldUseDrawerQuickView,\n      id,\n      title,\n      price,\n      image,\n      images,\n      originalPrice,\n      description,\n      categoryPath,\n      condition,\n      location,\n      freeShipping,\n      rating,\n      reviews,\n      inStock,\n      slug,\n      username,\n      sellerId,\n      sellerName,\n      sellerAvatarUrl,\n      sellerVerified,\n      openProductQuickView,\n    ]\n  )\n\n  return (\n    <Surface\n      ref={ref}\n      variant={visualPreset.surfaceVariant}\n      interactive={visualPreset.surfaceInteractive}\n      className={cn(\n        productCardVariants({ variant, state: resolvedState }),\n        radiusClass,\n        className\n      )}\n    >\n      {/* Full-card link for accessibility */}\n      <Link\n        href={productUrl}\n        data-slot=\"product-card-link\"\n        className={cn(\n          \"absolute inset-0 z-10 outline-none focus-visible:ring-2 focus-visible:ring-focus-ring\",\n          radiusClass\n        )}\n        aria-label={t(\"openProduct\", { title })}\n        onClick={handleCardClick}\n      >\n        <span className=\"sr-only\">{title}</span>\n      </Link>\n\n      <div className=\"relative\">\n        <div\n          className={cn(\n            \"relative overflow-hidden bg-surface-subtle\",\n            visualPreset.surfaceVariant === \"card\" && !isTile\n              ? cn(radiusTopClass, \"rounded-b-none\")\n              : radiusClass,\n            visualPreset.showImageDivider && !isTile && \"border-b border-border-subtle\"\n          )}\n        >\n          <ProductCardImage\n            src={image}\n            alt={title}\n            index={index}\n            inStock={inStock}\n            outOfStockLabel={t(\"outOfStock\")}\n            ratio={mediaRatio}\n          />\n\n          {inStock && visibleOverlayBadgeVariants.length > 0 && (\n            <div className=\"absolute left-1.5 top-1.5 z-10 flex flex-col gap-1 pointer-events-none\">\n              {visibleOverlayBadgeVariants.map((variant) => {\n                if (variant === \"promoted\") {\n                  return (\n                    <span\n                      key=\"promoted\"\n                      className={cn(\n                        \"flex items-center justify-center rounded-full bg-promoted text-promoted-foreground shadow-sm\",\n                        isMobileCleanUi ? \"size-7\" : \"size-6\"\n                      )}\n                      role=\"img\"\n                      aria-label={t(\"adBadge\")}\n                    >\n                      <Lightning size={isMobileCleanUi ? 15 : 14} weight=\"fill\" />\n                    </span>\n                  )\n                }\n                return (\n                  <Badge key=\"discount\" size=\"compact\" variant=\"discount\">\n                    -{discountPercent}%\n                  </Badge>\n                )\n              })}\n            </div>\n          )}\n\n          {showWishlist && (\n            <div className=\"absolute right-1.5 top-1.5 z-20\">\n              <ProductCardActions\n                id={id}\n                title={title}\n                price={price}\n                image={image}\n                slug={slug ?? null}\n                username={username ?? null}\n                showQuickAdd={false}\n                showWishlist\n                inStock={inStock}\n                isOwnProduct={isOwnProduct}\n                size={actionSize}\n                overlayDensity={isMobileCleanUi ? \"compact\" : \"default\"}\n              />\n            </div>\n          )}\n        </div>\n      </div>\n\n      <div\n        className={cn(\n          visualPreset.bodyClass\n        )}\n      >\n        {isMobileCleanUi ? (\n          <>\n            {showMobileTopRow && (\n              <div className=\"flex min-w-0 items-center justify-between gap-2 text-2xs text-muted-foreground\">\n                <div className=\"flex min-w-0 items-center gap-1.5\">\n                  {showCategoryBadge && rootCategoryLabel && (\n                    <span className=\"truncate font-medium\">{rootCategoryLabel}</span>\n                  )}\n                  {showMobileVerifiedInText && (\n                    <VerifiedSellerBadge\n                      label={t(\"b2b.verifiedShort\")}\n                      variant=\"icon\"\n                      size=\"sm\"\n                      className=\"size-5 border-border-subtle bg-card text-primary\"\n                    />\n                  )}\n                </div>\n                {showMobileFreshness && (\n                  <FreshnessIndicator\n                    createdAt={createdAt}\n                    variant=\"text\"\n                    showIcon={false}\n                    className=\"shrink-0 text-2xs text-muted-foreground\"\n                  />\n                )}\n              </div>\n            )}\n\n            <h3\n              className={cn(\n                \"min-w-0 text-foreground leading-tight tracking-tight\",\n                titleLines === 1 ? \"truncate\" : \"line-clamp-2 break-words\",\n                visualPreset.titleClass\n              )}\n            >\n              {title}\n            </h3>\n\n            <div className=\"flex min-w-0 items-baseline justify-between gap-2\">\n              <div className=\"min-w-0 flex-1\">\n                <ProductCardPrice\n                  price={price}\n                  originalPrice={originalPrice}\n                  locale={locale}\n                  compact={isCompact}\n                  homeEmphasis={isMobileCleanUi}\n                  priceEmphasis={visualPreset.priceEmphasis}\n                  presentation={visualPreset.pricePresentation}\n                  showOriginalPrice={isMobileCleanUi ? false : !showInlineDiscount}\n                  discountAsBadge={visualPreset.discountAsBadge}\n                  {...(showInlineDiscount ? { trailingLabel: `-${discountPercent}%` } : {})}\n                />\n              </div>\n              {showMobileRatingSignal && (\n                <div className=\"shrink-0\">\n                  <ProductCardSocialProof\n                    rating={rating}\n                    reviews={reviews}\n                    soldLabel={t(\"sold\")}\n                  />\n                </div>\n              )}\n            </div>\n          </>\n        ) : (\n          <>\n            <h3\n              className={cn(\n                \"min-w-0 text-foreground leading-tight tracking-tight\",\n                titleLines === 1 ? \"truncate\" : \"line-clamp-2 break-words\",\n                visualPreset.titleClass\n              )}\n            >\n              {title}\n            </h3>\n\n            <ProductCardPrice\n              price={price}\n              originalPrice={originalPrice}\n              locale={locale}\n              compact={isCompact}\n              homeEmphasis={isMobileCleanUi}\n              priceEmphasis={visualPreset.priceEmphasis}\n              presentation={visualPreset.pricePresentation}\n              showOriginalPrice={isMobileCleanUi ? false : !showInlineDiscount}\n              discountAsBadge={visualPreset.discountAsBadge}\n              {...(showInlineDiscount ? { trailingLabel: `-${discountPercent}%` } : {})}\n            />\n          </>\n        )}\n\n        {!isMobileCleanUi && (\n          (hasSocialProof || showFreshness) && (\n            <div className={visualPreset.metaClass}>\n              {hasSocialProof && (\n                <ProductCardSocialProof\n                  rating={showRating ? rating : undefined}\n                  reviews={showRating ? reviews : undefined}\n                  soldCount={soldCount}\n                  soldLabel={t(\"sold\")}\n                />\n              )}\n              {hasSocialProof && showFreshness && <span aria-hidden=\"true\">┬╖</span>}\n              {showFreshness && (\n                <FreshnessIndicator\n                  createdAt={createdAt}\n                  variant=\"text\"\n                  showIcon={false}\n                  className=\"text-tiny text-muted-foreground\"\n                />\n              )}\n            </div>\n          )\n        )}\n \n        {hasInfoMeta && (\n          <div className=\"flex min-w-0 flex-wrap items-center gap-x-1.5 gap-y-0.5 text-tiny text-muted-foreground\">\n            {conditionLabel && <span className=\"shrink-0 font-medium\">{conditionLabel}</span>}\n            {conditionLabel && locationLabel && <span aria-hidden=\"true\" className=\"text-border\">┬╖</span>}\n            {locationLabel && <span className=\"min-w-0 truncate\">{locationLabel}</span>}\n            {(conditionLabel || locationLabel) && hasTrustSignals && <span aria-hidden=\"true\" className=\"text-border\">┬╖</span>}\n            {freeShipping && (\n              <span className=\"shrink-0 font-medium text-success\">{t(\"freeDeliveryShort\")}</span>\n            )}\n            {freeShipping && showVerifiedInMeta && <span aria-hidden=\"true\" className=\"text-border\">┬╖</span>}\n            {showVerifiedInMeta && (\n              <VerifiedSellerBadge\n                label={t(\"b2b.verifiedShort\")}\n                className=\"shrink-0\"\n              />\n            )}\n          </div>\n        )}\n      </div>\n    </Surface>\n  )\n}\n\n// =============================================================================\n// RE-EXPORTS FROM PRODUCT-GRID\n// =============================================================================\n\nexport {\n  ProductGrid,\n  ProductCardSkeleton,\n  ProductCardSkeletonGrid,\n  type ProductGridProps,\n  type ProductCardSkeletonProps,\n  type ProductCardSkeletonGridProps,\n} from \"./product-grid\"\n\n// =============================================================================\n// EXPORTS\n// =============================================================================\n\nexport { ProductCard, productCardVariants, type ProductCardProps }\nexport type { ProductCardData, ProductCardViewConfig } from \"./product-card.types\"\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-card.types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-description.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-feed.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TabData' is defined but never used.","line":14,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_locale' is defined but never used.","line":56,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":56,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useRef, useEffect } from \"react\"\r\nimport type { UIProduct } from \"@/lib/data/products\"\r\nimport { ProductCard, ProductCardSkeletonGrid, ProductGrid } from \"@/components/shared/product/product-card\"\r\nimport { EmptyStateCTA } from \"@/components/shared/empty-state-cta\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\n// =============================================================================\r\n// Types\r\n// =============================================================================\r\n\r\ninterface TabData {\r\n  products: UIProduct[]\r\n  page: number\r\n  hasMore: boolean\r\n}\r\n\r\nexport interface ProductFeedProps {\r\n  products: UIProduct[]\r\n  hasMore: boolean\r\n  isLoading: boolean\r\n  activeSlug: string\r\n  locale: string\r\n  isAllTab: boolean\r\n  activeCategoryName: string | null\r\n  onLoadMore: () => void\r\n  /** When true, shows loading overlay instead of replacing content (smoother category switching) */\r\n  showLoadingOverlay?: boolean\r\n}\r\n\r\n// =============================================================================\r\n// End of Results\r\n// =============================================================================\r\n\r\nfunction EndOfResults({ label }: { label: string }) {\r\n  return (\r\n    <div className=\"flex items-center justify-center gap-2 py-4 text-xs text-muted-foreground\">\r\n      <span className=\"h-px w-12 bg-border\" />\r\n      <span>{label}</span>\r\n      <span className=\"h-px w-12 bg-border\" />\r\n    </div>\r\n  )\r\n}\r\n\r\n// =============================================================================\r\n// Component\r\n// =============================================================================\r\n\r\nexport function ProductFeed({\r\n  products,\r\n  hasMore,\r\n  isLoading,\r\n  activeSlug,\r\n  locale: _locale,\r\n  isAllTab,\r\n  activeCategoryName,\r\n  onLoadMore,\r\n  showLoadingOverlay = false,\r\n}: ProductFeedProps) {\r\n  const loadMoreRef = useRef<HTMLDivElement>(null)\r\n  const tFeed = useTranslations(\"ProductFeed\")\r\n\r\n  const categoryAnnouncement = activeCategoryName\n    ? tFeed(\"categoryAnnouncement\", { categoryName: activeCategoryName })\n    : null\n\n  const loadingLabel = tFeed(\"loadingProducts\")\n  const showInlineRefreshSkeleton = showLoadingOverlay && isLoading && products.length > 0\n\r\n  // Intersection Observer for infinite scroll\r\n  // Only observe if we have products AND hasMore - avoid spam on empty categories\r\n  useEffect(() => {\r\n    // Don't set up observer if no products loaded yet (empty category)\r\n    if (products.length === 0) return\r\n\r\n    const observer = new IntersectionObserver(\r\n      (entries) => {\r\n        const firstEntry = entries.at(0)\r\n        if (firstEntry?.isIntersecting && hasMore && !isLoading) {\r\n          onLoadMore()\r\n        }\r\n      },\r\n      { rootMargin: \"200px\", threshold: 0.1 }\r\n    )\r\n\r\n    if (loadMoreRef.current) {\r\n      observer.observe(loadMoreRef.current)\r\n    }\r\n\r\n    return () => observer.disconnect()\r\n  }, [hasMore, isLoading, onLoadMore, products.length])\r\n\r\n  return (\r\n    <div className=\"pt-1\">\r\n      {/* Announce category changes for screen readers */}\r\n      <div role=\"status\" aria-live=\"polite\" className=\"sr-only\">\n        {categoryAnnouncement}\n      </div>\n\n      <div aria-busy={isLoading} aria-label={isLoading ? loadingLabel : undefined} className=\"relative\">\n      {products.length === 0 && !isLoading ? (\n        <EmptyStateCTA\n          variant={isAllTab ? \"no-listings\" : \"no-category\"}\n          {...(activeCategoryName ? { categoryName: activeCategoryName } : {})}\n        />\n      ) : isLoading && products.length === 0 ? (\r\n        <ProductCardSkeletonGrid\n          count={6}\n          density=\"compact\"\n          appearance=\"tile\"\n          media=\"portrait\"\n          className=\"py-1\"\n        />\n      ) : (\n        <>\n          <ProductGrid density=\"compact\" className={cn(\"py-1 transition-colors duration-200\")}>\n            {products.map((product, index) => (\n              <ProductCard\n                key={`${product.id}-${activeSlug}`}\n                id={product.id}\n                title={product.title}\n                price={product.price}\n                createdAt={product.createdAt ?? null}\n                originalPrice={product.listPrice ?? null}\n                image={product.image}\n                rating={product.rating}\n                reviews={product.reviews}\n                {...(product.freeShipping === true ? { freeShipping: true } : {})}\n                {...(product.isBoosted ? { isBoosted: true } : {})}\n                index={index}\n                slug={product.slug ?? null}\n                username={product.storeSlug ?? null}\n                sellerId={product.sellerId ?? null}\n                {...((product.sellerName || product.storeSlug)\n                  ? { sellerName: product.sellerName || product.storeSlug || \"\" }\n                  : {})}\n                sellerAvatarUrl={product.sellerAvatarUrl || null}\n                sellerTier={product.sellerTier ?? \"basic\"}\n                sellerVerified={Boolean(product.sellerVerified)}\n                sellerEmailVerified={Boolean(product.sellerEmailVerified)}\n                sellerPhoneVerified={Boolean(product.sellerPhoneVerified)}\n                sellerIdVerified={Boolean(product.sellerIdVerified)}\n                {...(product.condition ? { condition: product.condition } : {})}\n                {...(product.brand ? { brand: product.brand } : {})}\n                {...(product.categorySlug ? { categorySlug: product.categorySlug } : {})}\n                {...(product.categoryRootSlug ? { categoryRootSlug: product.categoryRootSlug } : {})}\n                {...(product.categoryPath ? { categoryPath: product.categoryPath } : {})}\n                {...(product.make ? { make: product.make } : {})}\n                {...(product.model ? { model: product.model } : {})}\n                {...(product.year ? { year: product.year } : {})}\n                {...(product.location ? { location: product.location } : {})}\n                {...(product.attributes ? { attributes: product.attributes } : {})}\n                appearance=\"tile\"\n                media=\"landscape\"\n                density=\"compact\"\n                uiVariant=\"mobile-clean\"\n              />\n            ))}\n          </ProductGrid>\n\n          {showInlineRefreshSkeleton && (\n            <ProductCardSkeletonGrid\n              count={2}\n              density=\"compact\"\n              appearance=\"tile\"\n              media=\"portrait\"\n              className=\"py-1\"\n            />\n          )}\n        </>\n      )}\n\n      </div>\n\r\n      <div ref={loadMoreRef} className=\"py-3\">\r\n        {isLoading && products.length > 0 && (\r\n          <ProductCardSkeletonGrid\n            count={4}\n            density=\"compact\"\n            appearance=\"tile\"\n            media=\"portrait\"\n            className=\"py-1\"\n          />\n        )}\r\n        {!hasMore && products.length > 0 && (\r\n          <EndOfResults label={tFeed(\"endOfResults\", { count: products.length })} />\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-grid-skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-grid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-header-sync.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-page-layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-price.tsx","messages":[{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":57,"column":83,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":57,"endColumn":112},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'InlinePrice' is defined but never used.","line":111,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":111,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { cn } from '@/lib/utils'\r\nimport { formatPrice, formatPriceParts } from '@/lib/currency'\r\n\r\ninterface ProductPriceProps {\r\n  price: number\r\n  originalPrice?: number\r\n  locale: string\r\n  size?: 'sm' | 'md' | 'lg'\r\n  className?: string\r\n  showAccessibleLabel?: boolean\r\n  showVat?: boolean\r\n}\r\n\r\nconst sizeClasses = {\r\n  sm: {\r\n    symbol: 'text-xs',\r\n    whole: 'text-lg',\r\n    decimal: 'text-xs',\r\n    original: 'text-xs'\r\n  },\r\n  md: {\r\n    symbol: 'text-sm',\r\n    whole: 'text-2xl sm:text-3xl',\r\n    decimal: 'text-sm',\r\n    original: 'text-sm'\r\n  },\r\n  lg: {\r\n    symbol: 'text-base',\r\n    whole: 'text-3xl sm:text-4xl',\r\n    decimal: 'text-base',\r\n    original: 'text-base'\r\n  }\r\n}\r\n\r\nexport function ProductPrice({\r\n  price,\r\n  originalPrice,\r\n  locale,\r\n  size = 'md',\r\n  className,\r\n  showAccessibleLabel = true,\r\n  showVat = true\r\n}: ProductPriceProps) {\r\n  const hasDiscount = originalPrice && originalPrice > price\r\n  const priceParts = formatPriceParts(price, locale)\r\n  const classes = sizeClasses[size]\r\n  \r\n  // Accessible label for screen readers\r\n  const accessiblePrice = formatPrice(price, locale)\r\n  const accessibleOriginal = originalPrice ? formatPrice(originalPrice, locale) : null\r\n  \r\n  const vatLabel = locale === 'bg' ? '╤ü ╨ö╨ö╨í' : 'incl. VAT'\r\n  \r\n  return (\r\n    <div \r\n      className={cn(\"flex items-baseline gap-2\", className)}\r\n      aria-label={showAccessibleLabel ? `Price: ${accessiblePrice}${hasDiscount ? `, was ${accessibleOriginal}` : ''}` : undefined}\r\n    >\r\n      <span className={cn(\r\n        \"flex items-baseline gap-0.5 tabular-nums\",\r\n        hasDiscount ? \"text-price-sale\" : \"text-price-regular\"\r\n      )}>\r\n        {priceParts.symbolPosition === 'before' && (\r\n          <span \r\n            className={cn(classes.symbol, \"align-top font-medium relative top-1\")}\r\n            aria-hidden=\"true\"\r\n          >\r\n            {priceParts.symbol}\r\n          </span>\r\n        )}\r\n        <span \r\n          className={cn(classes.whole, \"font-medium\")}\r\n          aria-hidden=\"true\"\r\n        >\r\n          {priceParts.wholePart}\r\n        </span>\r\n        <span \r\n          className={cn(classes.decimal, \"align-top font-medium relative top-1\")}\r\n          aria-hidden=\"true\"\r\n        >\r\n          {locale === 'bg' ? ',' : '.'}{priceParts.decimalPart}\r\n        </span>\r\n        {priceParts.symbolPosition === 'after' && (\r\n          <span \r\n            className={cn(classes.symbol, \"align-top font-medium relative top-1 ml-1\")}\r\n            aria-hidden=\"true\"\r\n          >\r\n            {priceParts.symbol}\r\n          </span>\r\n        )}\r\n        {showVat && (\r\n          <span className=\"text-xs text-muted-foreground font-normal ml-1\">\r\n            {vatLabel}\r\n          </span>\r\n        )}\r\n      </span>\r\n      \r\n      {hasDiscount && originalPrice && (\r\n        <span \r\n          className={cn(\"text-price-original line-through tabular-nums\", classes.original)}\r\n          aria-hidden=\"true\"\r\n        >\r\n          {formatPrice(originalPrice, locale)}\r\n        </span>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\n// Simple inline price for Buy Box etc\r\nfunction InlinePrice({\r\n  price,\r\n  locale,\r\n  className\r\n}: {\r\n  price: number\r\n  locale: string\r\n  className?: string\r\n}) {\r\n  return (\r\n    <span className={cn(\"text-price-regular font-medium tabular-nums\", className)}>\r\n      {formatPrice(price, locale)}\r\n    </span>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\product-social-proof.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\quick-view\\product-quick-view-content.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\quick-view\\quick-view-image-gallery.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\quick-view\\quick-view-seller-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\quick-view\\quick-view-skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\recently-viewed-tracker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\seller-products-grid.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalCount' is defined but never used.","line":47,"column":48,"nodeType":"Identifier","messageId":"unusedVar","endLine":47,"endColumn":58}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useRef } from \"react\";\r\nimport { useLocale, useTranslations } from \"next-intl\";\r\nimport Image from \"next/image\";\r\nimport { Link } from \"@/i18n/routing\";\r\n\r\ninterface SellerProductItem {\r\n  id: string;\r\n  title: string;\r\n  price: number;\r\n  originalPrice: number | null;\r\n  image: string;\r\n  rating: number;\r\n  reviews: number;\r\n  sellerName: string;\r\n  sellerVerified: boolean;\r\n  sellerAvatarUrl: string;\r\n  condition: string;\r\n  freeShipping: boolean;\r\n  categorySlug: string;\r\n  attributes: Record<string, string>;\r\n  storeSlug?: string | null;\r\n  slug?: string | null;\r\n}\r\n\r\ninterface SellerProductsGridProps {\r\n  products: SellerProductItem[];\r\n  totalCount?: number;\r\n  sellerUsername?: string;\r\n}\r\n\r\n/**\r\n * SellerProductsGrid - \"More from Seller\" horizontal scroll section\r\n * \r\n * OLX/Treido reference design:\r\n * ```\r\n * ╨₧╤ë╨╡ ╨╛╤é ╨ÿ╨▓╨░╨╜                    [╨Æ╨╕╨╢ ╨▓╤ü╨╕╤ç╨║╨╕]\r\n * ΓöîΓöÇΓöÇΓöÇΓöÇΓöÉ ΓöîΓöÇΓöÇΓöÇΓöÇΓöÉ ΓöîΓöÇΓöÇΓöÇΓöÇΓöÉ ΓöîΓöÇΓöÇΓöÇΓöÇΓöÉ\r\n * Γöé    Γöé Γöé    Γöé Γöé    Γöé Γöé    Γöé  ΓåÉ Horizontal scroll\r\n * ΓööΓöÇΓöÇΓöÇΓöÇΓöÿ ΓööΓöÇΓöÇΓöÇΓöÇΓöÿ ΓööΓöÇΓöÇΓöÇΓöÇΓöÿ ΓööΓöÇΓöÇΓöÇΓöÇΓöÿ\r\n * ```\r\n * \r\n * Mobile: Pure swipe (no chevron buttons)\r\n * Desktop: Chevron navigation buttons\r\n */\r\nexport function SellerProductsGrid({ products, totalCount, sellerUsername }: SellerProductsGridProps) {\r\n  const t = useTranslations(\"Product\");\r\n  const tCommon = useTranslations(\"Common\");\r\n  const locale = useLocale();\r\n  const scrollRef = useRef<HTMLDivElement>(null);\r\n\r\n  const getProductHref = (product: SellerProductItem) => {\r\n    const resolvedSellerSlug = product.storeSlug || sellerUsername;\r\n    const resolvedProductSlug = product.slug || product.id;\r\n\r\n    // Canonical product URL format: /{username}/{productSlug}\r\n    // If slug is missing, fall back to /{username}/{id} and let the server resolve by id.\r\n    return resolvedSellerSlug ? `/${resolvedSellerSlug}/${resolvedProductSlug}` : \"#\";\r\n  };\r\n\r\n  const hasProducts = Array.isArray(products) && products.length > 0;\r\n\r\n  const viewAllHref = sellerUsername ? `/${sellerUsername}` : undefined;\r\n  \r\n  const viewAllText = tCommon(\"viewAll\");\r\n  \r\n  // Seller name for header - extract first name for treido-mock style \"More from Ivan\"\r\n  const sellerFirstName = products[0]?.sellerName?.split(\" \")[0] || \"\";\r\n\r\n  if (!hasProducts) return null;\r\n\r\n  return (\r\n    <div className=\"py-4 bg-surface-subtle\">\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between px-4 mb-3\">\r\n        <h3 className=\"text-sm font-bold text-foreground\">\r\n          {sellerFirstName ? t(\"moreFromSellerName\", { name: sellerFirstName }) : t(\"moreFromSeller\")}\r\n        </h3>\r\n        {viewAllHref && (\r\n          <Link \r\n            href={viewAllHref}\r\n            className=\"text-xs font-medium text-muted-foreground hover:text-foreground transition-colors\"\r\n          >\r\n            {viewAllText}\r\n          </Link>\r\n        )}\r\n      </div>\r\n      \r\n      {/* Horizontal scroll cards */}\r\n      <div \r\n        ref={scrollRef}\r\n        className=\"flex overflow-x-auto scrollbar-hide scroll-smooth px-4 gap-2.5\"\r\n      >\r\n        {products.slice(0, 10).map((product) => (\r\n          <Link\r\n            key={product.id}\r\n            href={getProductHref(product)}\r\n            className=\"w-32 flex-shrink-0 bg-background rounded border border-border overflow-hidden\"\r\n          >\r\n            {/* Image */}\r\n            <div className=\"aspect-square bg-muted relative\">\r\n              {product.image && (\r\n                <Image\r\n                  src={product.image}\r\n                  alt={product.title}\r\n                  fill\r\n                  className=\"object-cover\"\r\n                  sizes=\"130px\"\r\n                  loading=\"lazy\"\r\n                />\r\n              )}\r\n            </div>\r\n            {/* Content - treido-mock: p-2 with price bold + title muted */}\r\n            <div className=\"p-2\">\r\n              <p className=\"font-bold text-foreground text-sm\">\r\n                {new Intl.NumberFormat(locale === \"bg\" ? \"bg-BG\" : \"en-IE\", {\r\n                  style: \"currency\",\r\n                  currency: \"EUR\",\r\n                  minimumFractionDigits: 0,\r\n                  maximumFractionDigits: 0,\r\n                }).format(product.price)}\r\n              </p>\r\n              <p className=\"text-tiny text-muted-foreground truncate mt-0.5\">\r\n                {product.title}\r\n              </p>\r\n            </div>\r\n          </Link>\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\seller-verification-badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\shipping-returns-info.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\similar-items-grid.tsx","messages":[],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":73,"column":19,"nodeType":"JSXOpeningElement","endLine":77,"endColumn":21,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\specifications-list.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\trust-badges.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'verifiedSeller' is assigned a value but never used.","line":7,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":7,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useTranslations } from \"next-intl\"\r\nimport { RotateCcw, ShieldCheck, Truck } from \"lucide-react\"\r\n\r\nimport { Card, CardContent } from \"@/components/ui/card\"\r\n\r\nexport function TrustBadges(props: { verifiedSeller?: boolean }) {\n  const { verifiedSeller } = props\n  const t = useTranslations(\"Product\")\n\n  return (\n    <Card className=\"border border-border-subtle\">\n      <CardContent className=\"p-3\">\n        <div className=\"grid grid-cols-1 gap-3\">\n          <div className=\"flex items-start gap-3\">\n            <div className=\"mt-0.5 rounded-xl bg-surface-subtle p-2\">\n              <ShieldCheck className=\"h-4 w-4 text-foreground\" />\n            </div>\n            <div>\n              <div className=\"text-sm font-semibold text-foreground\">\n                {t(\"buyerProtectionBadgeTitle\")}\r\n              </div>\r\n              <div className=\"text-xs text-muted-foreground mt-0.5\">{t(\"buyerProtectionBadgeSubtitle\")}</div>\r\n            </div>\r\n          </div>\r\n\n          <div className=\"flex items-start gap-3\">\n            <div className=\"mt-0.5 rounded-xl bg-surface-subtle p-2\">\n              <Truck className=\"h-4 w-4 text-foreground\" />\n            </div>\n            <div>\n              <div className=\"text-sm font-semibold text-foreground\">{t(\"freeShipping\")}</div>\n              <div className=\"text-xs text-muted-foreground mt-0.5\">{t(\"freeShippingSubtitle\")}</div>\r\n            </div>\r\n          </div>\r\n\n          <div className=\"flex items-start gap-3\">\n            <div className=\"mt-0.5 rounded-xl bg-surface-subtle p-2\">\n              <RotateCcw className=\"h-4 w-4 text-foreground\" />\n            </div>\n            <div>\n              <div className=\"text-sm font-semibold text-foreground\">{t(\"returnsTitle\")}</div>\n              <div className=\"text-xs text-muted-foreground mt-0.5\">{t(\"returnsSubtitle\")}</div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\verified-seller-badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\view-tracker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\product\\write-review-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'locale' is assigned a value but never used.","line":58,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":58,"endColumn":9}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useTransition } from \"react\";\r\nimport { Star } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport { useTranslations } from \"next-intl\";\r\nimport { usePathname, useRouter } from \"@/i18n/routing\"\r\n\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogFooter,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Label } from \"@/components/ui/label\";\r\n\r\nfunction stripLocalePrefix(pathname: string): string {\r\n  const segments = pathname.split(\"/\").filter(Boolean)\r\n  const maybeLocale = segments[0]\r\n  if (maybeLocale && /^[a-z]{2}(-[A-Z]{2})?$/i.test(maybeLocale)) {\r\n    segments.shift()\r\n  }\r\n  const normalized = `/${segments.join(\"/\")}`\r\n  return normalized === \"/\" ? \"/\" : normalized.replace(/\\/+$/, \"\")\r\n}\r\n\r\n// Type for the review submission result\r\nexport interface ReviewResult {\r\n  success: boolean;\r\n  error?: string;\r\n}\r\n\r\n// Type for the submit function (allows dependency injection)\r\nexport type SubmitReviewFn = (input: {\r\n  productId: string;\r\n  rating: number;\r\n  comment?: string;\r\n}) => Promise<ReviewResult>;\r\n\r\ninterface WriteReviewDialogProps {\r\n  productId: string;\r\n  productTitle?: string;\r\n  locale?: string;\r\n  onReviewSubmitted?: () => void;\r\n  trigger?: React.ReactNode;\r\n  /** Server action to submit review - must be passed from route-level component */\r\n  submitReview: SubmitReviewFn;\r\n}\r\n\r\nexport function WriteReviewDialog({\r\n  productId,\r\n  productTitle,\r\n  locale = \"en\",\r\n  onReviewSubmitted,\r\n  trigger,\r\n  submitReview,\r\n}: WriteReviewDialogProps) {\r\n  const router = useRouter()\r\n  const pathname = usePathname()\r\n  const [open, setOpen] = useState(false);\r\n  const [rating, setRating] = useState(0);\r\n  const [hoverRating, setHoverRating] = useState(0);\r\n  const [comment, setComment] = useState(\"\");\r\n  const [isPending, startTransition] = useTransition();\r\n\r\n  const tReviews = useTranslations(\"Reviews\");\r\n  const tAuth = useTranslations(\"Auth\");\r\n  const activeRating = hoverRating || rating;\r\n\r\n  const handleSubmit = () => {\r\n    if (rating === 0) {\r\n      toast.error(tReviews(\"selectRating\"));\r\n      return;\r\n    }\r\n\r\n    startTransition(async () => {\r\n      const trimmedComment = comment.trim()\r\n      const result = await submitReview({\r\n        productId,\r\n        rating,\r\n        ...(trimmedComment ? { comment: trimmedComment } : {}),\r\n      });\r\n\r\n      if (result.success) {\r\n        toast.success(tReviews(\"reviewSuccess\"));\r\n        setOpen(false);\r\n        setRating(0);\r\n        setComment(\"\");\r\n        onReviewSubmitted?.();\r\n      } else {\r\n        if (result.error?.includes(\"logged in\")) {\r\n          const next = stripLocalePrefix(pathname)\r\n          toast.error(tReviews(\"signInRequired\"), {\r\n            action: {\r\n              label: tAuth(\"signIn\"),\r\n              onClick: () => {\r\n                router.push({ pathname: \"/auth/login\", query: { next } })\r\n              },\r\n            },\r\n          });\r\n        } else {\r\n          toast.error(result.error || tReviews(\"reviewFailed\"));\r\n        }\r\n      }\r\n    });\r\n  };\r\n\r\n  const handleOpenChange = (newOpen: boolean) => {\r\n    setOpen(newOpen);\r\n    if (!newOpen) {\r\n      // Reset state when closing\r\n      setRating(0);\r\n      setHoverRating(0);\r\n      setComment(\"\");\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Dialog open={open} onOpenChange={handleOpenChange}>\r\n      <DialogTrigger asChild>\r\n        {trigger || (\r\n          <Button variant=\"outline\" size=\"sm\">\r\n            {tReviews(\"writeReview\")}\r\n          </Button>\r\n        )}\r\n      </DialogTrigger>\r\n      <DialogContent className=\"sm:max-w-(--write-review-dialog-max-w)\">\r\n        <DialogHeader>\r\n          <DialogTitle>{tReviews(\"reviewThisProduct\")}</DialogTitle>\r\n          <DialogDescription>\r\n            {productTitle ? (\r\n              <span className=\"line-clamp-1\">{productTitle}</span>\r\n            ) : (\r\n              tReviews(\"shareThoughts\")\r\n            )}\r\n          </DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <div className=\"grid gap-4 py-2\">\r\n          {/* Star Rating */}\r\n          <div className=\"space-y-2\">\r\n            <Label>{tReviews(\"overallRating\")}</Label>\r\n            <div className=\"flex items-center gap-1\">\r\n              {[1, 2, 3, 4, 5].map((star) => (\r\n                <button\r\n                  key={star}\r\n                  type=\"button\"\r\n                  onClick={() => setRating(star)}\r\n                  onMouseEnter={() => setHoverRating(star)}\r\n                  onMouseLeave={() => setHoverRating(0)}\r\n                  className=\"p-1 focus:outline-none focus-visible:ring-2 focus-visible:ring-ring rounded\"\r\n                  aria-label={`${star} ${tReviews(\"star\")}`}\r\n                >\r\n                  <Star\r\n                    className={`h-8 w-8 transition-colors ${\r\n                      star <= activeRating\r\n                        ? \"fill-rating text-rating\"\r\n                        : \"text-muted-foreground hover:text-foreground\"\r\n                    }`}\r\n                  />\r\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Comment */}\r\n          <div className=\"space-y-2\">\r\n            <Label htmlFor=\"review-comment\">{tReviews(\"reviewComment\")}</Label>\r\n            <Textarea\r\n              id=\"review-comment\"\r\n              placeholder={tReviews(\"reviewCommentPlaceholder\")}\r\n              value={comment}\r\n              onChange={(e) => setComment(e.target.value)}\r\n              rows={4}\r\n              maxLength={2000}\r\n              className=\"resize-none\"\r\n            />\r\n            <p className=\"text-xs text-muted-foreground text-right\">\r\n              {comment.length}/2000\r\n            </p>\r\n          </div>\r\n        </div>\r\n\r\n        <DialogFooter className=\"gap-2 sm:gap-0\">\r\n          <Button\r\n            type=\"button\"\r\n            variant=\"ghost\"\r\n            onClick={() => setOpen(false)}\r\n            disabled={isPending}\r\n          >\r\n            {tReviews(\"cancel\")}\r\n          </Button>\r\n          <Button\r\n            type=\"button\"\r\n            onClick={handleSubmit}\r\n            disabled={isPending || rating === 0}\r\n          >\r\n            {isPending ? tReviews(\"submitting\") : tReviews(\"submitReview\")}\r\n          </Button>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\profile\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\profile\\profile-header-sync.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\profile\\profile-settings-panel.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Moon' is defined but never used.","line":11,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":7,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Moon"},"fix":{"range":[207,216],"text":""},"desc":"Remove unused variable \"Moon\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isSeller' is defined but never used.","line":108,"column":40,"nodeType":"Identifier","messageId":"unusedVar","endLine":108,"endColumn":48}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { Switch } from \"@/components/ui/switch\"\r\nimport {\r\n  Bell,\r\n  Shield,\r\n  CreditCard,\r\n  GlobeSimple,\r\n  Moon,\r\n  Question,\r\n  SignOut,\r\n  CaretRight,\r\n} from \"@phosphor-icons/react\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\ninterface SettingsItemProps {\r\n  icon: React.ReactNode\r\n  label: string\r\n  description?: string\r\n  hasToggle?: boolean\r\n  danger?: boolean\r\n  href?: string\r\n  onClick?: () => void\r\n  toggled?: boolean\r\n  onToggle?: (value: boolean) => void\r\n}\r\n\r\nfunction SettingsItem({\r\n  icon,\r\n  label,\r\n  description,\r\n  hasToggle,\r\n  danger,\r\n  href,\r\n  onClick,\r\n  toggled,\r\n  onToggle,\r\n}: SettingsItemProps) {\r\n  const content = (\r\n    <>\r\n      <div className={cn(\n        \"size-10 rounded-lg flex items-center justify-center\",\n        danger ? \"bg-destructive-subtle\" : \"bg-muted\"\n      )}>\n        <span className={danger ? \"text-destructive\" : \"text-foreground\"}>\n          {icon}\n        </span>\n      </div>\n      <div className=\"flex-1 text-left\">\r\n        <p className={cn(\r\n          \"font-medium\",\r\n          danger ? \"text-destructive\" : \"text-foreground\"\r\n        )}>\r\n          {label}\r\n        </p>\r\n        {description && (\r\n          <p className=\"text-xs text-muted-foreground\">{description}</p>\r\n        )}\r\n      </div>\r\n      {hasToggle && onToggle ? (\r\n        <Switch\r\n          checked={toggled ?? false}\r\n          onCheckedChange={onToggle}\r\n          onClick={(e) => e.stopPropagation()}\r\n        />\r\n      ) : (\r\n        <CaretRight className=\"size-5 text-muted-foreground\" />\r\n      )}\r\n    </>\r\n  )\r\n\r\n  const baseClasses = cn(\n    \"w-full flex items-center gap-3 p-4 bg-card rounded-xl border border-border\",\n    \"tap-transparent active:bg-active transition-colors\",\n    danger && \"text-destructive\"\n  )\n\r\n  if (href) {\r\n    return (\r\n      <Link href={href} className={baseClasses}>\r\n        {content}\r\n      </Link>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <button type=\"button\" onClick={onClick} className={baseClasses}>\r\n      {content}\r\n    </button>\r\n  )\r\n}\r\n\r\ninterface ProfileSettingsPanelProps {\r\n  /** Whether the user is a seller */\r\n  isSeller?: boolean\r\n  /** Sign out handler */\r\n  onSignOut?: () => void\r\n}\r\n\r\n/**\r\n * ProfileSettingsPanel - Tradesphere-style settings list\r\n * \r\n * Card-style items with icons, labels, descriptions, and either\r\n * chevron (navigation) or switch (toggle) on the right.\r\n */\r\nexport function ProfileSettingsPanel({ isSeller, onSignOut }: ProfileSettingsPanelProps) {\r\n  const t = useTranslations(\"ProfileSettings\")\r\n\r\n  return (\r\n    <div className=\"space-y-2 pb-4\">\r\n      <SettingsItem\r\n        icon={<Bell className=\"size-5\" weight=\"fill\" />}\r\n        label={t(\"notifications\")}\r\n        description={t(\"notificationsDescription\")}\r\n        href=\"/account/notifications\"\r\n      />\r\n      \r\n      <SettingsItem\r\n        icon={<Shield className=\"size-5\" weight=\"fill\" />}\r\n        label={t(\"security\")}\r\n        description={t(\"securityDescription\")}\r\n        href=\"/account/security\"\r\n      />\r\n      \r\n      <SettingsItem\r\n        icon={<CreditCard className=\"size-5\" weight=\"fill\" />}\r\n        label={t(\"paymentMethods\")}\r\n        description={t(\"paymentMethodsDescription\")}\r\n        href=\"/account/payments\"\r\n      />\r\n      \r\n      <SettingsItem\r\n        icon={<GlobeSimple className=\"size-5\" weight=\"fill\" />}\r\n        label={t(\"languageRegion\")}\r\n        description={t(\"languageRegionDescription\")}\r\n        href=\"/account/settings\"\r\n      />\r\n      \r\n      <SettingsItem\r\n        icon={<Question className=\"size-5\" weight=\"fill\" />}\r\n        label={t(\"helpSupport\")}\r\n        description={t(\"helpSupportDescription\")}\r\n        href=\"/support\"\r\n      />\r\n\r\n      {onSignOut && (\r\n        <SettingsItem\r\n          icon={<SignOut className=\"size-5\" weight=\"fill\" />}\r\n          label={t(\"signOut\")}\r\n          description={t(\"signOutDescription\")}\r\n          danger\r\n          onClick={onSignOut}\r\n        />\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\profile\\profile-shell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\profile\\profile-stats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\profile\\profile-tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\promoted-listings-strip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\search\\mobile-search-overlay.tsx","messages":[{"ruleId":"sonarjs/no-redundant-jump","severity":1,"message":"Remove this redundant jump.","line":111,"column":5,"nodeType":"ReturnStatement","messageId":"removeRedundantJump","endLine":111,"endColumn":11,"suggestions":[{"messageId":"suggestJumpRemoval","fix":{"range":[3247,3261],"text":""},"desc":"Remove this redundant jump"}]},{"ruleId":"sonarjs/no-redundant-jump","severity":1,"message":"Remove this redundant jump.","line":132,"column":5,"nodeType":"ReturnStatement","messageId":"removeRedundantJump","endLine":132,"endColumn":11,"suggestions":[{"messageId":"suggestJumpRemoval","fix":{"range":[3815,3829],"text":""},"desc":"Remove this redundant jump"}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'handleClose'. Either include it or remove the dependency array.","line":148,"column":6,"nodeType":"ArrayExpression","endLine":148,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [handleClose, isOpen]","fix":{"range":[4226,4234],"text":"[handleClose, isOpen]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'setIsOpen'. Either include it or remove the dependency array.","line":152,"column":6,"nodeType":"ArrayExpression","endLine":152,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [setIsOpen]","fix":{"range":[4307,4309],"text":"[setIsOpen]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'setIsOpen'. Either include it or remove the dependency array.","line":158,"column":6,"nodeType":"ArrayExpression","endLine":158,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [clearQuery, setIsOpen]","fix":{"range":[4435,4447],"text":"[clearQuery, setIsOpen]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { useRef, useEffect, useCallback, useId } from \"react\"\r\nimport {\r\n  MagnifyingGlass,\r\n  X,\r\n  Clock,\r\n  TrendUp,\r\n  Package,\r\n  ArrowRight,\r\n  Robot,\r\n} from \"@phosphor-icons/react\"\r\nimport { SearchAiChat } from \"./search-ai-chat\"\r\nimport { FieldLabel } from \"@/components/shared/field\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Switch } from \"@/components/ui/switch\"\r\nimport { useRouter } from \"@/i18n/routing\"\nimport { useTranslations } from \"next-intl\"\nimport Image from \"next/image\"\nimport { cn } from \"@/lib/utils\"\nimport { useProductSearch } from \"@/hooks/use-product-search\"\nimport { buildSearchHref, type SearchLaunchContext } from \"./search-context\"\n\r\ninterface MobileSearchOverlayProps {\n  className?: string\n  /** If true, hides the default trigger button (use when providing external trigger) */\n  hideDefaultTrigger?: boolean\n  /** External control for open state */\n  externalOpen?: boolean\n  /** Callback when overlay should close (for external control) */\n  onOpenChange?: (open: boolean) => void\n  /** Optional category context preserved when launching search results */\n  searchContext?: SearchLaunchContext\n}\n\r\n/** Focus delay in milliseconds after overlay opens */\r\nconst FOCUS_DELAY_MS = 100\r\n\r\n/**\r\n * Mobile Search Overlay Component\r\n * \r\n * A full-screen search overlay optimized for mobile devices with:\r\n * - Live product search with debouncing\r\n * - Recent searches with localStorage persistence\r\n * - Trending searches\r\n * - Full WCAG 2.1 AA accessibility compliance\r\n */\r\nexport function MobileSearchOverlay({\n  className,\n  hideDefaultTrigger = false,\n  externalOpen,\n  onOpenChange,\n  searchContext,\n}: MobileSearchOverlayProps) {\n  // Generate unique IDs for accessibility\r\n  const searchInputId = useId()\r\n  const overlayTitleId = useId()\r\n  const overlayDescId = useId()\r\n\r\n  // State - use external control if provided\r\n  const [internalOpen, setInternalOpen] = React.useState(false)\r\n  const [aiMode, setAiMode] = React.useState(false)\r\n  const isOpen = externalOpen !== undefined ? externalOpen : internalOpen\r\n\r\n  const setIsOpen = React.useCallback((open: boolean) => {\r\n    if (onOpenChange) {\r\n      onOpenChange(open)\r\n    } else {\r\n      setInternalOpen(open)\r\n    }\r\n  }, [onOpenChange])\r\n\r\n  // Refs\r\n  const inputRef = useRef<HTMLInputElement>(null)\r\n  const triggerRef = useRef<HTMLButtonElement>(null)\r\n\r\n  // Hooks\n  const router = useRouter()\n  const tNav = useTranslations(\"Navigation\")\n  const tSearch = useTranslations(\"SearchOverlay\")\n  const isAiModeAvailable =\n    process.env.NEXT_PUBLIC_AI_ASSISTANT_ENABLED === \"1\" ||\n    process.env.NEXT_PUBLIC_AI_ASSISTANT_ENABLED === \"true\"\n\r\n  // Use shared search hook\r\n  const {\r\n    query,\r\n    setQuery,\r\n    products,\r\n    isSearching,\r\n    recentSearches,\r\n    trendingSearches,\r\n    formatPrice,\r\n    saveSearch,\r\n    clearRecentSearches,\r\n    clearQuery,\r\n    minSearchLength,\r\n  } = useProductSearch(8)\r\n\r\n  // Focus input when opened\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      const timer = setTimeout(() => {\r\n        inputRef.current?.focus()\r\n      }, FOCUS_DELAY_MS)\r\n      return () => clearTimeout(timer)\r\n    }\r\n\r\n    return\r\n  }, [isOpen])\r\n\r\n  // Lock body scroll when open\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      const scrollY = window.scrollY\r\n      document.body.style.position = \"fixed\"\r\n      document.body.style.top = `-${scrollY}px`\r\n      document.body.style.width = \"100%\"\r\n      document.body.style.overflow = \"hidden\"\r\n\r\n      return () => {\r\n        document.body.style.position = \"\"\r\n        document.body.style.top = \"\"\r\n        document.body.style.width = \"\"\r\n        document.body.style.overflow = \"\"\r\n        window.scrollTo(0, scrollY)\r\n      }\r\n    }\r\n\r\n    return\r\n  }, [isOpen])\r\n\r\n  // Handle Escape key to close overlay\r\n  useEffect(() => {\r\n    if (!isOpen) return\r\n\r\n    const handleKeyDown = (e: KeyboardEvent) => {\r\n      if (e.key === \"Escape\") {\r\n        e.preventDefault()\r\n        handleClose()\r\n      }\r\n    }\r\n\r\n    document.addEventListener(\"keydown\", handleKeyDown)\r\n    return () => document.removeEventListener(\"keydown\", handleKeyDown)\r\n  }, [isOpen])\r\n\r\n  const handleOpen = useCallback(() => {\r\n    setIsOpen(true)\r\n  }, [])\r\n\r\n  const handleClose = useCallback(() => {\r\n    setIsOpen(false)\r\n    clearQuery()\r\n    triggerRef.current?.focus()\r\n  }, [clearQuery])\r\n\r\n  const handleSearch = useCallback(\r\n    (value: string) => {\r\n      const trimmedValue = value.trim()\r\n      if (!trimmedValue) return\r\n\r\n      saveSearch(trimmedValue)\n      handleClose()\n      router.push(\n        buildSearchHref({\n          query: trimmedValue,\n          ...(searchContext ? { context: searchContext } : {}),\n        })\n      )\n    },\n    [saveSearch, handleClose, router, searchContext]\n  )\n\r\n  // Build SEO-friendly product URL\r\n  const buildProductUrl = useCallback((product: { slug?: string; storeSlug?: string | null; id: string }) => {\r\n    if (!product.storeSlug) return \"#\"\r\n    return `/${product.storeSlug}/${product.slug || product.id}`\r\n  }, [])\r\n\r\n  const handleProductSelect = useCallback(\r\n    (product: { slug?: string; storeSlug?: string | null; id: string }) => {\r\n      if (!product) return\r\n      handleClose()\r\n      router.push(buildProductUrl(product))\r\n    },\r\n    [handleClose, router, buildProductUrl]\r\n  )\r\n\r\n  const handleClearInput = useCallback(() => {\r\n    setQuery(\"\")\r\n    inputRef.current?.focus()\r\n  }, [setQuery])\r\n\r\n  const handleSubmit = useCallback(\r\n    (e: React.FormEvent) => {\r\n      e.preventDefault()\r\n      handleSearch(query)\r\n    },\r\n    [handleSearch, query]\r\n  )\r\n\r\n  return (\r\n    <>\r\n      {/* Search Trigger Button - hidden when using external trigger */}\r\n      {!hideDefaultTrigger && (\r\n        <button\r\n          ref={triggerRef}\r\n          type=\"button\"\r\n          onClick={handleOpen}\r\n          className={cn(\r\n            \"flex items-center justify-center\",\r\n            \"size-11 p-0\",\r\n            \"rounded-lg text-header-text\",\r\n            \"hover:bg-header-hover active:bg-header-active\",\r\n            \"focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\r\n            \"transition-colors duration-150\",\r\n            \"md:hidden touch-manipulation\",\r\n            className\r\n          )}\r\n          aria-label={tSearch(\"search\")}\r\n          aria-haspopup=\"dialog\"\r\n          aria-expanded={isOpen}\r\n        >\r\n          <MagnifyingGlass size={24} weight=\"regular\" aria-hidden=\"true\" />\r\n        </button>\r\n      )}\r\n\r\n      {/* Full-Screen Search Overlay */}\r\n      {isOpen && (\r\n        <div\r\n          role=\"dialog\"\r\n          aria-modal=\"true\"\r\n          aria-labelledby={overlayTitleId}\r\n          aria-describedby={overlayDescId}\r\n          className={cn(\r\n            \"fixed inset-0 z-60\",\r\n            \"flex flex-col\",\r\n            \"bg-background\"\r\n          )}\r\n        >\r\n          {/* Visually hidden title for screen readers */}\r\n          <h2 id={overlayTitleId} className=\"sr-only\">\r\n            {tSearch(\"search\")}\r\n          </h2>\r\n          <p id={overlayDescId} className=\"sr-only\">\r\n            {tSearch(\"searchDescription\")}\r\n          </p>\r\n\r\n          {/* Search Header - Close above, full-width search below */}\r\n          <header className=\"shrink-0 bg-background border-b border-border px-inset pt-2 pb-2\">\n            <div className=\"flex items-center justify-between\">\n              {isAiModeAvailable ? (\n                <div className=\"flex items-center gap-2\">\n                  <Robot size={16} weight={aiMode ? \"fill\" : \"regular\"} className={aiMode ? \"text-primary\" : \"text-muted-foreground\"} />\n                  <span className={cn(\"text-sm font-medium\", aiMode ? \"text-foreground\" : \"text-muted-foreground\")}>\n                    {tSearch(\"aiMode\")}\n                  </span>\n                  <Switch\n                    checked={aiMode}\n                    onCheckedChange={setAiMode}\n                    aria-label={tSearch(\"aiMode\")}\n                  />\n                </div>\n              ) : (\n                <div />\n              )}\n              <Button\n                type=\"button\"\n                variant=\"ghost\"\n                onClick={handleClose}\n                className=\"h-11 px-3 text-link font-medium hover:bg-transparent hover:text-link-hover\"\n              >\n                {tSearch(\"close\")}\n              </Button>\n            </div>\n\n            {/* Search Input - hidden in AI mode */}\n            {(!isAiModeAvailable || !aiMode) && (\n              <form\n                onSubmit={handleSubmit}\n                className=\"relative\"\n                role=\"search\"\n                aria-label={tSearch(\"search\")}\n              >\n                <MagnifyingGlass\r\n                  size={18}\r\n                  weight=\"regular\"\r\n                  className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground pointer-events-none\"\r\n                  aria-hidden=\"true\"\r\n                />\r\n                <FieldLabel htmlFor={searchInputId} className=\"sr-only\">\r\n                  {tSearch(\"searchFieldLabel\")}\r\n                </FieldLabel>\r\n                <Input\n                  ref={inputRef}\n                  id={searchInputId}\n                  type=\"search\"\n                  inputMode=\"search\"\r\n                  enterKeyHint=\"search\"\r\n                  placeholder={tNav(\"searchPlaceholder\")}\r\n                  value={query}\r\n                  onChange={(e) => setQuery(e.target.value)}\r\n                  className=\"h-11 w-full pl-9 pr-10 text-base bg-background rounded-full border border-border focus-visible:ring-0\"\n                  autoComplete=\"off\"\n                  autoCapitalize=\"off\"\r\n                  autoCorrect=\"off\"\r\n                  spellCheck={false}\r\n                  aria-label={tSearch(\"searchFieldLabel\")}\r\n                />\r\n                {query && (\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={handleClearInput}\r\n                    className=\"absolute right-2 top-1/2 -translate-y-1/2 size-touch-xs rounded-full flex items-center justify-center bg-muted text-muted-foreground hover:bg-hover active:bg-active hover:text-foreground\"\r\n                    aria-label={tSearch(\"clear\")}\r\n                  >\r\n                    <X size={12} weight=\"bold\" aria-hidden=\"true\" />\r\n                  </button>\r\n                )}\r\n              </form>\r\n            )}\r\n          </header>\r\n\r\n          {/* Search Content */}\n          <main className=\"flex-1 overflow-y-auto overscroll-contain\" role=\"region\" aria-label={tSearch(\"search\")}>\n            {/* AI Chat Mode */}\n            {isAiModeAvailable && aiMode ? (\n              <SearchAiChat onClose={handleClose} className=\"h-full\" />\n            ) : (\n            <>\n            {/* Loading State */}\r\n            {isSearching && (\r\n              <div role=\"status\" aria-live=\"polite\" className=\"px-4 py-8 text-center\">\r\n                <div className=\"inline-flex items-center gap-2 text-sm text-muted-foreground\">\r\n                  <div className=\"size-5 border-2 border-border border-t-primary rounded-full animate-spin\" aria-hidden=\"true\" />\r\n                  <span>{tSearch(\"searching\")}</span>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Product Results */}\r\n            {!isSearching && products.length > 0 && (\r\n              <section aria-labelledby=\"products-heading\" className=\"border-b border-border\">\r\n                <div className=\"flex items-center justify-between px-inset py-2 bg-muted\">\r\n                  <h3 id=\"products-heading\" className=\"flex items-center gap-2 text-xs font-semibold text-muted-foreground uppercase tracking-wide\">\r\n                    <Package size={14} weight=\"regular\" aria-hidden=\"true\" />\r\n                    {tSearch(\"products\")}\r\n                  </h3>\r\n                  <button\r\n                    type=\"button\"\r\n                    onClick={() => handleSearch(query)}\r\n                    className=\"text-xs text-link font-medium flex items-center gap-1 hover:text-link-hover\"\r\n                  >\r\n                    {tSearch(\"viewAll\")}\r\n                    <ArrowRight size={12} weight=\"regular\" aria-hidden=\"true\" />\r\n                  </button>\r\n                </div>\r\n\r\n                <ul className=\"divide-y divide-border\" role=\"listbox\" aria-label={tSearch(\"products\")}>\r\n                  {products.map((product) => (\r\n                    <li key={product.id} role=\"option\" aria-selected=\"false\">\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={() => handleProductSelect(product)}\r\n                        className=\"w-full flex items-center gap-2 p-2 hover:bg-hover active:bg-active text-left touch-manipulation transition-colors\"\r\n                      >\r\n                        <div className=\"size-12 bg-muted rounded-lg overflow-hidden shrink-0 ring-1 ring-border\">\r\n                          {product.images?.[0] ? (\r\n                            <Image\r\n                              src={product.images[0]}\r\n                              alt={product.title}\r\n                              width={56}\r\n                              height={56}\r\n                              className=\"w-full h-full object-cover\"\r\n                              loading=\"lazy\"\r\n                            />\r\n                          ) : (\r\n                            <div className=\"w-full h-full flex items-center justify-center\" aria-hidden=\"true\">\r\n                              <Package size={24} weight=\"regular\" className=\"text-muted-foreground\" />\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                        <div className=\"flex-1 min-w-0\">\r\n                          <p className=\"text-sm font-medium text-foreground line-clamp-2\">{product.title}</p>\r\n                          <p className=\"text-sm font-bold text-price-sale mt-0.5\">{formatPrice(product.price)}</p>\r\n                        </div>\r\n                        <ArrowRight size={16} weight=\"regular\" className=\"text-muted-foreground shrink-0\" aria-hidden=\"true\" />\r\n                      </button>\r\n                    </li>\r\n                  ))}\r\n                </ul>\r\n              </section>\r\n            )}\r\n\r\n            {/* No Results */}\r\n            {!isSearching && query.length >= minSearchLength && products.length === 0 && (\r\n              <div role=\"status\" aria-live=\"polite\" className=\"px-inset py-10 text-center\">\r\n                <Package size={48} weight=\"regular\" className=\"text-muted-foreground mx-auto mb-3\" aria-hidden=\"true\" />\r\n                <p className=\"text-base font-medium text-foreground\">\r\n                  {tSearch(\"noResultsFor\", { query })}\r\n                </p>\r\n                <p className=\"text-sm text-muted-foreground mt-1\">{tSearch(\"tryDifferent\")}</p>\r\n              </div>\r\n            )}\r\n\r\n            {/* Default State - Recent & Trending Searches */}\r\n            {!query && (\r\n              <>\r\n                {/* Recent Searches Section */}\r\n                {recentSearches.length > 0 && (\r\n                  <section aria-labelledby=\"recent-searches-heading\" className=\"border-b border-border\">\r\n                    <div className=\"flex items-center justify-between px-inset py-2 bg-muted\">\r\n                      <h3 id=\"recent-searches-heading\" className=\"flex items-center gap-2 text-xs font-semibold text-muted-foreground uppercase tracking-wide\">\r\n                        <Clock size={14} weight=\"regular\" aria-hidden=\"true\" />\r\n                        {tSearch(\"recentSearches\")}\r\n                      </h3>\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={clearRecentSearches}\r\n                        className=\"text-xs text-muted-foreground font-medium hover:text-foreground\"\r\n                      >\r\n                        {tSearch(\"clear\")}\r\n                      </button>\r\n                    </div>\r\n                    <ul className=\"divide-y divide-border\" role=\"list\" aria-label={tSearch(\"recentSearches\")}>\r\n                      {recentSearches.map((search, index) => (\r\n                        <li key={`recent-${index}`}>\r\n                          <button\r\n                            type=\"button\"\r\n                            onClick={() => handleSearch(search)}\r\n                            className=\"w-full flex items-center gap-2 px-inset py-3 hover:bg-hover active:bg-active text-left touch-manipulation transition-colors\"\r\n                          >\r\n                            <Clock size={18} weight=\"regular\" className=\"text-muted-foreground shrink-0\" aria-hidden=\"true\" />\r\n                            <span className=\"flex-1 text-base text-foreground\">{search}</span>\r\n                            <ArrowRight size={16} weight=\"regular\" className=\"text-muted-foreground shrink-0\" aria-hidden=\"true\" />\r\n                          </button>\r\n                        </li>\r\n                      ))}\r\n                    </ul>\r\n                  </section>\r\n                )}\r\n\r\n                {/* Trending Searches Section */}\r\n                <section aria-labelledby=\"trending-searches-heading\" className=\"border-b border-border\">\r\n                  <div className=\"flex items-center gap-2 px-inset py-2 bg-muted\">\r\n                    <h3 id=\"trending-searches-heading\" className=\"flex items-center gap-2 text-xs font-semibold text-muted-foreground uppercase tracking-wide\">\r\n                      <TrendUp size={14} weight=\"regular\" aria-hidden=\"true\" />\r\n                      {tSearch(\"trending\")}\r\n                    </h3>\r\n                  </div>\r\n                  <ol className=\"divide-y divide-border\" role=\"list\" aria-label={tSearch(\"trending\")}>\r\n                    {trendingSearches.map((search, index) => (\r\n                      <li key={`trending-${index}`}>\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={() => handleSearch(search)}\r\n                          className=\"w-full flex items-center gap-2 px-inset py-3 hover:bg-hover active:bg-active text-left touch-manipulation transition-colors\"\r\n                        >\r\n                          <span className=\"size-6 rounded-full shrink-0 flex items-center justify-center text-xs font-bold text-primary-foreground bg-primary\" aria-hidden=\"true\">\r\n                            {index + 1}\r\n                          </span>\r\n                          <span className=\"flex-1 text-base text-foreground\">{search}</span>\r\n                          <ArrowRight size={16} weight=\"regular\" className=\"text-muted-foreground shrink-0\" aria-hidden=\"true\" />\r\n                        </button>\r\n                      </li>\r\n                    ))}\r\n                  </ol>\r\n                </section>\r\n              </>\r\n            )}\r\n            </>\r\n            )}\r\n          </main>\r\n\r\n          {/* Bottom Safe Area for notched devices */}\r\n          <div className=\"shrink-0 h-safe-bottom bg-background\" aria-hidden=\"true\" />\r\n        </div>\r\n      )}\r\n    </>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\search\\save-search-button.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BellRinging' is defined but never used.","line":6,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":27,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"BellRinging"},"fix":{"range":[174,187],"text":""},"desc":"Remove unused variable \"BellRinging\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\nimport { useEffect, useMemo, useState } from \"react\"\nimport { useTranslations } from \"next-intl\"\nimport { useSearchParams } from \"next/navigation\"\nimport { Bell, BellRinging, Check } from \"@phosphor-icons/react\"\nimport { Button } from \"@/components/ui/button\"\nimport { useToast } from \"@/hooks/use-toast\"\nimport { cn } from \"@/lib/utils\"\r\n\r\ninterface SaveSearchButtonProps {\r\n  query?: string | undefined\r\n  category?: string | undefined\r\n  className?: string\r\n}\r\n\r\n/**\r\n * SaveSearchButton - Allows users to save the current search for later\r\n * Saves to localStorage for MVP, will be enhanced with backend notifications\r\n */\r\nexport function SaveSearchButton({ query, category, className }: SaveSearchButtonProps) {\r\n  const t = useTranslations(\"SaveSearch\")\r\n  const { toast } = useToast()\r\n  const searchParams = useSearchParams()\n  const [isSaved, setIsSaved] = useState(false)\n  const [isAnimating, setIsAnimating] = useState(false)\n\n  // Build search key from current params (exclude pagination/sort).\n  const searchKey = useMemo(() => {\n    const params = new URLSearchParams()\n    if (query) params.set(\"q\", query)\n    if (category) params.set(\"category\", category)\n\r\n    // Include other filters\r\n    const minPrice = searchParams.get(\"minPrice\")\r\n    const maxPrice = searchParams.get(\"maxPrice\")\r\n    const minRating = searchParams.get(\"minRating\")\r\n    const deals = searchParams.get(\"deals\")\r\n    const verified = searchParams.get(\"verified\")\r\n\r\n    if (minPrice) params.set(\"minPrice\", minPrice)\r\n    if (maxPrice) params.set(\"maxPrice\", maxPrice)\r\n    if (minRating) params.set(\"minRating\", minRating)\r\n    if (deals) params.set(\"deals\", deals)\n    if (verified) params.set(\"verified\", verified)\n\n    return params.toString()\n  }, [query, category, searchParams])\n\n  // Check if already saved after mount (avoid setState during render).\n  useEffect(() => {\n    if (!searchKey) return\n\n    try {\n      const raw = localStorage.getItem(\"treido-saved-searches\")\n      const savedSearches = JSON.parse(raw || \"[]\") as Array<{ key: string }>\n      setIsSaved(savedSearches.some((s) => s.key === searchKey))\n    } catch {\n      setIsSaved(false)\n    }\n  }, [searchKey])\n\n  const handleSaveSearch = () => {\n    const key = searchKey\n    if (!key) {\n      toast({\n        title: t(\"emptySearchTitle\"),\n        description: t(\"emptySearchDescription\"),\n        variant: \"destructive\",\r\n      })\r\n      return\r\n    }\r\n\r\n    const savedSearches = JSON.parse(localStorage.getItem(\"treido-saved-searches\") || \"[]\")\r\n    const existingIndex = savedSearches.findIndex((s: { key: string }) => s.key === key)\r\n\r\n    if (existingIndex >= 0) {\r\n      // Remove from saved\r\n      savedSearches.splice(existingIndex, 1)\r\n      localStorage.setItem(\"treido-saved-searches\", JSON.stringify(savedSearches))\r\n      setIsSaved(false)\r\n      toast({\r\n        title: t(\"removedTitle\"),\r\n        description: t(\"removedDescription\"),\r\n      })\r\n    } else {\r\n      // Add to saved\r\n      const newSearch = {\r\n        key,\r\n        query: query || null,\r\n        category: category || null,\r\n        filters: {\r\n          minPrice: searchParams.get(\"minPrice\"),\r\n          maxPrice: searchParams.get(\"maxPrice\"),\r\n          minRating: searchParams.get(\"minRating\"),\r\n          deals: searchParams.get(\"deals\"),\r\n          verified: searchParams.get(\"verified\"),\r\n        },\r\n        createdAt: new Date().toISOString(),\r\n      }\r\n      savedSearches.push(newSearch)\r\n      localStorage.setItem(\"treido-saved-searches\", JSON.stringify(savedSearches))\r\n      setIsSaved(true)\r\n      setIsAnimating(true)\r\n      setTimeout(() => setIsAnimating(false), 600)\r\n      toast({\r\n        title: t(\"savedTitle\"),\r\n        description: t(\"savedDescription\"),\r\n      })\r\n    }\r\n  }\r\n\r\n  // Don't show if no search criteria\r\n  if (!query && !category) return null\r\n\r\n  return (\r\n    <Button\r\n      variant={isSaved ? \"secondary\" : \"outline\"}\r\n      size=\"sm\"\r\n      onClick={handleSaveSearch}\r\n      className={cn(\r\n        \"gap-1.5 transition-all\",\r\n        isAnimating && \"scale-105\",\r\n        className\r\n      )}\r\n    >\r\n      {isSaved ? (\r\n        <>\r\n          <Check size={16} weight=\"bold\" className=\"text-success\" />\r\n          <span className=\"hidden sm:inline\">{t(\"saved\")}</span>\r\n        </>\r\n      ) : (\r\n        <>\r\n          <Bell size={16} />\r\n          <span className=\"hidden sm:inline\">{t(\"saveSearch\")}</span>\r\n        </>\r\n      )}\r\n    </Button>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\search\\search-ai-chat.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'extractListings' to the outer scope.","line":117,"column":128,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":117,"endColumn":130}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport * as React from \"react\"\r\nimport { useChat } from \"@ai-sdk/react\"\r\nimport { DefaultChatTransport } from \"ai\"\r\nimport { PaperPlaneRight, Robot, CircleNotch, Package, ArrowRight } from \"@phosphor-icons/react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\"\r\nimport { useTranslations, useLocale } from \"next-intl\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { Link, useRouter } from \"@/i18n/routing\"\r\nimport Image from \"next/image\"\r\nimport { formatPrice } from \"@/lib/format-price\"\r\n\r\ninterface SearchAiChatProps {\r\n  className?: string\r\n  onClose?: () => void\r\n  /** Compact mode for desktop popover */\r\n  compact?: boolean\r\n}\r\n\r\ninterface ListingCard {\r\n  id: string\r\n  title: string\r\n  price: number\r\n  currency?: string\r\n  image?: string\r\n  slug?: string\r\n  storeSlug?: string\r\n}\r\n\r\n/** Assistant Avatar - consistent across the app */\r\nfunction AssistantAvatar({ size = \"sm\" }: { size?: \"sm\" | \"md\" }) {\r\n  const sizeClasses = {\r\n    sm: \"size-7\",\r\n    md: \"size-8\",\r\n  }\r\n  return (\r\n    <Avatar className={cn(sizeClasses[size], \"shrink-0\")}>\r\n      <AvatarFallback className=\"bg-primary text-primary-foreground\">\r\n        <Robot size={size === \"md\" ? 16 : 14} weight=\"fill\" />\r\n      </AvatarFallback>\r\n    </Avatar>\r\n  )\r\n}\r\n\r\n/** User Avatar for chat */\nfunction UserChatAvatar({\n  label,\n  size = \"sm\",\n}: {\n  label: string\n  size?: \"sm\" | \"md\"\n}) {\n  const sizeClasses = {\n    sm: \"size-7\",\n    md: \"size-8\",\n  }\n  return (\n    <Avatar className={cn(sizeClasses[size], \"shrink-0\")}>\n      <AvatarFallback className=\"bg-foreground text-background text-2xs font-semibold\">\n        {label}\n      </AvatarFallback>\n    </Avatar>\n  )\n}\n\r\n/**\r\n * AI Chat component for search overlay\r\n * Uses Vercel AI SDK useChat hook with streaming\r\n */\r\nexport function SearchAiChat({ className, onClose, compact = false }: SearchAiChatProps) {\r\n  const locale = useLocale()\r\n  const router = useRouter()\r\n  const t = useTranslations(\"SearchOverlay\")\r\n  const inputRef = React.useRef<HTMLInputElement>(null)\n  const messagesEndRef = React.useRef<HTMLDivElement>(null)\n  const [input, setInput] = React.useState(\"\")\n\n  const { messages, sendMessage, status, stop, error, clearError, regenerate } = useChat({\n    transport: new DefaultChatTransport({\n      api: \"/api/assistant/chat\",\n      body: { locale },\n    }),\n  })\n\n  const isLoading = (status === \"streaming\" || status === \"submitted\") && !error\n\r\n  // Auto-scroll to bottom on new messages\r\n  React.useEffect(() => {\r\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" })\r\n  }, [messages])\r\n\r\n  // Focus input on mount\r\n  React.useEffect(() => {\r\n    inputRef.current?.focus()\r\n  }, [])\r\n\r\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault()\n    const trimmed = input.trim()\n    if (!trimmed || isLoading) return\n    \n    clearError?.()\n    sendMessage({ text: trimmed })\n    setInput(\"\")\n  }\n\r\n  const handleProductClick = (product: ListingCard) => {\r\n    if (!product.storeSlug) return\r\n    onClose?.()\r\n    router.push(`/${product.storeSlug}/${product.slug || product.id}`)\r\n  }\r\n\r\n  // Extract tool results (listing cards) from messages\r\n  const extractListings = (parts: Array<{ type: string; toolName?: string; output?: unknown; state?: string }>): ListingCard[] => {\r\n    const listings: ListingCard[] = []\r\n    for (const part of parts) {\r\n      // AI SDK v6: tool parts are typed as `tool-{toolName}` with state\r\n      if (\r\n        part.type === \"tool-searchListings\" && \r\n        part.state === \"output-available\" &&\r\n        part.output && \r\n        Array.isArray(part.output)\r\n      ) {\r\n        listings.push(...(part.output as ListingCard[]))\r\n      }\r\n    }\r\n    return listings\r\n  }\r\n\r\n  return (\r\n    <div className={cn(\"flex flex-col h-full\", className)}>\r\n      {/* Chat Messages */}\n      <div className={cn(\n        \"flex-1 overflow-y-auto overscroll-contain\",\n        compact ? \"max-h-80\" : \"min-h-0\"\n      )}>\n        {messages.length === 0 ? (\r\n          <div className={cn(\r\n            \"flex flex-col items-center justify-center text-center\",\r\n            compact ? \"py-8 px-4\" : \"py-12 px-6\"\r\n          )}>\r\n            <Avatar className=\"size-12 mb-4\">\r\n              <AvatarFallback className=\"bg-selected text-primary\">\r\n                <Robot size={24} weight=\"fill\" />\r\n              </AvatarFallback>\r\n            </Avatar>\r\n            <h3 className=\"text-base font-semibold text-foreground mb-1\">\r\n              {t(\"aiWelcome\")}\r\n            </h3>\r\n            <p className=\"text-sm text-muted-foreground max-w-xs\">\r\n              {t(\"aiDescription\")}\r\n            </p>\r\n            <div className=\"mt-4 flex flex-wrap gap-2 justify-center\">\n              {[t(\"aiSuggestionOne\"), t(\"aiSuggestionTwo\"), t(\"aiSuggestionThree\")].map((suggestion) => (\n                <button\n                  key={suggestion}\n                  type=\"button\"\n                  onClick={() => {\n                    clearError?.()\n                    setInput(suggestion)\n                    inputRef.current?.focus()\n                  }}\n                  className=\"px-3 py-1.5 text-xs bg-surface-subtle hover:bg-hover active:bg-active rounded-full text-muted-foreground hover:text-foreground transition-colors\"\n                >\n                  {suggestion}\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n        ) : (\r\n          <div className=\"p-4 space-y-4\">\r\n            {messages.map((message) => {\r\n              const isUser = message.role === \"user\"\r\n              const listings = extractListings(message.parts as Array<{ type: string; toolName?: string; output?: unknown }>)\r\n              \r\n              return (\r\n                <div key={message.id} className={cn(\"flex gap-3\", isUser ? \"justify-end\" : \"justify-start\")}>\n                  {!isUser && <AssistantAvatar size=\"sm\" />}\n                  \n                  <div className={cn(\n                    \"flex flex-col gap-2 max-w-sm sm:max-w-md\",\n                    isUser ? \"items-end\" : \"items-start\"\n                  )}>\n                    {/* Text parts */}\r\n                    {message.parts.map((part, i) => {\r\n                      if (part.type === \"text\" && part.text) {\r\n                        return (\r\n                          <div\r\n                            key={`${message.id}-${i}`}\r\n                            className={cn(\r\n                              \"px-3 py-2 rounded-2xl text-sm\",\r\n                              isUser\r\n                                ? \"bg-primary text-primary-foreground rounded-br-md\"\r\n                                : \"bg-muted text-foreground rounded-bl-md\"\r\n                            )}\r\n                          >\r\n                            {part.text}\r\n                          </div>\r\n                        )\r\n                      }\r\n                      return null\r\n                    })}\r\n\r\n                    {/* Product listings */}\r\n                    {listings.length > 0 && (\r\n                      <div className=\"flex gap-2 overflow-x-auto pb-1 -mx-1 px-1\">\r\n                        {listings.slice(0, 4).map((listing) => (\r\n                          <button\r\n                            key={listing.id}\r\n                            type=\"button\"\r\n                            onClick={() => handleProductClick(listing)}\r\n                            className=\"shrink-0 w-28 text-left group\"\r\n                          >\r\n                            <div className=\"w-28 h-28 bg-muted rounded-lg overflow-hidden ring-1 ring-border\">\r\n                              {listing.image ? (\r\n                                <Image\r\n                                  src={listing.image}\r\n                                  alt={listing.title}\r\n                                  width={112}\r\n                                  height={112}\r\n                                  className=\"w-full h-full object-cover\"\r\n                                />\r\n                              ) : (\r\n                                <div className=\"w-full h-full flex items-center justify-center\">\r\n                                  <Package size={24} className=\"text-muted-foreground\" />\r\n                                </div>\r\n                              )}\r\n                            </div>\r\n                            <p className=\"mt-1 text-xs text-foreground line-clamp-2 group-hover:text-primary\">\r\n                              {listing.title}\r\n                            </p>\r\n                            <p className=\"text-xs font-semibold text-price-sale\">\r\n                              {formatPrice(listing.price, { locale })}\r\n                            </p>\r\n                          </button>\r\n                        ))}\r\n                        {listings.length > 4 && (\n                          <Link\n                            href={`/search?q=${encodeURIComponent(input)}`}\n                            onClick={() => onClose?.()}\n                            className=\"shrink-0 w-28 h-28 flex flex-col items-center justify-center bg-surface-subtle rounded-lg text-muted-foreground hover:text-foreground hover:bg-hover active:bg-active\"\n                          >\n                            <ArrowRight size={20} />\n                            <span className=\"text-xs mt-1\">{t(\"aiMoreResults\", { count: listings.length - 4 })}</span>\n                          </Link>\n                        )}\n                      </div>\n                    )}\n                  </div>\n\n                  {isUser && <UserChatAvatar size=\"sm\" label={t(\"aiUserLabel\")} />}\n                </div>\n              )\n            })}\n\n            {/* Loading indicator */}\n            {isLoading && (\n              <div className=\"flex gap-3\">\r\n                <AssistantAvatar size=\"sm\" />\r\n                <div className=\"px-3 py-2 rounded-2xl rounded-bl-md bg-muted\">\r\n                  <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\r\n                    <CircleNotch size={14} className=\"animate-spin\" />\r\n                    {t(\"aiThinking\")}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\n\n            {/* Error state */}\n            {error && (\n              <div className=\"rounded-lg border border-border bg-card p-3\">\n                <p className=\"text-sm font-medium text-foreground\">{t(\"aiErrorTitle\")}</p>\n                <p className=\"mt-1 text-sm text-muted-foreground\">{t(\"aiErrorDescription\")}</p>\n                <div className=\"mt-3 flex items-center justify-end gap-2\">\n                  <Button\n                    type=\"button\"\n                    variant=\"secondary\"\n                    size=\"sm\"\n                    onClick={() => {\n                      clearError?.()\n                      void regenerate?.()\n                    }}\n                  >\n                    {t(\"aiRetry\")}\n                  </Button>\n                </div>\n              </div>\n            )}\n\n            <div ref={messagesEndRef} />\n          </div>\n        )}\n      </div>\n\n      {/* Input */}\n      <form onSubmit={handleSubmit} className=\"shrink-0 p-3 border-t border-border bg-background\">\n        <div className=\"flex items-center gap-2\">\n          <Input\n            ref={inputRef}\n            type=\"text\"\n            value={input}\n            onChange={(e) => setInput(e.target.value)}\n            placeholder={t(\"aiPlaceholder\")}\n            className=\"flex-1 h-10 rounded-full\"\n            disabled={isLoading}\n          />\n          <Button\n            type=\"submit\"\n            size=\"icon\"\n            disabled={!input.trim() || isLoading}\n            className=\"shrink-0 rounded-full\"\n            aria-label={t(\"sendMessage\")}\n          >\n            {isLoading ? (\r\n              <CircleNotch size={18} className=\"animate-spin\" />\r\n            ) : (\r\n              <PaperPlaneRight size={18} weight=\"fill\" />\r\n            )}\r\n          </Button>\r\n        </div>\r\n        {isLoading && (\r\n          <button\r\n            type=\"button\"\r\n            onClick={() => stop?.()}\r\n            className=\"mt-2 text-xs text-muted-foreground hover:text-foreground w-full text-center\"\r\n          >\r\n            {t(\"stopGenerating\")}\r\n          </button>\r\n        )}\r\n      </form>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\search\\search-context.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\search\\search-filters.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_brands' is assigned a value but never used.","line":62,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":62,"endColumn":18},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'categories' and 'expandedCategories'. Either include them or remove the dependency array.","line":111,"column":6,"nodeType":"ArrayExpression","endLine":111,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [categories, currentCategory, expandedCategories]","fix":{"range":[3761,3778],"text":"[categories, currentCategory, expandedCategories]"}}]},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'isValidCategory' to the outer scope.","line":223,"column":43,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":223,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useSearchParams } from \"next/navigation\"\r\nimport { useRouter } from \"@/i18n/routing\"\r\nimport { Checkbox } from \"@/components/ui/checkbox\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Star, CaretDown, CaretRight, Check, Package, MapPin, Crosshair } from \"@phosphor-icons/react\"\r\nimport { useLocale, useTranslations } from \"next-intl\"\r\nimport { Link } from \"@/i18n/routing\"\r\nimport { useState, useEffect, useCallback } from \"react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport {\r\n  Accordion,\r\n  AccordionContent,\r\n  AccordionItem,\r\n  AccordionTrigger,\r\n} from \"@/components/ui/accordion\"\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\"\r\nimport { CategoryBreadcrumbTrail } from \"@/components/category/category-breadcrumb-trail\"\r\nimport { BULGARIAN_CITIES } from \"@/lib/bulgarian-cities\"\r\n\r\ninterface Category {\r\n  id: string\r\n  name: string\r\n  name_bg: string | null\r\n  slug: string\r\n  parent_id: string | null\r\n  image_url?: string | null\r\n}\r\n\r\ninterface BreadcrumbCategory {\r\n  slug: string\r\n  name: string\r\n  name_bg: string | null\r\n}\r\n\r\ninterface SearchFiltersProps {\r\n  categories: Category[]\r\n  subcategories: Category[]\r\n  currentCategory: Category | null\r\n  parentCategory?: Category | null\r\n  allCategoriesWithSubs?: { category: Category; subs: Category[] }[]\r\n  brands?: string[]\r\n  basePath?: string // e.g., \"/categories/electronics\" or undefined for \"/search\"\r\n  /** Full ancestry chain from L0 to current category (for breadcrumb display) */\r\n  ancestry?: BreadcrumbCategory[]\r\n}\r\n\r\nexport function SearchFilters({ \r\n  categories, \r\n  subcategories, \r\n  currentCategory,\r\n  parentCategory,\r\n  allCategoriesWithSubs = [],\r\n  brands: _brands = [],\r\n  basePath,\r\n  ancestry = []\r\n}: SearchFiltersProps) {\n  const router = useRouter()\n  const searchParams = useSearchParams()\n  const locale = useLocale()\n  const t = useTranslations('SearchFilters')\n  const tCommon = useTranslations(\"Common\")\n\r\n  const currentMinPrice = searchParams.get(\"minPrice\")\r\n  const currentMaxPrice = searchParams.get(\"maxPrice\")\r\n  const currentRating = searchParams.get(\"minRating\")\r\n  const currentBrand = searchParams.get(\"brand\")\r\n  const currentAvailability = searchParams.get(\"availability\")\r\n  const currentCity = searchParams.get(\"city\")\r\n  const currentNearby = searchParams.get(\"nearby\") === \"true\"\r\n  \r\n  // Price input state (controlled inputs that sync with URL)\r\n  const [priceMin, setPriceMin] = useState(currentMinPrice ?? \"\")\r\n  const [priceMax, setPriceMax] = useState(currentMaxPrice ?? \"\")\r\n  \r\n  // Sync price inputs with URL on mount/change\r\n  useEffect(() => {\r\n    setPriceMin(currentMinPrice ?? \"\")\r\n    setPriceMax(currentMaxPrice ?? \"\")\r\n  }, [currentMinPrice, currentMaxPrice])\r\n  \r\n  // Track expanded categories\r\n  const [expandedCategories, setExpandedCategories] = useState<string[]>([])\r\n  // Track if \"All Categories\" is expanded (for context-aware view)\r\n  const [showAllCategories, setShowAllCategories] = useState(false)\r\n  \r\n  // Auto-expand current category\r\n  useEffect(() => {\r\n    if (currentCategory) {\r\n      // If we're in a subcategory, expand its parent\r\n      if (currentCategory.parent_id) {\r\n        const parentSlug = categories.find(c => c.id === currentCategory.parent_id)?.slug\r\n        if (parentSlug && !expandedCategories.includes(parentSlug)) {\r\n          setExpandedCategories(prev => [...prev, parentSlug])\r\n        }\r\n      } else {\r\n        // If we're in a main category, expand it\r\n        if (!expandedCategories.includes(currentCategory.slug)) {\r\n          setExpandedCategories(prev => [...prev, currentCategory.slug])\r\n        }\r\n      }\r\n    }\r\n  }, [currentCategory])\r\n\r\n  const toggleCategory = (slug: string) => {\r\n    setExpandedCategories(prev => \r\n      prev.includes(slug) \r\n        ? prev.filter(s => s !== slug)\r\n        : [...prev, slug]\r\n    )\r\n  }\r\n\r\n  const getCategoryName = (cat: Category) => {\r\n    if (locale === 'bg' && cat.name_bg) {\r\n      return cat.name_bg\r\n    }\r\n    return cat.name\r\n  }\r\n\r\n  const updateParams = (key: string, value: string | null) => {\r\n    const params = new URLSearchParams(searchParams.toString())\r\n    if (value === null) {\r\n      params.delete(key)\r\n    } else {\r\n      params.set(key, value)\r\n    }\r\n    if (basePath) {\r\n      router.push(`${basePath}?${params.toString()}`)\r\n    } else {\r\n      router.push(`/search?${params.toString()}`)\r\n    }\r\n  }\r\n\r\n  const handlePriceClick = (min: string | null, max: string | null) => {\r\n    const params = new URLSearchParams(searchParams.toString())\r\n    if (min) params.set(\"minPrice\", min)\r\n    else params.delete(\"minPrice\")\r\n\r\n    if (max) params.set(\"maxPrice\", max)\r\n    else params.delete(\"maxPrice\")\r\n\r\n    if (basePath) {\r\n      router.push(`${basePath}?${params.toString()}`)\r\n    } else {\r\n      router.push(`/search?${params.toString()}`)\r\n    }\r\n  }\r\n  \r\n  // Apply price from min/max inputs\r\n  const applyPriceInputs = useCallback(() => {\r\n    const params = new URLSearchParams(searchParams.toString())\r\n    if (priceMin && priceMin !== \"0\") params.set(\"minPrice\", priceMin)\r\n    else params.delete(\"minPrice\")\r\n    if (priceMax && priceMax !== \"0\") params.set(\"maxPrice\", priceMax)\r\n    else params.delete(\"maxPrice\")\r\n    \r\n    if (basePath) {\r\n      router.push(`${basePath}?${params.toString()}`)\r\n    } else {\r\n      router.push(`/search?${params.toString()}`)\r\n    }\r\n  }, [priceMin, priceMax, searchParams, basePath, router])\r\n  \r\n  // Handle location changes\r\n  const handleCityChange = useCallback((city: string | null) => {\r\n    const params = new URLSearchParams(searchParams.toString())\r\n    if (city && city !== \"all\") {\r\n      params.set(\"city\", city)\r\n    } else {\r\n      params.delete(\"city\")\r\n    }\r\n    if (basePath) {\r\n      router.push(`${basePath}?${params.toString()}`)\r\n    } else {\r\n      router.push(`/search?${params.toString()}`)\r\n    }\r\n  }, [searchParams, basePath, router])\r\n  \r\n  const toggleNearby = useCallback(() => {\r\n    const params = new URLSearchParams(searchParams.toString())\r\n    if (currentNearby) {\r\n      params.delete(\"nearby\")\r\n    } else {\r\n      params.set(\"nearby\", \"true\")\r\n    }\r\n    if (basePath) {\r\n      router.push(`${basePath}?${params.toString()}`)\r\n    } else {\r\n      router.push(`/search?${params.toString()}`)\r\n    }\r\n  }, [currentNearby, searchParams, basePath, router])\r\n\r\n  const clearAllFilters = () => {\r\n    if (basePath) {\r\n      router.push(basePath)\r\n    } else {\r\n      const params = new URLSearchParams()\r\n      const category = searchParams.get(\"category\")\r\n      const q = searchParams.get(\"q\")\r\n      if (category) params.set(\"category\", category)\r\n      if (q) params.set(\"q\", q)\r\n      router.push(`/search?${params.toString()}`)\r\n    }\r\n  }\r\n\r\n  const hasActiveFilters = currentMinPrice || currentMaxPrice || currentRating || currentBrand || currentAvailability || currentCity || currentNearby\r\n\r\n  // Get subcategories for a given category from allCategoriesWithSubs\r\n  const getSubcategoriesFor = (categoryId: string) => {\r\n    const found = allCategoriesWithSubs.find(c => c.category.id === categoryId)\r\n    return found?.subs || []\r\n  }\r\n\r\n  // Filter out deprecated/moved categories\r\n  const isValidCategory = (cat: Category) => {\r\n    const name = cat.name.toLowerCase()\r\n    return !name.includes('[deprecated]') && \r\n           !name.includes('[moved]') && \r\n           !name.includes('[duplicate]')\r\n  }\r\n\r\n  // Filter categories and subcategories\r\n  const validCategories = categories.filter(isValidCategory)\r\n  const validSubcategories = subcategories.filter(isValidCategory)\r\n\r\n  return (\r\n    <div className=\"text-sidebar-foreground\">\r\n      {/* ================================================================\r\n          SECTION 1: Category Navigation with Breadcrumb Trail\r\n          ================================================================ */}\r\n      <div className=\"pb-4\">\r\n        {/* Context-aware navigation */}\r\n        {currentCategory ? (\r\n          <>\r\n            {/* Breadcrumb trail - shows full hierarchy when available */}\r\n            {ancestry.length > 1 ? (\r\n              <CategoryBreadcrumbTrail ancestry={ancestry} className=\"mb-4\" />\r\n            ) : (\r\n              /* Fallback: Back link to parent or show all categories toggle */\r\n              parentCategory ? (\r\n                <Link\n                  href={`/categories/${parentCategory.slug}`}\n                  className=\"text-sm text-muted-foreground hover:text-primary hover:underline min-h-11 flex items-center gap-1 mb-2\"\n                >\n                  <CaretRight size={14} weight=\"bold\" className=\"rotate-180\" />\n                  {getCategoryName(parentCategory)}\n                </Link>\n              ) : (\n                <button\n                  onClick={() => setShowAllCategories(!showAllCategories)}\n                  className=\"text-sm text-muted-foreground hover:text-primary min-h-11 flex items-center gap-1 w-full mb-2\"\n                >\n                  <CaretRight size={14} weight=\"bold\" className={showAllCategories ? \"rotate-90\" : \"rotate-180\"} />\n                  <span className=\"hover:underline\">\n                    {tCommon(\"allCategories\")}\n                  </span>\n                </button>\n              )\n            )}\n            \r\n            {/* Show all L0 categories when expanded (only when no ancestry) */}\r\n            {showAllCategories && !parentCategory && ancestry.length <= 1 && (\r\n              <div className=\"ml-2 mb-3 space-y-0.5 pl-3 py-1\">\r\n                {validCategories.map((cat) => (\r\n                  <Link\n                    key={cat.id}\n                    href={`/categories/${cat.slug}`}\n                    className={`text-sm cursor-pointer min-h-11 flex items-center px-2 -mx-2 rounded-md transition-colors ${\n                      cat.id === currentCategory.id \n                        ? 'font-semibold text-sidebar-foreground bg-sidebar-accent' \n                        : 'text-sidebar-muted-foreground hover:bg-sidebar-accent hover:text-sidebar-accent-foreground'\n                    }`}\n                  >\n                    {getCategoryName(cat)}\n                  </Link>\n                ))}\r\n              </div>\r\n            )}\r\n            \r\n            {/* Subcategories section header */}\r\n            {validSubcategories.length > 0 && (\n              <>\n                <h3 className=\"text-xs font-semibold text-sidebar-muted-foreground uppercase tracking-wide mb-2 mt-4\">\n                  {t(\"subcategories\")}\n                </h3>\n                <nav className=\"space-y-0.5\">\n                  {validSubcategories.map((subcat) => (\n                    <Link\n                      key={subcat.id}\n                      href={`/categories/${subcat.slug}`}\n                      className=\"text-sm cursor-pointer text-sidebar-muted-foreground hover:text-sidebar-accent-foreground hover:bg-sidebar-accent min-h-11 flex items-center px-2 -mx-2 rounded-md transition-colors\"\n                    >\n                      {getCategoryName(subcat)}\n                    </Link>\n                  ))}\n                </nav>\n              </>\r\n            )}\r\n          </>\r\n        ) : (\r\n          /* Full category list for search page */\r\n          <>\r\n            <h3 className=\"font-semibold text-base mb-3 text-sidebar-foreground\">{t('department')}</h3>\r\n            <nav className=\"space-y-0.5\">\r\n              {validCategories.map((cat) => {\r\n                const isExpanded = expandedCategories.includes(cat.slug)\r\n                const catSubs = allCategoriesWithSubs.length > 0 \r\n                  ? getSubcategoriesFor(cat.id).filter(isValidCategory)\r\n                  : []\r\n                const hasSubs = catSubs.length > 0\r\n                \r\n                return (\r\n                  <div key={cat.id}>\r\n                    <div className=\"flex items-center justify-between group\">\r\n                      <Link\n                        href={`/categories/${cat.slug}`}\n                        className=\"text-sm cursor-pointer hover:text-sidebar-accent-foreground flex-1 min-h-11 flex items-center text-sidebar-foreground\"\n                      >\n                        {getCategoryName(cat)}\n                      </Link>\n                      {hasSubs && (\n                        <button\n                          onClick={(e) => {\r\n                            e.preventDefault()\r\n                            toggleCategory(cat.slug)\n                          }}\n                          className=\"size-11 flex items-center justify-center hover:bg-sidebar-accent rounded-md transition-colors\"\n                          aria-label={\n                            isExpanded\n                              ? t(\"collapseSubcategories\", { category: getCategoryName(cat) })\n                              : t(\"expandSubcategories\", { category: getCategoryName(cat) })\n                          }\n                          aria-expanded={isExpanded}\n                        >\n                          {isExpanded ? (\n                            <CaretDown size={16} weight=\"regular\" className=\"text-sidebar-muted-foreground\" aria-hidden=\"true\" />\n                          ) : (\n                            <CaretRight size={16} weight=\"regular\" className=\"text-sidebar-muted-foreground\" aria-hidden=\"true\" />\r\n                          )}\r\n                        </button>\r\n                      )}\r\n                    </div>\r\n                    \r\n                    {/* Subcategories */}\r\n                    {isExpanded && hasSubs && (\r\n                      <div className=\"ml-3 mt-1 space-y-0.5 pl-3\">\r\n                        {catSubs.map((subcat) => (\r\n                          <Link\n                            key={subcat.id}\n                            href={`/categories/${subcat.slug}`}\n                            className=\"text-sm cursor-pointer min-h-11 flex items-center px-2 -mx-2 rounded-md text-sidebar-muted-foreground hover:bg-sidebar-accent hover:text-sidebar-accent-foreground transition-colors\"\n                          >\n                            {getCategoryName(subcat)}\n                          </Link>\n                        ))}\n                      </div>\n                    )}\r\n                  </div>\r\n                )\r\n              })}\r\n            </nav>\r\n          </>\r\n        )}\r\n      </div>\r\n\r\n      {/* ================================================================\r\n          SECTION 2-4: Filters using Accordion (cleaner UI)\r\n          ================================================================ */}\r\n      <Accordion type=\"multiple\" defaultValue={[\"reviews\", \"price\", \"location\", \"availability\"]} className=\"w-full mt-4\">\r\n        {/* Customer Reviews */}\r\n        <AccordionItem value=\"reviews\" className=\"border-b-0\">\r\n          <AccordionTrigger className=\"py-3 text-sm font-semibold text-sidebar-foreground hover:no-underline hover:text-sidebar-accent-foreground\">\r\n            {t('customerReviews')}\r\n          </AccordionTrigger>\r\n          <AccordionContent className=\"pb-2\">\r\n            <div className=\"space-y-0.5\">\r\n              {[4, 3, 2, 1].map((stars) => {\r\n                const isActive = currentRating === stars.toString()\r\n                return (\r\n                  <button\r\n                    key={stars}\r\n                    className={cn(\r\n                      \"w-full flex items-center gap-2 py-2 px-2 -mx-2 rounded-md transition-colors\",\r\n                      isActive\r\n                        ? \"bg-sidebar-accent text-sidebar-accent-foreground font-medium\"\r\n                        : \"hover:bg-sidebar-muted text-sidebar-foreground\"\r\n                    )}\r\n                    onClick={() => updateParams(\"minRating\", isActive ? null : stars.toString())}\r\n                  >\r\n                    <div className=\"flex text-rating\">\r\n                      {[...Array(5)].map((_, i) => (\r\n                        <Star\r\n                          key={i}\r\n                          size={16}\r\n                          weight={i < stars ? \"fill\" : \"regular\"}\r\n                        />\r\n                      ))}\r\n                    </div>\r\n                    <span className=\"text-sm\">{t('andUp')}</span>\r\n                    {isActive && (\r\n                      <Check size={16} weight=\"regular\" className=\"ml-auto text-primary\" />\r\n                    )}\r\n                  </button>\r\n                )\r\n              })}\r\n            </div>\r\n          </AccordionContent>\r\n        </AccordionItem>\r\n\r\n        {/* Price - Min/Max inputs */}\r\n        <AccordionItem value=\"price\" className=\"border-b-0\">\r\n          <AccordionTrigger className=\"py-3 text-sm font-semibold text-sidebar-foreground hover:no-underline hover:text-sidebar-accent-foreground\">\r\n            {t('price')}\r\n          </AccordionTrigger>\r\n          <AccordionContent className=\"pb-2\">\r\n            <div className=\"space-y-3\">\r\n              {/* Min/Max input row */}\r\n              <div className=\"flex items-center gap-2\">\r\n                <div className=\"flex-1\">\r\n                  <Input\n                    type=\"number\"\n                    placeholder={t('min')}\n                    value={priceMin}\n                    onChange={(e) => setPriceMin(e.target.value)}\n                    onKeyDown={(e) => e.key === \"Enter\" && applyPriceInputs()}\n                    className=\"text-sm\"\n                    min={0}\n                  />\n                </div>\n                <span className=\"text-muted-foreground text-sm\">ΓÇô</span>\n                <div className=\"flex-1\">\n                  <Input\n                    type=\"number\"\n                    placeholder={t('max')}\n                    value={priceMax}\n                    onChange={(e) => setPriceMax(e.target.value)}\n                    onKeyDown={(e) => e.key === \"Enter\" && applyPriceInputs()}\n                    className=\"text-sm\"\n                    min={0}\n                  />\n                </div>\n                <Button\n                  size=\"default\"\n                  variant=\"secondary\"\n                  onClick={applyPriceInputs}\n                  className=\"px-3\"\n                >\n                  {t('go')}\n                </Button>\n              </div>\n              \r\n              {/* Quick price presets */}\r\n              <div className=\"flex flex-wrap gap-1.5\">\r\n                {[\r\n                  { label: locale === \"bg\" ? \"╨ƒ╨╛╨┤ 25\" : \"Under 25\", min: null, max: \"25\" },\r\n                  { label: \"25-50\", min: \"25\", max: \"50\" },\r\n                  { label: \"50-100\", min: \"50\", max: \"100\" },\r\n                  { label: \"100-200\", min: \"100\", max: \"200\" },\r\n                  { label: locale === \"bg\" ? \"╨¥╨░╨┤ 200\" : \"200+\", min: \"200\", max: null }\r\n                ].map(({ label, min, max }) => {\r\n                  const isActive = currentMinPrice === min && currentMaxPrice === max\r\n                  return (\r\n                    <button\r\n                      key={label}\r\n                      className={cn(\r\n                        \"px-2.5 py-1 rounded-md text-xs font-medium transition-colors\",\r\n                        isActive\r\n                          ? \"bg-primary text-primary-foreground\"\r\n                          : \"bg-sidebar-accent text-sidebar-accent-foreground hover:bg-sidebar-muted\"\r\n                      )}\r\n                      onClick={() => handlePriceClick(min, max)}\r\n                    >\r\n                      {label}\r\n                    </button>\r\n                  )\r\n                })}\r\n              </div>\r\n            </div>\r\n          </AccordionContent>\r\n        </AccordionItem>\r\n        \r\n        {/* Location */}\r\n        <AccordionItem value=\"location\" className=\"border-b-0\">\r\n          <AccordionTrigger className=\"py-3 text-sm font-semibold text-sidebar-foreground hover:no-underline hover:text-sidebar-accent-foreground\">\r\n            {t('location')}\r\n          </AccordionTrigger>\r\n          <AccordionContent className=\"pb-2\">\r\n            <div className=\"space-y-3\">\r\n              {/* City selector */}\r\n              <Select\r\n                value={currentCity ?? \"all\"}\n                onValueChange={(value) => handleCityChange(value === \"all\" ? null : value)}\n              >\n                <SelectTrigger className=\"w-full\">\n                  <SelectValue placeholder={t('selectCity')} />\n                </SelectTrigger>\n                <SelectContent className=\"max-h-64\">\n                  <SelectItem value=\"all\">\n                    <span className=\"flex items-center gap-2\">\n                      <MapPin size={14} weight=\"regular\" />\r\n                      {t('anyLocation')}\r\n                    </span>\r\n                  </SelectItem>\r\n                  {BULGARIAN_CITIES.filter(c => c.value !== \"other\").map((city) => (\r\n                    <SelectItem key={city.value} value={city.value}>\r\n                      {locale === \"bg\" ? city.labelBg : city.label}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n              \r\n              {/* Nearby toggle */}\r\n              <label\r\n                htmlFor=\"nearby\"\n                className={cn(\n                  \"flex min-h-11 items-center gap-3 px-2 -mx-2 rounded-md cursor-pointer transition-colors\",\n                  currentNearby\n                    ? \"bg-sidebar-accent text-sidebar-accent-foreground\"\n                    : \"hover:bg-sidebar-muted text-sidebar-foreground\"\n                )}\n              >\n                <Checkbox\n                  id=\"nearby\"\n                  checked={currentNearby}\n                  onCheckedChange={toggleNearby}\n                />\n                <span className=\"text-sm flex items-center gap-1.5\">\n                  <Crosshair size={16} weight=\"regular\" className=\"text-primary\" />\n                  {t('nearMe')}\n                </span>\n              </label>\n            </div>\r\n          </AccordionContent>\r\n        </AccordionItem>\r\n\r\n        {/* Availability */}\r\n        <AccordionItem value=\"availability\" className=\"border-b-0\">\r\n          <AccordionTrigger className=\"py-3 text-sm font-semibold text-sidebar-foreground hover:no-underline hover:text-sidebar-accent-foreground\">\r\n            {t('availability')}\r\n          </AccordionTrigger>\r\n          <AccordionContent className=\"pb-2\">\r\n            <label\r\n              htmlFor=\"instock\"\n              className={cn(\n                \"flex min-h-11 items-center gap-3 px-2 -mx-2 rounded-md cursor-pointer transition-colors\",\n                currentAvailability === \"instock\"\n                  ? \"bg-sidebar-accent text-sidebar-accent-foreground\"\n                  : \"hover:bg-sidebar-muted text-sidebar-foreground\"\n              )}\n            >\n              <Checkbox\n                id=\"instock\"\n                checked={currentAvailability === \"instock\"}\n                onCheckedChange={() => updateParams(\"availability\", currentAvailability === \"instock\" ? null : \"instock\")}\n              />\n              <span className=\"text-sm flex items-center gap-1.5\">\n                <Package size={16} weight=\"regular\" className=\"text-stock-available\" />\n                {t('includeOutOfStock')}\n              </span>\n            </label>\n          </AccordionContent>\r\n        </AccordionItem>\r\n      </Accordion>\r\n\r\n      {/* Clear All Filters Button - Show at bottom when filters are active */}\r\n        {hasActiveFilters && (\n          <div className=\"pt-4 mt-2\">\n            <button\n              onClick={clearAllFilters}\n              className=\"w-full min-h-11 text-sm text-center text-sidebar-primary hover:underline font-medium\"\n            >\n              {t('clearAllFilters')}\n            </button>\n          </div>\n        )}\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\search\\search-pagination.tsx","messages":[{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":52,"column":42,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":52,"endColumn":59}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useTranslations } from \"next-intl\"\nimport { useLocale } from \"next-intl\"\nimport { useSearchParams } from \"next/navigation\"\nimport { usePathname } from \"@/i18n/routing\"\nimport {\r\n  Pagination,\r\n  PaginationContent,\r\n  PaginationEllipsis,\r\n  PaginationItem,\r\n  PaginationLink,\r\n  PaginationNext,\r\n  PaginationPrevious,\r\n} from \"@/components/ui/pagination\"\r\n\r\ninterface SearchPaginationProps {\r\n  totalItems: number\r\n  itemsPerPage?: number\r\n  currentPage: number\r\n}\r\n\r\nexport function SearchPagination({ \r\n  totalItems, \r\n  itemsPerPage = 20, \r\n  currentPage \r\n}: SearchPaginationProps) {\n  const tCommon = useTranslations(\"Common\")\n  const locale = useLocale()\n  const pathname = usePathname()\n  const searchParams = useSearchParams()\n  \r\n  const totalPages = Math.ceil(totalItems / itemsPerPage)\r\n  \r\n  // Don't render if only one page\r\n  if (totalPages <= 1) return null\r\n  \r\n  // Build URL with page param\r\n  const buildPageUrl = (page: number) => {\n    const params = new URLSearchParams(searchParams.toString())\n    if (page === 1) {\n      params.delete(\"page\")\n    } else {\n      params.set(\"page\", page.toString())\n    }\n    const queryString = params.toString()\n\n    const localePath = pathname.startsWith(`/${locale}`)\n      ? pathname\n      : `/${locale}${pathname === \"/\" ? \"\" : pathname}`\n\n    return `${localePath}${queryString ? `?${queryString}` : \"\"}`\n  }\n  \r\n  // Generate page numbers to show\r\n  const getPageNumbers = () => {\r\n    const pages: (number | 'ellipsis')[] = []\r\n    const showPages = 5 // Max pages to show\r\n    \r\n    if (totalPages <= showPages) {\r\n      // Show all pages if total is small\r\n      for (let i = 1; i <= totalPages; i++) {\r\n        pages.push(i)\r\n      }\r\n    } else {\r\n      // Always show first page\r\n      pages.push(1)\r\n      \r\n      if (currentPage > 3) {\r\n        pages.push('ellipsis')\r\n      }\r\n      \r\n      // Show pages around current\r\n      const start = Math.max(2, currentPage - 1)\r\n      const end = Math.min(totalPages - 1, currentPage + 1)\r\n      \r\n      for (let i = start; i <= end; i++) {\r\n        if (!pages.includes(i)) {\r\n          pages.push(i)\r\n        }\r\n      }\r\n      \r\n      if (currentPage < totalPages - 2) {\r\n        pages.push('ellipsis')\r\n      }\r\n      \r\n      // Always show last page\r\n      if (!pages.includes(totalPages)) {\r\n        pages.push(totalPages)\r\n      }\r\n    }\r\n    \r\n    return pages\r\n  }\r\n  \r\n  const pageNumbers = getPageNumbers()\r\n  const hasPrev = currentPage > 1\r\n  const hasNext = currentPage < totalPages\r\n\r\n  return (\r\n    <Pagination className=\"mt-8\" aria-label={tCommon(\"pagination\")}>\r\n      <PaginationContent>\r\n        {/* Previous */}\r\n        <PaginationItem>\r\n          {hasPrev ? (\r\n            <PaginationPrevious\r\n              href={buildPageUrl(currentPage - 1)}\r\n              label={tCommon(\"previous\")}\r\n              ariaLabel={tCommon(\"goToPreviousPage\")}\r\n            />\r\n          ) : (\r\n            <PaginationPrevious \n              href=\"#\" \n              className=\"pointer-events-none text-muted-foreground\" \n              aria-disabled=\"true\"\n              label={tCommon(\"previous\")}\n              ariaLabel={tCommon(\"goToPreviousPage\")}\n            />\n          )}\r\n        </PaginationItem>\r\n        \r\n        {/* Page Numbers */}\r\n        {pageNumbers.map((page, index) => (\r\n          <PaginationItem key={index}>\r\n            {page === 'ellipsis' ? (\r\n              <PaginationEllipsis label={tCommon(\"morePages\")} />\r\n            ) : (\r\n              <PaginationLink \r\n                href={buildPageUrl(page)} \r\n                isActive={page === currentPage}\r\n              >\r\n                {page}\r\n              </PaginationLink>\r\n            )}\r\n          </PaginationItem>\r\n        ))}\r\n        \r\n        {/* Next */}\r\n        <PaginationItem>\r\n          {hasNext ? (\r\n            <PaginationNext\r\n              href={buildPageUrl(currentPage + 1)}\r\n              label={tCommon(\"next\")}\r\n              ariaLabel={tCommon(\"goToNextPage\")}\r\n            />\r\n          ) : (\r\n            <PaginationNext \n              href=\"#\" \n              className=\"pointer-events-none text-muted-foreground\" \n              aria-disabled=\"true\"\n              label={tCommon(\"next\")}\n              ariaLabel={tCommon(\"goToNextPage\")}\n            />\n          )}\r\n        </PaginationItem>\r\n      </PaginationContent>\r\n    </Pagination>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\search\\sort-select.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CaretDown' is defined but never used.","line":3,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":19,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"CaretDown"},"fix":{"range":[25,35],"text":""},"desc":"Remove unused variable \"CaretDown\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { CaretDown, ArrowsDownUp } from \"@phosphor-icons/react\"\r\nimport { useTranslations } from \"next-intl\"\nimport { useSearchParams } from \"next/navigation\"\r\nimport { usePathname, useRouter } from \"@/i18n/routing\"\r\nimport { useCallback } from \"react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\"\r\n\r\nexport function SortSelect() {\r\n  const t = useTranslations('SearchFilters')\r\n  const router = useRouter()\n  const pathname = usePathname()\n  const searchParams = useSearchParams()\n\n  const normalizedPathname = (() => {\n    const segments = pathname.split('/').filter(Boolean)\n    const maybeLocale = segments[0]\n    if (maybeLocale && /^[a-z]{2}(-[A-Z]{2})?$/i.test(maybeLocale)) {\n      segments.shift()\n    }\n    return `/${segments.join('/')}` || '/'\n  })()\n  \r\n  // Get current sort from URL, default to \"featured\"\r\n  const currentSort = searchParams.get('sort') || 'featured'\r\n  \r\n  // Handle sort change\r\n  const handleSortChange = useCallback((value: string) => {\r\n    const params = new URLSearchParams(searchParams.toString())\r\n    \r\n    if (value === 'featured') {\r\n      params.delete('sort')\r\n    } else {\r\n      params.set('sort', value)\r\n    }\r\n    \r\n    const queryString = params.toString()\r\n    router.push(queryString ? `${normalizedPathname}?${queryString}` : normalizedPathname)\r\n  }, [router, normalizedPathname, searchParams])\r\n\r\n  const isSorted = currentSort !== 'featured'\r\n\r\n  return (\n    <Select value={currentSort} onValueChange={handleSortChange}>\n      <SelectTrigger \n        size=\"default\"\n        className={cn(\n          \"px-3 w-full rounded-lg gap-2\",\n          \"bg-surface-subtle hover:bg-hover hover:text-foreground border border-border/40\",\n          \"active:bg-active\",\n          isSorted && \"bg-selected text-primary border-selected-border\",\n          \"text-xs font-medium text-foreground\",\n          \"focus:ring-2 focus:ring-offset-1 focus:ring-ring\",\n          \"[&_svg[data-slot=select-icon]]:size-3\"\n        )}\n        aria-label={t('sortBy')}\n      >\n        <ArrowsDownUp size={14} weight=\"regular\" className={cn(\r\n          isSorted ? \"text-primary\" : \"text-muted-foreground\",\r\n          \"shrink-0\"\r\n        )} aria-hidden=\"true\" />\r\n        <SelectValue placeholder={t('sortBy')} />\r\n      </SelectTrigger>\r\n      <SelectContent className=\"rounded-lg border-border\">\r\n        <SelectItem value=\"featured\" className=\"rounded-md\">{t('featured')}</SelectItem>\r\n        <SelectItem value=\"price-asc\" className=\"rounded-md\">{t('priceLowHigh')}</SelectItem>\r\n        <SelectItem value=\"price-desc\" className=\"rounded-md\">{t('priceHighLow')}</SelectItem>\r\n        <SelectItem value=\"rating\" className=\"rounded-md\">{t('avgReview')}</SelectItem>\r\n        <SelectItem value=\"newest\" className=\"rounded-md\">{t('newestArrivals')}</SelectItem>\r\n      </SelectContent>\r\n    </Select>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\seller\\boost-dialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_onBoostSuccess' is defined but never used.","line":54,"column":73,"nodeType":"Identifier","messageId":"unusedVar","endLine":54,"endColumn":88}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\n\n\nimport { useEffect, useState } from \"react\"\nimport { Link } from \"@/i18n/routing\"\nimport { Button } from \"@/components/ui/button\"\nimport { Badge } from \"@/components/ui/badge\"\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n} from \"@/components/ui/dialog\"\r\nimport {\r\n  Lightning,\r\n  SpinnerGap,\r\n  CheckCircle,\r\n  Rocket,\r\n  Eye,\r\n  TrendUp,\r\n  Clock,\r\n  Crown,\r\n  CaretRight,\r\n} from \"@phosphor-icons/react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { toast } from \"sonner\"\r\nimport { useTranslations } from \"next-intl\"\r\n\r\ntype PricingOption = {\r\n  days: number\r\n  sku: string\r\n  priceEur: number\r\n  priceBgn: number\r\n  durationKey: string\r\n  currency: string\r\n}\r\n\r\ninterface Product {\r\n  id: string\r\n  title: string\r\n  is_boosted?: boolean\r\n  boost_expires_at?: string | null\r\n}\r\n\r\ninterface BoostDialogProps {\r\n  product: Product\r\n  locale: string\r\n  trigger?: React.ReactNode\r\n  onBoostSuccess?: () => void\r\n}\r\n\r\nexport function BoostDialog({ product, locale, trigger, onBoostSuccess: _onBoostSuccess }: BoostDialogProps) {\r\n  const [selectedDays, setSelectedDays] = useState<number>(7)\r\n  const [isLoading, setIsLoading] = useState(false)\r\n  const [isOpen, setIsOpen] = useState(false)\r\n  const [pricingStatus, setPricingStatus] = useState<\"idle\" | \"loading\" | \"ready\" | \"error\">(\"idle\")\r\n  const [pricingOptions, setPricingOptions] = useState<PricingOption[] | null>(null)\r\n  const t = useTranslations('Boost')\r\n\r\n  const formatPriceEur = (price: number) => {\r\n    return new Intl.NumberFormat(locale, {\r\n      style: 'currency',\r\n      currency: 'EUR',\r\n      minimumFractionDigits: 2,\r\n    }).format(price)\r\n  }\r\n\r\n  const formatPriceBgn = (price: number) => {\r\n    return t('priceBgn', { price: price.toFixed(2) })\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (!isOpen) return\r\n    if (pricingStatus === \"loading\" || pricingStatus === \"ready\") return\r\n\r\n    let cancelled = false\r\n    setPricingStatus(\"loading\")\r\n\r\n    void (async () => {\r\n      try {\r\n        const response = await fetch(\"/api/boost/checkout\", { method: \"GET\" })\r\n        const data = (await response.json()) as { options?: PricingOption[] }\r\n        const options = Array.isArray(data.options) ? data.options : []\r\n\r\n        if (cancelled) return\r\n\r\n        if (!response.ok || options.length === 0) {\r\n          setPricingStatus(\"error\")\r\n          setPricingOptions(null)\r\n          return\r\n        }\r\n\r\n        setPricingOptions(options)\r\n        setPricingStatus(\"ready\")\r\n\r\n        if (!options.some((opt) => opt.days === selectedDays)) {\r\n          const nextDefault = options.find((opt) => opt.days === 7)?.days ?? options[0]?.days\r\n          if (typeof nextDefault === \"number\") setSelectedDays(nextDefault)\r\n        }\r\n      } catch {\r\n        if (cancelled) return\r\n        setPricingStatus(\"error\")\r\n        setPricingOptions(null)\r\n      }\r\n    })()\r\n\r\n    return () => {\r\n      cancelled = true\r\n    }\r\n  }, [isOpen, pricingStatus, selectedDays])\r\n\r\n  const handleBoost = async () => {\r\n    setIsLoading(true)\r\n\r\n    try {\r\n      const response = await fetch(\"/api/boost/checkout\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({\r\n          productId: product.id,\r\n          durationDays: selectedDays.toString(),\r\n          locale,\r\n        }),\r\n      })\r\n\r\n      const data = (await response.json()) as {\r\n        url?: string | null\r\n        errorKey?: string\r\n        durationKey?: string\r\n      }\r\n\r\n      if (!response.ok || data.errorKey) {\r\n        toast.error(t(data.errorKey ?? \"errors.internal\"))\r\n        return\r\n      }\r\n\r\n      if (!data.durationKey) {\r\n        toast.error(t(\"errors.internal\"))\r\n        return\r\n      }\r\n\r\n      const url = data.url\r\n\r\n      // Redirect to Stripe checkout\r\n      if (url) {\r\n        window.location.href = url\r\n      }\r\n    } catch (error) {\r\n      console.error('Boost error:', error)\r\n      toast.error(t('paymentError'))\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }\r\n\r\n  // Compute boost status using shared logic\r\n  const isCurrentlyBoosted = product.is_boosted && product.boost_expires_at \r\n    ? new Date(product.boost_expires_at) > new Date() \r\n    : false\r\n  \r\n  // Calculate time left for active boost\r\n  const getTimeLeft = () => {\r\n    if (!product.boost_expires_at) return null\r\n    const expiresAt = new Date(product.boost_expires_at)\r\n    const now = new Date()\r\n    const diffMs = expiresAt.getTime() - now.getTime()\r\n    if (diffMs <= 0) return null\r\n    const days = Math.floor(diffMs / (1000 * 60 * 60 * 24))\r\n    const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))\r\n    return { days, hours }\r\n  }\r\n  \r\n  const formatDate = (dateStr: string) => {\r\n    return new Intl.DateTimeFormat(locale, { \r\n      dateStyle: 'medium', \r\n      timeStyle: 'short' \r\n    }).format(new Date(dateStr))\r\n  }\r\n  \r\n  // If boost is currently active, show detailed status badge (not a dialog)\r\n  if (isCurrentlyBoosted && product.boost_expires_at) {\r\n    const timeLeft = getTimeLeft()\r\n    return (\r\n      <div className=\"flex flex-col gap-1\">\r\n        <Badge className=\"bg-selected text-primary border-0 gap-1\">\n          <Lightning className=\"size-3\" weight=\"fill\" />\n          {timeLeft \n            ? t('timeLeft', { days: timeLeft.days, hours: timeLeft.hours })\n            : t('boostActive')\n          }\n        </Badge>\n        <span className=\"text-2xs text-muted-foreground\">\r\n          {t('boostActiveUntil', { date: formatDate(product.boost_expires_at) })}\r\n        </span>\r\n      </div>\r\n    )\r\n  }\r\n  \r\n  // Check if there was a previous boost that expired (allow re-boost)\r\n  const wasBoostExpired = product.is_boosted && product.boost_expires_at \r\n    ? new Date(product.boost_expires_at) <= new Date() \r\n    : false\r\n\r\n  const selectedPricing = pricingOptions?.find((opt) => opt.days === selectedDays) ?? null\r\n\r\n  return (\r\n    <Dialog open={isOpen} onOpenChange={setIsOpen}>\r\n      <DialogTrigger asChild>\r\n        {trigger || (\r\n          <Button variant=\"outline\" size=\"sm\" className=\"gap-1.5 text-primary border-selected-border hover:bg-hover hover:text-primary\">\n            <Lightning className=\"size-4\" weight=\"bold\" />\n            {wasBoostExpired ? t('reboost') : t('trigger')}\n          </Button>\n        )}\n      </DialogTrigger>\r\n      <DialogContent className=\"sm:max-w-md\">\r\n        <DialogHeader>\r\n          <DialogTitle className=\"flex items-center gap-2\">\r\n            <div className=\"size-10 rounded-lg bg-selected flex items-center justify-center\">\n              <Rocket className=\"size-5 text-primary\" weight=\"fill\" />\n            </div>\n            {t('title')}\n          </DialogTitle>\n          <DialogDescription>{t('description')}</DialogDescription>\r\n        </DialogHeader>\r\n\r\n        <div className=\"space-y-4 pt-2\">\n          {/* Product being boosted */}\n          <div className=\"p-3 bg-surface-subtle rounded-lg\">\n            <p className=\"text-sm font-medium truncate\">{product.title}</p>\n          </div>\n\r\n          {/* Duration Selection */}\r\n          <div className=\"space-y-2\">\r\n            <p className=\"text-sm font-medium text-muted-foreground\">{t('selectDuration')}</p>\r\n            {pricingStatus === \"loading\" ? (\r\n              <div className=\"grid grid-cols-3 gap-2\">\r\n                {[0, 1, 2].map((i) => (\n                  <div\n                    key={i}\n                    className=\"h-28 rounded-lg border border-border bg-surface-subtle animate-pulse\"\n                  />\n                ))}\n              </div>\n            ) : pricingStatus === \"error\" || !pricingOptions ? (\n              <div className=\"rounded-lg border border-border bg-surface-subtle p-3 text-xs text-muted-foreground\">\n                {t(\"errors.internal\")}\n              </div>\n            ) : (\n              <div className=\"grid grid-cols-3 gap-2\">\r\n                {pricingOptions.map((option) => {\r\n                  const isSelected = selectedDays === option.days\r\n                  const isPopular = option.days === 7\r\n                  const isBestValue = option.days === 30\r\n                  const pricePerDayEur = option.priceEur / (option.days === 1 ? 1 : option.days)\r\n\r\n                  return (\r\n                    <button\r\n                      key={option.days}\r\n                      onClick={() => setSelectedDays(option.days)}\r\n                      className={cn(\r\n                        \"relative flex flex-col items-center p-3 rounded-lg border-2 transition-all\",\n                        isSelected\n                          ? \"border-selected-border bg-selected\"\n                          : \"border-border hover:border-hover-border\"\n                      )}\n                    >\n                      {isPopular && (\r\n                        <Badge\r\n                          className=\"absolute -top-2 left-1/2 -translate-x-1/2 text-2xs px-1.5 py-0\"\r\n                          variant=\"default\"\r\n                        >\r\n                          {t('popular')}\r\n                        </Badge>\r\n                      )}\r\n                      {isBestValue && (\r\n                        <Badge\r\n                          className=\"absolute -top-2 left-1/2 -translate-x-1/2 text-2xs px-1.5 py-0 bg-success\"\r\n                          variant=\"default\"\r\n                        >\r\n                          {t('bestValue')}\r\n                        </Badge>\r\n                      )}\r\n                      <span className=\"text-lg font-bold\">{option.days === 1 ? '24' : option.days}</span>\r\n                      <span className=\"text-xs text-muted-foreground\">{option.days === 1 ? t('hours') : t('days')}</span>\r\n                      <span className={cn(\r\n                        \"text-sm font-semibold mt-1\",\r\n                        isSelected ? \"text-primary\" : \"text-foreground\"\r\n                      )}>\r\n                        {formatPriceEur(option.priceEur)}\r\n                      </span>\r\n                      <span className=\"text-2xs text-muted-foreground\">\r\n                        {formatPriceBgn(option.priceBgn)}\r\n                      </span>\r\n                      {option.days > 1 && (\r\n                        <span className=\"text-2xs text-muted-foreground mt-0.5\">\r\n                          {formatPriceEur(pricePerDayEur)}{t('perDay')}\r\n                        </span>\r\n                      )}\r\n                    </button>\r\n                  )\r\n                })}\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Features */}\r\n          <div className=\"space-y-2\">\r\n            <p className=\"text-sm font-medium text-muted-foreground\">{t('features')}</p>\r\n            <div className=\"grid grid-cols-2 gap-2\">\r\n              {[\r\n                { icon: TrendUp, text: t('feature1') },\r\n                { icon: Lightning, text: t('feature2') },\r\n                { icon: Eye, text: t('feature3') },\r\n                { icon: Clock, text: t('feature4') },\r\n              ].map((feature, i) => (\r\n                <div key={i} className=\"flex items-center gap-2 text-sm\">\r\n                  <CheckCircle className=\"size-4 text-success\" weight=\"fill\" />\r\n                  <span className=\"text-muted-foreground\">{feature.text}</span>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </div>\r\n\r\n          {/* CTA Button */}\r\n          <Button\r\n            className=\"w-full gap-2\"\r\n            size=\"lg\"\r\n            onClick={handleBoost}\r\n            disabled={isLoading || pricingStatus !== \"ready\" || !selectedPricing}\r\n          >\r\n            {isLoading ? (\r\n              <>\r\n                <SpinnerGap className=\"size-4 animate-spin\" />\r\n                {t('processing')}\r\n              </>\r\n            ) : (\r\n              <>\r\n                <Lightning className=\"size-4\" weight=\"fill\" />\r\n                {t('boostNow')} ΓÇó {formatPriceEur(selectedPricing?.priceEur ?? 0)}\r\n              </>\r\n            )}\r\n          </Button>\r\n\r\n          {/* Divider with \"or\" */}\r\n          <div className=\"relative\">\r\n            <div className=\"absolute inset-0 flex items-center\">\r\n              <span className=\"w-full border-t border-border\" />\r\n            </div>\r\n            <div className=\"relative flex justify-center text-xs uppercase\">\r\n              <span className=\"bg-background px-2 text-muted-foreground\">\r\n                {t('or')}\r\n              </span>\r\n            </div>\r\n          </div>\r\n\r\n          {/* View Plans CTA */}\r\n          <Link\n            href=\"/account/plans\"\n            onClick={() => setIsOpen(false)}\n            className=\"flex items-center justify-between w-full p-3 rounded-lg border border-selected-border bg-selected hover:bg-hover transition-colors group\"\n          >\n            <div className=\"flex items-center gap-3\">\n              <div className=\"size-9 rounded-lg bg-selected flex items-center justify-center\">\n                <Crown className=\"size-5 text-primary\" weight=\"fill\" />\n              </div>\n              <div className=\"text-left\">\n                <p className=\"text-sm font-medium\">\n                  {t('upgradePlan')}\n                </p>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {t('upgradeDesc')}\r\n                </p>\r\n              </div>\r\n            </div>\r\n            <CaretRight className=\"size-4 text-muted-foreground group-hover:text-primary transition-colors\" />\r\n          </Link>\r\n        </div>\r\n      </DialogContent>\r\n    </Dialog>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\seller\\follow-seller-button.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_locale' is assigned a value but never used.","line":43,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useOptimistic, useTransition } from \"react\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Heart, SpinnerGap, UserPlus } from \"@phosphor-icons/react\"\r\nimport { toast } from \"sonner\"\r\nimport { useTranslations } from \"next-intl\"\r\n\r\n/**\r\n * Action result type for follow/unfollow operations\r\n */\r\nexport type FollowActionResult = { success: boolean; error?: string }\r\n\r\n/**\r\n * Handler types for follow/unfollow actions - passed from app/ layer\r\n */\r\nexport interface FollowSellerActions {\r\n  followSeller: (sellerId: string) => Promise<FollowActionResult>\r\n  unfollowSeller: (sellerId: string) => Promise<FollowActionResult>\r\n}\r\n\r\ninterface FollowSellerButtonProps {\r\n  sellerId: string\r\n  initialIsFollowing: boolean\r\n  /** Action handlers - required, passed from app/ layer */\r\n  actions: FollowSellerActions\r\n  locale?: string\r\n  showLabel?: boolean\r\n  onFollowChange?: (isFollowing: boolean) => void\r\n  variant?: \"default\" | \"outline\" | \"secondary\" | \"ghost\" | \"destructive\" | \"link\"\r\n  size?: \"default\" | \"sm\" | \"lg\" | \"icon\"\r\n  className?: string\r\n}\r\n\r\n/**\r\n * Follow/Unfollow button for seller profiles and product pages\r\n * Uses React 19 useOptimistic for instant feedback\r\n */\r\nexport function FollowSellerButton({\r\n  sellerId,\r\n  initialIsFollowing,\r\n  actions,\r\n  locale: _locale = \"en\",\r\n  showLabel = true,\r\n  onFollowChange,\r\n  variant = \"outline\",\r\n  size = \"sm\",\r\n  className,\r\n}: FollowSellerButtonProps) {\r\n  const [isPending, startTransition] = useTransition()\r\n  // React 19: useOptimistic for instant UI feedback before server responds\r\n  const [optimisticFollowing, setOptimisticFollowing] = useOptimistic(initialIsFollowing)\r\n\r\n  const tSeller = useTranslations(\"Seller\")\r\n  const tCommon = useTranslations(\"Common\")\r\n\r\n  const handleClick = async () => {\r\n    const newState = !optimisticFollowing\r\n    startTransition(async () => {\r\n      // Instant UI feedback via useOptimistic (inside transition)\r\n      setOptimisticFollowing(newState)\r\n      onFollowChange?.(newState)\r\n\r\n      const result = newState \r\n        ? await actions.followSeller(sellerId)\r\n        : await actions.unfollowSeller(sellerId)\r\n\r\n      if (result.success) {\r\n        toast.success(newState ? tSeller(\"followSuccess\") : tSeller(\"unfollowSuccess\"))\r\n      } else {\r\n        // On error, useOptimistic automatically rolls back when transition ends\r\n        // But we need to notify parent\r\n        onFollowChange?.(!newState)\r\n        \r\n        if (result.error === \"Not authenticated\") {\r\n          toast.error(tSeller(\"loginRequired\"))\r\n        } else {\r\n          toast.error(result.error || tCommon(\"error\"))\r\n        }\r\n      }\r\n    })\r\n  }\r\n\r\n  return (\r\n    <Button\r\n      variant={optimisticFollowing ? \"secondary\" : variant}\r\n      size={size}\r\n      className={className}\r\n      onClick={handleClick}\r\n      disabled={isPending}\r\n    >\r\n      {isPending ? (\r\n        <SpinnerGap className=\"size-4 animate-spin\" />\r\n      ) : optimisticFollowing ? (\r\n        <Heart className=\"size-4\" weight=\"fill\" />\r\n      ) : (\r\n        <UserPlus className=\"size-4\" />\r\n      )}\r\n      {showLabel && (\r\n        <span className=\"ml-1.5\">\r\n          {optimisticFollowing ? tSeller(\"following\") : tSeller(\"follow\")}\r\n        </span>\r\n      )}\r\n    </Button>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\seller\\seller-payout-setup.tsx","messages":[{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 59 to the 25 allowed.","line":31,"column":17,"nodeType":null,"messageId":"refactorFunction","endLine":31,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | URL | undefined`.","line":110,"column":19,"nodeType":"MemberExpression","messageId":"unsafeArgument","endLine":110,"endColumn":27},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":227,"column":119,"nodeType":"Literal","endLine":227,"endColumn":155},{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 6 times.","line":227,"column":158,"nodeType":"Literal","endLine":227,"endColumn":190}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState } from \"react\"\r\nimport { useLocale, useTranslations } from \"next-intl\"\r\nimport { motion } from \"framer-motion\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport {\r\n  CreditCard,\r\n  Wallet,\r\n  ArrowRight,\r\n  CheckCircle2,\r\n  ShieldCheck,\r\n  Zap,\r\n  ExternalLink,\r\n  Loader2,\r\n} from \"lucide-react\"\r\n\r\ntype PayoutStatus = {\r\n  stripe_connect_account_id: string | null\r\n  details_submitted: boolean\r\n  charges_enabled: boolean\r\n  payouts_enabled: boolean\r\n} | null\r\n\r\ntype Props = {\r\n  payoutStatus: PayoutStatus\r\n  variant?: \"full\" | \"compact\"\r\n}\r\n\r\nexport function SellerPayoutSetup({ payoutStatus, variant = \"full\" }: Props) {\r\n  const t = useTranslations(\"seller.payouts\")\r\n  const locale = useLocale()\r\n  const [loading, setLoading] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n\r\n  const isComplete = payoutStatus?.details_submitted && payoutStatus?.charges_enabled && payoutStatus?.payouts_enabled\r\n  const hasStarted = !!payoutStatus?.stripe_connect_account_id\r\n\r\n  const getErrorMessage = (action: \"onboarding\" | \"dashboard\", status: number) => {\r\n    if (status === 401) return t(\"errors.unauthorized\")\r\n    if (status === 403) return t(\"errors.forbidden\")\r\n\r\n    if (action === \"dashboard\") {\r\n      if (status === 404) return t(\"errors.noAccount\")\r\n      if (status === 400) return t(\"errors.onboardingIncomplete\")\r\n      return t(\"errors.dashboardFailed\")\r\n    }\r\n\r\n    return t(\"errors.onboardingFailed\")\r\n  }\r\n\r\n  const handleStartOnboarding = async () => {\r\n    setLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const response = await fetch(\"/api/connect/onboarding\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"x-next-intl-locale\": locale,\r\n        },\r\n      })\r\n\r\n      if (!response.ok) {\r\n        setError(getErrorMessage(\"onboarding\", response.status))\r\n        setLoading(false)\r\n        return\r\n      }\r\n\r\n      const data = await response.json()\r\n      if (!data?.url) {\r\n        setError(t(\"errors.generic\"))\r\n        setLoading(false)\r\n        return\r\n      }\r\n\r\n      window.location.href = data.url\r\n    } catch {\r\n      setError(t(\"errors.generic\"))\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleOpenDashboard = async () => {\r\n    setLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const response = await fetch(\"/api/connect/dashboard\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"x-next-intl-locale\": locale,\r\n        },\r\n      })\r\n\r\n      if (!response.ok) {\r\n        setError(getErrorMessage(\"dashboard\", response.status))\r\n        setLoading(false)\r\n        return\r\n      }\r\n\r\n      const data = await response.json()\r\n      if (!data?.url) {\r\n        setError(t(\"errors.generic\"))\r\n        setLoading(false)\r\n        return\r\n      }\r\n\r\n      window.open(data.url, \"_blank\")\r\n      setLoading(false)\r\n    } catch {\r\n      setError(t(\"errors.generic\"))\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const title = isComplete ? t(\"titleComplete\") : hasStarted ? t(\"titleContinue\") : t(\"titleSetup\")\r\n  const fullDescription = isComplete\r\n    ? t(\"descriptionComplete\")\r\n    : hasStarted\r\n      ? t(\"descriptionContinue\")\r\n      : t(\"descriptionSetup\")\r\n  const compactDescription = isComplete\r\n    ? t(\"statusComplete\")\r\n    : hasStarted\r\n      ? t(\"statusIncomplete\")\r\n      : t(\"statusNotStarted\")\r\n\r\n  // Full layout (seller settings page)\r\n  if (variant !== \"compact\") {\r\n    return (\r\n    <div className=\"flex flex-col items-center justify-center text-center max-w-md mx-auto py-8 px-4\">\r\n      {/* Icon */}\r\n      <motion.div\r\n        initial={{ scale: 0.8, opacity: 0 }}\r\n        animate={{ scale: 1, opacity: 1 }}\r\n        transition={{ duration: 0.3 }}\r\n        className=\"size-20 rounded-2xl bg-primary flex items-center justify-center mb-6 shadow-lg shadow-primary\"\r\n      >\r\n        {isComplete ? (\r\n          <CheckCircle2 className=\"size-10 text-primary-foreground\" strokeWidth={2} />\r\n        ) : (\r\n          <Wallet className=\"size-10 text-primary-foreground\" strokeWidth={2} />\r\n        )}\r\n      </motion.div>\r\n\r\n      {/* Title */}\r\n      <motion.h1\r\n        initial={{ y: 10, opacity: 0 }}\r\n        animate={{ y: 0, opacity: 1 }}\r\n        transition={{ duration: 0.3, delay: 0.1 }}\r\n        className=\"text-2xl sm:text-3xl font-bold text-foreground mb-3\"\r\n      >\r\n        {title}\r\n      </motion.h1>\r\n\r\n      {/* Description */}\r\n      <motion.p\r\n        initial={{ y: 10, opacity: 0 }}\r\n        animate={{ y: 0, opacity: 1 }}\r\n        transition={{ duration: 0.3, delay: 0.15 }}\r\n        className=\"text-muted-foreground text-base mb-8 max-w-sm\"\r\n      >\r\n        {fullDescription}\r\n      </motion.p>\r\n\r\n      {/* Error */}\r\n      {error && (\r\n        <motion.div\r\n          initial={{ opacity: 0 }}\r\n          animate={{ opacity: 1 }}\r\n          className=\"w-full p-3 mb-6 bg-destructive-subtle text-destructive rounded-lg text-sm\"\r\n        >\r\n          {error}\r\n        </motion.div>\r\n      )}\r\n\r\n      {/* CTA Button */}\r\n      <motion.div\r\n        initial={{ y: 10, opacity: 0 }}\r\n        animate={{ y: 0, opacity: 1 }}\r\n        transition={{ duration: 0.3, delay: 0.2 }}\r\n        className=\"w-full\"\r\n      >\r\n        {!isComplete ? (\r\n          <Button\r\n            onClick={handleStartOnboarding}\r\n            disabled={loading}\r\n            size=\"lg\"\r\n            className=\"w-full h-12 text-base font-semibold shadow-md\"\r\n          >\r\n            {loading ? (\r\n              <Loader2 className=\"size-5 mr-2 animate-spin\" />\r\n            ) : (\r\n              <CreditCard className=\"size-5 mr-2\" />\r\n            )}\r\n            {hasStarted ? t(\"continueSetup\") : t(\"startSetup\")}\r\n            <ArrowRight className=\"size-5 ml-2\" />\r\n          </Button>\r\n        ) : (\r\n          <Button\r\n            onClick={handleOpenDashboard}\r\n            disabled={loading}\r\n            size=\"lg\"\r\n            variant=\"outline\"\r\n            className=\"w-full h-12 text-base font-semibold\"\r\n          >\r\n            {loading ? (\r\n              <Loader2 className=\"size-5 mr-2 animate-spin\" />\r\n            ) : null}\r\n            {t(\"openDashboard\")}\r\n            <ExternalLink className=\"size-5 ml-2\" />\r\n          </Button>\r\n        )}\r\n      </motion.div>\r\n\r\n      {/* Progress indicators for incomplete setup */}\r\n      {hasStarted && !isComplete && (\r\n        <motion.div\r\n          initial={{ opacity: 0 }}\r\n          animate={{ opacity: 1 }}\r\n          transition={{ delay: 0.3 }}\r\n          className=\"mt-8 w-full space-y-2\"\r\n        >\r\n          <div className=\"flex items-center gap-2 text-sm\">\r\n            <div className={`size-5 rounded-full flex items-center justify-center ${payoutStatus?.details_submitted ? \"bg-success text-success-foreground\" : \"bg-muted text-muted-foreground\"}`}>\r\n              {payoutStatus?.details_submitted ? <CheckCircle2 className=\"size-3\" /> : <span className=\"text-xs\">1</span>}\r\n            </div>\r\n            <span className={payoutStatus?.details_submitted ? \"text-foreground\" : \"text-muted-foreground\"}>\r\n              {t(\"detailsSubmitted\")}\r\n            </span>\r\n          </div>\r\n          <div className=\"flex items-center gap-2 text-sm\">\r\n            <div className={`size-5 rounded-full flex items-center justify-center ${payoutStatus?.charges_enabled ? \"bg-success text-success-foreground\" : \"bg-muted text-muted-foreground\"}`}>\r\n              {payoutStatus?.charges_enabled ? <CheckCircle2 className=\"size-3\" /> : <span className=\"text-xs\">2</span>}\r\n            </div>\r\n            <span className={payoutStatus?.charges_enabled ? \"text-foreground\" : \"text-muted-foreground\"}>\r\n              {t(\"chargesEnabled\")}\r\n            </span>\r\n          </div>\r\n          <div className=\"flex items-center gap-2 text-sm\">\r\n            <div className={`size-5 rounded-full flex items-center justify-center ${payoutStatus?.payouts_enabled ? \"bg-success text-success-foreground\" : \"bg-muted text-muted-foreground\"}`}>\r\n              {payoutStatus?.payouts_enabled ? <CheckCircle2 className=\"size-3\" /> : <span className=\"text-xs\">3</span>}\r\n            </div>\r\n            <span className={payoutStatus?.payouts_enabled ? \"text-foreground\" : \"text-muted-foreground\"}>\r\n              {t(\"payoutsEnabled\")}\r\n            </span>\r\n          </div>\r\n        </motion.div>\r\n      )}\r\n\r\n      {/* Benefits - only for new setup */}\r\n      {!hasStarted && (\r\n        <motion.div\r\n          initial={{ opacity: 0 }}\r\n          animate={{ opacity: 1 }}\r\n          transition={{ delay: 0.3 }}\r\n          className=\"mt-10 pt-8 border-t border-border w-full\"\r\n        >\r\n          <div className=\"grid gap-4 text-left\">\r\n            <div className=\"flex items-start gap-3\">\r\n              <div className=\"size-8 rounded-lg bg-selected flex items-center justify-center shrink-0\">\r\n                <ShieldCheck className=\"size-4 text-primary\" />\r\n              </div>\r\n              <div>\r\n                <p className=\"text-sm font-medium text-foreground\">{t(\"benefit1Title\")}</p>\r\n                <p className=\"text-xs text-muted-foreground\">{t(\"benefit1Desc\")}</p>\r\n              </div>\r\n            </div>\r\n            <div className=\"flex items-start gap-3\">\r\n              <div className=\"size-8 rounded-lg bg-selected flex items-center justify-center shrink-0\">\r\n                <Zap className=\"size-4 text-primary\" />\r\n              </div>\r\n              <div>\r\n                <p className=\"text-sm font-medium text-foreground\">{t(\"benefit2Title\")}</p>\r\n                <p className=\"text-xs text-muted-foreground\">{t(\"benefit2Desc\")}</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </motion.div>\r\n      )}\r\n    </div>\r\n    )\r\n  }\r\n\r\n  // Compact layout (sell gate on mobile): sticky CTA, minimal copy\r\n  return (\r\n    <div className=\"mx-auto w-full max-w-md px-4 pt-4 pb-safe text-center\">\r\n      <div className=\"flex flex-col items-center\">\r\n        <div className=\"size-12 rounded-xl bg-primary flex items-center justify-center shadow-sm shadow-sm\">\r\n          {isComplete ? (\r\n            <CheckCircle2 className=\"size-7 text-primary-foreground\" strokeWidth={2} />\r\n          ) : (\r\n            <Wallet className=\"size-7 text-primary-foreground\" strokeWidth={2} />\r\n          )}\r\n        </div>\r\n\r\n        <h1 className=\"mt-3 text-xl font-semibold tracking-tight text-foreground\">{title}</h1>\r\n        <p className=\"mt-1 text-sm text-muted-foreground leading-snug line-clamp-2\">{compactDescription}</p>\r\n\r\n        {/* Minimal status chips (only if setup already started) */}\r\n        {hasStarted && !isComplete && (\r\n          <div className=\"mt-3 w-full flex flex-wrap justify-center gap-2\">\r\n            <div className={cn(\r\n              \"inline-flex items-center gap-2 rounded-full border px-3 py-1 text-xs\",\r\n              payoutStatus?.details_submitted\r\n                ? \"border-success bg-success-subtle text-foreground\"\r\n                : \"border-border bg-surface-subtle text-muted-foreground\"\r\n            )}>\r\n              <span className={cn(\r\n                \"inline-flex size-4 items-center justify-center rounded-full text-2xs\",\r\n                payoutStatus?.details_submitted\r\n                  ? \"bg-success text-success-foreground\"\r\n                  : \"bg-muted text-muted-foreground\"\r\n              )}>\r\n                {payoutStatus?.details_submitted ? <CheckCircle2 className=\"size-3\" /> : \"1\"}\r\n              </span>\r\n              <span className=\"truncate max-w-48\">{t(\"detailsSubmitted\")}</span>\r\n            </div>\r\n\r\n            <div className={cn(\r\n              \"inline-flex items-center gap-2 rounded-full border px-3 py-1 text-xs\",\r\n              payoutStatus?.charges_enabled\r\n                ? \"border-success bg-success-subtle text-foreground\"\r\n                : \"border-border bg-surface-subtle text-muted-foreground\"\r\n            )}>\r\n              <span className={cn(\r\n                \"inline-flex size-4 items-center justify-center rounded-full text-2xs\",\r\n                payoutStatus?.charges_enabled\r\n                  ? \"bg-success text-success-foreground\"\r\n                  : \"bg-muted text-muted-foreground\"\r\n              )}>\r\n                {payoutStatus?.charges_enabled ? <CheckCircle2 className=\"size-3\" /> : \"2\"}\r\n              </span>\r\n              <span className=\"truncate max-w-48\">{t(\"chargesEnabled\")}</span>\r\n            </div>\r\n\r\n            <div className={cn(\r\n              \"inline-flex items-center gap-2 rounded-full border px-3 py-1 text-xs\",\r\n              payoutStatus?.payouts_enabled\r\n                ? \"border-success bg-success-subtle text-foreground\"\r\n                : \"border-border bg-surface-subtle text-muted-foreground\"\r\n            )}>\r\n              <span className={cn(\r\n                \"inline-flex size-4 items-center justify-center rounded-full text-2xs\",\r\n                payoutStatus?.payouts_enabled\r\n                  ? \"bg-success text-success-foreground\"\r\n                  : \"bg-muted text-muted-foreground\"\r\n              )}>\r\n                {payoutStatus?.payouts_enabled ? <CheckCircle2 className=\"size-3\" /> : \"3\"}\r\n              </span>\r\n              <span className=\"truncate max-w-48\">{t(\"payoutsEnabled\")}</span>\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"h-22\" aria-hidden=\"true\" />\r\n\r\n      {/* Fixed bottom CTA (always visible, no scroll required) */}\r\n      <div className=\"fixed bottom-0 left-0 right-0 z-50 border-t border-border bg-background px-4 pt-3 pb-safe backdrop-blur\">\r\n        <div className=\"mx-auto w-full max-w-md pb-4\">\r\n        {error && (\r\n          <div className=\"w-full p-3 mb-3 bg-destructive-subtle text-destructive rounded-lg text-sm\">\r\n            {error}\r\n          </div>\r\n        )}\r\n\r\n        {!isComplete ? (\r\n          <Button\r\n            onClick={handleStartOnboarding}\r\n            disabled={loading}\r\n            size=\"lg\"\r\n            className=\"w-full h-12 text-base font-semibold\"\r\n          >\r\n            {loading ? (\r\n              <Loader2 className=\"size-5 mr-2 animate-spin\" />\r\n            ) : (\r\n              <CreditCard className=\"size-5 mr-2\" />\r\n            )}\r\n            {hasStarted ? t(\"continueSetup\") : t(\"startSetup\")}\r\n            <ArrowRight className=\"size-5 ml-2\" />\r\n          </Button>\r\n        ) : (\r\n          <Button\r\n            onClick={handleOpenDashboard}\r\n            disabled={loading}\r\n            size=\"lg\"\r\n            variant=\"outline\"\r\n            className=\"w-full h-12 text-base font-semibold\"\r\n          >\r\n            {loading ? <Loader2 className=\"size-5 mr-2 animate-spin\" /> : null}\r\n            {t(\"openDashboard\")}\r\n            <ExternalLink className=\"size-5 ml-2\" />\r\n          </Button>\r\n        )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\seller\\sellers-grid.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\skip-links.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used.","line":1,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":14,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Link"},"fix":{"range":[0,38],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Link } from \"@/i18n/routing\";\r\n\r\n/**\r\n * SkipLinks ΓÇö Accessibility navigation for keyboard users\r\n *\r\n * Provides quick navigation to key page areas:\r\n * - Main content (product grid, page content)\r\n * - Sidebar (categories, filters)\r\n * - Footer\r\n *\r\n * These links are only visible when focused, allowing keyboard users\r\n * to bypass repetitive navigation blocks.\r\n *\r\n * Best Practices:\r\n * - Links target element IDs that exist on the page\r\n * - Each target element should have tabindex=\"-1\" for proper focus\r\n * - Links are in a logical tab order\r\n */\r\n\r\ninterface SkipLinkProps {\r\n  href: string;\r\n  children: React.ReactNode;\r\n}\r\n\r\nfunction SkipLink({ href, children }: SkipLinkProps) {\r\n  return (\r\n    <a\r\n      href={href}\r\n      className=\"fixed top-2 left-2 z-skip-link bg-background text-foreground p-4 rounded-md shadow-md border border-border font-semibold ring-2 ring-primary outline-none transform -translate-y-16 focus:translate-y-0 transition-transform duration-150\"\r\n    >\r\n      {children}\r\n    </a>\r\n  );\r\n}\r\n\r\nexport function SkipLinks() {\r\n  return (\r\n    <nav\r\n      aria-label=\"Skip links\"\r\n      className=\"sr-only focus-within:not-sr-only\"\r\n    >\r\n      {/* Primary skip link - always first */}\r\n      <SkipLink href=\"#main-content\">\r\n        Skip to main content\r\n      </SkipLink>\r\n\r\n      {/* Secondary skip links - shown in sequence on Tab */}\r\n      <SkipLink href=\"#shell-sidebar\">\r\n        Skip to sidebar\r\n      </SkipLink>\r\n\r\n      <SkipLink href=\"#product-grid\">\r\n        Skip to products\r\n      </SkipLink>\r\n\r\n      <SkipLink href=\"#footerHeader\">\r\n        Skip to footer\r\n      </SkipLink>\r\n    </nav>\r\n  );\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\spinner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\star-rating-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\user-avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\wishlist\\mobile-wishlist-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\shared\\wishlist\\wishlist-drawer.tsx","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'formatPrice' to the outer scope.","line":42,"column":39,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":42,"endColumn":41}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useEffect, useState } from \"react\"\r\nimport { Heart, ShoppingCart, Trash, ArrowRight, X } from \"@phosphor-icons/react\"\r\nimport {\n  Drawer,\n  DrawerTrigger,\n  DrawerContent,\n  DrawerDescription,\n  DrawerHeader,\n  DrawerTitle,\n  DrawerClose,\n  DrawerFooter,\n  DrawerBody,\n} from \"@/components/ui/drawer\"\nimport { Button } from \"@/components/ui/button\"\nimport { IconButton } from \"@/components/ui/icon-button\"\nimport { Link } from \"@/i18n/routing\"\nimport { useTranslations } from \"next-intl\"\nimport { useWishlist } from \"@/components/providers/wishlist-context\"\nimport { useCart } from \"@/components/providers/cart-context\"\nimport Image from \"next/image\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { toast } from \"sonner\"\r\n\r\ninterface WishlistDrawerProps {\r\n  className?: string\r\n  children: React.ReactNode\r\n}\r\n\r\nexport function WishlistDrawer({ className, children }: WishlistDrawerProps) {\r\n  const [open, setOpen] = useState(false)\r\n  const [mounted, setMounted] = useState(false)\r\n  const { items, isLoading, removeFromWishlist, totalItems } = useWishlist()\r\n  const { addToCart } = useCart()\r\n  const t = useTranslations(\"Wishlist\")\r\n\r\n  useEffect(() => {\r\n    setMounted(true)\r\n  }, [])\r\n\r\n  const formatPrice = (price: number) => {\r\n    return new Intl.NumberFormat(\"en-IE\", {\r\n      style: \"currency\",\r\n      currency: \"EUR\",\r\n    }).format(price)\r\n  }\r\n\r\n  const handleMoveToCart = (item: (typeof items)[0]) => {\r\n    addToCart({\r\n      id: item.product_id,\r\n      title: item.title,\r\n      price: item.price,\r\n      image: item.image,\r\n      quantity: 1,\r\n    })\r\n    removeFromWishlist(item.product_id)\r\n    toast.success(t(\"movedToCart\"))\r\n  }\r\n\r\n  const contentMaxHeight = items.length <= 2 ? \"max-h-dialog-sm\" : \"max-h-dialog\"\r\n\r\n  return (\r\n    <Drawer open={open} onOpenChange={setOpen}>\n      <DrawerTrigger asChild>{children}</DrawerTrigger>\n      <DrawerContent className={className}>\n        <DrawerHeader className=\"pb-1.5 pt-0 border-b border-border text-left\">\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-1\">\n              <Heart size={16} weight=\"fill\" className=\"text-wishlist\" />\n              <DrawerTitle className=\"text-sm font-semibold\">{t(\"title\")}</DrawerTitle>\r\n              <span className=\"text-xs text-muted-foreground\" suppressHydrationWarning>\r\n                ({mounted ? totalItems : 0})\r\n              </span>\r\n            </div>\n            <DrawerClose asChild>\n              <IconButton\n                aria-label={t(\"close\")}\n                variant=\"ghost\"\n                size=\"icon-compact\"\n                className=\"text-muted-foreground hover:text-foreground hover:bg-muted active:bg-muted\"\n              >\n                <X size={20} weight=\"light\" />\n              </IconButton>\n            </DrawerClose>\n          </div>\n          <DrawerDescription className=\"sr-only\">{t(\"description\")}</DrawerDescription>\n        </DrawerHeader>\n\r\n        {isLoading ? (\r\n          <div className=\"flex items-center justify-center py-8\">\r\n            <div className=\"size-6 border-2 border-muted border-t-wishlist rounded-full animate-spin\" />\r\n          </div>\r\n        ) : items.length === 0 ? (\n          <div className=\"flex flex-col items-center justify-center py-5 px-inset text-center\">\n            <div className=\"size-11 bg-muted rounded-xl flex items-center justify-center mb-2\">\n              <Heart size={22} weight=\"duotone\" className=\"text-muted-foreground\" />\n            </div>\n            <p className=\"text-sm text-foreground font-medium\">{t(\"empty\")}</p>\n            <p className=\"text-xs text-muted-foreground mt-0.5 mb-3\">{t(\"emptyDescription\")}</p>\r\n            <Button asChild variant=\"cta\" size=\"default\" onClick={() => setOpen(false)}>\r\n              <Link href=\"/search\" className=\"gap-1\">\n                {t(\"startShopping\")}\r\n                <ArrowRight size={14} />\r\n              </Link>\r\n            </Button>\r\n          </div>\r\n        ) : (\r\n          <>\r\n            <DrawerBody className={cn(\"px-inset\", contentMaxHeight)}>\r\n              {items.map((item, index) => (\r\n                <div\r\n                  key={item.id}\r\n                  className={cn(\r\n                    \"grid grid-cols-wishlist-item gap-1.5 py-2\",\n                    index !== items.length - 1 && \"border-b border-border\"\r\n                  )}\r\n                >\n                  <Link\n                    href={item.username ? `/${item.username}/${item.slug || item.product_id}` : \"#\"}\n                    onClick={() => setOpen(false)}\n                    className=\"shrink-0\"\n                  >\n                    <div className=\"size-14 bg-muted rounded-xl overflow-hidden border border-border\">\n                      <Image\n                        src={item.image}\n                        alt={item.title}\n                        width={56}\n                        height={56}\n                        className=\"size-full object-cover\"\n                      />\n                    </div>\r\n                  </Link>\r\n\r\n                  <div className=\"min-w-0 flex flex-col\">\r\n                    <Link\r\n                      href={item.username ? `/${item.username}/${item.slug || item.product_id}` : \"#\"}\r\n                      onClick={() => setOpen(false)}\r\n                      className=\"text-sm text-foreground line-clamp-2 leading-snug hover:text-primary\"\r\n                    >\r\n                      {item.title}\r\n                    </Link>\r\n                    <p className=\"text-sm font-semibold tabular-nums text-foreground mt-auto pt-1\">{formatPrice(item.price)}</p>\r\n                  </div>\r\n\n                  <div className=\"flex flex-col items-end justify-between\">\n                    <IconButton\n                      data-vaul-no-drag\n                      onClick={() => handleMoveToCart(item)}\n                      variant=\"ghost\"\n                      size=\"icon-compact\"\n                      className=\"text-foreground hover:bg-muted active:bg-muted\"\n                      aria-label={t(\"add\")}\n                    >\n                      <ShoppingCart size={18} weight=\"regular\" />\n                    </IconButton>\n                    <IconButton\n                      data-vaul-no-drag\n                      onClick={() => {\n                        removeFromWishlist(item.product_id)\n                        toast.success(t(\"removed\"))\n                      }}\n                      variant=\"ghost\"\n                      size=\"icon-compact\"\n                      className=\"text-muted-foreground hover:text-destructive hover:bg-destructive-subtle active:bg-destructive-subtle\"\n                      aria-label={t(\"remove\")}\n                    >\n                      <Trash size={16} weight=\"regular\" />\n                    </IconButton>\n                  </div>\n                </div>\n              ))}\n            </DrawerBody>\r\n\r\n            <DrawerFooter className=\"border-t border-border gap-1\">\n              <Button asChild variant=\"cta\" size=\"default\" className=\"w-full\" onClick={() => setOpen(false)}>\r\n                <Link href=\"/account/wishlist\" className=\"gap-1\">\n                  {t(\"viewAll\")}\r\n                  <ArrowRight size={14} />\r\n                </Link>\r\n              </Button>\r\n            </DrawerFooter>\r\n          </>\r\n        )}\r\n      </DrawerContent>\r\n    </Drawer>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\support\\customer-service-chat.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\support\\support-chat-widget.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used.","line":16,"column":42,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":43,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"X"},"fix":{"range":[524,527],"text":""},"desc":"Remove unused variable \"X\"."}]},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'formatTime' to the outer scope.","line":273,"column":40,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":273,"endColumn":42}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useRef, useCallback } from \"react\"\r\nimport { createClient } from \"@/lib/supabase/client\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\"\r\nimport { Avatar, AvatarFallback, AvatarImage } from \"@/components/ui/avatar\"\r\nimport {\r\n  Sheet,\r\n  SheetContent,\r\n  SheetHeader,\r\n  SheetTitle,\r\n  SheetTrigger,\r\n} from \"@/components/ui/sheet\"\r\nimport { ChatCircleDots, PaperPlaneTilt, X, Headphones } from \"@phosphor-icons/react\"\r\nimport { Spinner } from \"@/components/shared/spinner\"\r\nimport { useTranslations } from \"next-intl\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { AuthGateCard } from \"@/components/shared/auth/auth-gate-card\"\r\n\r\n// Support chat configuration\r\nconst SUPPORT_SUBJECT = \"SUPPORT_CHAT\"\r\n\r\ninterface SupportMessage {\r\n  id: string\r\n  content: string\r\n  sender_id: string\r\n  is_support: boolean\r\n  created_at: string\r\n  sender_name?: string\r\n}\r\n\r\ninterface SupportChatWidgetProps {\r\n  className?: string\r\n  /** External control for open state */\r\n  isOpen?: boolean\r\n  /** Callback when open state changes */\r\n  onOpenChange?: (open: boolean) => void\r\n  /** Hide the floating trigger button (for external control) */\r\n  hideTrigger?: boolean\r\n}\r\n\r\nexport function SupportChatWidget({\r\n  className,\r\n  isOpen: controlledIsOpen,\r\n  onOpenChange,\r\n  hideTrigger = false,\r\n}: SupportChatWidgetProps) {\r\n  const t = useTranslations(\"CustomerService\")\r\n  const tCommon = useTranslations(\"Common\")\r\n  const supabase = createClient()\r\n\r\n  // Support both controlled and uncontrolled modes\r\n  const [uncontrolledIsOpen, setUncontrolledIsOpen] = useState(false)\r\n  const isOpen = controlledIsOpen !== undefined ? controlledIsOpen : uncontrolledIsOpen\r\n  const setIsOpen = (open: boolean) => {\r\n    if (onOpenChange) {\r\n      onOpenChange(open)\r\n    }\r\n    setUncontrolledIsOpen(open)\r\n  }\r\n  const [messages, setMessages] = useState<SupportMessage[]>([])\r\n  const [newMessage, setNewMessage] = useState(\"\")\r\n  const [isLoading, setIsLoading] = useState(false)\r\n  const [isSending, setIsSending] = useState(false)\r\n  const [conversationId, setConversationId] = useState<string | null>(null)\r\n  const [userId, setUserId] = useState<string | null>(null)\r\n  const [isAuthenticated, setIsAuthenticated] = useState(false)\r\n  const scrollRef = useRef<HTMLDivElement>(null)\r\n  const inputRef = useRef<HTMLInputElement>(null)\r\n\r\n  // Check authentication status\r\n  useEffect(() => {\r\n    const checkAuth = async () => {\r\n      const { data: { user } } = await supabase.auth.getUser()\r\n      setIsAuthenticated(!!user)\r\n      setUserId(user?.id || null)\r\n    }\r\n    checkAuth()\r\n\r\n    const { data: { subscription } } = supabase.auth.onAuthStateChange((_, session) => {\r\n      setIsAuthenticated(!!session?.user)\r\n      setUserId(session?.user?.id || null)\r\n    })\r\n\r\n    return () => subscription.unsubscribe()\r\n  }, [supabase])\r\n\r\n  // Load or create support conversation\r\n  const loadConversation = useCallback(async () => {\r\n    if (!userId) return\r\n\r\n    setIsLoading(true)\r\n    try {\r\n      // Check for existing support conversation\r\n      const { data: existingConv } = await supabase\r\n        .from(\"conversations\")\r\n        .select(\"id\")\r\n        .eq(\"buyer_id\", userId)\r\n        .eq(\"subject\", SUPPORT_SUBJECT)\r\n        .single()\r\n\r\n      if (existingConv) {\r\n        setConversationId(existingConv.id)\r\n        // Load messages\r\n        const { data: msgs } = await supabase\r\n          .from(\"messages\")\r\n          .select(`\r\n            id,\r\n            content,\r\n            sender_id,\r\n            created_at\r\n          `)\r\n          .eq(\"conversation_id\", existingConv.id)\r\n          .order(\"created_at\", { ascending: true })\r\n\r\n        if (msgs) {\r\n          const formattedMsgs: SupportMessage[] = msgs.map(msg => ({\r\n            id: msg.id,\r\n            content: msg.content,\r\n            sender_id: msg.sender_id,\r\n            is_support: msg.sender_id !== userId,\r\n            created_at: msg.created_at,\r\n          }))\r\n          setMessages(formattedMsgs)\r\n        }\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Error loading support conversation:\", err)\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }, [supabase, userId])\r\n\r\n  // Load conversation when opened\r\n  useEffect(() => {\r\n    if (isOpen && isAuthenticated) {\r\n      loadConversation()\r\n    }\r\n  }, [isOpen, isAuthenticated, loadConversation])\r\n\r\n  // Set up realtime subscription\r\n  useEffect(() => {\r\n    if (!conversationId) return\r\n\r\n    const channel = supabase\r\n      .channel(`support-chat-${conversationId}`)\r\n      .on(\r\n        \"postgres_changes\",\r\n        {\r\n          event: \"INSERT\",\r\n          schema: \"public\",\r\n          table: \"messages\",\r\n          filter: `conversation_id=eq.${conversationId}`,\r\n        },\r\n        (payload) => {\r\n          const newMsg = payload.new as {\r\n            id: string\r\n            content: string\r\n            sender_id: string\r\n            created_at: string\r\n          }\r\n\r\n          // Avoid duplicates\r\n          setMessages(prev => {\r\n            if (prev.some(m => m.id === newMsg.id)) return prev\r\n            return [...prev, {\r\n              id: newMsg.id,\r\n              content: newMsg.content,\r\n              sender_id: newMsg.sender_id,\r\n              is_support: newMsg.sender_id !== userId,\r\n              created_at: newMsg.created_at,\r\n            }]\r\n          })\r\n        }\r\n      )\r\n      .subscribe()\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel)\r\n    }\r\n  }, [supabase, conversationId, userId])\r\n\r\n  // Scroll to bottom on new messages\r\n  useEffect(() => {\r\n    if (scrollRef.current) {\r\n      scrollRef.current.scrollTop = scrollRef.current.scrollHeight\r\n    }\r\n  }, [messages])\r\n\r\n  // Send message\r\n  const handleSend = async () => {\r\n    if (!newMessage.trim() || !userId || isSending) return\r\n\r\n    setIsSending(true)\r\n    const messageContent = newMessage.trim()\r\n    setNewMessage(\"\")\r\n\r\n    try {\r\n      let currentConvId = conversationId\r\n\r\n      // Create conversation if doesn't exist\r\n      if (!currentConvId) {\r\n        // Get first admin user as support agent\r\n        const { data: adminUser } = await supabase\r\n          .from(\"profiles\")\r\n          .select(\"id\")\r\n          .eq(\"role\", \"admin\")\r\n          .limit(1)\r\n          .single()\r\n\r\n        if (!adminUser) {\r\n          throw new Error(\"No support agent available\")\r\n        }\r\n\r\n        const { data: newConv, error: convError } = await supabase\r\n          .from(\"conversations\")\r\n          .insert({\r\n            buyer_id: userId,\r\n            seller_id: adminUser.id,\r\n            subject: SUPPORT_SUBJECT,\r\n            status: \"open\",\r\n          })\r\n          .select(\"id\")\r\n          .single()\r\n\r\n        if (convError) throw convError\r\n        currentConvId = newConv.id\r\n        setConversationId(currentConvId)\r\n      }\r\n\r\n      // Send message\r\n      const { error: msgError } = await supabase\r\n        .from(\"messages\")\r\n        .insert({\r\n          conversation_id: currentConvId,\r\n          sender_id: userId,\r\n          content: messageContent,\r\n          message_type: \"text\",\r\n        })\r\n\r\n      if (msgError) throw msgError\r\n\r\n      // Add optimistic message (will be confirmed by realtime)\r\n      const optimisticMsg: SupportMessage = {\r\n        id: `temp-${Date.now()}`,\r\n        content: messageContent,\r\n        sender_id: userId,\r\n        is_support: false,\r\n        created_at: new Date().toISOString(),\r\n      }\r\n      setMessages(prev => [...prev, optimisticMsg])\r\n\r\n    } catch (err) {\r\n      console.error(\"Error sending message:\", err)\r\n      // Restore message on error\r\n      setNewMessage(messageContent)\r\n    } finally {\r\n      setIsSending(false)\r\n      inputRef.current?.focus()\r\n    }\r\n  }\r\n\r\n  const handleKeyDown = (e: React.KeyboardEvent) => {\r\n    if (e.key === \"Enter\" && !e.shiftKey) {\r\n      e.preventDefault()\r\n      handleSend()\r\n    }\r\n  }\r\n\r\n  // Format time\r\n  const formatTime = (dateStr: string) => {\r\n    const date = new Date(dateStr)\r\n    return date.toLocaleTimeString([], { hour: \"2-digit\", minute: \"2-digit\" })\r\n  }\r\n\r\n  return (\r\n    <Sheet open={isOpen} onOpenChange={setIsOpen}>\r\n      {!hideTrigger && (\r\n        <SheetTrigger asChild>\r\n          <Button\r\n            size=\"lg\"\r\n            className={cn(\r\n              \"fixed bottom-4 right-4 z-50 h-12 w-12 rounded-full shadow bg-primary hover:bg-interactive-hover\",\r\n              \"md:bottom-6 md:right-6\",\r\n              className\r\n            )}\r\n            aria-label={t(\"startChatting\")}\r\n          >\r\n            <ChatCircleDots className=\"size-6\" weight=\"fill\" />\r\n          </Button>\r\n        </SheetTrigger>\r\n      )}\r\n      <SheetContent\r\n        side=\"right\"\r\n        className=\"w-full sm:w-(--container-modal-sm) p-0 flex flex-col\"\r\n      >\r\n        {/* Header */}\r\n        <SheetHeader className=\"px-4 py-3 border-b bg-primary text-primary-foreground\">\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"size-10 bg-muted rounded-full flex items-center justify-center\">\r\n              <Headphones className=\"size-5\" weight=\"fill\" />\r\n            </div>\r\n            <div className=\"flex-1\">\r\n              <SheetTitle className=\"text-primary-foreground text-lg\">{t(\"contactUs\")}</SheetTitle>\r\n              <p className=\"text-foreground text-sm\">{t(\"needMoreHelp\")}</p>\r\n            </div>\r\n          </div>\r\n        </SheetHeader>\r\n\r\n        {/* Messages area */}\r\n        <ScrollArea className=\"flex-1 p-4\" ref={scrollRef}>\r\n          {!isAuthenticated ? (\r\n            <div className=\"flex flex-col items-center justify-center h-full text-center py-8\">\r\n              <Headphones className=\"size-12 text-muted-foreground mb-4\" />\r\n              <AuthGateCard\r\n                title={t(\"signInRequired\")}\r\n                showBackToHome={false}\r\n                className=\"border-0 shadow-none bg-transparent max-w-none\"\r\n              />\r\n            </div>\r\n          ) : isLoading ? (\r\n            <div className=\"flex items-center justify-center h-full\">\r\n              <Spinner className=\"size-8 text-primary\" label={tCommon(\"loading\")} />\r\n            </div>\r\n          ) : messages.length === 0 ? (\r\n            <div className=\"flex flex-col items-center justify-center h-full text-center py-8\">\r\n              <ChatCircleDots className=\"size-12 text-muted-foreground mb-4\" />\r\n              <p className=\"text-muted-foreground\">\r\n                {t(\"startConversation\") || \"Start a conversation with our support team\"}\r\n              </p>\r\n              <p className=\"text-sm text-muted-foreground mt-2\">\r\n                help@treido.com\r\n              </p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-4\">\r\n              {messages.map((msg) => (\r\n                <div\r\n                  key={msg.id}\r\n                  className={cn(\r\n                    \"flex gap-2\",\r\n                    msg.is_support ? \"justify-start\" : \"justify-end\"\r\n                  )}\r\n                >\r\n                  {msg.is_support && (\r\n                    <Avatar className=\"size-8 shrink-0\">\r\n                      <AvatarImage src=\"/images/support-avatar.png\" />\r\n                      <AvatarFallback className=\"bg-primary text-primary-foreground text-xs\">\r\n                        TS\r\n                      </AvatarFallback>\r\n                    </Avatar>\r\n                  )}\r\n                  <div\r\n                    className={cn(\r\n                      \"max-w-(--support-chat-message-max-w) rounded-lg px-3 py-2\",\r\n                      msg.is_support\r\n                        ? \"bg-muted text-foreground\"\r\n                        : \"bg-primary text-primary-foreground\"\r\n                    )}\r\n                  >\r\n                    <p className=\"text-sm whitespace-pre-wrap wrap-break-word\">\r\n                      {msg.content}\r\n                    </p>\r\n                    <p\r\n                      className={cn(\r\n                        \"text-2xs mt-1\",\r\n                        msg.is_support ? \"text-muted-foreground\" : \"text-foreground\"\r\n                      )}\r\n                    >\r\n                      {formatTime(msg.created_at)}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </ScrollArea>\r\n\r\n        {/* Input area */}\r\n        {isAuthenticated && (\r\n          <div className=\"border-t p-4\">\r\n            <div className=\"flex gap-2\">\r\n              <Input\r\n                ref={inputRef}\r\n                value={newMessage}\r\n                onChange={(e) => setNewMessage(e.target.value)}\r\n                onKeyDown={handleKeyDown}\r\n                placeholder={t(\"typeMessage\") || \"Type a message...\"}\r\n                disabled={isSending}\r\n                className=\"flex-1\"\r\n              />\r\n              <Button\n                size=\"icon\"\n                onClick={handleSend}\n                disabled={!newMessage.trim() || isSending}\n                className=\"bg-primary hover:bg-interactive-hover shrink-0\"\n                aria-label={t(\"sendMessage\")}\n              >\n                {isSending ? (\r\n                  <Spinner className=\"size-4\" label={tCommon(\"loading\")} />\r\n                ) : (\r\n                  <PaperPlaneTilt className=\"size-4\" weight=\"fill\" />\r\n                )}\r\n              </Button>\r\n            </div>\r\n            <p className=\"text-xs text-muted-foreground mt-2 text-center\">\r\n              {t(\"emailAlternative\") || \"Or email us at\"}{\" \"}\r\n              <a href=\"mailto:help@treido.com\" className=\"text-primary hover:underline\">\r\n                help@treido.com\r\n              </a>\r\n            </p>\r\n          </div>\r\n        )}\r\n      </SheetContent>\r\n    </Sheet>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\accordion.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\alert-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\alert.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\aspect-ratio.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\badge.tsx","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 5 times.","line":29,"column":27,"nodeType":"Literal","endLine":29,"endColumn":73}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport { Slot } from \"@radix-ui/react-slot\"\r\nimport { cva, type VariantProps } from \"class-variance-authority\"\r\n\r\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex w-fit shrink-0 select-none items-center justify-center whitespace-nowrap rounded-full border font-medium leading-none transition-colors [&>svg]:shrink-0\",\n  {\n    variants: {\n      size: {\n        compact: \"min-h-4.5 gap-1 px-1.5 text-2xs [&>svg]:size-2.5\",\n        default: \"min-h-5 gap-1 px-2 text-2xs [&>svg]:size-3\",\n        prominent: \"min-h-6 gap-1.5 px-2.5 text-xs [&>svg]:size-3.5\",\n      },\n      variant: {\n        // Base (shadcn-like)\n        default: \"border-transparent bg-secondary text-secondary-foreground\",\n        secondary: \"border-border bg-muted text-muted-foreground\",\n        outline: \"border-border bg-background text-foreground\",\n        destructive: \"border-transparent bg-destructive text-destructive-foreground\",\n\n        // Canonical semantic statuses\n        success: \"border-transparent bg-success text-success-foreground\",\n        warning: \"border-transparent bg-warning text-warning-foreground\",\n        critical: \"border-transparent bg-destructive text-destructive-foreground\",\n        info: \"border-transparent bg-info text-info-foreground\",\n\n        \"success-subtle\": \"border-border bg-success-subtle text-success\",\n        \"warning-subtle\": \"border-border bg-primary-subtle text-warning\",\n        \"critical-subtle\": \"border-border bg-destructive-subtle text-destructive\",\n        \"info-subtle\": \"border-border bg-primary-subtle text-info\",\n        \"neutral-subtle\": \"border-border bg-muted text-muted-foreground\",\n\n        // Canonical condition variants\n        \"condition-new\": \"border-border bg-condition-new-bg text-condition-new\",\n        \"condition-likenew\": \"border-border bg-condition-likenew-bg text-condition-likenew\",\n        \"condition-good\": \"border-border bg-condition-good-bg text-condition-good\",\n        \"condition-fair\": \"border-border bg-condition-fair-bg text-condition-fair\",\n        \"condition-used\": \"border-border bg-condition-used-bg text-condition-used\",\n        \"condition-refurb\": \"border-border bg-condition-refurb-bg text-condition-refurb\",\n        condition: \"border-border bg-badge-condition-bg text-badge-condition-text\",\n        \"condition-outline\": \"border-border bg-background text-foreground\",\n\n        // Canonical shipping variants\n        shipping: \"border-border bg-badge-shipping-bg text-badge-shipping-text\",\n        \"shipping-free\": \"border-border bg-success-subtle text-success\",\n        \"shipping-subtle\": \"border-border bg-success-subtle text-success\",\n        \"shipping-express\": \"border-transparent bg-warning text-warning-foreground\",\n\n        // Canonical stock variants\n        \"stock-available\": \"border-border bg-success-subtle text-success\",\n        \"stock-low\": \"border-border bg-badge-stock-bg text-badge-stock-text\",\n        \"stock-out\": \"border-border bg-destructive-subtle text-destructive line-through\",\n\n        // Canonical commerce variants\n        promo: \"border-transparent bg-destructive text-destructive-foreground\",\n        discount: \"border-transparent bg-destructive text-destructive-foreground font-semibold tabular-nums\",\n        deal: \"border-transparent bg-destructive text-destructive-foreground font-semibold\",\n        sale: \"border-transparent bg-destructive text-destructive-foreground font-semibold\",\n        \"limited-time\": \"border-transparent bg-destructive text-destructive-foreground font-semibold\",\n        promoted: \"border-transparent bg-promoted text-promoted-foreground font-semibold\",\n        sponsored: \"border-transparent bg-promoted text-promoted-foreground font-semibold\",\n\n        // Canonical trust variants\n        \"verified-business\": \"border-transparent bg-verified-business text-verified-business-foreground\",\n        \"verified-personal\": \"border-transparent bg-verified-personal text-verified-personal-foreground\",\n        verified: \"border-transparent bg-verified-personal text-verified-personal-foreground\",\n        \"verified-solid\": \"border-transparent bg-verified-business text-verified-business-foreground\",\n        \"top-rated\": \"border-transparent bg-top-rated text-top-rated-foreground\",\n\n        category: \"border-border bg-category-badge-bg text-category-badge-text\",\n\n        // Backward-compatible aliases\n        \"condition-pro\": \"border-border bg-background text-foreground font-semibold tracking-wide\",\n        \"shipping-pro\": \"border-border bg-success-subtle text-success\",\n        \"stock-urgent\": \"border-border bg-destructive-subtle text-destructive font-semibold\",\n      },\n    },\n    defaultVariants: {\n      size: \"default\",\n      variant: \"default\",\n    },\n  }\n)\n\r\n/**\r\n * Badge component for marketplace use cases\r\n */\r\nfunction Badge({\n  className,\n  variant,\n  size,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"span\"> &\n  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"span\"\n\n  return (\n    <Comp\n      data-slot=\"badge\"\n      className={cn(badgeVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n}\n\r\nexport { Badge, badgeVariants }\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\breadcrumb.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BreadcrumbEllipsis' is defined but never used.","line":83,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":83,"endColumn":28}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport { Slot } from \"@radix-ui/react-slot\"\r\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nfunction Breadcrumb({ ...props }: React.ComponentProps<\"nav\">) {\r\n  return <nav data-slot=\"breadcrumb\" {...props} />\r\n}\r\n\r\nfunction BreadcrumbList({ className, ...props }: React.ComponentProps<\"ol\">) {\r\n  return (\r\n    <ol\r\n      data-slot=\"breadcrumb-list\"\r\n      className={cn(\r\n        \"text-muted-foreground flex flex-wrap items-center gap-1.5 text-sm break-words sm:gap-2.5\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction BreadcrumbItem({ className, ...props }: React.ComponentProps<\"li\">) {\r\n  return (\r\n    <li\r\n      data-slot=\"breadcrumb-item\"\r\n      className={cn(\"inline-flex items-center gap-1.5\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction BreadcrumbLink({\r\n  asChild,\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<\"a\"> & {\r\n  asChild?: boolean\r\n}) {\r\n  const Comp = asChild ? Slot : \"a\"\r\n\r\n  return (\r\n    <Comp\r\n      data-slot=\"breadcrumb-link\"\r\n      className={cn(\"hover:text-foreground transition-colors\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction BreadcrumbPage({ className, ...props }: React.ComponentProps<\"span\">) {\r\n  return (\r\n    <span\r\n      data-slot=\"breadcrumb-page\"\r\n      role=\"link\"\r\n      aria-disabled=\"true\"\r\n      aria-current=\"page\"\r\n      className={cn(\"text-foreground font-normal\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction BreadcrumbSeparator({\r\n  children,\r\n  className,\r\n  ...props\r\n}: React.ComponentProps<\"li\">) {\r\n  return (\r\n    <li\r\n      data-slot=\"breadcrumb-separator\"\r\n      role=\"presentation\"\r\n      aria-hidden=\"true\"\r\n      className={cn(\"[&>svg]:size-3.5\", className)}\r\n      {...props}\r\n    >\r\n      {children ?? <ChevronRight />}\r\n    </li>\r\n  )\r\n}\r\n\r\nfunction BreadcrumbEllipsis({\r\n  className,\r\n  label,\r\n  ...props\r\n}: React.ComponentProps<\"span\"> & {\r\n  label?: string\r\n}) {\r\n  return (\r\n    <span\r\n      data-slot=\"breadcrumb-ellipsis\"\r\n      role=\"presentation\"\r\n      aria-hidden=\"true\"\r\n      className={cn(\"flex size-9 items-center justify-center\", className)}\r\n      {...props}\r\n    >\r\n      <MoreHorizontal className=\"size-4\" />\r\n      {label ? <span className=\"sr-only\">{label}</span> : null}\r\n    </span>\r\n  )\r\n}\r\n\r\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\checkbox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\command.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\hover-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\icon-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\pagination.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\progress.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\radio-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\separator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\slider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\surface.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\switch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\table.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TableFooter' is defined but never used.","line":40,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":40,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from 'react'\r\n\r\nimport { cn } from '@/lib/utils'\r\n\r\nfunction Table({ className, ...props }: React.ComponentProps<'table'>) {\r\n  return (\r\n    <div\r\n      data-slot=\"table-container\"\r\n      className=\"relative w-full overflow-x-auto\"\r\n    >\r\n      <table\r\n        data-slot=\"table\"\r\n        className={cn('w-full caption-bottom text-sm', className)}\r\n        {...props}\r\n      />\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction TableHeader({ className, ...props }: React.ComponentProps<'thead'>) {\r\n  return (\r\n    <thead\r\n      data-slot=\"table-header\"\r\n      className={cn('', className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction TableBody({ className, ...props }: React.ComponentProps<'tbody'>) {\r\n  return (\r\n    <tbody\r\n      data-slot=\"table-body\"\r\n      className={cn('', className)}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction TableFooter({ className, ...props }: React.ComponentProps<'tfoot'>) {\n  return (\n    <tfoot\n      data-slot=\"table-footer\"\n      className={cn('bg-surface-subtle border-t font-medium', className)}\n      {...props}\n    />\n  )\n}\n\r\nfunction TableRow({ className, ...props }: React.ComponentProps<'tr'>) {\n  return (\n    <tr\n      data-slot=\"table-row\"\n      className={cn(\n        'ui-table-row hover:bg-hover border-b last:border-0 transition-colors',\n        className,\n      )}\n      {...props}\n    />\n  )\n}\n\r\nfunction TableHead({ className, ...props }: React.ComponentProps<'th'>) {\r\n  return (\r\n    <th\r\n      data-slot=\"table-head\"\r\n      className={cn(\r\n        'ui-table-head text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap',\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nfunction TableCell({ className, ...props }: React.ComponentProps<'td'>) {\r\n  return (\r\n    <td\r\n      data-slot=\"table-cell\"\r\n      className={cn(\r\n        'ui-table-cell p-2 align-middle whitespace-nowrap',\r\n        className,\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableHead,\n  TableRow,\n  TableCell,\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\toggle-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\toggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\components\\ui\\tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\app\\[[...mdxPath]]\\page.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\app\\layout.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\content\\_meta.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\content\\business\\_meta.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\content\\business\\decisions\\_meta.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\content\\business\\investors\\_meta.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\content\\business\\ops\\_meta.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\content\\business\\product\\_meta.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\content\\business\\product\\ux\\_meta.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\content\\business\\specs\\_meta.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\content\\guides\\_meta.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\content\\guides\\ios-marketplace-ui-pack\\_meta.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\content\\help\\_meta.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\content\\payments\\_meta.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\content\\policies\\_meta.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\mdx-components.jsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\docs-site\\next.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\accessibility.spec.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_makeAxeBuilder' is defined but never used.","line":161,"column":68,"nodeType":"Identifier","messageId":"unusedVar","endLine":161,"endColumn":83},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_makeAxeBuilder' is defined but never used.","line":372,"column":73,"nodeType":"Identifier","messageId":"unusedVar","endLine":372,"endColumn":88}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { test, expect, formatViolations } from './fixtures/axe-test'\r\nimport type { Page } from './fixtures/test'\r\n\r\n/**\r\n * Accessibility Tests for WCAG 2.1 AA Compliance\r\n * \r\n * These tests verify:\r\n * - Automated WCAG 2.1 Level AA compliance\r\n * - Keyboard navigation\r\n * - Screen reader compatibility (ARIA)\r\n * - Color contrast\r\n * - Form accessibility\r\n * \r\n * Run with: pnpm test:a11y\r\n * \r\n * Note: These tests use @axe-core/playwright which catches ~30-50% of accessibility issues.\r\n * Manual testing is still required for complete WCAG compliance.\r\n */\r\n\r\n// ============================================================================\r\n// Test Configuration\r\n// ============================================================================\r\n\r\n/**\r\n * Routes to test for accessibility\r\n * Testing both English and Bulgarian to catch locale-specific issues\r\n */\r\nconst A11Y_ROUTES = [\n  { name: 'Homepage (EN)', path: '/en' },\n  { name: 'Homepage (BG)', path: '/bg' },\n  { name: 'Categories', path: '/en/categories' },\n  { name: 'Category Detail', path: '/en/categories/electronics' },\n  { name: 'Search Results', path: '/en/search?q=phone' },\n  { name: 'Cart', path: '/en/cart' },\n] as const\n\r\n/**\r\n * Known violations to track but not fail on (temporary)\r\n * Document why each is here and create tickets to fix them\r\n * \r\n * Navigation menu ARIA structure issues - requires refactoring:\r\n * - aria-required-children: Category dropdown panel has invalid children structure\r\n * - list/listitem: NavigationMenuList structure has intermediate divs\r\n * - button-name: Some navigation/filter buttons need accessible names\r\n */\r\nconst KNOWN_VIOLATIONS: Record<string, string> = {\r\n  // Navigation menu structure violations (requires refactoring)\r\n  'aria-required-children': 'Navigation mega-menu dropdown has nav/list children in role=\"menu\"',\r\n  'list': 'NavigationMenuList has intermediate div elements breaking ul/li structure',\r\n  'listitem': 'NavigationMenuItem (li) is inside div instead of direct ul child',\r\n  'button-name': 'Some navigation buttons in header/mega-menu need aria-labels',\r\n}\r\n\r\n// ============================================================================\r\n// Helper Functions\r\n// ============================================================================\r\n\r\n/**\r\n * Wait for page to be fully loaded and interactive\r\n */\r\nasync function waitForPageReady(page: Page) {\r\n  // Avoid 'networkidle' in Next.js dev mode (HMR/websockets can keep the network busy)\r\n  await page.waitForLoadState('domcontentloaded')\r\n  await page.locator('main').first().waitFor({ state: 'visible' })\r\n  // Give a brief moment for client hydration / lazy content\r\n  await page.waitForTimeout(250)\r\n}\r\n\r\n// ============================================================================\r\n// Full Page Accessibility Tests\r\n// ============================================================================\r\n\r\ntest.describe('Accessibility - Full Page Scans @accessibility', () => {\r\n  for (const route of A11Y_ROUTES) {\r\n    test(`${route.name} has no accessibility violations`, async ({ page, makeAxeBuilder }) => {\r\n      await page.goto(route.path)\r\n      await waitForPageReady(page)\r\n\r\n      const accessibilityScanResults = await makeAxeBuilder().analyze()\r\n\r\n      // Filter out known violations\r\n      const newViolations = accessibilityScanResults.violations.filter(\r\n        (v) => !KNOWN_VIOLATIONS[v.id]\r\n      )\r\n\r\n      // Assert no new violations\r\n      if (newViolations.length > 0) {\r\n        const formattedViolations = formatViolations(newViolations)\r\n        throw new Error(`Accessibility violations found on ${route.name}:\\n${formattedViolations}`)\r\n      }\r\n\r\n      expect(accessibilityScanResults.violations).toEqual([])\r\n    })\r\n  }\r\n})\r\n\r\n// ============================================================================\r\n// Component-Specific Accessibility Tests\r\n// ============================================================================\r\n\r\ntest.describe('Accessibility - Navigation @accessibility', () => {\n  test('main navigation is accessible', async ({ page, makeAxeBuilder }) => {\r\n    await page.goto('/en')\r\n    await waitForPageReady(page)\r\n\r\n    // Test header/navigation specifically\r\n    const header = page.locator('header').first()\r\n    await expect(header).toBeVisible()\r\n\r\n    const results = await makeAxeBuilder()\r\n      .include('header')\r\n      .analyze()\r\n\r\n    expect(results.violations).toEqual([])\r\n  })\r\n\r\n  test('navigation is keyboard accessible', async ({ page }) => {\r\n    await page.goto('/en')\r\n    await waitForPageReady(page)\r\n\r\n    // Press Tab multiple times and verify focus moves through interactive elements\r\n    await page.keyboard.press('Tab')\r\n    \r\n    // First focusable element should receive focus\r\n    const firstFocused = await page.evaluate(() => {\r\n      const el = document.activeElement\r\n      return el?.tagName.toLowerCase()\r\n    })\r\n\r\n    // Should focus on an interactive element (link, button, input)\r\n    expect(['a', 'button', 'input', 'select', 'textarea']).toContain(firstFocused)\r\n\r\n    // Tab through several elements\r\n    for (let i = 0; i < 5; i++) {\r\n      await page.keyboard.press('Tab')\r\n    }\r\n\r\n    // Focus should still be on an interactive element\r\n    const laterFocused = await page.evaluate(() => {\r\n      const el = document.activeElement\r\n      return el?.tagName.toLowerCase()\r\n    })\r\n\r\n    expect(['a', 'button', 'input', 'select', 'textarea', 'body']).toContain(laterFocused)\r\n  })\n\n  test('mobile filter controls expose accessible buttons', async ({ page }) => {\n    await page.setViewportSize({ width: 390, height: 844 })\n    await page.goto('/en/search?q=phone')\n    await waitForPageReady(page)\n\n    const filterBar = page.getByTestId('mobile-filter-sort-bar')\n    await expect(filterBar).toBeVisible()\n    await expect(filterBar.getByRole('button', { name: /filters/i })).toBeVisible()\n    await expect(filterBar.getByRole('button', { name: /sort/i })).toBeVisible()\n    await expect(page.getByTestId('mobile-location-chip')).toBeVisible()\n  })\n})\n\r\ntest.describe('Accessibility - Forms @accessibility', () => {\r\n  test('search form is accessible', async ({ page, makeAxeBuilder: _makeAxeBuilder }) => {\r\n    await page.goto('/en')\r\n    await waitForPageReady(page)\r\n\r\n    // Find search input\r\n    const searchInput = page.getByRole('searchbox')\r\n      .or(page.getByRole('textbox', { name: /search/i }))\r\n      .or(page.locator('input[type=\"search\"]'))\r\n      .or(page.locator('[data-testid=\"search-input\"]'))\r\n\r\n    // If search exists on homepage, test it\r\n    const searchCount = await searchInput.count()\r\n    if (searchCount > 0) {\r\n      // Search should have accessible name\r\n      const accessibleName = await searchInput.first().getAttribute('aria-label') ||\r\n        await searchInput.first().getAttribute('placeholder') ||\r\n        await page.evaluate((el) => {\r\n          const input = el as HTMLInputElement\r\n          const labelId = input.getAttribute('aria-labelledby')\r\n          if (labelId) {\r\n            return document.getElementById(labelId)?.textContent || ''\r\n          }\r\n          const label = document.querySelector(`label[for=\"${input.id}\"]`)\r\n          return label?.textContent || ''\r\n        }, await searchInput.first().elementHandle())\r\n\r\n      expect(accessibleName).toBeTruthy()\r\n    }\r\n  })\r\n\r\n  test('cart page form elements are accessible', async ({ page, makeAxeBuilder }) => {\r\n    await page.goto('/en/cart')\r\n    await waitForPageReady(page)\r\n\r\n    // Test any form elements on the cart page\r\n    const results = await makeAxeBuilder()\r\n      .include('main')\r\n      .analyze()\r\n\r\n    // Filter form-related violations\r\n    const formViolations = results.violations.filter((v) =>\r\n      ['label', 'form-field-multiple-labels', 'input-button-name', 'select-name'].includes(v.id)\r\n    )\r\n\r\n    expect(formViolations).toEqual([])\r\n  })\r\n})\r\n\r\n// ============================================================================\r\n// Focus Management Tests\r\n// ============================================================================\r\n\r\ntest.describe('Accessibility - Focus Management @accessibility', () => {\r\n  test('focus is visible on interactive elements', async ({ page }) => {\r\n    await page.goto('/en')\r\n    await waitForPageReady(page)\r\n\r\n    // Tab to an element\r\n    await page.keyboard.press('Tab')\r\n\r\n    // Check if focus is visible (element has focus styles)\r\n    const hasFocusIndicator = await page.evaluate(() => {\r\n      const el = document.activeElement\r\n      if (!el) return false\r\n\r\n      const styles = window.getComputedStyle(el)\r\n      window.getComputedStyle(el, ':focus')\r\n\r\n      // Check for common focus indicators\r\n      const hasOutline = styles.outline !== 'none' && styles.outline !== ''\r\n      const hasBoxShadow = styles.boxShadow !== 'none' && styles.boxShadow !== ''\r\n      const hasBorder = styles.borderColor !== '' || styles.borderWidth !== '0px'\r\n\r\n      return hasOutline || hasBoxShadow || hasBorder\r\n    })\r\n\r\n    // This might need adjustment based on your focus styles\r\n    // The test ensures SOME focus indicator exists\r\n    expect(hasFocusIndicator).toBe(true)\r\n  })\r\n\r\n  test('skip link exists and works', async ({ page }) => {\r\n    await page.goto('/en')\r\n\r\n    // Press Tab once - skip link should be first focusable\r\n    await page.keyboard.press('Tab')\r\n\r\n    // Look for skip link\r\n    const skipLink = page.getByRole('link', { name: /skip to (main|content)/i })\r\n      .or(page.locator('a[href=\"#main\"]'))\r\n      .or(page.locator('a[href=\"#content\"]'))\r\n      .or(page.locator('.sr-only').filter({ hasText: /skip/i }))\r\n\r\n    const skipLinkCount = await skipLink.count()\r\n\r\n    // Skip link is a best practice but not always present\r\n    // Log whether it exists\r\n    if (skipLinkCount === 0) {\r\n      console.log('ΓÜá∩╕Å No skip link found - consider adding one for keyboard users')\r\n    }\r\n  })\r\n})\r\n\r\n// ============================================================================\r\n// Color Contrast Tests\r\n// ============================================================================\r\n\r\ntest.describe('Accessibility - Color Contrast @accessibility', () => {\r\n  test('text has sufficient color contrast', async ({ page, makeAxeBuilder }) => {\r\n    await page.goto('/en')\r\n    await waitForPageReady(page)\r\n\r\n    // Run only color contrast checks\r\n    const results = await makeAxeBuilder()\r\n      .withTags(['wcag2aa'])\r\n      .analyze()\r\n\r\n    const contrastViolations = results.violations.filter((v) =>\r\n      v.id === 'color-contrast'\r\n    )\r\n\r\n    if (contrastViolations.length > 0) {\r\n      const formatted = formatViolations(contrastViolations)\r\n      console.log(`Color contrast issues found:\\n${formatted}`)\r\n    }\r\n\r\n    expect(contrastViolations).toEqual([])\r\n  })\r\n})\r\n\r\n// ============================================================================\r\n// ARIA and Semantic HTML Tests\r\n// ============================================================================\r\n\r\ntest.describe('Accessibility - Semantic HTML @accessibility', () => {\r\n  test('page has proper heading hierarchy', async ({ page }) => {\r\n    await page.goto('/en')\r\n    await waitForPageReady(page)\r\n\r\n    // Get all headings\r\n    const headings = await page.evaluate(() => {\r\n      const allHeadings = document.querySelectorAll('h1, h2, h3, h4, h5, h6')\r\n      return [...allHeadings].map((h) => ({\r\n        level: Number.parseInt(h.tagName.slice(1)),\r\n        text: h.textContent?.trim().slice(0, 50),\r\n      }))\r\n    })\r\n\r\n    // Should have at least one h1\r\n    const h1Count = headings.filter((h) => h.level === 1).length\r\n    expect(h1Count).toBeGreaterThan(0)\r\n\r\n    // Should not have more than one h1 (best practice)\r\n    if (h1Count > 1) {\r\n      console.log(`ΓÜá∩╕Å Found ${h1Count} h1 elements - consider using only one h1 per page`)\r\n    }\r\n\r\n    // Check for heading level skips (e.g., h1 -> h3)\r\n    for (let i = 1; i < headings.length; i++) {\r\n      const prev = headings[i - 1]\r\n      const curr = headings[i]\r\n      if (!prev || !curr) continue\r\n\r\n      const prevLevel = prev.level\r\n      const currLevel = curr.level\r\n      \r\n      // Allow going to any lower level, but not skipping when going higher\r\n      if (currLevel > prevLevel && currLevel - prevLevel > 1) {\r\n        console.log(`ΓÜá∩╕Å Heading level skip: h${prevLevel} -> h${currLevel}`)\r\n      }\r\n    }\r\n  })\r\n\r\n  test('images have alt text', async ({ page, makeAxeBuilder }) => {\r\n    await page.goto('/en')\r\n    await waitForPageReady(page)\r\n\r\n    const results = await makeAxeBuilder()\r\n      .withTags(['wcag2a'])\r\n      .analyze()\r\n\r\n    const imageViolations = results.violations.filter((v) =>\r\n      ['image-alt', 'input-image-alt', 'area-alt'].includes(v.id)\r\n    )\r\n\r\n    expect(imageViolations).toEqual([])\r\n  })\r\n\r\n  test('links have accessible names', async ({ page, makeAxeBuilder }) => {\r\n    await page.goto('/en')\r\n    await waitForPageReady(page)\r\n\r\n    const results = await makeAxeBuilder()\r\n      .withTags(['wcag2a', 'wcag2aa'])\r\n      .analyze()\r\n\r\n    const linkViolations = results.violations.filter((v) =>\r\n      ['link-name', 'link-in-text-block'].includes(v.id)\r\n    )\r\n\r\n    expect(linkViolations).toEqual([])\r\n  })\r\n})\r\n\r\n// ============================================================================\r\n// Mobile Accessibility Tests\r\n// ============================================================================\r\n\r\ntest.describe('Accessibility - Mobile @accessibility @mobile', () => {\r\n  test.use({ viewport: { width: 375, height: 667 } })\r\n\r\n  test('touch targets are large enough', async ({ page, makeAxeBuilder: _makeAxeBuilder }) => {\r\n    await page.goto('/en')\r\n    await waitForPageReady(page)\r\n\r\n    // Check interactive elements meet minimum touch target size\r\n    const smallTargets = await page.evaluate(() => {\r\n      const interactiveElements = document.querySelectorAll('a, button, input, select, [role=\"button\"], [tabindex=\"0\"]')\r\n      const tooSmall: string[] = []\r\n\r\n      interactiveElements.forEach((el) => {\r\n        const rect = el.getBoundingClientRect()\r\n        // WCAG 2.2 recommends 44x44 minimum, but 24x24 is acceptable\r\n        if ((rect.width < 24 || rect.height < 24) && // Ignore hidden elements\r\n          rect.width > 0 && rect.height > 0) {\r\n            tooSmall.push(`${el.tagName}: ${rect.width.toFixed(0)}x${rect.height.toFixed(0)}px`)\r\n          }\r\n      })\r\n\r\n      return tooSmall.slice(0, 5) // Return first 5\r\n    })\r\n\r\n    if (smallTargets.length > 0) {\r\n      console.log(`ΓÜá∩╕Å Small touch targets found: ${smallTargets.join(', ')}`)\r\n    }\r\n  })\r\n\r\n  test('mobile navigation is accessible', async ({ page, makeAxeBuilder }) => {\r\n    await page.goto('/en')\r\n    await waitForPageReady(page)\r\n\r\n    // Test mobile menu accessibility\r\n    const mobileMenuTrigger = page.getByRole('button', { name: /menu/i })\r\n      .or(page.locator('[data-testid=\"mobile-menu-trigger\"]'))\r\n      .or(page.locator('[aria-label*=\"menu\"]'))\r\n\r\n    const hasMobileMenu = (await mobileMenuTrigger.count()) > 0\r\n\r\n    if (hasMobileMenu) {\r\n      // Mobile menu trigger should be accessible\r\n      await expect(mobileMenuTrigger.first()).toBeVisible()\r\n\r\n      // Click to open\r\n      await mobileMenuTrigger.first().click()\r\n\r\n      // Run accessibility check on opened menu\r\n      const results = await makeAxeBuilder().analyze()\r\n      expect(results.violations).toEqual([])\r\n    }\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\account-phase5.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\auth.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\boost-checkout.spec.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'trigger' is assigned a value but never used.","line":24,"column":9,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'locale' is defined but never used.","line":43,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":43,"endColumn":53}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { test, expect } from './fixtures/test'\r\nimport { getTestUserCredentials, loginWithPassword } from './fixtures/auth'\r\n\r\ntype BoostMockOptions = {\r\n  locale: 'en' | 'bg'\r\n}\r\n\r\nasync function openBoostDialogOrSkip({ page, app }: { page: any; app: any }, locale: 'en' | 'bg') {\r\n  await app.clearAuthSession()\r\n\r\n  const creds = getTestUserCredentials()\r\n  test.skip(!creds, 'Set TEST_USER_EMAIL/TEST_USER_PASSWORD to run authenticated boost flow checks')\r\n\r\n  await loginWithPassword(page, creds!)\r\n\r\n  await app.goto(`/${locale}/account/selling`, { timeout: 60_000, retries: 3 })\r\n\r\n  // If seller profile isn't set up (no username), the app redirects to /sell.\r\n  if (page.url().includes(`/${locale}/sell`)) {\r\n    test.skip(true, 'Test user must have a seller username/profile to access /account/selling')\r\n  }\r\n\r\n  // Find a boost trigger (icon-only button on mobile cards or outline button on desktop).\r\n  const trigger = page.locator('button:has(svg)')\r\n    .filter({ has: page.locator('svg') })\r\n\r\n  // Prefer a visible button with the translated trigger text.\r\n  const textTrigger = page.getByRole('button', { name: locale === 'bg' ? '╨ƒ╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╣' : 'Boost' }).first()\r\n\r\n  if (await textTrigger.isVisible().catch(() => false)) {\r\n    await textTrigger.click()\r\n    return\r\n  }\r\n\r\n  // Fallback: click the first lightning-icon ghost button (best-effort).\r\n  const lightningButtons = page.locator('button').filter({ has: page.locator('svg') })\r\n  const count = await lightningButtons.count()\r\n  test.skip(count === 0, 'No boost triggers found on selling page (need at least one unboosted product)')\r\n\r\n  await lightningButtons.first().click()\r\n}\r\n\r\nasync function mockBoostCheckout(page: any, { locale }: BoostMockOptions) {\r\n  const requests: Array<{ locale?: string; durationDays?: string; productId?: string }> = []\r\n\r\n  await page.route('**/api/boost/checkout', async (route: any) => {\r\n    const req = route.request()\r\n    const postData = (req.postDataJSON?.() ?? {}) as any\r\n\r\n    requests.push({\r\n      locale: postData.locale,\r\n      durationDays: postData.durationDays,\r\n      productId: postData.productId,\r\n    })\r\n\r\n    const durationKey =\r\n      postData.durationDays === '1'\r\n        ? 'duration24h'\r\n        : postData.durationDays === '7'\r\n          ? 'duration7d'\r\n          : 'duration30d'\r\n\r\n    await route.fulfill({\r\n      status: 200,\r\n      contentType: 'application/json',\r\n      body: JSON.stringify({\r\n        url: null,\r\n        durationKey,\r\n      }),\r\n    })\r\n  })\r\n\r\n  return requests\r\n}\r\n\r\ntest.describe('Boost flow (DEC-003) - localized pricing + checkout payload', () => {\r\n  test.describe.configure({ timeout: 120_000 })\r\n\r\n  test('shows EUR + BGN approx and includes locale in checkout request (en) @boost @auth', async ({ page, app }) => {\r\n    const requests = await mockBoostCheckout(page, { locale: 'en' })\r\n\r\n    await openBoostDialogOrSkip({ page, app }, 'en')\r\n\r\n    // Assert all three options render EUR and BGN approximation.\r\n    await expect(page.getByText('Γé¼0.99')).toBeVisible()\r\n    await expect(page.getByText('Γé¼4.99')).toBeVisible()\r\n    await expect(page.getByText('Γé¼14.99')).toBeVisible()\r\n\r\n    await expect(page.getByText('Γëê1.94 ╨╗╨▓')).toBeVisible()\r\n    await expect(page.getByText('Γëê9.76 ╨╗╨▓')).toBeVisible()\r\n    await expect(page.getByText('Γëê29.32 ╨╗╨▓')).toBeVisible()\r\n\r\n    // Select each duration and trigger checkout (mocked).\r\n    await page.getByText('Γé¼0.99').click()\r\n    await page.getByRole('button', { name: /boost now/i }).click()\r\n\r\n    await page.getByText('Γé¼4.99').click()\r\n    await page.getByRole('button', { name: /boost now/i }).click()\r\n\r\n    await page.getByText('Γé¼14.99').click()\r\n    await page.getByRole('button', { name: /boost now/i }).click()\r\n\r\n    expect(requests.length).toBeGreaterThanOrEqual(3)\r\n\r\n    for (const req of requests.slice(-3)) {\r\n      expect(req.locale).toBe('en')\r\n      expect(req.durationDays).toMatch(/^(1|7|30)$/)\r\n      expect(req.productId).toBeTruthy()\r\n    }\r\n  })\r\n\r\n  test('shows EUR + BGN approx and includes locale in checkout request (bg) @boost @auth', async ({ page, app }) => {\r\n    const requests = await mockBoostCheckout(page, { locale: 'bg' })\r\n\r\n    await openBoostDialogOrSkip({ page, app }, 'bg')\r\n\r\n    await expect(page.getByText('Γé¼0.99')).toBeVisible()\r\n    await expect(page.getByText('Γé¼4.99')).toBeVisible()\r\n    await expect(page.getByText('Γé¼14.99')).toBeVisible()\r\n\r\n    await expect(page.getByText('Γëê1.94 ╨╗╨▓')).toBeVisible()\r\n    await expect(page.getByText('Γëê9.76 ╨╗╨▓')).toBeVisible()\r\n    await expect(page.getByText('Γëê29.32 ╨╗╨▓')).toBeVisible()\r\n\r\n    await page.getByText('Γé¼0.99').click()\r\n    await page.getByRole('button', { name: /╨┐╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╣ ╤ü╨╡╨│╨░/i }).click()\r\n\r\n    await page.getByText('Γé¼4.99').click()\r\n    await page.getByRole('button', { name: /╨┐╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╣ ╤ü╨╡╨│╨░/i }).click()\r\n\r\n    await page.getByText('Γé¼14.99').click()\r\n    await page.getByRole('button', { name: /╨┐╤Ç╨╛╨╝╨╛╤é╨╕╤Ç╨░╨╣ ╤ü╨╡╨│╨░/i }).click()\r\n\r\n    expect(requests.length).toBeGreaterThanOrEqual(3)\r\n\r\n    for (const req of requests.slice(-3)) {\r\n      expect(req.locale).toBe('bg')\r\n      expect(req.durationDays).toMatch(/^(1|7|30)$/)\r\n      expect(req.productId).toBeTruthy()\r\n    }\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\drawer-header-sticky.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\fixtures\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\fixtures\\authenticated.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"The `{}` (\"empty object\") type allows any non-nullish value, including literals like `0` and `\"\"`.\n- If that's what you want, disable this lint rule with an inline comment or configure the 'allowObjectTypes' rule option.\n- If you want a type meaning \"any object\", you probably want `object` instead.\n- If you want a type meaning \"any value\", you probably want `unknown` instead.","line":9,"column":37,"nodeType":"TSTypeLiteral","messageId":"noEmptyObject","endLine":9,"endColumn":39,"suggestions":[{"messageId":"replaceEmptyObjectType","data":{"replacement":"object"},"fix":{"range":[252,254],"text":"object"},"desc":"Replace `{}` with `object`."},{"messageId":"replaceEmptyObjectType","data":{"replacement":"unknown"},"fix":{"range":[252,254],"text":"unknown"},"desc":"Replace `{}` with `unknown`."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { test as baseTest, expect, type Page } from './test'\r\nimport { getTestUserCredentials, loginWithPassword } from './auth'\r\n\r\nimport fs from 'node:fs'\r\nimport path from 'node:path'\r\n\r\nexport * from './test'\r\n\r\nexport const test = baseTest.extend<{}, { workerStorageState: string }>({\r\n  // Reuse the same storage state for all tests in this worker.\r\n  storageState: ({ workerStorageState }, runFixture) => runFixture(workerStorageState),\r\n\r\n  // Authenticate once per worker and persist storageState to disk.\r\n  workerStorageState: [async ({ browser }, runFixture) => {\r\n    const creds = getTestUserCredentials()\r\n    if (!creds) {\r\n      throw new Error(\r\n        'Authenticated E2E tests require TEST_USER_EMAIL and TEST_USER_PASSWORD (or E2E_USER_EMAIL/E2E_USER_PASSWORD).'\r\n      )\r\n    }\r\n\r\n    const projectOutputDir = test.info().project.outputDir\r\n    const authDir = path.join(projectOutputDir, '.auth')\r\n    const id = test.info().parallelIndex\r\n    const fileName = path.join(authDir, `${id}.json`)\r\n\r\n    if (!fs.existsSync(authDir)) fs.mkdirSync(authDir, { recursive: true })\r\n\r\n    if (fs.existsSync(fileName)) {\r\n      await runFixture(fileName)\r\n      return\r\n    }\r\n\r\n    // Authenticate in a clean environment.\r\n    const page = await browser.newPage()\r\n\r\n    // Ensure modal/consent overlays never block login.\r\n    await page.addInitScript(() => {\r\n      try {\r\n        localStorage.setItem('geo-welcome-dismissed', 'true')\r\n        localStorage.setItem('cookie-consent', 'accepted')\r\n      } catch {\r\n        // ignore\r\n      }\r\n    })\r\n\r\n    await loginWithPassword(page as Page, creds)\r\n\r\n    await page.context().storageState({ path: fileName })\r\n    await page.close()\r\n\r\n    await runFixture(fileName)\r\n  }, { scope: 'worker' }],\r\n})\r\n\r\nexport { expect }\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\fixtures\\axe-test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\fixtures\\base.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\fixtures\\test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\global-setup.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\header-drawers.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\mobile-browse-filters.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\mobile-responsiveness.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\mobile-ux-audit-detailed.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\mobile-ux-audit.spec.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'devices' is defined but never used.","line":1,"column":24,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":31,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"devices"},"fix":{"range":[21,30],"text":""},"desc":"Remove unused variable \"devices\"."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { test, expect, devices } from '@playwright/test';\r\n\r\nconst BASE_URL = process.env.BASE_URL || 'http://localhost:3000';\r\n\r\n// Set mobile viewport at top level\r\ntest.use({ \r\n  viewport: { width: 390, height: 844 },\r\n  isMobile: true,\r\n  hasTouch: true,\r\n});\r\n\r\n// ========== PHASE 1: Homepage & Navigation ==========\r\ntest.describe('Phase 1: Homepage & Navigation', () => {\r\n    test('homepage loads correctly', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en`);\r\n      await expect(page).toHaveTitle(/Treido|Home/);\r\n      console.log('Γ£à Homepage title verified');\r\n    });\r\n\r\n    test('hero section displays', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en`);\r\n      // Look for main content area - use first() since there are nested mains\r\n      const main = page.locator('#main-content').first();\r\n      await expect(main).toBeVisible();\r\n      console.log('Γ£à Main content visible');\r\n    });\r\n\r\n    test('mobile navigation works', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en`);\r\n      \r\n      // Find mobile menu button\r\n      const menuButton = page.locator('button[aria-label*=\"menu\" i], [data-testid*=\"menu\"], header button:has(svg)').first();\r\n      \r\n      if (await menuButton.isVisible()) {\r\n        await menuButton.click();\r\n        await page.waitForTimeout(500);\r\n        \r\n        // Check for navigation links\r\n        const navLinks = page.locator('nav a, [role=\"dialog\"] a, [role=\"menu\"] a');\r\n        const count = await navLinks.count();\r\n        console.log(`Γ£à Mobile menu opened with ${count} links`);\r\n      } else {\r\n        console.log('Γä╣∩╕Å Mobile menu button not found - may have different design');\r\n      }\r\n    });\r\n\r\n    test('search functionality exists', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en`);\r\n      \r\n      const searchInput = page.locator('input[type=\"search\"], input[placeholder*=\"search\" i], input[name=\"q\"]');\r\n      const searchButton = page.locator('button[aria-label*=\"search\" i], [data-testid*=\"search\"]');\r\n      \r\n      const inputVisible = await searchInput.first().isVisible().catch(() => false);\r\n      const buttonVisible = await searchButton.first().isVisible().catch(() => false);\r\n      \r\n      expect(inputVisible || buttonVisible).toBeTruthy();\r\n      console.log(`Γ£à Search: input=${inputVisible}, button=${buttonVisible}`);\r\n    });\r\n\r\n    test('footer exists', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en`);\r\n      await page.evaluate(() => window.scrollTo(0, document.body.scrollHeight));\r\n      await page.waitForTimeout(300);\r\n      \r\n      const footer = page.locator('footer');\r\n      await expect(footer).toBeVisible();\r\n      console.log('Γ£à Footer visible');\r\n    });\r\n  });\r\n\r\n  // ========== PHASE 2: Category & Product Browsing ==========\r\n  test.describe('Phase 2: Category & Product Browsing', () => {\r\n    test('categories page loads', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/categories`);\r\n      await expect(page).toHaveURL(/categories/);\r\n      console.log('Γ£à Categories page loaded');\r\n    });\r\n\r\n    test('category links are visible', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/categories`);\r\n      await page.waitForLoadState('networkidle');\r\n      \r\n      const categoryLinks = page.locator('a[href*=\"/categories/\"], a[href*=\"/category/\"]');\r\n      const count = await categoryLinks.count();\r\n      \r\n      console.log(`Γ£à Found ${count} category links`);\r\n      expect(count).toBeGreaterThan(0);\r\n    });\r\n\r\n    test('category detail page loads', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/categories`);\r\n      await page.waitForLoadState('networkidle');\r\n      \r\n      const categoryLink = page.locator('a[href*=\"/categories/\"]').first();\r\n      if (await categoryLink.isVisible()) {\r\n        await categoryLink.click();\r\n        await page.waitForLoadState('networkidle');\r\n        console.log(`Γ£à Navigated to category: ${page.url()}`);\r\n      }\r\n    });\r\n  });\r\n\r\n  // ========== PHASE 3: Product Detail Page ==========\r\n  test.describe('Phase 3: Product Detail Page', () => {\r\n    test('can navigate to product detail', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en`);\r\n      await page.waitForLoadState('networkidle');\r\n      \r\n      const productLink = page.locator('a[href*=\"/products/\"], a[href*=\"/product/\"]').first();\r\n      \r\n      if (await productLink.isVisible().catch(() => false)) {\r\n        await productLink.click();\r\n        await page.waitForLoadState('networkidle');\r\n        console.log(`Γ£à Product page loaded: ${page.url()}`);\r\n        \r\n        // Check for product elements\r\n        const hasImage = await page.locator('img').first().isVisible();\r\n        const hasTitle = await page.locator('h1').first().isVisible();\r\n        \r\n        console.log(`Γ£à Product has image: ${hasImage}, title: ${hasTitle}`);\r\n      } else {\r\n        console.log('Γä╣∩╕Å No product links on homepage');\r\n      }\r\n    });\r\n  });\r\n\r\n  // ========== PHASE 4: Authentication Flow ==========\r\n  test.describe('Phase 4: Authentication Flow', () => {\r\n    test('sign-in page accessible', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/auth/sign-in`);\r\n      await page.waitForLoadState('networkidle');\r\n      \r\n      // Could redirect to /login\r\n      const url = page.url();\r\n      expect(url).toMatch(/sign-in|login|auth/);\r\n      console.log(`Γ£à Auth page: ${url}`);\r\n    });\r\n\r\n    test('sign-in form has required fields', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/auth/login`);\r\n      await page.waitForLoadState('networkidle');\r\n      \r\n      const emailInput = page.locator('input[type=\"email\"], input[name=\"email\"]');\r\n      const passwordInput = page.locator('input[type=\"password\"]');\r\n      const submitBtn = page.locator('button[type=\"submit\"]');\r\n      \r\n      await expect(emailInput.first()).toBeVisible();\r\n      await expect(passwordInput.first()).toBeVisible();\r\n      await expect(submitBtn.first()).toBeVisible();\r\n      console.log('Γ£à Login form has all required fields');\r\n    });\r\n\r\n    test('sign-up page accessible', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/auth/sign-up`);\r\n      await page.waitForLoadState('networkidle');\r\n      \r\n      const emailInput = page.locator('input[type=\"email\"], input[name=\"email\"]');\r\n      await expect(emailInput.first()).toBeVisible();\r\n      console.log('Γ£à Sign-up page has email field');\r\n    });\r\n  });\r\n\r\n  // ========== PHASE 5: User Account ==========\r\n  test.describe('Phase 5: User Account', () => {\r\n    test('account page redirects when not logged in', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/account`);\r\n      await page.waitForLoadState('networkidle');\r\n      \r\n      const url = page.url();\r\n      console.log(`Γ£à Account page URL: ${url}`);\r\n      // May redirect to auth or show account page\r\n    });\r\n\r\n    test('wishlist page accessible', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/wishlist`);\r\n      await page.waitForLoadState('networkidle');\r\n      console.log(`Γ£à Wishlist page: ${page.url()}`);\r\n    });\r\n  });\r\n\r\n  // ========== PHASE 6: Cart & Checkout ==========\r\n  test.describe('Phase 6: Cart & Checkout', () => {\r\n    test('cart page loads', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/cart`);\r\n      await page.waitForLoadState('networkidle');\r\n      \r\n      await expect(page).toHaveURL(/cart/);\r\n      console.log('Γ£à Cart page loaded');\r\n    });\r\n\r\n    test('checkout page loads', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/checkout`);\r\n      await page.waitForLoadState('networkidle');\r\n      console.log(`Γ£à Checkout page: ${page.url()}`);\r\n    });\r\n  });\r\n\r\n  // ========== PHASE 7: Seller Features ==========\r\n  test.describe('Phase 7: Seller Features', () => {\r\n    test('sell page loads', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/sell`);\r\n      await page.waitForLoadState('networkidle');\r\n      console.log(`Γ£à Sell page: ${page.url()}`);\r\n    });\r\n\r\n    test('seller dashboard accessible', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/seller`);\r\n      await page.waitForLoadState('networkidle');\r\n      console.log(`Γ£à Seller page: ${page.url()}`);\r\n    });\r\n  });\r\n\r\n  // ========== PHASE 8: Plans ==========\r\n  test.describe('Phase 8: Plans & Subscriptions', () => {\r\n    test('plans page loads', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/plans`);\r\n      await page.waitForLoadState('networkidle');\r\n      \r\n      await expect(page).toHaveURL(/plans/);\r\n      console.log('Γ£à Plans page loaded');\r\n    });\r\n\r\n    test('plan cards visible', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/plans`);\r\n      await page.waitForLoadState('networkidle');\r\n      \r\n      // Look for any card-like elements\r\n      const cards = page.locator('[class*=\"card\"], article, [class*=\"plan\"]');\r\n      const count = await cards.count();\r\n      console.log(`Γ£à Found ${count} card elements on plans page`);\r\n    });\r\n  });\r\n\r\n  // ========== PHASE 9: Static Pages ==========\r\n  test.describe('Phase 9: Static Pages', () => {\r\n    test('support page loads', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/support`);\r\n      await page.waitForLoadState('networkidle');\r\n      console.log(`Γ£à Support page: ${page.url()}`);\r\n    });\r\n\r\n    test('FAQ page loads', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/faq`);\r\n      await page.waitForLoadState('networkidle');\r\n      console.log(`Γ£à FAQ page: ${page.url()}`);\r\n    });\r\n\r\n    test('terms page loads', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/terms`);\r\n      await page.waitForLoadState('networkidle');\r\n      console.log(`Γ£à Terms page: ${page.url()}`);\r\n    });\r\n\r\n    test('privacy page loads', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/privacy`);\r\n      await page.waitForLoadState('networkidle');\r\n      console.log(`Γ£à Privacy page: ${page.url()}`);\r\n    });\r\n\r\n    test('about page loads', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/about`);\r\n      await page.waitForLoadState('networkidle');\r\n      console.log(`Γ£à About page: ${page.url()}`);\r\n    });\r\n  });\r\n\r\n  // ========== PHASE 10: Orders ==========\r\n  test.describe('Phase 10: Orders', () => {\r\n    test('orders page accessible', async ({ page }) => {\r\n      await page.goto(`${BASE_URL}/en/orders`);\r\n      await page.waitForLoadState('networkidle');\r\n      console.log(`Γ£à Orders page: ${page.url()}`);\r\n    });\r\n  });\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\modal-routing.spec.ts","messages":[{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":8,"column":19,"nodeType":"Identifier","messageId":"method","endLine":8,"endColumn":26,"fix":{"range":[248,248],"text":"All"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { test, expect, assertNoErrorBoundary, assertVisible } from \"./fixtures/base\"\n\nfunction pickSearchTerm(title: string | null | undefined): string {\n  if (!title) return \"test\"\n\n  const words = title\n    .split(/\\s+/)\n    .map((w) => w.replace(/[^a-z0-9_-]/gi, \"\"))\n    .filter((w) => w.length >= 3)\n\n  return words[0] ?? \"test\"\n}\n\nasync function pickAnyProductFromApi(request: import(\"@playwright/test\").APIRequestContext) {\n  const response = await request.get(\"/api/products/newest\")\n  expect(response.status()).toBe(200)\n\n  const data = await response.json()\n  const products: unknown[] = Array.isArray(data?.products) ? data.products : []\n\n  const first = products.find((p: any) => p?.storeSlug && (p?.slug || p?.id)) as any | undefined\n  test.skip(!first, \"No products returned from /api/products/newest\")\n\n  return first\n}\n\nasync function clickAnyProductCard(page: import(\"@playwright/test\").Page) {\n  const grid = page.locator(\"#product-grid:visible\").first()\n  await assertVisible(grid)\n\n  const productLink = grid.locator('a[data-slot=\"product-card-link\"], a[aria-label]').first()\n  const hasLink = await productLink.isVisible({ timeout: 10_000 }).catch(() => false)\n  test.skip(!hasLink, \"No product cards visible in #product-grid\")\n\n  await productLink.scrollIntoViewIfNeeded()\n\n  const urlBefore = page.url()\n  const scrollYBefore = await page.evaluate(() => window.scrollY)\n  await productLink.click()\n\n  return { urlBefore, scrollYBefore }\n}\n\ntest.describe(\"Product quick view overlay (no route change)\", () => {\n  test.describe.configure({ timeout: 60_000 })\n\n  test(\"search ΓåÆ opens dialog on desktop; close preserves scroll\", async ({ page, app, request }) => {\n    await page.setViewportSize({ width: 1280, height: 720 })\n\n    const first = await pickAnyProductFromApi(request)\n    const term = pickSearchTerm(first?.title)\n\n    await app.goto(`/en/search?q=${encodeURIComponent(term)}`)\n    await app.waitForHydration()\n\n    await assertNoErrorBoundary(page)\n\n    const { urlBefore, scrollYBefore } = await clickAnyProductCard(page)\n\n    await assertVisible(page.locator('[data-slot=\"dialog-content\"]').first())\n    expect(page.url()).toBe(urlBefore)\n\n    await page.keyboard.press(\"Escape\")\n    await expect(page.locator('[data-slot=\"dialog-content\"]').first()).toBeHidden({ timeout: 10_000 })\n\n    const scrollYAfter = await page.evaluate(() => window.scrollY)\n    expect(Math.abs(scrollYAfter - scrollYBefore)).toBeLessThan(200)\n\n    await assertNoErrorBoundary(page)\n    app.assertNoConsoleErrors()\n  })\n\n  test(\"search ΓåÆ opens drawer on mobile; close preserves scroll\", async ({ page, app, request }) => {\n    await page.setViewportSize({ width: 390, height: 844 })\n\n    const first = await pickAnyProductFromApi(request)\n    const term = pickSearchTerm(first?.title)\n\n    await app.goto(`/en/search?q=${encodeURIComponent(term)}`)\n    await app.waitForHydration()\n\n    await assertNoErrorBoundary(page)\n\n    const { urlBefore, scrollYBefore } = await clickAnyProductCard(page)\n\n    await assertVisible(page.locator('[data-slot=\"drawer-content\"]').first())\n    expect(page.url()).toBe(urlBefore)\n\n    await page.keyboard.press(\"Escape\")\n    await expect(page.locator('[data-slot=\"drawer-content\"]').first()).toBeHidden({ timeout: 10_000 })\n\n    const scrollYAfter = await page.evaluate(() => window.scrollY)\n    expect(Math.abs(scrollYAfter - scrollYBefore)).toBeLessThan(200)\n\n    await assertNoErrorBoundary(page)\n    app.assertNoConsoleErrors()\n  })\n\n  test(\"categories ΓåÆ opens dialog; URL stays on category\", async ({ page, app, request }) => {\n    await page.setViewportSize({ width: 1280, height: 720 })\n\n    const first = await pickAnyProductFromApi(request)\n\n    const categorySlug =\n      typeof first?.categorySlug === \"string\"\n        ? first.categorySlug\n        : typeof first?.categoryRootSlug === \"string\"\n          ? first.categoryRootSlug\n          : null\n\n    test.skip(!categorySlug, \"No category slug returned from /api/products/newest\")\n\n    await app.goto(`/en/categories/${categorySlug}`)\n    await app.waitForHydration()\n\n    await assertNoErrorBoundary(page)\n\n    const { urlBefore } = await clickAnyProductCard(page)\n\n    await assertVisible(page.locator('[data-slot=\"dialog-content\"]').first())\n    expect(page.url()).toBe(urlBefore)\n\n    await page.keyboard.press(\"Escape\")\n    await expect(page.locator('[data-slot=\"dialog-content\"]').first()).toBeHidden({ timeout: 10_000 })\n\n    await assertNoErrorBoundary(page)\n    app.assertNoConsoleErrors()\n  })\n})\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\onboarding.spec.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'clearAuthSession' is defined but never used.","line":6,"column":3,"nodeType":"Identifier","messageId":"unusedVar","endLine":6,"endColumn":19,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"clearAuthSession"},"fix":{"range":[55,76],"text":""},"desc":"Remove unused variable \"clearAuthSession\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'browserName' is defined but never used.","line":75,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":75,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'page' is defined but never used.","line":154,"column":101,"nodeType":"Identifier","messageId":"unusedVar","endLine":154,"endColumn":105},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'page' is defined but never used.","line":167,"column":102,"nodeType":"Identifier","messageId":"unusedVar","endLine":167,"endColumn":106},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'page' is defined but never used.","line":180,"column":94,"nodeType":"Identifier","messageId":"unusedVar","endLine":180,"endColumn":98},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'page' is defined but never used.","line":188,"column":96,"nodeType":"Identifier","messageId":"unusedVar","endLine":188,"endColumn":100}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  test,\r\n  expect,\r\n  type Page,\r\n  setupPage,\r\n  clearAuthSession,\r\n  gotoWithRetries,\r\n  waitForDevCompilingOverlayToHide,\r\n} from './fixtures/test'\r\n\r\n/**\r\n * Onboarding E2E Tests\r\n * \r\n * Tests for the post-signup onboarding flow:\r\n * - Profile setup (display name, avatar, bio)\r\n * - Social links (personal accounts)\r\n * - Business info (business accounts)\r\n * - Final step with CTAs (Start Shopping / Become a Seller)\r\n * \r\n * Run with: pnpm test:e2e e2e/onboarding.spec.ts\r\n */\r\n\r\n// ============================================================================\r\n// Test Configuration\r\n// ============================================================================\r\n\r\nconst ROUTES = {\r\n  home: '/en/',\r\n  homeWithOnboarding: '/en?onboarding=true',\r\n  sell: '/en/sell',\r\n  signUp: '/en/auth/sign-up',\r\n} as const\r\n\r\n// Selectors for onboarding modal\r\nconst SELECTORS = {\r\n  modal: '[role=\"dialog\"]',\r\n  profileTitle: 'text=/set up your profile/i',\r\n  displayNameInput: 'input#displayName',\r\n  bioTextarea: 'textarea#bio',\r\n  continueButton: 'button:has-text(\"Continue\")',\r\n  skipButton: 'button:has-text(\"Skip\")',\r\n  startShoppingButton: 'button:has-text(\"Start Shopping\")',\r\n  startSellingButton: 'button:has-text(\"Become a Seller\")',\r\n  progressIndicator: 'text=/step.*of/i',\r\n  avatarVariants: 'button[class*=\"rounded-lg\"][class*=\"border-2\"]',\r\n  socialTitle: 'text=/add your social links/i',\r\n  businessTitle: 'text=/business information/i',\r\n  completeTitle: 'text=/all set/i',\r\n  profilePreviewCard: '[class*=\"rounded-xl\"][class*=\"bg-secondary\"]',\r\n} as const\r\n\r\n// ============================================================================\r\n// Test Utilities\r\n// ============================================================================\r\n\r\n/**\r\n * Note: Testing the actual onboarding modal requires:\r\n * 1. A new user with onboarding_completed = false\r\n * 2. Verified email (to trigger ?onboarding=true param)\r\n * \r\n * For E2E testing, we test the modal components and flow by:\r\n * - Navigating to the home page with ?onboarding=true (for authenticated users)\r\n * - Testing modal interactions and navigation\r\n */\r\n\r\nasync function waitForModalVisible(page: Page) {\r\n  await page.waitForSelector(SELECTORS.modal, { state: 'visible', timeout: 15000 })\r\n}\r\n\r\n// ============================================================================\r\n// Onboarding Modal Structure Tests\r\n// ============================================================================\r\n\r\ntest.describe('Onboarding Modal UI Structure', () => {\r\n  test.skip(({ browserName }) => true, 'Requires authenticated user with onboarding flag - manual testing recommended')\r\n  \r\n  test('should display profile setup as first step @onboarding @ui', async ({ page }) => {\r\n    // This test requires an authenticated user with onboarding_completed=false\r\n    // For automated testing, we verify the modal structure by mocking the auth state\r\n    \r\n    await setupPage(page)\r\n    await gotoWithRetries(page, ROUTES.homeWithOnboarding)\r\n    \r\n    // If modal appears, verify first step is Profile Setup (not Intent)\r\n    try {\r\n      await waitForModalVisible(page)\r\n      await expect(page.locator(SELECTORS.profileTitle)).toBeVisible({ timeout: 5000 })\r\n    } catch {\r\n      // Modal may not appear without proper auth state - this is expected\r\n      test.skip(true, 'Onboarding modal requires authenticated user')\r\n    }\r\n  })\r\n\r\n  test('should show progress indicator @onboarding @ui', async ({ page }) => {\r\n    await setupPage(page)\r\n    await gotoWithRetries(page, ROUTES.homeWithOnboarding)\r\n    \r\n    try {\r\n      await waitForModalVisible(page)\r\n      await expect(page.locator(SELECTORS.progressIndicator)).toBeVisible({ timeout: 5000 })\r\n    } catch {\r\n      test.skip(true, 'Onboarding modal requires authenticated user')\r\n    }\r\n  })\r\n})\r\n\r\n// ============================================================================\r\n// Component Existence Tests (No Auth Required)\r\n// ============================================================================\r\n\r\ntest.describe('Onboarding Related Pages', () => {\r\n  test.beforeEach(async ({ page }) => {\r\n    await setupPage(page)\r\n  })\r\n\r\n  test('home page should load successfully @smoke', async ({ page }) => {\r\n    await gotoWithRetries(page, ROUTES.home, { timeout: 60000 })\r\n    await expect(page).toHaveURL(/\\/en\\/?/)\r\n  })\r\n\r\n  test('sell page should load successfully @smoke', async ({ page }) => {\r\n    await gotoWithRetries(page, ROUTES.sell, { timeout: 60000 })\r\n    // Sell page should either show auth prompt or sell interface\r\n    await expect(page).toHaveURL(/\\/en\\/sell/)\r\n  })\r\n\r\n  test('sign up page should have account type selector @onboarding @signup', async ({ page }) => {\r\n    await gotoWithRetries(page, ROUTES.signUp, { timeout: 60000 })\r\n    await waitForDevCompilingOverlayToHide(page)\r\n    \r\n    // The sign up page should have account type options\r\n    // This is where users first choose Personal vs Business\r\n    await expect(page.locator('form').first()).toBeVisible({ timeout: 30000 })\r\n    \r\n    // Look for account type selection (Personal/Business radio or toggle)\r\n    const personalOption = page.getByText(/personal/i).first()\r\n    const businessOption = page.getByText(/business/i).first()\r\n    \r\n    await expect(personalOption).toBeVisible({ timeout: 10000 })\r\n    await expect(businessOption).toBeVisible({ timeout: 10000 })\r\n  })\r\n})\r\n\r\n// ============================================================================\r\n// Onboarding Flow Tests (with mocked auth state)\r\n// ============================================================================\r\n\r\ntest.describe('Onboarding New User Flow', () => {\r\n  // These tests require setting up test users via Supabase test helpers\r\n  // For now, we document the expected behavior\r\n  \r\n  test.describe.configure({ mode: 'serial' })\r\n  \r\n  test('personal account flow: Profile ΓåÆ Social Links ΓåÆ Complete @onboarding @flow @skip', async ({ page }) => {\r\n    test.skip(true, 'Requires test user setup - manual verification needed')\r\n    \r\n    // Expected flow for personal account:\r\n    // 1. Modal opens showing \"Set up your profile\" (Step 1/3)\r\n    // 2. User fills display name, selects avatar, adds bio\r\n    // 3. Clicks Continue ΓåÆ \"Add your social links\" (Step 2/3)\r\n    // 4. User can skip or fill social links\r\n    // 5. Clicks Continue/Skip ΓåÆ \"You're all set!\" (Step 3/3)\r\n    // 6. Shows profile preview card with avatar and display name\r\n    // 7. Two CTAs: \"Start Shopping\" and \"Become a Seller\"\r\n  })\r\n\r\n  test('business account flow: Profile ΓåÆ Business Info ΓåÆ Complete @onboarding @flow @skip', async ({ page }) => {\r\n    test.skip(true, 'Requires test user setup - manual verification needed')\r\n    \r\n    // Expected flow for business account:\r\n    // 1. Modal opens showing \"Set up your profile\" (Step 1/3)\r\n    // 2. User fills display name, selects avatar, adds bio\r\n    // 3. Clicks Continue ΓåÆ \"Business information\" (Step 2/3)\r\n    // 4. User can skip or fill business name, website, location, cover image\r\n    // 5. Clicks Continue/Skip ΓåÆ \"You're all set!\" (Step 3/3)\r\n    // 6. Shows profile preview card\r\n    // 7. Two CTAs: \"Start Shopping\" and \"Become a Seller\"\r\n  })\r\n\r\n  test('clicking \"Start Shopping\" redirects to home @onboarding @navigation @skip', async ({ page }) => {\r\n    test.skip(true, 'Requires test user setup - manual verification needed')\r\n    \r\n    // After completing onboarding:\r\n    // 1. Click \"Start Shopping\" button\r\n    // 2. Should close modal and navigate to home page\r\n  })\r\n\r\n  test('clicking \"Become a Seller\" redirects to /sell @onboarding @navigation @skip', async ({ page }) => {\r\n    test.skip(true, 'Requires test user setup - manual verification needed')\r\n    \r\n    // After completing onboarding:\r\n    // 1. Click \"Become a Seller\" button\r\n    // 2. Should close modal and navigate to /sell page\r\n    // 3. /sell page handles Stripe Connect onboarding separately\r\n  })\r\n})\r\n\r\n// ============================================================================\r\n// Acceptance Criteria Tests\r\n// ============================================================================\r\n\r\ntest.describe('Onboarding Acceptance Criteria @acceptance', () => {\r\n  /**\r\n   * These tests document the acceptance criteria from the production plan.\r\n   * Mark as passed/failed based on manual testing or future automation.\r\n   */\r\n\r\n  test('MUST: After email verification, user sees profile setup modal (not intent) @skip', async () => {\r\n    test.skip(true, 'Manual verification: Intent step removed, Profile is first step')\r\n    // Verified in code: step defaults to \"profile\" not \"intent\"\r\n  })\r\n\r\n  test('MUST: User can set display name with default from full_name @skip', async () => {\r\n    test.skip(true, 'Manual verification: initialDisplayName prop passed to modal')\r\n    // Verified in code: displayName state initialized with initialDisplayName\r\n  })\r\n\r\n  test('MUST: User can select avatar style (4 variants) or upload custom @skip', async () => {\r\n    test.skip(true, 'Manual verification: Avatar variants + upload button present')\r\n    // Verified in code: AVATAR_VARIANTS.slice(0, 4) shown, file input available\r\n  })\r\n\r\n  test('MUST: User can add optional bio (max 160 chars with counter) @skip', async () => {\r\n    test.skip(true, 'Manual verification: Bio textarea with maxLength=160 and counter')\r\n    // Verified in code: textarea maxLength={160}, character count displayed\r\n  })\r\n\r\n  test('MUST: Personal users see social links step (optional) @skip', async () => {\r\n    test.skip(true, 'Manual verification: Personal ΓåÆ Social step with Skip button')\r\n    // Verified in code: handleProfileNext routes personal to \"social\" step\r\n  })\r\n\r\n  test('MUST: Business users see business info step (optional) @skip', async () => {\r\n    test.skip(true, 'Manual verification: Business ΓåÆ Business step with Skip button')\r\n    // Verified in code: handleProfileNext routes business to \"business\" step\r\n  })\r\n\r\n  test('MUST: Final step shows \"Start Shopping\" AND \"Become a Seller\" buttons @skip', async () => {\r\n    test.skip(true, 'Manual verification: Complete step has two CTAs')\r\n    // Verified in code: Two Button components in complete step\r\n  })\r\n\r\n  test('MUST: Profile is saved correctly to database @skip', async () => {\r\n    test.skip(true, 'Manual verification: Server action updates profile fields')\r\n    // Verified in code: completePostSignupOnboarding updates display_name, bio, avatar_url, etc.\r\n  })\r\n\r\n  test('MUST: onboarding_completed set to true after completion @skip', async () => {\r\n    test.skip(true, 'Manual verification: onboarding_completed = true in update')\r\n    // Verified in code: updateData includes onboarding_completed: true\r\n  })\r\n\r\n  test('SHOULD: Progress indicator shows step X of Y @skip', async () => {\r\n    test.skip(true, 'Manual verification: Progress indicator visible')\r\n    // Verified in code: getCurrentStepNumber() and getTotalSteps() used\r\n  })\r\n\r\n  test('SHOULD: Avatar preview shown before save @skip', async () => {\r\n    test.skip(true, 'Manual verification: Avatar component displays selected style')\r\n    // Verified in code: Avatar component renders with selected variant\r\n  })\r\n\r\n  test('SHOULD: Bio character counter visible @skip', async () => {\r\n    test.skip(true, 'Manual verification: {bio.length}/160 shown')\r\n    // Verified in code: Character count displayed below textarea\r\n  })\r\n})\r\n\r\n// ============================================================================\r\n// Regression Tests - No Intent Step\r\n// ============================================================================\r\n\r\ntest.describe('Regression: Intent Step Removed', () => {\r\n  test('Intent step code should not exist in modal @regression @code', async () => {\r\n    // This is a code-level test - verify in source that:\r\n    // - OnboardingStep type no longer includes \"intent\"\r\n    // - No JSX renders step === \"intent\"\r\n    // - No handleIntentSelect function exists\r\n    // \r\n    // This is verified by the TypeScript compilation passing\r\n    // and the modal code review above.\r\n    expect(true).toBe(true)\r\n  })\r\n\r\n  test('OnboardingData type should not include intent field @regression @code', async () => {\r\n    // Verified: OnboardingData interface no longer has intent field\r\n    // Server action no longer expects or uses intent\r\n    expect(true).toBe(true)\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\orders.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\profile.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\reviews.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\seller-create-listing.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\seller-routes.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\e2e\\smoke.spec.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'app' is defined but never used.","line":607,"column":79,"nodeType":"Identifier","messageId":"unusedVar","endLine":607,"endColumn":82}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\r\n  test,\r\n  expect,\r\n  assertNoErrorBoundary,\r\n  assertVisible,\r\n  assertNavigatedTo,\r\n} from './fixtures/base'\r\nimport { getTestUserCredentials, loginWithPassword } from './fixtures/auth'\r\nimport type { Page } from './fixtures/base'\r\n\r\nasync function ensureUserCanSell(page: Page, locale: 'en' | 'bg' = 'en') {\r\n  // If the Sell page redirects to the legacy \"Set Up Your Username\" gate, follow\r\n  // the prompt and set a username via the profile editor, then return to /sell.\r\n  const usernameGateHeading = page.getByRole('heading', { name: /set up your username/i }).first()\r\n  const isOnUsernameGate = await usernameGateHeading.isVisible({ timeout: 2_000 }).catch(() => false)\r\n\r\n  if (!isOnUsernameGate) return\r\n\r\n  await page.getByRole('link', { name: /go to settings/i }).click()\r\n  await expect(page).toHaveURL(new RegExp(`/${locale}/account/profile`))\r\n\r\n  // Profile page defaults to the \"Account\" tab; username lives under \"Public Profile\".\r\n  await page.getByRole('tab', { name: /public profile/i }).first().click()\r\n\r\n  // Open the username dialog (\"Set\" when username is missing).\r\n  await page.getByRole('button', { name: /^set$/i }).click({ timeout: 30_000 })\r\n\r\n  const usernameInput = page.getByPlaceholder('your_username')\r\n  await expect(usernameInput).toBeVisible({ timeout: 30_000 })\r\n\r\n  const desired = `e2e_${Date.now()}`\r\n  await usernameInput.fill(desired)\r\n\r\n  // Wait for the availability check to pass (link preview appears).\r\n  await expect(page.getByText(new RegExp(`treido\\\\.eu/u/${desired}`))).toBeVisible({ timeout: 30_000 })\r\n\r\n  const saveButton = page.getByRole('button', { name: /^save$/i })\r\n  await expect(saveButton).toBeEnabled({ timeout: 30_000 })\r\n  await saveButton.click()\r\n\r\n  // Page refreshes on success.\r\n  await page.waitForLoadState('domcontentloaded')\r\n}\r\n\r\n/**\r\n * SMOKE TESTS - Critical Path Only\r\n *\r\n * These tests verify the MINIMUM functionality required for production.\r\n * If ANY of these fail, the app is BROKEN.\r\n *\r\n * Rules:\r\n * 1. Each test must complete in < 30 seconds\r\n * 2. No soft assertions - everything is strict\r\n * 3. Console errors = test failure\r\n * 4. Every test must have clear FAIL conditions\r\n *\r\n * Run: pnpm test:e2e:smoke\r\n */\r\n\r\ntest.describe('Smoke Tests - Critical Path', () => {\r\n  test.describe.configure({ timeout: 30_000 })\r\n\r\n  // ==========================================================================\r\n  // Homepage\r\n  // ==========================================================================\r\n\r\n  test('homepage loads without errors @smoke @critical', async ({ page, app }) => {\r\n    await app.goto('/en')\r\n    await app.waitForHydration()\r\n\r\n    // MUST have: header, main content, no error boundary\r\n    await assertVisible(page.locator('header').first())\r\n    await assertVisible(page.locator('main, #main-content').first())\r\n    await assertNoErrorBoundary(page)\r\n\r\n    // Check for console errors\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  test('homepage loads in Bulgarian locale @smoke', async ({ page, app }) => {\n    await app.goto('/bg')\n    await app.waitForHydration()\n\r\n    await assertVisible(page.locator('header').first())\r\n    await assertVisible(page.locator('main, #main-content').first())\r\n    await assertNoErrorBoundary(page)\r\n\n    app.assertNoConsoleErrors()\n  })\n\n  test('homepage mobile landing hierarchy and geometry stay consistent @smoke @home', async ({ page, app }) => {\n    await page.setViewportSize({ width: 390, height: 844 })\n    await app.goto('/en')\n    await app.waitForHydration()\n\n    const categoriesRow = page.getByTestId('home-category-circles')\n    const promotedSection = page.getByTestId('home-section-promoted')\n    const newestSection = page.getByTestId('home-section-newest')\n    const curatedRail = page.getByTestId('home-section-curated-rail')\n\n    await assertVisible(categoriesRow)\n    await assertVisible(newestSection)\n    await expect(page.getByTestId('home-section-featured-hero')).toHaveCount(0)\n\n    const hasPromoted = await promotedSection.isVisible({ timeout: 2_000 }).catch(() => false)\n    test.skip(!hasPromoted, 'No promoted listings rendered on homepage')\n\n    await assertVisible(promotedSection)\n\n    const categoryBox = await categoriesRow.boundingBox()\n    const promotedBox = await promotedSection.boundingBox()\n    const newestBox = await newestSection.boundingBox()\n\n    expect(categoryBox).toBeTruthy()\n    expect(promotedBox).toBeTruthy()\n    expect(newestBox).toBeTruthy()\n\n    expect(promotedBox!.y).toBeGreaterThan(categoryBox!.y)\n    expect(newestBox!.y).toBeGreaterThan(promotedBox!.y)\n\n    const promotedCard = promotedSection.locator('[data-slot=\"surface\"]').first()\n    const newestCard = newestSection.locator('[data-slot=\"surface\"]').first()\n\n    await assertVisible(promotedCard)\n    await assertVisible(newestCard)\n\n    const promotedCardBox = await promotedCard.boundingBox()\n    const newestCardBox = await newestCard.boundingBox()\n\n    expect(promotedCardBox).toBeTruthy()\n    expect(newestCardBox).toBeTruthy()\n    const promotedCardWidth = promotedCardBox?.width ?? 0\n    const newestCardWidth = newestCardBox?.width ?? 0\n    expect(promotedCardWidth).toBeGreaterThan(newestCardWidth * 1.08)\n\n    const newestImage = newestCard.locator('[data-slot=\"aspect-ratio\"]').first()\n    await assertVisible(newestImage)\n    const newestImageBox = await newestImage.boundingBox()\n    expect(newestImageBox).toBeTruthy()\n    expect(newestImageBox!.width).toBeGreaterThan(newestImageBox!.height)\n\n    const discountBadgesInNewest = newestSection\n      .locator('[data-slot=\"badge\"]')\n      .filter({ hasText: /^-\\d+%$/ })\n    await expect(discountBadgesInNewest).toHaveCount(0)\n\n    const promotedStrip = promotedSection.getByTestId('home-section-promoted-strip')\n    await assertVisible(promotedStrip)\n\n    const stripIsHorizontallyScrollable = await promotedStrip.evaluate((element) => {\n      return element.scrollWidth > element.clientWidth + 8\n    })\n    expect(stripIsHorizontallyScrollable).toBe(true)\n\n    const categoryButtons = categoriesRow.getByRole('button')\n    const buttonCount = await categoryButtons.count()\n    expect(buttonCount).toBeGreaterThan(0)\n\n    const sampleCount = Math.min(5, buttonCount)\n    for (let index = 0; index < sampleCount; index += 1) {\n      const buttonBox = await categoryButtons.nth(index).boundingBox()\n      expect(buttonBox).toBeTruthy()\n      expect(buttonBox!.height).toBeGreaterThanOrEqual(44)\n      expect(buttonBox!.width).toBeGreaterThanOrEqual(44)\n    }\n\n    const hasCuratedRail = await curatedRail.isVisible({ timeout: 2_000 }).catch(() => false)\n    if (hasCuratedRail) {\n      await assertVisible(curatedRail)\n      const curatedBox = await curatedRail.boundingBox()\n      expect(curatedBox).toBeTruthy()\n      expect(curatedBox!.y).toBeGreaterThan(newestBox!.y)\n    }\n\n    await assertNoErrorBoundary(page)\n    app.assertNoConsoleErrors()\n  })\n\r\n  // ==========================================================================\r\n  // Navigation\r\n  // ==========================================================================\r\n\r\n  test('categories page loads @smoke @critical', async ({ page, app }) => {\r\n    await app.goto('/en/categories')\r\n    await app.waitForHydration()\r\n\r\n    // Must have a heading\r\n    await assertVisible(page.getByRole('heading', { level: 1 }))\r\n    await assertNoErrorBoundary(page)\r\n\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  test('search page loads with query @smoke @critical', async ({ page, app }) => {\n    await app.goto('/en/search?q=test')\n    await app.waitForHydration()\n\r\n    // Must have main content (product grid or empty state)\r\n    await assertVisible(page.locator('main, #main-content').first())\r\n    await assertNoErrorBoundary(page)\r\n\r\n    // URL must contain query param\r\n    expect(page.url()).toContain('q=test')\r\n\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  test('search page loads with sort param @smoke', async ({ page, app }) => {\r\n    await app.goto('/en/search?q=test&sort=price-asc')\r\n    await app.waitForHydration()\r\n\r\n    await assertVisible(page.locator('main, #main-content').first())\r\n    await assertNoErrorBoundary(page)\r\n\r\n    expect(page.url()).toContain('q=test')\r\n    expect(page.url()).toContain('sort=price-asc')\r\n\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  test('search pagination preserves locale @smoke @critical', async ({ page, app }) => {\r\n    await app.goto('/bg/search')\r\n    await app.waitForHydration()\r\n\r\n    const pagination = page\r\n      .locator('nav[data-slot=\"pagination\"]:visible')\r\n      .filter({ has: page.locator('a[data-slot=\"pagination-link\"][href*=\"page=2\"]') })\r\n      .first()\r\n    await expect(pagination).toBeVisible()\r\n\r\n    const page2Link = pagination.locator('a[data-slot=\"pagination-link\"][href*=\"page=2\"]').first()\r\n    await expect(page2Link).toBeVisible()\r\n\r\n    const href = await page2Link.getAttribute('href')\r\n    expect(href).toBeTruthy()\r\n    expect(href!).toMatch(/^\\/bg\\/search/)\r\n\r\n    await page2Link.click()\r\n    await expect(page).toHaveURL(/\\/bg\\/search.*page=2/)\r\n    await assertNoErrorBoundary(page)\r\n\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  test('mobile tab bar Profile opens auth drawer for guests @smoke @critical', async ({ page, app }) => {\n    await page.setViewportSize({ width: 390, height: 844 })\n\n    await app.clearAuthSession()\n    await app.goto('/bg/search?q=iphone')\n    await app.waitForHydration()\n\n    await assertVisible(page.getByTestId('mobile-tab-bar'))\n    await assertVisible(page.getByTestId('mobile-tab-bar-dock'))\n    await assertVisible(page.getByTestId('mobile-tab-sell'))\n\n    await page.getByTestId('mobile-tab-profile').click()\n\n    const authDrawer = page.getByTestId('mobile-auth-drawer')\n    await assertVisible(authDrawer)\n    await expect(page).toHaveURL(/\\/bg\\/search\\?q=iphone/)\n    await assertVisible(authDrawer.locator('input[type=\"email\"], input#email'))\n    await assertVisible(authDrawer.locator('input[type=\"password\"], input#password'))\n    await assertNoErrorBoundary(page)\n\n    app.assertNoConsoleErrors()\n  })\n\n  test('mobile search cards use clean landscape layout @smoke @search', async ({ page, app }) => {\n    await page.setViewportSize({ width: 390, height: 844 })\n    await app.goto('/en/search?q=test')\n    await app.waitForHydration()\n\n    const firstCardLink = page.locator('a[data-slot=\"product-card-link\"]').first()\n    const hasCard = await firstCardLink.isVisible({ timeout: 2_000 }).catch(() => false)\n    test.skip(!hasCard, 'No product cards rendered on mobile search')\n\n    const firstCardSurface = firstCardLink.locator('xpath=ancestor::*[@data-slot=\"surface\"][1]')\n    const firstCardImage = firstCardSurface.locator('[data-slot=\"aspect-ratio\"]').first()\n    await assertVisible(firstCardImage)\n    const firstCardImageRect = await firstCardImage.evaluate((element) => {\n      const rect = element.getBoundingClientRect()\n      return { width: rect.width, height: rect.height }\n    })\n    expect(firstCardImageRect.width).toBeGreaterThan(firstCardImageRect.height)\n\n    const discountBadges = firstCardSurface.locator('[data-slot=\"badge\"]').filter({ hasText: /^-\\d+%$/ })\n    await expect(discountBadges).toHaveCount(0)\n\n    await assertNoErrorBoundary(page)\n  })\n\n  test('mobile category feed cards use clean landscape layout @smoke @category', async ({ page, app }) => {\n    await page.setViewportSize({ width: 390, height: 844 })\n    await app.goto('/en/categories/fashion')\n    await app.waitForHydration()\n\n    const firstCardLink = page.locator('a[data-slot=\"product-card-link\"]').first()\n    const hasCard = await firstCardLink.isVisible({ timeout: 2_000 }).catch(() => false)\n    test.skip(!hasCard, 'No product cards rendered in mobile category feed')\n\n    const firstCardSurface = firstCardLink.locator('xpath=ancestor::*[@data-slot=\"surface\"][1]')\n    const firstCardImage = firstCardSurface.locator('[data-slot=\"aspect-ratio\"]').first()\n    await assertVisible(firstCardImage)\n    const firstCardImageRect = await firstCardImage.evaluate((element) => {\n      const rect = element.getBoundingClientRect()\n      return { width: rect.width, height: rect.height }\n    })\n    expect(firstCardImageRect.width).toBeGreaterThan(firstCardImageRect.height)\n\n    const discountBadges = firstCardSurface.locator('[data-slot=\"badge\"]').filter({ hasText: /^-\\d+%$/ })\n    await expect(discountBadges).toHaveCount(0)\n\n    await assertNoErrorBoundary(page)\n  })\n\n  test('mobile tab bar Profile opens account drawer when authenticated @smoke', async ({ page, app }) => {\n    const creds = getTestUserCredentials()\n    test.skip(!creds, 'Set TEST_USER_EMAIL/TEST_USER_PASSWORD to run authenticated profile drawer smoke test')\n\n    await page.setViewportSize({ width: 390, height: 844 })\n    await app.clearAuthSession()\n    await loginWithPassword(page, creds!)\n    await app.goto('/en/search?q=iphone')\n    await app.waitForHydration()\n\n    await assertVisible(page.getByTestId('mobile-tab-bar'))\n    await assertVisible(page.getByTestId('mobile-tab-bar-dock'))\n    await page.getByTestId('mobile-tab-profile').click()\n\n    const accountDrawer = page.getByTestId('mobile-account-drawer')\n    await assertVisible(accountDrawer)\n    await assertVisible(accountDrawer.getByTestId('account-drawer-quick-link').first())\n\n    const firstQuickLinkBox = await accountDrawer.getByTestId('account-drawer-quick-link').first().boundingBox()\n    expect(firstQuickLinkBox).toBeTruthy()\n    expect(firstQuickLinkBox!.height).toBeGreaterThanOrEqual(44)\n\n    await assertNoErrorBoundary(page)\n    app.assertNoConsoleErrors()\n  })\n\n  test('mobile categories tab opens unified category drawer @smoke @critical', async ({ page, app }) => {\n    await page.setViewportSize({ width: 390, height: 844 })\n\n    await app.goto('/en/search?q=iphone')\n    await app.waitForHydration()\n\n    const tabBar = page.getByTestId('mobile-tab-bar')\n    await assertVisible(tabBar)\n\n    await tabBar.getByRole('button', { name: /categories/i }).click()\n\n    const categoryDrawer = page.getByTestId('mobile-category-drawer')\n    await assertVisible(categoryDrawer)\n    await assertVisible(categoryDrawer.getByRole('textbox', { name: /search categories/i }))\n    await assertNoErrorBoundary(page)\n\n    app.assertNoConsoleErrors()\n  })\n\r\n  test('product page loads without errors @smoke @critical', async ({ page, app, request }) => {\r\n    const response = await request.get('/api/products/newest')\r\n    expect(response.status()).toBe(200)\r\n\r\n    const data = await response.json()\r\n    const products: unknown[] = Array.isArray(data?.products) ? data.products : []\r\n\r\n    const first = products.find((p: any) => p?.storeSlug && (p?.slug || p?.id)) as any | undefined\r\n    test.skip(!first, 'No products returned from /api/products/newest')\r\n\r\n    const seller = String(first.storeSlug)\r\n    const productSlug = String(first.slug || first.id)\r\n\r\n    await app.goto(`/en/${seller}/${productSlug}`)\r\n    await app.waitForHydration()\r\n\r\n    await assertVisible(page.locator('main, #main-content').first())\r\n    await assertNoErrorBoundary(page)\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  test('cart page loads @smoke', async ({ page, app }) => {\r\n    await app.goto('/en/cart')\r\n    await app.waitForHydration()\r\n\r\n    await assertVisible(page.locator('main, #main-content').first())\r\n    await assertNoErrorBoundary(page)\r\n\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  // ==========================================================================\r\n  // Auth Pages (Public Access)\r\n  // ==========================================================================\r\n\r\n  test('login page loads @smoke @critical', async ({ page, app }) => {\r\n    await app.goto('/en/auth/login')\r\n    await app.waitForHydration()\r\n\r\n    // Must have form with required fields\r\n    await expect(page.locator('form')).toHaveCount(1)\r\n    await assertVisible(page.locator('input[type=\"email\"], input#email'))\r\n    await assertVisible(page.locator('input[type=\"password\"], input#password'))\r\n    await assertVisible(page.getByRole('button', { name: /sign in|log in/i }))\r\n\r\n    await assertNoErrorBoundary(page)\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  test('sign-up page loads @smoke @critical', async ({ page, app }) => {\r\n    await app.goto('/en/auth/sign-up')\r\n    await app.waitForHydration()\r\n\r\n    // Must have form\r\n    await expect(page.locator('form')).toHaveCount(1)\r\n    await assertNoErrorBoundary(page)\r\n\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  test('forgot-password page loads @smoke', async ({ page, app }) => {\r\n    await app.goto('/en/auth/forgot-password')\r\n    await app.waitForHydration()\r\n\r\n    // Must have email input + submit button\r\n    await assertVisible(page.getByRole('textbox', { name: /email/i }))\r\n    await assertVisible(page.getByRole('button', { name: /send reset link/i }))\r\n    await assertNoErrorBoundary(page)\r\n\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  // ==========================================================================\r\n  // Protected Routes (Should Redirect to Login)\r\n  // ==========================================================================\r\n\r\n  test('account page redirects to login when unauthenticated @smoke @auth', async ({ page, app }) => {\r\n    await app.clearAuthSession()\r\n    await app.goto('/en/account')\r\n\r\n    // MUST redirect to login\r\n    await assertNavigatedTo(page, /\\/auth\\/login/)\r\n  })\r\n\r\n  test('sell page shows sign-in prompt when unauthenticated @smoke @auth', async ({ page, app }) => {\r\n    await app.clearAuthSession()\r\n    await app.goto('/en/sell')\r\n\r\n    // MUST show a non-blocking sign-in prompt (no redirect)\r\n    await expect(page).toHaveURL(/\\/en\\/sell/)\r\n    await assertVisible(page.getByRole('link', { name: /sign in/i }).first())\r\n  })\r\n\r\n  test('seller flow: sell ΓåÆ payout gating ΓåÆ listing creation @smoke @sell', async ({ page, app }) => {\r\n    const creds = getTestUserCredentials()\r\n    test.skip(!creds, 'Set TEST_USER_EMAIL/TEST_USER_PASSWORD to run authenticated seller smoke flow')\r\n\r\n    test.setTimeout(180_000)\r\n\r\n    // Force mobile layout so the publish button is available in the stepper UI.\r\n    await page.setViewportSize({ width: 390, height: 844 })\r\n\r\n    await app.clearAuthSession()\r\n    await loginWithPassword(page, creds!)\r\n\r\n    await app.goto('/en/sell', { timeout: 60_000, retries: 3 })\r\n\r\n    // Wait for the sell header to be mounted (sell flow doesn't always include <main>).\r\n    await assertVisible(page.locator('nav').first())\r\n\r\n    await ensureUserCanSell(page, 'en')\r\n\r\n    // After ensuring username is set, return to the sell page.\r\n    await app.goto('/en/sell', { timeout: 60_000, retries: 3 })\r\n    await assertVisible(page.locator('nav').first())\r\n\r\n    // If the user is not onboarded as a seller yet, complete the minimal wizard.\r\n    const onboardingHeading = page.getByRole('heading', { name: /customize your profile/i }).first()\r\n    const needsOnboarding = await onboardingHeading.isVisible({ timeout: 2_000 }).catch(() => false)\r\n\r\n    if (needsOnboarding) {\r\n      const displayNameInput = page.getByPlaceholder(/how should buyers call you\\?/i).first()\r\n      if (await displayNameInput.isVisible({ timeout: 2_000 }).catch(() => false)) {\r\n        await displayNameInput.fill('E2E Seller')\r\n      }\r\n\r\n      await page.getByRole('button', { name: /continue/i }).click({ timeout: 30_000 })\r\n\r\n      // Success step offers \"Start Selling\".\r\n      const startSelling = page.getByRole('button', { name: /start selling/i }).first()\r\n      if (await startSelling.isVisible({ timeout: 10_000 }).catch(() => false)) {\r\n        await startSelling.click({ timeout: 30_000 })\r\n        await assertVisible(page.locator('nav').first())\r\n      }\r\n    }\r\n\r\n    // Payout gating: if payouts aren't set up yet, ensure the CTA navigates correctly.\r\n    const payoutGateTitle = page.getByRole('heading', { name: /set up payouts first/i }).first()\r\n    const isPayoutGated = await payoutGateTitle.isVisible({ timeout: 2_000 }).catch(() => false)\r\n\r\n    if (isPayoutGated) {\r\n      await page.getByRole('link', { name: /set up payouts/i }).click({ timeout: 30_000 })\r\n      await assertNavigatedTo(page, /\\/en\\/seller\\/settings\\/payouts/)\r\n      await assertVisible(page.getByRole('heading', { level: 1 }).first())\r\n      app.assertNoConsoleErrors()\r\n      return\r\n    }\r\n\r\n    const uniqueTitle = `E2E Listing ${Date.now()}`\r\n\r\n    // Step 1: Basics\r\n    await page.locator('#sell-form-title').fill(uniqueTitle)\r\n\r\n    // Category: open drawer and pick the first search result.\r\n    await page.getByRole('button', { name: /category:|╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å:/i }).first().click()\r\n\r\n    const categorySearch = page.getByPlaceholder(/search category|╤é╤è╤Ç╤ü╨╕ ╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╤Å/i)\r\n    await categorySearch.fill('a')\r\n\r\n    const firstCategoryResult = page.locator('button', { hasText: 'ΓÇ║' }).first()\r\n    await expect(firstCategoryResult).toBeVisible({ timeout: 30_000 })\r\n    await firstCategoryResult.click()\r\n\r\n    await page.getByRole('button', { name: /continue|╨┐╤Ç╨╛╨┤╤è╨╗╨╢╨╕/i }).click()\r\n\r\n    // Step 2: Photos\r\n    const fileInput = page.locator('input[type=\\\"file\\\"]').first()\r\n    await fileInput.setInputFiles('e2e/assets/1x1.png')\r\n\r\n    await expect(page.locator('img[alt=\\\"Product image 1\\\"]:visible').first()).toBeVisible({ timeout: 60_000 })\r\n\r\n    await page.getByRole('button', { name: /continue|╨┐╤Ç╨╛╨┤╤è╨╗╨╢╨╕/i }).click()\r\n\r\n    // Step 3: Pricing & shipping\r\n    await page.locator('#sell-form-price').fill('12.34')\r\n\r\n    await page.getByRole('button', { name: /continue|╨┐╤Ç╨╛╨┤╤è╨╗╨╢╨╕/i }).click()\r\n\r\n    // Step 4: Review & publish\r\n    const description =\r\n      'This is an end to end test listing created by Playwright to validate the seller flow. ' +\r\n      'It contains enough words to satisfy the minimum description requirement for publishing today.'\r\n\r\n    await page.locator('#sell-form-description').fill(description)\r\n\r\n    await page.getByRole('button', { name: /publish listing|╨┐╤â╨▒╨╗╨╕╨║╤â╨▓╨░╨╣/i }).click()\r\n\r\n    await expect(page.getByText(/published!/i)).toBeVisible({ timeout: 90_000 })\r\n\r\n    await page.getByRole('link', { name: /view listing|╨▓╨╕╨╢ ╨╛╨▒╤Å╨▓╨░╤é╨░/i }).click()\r\n\r\n    await expect(page.getByText(uniqueTitle).first()).toBeVisible({ timeout: 60_000 })\r\n    await expect(page.getByText(/something went wrong/i)).not.toBeVisible()\r\n\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  // ==========================================================================\r\n  // Search Functionality\r\n  // ==========================================================================\r\n\r\n  test('header search navigates with query param @smoke @search', async ({ page, app }) => {\r\n    await app.goto('/en')\r\n    await app.waitForHydration()\r\n\r\n    // Treido uses a header search trigger that opens a full-screen overlay.\r\n    const searchTrigger = page.getByRole('button', { name: /search/i }).first()\r\n    await assertVisible(searchTrigger)\r\n    await searchTrigger.click()\r\n\r\n    const searchInput = page.getByRole('searchbox').first()\r\n    await assertVisible(searchInput)\r\n    await searchInput.fill('phone')\r\n    await searchInput.press('Enter')\r\n\r\n    // MUST navigate to search with query\r\n    await assertNavigatedTo(page, /\\/en\\/search/, 30_000)\r\n\r\n    // URL must have the query param\r\n    await page.waitForFunction(() => {\r\n      return new URL(window.location.href).searchParams.get('q') === 'phone'\r\n    }, undefined, { timeout: 30_000 })\r\n\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  // ==========================================================================\r\n  // API Health\r\n  // ==========================================================================\r\n\r\n  test('API products endpoint returns data @smoke @api', async ({ request }) => {\r\n    const response = await request.get('/api/products/newest')\r\n\r\n    // MUST return 200\r\n    expect(response.status()).toBe(200)\r\n\r\n    const data = await response.json()\r\n\r\n    // MUST include products array\r\n    expect(Array.isArray(data?.products)).toBe(true)\r\n  })\r\n\r\n  // ==========================================================================\r\n  // Error Handling\r\n  // ==========================================================================\r\n\r\n  test('404 page shows error state for unknown routes @smoke', async ({ page, app }) => {\r\n    // Use 3 segments to avoid matching dynamic seller/product routes.\r\n    const unknownMarker = 'this-route-does-not-exist'\r\n\r\n    await page.goto('/en/this-route-does-not-exist-12345/also-does-not-exist/extra', {\r\n      waitUntil: 'domcontentloaded',\r\n    })\r\n\r\n    // Should show 404 OR redirect quickly to a valid page - not crash.\r\n    // Allow a brief window for Next.js dev-mode route resolution.\r\n    const notFoundText = page.locator('text=/not found|404/i').first()\r\n\r\n    await Promise.race([\r\n      notFoundText.waitFor({ state: 'visible', timeout: 5_000 }).catch(() => {}),\r\n      page.waitForURL((url) => !url.toString().includes(unknownMarker), { timeout: 5_000 }).catch(() => {}),\r\n    ])\r\n\r\n    const is404 = await notFoundText.isVisible().catch(() => false)\r\n    const isRedirected = !page.url().includes(unknownMarker)\r\n\r\n    // MUST either show 404 or redirect - not crash\r\n    expect(is404 || isRedirected).toBe(true)\r\n    await assertNoErrorBoundary(page)\r\n  })\r\n})\r\n\r\ntest.describe('Smoke Tests - Critical User Actions', () => {\r\n  test.describe.configure({ timeout: 30_000 })\r\n\r\n  test('can navigate from homepage to category @smoke @navigation', async ({ page, app }) => {\r\n    await app.goto('/en')\r\n    await app.waitForHydration()\r\n\r\n    // Click on categories link (in nav or body)\r\n    const categoriesLink = page.getByRole('link', { name: /categories|╨║╨░╤é╨╡╨│╨╛╤Ç╨╕╨╕/i }).first()\r\n\r\n    // If not visible in main nav, try the tab bar or other locations\r\n    const linkVisible = await categoriesLink.isVisible().catch(() => false)\r\n\r\n    if (linkVisible) {\r\n      try {\r\n        await categoriesLink.click({ timeout: 5_000 })\r\n        await assertNavigatedTo(page, /\\/categories/)\r\n      } catch {\r\n        // Some homepage sections use full-card overlay links which can intercept clicks.\r\n        // Fallback to direct navigation to keep this smoke test stable.\r\n        await app.goto('/en/categories')\r\n      }\r\n    } else {\r\n      // Fallback: navigate directly and verify it works\r\n      await app.goto('/en/categories')\r\n    }\r\n\r\n    await assertNoErrorBoundary(page)\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  test('cart items persist to checkout @smoke @critical', async ({ page, app }) => {\r\n    test.setTimeout(60_000)\r\n    await app.clearAuthSession()\r\n\r\n    const seededCart = [\r\n      {\r\n        id: 'e2e-cart-item',\r\n        title: 'E2E Cart Item',\r\n        price: 12.34,\r\n        image: '/placeholder.svg',\r\n        quantity: 1,\r\n        slug: 'e2e-cart-item',\r\n        username: 'e2e_seller',\r\n        storeSlug: 'e2e_seller',\r\n      },\r\n    ]\r\n\r\n    await page.addInitScript((items) => {\r\n      try {\r\n        localStorage.setItem('cart', JSON.stringify(items))\r\n      } catch {\r\n        // Ignore storage errors\r\n      }\r\n    }, seededCart)\r\n\r\n    await app.goto('/en/cart')\r\n    await app.waitForHydration()\r\n\r\n    await assertVisible(page.getByText('E2E Cart Item').first())\r\n\r\n    const proceedToCheckout = page.getByRole('button', { name: /checkout/i }).first()\r\n    await assertVisible(proceedToCheckout)\r\n    await proceedToCheckout.click()\r\n\r\n    await assertNavigatedTo(page, /\\/en\\/checkout/)\r\n    await app.waitForHydration()\r\n\r\n    // Assert the seeded item is present on the checkout page (order items section).\r\n    // Use the image alt since the title can be rendered in multiple places (some hidden).\r\n    await assertVisible(page.getByRole('img', { name: 'E2E Cart Item' }).first())\r\n    await assertNoErrorBoundary(page)\r\n\r\n    app.assertNoConsoleErrors()\r\n  })\r\n\r\n  test('search filters can be applied @smoke @search', async ({ page, app }) => {\r\n    await app.goto('/en/search?q=phone')\r\n    await app.waitForHydration()\r\n\r\n    // Look for sort dropdown\r\n    const sortTrigger = page.getByLabel(/sort/i).first()\r\n    const sortVisible = await sortTrigger.isVisible().catch(() => false)\r\n\r\n    if (sortVisible) {\r\n      await sortTrigger.click()\r\n\r\n      const priceOption = page.getByRole('option', { name: /price/i }).first()\r\n      const optionVisible = await priceOption.isVisible().catch(() => false)\r\n\r\n      if (optionVisible) {\r\n        await priceOption.click()\r\n\r\n        // URL should update with sort param (client-side navigation can be fast\r\n        // enough that waiting for a full load is flaky).\r\n        await page.waitForFunction(() => {\r\n          return new URL(window.location.href).searchParams.has('sort')\r\n        }, undefined, { timeout: 10_000 })\r\n        expect(page.url()).toMatch(/sort=/)\r\n      }\r\n    }\r\n\r\n    await assertNoErrorBoundary(page)\r\n    app.assertNoConsoleErrors()\r\n  })\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\hooks\\use-badges.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `SetStateAction<BadgeWithMeta[]>`.","line":47,"column":17,"nodeType":"LogicalExpression","messageId":"unsafeArgument","endLine":47,"endColumn":34},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `string | undefined`.","line":68,"column":25,"nodeType":"LogicalExpression","messageId":"unsafeArgument","endLine":68,"endColumn":63},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'usePublicBadges' is defined but never used.","line":126,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":126,"endColumn":25},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `SetStateAction<BadgeWithMeta[]>`.","line":153,"column":21,"nodeType":"LogicalExpression","messageId":"unsafeArgument","endLine":153,"endColumn":38}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useCallback } from \"react\"\r\nimport type { DisplayBadge } from \"@/lib/types/badges\"\r\n\r\ninterface BadgeWithMeta extends DisplayBadge {\r\n  id: string\r\n  earned_at: string\r\n  is_featured: boolean\r\n}\r\n\r\ninterface UseBadgesResult {\r\n  badges: BadgeWithMeta[]\r\n  isLoading: boolean\r\n  error: string | null\r\n  refetch: () => Promise<void>\r\n  toggleFeatured: (badgeId: string) => Promise<boolean>\r\n  evaluateBadges: (context?: string) => Promise<string[]>\r\n}\r\n\r\n/**\r\n * Hook for managing user badges\r\n * Fetches badges, allows featuring/unfeaturing, and evaluating new badges\r\n */\r\nexport function useBadges(): UseBadgesResult {\r\n  const [badges, setBadges] = useState<BadgeWithMeta[]>([])\r\n  const [isLoading, setIsLoading] = useState(true)\r\n  const [error, setError] = useState<string | null>(null)\r\n\r\n  const fetchBadges = useCallback(async () => {\r\n    setIsLoading(true)\r\n    setError(null)\r\n    \r\n    try {\r\n      const response = await fetch(\"/api/badges\")\r\n      \r\n      if (!response.ok) {\r\n        if (response.status === 401) {\r\n          setError(\"Please sign in to view badges\")\r\n        } else {\r\n          setError(\"Failed to load badges\")\r\n        }\r\n        return\r\n      }\r\n      \r\n      const data = await response.json()\r\n      setBadges(data.badges || [])\r\n    } catch (err) {\r\n      setError(\"Failed to load badges\")\r\n      console.error(\"Error fetching badges:\", err)\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    fetchBadges()\r\n  }, [fetchBadges])\r\n\r\n  const toggleFeatured = useCallback(async (badgeId: string): Promise<boolean> => {\r\n    try {\r\n      const response = await fetch(`/api/badges/feature/${badgeId}`, {\r\n        method: \"PATCH\",\r\n      })\r\n      \r\n      if (!response.ok) {\r\n        const data = await response.json()\r\n        throw new Error(data.error || \"Failed to update badge\")\r\n      }\r\n      \r\n      const data = await response.json()\r\n      \r\n      // Update local state\r\n      setBadges(prev => prev.map(badge => \r\n        badge.id === badgeId \r\n          ? { ...badge, is_featured: data.is_featured }\r\n          : badge\r\n      ))\r\n      \r\n      return data.is_featured\r\n    } catch (err) {\r\n      console.error(\"Error toggling badge feature:\", err)\r\n      throw err\r\n    }\r\n  }, [])\r\n\r\n  const evaluateBadges = useCallback(async (context?: string): Promise<string[]> => {\r\n    try {\r\n      const response = await fetch(\"/api/badges/evaluate\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({ context }),\r\n      })\r\n      \r\n      if (!response.ok) {\r\n        throw new Error(\"Failed to evaluate badges\")\r\n      }\r\n      \r\n      const data = await response.json()\r\n      \r\n      // Refetch badges if new ones were awarded\r\n      if (data.total_awarded > 0) {\r\n        await fetchBadges()\r\n      }\r\n      \r\n      return data.awarded || []\r\n    } catch (err) {\r\n      console.error(\"Error evaluating badges:\", err)\r\n      return []\r\n    }\r\n  }, [fetchBadges])\r\n\r\n  return {\r\n    badges,\r\n    isLoading,\r\n    error,\r\n    refetch: fetchBadges,\r\n    toggleFeatured,\r\n    evaluateBadges,\r\n  }\r\n}\r\n\r\n/**\r\n * Hook to fetch another user's public badges\r\n */\r\nfunction usePublicBadges(userId: string | null) {\r\n  const [badges, setBadges] = useState<BadgeWithMeta[]>([])\r\n  const [isLoading, setIsLoading] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n\r\n  useEffect(() => {\r\n    if (!userId) {\r\n      setBadges([])\r\n      return\r\n    }\r\n    \r\n    let cancelled = false\r\n    \r\n    async function fetchBadges() {\r\n      setIsLoading(true)\r\n      setError(null)\r\n      \r\n      try {\r\n        const response = await fetch(`/api/badges/${userId}`)\r\n        \r\n        if (!response.ok) {\r\n          throw new Error(\"Failed to load badges\")\r\n        }\r\n        \r\n        const data = await response.json()\r\n        \r\n        if (!cancelled) {\r\n          setBadges(data.badges || [])\r\n        }\r\n      } catch (err) {\r\n        if (!cancelled) {\r\n          setError(\"Failed to load badges\")\r\n          console.error(\"Error fetching public badges:\", err)\r\n        }\r\n      } finally {\r\n        if (!cancelled) {\r\n          setIsLoading(false)\r\n        }\r\n      }\r\n    }\r\n    \r\n    fetchBadges()\r\n    \r\n    return () => {\r\n      cancelled = true\r\n    }\r\n  }, [userId])\r\n\r\n  return { badges, isLoading, error }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\hooks\\use-category-attributes.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `CategoryAttribute[]`.","line":71,"column":34,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":71,"endColumn":45},{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `SetStateAction<CategoryAttribute[]>`.","line":72,"column":21,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":72,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback, useRef } from \"react\"\r\nimport type { CategoryAttribute } from \"@/lib/data/categories\"\nimport { normalizeAttributeKey } from \"@/lib/attributes/normalize-attribute-key\"\n\ninterface UseCategoryAttributesResult {\n  attributes: CategoryAttribute[]\n  isLoading: boolean\n  error: string | null\n}\n\n/** Transform API response to CategoryAttribute format */\nfunction normalizeAttribute(api: CategoryAttribute): CategoryAttribute {\n  return {\n    ...api,\n    attribute_key: api.attribute_key ?? (normalizeAttributeKey(api.name) || null),\n    options: Array.isArray(api.options) ? api.options : null,\n    options_bg: Array.isArray(api.options_bg) ? api.options_bg : null,\n  }\n}\n\r\n/**\r\n * Hook to fetch filterable attributes for a category.\r\n * Automatically handles inheritance (parent/grandparent attrs).\r\n * Only returns select/multiselect attrs with options (suitable for filter pills).\r\n */\r\nexport function useCategoryAttributes(\r\n  categorySlug: string | null\r\n): UseCategoryAttributesResult {\r\n  const [attributes, setAttributes] = useState<CategoryAttribute[]>([])\r\n  const [isLoading, setIsLoading] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n  \r\n  // Cache to avoid refetching same category\r\n  const cacheRef = useRef<Map<string, CategoryAttribute[]>>(new Map())\r\n\r\n  const fetchAttributes = useCallback(async (slug: string) => {\n    // Check cache first\n    const cached = cacheRef.current.get(slug)\n    if (cached) {\n      setAttributes(cached)\n      return\n    }\n\r\n    setIsLoading(true)\r\n    setError(null)\r\n\r\n    try {\r\n      const res = await fetch(`/api/categories/${slug}/attributes`)\r\n      if (!res.ok) {\r\n        throw new Error(`Failed to fetch: ${res.status}`)\r\n      }\r\n\r\n      const data = await res.json()\r\n      \r\n      // Filter to only filterable select/multiselect attrs with options\r\n      const filterable = (data.attributes || []).filter(\n        (attr: CategoryAttribute) =>\n          attr.is_filterable &&\n          (attr.attribute_type === \"select\" || attr.attribute_type === \"multiselect\") &&\n          Array.isArray(attr.options) &&\n          attr.options.length > 0\n      )\n\n      // Sort by sortOrder and transform to CategoryAttribute format\n      filterable.sort((a: CategoryAttribute, b: CategoryAttribute) => \n        (a.sort_order ?? 999) - (b.sort_order ?? 999)\n      )\n      \n      const transformed = filterable.map(normalizeAttribute)\n\r\n      cacheRef.current.set(slug, transformed)\r\n      setAttributes(transformed)\r\n    } catch (err) {\r\n      setError(err instanceof Error ? err.message : \"Unknown error\")\r\n      setAttributes([])\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    if (!categorySlug) {\r\n      setAttributes([])\r\n      setIsLoading(false)\r\n      setError(null)\r\n      return\r\n    }\r\n\r\n    fetchAttributes(categorySlug)\r\n  }, [categorySlug, fetchAttributes])\r\n\r\n  return { attributes, isLoading, error }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\hooks\\use-category-counts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\hooks\\use-filter-count.ts","messages":[{"ruleId":"@typescript-eslint/no-unsafe-argument","severity":1,"message":"Unsafe argument of type `any` assigned to a parameter of type `SetStateAction<number>`.","line":82,"column":16,"nodeType":"Identifier","messageId":"unsafeArgument","endLine":82,"endColumn":24},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchCount'. Either include it or remove the dependency array.","line":119,"column":6,"nodeType":"ArrayExpression","endLine":130,"endColumn":4,"suggestions":[{"desc":"Update the dependencies array to be: [params.categoryId, params.query, params.filters.minPrice, params.filters.maxPrice, params.filters.minRating, params.filters.availability, params.filters.deals, params.filters.verified, fetchCount]","fix":{"range":[3173,3510],"text":"[params.categoryId, params.query, params.filters.minPrice, params.filters.maxPrice, params.filters.minRating, params.filters.availability, params.filters.deals, params.filters.verified, fetchCount]"}}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a complex expression in the dependency array. Extract it to a separate variable so it can be statically checked.","line":129,"column":5,"nodeType":"CallExpression","endLine":129,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { useState, useEffect, useRef, useCallback } from \"react\"\r\n\r\n/**\r\n * useFilterCount ΓÇö Client hook for live product count with debounce.\r\n * \r\n * Per UI_UX_CODEX.md:\r\n * - Debounce 250-300ms\r\n * - Updates on every pending change\r\n * - Fallback to last known count if > 2s\r\n */\r\n\r\ninterface FilterCountParams {\r\n  categoryId?: string | null\r\n  query?: string | null\r\n  filters?: {\r\n    minPrice?: number | null\r\n    maxPrice?: number | null\r\n    minRating?: number | null\r\n    availability?: \"instock\" | null\r\n    deals?: boolean | null\r\n    verified?: boolean | null\r\n    attributes?: Record<string, string | string[]>\r\n  }\r\n}\r\n\r\ninterface UseFilterCountResult {\r\n  count: number\r\n  isLoading: boolean\r\n  error: string | null\r\n}\r\n\r\nconst DEBOUNCE_MS = 280\r\nconst TIMEOUT_MS = 2000\r\n\r\nexport function useFilterCount(params: FilterCountParams): UseFilterCountResult {\r\n  const [count, setCount] = useState<number>(0)\r\n  const [isLoading, setIsLoading] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n\r\n  const abortControllerRef = useRef<AbortController | null>(null)\r\n  const timeoutIdRef = useRef<ReturnType<typeof setTimeout> | null>(null)\r\n  const lastCountRef = useRef<number>(0)\r\n\r\n  const fetchCount = useCallback(async (signal: AbortSignal) => {\r\n    setIsLoading(true)\r\n    setError(null)\r\n\r\n    // Set timeout fallback\r\n    const fallbackTimeout = setTimeout(() => {\r\n      if (!signal.aborted) {\r\n        // Stop the request; we already decided to fall back.\r\n        abortControllerRef.current?.abort()\r\n\r\n        // Fallback to last known count\r\n        setCount(lastCountRef.current)\r\n        setIsLoading(false)\r\n      }\r\n    }, TIMEOUT_MS)\r\n\r\n    try {\r\n      const response = await fetch(\"/api/products/count\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify(params),\r\n        signal,\r\n      })\r\n\r\n      clearTimeout(fallbackTimeout)\r\n\r\n      if (signal.aborted) return\r\n\r\n      if (!response.ok) {\r\n        throw new Error(\"Failed to fetch count\")\r\n      }\r\n\r\n      const data = await response.json()\r\n      const newCount = data.count ?? 0\r\n\r\n      lastCountRef.current = newCount\r\n      setCount(newCount)\r\n      setIsLoading(false)\r\n    } catch (err) {\r\n      clearTimeout(fallbackTimeout)\r\n      \r\n      if (signal.aborted) return\r\n\r\n      // On error, keep last known count\r\n      setCount(lastCountRef.current)\r\n      setError(err instanceof Error ? err.message : \"Unknown error\")\r\n      setIsLoading(false)\r\n    }\r\n  }, [params])\r\n\r\n  useEffect(() => {\r\n    // Cancel previous request\r\n    if (abortControllerRef.current) {\r\n      abortControllerRef.current.abort()\r\n    }\r\n    if (timeoutIdRef.current) {\r\n      clearTimeout(timeoutIdRef.current)\r\n    }\r\n\r\n    // Debounce the fetch\r\n    const controller = new AbortController()\r\n    abortControllerRef.current = controller\r\n\r\n    timeoutIdRef.current = setTimeout(() => {\r\n      fetchCount(controller.signal)\r\n    }, DEBOUNCE_MS)\r\n\r\n    return () => {\r\n      controller.abort()\r\n      if (timeoutIdRef.current) {\r\n        clearTimeout(timeoutIdRef.current)\r\n      }\r\n    }\r\n  }, [\r\n    params.categoryId,\r\n    params.query,\r\n    params.filters?.minPrice,\r\n    params.filters?.maxPrice,\r\n    params.filters?.minRating,\r\n    params.filters?.availability,\r\n    params.filters?.deals,\r\n    params.filters?.verified,\r\n    // Stringify attributes for stable dependency\r\n    JSON.stringify(params.filters?.attributes),\r\n  ])\r\n\r\n  return { count, isLoading, error }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\hooks\\use-geo-welcome.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'GEO_STORAGE_KEYS' is assigned a value but never used.","line":319,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":319,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect, useCallback } from 'react';\r\nimport { createClient } from '@/lib/supabase/client';\r\nimport { getShippingRegion, type ShippingRegion } from '@/lib/shipping';\r\nimport type { Locale } from '@/i18n/routing';\r\n\r\n// Storage keys\r\nconst STORAGE_KEYS = {\r\n  DISMISSED: 'geo-welcome-dismissed',\r\n  CONFIRMED: 'geo-region-confirmed',\r\n  LAST_SHOWN: 'geo-last-shown',\r\n} as const;\r\n\r\n// Cookie names (already used by proxy.ts)\r\nconst COOKIE_NAMES = {\n  COUNTRY: 'user-country',\n  ZONE: 'user-zone',\n  LOCALE: 'NEXT_LOCALE',\n} as const;\nconst GEO_WELCOME_COMPLETE_EVENT = \"treido:geo-welcome-complete\";\n\r\nconst SUPPORTED_LOCALES: readonly Locale[] = ['en', 'bg'] as const;\r\n\r\nfunction isSupportedLocale(value: string): value is Locale {\r\n  return (SUPPORTED_LOCALES as readonly string[]).includes(value);\r\n}\r\n\r\nfunction getCurrentLocaleFromPathname(pathname: string): Locale {\r\n  const firstSegment = pathname.split('/').filter(Boolean)[0] || 'en';\r\n  return isSupportedLocale(firstSegment) ? firstSegment : 'en';\r\n}\r\n\r\nfunction getPathWithLocale(targetLocale: Locale): string {\r\n  const { pathname, search, hash } = window.location;\r\n  const segments = pathname.split('/').filter(Boolean);\r\n  const currentLocale = getCurrentLocaleFromPathname(pathname);\r\n\r\n  if (segments.length === 0) {\r\n    return `/${targetLocale}${search}${hash}`;\r\n  }\r\n\r\n  if (segments[0] === currentLocale) {\r\n    segments[0] = targetLocale;\r\n  } else {\r\n    segments.unshift(targetLocale);\r\n  }\r\n\r\n  return `/${segments.join('/')}${search}${hash}`;\r\n}\r\n\r\nfunction getLocaleForRegion(region: ShippingRegion): Locale {\r\n  // App supports only 'en' and 'bg'. Product requirement:\r\n  // - Selecting BG region should switch to /bg\r\n  // - \"Show all products\" should stay on /en\r\n  if (region === 'BG') return 'bg';\r\n  return 'en';\r\n}\r\n\r\nexport interface GeoWelcomeState {\r\n  isOpen: boolean;\r\n  detectedCountry: string;\r\n  detectedRegion: ShippingRegion;\r\n  selectedRegion: ShippingRegion;\r\n  isLoading: boolean;\r\n}\r\n\r\nexport interface UseGeoWelcomeReturn extends GeoWelcomeState {\r\n  setSelectedRegion: (region: ShippingRegion) => void;\r\n  confirmRegion: () => Promise<void>;\r\n  declineAndShowAll: () => void;\r\n  closeModal: () => void;\r\n}\r\n\r\nexport interface UseGeoWelcomeOptions {\r\n  enabled?: boolean;\r\n}\r\n\r\n/**\r\n * Helper to get cookie value\r\n */\r\nfunction getCookie(name: string): string | null {\r\n  if (typeof document === 'undefined') return null;\r\n  const value = `; ${document.cookie}`;\r\n  const parts = value.split(`; ${name}=`);\r\n  if (parts.length === 2) return parts.pop()?.split(';').shift() ?? null;\r\n  return null;\r\n}\r\n\r\n/**\r\n * Helper to set cookie\r\n */\r\nfunction setCookie(name: string, value: string, days: number = 365) {\r\n  if (typeof document === 'undefined') return;\r\n  const expires = new Date();\r\n  expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);\r\n  document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Lax`;\r\n}\r\n\r\n/**\r\n * Helper to safely access localStorage\r\n */\r\nfunction getLocalStorage(key: string): string | null {\r\n  if (typeof window === 'undefined') return null;\r\n  try {\r\n    return localStorage.getItem(key);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Helper to safely set localStorage\r\n */\r\nfunction setLocalStorage(key: string, value: string) {\n  if (typeof window === 'undefined') return;\n  try {\n    localStorage.setItem(key, value);\n  } catch {\n    // Silently fail for incognito mode or storage full\n  }\n}\n\nfunction dispatchGeoWelcomeCompleteEvent() {\n  if (typeof window === \"undefined\") return;\n  window.dispatchEvent(new CustomEvent(GEO_WELCOME_COMPLETE_EVENT));\n}\n\r\n/**\r\n * Custom hook for managing geo-location welcome modal state\r\n * Handles first-visit detection, cookie management, and Supabase profile sync\r\n */\r\nexport function useGeoWelcome(options: UseGeoWelcomeOptions = {}): UseGeoWelcomeReturn {\r\n  const { enabled = true } = options;\r\n  const [state, setState] = useState<GeoWelcomeState>({\r\n    isOpen: false,\r\n    detectedCountry: 'BG',\r\n    detectedRegion: 'BG',\r\n    selectedRegion: 'BG',\r\n    isLoading: true,\r\n  });\r\n\r\n  // Initialize state on mount\r\n  useEffect(() => {\r\n    if (!enabled) {\r\n      setState(prev => ({ ...prev, isOpen: false, isLoading: false }));\r\n      return;\r\n    }\r\n\r\n    const initializeGeoWelcome = async () => {\r\n      // Check if already dismissed\r\n      const dismissed = getLocalStorage(STORAGE_KEYS.DISMISSED);\r\n      if (dismissed === 'true') {\r\n        setState(prev => ({ ...prev, isOpen: false, isLoading: false }));\r\n        return;\r\n      }\r\n\r\n      // Get detected country from cookie (set by proxy.ts)\r\n      const countryCode = getCookie(COOKIE_NAMES.COUNTRY) || 'BG';\r\n      const zoneFromCookie = getCookie(COOKIE_NAMES.ZONE) as ShippingRegion | null;\r\n      const detectedRegion = zoneFromCookie || getShippingRegion(countryCode);\r\n\r\n      // Check if user is authenticated and has a saved region preference\r\n      const supabase = createClient();\r\n      const { data: { user } } = await supabase.auth.getUser();\r\n\r\n      if (user) {\r\n        const { data: profile } = await supabase\r\n          .from('profiles')\r\n          .select('shipping_region, country_code')\r\n          .eq('id', user.id)\r\n          .single();\r\n\r\n        // If user has a saved preference, use it and don't show modal\r\n        if (profile?.shipping_region) {\r\n          // Sync profile region to cookies\r\n          setCookie(COOKIE_NAMES.ZONE, profile.shipping_region);\r\n          if (profile.country_code) {\r\n            setCookie(COOKIE_NAMES.COUNTRY, profile.country_code);\r\n          }\r\n          setLocalStorage(STORAGE_KEYS.DISMISSED, 'true');\r\n          setState(prev => ({ ...prev, isOpen: false, isLoading: false }));\r\n          return;\r\n        }\r\n      }\r\n\r\n      // Show the modal for first-time visitors\r\n      setState({\r\n        isOpen: true,\r\n        detectedCountry: countryCode,\r\n        detectedRegion,\r\n        selectedRegion: detectedRegion,\r\n        isLoading: false,\r\n      });\r\n\r\n      // Record when modal was shown\r\n      setLocalStorage(STORAGE_KEYS.LAST_SHOWN, Date.now().toString());\r\n    };\r\n\r\n    initializeGeoWelcome();\r\n  }, [enabled]);\r\n\r\n  /**\r\n   * Update selected region in state\r\n   */\r\n  const setSelectedRegion = useCallback((region: ShippingRegion) => {\r\n    setState(prev => ({ ...prev, selectedRegion: region }));\r\n  }, []);\r\n\r\n  /**\r\n   * Confirm region selection - updates cookies and optionally Supabase profile\r\n   */\r\n  const confirmRegion = useCallback(async () => {\r\n    const { selectedRegion, detectedRegion, detectedCountry } = state;\r\n\r\n    // Determine if this was auto-detected or manually changed\r\n    const isAutoDetected = selectedRegion === detectedRegion;\r\n\r\n    // Get country code for the selected region (use detected country if same region)\r\n    const countryCode =\r\n      selectedRegion === 'WW'\r\n        ? detectedCountry\r\n        : (isAutoDetected ? detectedCountry : getRegionCountryCode(selectedRegion));\r\n\r\n    // Update cookies\r\n    setCookie(COOKIE_NAMES.ZONE, selectedRegion);\r\n    setCookie(COOKIE_NAMES.COUNTRY, countryCode);\r\n\r\n    // Keep locale cookie in sync with region selection.\r\n    // (Locale routing is URL-based, but this preserves preference for future visits.)\r\n    const targetLocale = getLocaleForRegion(selectedRegion);\r\n    setCookie(COOKIE_NAMES.LOCALE, targetLocale);\r\n\r\n    // Mark as dismissed\r\n    setLocalStorage(STORAGE_KEYS.DISMISSED, 'true');\r\n    setLocalStorage(STORAGE_KEYS.CONFIRMED, 'true');\r\n\r\n    // If authenticated, update Supabase profile\r\n    const supabase = createClient();\r\n    const { data: { user } } = await supabase.auth.getUser();\r\n\r\n    if (user) {\r\n      await supabase\r\n        .from('profiles')\r\n        .update({\r\n          shipping_region: selectedRegion,\r\n          country_code: countryCode,\r\n          region_auto_detected: isAutoDetected,\r\n          region_updated_at: new Date().toISOString(),\r\n        })\r\n        .eq('id', user.id);\r\n    }\r\n\r\n    // Close modal\n    setState(prev => ({ ...prev, isOpen: false }));\n    dispatchGeoWelcomeCompleteEvent();\n\n    // Navigate to the correct locale route (BUG-001 fix).\n    // This also refreshes server components with the updated cookies.\r\n    window.location.assign(getPathWithLocale(targetLocale));\r\n  }, [state]);\r\n\r\n  /**\r\n   * Decline region filtering - show all products\r\n   */\r\n  const declineAndShowAll = useCallback(() => {\r\n    // Set to worldwide (no filtering)\r\n    setCookie(COOKIE_NAMES.ZONE, 'WW');\r\n\r\n    // Match product expectation: \"Show all\" keeps English locale.\r\n    setCookie(COOKIE_NAMES.LOCALE, 'en');\r\n\r\n    // Mark as dismissed\r\n    setLocalStorage(STORAGE_KEYS.DISMISSED, 'true');\r\n\r\n    // Close modal\n    setState(prev => ({ ...prev, isOpen: false }));\n    dispatchGeoWelcomeCompleteEvent();\n\n    // Navigate to /en to reflect \"show all\" behavior.\n    window.location.assign(getPathWithLocale('en'));\r\n  }, []);\r\n\r\n  /**\r\n   * Close modal without action (just dismiss)\r\n   */\r\n  const closeModal = useCallback(() => {\n    setLocalStorage(STORAGE_KEYS.DISMISSED, 'true');\n    setState(prev => ({ ...prev, isOpen: false }));\n    dispatchGeoWelcomeCompleteEvent();\n  }, []);\n\r\n  return {\r\n    ...state,\r\n    setSelectedRegion,\r\n    confirmRegion,\r\n    declineAndShowAll,\r\n    closeModal,\r\n  };\r\n}\r\n\r\n/**\r\n * Get a representative country code for a shipping region\r\n */\r\nfunction getRegionCountryCode(region: ShippingRegion): string {\r\n  const regionToCountry: Record<ShippingRegion, string> = {\r\n    BG: 'BG',\r\n    UK: 'GB',\r\n    EU: 'DE', // Use Germany as representative EU country\r\n    US: 'US',\r\n    WW: 'BG',\r\n  };\r\n  return regionToCountry[region];\r\n}\r\n\r\n/**\r\n * Export storage keys for external use (e.g., resetting preferences)\r\n */\r\nconst GEO_STORAGE_KEYS = STORAGE_KEYS;\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\hooks\\use-instant-category-browse.ts","messages":[{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":37,"column":21,"nodeType":"CallExpression","messageId":"array-from","endLine":37,"endColumn":44,"fix":{"range":[979,1002],"text":"[...next.keys()]"}},{"ruleId":"sonarjs/no-nested-template-literals","severity":1,"message":"Refactor this code to not use nested template literals.","line":137,"column":79,"nodeType":"TemplateLiteral","messageId":"nestedTemplateLiterals","endLine":137,"endColumn":87},{"ruleId":"sonarjs/no-redundant-jump","severity":1,"message":"Remove this redundant jump.","line":246,"column":7,"nodeType":"ReturnStatement","messageId":"removeRedundantJump","endLine":246,"endColumn":13,"suggestions":[{"messageId":"suggestJumpRemoval","fix":{"range":[8365,8379],"text":""},"desc":"Remove this redundant jump"}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":1,"source":"\"use client\"\r\n\r\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\"\r\nimport type { UIProduct } from \"@/lib/data/products\"\r\nimport type { CategoryAttribute } from \"@/lib/data/categories\"\r\n\r\ntype CategoryLite = {\r\n  id: string\r\n  name: string\r\n  name_bg: string | null\r\n  slug: string\r\n  parent_id: string | null\r\n  icon?: string | null\r\n  image_url?: string | null\r\n}\r\n\r\ntype CategoryContextResponse = {\r\n  current: CategoryLite\r\n  parent: CategoryLite | null\r\n  siblings: CategoryLite[]\r\n  children: CategoryLite[]\r\n  attributes: CategoryAttribute[]\r\n}\r\n\r\ntype FeedState = {\r\n  products: UIProduct[]\r\n  page: number\r\n  hasMore: boolean\r\n}\r\n\r\nfunction toDisplayName(locale: string, cat: { name: string; name_bg: string | null }): string {\r\n  return locale === \"bg\" && cat.name_bg ? cat.name_bg : cat.name\r\n}\r\n\r\nfunction withoutAttrParams(params: URLSearchParams): URLSearchParams {\r\n  const next = new URLSearchParams(params.toString())\r\n  for (const key of Array.from(next.keys())) {\r\n    if (key.startsWith(\"attr_\")) next.delete(key)\r\n  }\r\n  return next\r\n}\r\n\r\n/**\r\n * Update URL for category navigation.\r\n * - For filters: use replaceState (no history entry)\r\n * - For category changes: use pushState (proper back button support)\r\n */\r\nfunction updateUrl(nextPath: string, createHistoryEntry: boolean) {\r\n  try {\r\n    if (createHistoryEntry) {\r\n      window.history.pushState(null, \"\", nextPath)\r\n    } else {\r\n      window.history.replaceState(null, \"\", nextPath)\r\n    }\r\n  } catch {\r\n    // Non-blocking; URL sync is a UX enhancement.\r\n  }\r\n}\r\n\r\nasync function fetchJson<T>(url: string, signal?: AbortSignal): Promise<T> {\r\n  const res = await fetch(url, { method: \"GET\", credentials: \"same-origin\", signal: signal ?? null })\r\n  if (!res.ok) {\r\n    throw new Error(`Request failed: ${res.status}`)\r\n  }\r\n  return (await res.json()) as T\r\n}\r\n\r\nexport function useInstantCategoryBrowse(options: {\r\n  enabled: boolean\r\n  locale: string\r\n  /** Initial category slug (the route slug) */\r\n  initialSlug: string\r\n  initialTitle: string\r\n  initialCategoryId: string | undefined\r\n  initialParent: CategoryLite | null\r\n  initialChildren: CategoryLite[]\r\n  initialAttributes: CategoryAttribute[]\r\n  initialProducts: UIProduct[]\r\n  /** Initial querystring without leading ? (from server searchParams) */\r\n  initialQueryString?: string\r\n}) {\r\n  const {\r\n    enabled,\r\n    locale,\r\n    initialSlug,\r\n    initialTitle,\r\n    initialCategoryId,\r\n    initialParent,\r\n    initialChildren,\r\n    initialAttributes,\r\n    initialProducts,\r\n    initialQueryString = \"\",\r\n  } = options\r\n\r\n  const [categorySlug, setCategorySlugState] = useState(initialSlug)\r\n  const [categoryId, setCategoryId] = useState<string | undefined>(initialCategoryId)\r\n  const [categoryTitle, setCategoryTitle] = useState(initialTitle)\r\n  const [parent, setParent] = useState<CategoryLite | null>(initialParent)\r\n  const [children, setChildren] = useState<CategoryLite[]>(initialChildren)\r\n  const [attributes, setAttributes] = useState<CategoryAttribute[]>(initialAttributes)\r\n\r\n  const [appliedParams, setAppliedParams] = useState<URLSearchParams>(() => new URLSearchParams(initialQueryString))\r\n  const [feed, setFeed] = useState<FeedState>(() => ({\r\n    products: initialProducts,\r\n    page: 1,\r\n    hasMore: true,\r\n  }))\r\n  const [isLoading, setIsLoading] = useState(false)\r\n  // Track which category slug is currently being navigated to (for loading indicators)\r\n  const [loadingSlug, setLoadingSlug] = useState<string | null>(null)\r\n\r\n  const productsCacheRef = useRef(new Map<string, { products: UIProduct[]; hasMore: boolean }>())\r\n  const contextCacheRef = useRef(new Map<string, CategoryContextResponse>())\r\n  const abortRef = useRef<AbortController | null>(null)\r\n\r\n  const activeSlug = categorySlug\r\n\r\n  const activeCategoryName = useMemo(() => categoryTitle, [categoryTitle])\r\n\r\n  const buildProductsUrl = useCallback((slug: string, params: URLSearchParams, page: number, limit: number) => {\r\n    const next = new URLSearchParams(params.toString())\r\n    next.delete(\"category\")\r\n    next.delete(\"page\")\r\n    next.delete(\"limit\")\r\n    next.set(\"category\", slug)\r\n    next.set(\"page\", String(page))\r\n    next.set(\"limit\", String(limit))\r\n    return `/api/products/newest?${next.toString()}`\r\n  }, [])\r\n\r\n  /**\r\n   * Sync URL with current category state.\r\n   * @param createHistoryEntry - true for category changes (back button works), false for filter changes\r\n   */\r\n  const syncUrl = useCallback((slug: string, params: URLSearchParams, createHistoryEntry: boolean = false) => {\r\n    const qs = params.toString()\r\n    const nextPath = `/${locale}/categories/${encodeURIComponent(slug)}${qs ? `?${qs}` : \"\"}`\r\n    updateUrl(nextPath, createHistoryEntry)\r\n  }, [locale])\r\n\r\n  const loadPage = useCallback(async (opts: {\r\n    slug: string\r\n    params: URLSearchParams\r\n    page: number\r\n    append: boolean\r\n  }) => {\r\n    const { slug, params, page, append } = opts\r\n    const limit = 24\r\n\r\n    const cacheKey = `${slug}|${params.toString()}|${page}|${limit}`\r\n    const cached = productsCacheRef.current.get(cacheKey)\r\n    if (cached) {\r\n      setFeed((prev) => ({\r\n        products: append ? [...prev.products, ...cached.products] : cached.products,\r\n        page,\r\n        hasMore: cached.hasMore,\r\n      }))\r\n      return\r\n    }\r\n\r\n    abortRef.current?.abort()\r\n    const ac = new AbortController()\r\n    abortRef.current = ac\r\n\r\n    setIsLoading(true)\r\n    try {\r\n      const url = buildProductsUrl(slug, params, page, limit)\r\n      const data = await fetchJson<{ products: UIProduct[]; hasMore: boolean }>(url, ac.signal)\r\n      const products = Array.isArray(data.products) ? data.products : []\r\n      const hasMore = Boolean(data.hasMore)\r\n\r\n      productsCacheRef.current.set(cacheKey, { products, hasMore })\r\n\r\n      setFeed((prev) => ({\r\n        products: append ? [...prev.products, ...products] : products,\r\n        page,\r\n        hasMore,\r\n      }))\r\n    } finally {\r\n      setIsLoading(false)\r\n    }\r\n  }, [buildProductsUrl])\r\n\r\n  const setFilters = useCallback(async (nextParams: URLSearchParams) => {\r\n    if (!enabled) return\r\n\r\n    // New filters apply instantly to current category.\r\n    // Use replaceState (no history entry) - filters shouldn't pollute back button\r\n    setAppliedParams(nextParams)\r\n    syncUrl(categorySlug, nextParams, false)\r\n\r\n    await loadPage({ slug: categorySlug, params: nextParams, page: 1, append: false })\r\n  }, [enabled, categorySlug, loadPage, syncUrl])\r\n\r\n  /**\r\n   * Internal navigation - fetches context + products for a category.\r\n   * Shared by both user-initiated navigation and popstate handler.\r\n   */\r\n  const navigateToCategory = useCallback(async (\r\n    nextSlug: string,\r\n    nextParams: URLSearchParams,\r\n    updateHistory: boolean\r\n  ) => {\r\n    setLoadingSlug(nextSlug)\r\n    setCategorySlugState(nextSlug)\r\n    setAppliedParams(nextParams)\r\n\r\n    if (updateHistory) {\r\n      syncUrl(nextSlug, nextParams, true)\r\n    }\r\n\r\n    // Context (cached) + products\r\n    try {\r\n      const cached = contextCacheRef.current.get(nextSlug)\r\n      const context = cached ?? (await fetchJson<CategoryContextResponse>(`/api/categories/${encodeURIComponent(nextSlug)}/context`))\r\n      if (!cached) contextCacheRef.current.set(nextSlug, context)\r\n\r\n      setCategoryId(context.current.id)\r\n      setCategoryTitle(toDisplayName(locale, context.current))\r\n      setParent(context.parent)\r\n      setChildren(context.children)\r\n      setAttributes(context.attributes)\r\n    } catch {\r\n      // If context fails, products still load (best-effort).\r\n    }\r\n\r\n    await loadPage({ slug: nextSlug, params: nextParams, page: 1, append: false })\r\n    setLoadingSlug(null)\r\n  }, [loadPage, locale, syncUrl])\r\n\r\n  const setCategorySlug = useCallback(async (nextSlug: string, opts?: { clearAttrFilters?: boolean }) => {\r\n    if (!enabled) return\r\n    if (!nextSlug || nextSlug === categorySlug) return\r\n\r\n    const nextParams = opts?.clearAttrFilters\r\n      ? withoutAttrParams(appliedParams)\r\n      : new URLSearchParams(appliedParams.toString())\r\n\r\n    await navigateToCategory(nextSlug, nextParams, true)\r\n  }, [enabled, categorySlug, appliedParams, navigateToCategory])\r\n\r\n  const goBack = useCallback(async () => {\r\n    if (!enabled) return\r\n    if (parent?.slug) {\r\n      await setCategorySlug(parent.slug, { clearAttrFilters: true })\r\n      return\r\n    }\r\n  }, [enabled, parent?.slug, setCategorySlug])\r\n\r\n  const loadMore = useCallback(async () => {\r\n    if (!enabled) return\r\n    if (isLoading || !feed.hasMore) return\r\n    await loadPage({ slug: categorySlug, params: appliedParams, page: feed.page + 1, append: true })\r\n  }, [enabled, isLoading, feed.hasMore, feed.page, loadPage, categorySlug, appliedParams])\r\n\r\n  // Prefetch category context for faster navigation\r\n  const prefetchCategory = useCallback((slug: string) => {\r\n    if (!enabled) return\r\n    if (contextCacheRef.current.has(slug)) return // Already cached\r\n\r\n    // Fire-and-forget prefetch\r\n    fetchJson<CategoryContextResponse>(`/api/categories/${encodeURIComponent(slug)}/context`)\r\n      .then((context) => {\r\n        contextCacheRef.current.set(slug, context)\r\n      })\r\n      .catch(() => {\r\n        // Prefetch failures are silent - non-critical\r\n      })\r\n  }, [enabled])\r\n\r\n  // Auto-prefetch children categories for instant drilling down\r\n  useEffect(() => {\r\n    if (!enabled) return\r\n    // Prefetch all child categories in background\r\n    children.forEach((child) => {\r\n      prefetchCategory(child.slug)\r\n    })\r\n  }, [enabled, children, prefetchCategory])\r\n\r\n  // Handle browser back/forward navigation (popstate)\r\n  useEffect(() => {\r\n    if (!enabled) return\r\n\r\n    const handlePopState = () => {\r\n      const path = window.location.pathname\r\n      const match = path.match(/\\/categories\\/([^/?]+)/)\r\n      const urlSlug = match?.[1] ? decodeURIComponent(match[1]) : null\r\n\r\n      if (urlSlug && urlSlug !== categorySlug) {\r\n        const params = new URLSearchParams(window.location.search)\r\n        // Don't create new history entry - we're responding to existing navigation\r\n        navigateToCategory(urlSlug, params, false)\r\n      }\r\n    }\r\n\r\n    window.addEventListener(\"popstate\", handlePopState)\r\n    return () => window.removeEventListener(\"popstate\", handlePopState)\r\n  }, [enabled, categorySlug, navigateToCategory])\r\n\r\n  return {\r\n    categorySlug,\r\n    categoryId,\r\n    categoryTitle,\r\n    parent,\r\n    children,\r\n    attributes,\r\n    appliedSearchParams: appliedParams,\r\n    feed,\r\n    isLoading,\r\n    loadingSlug,\r\n    activeSlug,\r\n    activeCategoryName,\r\n    setFilters,\r\n    setCategorySlug,\r\n    goBack,\r\n    loadMore,\r\n    prefetchCategory,\r\n  }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\hooks\\use-mobile.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\hooks\\use-notification-count.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\hooks\\use-product-quick-view-details.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\hooks\\use-product-search.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\hooks\\use-recently-viewed.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\hooks\\use-toast.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'actionTypes' is assigned a value but only used as a type.","line":18,"column":7,"nodeType":"Identifier","messageId":"usedOnlyAsType","endLine":18,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\n// Inspired by react-hot-toast library\nimport * as React from 'react'\n\nimport type { ToastActionElement, ToastProps } from '@/components/ui/toast'\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: 'ADD_TOAST',\n  UPDATE_TOAST: 'UPDATE_TOAST',\n  DISMISS_TOAST: 'DISMISS_TOAST',\n  REMOVE_TOAST: 'REMOVE_TOAST',\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType['ADD_TOAST']\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType['UPDATE_TOAST']\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType['DISMISS_TOAST']\n      toastId?: ToasterToast['id']\n    }\n  | {\n      type: ActionType['REMOVE_TOAST']\n      toastId?: ToasterToast['id']\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: 'REMOVE_TOAST',\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case 'ADD_TOAST':\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case 'UPDATE_TOAST':\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t,\n        ),\n      }\n\n    case 'DISMISS_TOAST': {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t,\n        ),\n      }\n    }\n    case 'REMOVE_TOAST':\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, 'id'>\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: 'UPDATE_TOAST',\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: 'DISMISS_TOAST', toastId: id })\n\n  dispatch({\n    type: 'ADD_TOAST',\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) =>\n      dispatch(toastId ? { type: 'DISMISS_TOAST', toastId } : { type: 'DISMISS_TOAST' }),\n  }\n}\n\nexport { useToast, toast }\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\hooks\\use-view-mode.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\i18n\\request.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\i18n\\routing.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\ai\\env.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\ai\\models.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\ai\\safe-url.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\ai\\schemas\\find-similar.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\ai\\schemas\\listings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\ai\\schemas\\sell-autofill.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\ai\\tools\\assistant-tools.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\ai\\tools\\get-listing.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\ai\\tools\\search-listings.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\api\\envelope.ts","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"The `{}` (\"empty object\") type allows any non-nullish value, including literals like `0` and `\"\"`.\n- If that's what you want, disable this lint rule with an inline comment or configure the 'allowObjectTypes' rule option.\n- If you want a type meaning \"any object\", you probably want `object` instead.\n- If you want a type meaning \"any value\", you probably want `unknown` instead.","line":3,"column":57,"nodeType":"TSTypeLiteral","messageId":"noEmptyObject","endLine":3,"endColumn":59,"suggestions":[{"messageId":"replaceEmptyObjectType","data":{"replacement":"object"},"fix":{"range":[104,106],"text":"object"},"desc":"Replace `{}` with `object`."},{"messageId":"replaceEmptyObjectType","data":{"replacement":"unknown"},"fix":{"range":[104,106],"text":"unknown"},"desc":"Replace `{}` with `unknown`."}]},{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"The `{}` (\"empty object\") type allows any non-nullish value, including literals like `0` and `\"\"`.\n- If that's what you want, disable this lint rule with an inline comment or configure the 'allowObjectTypes' rule option.\n- If you want a type meaning \"any object\", you probably want `object` instead.\n- If you want a type meaning \"any value\", you probably want `unknown` instead.","line":4,"column":55,"nodeType":"TSTypeLiteral","messageId":"noEmptyObject","endLine":4,"endColumn":57,"suggestions":[{"messageId":"replaceEmptyObjectType","data":{"replacement":"object"},"fix":{"range":[186,188],"text":"object"},"desc":"Replace `{}` with `object`."},{"messageId":"replaceEmptyObjectType","data":{"replacement":"unknown"},"fix":{"range":[186,188],"text":"unknown"},"desc":"Replace `{}` with `unknown`."}]},{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"The `{}` (\"empty object\") type allows any non-nullish value, including literals like `0` and `\"\"`.\n- If that's what you want, disable this lint rule with an inline comment or configure the 'allowObjectTypes' rule option.\n- If you want a type meaning \"any object\", you probably want `object` instead.\n- If you want a type meaning \"any value\", you probably want `unknown` instead.","line":5,"column":57,"nodeType":"TSTypeLiteral","messageId":"noEmptyObject","endLine":5,"endColumn":59,"suggestions":[{"messageId":"replaceEmptyObjectType","data":{"replacement":"object"},"fix":{"range":[271,273],"text":"object"},"desc":"Replace `{}` with `object`."},{"messageId":"replaceEmptyObjectType","data":{"replacement":"unknown"},"fix":{"range":[271,273],"text":"unknown"},"desc":"Replace `{}` with `unknown`."}]},{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"The `{}` (\"empty object\") type allows any non-nullish value, including literals like `0` and `\"\"`.\n- If that's what you want, disable this lint rule with an inline comment or configure the 'allowObjectTypes' rule option.\n- If you want a type meaning \"any object\", you probably want `object` instead.\n- If you want a type meaning \"any value\", you probably want `unknown` instead.","line":5,"column":94,"nodeType":"TSTypeLiteral","messageId":"noEmptyObject","endLine":5,"endColumn":96,"suggestions":[{"messageId":"replaceEmptyObjectType","data":{"replacement":"object"},"fix":{"range":[308,310],"text":"object"},"desc":"Replace `{}` with `object`."},{"messageId":"replaceEmptyObjectType","data":{"replacement":"unknown"},"fix":{"range":[308,310],"text":"unknown"},"desc":"Replace `{}` with `unknown`."}]},{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"The `{}` (\"empty object\") type allows any non-nullish value, including literals like `0` and `\"\"`.\n- If that's what you want, disable this lint rule with an inline comment or configure the 'allowObjectTypes' rule option.\n- If you want a type meaning \"any object\", you probably want `object` instead.\n- If you want a type meaning \"any value\", you probably want `unknown` instead.","line":9,"column":61,"nodeType":"TSTypeLiteral","messageId":"noEmptyObject","endLine":9,"endColumn":63,"suggestions":[{"messageId":"replaceEmptyObjectType","data":{"replacement":"object"},"fix":{"range":[431,433],"text":"object"},"desc":"Replace `{}` with `object`."},{"messageId":"replaceEmptyObjectType","data":{"replacement":"unknown"},"fix":{"range":[431,433],"text":"unknown"},"desc":"Replace `{}` with `unknown`."}]},{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"The `{}` (\"empty object\") type allows any non-nullish value, including literals like `0` and `\"\"`.\n- If that's what you want, disable this lint rule with an inline comment or configure the 'allowObjectTypes' rule option.\n- If you want a type meaning \"any object\", you probably want `object` instead.\n- If you want a type meaning \"any value\", you probably want `unknown` instead.","line":17,"column":59,"nodeType":"TSTypeLiteral","messageId":"noEmptyObject","endLine":17,"endColumn":61,"suggestions":[{"messageId":"replaceEmptyObjectType","data":{"replacement":"object"},"fix":{"range":[644,646],"text":"object"},"desc":"Replace `{}` with `object`."},{"messageId":"replaceEmptyObjectType","data":{"replacement":"unknown"},"fix":{"range":[644,646],"text":"unknown"},"desc":"Replace `{}` with `unknown`."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"type EnvelopePayload = Record<string, unknown>\n\nexport type SuccessEnvelope<T extends EnvelopePayload = {}> = { success: true } & T\nexport type ErrorEnvelope<T extends EnvelopePayload = {}> = { success: false } & T\nexport type Envelope<TSuccess extends EnvelopePayload = {}, TError extends EnvelopePayload = {}> =\n  | SuccessEnvelope<TSuccess>\n  | ErrorEnvelope<TError>\n\nexport function successEnvelope<T extends EnvelopePayload = {}>(payload?: T): SuccessEnvelope<T> {\n  if (!payload) {\n    return { success: true } as SuccessEnvelope<T>\n  }\n\n  return { success: true, ...payload }\n}\n\nexport function errorEnvelope<T extends EnvelopePayload = {}>(payload?: T): ErrorEnvelope<T> {\n  if (!payload) {\n    return { success: false } as ErrorEnvelope<T>\n  }\n\n  return { success: false, ...payload }\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\api\\response-helpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\attributes\\normalize-attribute-key.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\auth\\admin.ts","messages":[{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'toRecord' to the outer scope.","line":85,"column":69,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":85,"endColumn":71},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'asNumber' to the outer scope.","line":90,"column":52,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":90,"endColumn":54}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import 'server-only'\r\n\r\nimport { createClient, createAdminClient } from \"@/lib/supabase/server\"\r\nimport { logger } from \"@/lib/logger\"\r\nimport { redirect } from \"@/i18n/routing\"\r\nimport { connection } from \"next/server\"\r\nimport { getLocale } from \"next-intl/server\"\r\n\r\nexport type UserRole = 'buyer' | 'seller' | 'admin'\r\n\r\nexport interface AdminUser {\r\n  id: string\r\n  email: string\r\n  role: UserRole\r\n  full_name: string | null\r\n}\r\n\r\n/**\r\n * Verifies the current user is authenticated and has admin role.\r\n * MUST be called in server components only.\r\n * \r\n * @param redirectTo - Where to redirect non-admins (default: /)\r\n * @returns The admin user if verified\r\n * @throws Redirects to login or home if not authorized\r\n */\r\nexport async function requireAdmin(redirectTo: string = \"/\"): Promise<AdminUser> {\n  // Mark as dynamic - auth check reads cookies\n  await connection()\n  const locale = await getLocale()\n  \n  const supabase = await createClient()\n  \n  // First check if user is authenticated\n  const { data: { user }, error: authError } = await supabase.auth.getUser()\n  \n  if (authError || !user) {\n    return redirect({ href: \"/auth/login\", locale })\n  }\n  \n  // Then check their role in the profiles table (public surface)\n  const [\n    { data: profile, error: profileError },\n    { data: privateProfile },\n  ] = await Promise.all([\n    supabase\n      .from('profiles')\n      .select('id, role, full_name')\n      .eq('id', user.id)\n      .single(),\n    supabase\n      .from('private_profiles')\n      .select('email')\n      .eq('id', user.id)\n      .maybeSingle(),\n  ])\n  \n  if (profileError || !profile) {\n    logger.error(\"[Admin] Admin check failed - no profile\", profileError)\n    return redirect({ href: redirectTo, locale })\n  }\n  \r\n  if (profile.role !== 'admin') {\r\n    // Not an admin - silently redirect (don't reveal admin exists)\r\n    return redirect({ href: redirectTo, locale })\r\n  }\r\n  \r\n  return {\n    id: profile.id,\n    email: privateProfile?.email || user.email || '',\n    role: profile.role as UserRole,\n    full_name: profile.full_name,\n  }\n}\n\r\n/**\r\n * Gets admin statistics using service role (bypasses RLS)\r\n * ONLY call this after verifying admin with requireAdmin()\r\n */\r\nexport async function getAdminStats() {\n  // Mark as dynamic and satisfy Next.js current-time access rules.\n  await connection()\n\n  const adminClient = createAdminClient()\n\n  const toRecord = (value: unknown): Record<string, unknown> | null => {\n    if (!value || typeof value !== \"object\") return null\n    return value as Record<string, unknown>\n  }\n\n  const asNumber = (value: unknown): number | null => {\n    if (typeof value === \"number\") return Number.isFinite(value) ? value : null\n    if (typeof value === \"string\") {\n      const parsed = Number(value)\n      return Number.isFinite(parsed) ? parsed : null\n    }\n    return null\n  }\n\r\n  const sevenDaysAgoIso = new Date(\r\n    Date.now() - 7 * 24 * 60 * 60 * 1000\r\n  ).toISOString()\r\n  \r\n  const [\r\n    usersResult,\r\n    productsResult,\r\n    ordersResult,\r\n    sellersResult,\r\n    recentUsersResult,\r\n    recentProductsResult,\r\n    recentOrdersResult,\r\n  ] = await Promise.all([\r\n    // Total counts\r\n    adminClient.from('profiles').select('id', { count: 'exact', head: true }),\r\n    adminClient.from('products').select('id', { count: 'exact', head: true }),\r\n    adminClient.from('orders').select('id', { count: 'exact', head: true }),\r\n    adminClient.from('profiles').select('id', { count: 'exact', head: true }).eq('is_seller', true),\r\n    \r\n    // Recent activity (last 7 days)\n    adminClient\n      .from('profiles')\n      .select('id, full_name, role, created_at')\n      .gte('created_at', sevenDaysAgoIso)\n      .order('created_at', { ascending: false })\n      .limit(10),\n    \r\n    adminClient\r\n      .from('products')\r\n      .select('id, title, price, created_at, seller_id')\r\n      .gte('created_at', sevenDaysAgoIso)\r\n      .order('created_at', { ascending: false })\r\n      .limit(10),\r\n    \r\n    adminClient\r\n      .from('orders')\r\n      .select('id, total_amount, status, created_at, user_id')\r\n      .order('created_at', { ascending: false })\r\n      .limit(10),\r\n  ])\r\n  \r\n  // Calculate revenue via SQL aggregate (avoid scanning all orders client-side)\n  const revenueResult = await adminClient\n    .from(\"orders\")\n    .select(\"total_amount.sum()\")\n    .eq(\"status\", \"paid\")\n    .maybeSingle()\n\n  const revenueRecord = toRecord(revenueResult.data)\n  const totalRevenue =\n    asNumber(revenueRecord?.total_amount) ?? asNumber(revenueRecord?.sum) ?? 0\n\n  const recentUsersBase = recentUsersResult.data || []\n  const recentUserIds = recentUsersBase.map((u) => u.id).filter(Boolean)\n\n  const { data: privateProfiles } = recentUserIds.length\n    ? await adminClient\n        .from('private_profiles')\n        .select('id, email')\n        .in('id', recentUserIds)\n    : { data: [] }\n\n  const emailById = new Map((privateProfiles || []).map((p) => [p.id, p.email]))\n  const recentUsers = recentUsersBase.map((u) => ({\n    ...u,\n    email: emailById.get(u.id) ?? '',\n  }))\n  \n  return {\n    totals: {\n      users: usersResult.count || 0,\n      products: productsResult.count || 0,\n      orders: ordersResult.count || 0,\n      sellers: sellersResult.count || 0,\n      revenue: totalRevenue,\n    },\n    recent: {\n      users: recentUsers,\n      products: recentProductsResult.data || [],\n      orders: recentOrdersResult.data || [],\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\auth\\business.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getBusinessSellerWithSubscription' is defined but never used.","line":287,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":287,"endColumn":49},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isBusinessAccount' is defined but never used.","line":333,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":333,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getSellerInfo' is defined but never used.","line":356,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":356,"endColumn":29},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":571,"column":26,"nodeType":"CallExpression","messageId":"array-from","endLine":571,"endColumn":41,"fix":{"range":[16994,17009],"text":"[...ids]"}},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":678,"column":20,"nodeType":"CallExpression","messageId":"array-from","endLine":678,"endColumn":92,"fix":{"range":[20263,20335],"text":"[...new Set((data || []).map((i) => i.order_id).filter(Boolean))]"}},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":679,"column":22,"nodeType":"CallExpression","messageId":"array-from","endLine":679,"endColumn":96,"fix":{"range":[20358,20432],"text":"[...new Set((data || []).map((i) => i.product_id).filter(Boolean))]"}},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":702,"column":19,"nodeType":"CallExpression","messageId":"array-from","endLine":702,"endColumn":92,"fix":{"range":[21356,21429],"text":"[...new Set((orders || []).map((o) => o.user_id).filter(Boolean))]"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":4,"source":"import 'server-only'\r\n\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport { redirect } from \"@/i18n/routing\"\r\nimport { connection } from \"next/server\"\r\nimport { getLocale } from \"next-intl/server\"\r\n\r\nexport type AccountType = 'personal' | 'business'\r\n\r\n// Internal types for order management - must match OrdersTable component expectations\r\ninterface UserRecord {\n  id: string\n  full_name: string | null\n  email?: string | null\n}\n\r\ninterface OrderRecord {\r\n  id: string\r\n  status: string | null\r\n  created_at: string\r\n  shipping_address?: Record<string, unknown> | null\r\n  user_id: string\r\n  user?: UserRecord | null\r\n}\r\n\r\ninterface ProductRecord {\n  id: string\n  title: string\n  images: string[] | null\n  sku: string | null\n}\n\r\n// Tiers that have dashboard access (paid business plans)\r\n// starter = Business Starter (50╨╗╨▓), professional = Business Pro (100╨╗╨▓), enterprise = Business Enterprise (200╨╗╨▓)\r\nexport const DASHBOARD_ALLOWED_TIERS = ['starter', 'professional', 'enterprise'] as const\r\nexport type DashboardAllowedTier = typeof DASHBOARD_ALLOWED_TIERS[number]\r\n\r\n// Subscription status for active plans\r\nexport type SubscriptionStatus = 'active' | 'cancelled' | 'expired' | 'pending'\r\n\r\nexport interface BusinessSubscription {\r\n  id: string\r\n  seller_id: string\r\n  plan_type: string\r\n  status: SubscriptionStatus\r\n  expires_at: string\r\n  plan_name: string\r\n  plan_tier: string\r\n  account_type: AccountType\r\n  price_monthly: number\r\n  features: string[]\r\n}\r\n\r\nexport interface BusinessSeller {\r\n  id: string\r\n  email: string\r\n  store_name: string\r\n  account_type: AccountType\r\n  is_verified_business: boolean\r\n  business_name: string | null\r\n  tier: string\r\n  avatar_url: string | null\r\n}\r\n\r\nexport interface BusinessSellerWithSubscription extends BusinessSeller {\r\n  subscription: BusinessSubscription | null\r\n  hasDashboardAccess: boolean\r\n}\r\n\r\ntype VariantSummary = {\r\n  variantCount: number\r\n  variantStock: number\r\n}\r\n\r\nasync function getVariantSummaryByProductId(\r\n  supabase: Awaited<ReturnType<typeof createClient>>,\r\n  productIds: string[]\r\n): Promise<Map<string, VariantSummary>> {\r\n  if (productIds.length === 0) return new Map()\r\n\r\n  const { data, error } = await supabase\r\n    .from('product_variants')\r\n    .select('product_id, stock')\r\n    .in('product_id', productIds)\r\n\r\n  if (error || !data) return new Map()\r\n\r\n  const summary = new Map<string, VariantSummary>()\r\n  for (const row of data) {\r\n    const productId = row.product_id as string\r\n    const stock = Number(row.stock ?? 0)\r\n\r\n    const existing = summary.get(productId)\r\n    if (existing) {\r\n      existing.variantCount += 1\r\n      existing.variantStock += stock\r\n    } else {\r\n      summary.set(productId, { variantCount: 1, variantStock: stock })\r\n    }\r\n  }\r\n  return summary\r\n}\r\n\r\n/**\r\n * Verifies the current user is authenticated and has a business seller account.\r\n * MUST be called in server components only.\r\n * \r\n * @param redirectTo - Where to redirect non-business users (default: /account)\r\n * @returns The business seller if verified\r\n * @throws Redirects to login or account if not authorized\r\n */\r\nexport async function requireBusinessSeller(redirectTo: string = \"/account\"): Promise<BusinessSeller> {\r\n  const locale = await getLocale()\r\n  const supabase = await createClient()\r\n  \r\n  // Check if user is authenticated via Supabase auth\r\n  const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n  \r\n  if (authError || !user) {\r\n    // User not authenticated - redirect to login\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n  \r\n  const userId = user.id\r\n  const userEmail = user.email\r\n\r\n  // Check profile for account type and seller status\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select(`\r\n      id, \r\n      username,\r\n      display_name,\r\n      account_type, \r\n      is_verified_business, \r\n      business_name, \r\n      tier,\r\n      avatar_url,\r\n      is_seller\r\n    `)\r\n    .eq('id', userId)\r\n    .single()\r\n  \r\n  if (profileError || !profile) {\r\n    // No profile - redirect to login\r\n    return redirect({ href: \"/auth/login\", locale })\r\n  }\r\n  \r\n  if (profile.account_type !== 'business') {\r\n    // Personal account - redirect to regular account\r\n    return redirect({ href: redirectTo, locale })\r\n  }\r\n\r\n  // Must be an activated seller (completed seller onboarding) before accessing business seller routes.\r\n  // This prevents non-sellers who selected a business intent at signup from entering dashboard flows.\r\n  if (!profile.is_seller) {\r\n    return redirect({ href: \"/sell\", locale })\r\n  }\r\n  \r\n  return {\r\n    id: profile.id,\r\n    email: userEmail || '',\r\n    store_name: profile.display_name || profile.business_name || profile.username || 'Business',\r\n    account_type: profile.account_type as AccountType,\r\n    is_verified_business: profile.is_verified_business ?? false,\r\n    business_name: profile.business_name,\r\n    tier: profile.tier ?? 'free',\r\n    avatar_url: profile.avatar_url ?? null,\r\n  }\r\n}\r\n\r\n/**\r\n * Gets the active subscription for a seller.\r\n * Returns null if no active subscription exists.\r\n */\r\nexport async function getActiveSubscription(sellerId: string): Promise<BusinessSubscription | null> {\r\n  const supabase = await createClient()\r\n\r\n  const {\r\n    data: { user },\r\n  } = await supabase.auth.getUser()\r\n\r\n  if (!user || user.id !== sellerId) return null\r\n  \r\n  // First get the subscription\r\n  const { data: subscription } = await supabase\r\n    .from('subscriptions')\r\n    .select(`\r\n      id,\r\n      seller_id,\r\n      plan_type,\r\n      status,\r\n      expires_at\r\n    `)\r\n    .eq('seller_id', sellerId)\r\n    .eq('status', 'active')\r\n    .gt('expires_at', new Date().toISOString())\r\n    .order('created_at', { ascending: false })\r\n    .limit(1)\r\n    .single()\r\n  \r\n  if (!subscription) return null\r\n  \r\n  // Then get the matching plan details separately (no FK relation exists)\r\n  const { data: plan } = await supabase\r\n    .from('subscription_plans')\r\n    .select('name, tier, account_type, price_monthly, features')\r\n    .eq('tier', subscription.plan_type)\r\n    .eq('account_type', 'business')\r\n    .single()\r\n  \r\n  return {\r\n    id: subscription.id,\r\n    seller_id: subscription.seller_id,\r\n    plan_type: subscription.plan_type,\r\n    status: subscription.status as SubscriptionStatus,\r\n    expires_at: subscription.expires_at,\r\n    plan_name: plan?.name || 'Unknown',\r\n    plan_tier: plan?.tier || subscription.plan_type,\r\n    account_type: (plan?.account_type || 'business') as AccountType,\r\n    price_monthly: plan?.price_monthly || 0,\r\n    features: (plan?.features as string[]) || [],\r\n  }\r\n}\r\n\r\n/**\r\n * Checks if a seller has dashboard access (paid business subscription).\r\n * Dashboard access requires:\r\n * 1. Business account type\r\n * 2. Active subscription with starter, professional or enterprise tier\r\n */\r\nexport function hasDashboardAccess(tier: string, subscription: BusinessSubscription | null): boolean {\r\n  // Free tier business accounts don't get dashboard access\r\n  if (tier === 'free') return false\r\n  \r\n  // Must have an allowed tier (starter, professional, enterprise)\r\n  if (!DASHBOARD_ALLOWED_TIERS.includes(tier as DashboardAllowedTier)) {\r\n    return false\r\n  }\r\n  \r\n  // Must have active subscription \r\n  // (getActiveSubscription already filters for status='active' and expires_at > now)\r\n  if (!subscription) {\r\n    return false\r\n  }\r\n  \r\n  return true\r\n}\r\n\r\n/**\r\n * Verifies the current user has business account AND active paid subscription.\r\n * Used for dashboard routes that require subscription.\r\n * \r\n * @param upgradeRedirect - Where to redirect users without subscription (default: /dashboard/upgrade)\r\n * @returns The business seller with subscription info\r\n * @throws Redirects to upgrade page if no active paid subscription\r\n */\r\nexport async function requireDashboardAccess(\r\n  upgradeRedirect: string = \"/dashboard/upgrade\"\r\n): Promise<BusinessSellerWithSubscription> {\r\n  await connection()\r\n  const locale = await getLocale()\r\n  \r\n  // First verify they have a business account\r\n  const seller = await requireBusinessSeller(\"/account\")\r\n  \r\n  // Then check their subscription status\r\n  const subscription = await getActiveSubscription(seller.id)\r\n  const hasAccess = hasDashboardAccess(seller.tier, subscription)\r\n  \r\n  if (!hasAccess) {\r\n    // No paid subscription - redirect to upgrade page\r\n    redirect({ href: upgradeRedirect, locale })\r\n  }\r\n  \r\n  return {\r\n    ...seller,\r\n    subscription,\r\n    hasDashboardAccess: true,\r\n  }\r\n}\r\n\r\n/**\r\n * Gets business seller info with subscription status (no redirect).\r\n * Useful for checking subscription status without forcing redirect.\r\n */\r\nasync function getBusinessSellerWithSubscription(\r\n  sellerId: string\r\n): Promise<BusinessSellerWithSubscription | null> {\r\n  await connection()\r\n\r\n  const supabase = await createClient()\r\n\r\n  const {\r\n    data: { user },\r\n  } = await supabase.auth.getUser()\r\n\r\n  if (!user || user.id !== sellerId) return null\r\n  \r\n  const { data: profile } = await supabase\n    .from('profiles')\n    .select(\n      'id, username, display_name, account_type, is_verified_business, business_name, tier, avatar_url'\n    )\n    .eq('id', sellerId)\n    .single()\n  \r\n  if (!profile || profile.account_type !== 'business') {\r\n    return null\r\n  }\r\n\r\n  const subscription = await getActiveSubscription(sellerId)\r\n  const hasAccess = hasDashboardAccess(profile.tier ?? 'free', subscription)\r\n\r\n  return {\n    id: profile.id,\n    email: user.email || '',\n    store_name: profile.display_name || profile.business_name || profile.username || 'Business',\n    account_type: profile.account_type as AccountType,\n    is_verified_business: profile.is_verified_business ?? false,\n    business_name: profile.business_name,\n    tier: profile.tier ?? 'free',\n    avatar_url: profile.avatar_url ?? null,\r\n    subscription,\r\n    hasDashboardAccess: hasAccess,\r\n  }\r\n}\r\n\r\n/**\r\n * Checks if current user has a business account without redirecting.\r\n * Useful for conditional UI rendering.\r\n */\r\nasync function isBusinessAccount(): Promise<boolean> {\r\n  try {\r\n    const supabase = await createClient()\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    \r\n    if (!user) return false\r\n    \r\n    const { data: profile } = await supabase\r\n      .from('profiles')\r\n      .select('account_type')\r\n      .eq('id', user.id)\r\n      .single()\r\n    \r\n    return profile?.account_type === 'business'\r\n  } catch {\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Gets the current user's seller info including account type.\r\n * Returns null if user is not a seller.\r\n */\r\nasync function getSellerInfo() {\r\n  try {\r\n    const supabase = await createClient()\r\n    const { data: { user } } = await supabase.auth.getUser()\r\n    \r\n    if (!user) return null\r\n    \r\n    const { data: profile } = await supabase\r\n      .from('profiles')\r\n      .select(`\r\n        id, \r\n        username,\r\n        display_name,\r\n        account_type, \r\n        is_verified_business, \r\n        business_name, \r\n        tier,\r\n        avatar_url,\r\n        is_seller\r\n      `)\r\n      .eq('id', user.id)\r\n      .single()\r\n    \r\n    if (!profile) return null\r\n    \r\n    return {\r\n      id: profile.id,\r\n      store_name: profile.display_name || profile.business_name || profile.username || 'Seller',\r\n      account_type: profile.account_type,\r\n      is_verified_business: profile.is_verified_business,\r\n      business_name: profile.business_name,\r\n      tier: profile.tier,\r\n      avatar_url: profile.avatar_url,\r\n      is_seller: profile.is_seller,\r\n    }\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\n/**\r\n * Gets business dashboard statistics for a seller\r\n * Uses the seller's ID to fetch their specific data\r\n */\r\nexport async function getBusinessDashboardStats(sellerId: string) {\r\n  // Mark as dynamic and satisfy Next.js current-time access rules.\r\n  await connection()\r\n  \r\n  const supabase = await createClient()\r\n  \r\n  const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString()\r\n  \r\n  // Total products\r\n  const productsResult = await supabase\r\n    .from('products')\r\n    .select('id', { count: 'exact', head: true })\r\n    .eq('seller_id', sellerId)\r\n\r\n  // Total orders (as seller) - last 30 days\r\n  const ordersResult = await supabase\r\n    .from('order_items')\r\n    .select('id, quantity, price_at_purchase', { count: 'exact' })\r\n    .eq('seller_id', sellerId)\r\n\r\n  // Recent orders (last 7 days) - no joins\r\n  const { data: recentOrderItems } = await supabase\r\n    .from('order_items')\r\n    .select('id, quantity, price_at_purchase, order_id, product_id')\r\n    .eq('seller_id', sellerId)\r\n    .limit(10)\r\n\r\n  // Fetch related products and orders for recent orders\r\n  const productIds = recentOrderItems?.map(i => i.product_id).filter(Boolean) || []\r\n  const orderIds = recentOrderItems?.map(i => i.order_id).filter(Boolean) || []\r\n  const [{ data: products = [] }, { data: orders = [] }] = await Promise.all([\r\n    productIds.length ? supabase.from('products').select('id, title, images').in('id', productIds) : Promise.resolve({ data: [] }),\r\n    orderIds.length ? supabase.from('orders').select('id, created_at').in('id', orderIds) : Promise.resolve({ data: [] })\r\n  ])\r\n  const productsMap = new Map((products || []).map(p => [p.id, p]))\r\n  const ordersMap = new Map((orders || []).map(o => [o.id, o]))\r\n  const recentOrders = (recentOrderItems || []).map(item => ({\r\n    ...item,\r\n    product: productsMap.get(item.product_id) || null,\r\n    order: ordersMap.get(item.order_id) || null,\r\n  }))\r\n\r\n  // Recent products (last 7 days)\r\n  const recentProductsResult = await supabase\r\n    .from('products')\r\n    .select('id, title, price, created_at, images, status')\r\n    .eq('seller_id', sellerId)\r\n    .gte('created_at', sevenDaysAgo)\r\n    .order('created_at', { ascending: false })\r\n    .limit(10)\r\n\r\n  // Seller stats (rating, reviews, sales)\r\n  const sellerStatsResult = await supabase\r\n    .from('seller_stats')\r\n    .select('average_rating, total_reviews, total_sales')\r\n    .eq('seller_id', sellerId)\r\n    .single()\r\n\r\n  // Products count for views approximation\r\n  const viewsResult = await supabase\r\n    .from('products')\r\n    .select('id', { count: 'exact', head: true })\r\n    .eq('seller_id', sellerId)\r\n  \r\n  // Calculate revenue from orders\r\n  const revenue = ordersResult.data?.reduce((sum, item) => \r\n    sum + (Number((item as { price_at_purchase: number }).price_at_purchase) * (item as { quantity: number }).quantity), 0) || 0\r\n  \r\n  // Calculate total views (approximation - views column doesn't exist yet)\r\n  const totalViews = (viewsResult.count || 0) * 10\r\n\r\n  const liveActivity = {\r\n    currentVisitors: 0,\r\n    recentViews: Math.floor(totalViews * 0.01),\r\n    cartAdds: 0,\r\n  }\r\n  \r\n  return {\r\n    totals: {\r\n      products: productsResult.count || 0,\r\n      orders: ordersResult.count || 0,\r\n      revenue,\r\n      views: totalViews,\r\n      rating: Number(sellerStatsResult.data?.average_rating) || 0,\r\n      totalReviews: sellerStatsResult.data?.total_reviews || 0,\r\n      totalSales: sellerStatsResult.data?.total_sales || 0,\r\n    },\r\n    recent: {\r\n      orders: recentOrders,\r\n      products: recentProductsResult.data || [],\r\n    },\r\n    liveActivity,\r\n  }\r\n}\r\n\r\n/**\r\n * Gets products for the business dashboard with pagination and filters\r\n */\r\nexport async function getBusinessProducts(\r\n  sellerId: string,\r\n  options: {\r\n    page?: number\r\n    limit?: number\r\n    status?: string\r\n    search?: string\r\n    category?: string\r\n    sortBy?: string\r\n    sortOrder?: 'asc' | 'desc'\r\n  } = {}\r\n) {\r\n  await connection()\r\n  \r\n  const supabase = await createClient()\r\n  \r\n  const {\r\n    page = 1,\r\n    limit = 50,\r\n    status,\r\n    search,\r\n    category,\r\n    sortBy = 'created_at',\r\n    sortOrder = 'desc'\r\n  } = options\r\n  \r\n  let query = supabase\n    .from('products')\n    .select(`\n      id,\n      title,\n      price,\n      list_price,\n      stock,\n      track_inventory,\n      status,\n      weight,\n      weight_unit,\n      condition,\n      images,\n      rating,\n      review_count,\n      created_at,\n      updated_at,\n      category_id\n    `, { count: 'exact' })\n    .eq('seller_id', sellerId)\n\n  // Apply filters\n  if (status && status !== 'all') {\n    query = query.eq('status', status)\n  }\n\n  if (search) {\n    const term = search.trim()\n    if (term) {\n      const [titleMatches, privateMatches] = await Promise.all([\n        supabase\n          .from('products')\n          .select('id')\n          .eq('seller_id', sellerId)\n          .ilike('title', `%${term}%`),\n        supabase\n          .from('product_private')\n          .select('product_id')\n          .eq('seller_id', sellerId)\n          .or(`sku.ilike.%${term}%,barcode.ilike.%${term}%`),\n      ])\n\n      const ids = new Set<string>()\n      for (const row of (titleMatches.data || []) as Array<{ id: string }>) ids.add(row.id)\n      for (const row of (privateMatches.data || []) as Array<{ product_id: string }>) ids.add(row.product_id)\n\n      const matchedIds = Array.from(ids)\n      if (matchedIds.length === 0) {\n        return { products: [], total: 0, page, limit, totalPages: 0, error: null }\n      }\n\n      query = query.in('id', matchedIds)\n    }\n  }\n  \r\n  if (category) {\r\n    query = query.eq('category_id', category)\r\n  }\r\n  \r\n  // Apply sorting and pagination\n  query = query\n    .order(sortBy, { ascending: sortOrder === 'asc' })\n    .range((page - 1) * limit, page * limit - 1)\n\n  const { data, count, error } = await query\n\n  const productIds = (data || []).map((p) => p.id)\n  const privateRows = productIds.length\n    ? (await supabase\n        .from('product_private')\n        .select('product_id, cost_price, sku, barcode')\n        .eq('seller_id', sellerId)\n        .in('product_id', productIds)).data\n    : []\n  const privateMap = new Map(\n    (privateRows || []).map((r) => [r.product_id as string, r as unknown as { cost_price: number | null; sku: string | null; barcode: string | null }])\n  )\n  const variantsSummary = await getVariantSummaryByProductId(supabase, productIds)\n\r\n  // Fetch categories for products\r\n  const categoryIds = (data || []).map(p => p.category_id).filter((id): id is string => id !== null)\r\n  let categories: { id: string; name: string; slug: string }[] = []\r\n  if (categoryIds.length) {\r\n    const { data: cats } = await supabase.from('categories').select('id, name, slug').in('id', categoryIds)\r\n    categories = cats || []\r\n  }\r\n  const categoriesMap = new Map(categories.map(c => [c.id, c]))\n  const productsWithCategories = (data || []).map(p => ({\n    ...p,\n    cost_price: privateMap.get(p.id)?.cost_price ?? null,\n    sku: privateMap.get(p.id)?.sku ?? null,\n    barcode: privateMap.get(p.id)?.barcode ?? null,\n    stock: (() => {\n      const summary = variantsSummary.get(p.id)\n      return summary && summary.variantStock > 0 ? summary.variantStock : p.stock\n    })(),\n    variant_count: variantsSummary.get(p.id)?.variantCount ?? 0,\n    category: p.category_id ? categoriesMap.get(p.category_id) ?? null : null,\r\n  }))\r\n\r\n  return {\r\n    products: productsWithCategories,\r\n    total: count || 0,\r\n    page,\r\n    limit,\r\n    totalPages: Math.ceil((count || 0) / limit),\r\n    error,\r\n  }\r\n}\r\n\r\n/**\r\n * Gets orders for the business dashboard\r\n */\r\nexport async function getBusinessOrders(\r\n  sellerId: string,\r\n  options: {\r\n    page?: number\r\n    limit?: number\r\n    status?: string\r\n    search?: string\r\n    dateFrom?: string\r\n    dateTo?: string\r\n  } = {}\r\n) {\r\n  await connection()\r\n  \r\n  const supabase = await createClient()\r\n  \r\n  const {\r\n    page = 1,\r\n    limit = 50,\r\n    // status,\r\n    // search,\r\n    // dateFrom,\r\n    // dateTo,\r\n  } = options\r\n  \r\n  let query = supabase\r\n    .from('order_items')\r\n    .select('id, quantity, price_at_purchase, order_id, product_id, seller_id', { count: 'exact' })\r\n    .eq('seller_id', sellerId)\r\n  \r\n  // Apply filters (only on order_items fields)\r\n  // (If you want to filter by order status, do it after fetching orders below)\r\n  // (If you want to filter by product title, do it after fetching products below)\r\n\r\n  // Apply sorting and pagination\r\n  query = query\r\n    .range((page - 1) * limit, page * limit - 1)\r\n\r\n  const { data, count, error } = await query\r\n\r\n  // Fetch related orders and products\r\n  const orderIds = Array.from(new Set((data || []).map((i) => i.order_id).filter(Boolean)))\r\n  const productIds = Array.from(new Set((data || []).map((i) => i.product_id).filter(Boolean)))\r\n  let orders: OrderRecord[] = []\n  let products: ProductRecord[] = []\n  if (orderIds.length) {\n    const { data: o } = await supabase.from('orders').select('id, status, created_at, user_id, shipping_address').in('id', orderIds)\n    orders = (o || []) as OrderRecord[]\n  }\n  if (productIds.length) {\n    const { data: p } = await supabase.from('products').select('id, title, images').in('id', productIds)\n    const { data: privateRows } = await supabase\n      .from('product_private')\n      .select('product_id, sku')\n      .eq('seller_id', sellerId)\n      .in('product_id', productIds)\n\n    const privateSku = new Map((privateRows || []).map((r) => [r.product_id as string, r.sku as string | null]))\n\n    products = ((p || []) as Array<Omit<ProductRecord, 'sku'> & { sku?: string | null }>).map((row) => ({\n      ...row,\n      sku: privateSku.get(row.id) ?? null,\n    }))\n  }\n  // Fetch users for orders\n  const userIds = Array.from(new Set((orders || []).map((o) => o.user_id).filter(Boolean)))\n  let users: UserRecord[] = []\n  if (userIds.length) {\n    const { data: u } = await supabase.from('profiles').select('id, full_name').in('id', userIds)\n    users = (u || []) as UserRecord[]\n  }\n  const ordersMap = new Map(orders.map(o => [o.id, o]))\r\n  const productsMap = new Map(products.map(p => [p.id, p]))\r\n  const usersMap = new Map(users.map(u => [u.id, u]))\n  // Compose final orders array - include user inside order object for component compatibility\n  const ordersWithDetails = (data || []).map(item => {\n    const orderBase = ordersMap.get(item.order_id)\n    const product = productsMap.get(item.product_id) || null\n    const shippingAddressRaw = orderBase?.shipping_address as unknown\n    const shippingAddress =\n      shippingAddressRaw && typeof shippingAddressRaw === 'object' && !Array.isArray(shippingAddressRaw)\n        ? (shippingAddressRaw as Record<string, unknown>)\n        : null\n\n    const email = typeof shippingAddress?.email === 'string' ? shippingAddress.email : null\n\n    const baseUser = orderBase ? usersMap.get(orderBase.user_id) || null : null\n    const user = orderBase\n      ? {\n          id: orderBase.user_id,\n          full_name: baseUser?.full_name ?? null,\n          email,\n        }\n      : null\n    // Nest user inside order for component compatibility\n    const order = orderBase ? { ...orderBase, shipping_address: shippingAddress, user } : null\n    return {\n      ...item,\n      order,\n      product,\n      user,\n    }\r\n  })\r\n\r\n  return {\r\n    orders: ordersWithDetails,\r\n    total: count || 0,\r\n    page,\r\n    limit,\r\n    totalPages: Math.ceil((count || 0) / limit),\r\n    error,\r\n  }\r\n}\r\n\r\n/**\r\n * Gets inventory data for stock management\r\n */\r\nexport async function getBusinessInventory(\r\n  sellerId: string,\r\n  options: {\r\n    page?: number\r\n    limit?: number\r\n    stockLevel?: 'all' | 'low' | 'out' | 'in'\r\n  } = {}\r\n) {\r\n  await connection()\r\n  \r\n  const supabase = await createClient()\r\n  \r\n  const { page = 1, limit = 50, stockLevel = 'all' } = options\r\n  \r\n  let query = supabase\n    .from('products')\n    .select(`\n      id,\n      title,\n      stock,\n      images,\n      price,\n      status\n    `, { count: 'exact' })\n    .eq('seller_id', sellerId)\n  \r\n  // Apply stock level filter\r\n  if (stockLevel === 'low') {\r\n    query = query.gt('stock', 0).lte('stock', 10)\r\n  } else if (stockLevel === 'out') {\r\n    query = query.eq('stock', 0)\r\n  } else if (stockLevel === 'in') {\r\n    query = query.gt('stock', 10)\r\n  }\r\n  \r\n  query = query\n    .order('stock', { ascending: true })\n    .range((page - 1) * limit, page * limit - 1)\n\n  const { data, count, error } = await query\n\n  const productIds = (data || []).map((p) => p.id)\n  const privateRows = productIds.length\n    ? (await supabase\n        .from('product_private')\n        .select('product_id, sku')\n        .eq('seller_id', sellerId)\n        .in('product_id', productIds)).data\n    : []\n  const privateSku = new Map((privateRows || []).map((r) => [r.product_id as string, r.sku as string | null]))\n  const variantsSummary = await getVariantSummaryByProductId(supabase, productIds)\n\n  const products = (data || []).map((p) => {\n    const summary = variantsSummary.get(p.id)\n    const totalStock = summary && summary.variantStock > 0 ? summary.variantStock : p.stock\n    return {\n      ...p,\n      sku: privateSku.get(p.id) ?? null,\n      stock: totalStock,\n      variant_count: summary?.variantCount ?? 0,\n    }\n  })\n  \r\n  // Get stock summary\r\n  const { data: stockBaseRows } = await supabase\r\n    .from('products')\r\n    .select('id, stock')\r\n    .eq('seller_id', sellerId)\r\n\r\n  const baseProductIds = (stockBaseRows || []).map((p) => p.id)\r\n  const allVariantsSummary = await getVariantSummaryByProductId(supabase, baseProductIds)\r\n\r\n  const computedStocks = (stockBaseRows || []).map((p) => {\r\n    const summary = allVariantsSummary.get(p.id)\r\n    return summary && summary.variantStock > 0 ? summary.variantStock : (p.stock || 0)\r\n  })\r\n\r\n  const totalStock = computedStocks.reduce((sum, s) => sum + s, 0)\r\n  const lowStockCount = computedStocks.filter((s) => s > 0 && s <= 10).length\r\n  const outOfStockCount = computedStocks.filter((s) => s === 0).length\r\n  \r\n  return {\r\n    products,\r\n    total: count || 0,\r\n    page,\r\n    limit,\r\n    totalPages: Math.ceil((count || 0) / limit),\r\n    summary: {\r\n      totalStock,\r\n      lowStockCount,\r\n      outOfStockCount,\r\n      totalProducts: stockBaseRows?.length || 0,\r\n    },\r\n    error,\r\n  }\r\n}\r\n\r\n/**\r\n * Gets counts for pending tasks shown on dashboard\r\n */\r\nexport async function getPendingTasksCount(sellerId: string) {\r\n  await connection()\r\n  \r\n  const supabase = await createClient()\r\n  \r\n  // Get date 7 days ago for \"recent\" reviews\r\n  const sevenDaysAgo = new Date()\r\n  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7)\r\n  \r\n  const [unfulfilledResult, lowStockResult, recentReviewsResult] = await Promise.all([\r\n    // Count unfulfilled orders (pending status)\r\n    supabase\r\n      .from('order_items')\r\n      .select('id', { count: 'exact', head: true })\r\n      .eq('seller_id', sellerId)\r\n      .in('order.status', ['pending', 'paid']),\r\n    \r\n    // Count low stock products\r\n    supabase\r\n      .from('products')\r\n      .select('id', { count: 'exact', head: true })\r\n      .eq('seller_id', sellerId)\r\n      .gt('stock', 0)\r\n      .lte('stock', 10),\r\n    \r\n    // Count recent reviews on seller's products (last 7 days)\r\n    supabase\r\n      .from('reviews')\r\n      .select('id, products!inner(seller_id)', { count: 'exact', head: true })\r\n      .eq('products.seller_id', sellerId)\r\n      .gte('created_at', sevenDaysAgo.toISOString()),\r\n  ])\r\n  \r\n  return {\r\n    unfulfilled: unfulfilledResult.count || 0,\r\n    lowStock: lowStockResult.count || 0,\r\n    recentReviews: recentReviewsResult.count || 0,\r\n  }\r\n}\r\n\r\n/**\r\n * Gets setup progress for the onboarding checklist\r\n * Returns which setup steps have been completed\r\n */\r\nexport async function getSetupProgress(sellerId: string) {\r\n  await connection()\r\n  \r\n  const supabase = await createClient()\r\n  \r\n  const [profileResult, productsResult, shippingResult, payoutResult] = await Promise.all([\r\n    // Get profile details for setup completion\r\n    supabase\r\n      .from('profiles')\r\n      .select('bio, avatar_url, username')\r\n      .eq('id', sellerId)\r\n      .single(),\r\n    \r\n    // Check if seller has any products\r\n    supabase\r\n      .from('products')\r\n      .select('id', { count: 'exact', head: true })\r\n      .eq('seller_id', sellerId)\r\n      .limit(1),\r\n\r\n    // Check if seller has configured shipping settings\r\n    supabase\r\n      .from('seller_shipping_settings')\r\n      .select('is_configured')\r\n      .eq('seller_id', sellerId)\r\n      .maybeSingle(),\r\n\r\n    // Check seller payout status (Stripe Connect)\r\n    supabase\r\n      .from('seller_payout_status')\r\n      .select('details_submitted, charges_enabled, payouts_enabled')\r\n      .eq('seller_id', sellerId)\r\n      .maybeSingle(),\r\n  ])\r\n  \r\n  const profile = profileResult.data\r\n\r\n  const hasShippingSetup = !shippingResult.error && Boolean(shippingResult.data?.is_configured)\r\n  const payout = payoutResult.error ? null : payoutResult.data\r\n  const hasPaymentSetup = Boolean(payout?.details_submitted && payout?.charges_enabled && payout?.payouts_enabled)\r\n  \r\n  return {\r\n    hasProducts: (productsResult.count || 0) > 0,\r\n    hasDescription: Boolean(profile?.bio && profile.bio.length > 10),\r\n    hasLogo: Boolean(profile?.avatar_url),\r\n    hasUsername: Boolean(profile?.username),\r\n    hasShippingSetup,\r\n    hasPaymentSetup,\r\n  }\r\n}\r\n\r\n/**\r\n * Gets customers data for the customers page\r\n */\r\nexport async function getBusinessCustomers(\r\n  sellerId: string,\r\n  options: {\r\n    page?: number\r\n    limit?: number\r\n    search?: string\r\n    sortBy?: string\r\n    sortOrder?: 'asc' | 'desc'\r\n  } = {}\r\n) {\r\n  await connection()\r\n  \r\n  const supabase = await createClient()\r\n  \r\n  const {\r\n    page = 1,\r\n    limit = 50,\r\n    search,\r\n    sortBy = 'total_spent',\r\n    sortOrder = 'desc'\r\n  } = options\r\n  \r\n  // Get unique customers who have ordered from this seller\r\n  // This aggregates order data by customer\r\n  const { data: orderItems } = await supabase\n    .from('order_items')\n    .select(`\n      quantity,\n      price_at_purchase,\n      order:orders!inner(\n        user_id,\n        created_at,\n        user:profiles(id, full_name, avatar_url, created_at)\n      )\n    `)\n    .eq('seller_id', sellerId)\n  \r\n  if (!orderItems) {\r\n    return { customers: [], total: 0 }\r\n  }\r\n  \r\n  // Aggregate by customer\n  const customerMap = new Map<string, {\n    id: string\n    full_name: string | null\n    avatar_url: string | null\n    total_orders: number\n    total_spent: number\n    first_order: string\r\n    last_order: string\r\n  }>()\r\n  \r\n  for (const item of orderItems as unknown as Array<{\n    quantity: number\n    price_at_purchase: number\n    order: { user_id: string; created_at: string; user: { id: string; full_name: string | null; avatar_url: string | null; created_at: string } | null }\n  }>) {\n    const order = item.order\r\n    if (!order?.user) continue\r\n    \r\n    const user = order.user\r\n    if (!user?.id) continue\r\n    \r\n    const existing = customerMap.get(user.id)\r\n    const orderTotal = Number(item.price_at_purchase) * item.quantity\r\n    const orderDate = order.created_at\r\n    \r\n    if (existing) {\r\n      existing.total_orders += 1\r\n      existing.total_spent += orderTotal\r\n      if (orderDate > existing.last_order) {\r\n        existing.last_order = orderDate\r\n      }\r\n      if (orderDate < existing.first_order) {\r\n        existing.first_order = orderDate\r\n      }\r\n    } else {\n      customerMap.set(user.id, {\n        id: user.id,\n        full_name: user.full_name,\n        avatar_url: user.avatar_url,\n        total_orders: 1,\n        total_spent: orderTotal,\n        first_order: orderDate,\r\n        last_order: orderDate,\r\n      })\r\n    }\r\n  }\r\n  \r\n  let customers = [...customerMap.values()]\r\n  \r\n  // Apply search filter\n  if (search) {\n    const query = search.toLowerCase()\n    customers = customers.filter(c => \n      c.full_name?.toLowerCase().includes(query)\n    )\n  }\n  \r\n  // Sort\r\n  customers.sort((a, b) => {\r\n    let comparison = 0\r\n    switch (sortBy) {\r\n      case 'total_spent':\r\n        comparison = a.total_spent - b.total_spent\r\n        break\r\n      case 'total_orders':\r\n        comparison = a.total_orders - b.total_orders\r\n        break\r\n      case 'last_order':\r\n        comparison = new Date(a.last_order).getTime() - new Date(b.last_order).getTime()\r\n        break\r\n      default:\r\n        comparison = (a.full_name || '').localeCompare(b.full_name || '')\r\n    }\r\n    return sortOrder === 'asc' ? comparison : -comparison\r\n  })\r\n  \r\n  const total = customers.length\r\n  const paginatedCustomers = customers.slice((page - 1) * limit, page * limit)\r\n  \r\n  return {\r\n    customers: paginatedCustomers,\r\n    total,\r\n    page,\r\n    limit,\r\n    totalPages: Math.ceil(total / limit),\r\n  }\r\n}\r\n\r\n/**\r\n * Calculate performance score from stats (server-safe version)\r\n */\r\nexport function calculatePerformanceScoreServer(stats: {\r\n  orders: number\r\n  products: number\r\n  views: number\r\n  rating: number\r\n  revenue: number\r\n}) {\r\n  const metrics = [\r\n    {\r\n      id: \"conversion\",\r\n      label: \"Conversion Rate\",\r\n      value: stats.orders > 0 && stats.views > 0 \r\n        ? Number(((stats.orders / stats.views) * 100).toFixed(1))\r\n        : 0,\r\n      target: 3,\r\n      unit: \"%\",\r\n      trend: \"up\" as const,\r\n      trendValue: 12,\r\n      description: \"Percentage of visitors who made a purchase\",\r\n    },\r\n    {\r\n      id: \"rating\",\r\n      label: \"Customer Rating\",\r\n      value: stats.rating || 0,\r\n      target: 5,\r\n      trend: \"neutral\" as const,\r\n      description: \"Average rating from customer reviews\",\r\n    },\r\n    {\r\n      id: \"listings\",\r\n      label: \"Active Listings\",\r\n      value: stats.products,\r\n      target: 20,\r\n      trend: \"up\" as const,\r\n      trendValue: 5,\r\n      description: \"Number of products listed in your store\",\r\n    },\r\n    {\r\n      id: \"orders\",\r\n      label: \"Orders (30d)\",\r\n      value: stats.orders,\r\n      target: 50,\r\n      trend: stats.orders > 10 ? \"up\" as const : \"neutral\" as const,\r\n      trendValue: stats.orders > 10 ? 8 : 0,\r\n      description: \"Number of orders in the last 30 days\",\r\n    },\r\n  ]\r\n  \r\n  // Calculate overall score (weighted average)\r\n  const weights: Record<string, number> = { conversion: 30, rating: 25, listings: 20, orders: 25 }\r\n  let totalScore = 0\r\n  \r\n  for (const metric of metrics) {\r\n    const progress = Math.min((metric.value / metric.target) * 100, 100)\r\n    const weight = weights[metric.id] || 25\r\n    totalScore += (progress * weight) / 100\r\n  }\r\n  \r\n  return {\r\n    overallScore: Math.round(totalScore),\r\n    metrics,\r\n  }\r\n}\r\n\r\ntype ActivityType = \"order\" | \"product\" | \"review\" | \"customer\" | \"milestone\"\r\n\r\ninterface ActivityItem {\r\n  id: string\r\n  type: ActivityType\r\n  title: string\r\n  description: string\r\n  timestamp: string\r\n  href?: string\r\n  meta?: {\r\n    amount?: number\r\n    status?: string\r\n    image?: string\r\n    rating?: number\r\n  }\r\n}\r\n\r\n/**\r\n * Transform orders/products into activity items (server-safe version)\r\n */\r\nexport function transformToActivityItemsServer(\r\n  orders: Array<{\r\n    id: string\r\n    quantity: number\r\n    price_at_purchase: number\r\n    product?: { title: string; images?: string[] | null } | { title: string; images?: string[] | null }[] | null\r\n    order?: { id: string; created_at: string } | null\r\n  }>,\r\n  products: Array<{\r\n    id: string\r\n    title: string\r\n    created_at: string\r\n    images?: string[] | null\r\n    status?: string | null\r\n  }>\r\n): ActivityItem[] {\r\n  const activities: ActivityItem[] = []\r\n  \r\n  // Transform orders\r\n  for (const orderItem of orders) {\r\n    const product = Array.isArray(orderItem.product) ? orderItem.product[0] : orderItem.product\r\n    // Use created_at from order relation, fallback to now\r\n    const timestamp = orderItem.order?.created_at ?? new Date().toISOString()\r\n    activities.push({\r\n      id: `order-${orderItem.id}`,\r\n      type: \"order\",\r\n      title: \"New order received\",\r\n      description: product?.title || \"Order item\",\r\n      timestamp,\r\n      href: `/dashboard/orders/${orderItem.order?.id ?? orderItem.id}`,\r\n      meta: {\r\n        amount: Number(orderItem.price_at_purchase) * orderItem.quantity,\r\n        status: \"Unfulfilled\",\r\n        ...(product?.images?.[0] ? { image: product.images[0] } : {}),\r\n      },\r\n    })\r\n  }\r\n  \r\n  // Transform products\r\n  for (const product of products) {\r\n    activities.push({\r\n      id: `product-${product.id}`,\r\n      type: \"product\",\r\n      title: \"Product listed\",\r\n      description: product.title,\r\n      timestamp: product.created_at,\r\n      href: `/dashboard/products/${product.id}`,\r\n      meta: {\r\n        status: product.status || \"Active\",\r\n        ...(product.images?.[0] ? { image: product.images[0] } : {}),\r\n      },\r\n    })\r\n  }\r\n  \r\n  // Sort by timestamp (newest first)\r\n  activities.sort((a, b) => \r\n    new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()\r\n  )\r\n  \r\n  return activities.slice(0, 10)\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\auth\\require-auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\auth\\server-actions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\avatar-palettes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\badges\\category-badge-specs.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\boost\\boost-status.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\bulgarian-cities.ts","messages":[{"ruleId":"sonarjs/no-duplicate-string","severity":1,"message":"Define a constant instead of duplicating this literal 9 times.","line":22,"column":69,"nodeType":"Literal","endLine":22,"endColumn":84}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Bulgarian Cities List\r\n * Used for seller location in listings and user profiles\r\n * \r\n * Major cities ordered by population, plus \"Other\" option\r\n */\r\n\r\ninterface BulgarianCity {\r\n  value: string;\r\n  label: string;\r\n  labelBg: string;\r\n  region: string | null;\r\n  population?: number; // For sorting reference\r\n}\r\n\r\n/**\r\n * Major Bulgarian cities - top 20 by population plus \"Other\"\r\n * Cities are ordered by population for better UX (most likely choices first)\r\n */\r\nexport const BULGARIAN_CITIES: readonly BulgarianCity[] = [\r\n  { value: \"sofia\", label: \"Sofia\", labelBg: \"╨í╨╛╤ä╨╕╤Å\", region: \"Sofia City\", population: 1307000 },\r\n  { value: \"plovdiv\", label: \"Plovdiv\", labelBg: \"╨ƒ╨╗╨╛╨▓╨┤╨╕╨▓\", region: \"South Central\", population: 346000 },\r\n  { value: \"varna\", label: \"Varna\", labelBg: \"╨Æ╨░╤Ç╨╜╨░\", region: \"Northeast\", population: 336000 },\r\n  { value: \"burgas\", label: \"Burgas\", labelBg: \"╨æ╤â╤Ç╨│╨░╤ü\", region: \"Southeast\", population: 211000 },\r\n  { value: \"ruse\", label: \"Ruse\", labelBg: \"╨á╤â╤ü╨╡\", region: \"North Central\", population: 144000 },\r\n  { value: \"stara-zagora\", label: \"Stara Zagora\", labelBg: \"╨í╤é╨░╤Ç╨░ ╨ù╨░╨│╨╛╤Ç╨░\", region: \"South Central\", population: 137000 },\r\n  { value: \"pleven\", label: \"Pleven\", labelBg: \"╨ƒ╨╗╨╡╨▓╨╡╨╜\", region: \"Northwest\", population: 101000 },\r\n  { value: \"sliven\", label: \"Sliven\", labelBg: \"╨í╨╗╨╕╨▓╨╡╨╜\", region: \"Southeast\", population: 89000 },\r\n  { value: \"dobrich\", label: \"Dobrich\", labelBg: \"╨ö╨╛╨▒╤Ç╨╕╤ç\", region: \"Northeast\", population: 86000 },\r\n  { value: \"shumen\", label: \"Shumen\", labelBg: \"╨¿╤â╨╝╨╡╨╜\", region: \"Northeast\", population: 82000 },\r\n  { value: \"pernik\", label: \"Pernik\", labelBg: \"╨ƒ╨╡╤Ç╨╜╨╕╨║\", region: \"Southwest\", population: 76000 },\r\n  { value: \"haskovo\", label: \"Haskovo\", labelBg: \"╨Ñ╨░╤ü╨║╨╛╨▓╨╛\", region: \"South Central\", population: 73000 },\r\n  { value: \"yambol\", label: \"Yambol\", labelBg: \"╨»╨╝╨▒╨╛╨╗\", region: \"Southeast\", population: 70000 },\r\n  { value: \"pazardzhik\", label: \"Pazardzhik\", labelBg: \"╨ƒ╨░╨╖╨░╤Ç╨┤╨╢╨╕╨║\", region: \"South Central\", population: 68000 },\r\n  { value: \"blagoevgrad\", label: \"Blagoevgrad\", labelBg: \"╨æ╨╗╨░╨│╨╛╨╡╨▓╨│╤Ç╨░╨┤\", region: \"Southwest\", population: 67000 },\r\n  { value: \"veliko-tarnovo\", label: \"Veliko Tarnovo\", labelBg: \"╨Æ╨╡╨╗╨╕╨║╨╛ ╨ó╤è╤Ç╨╜╨╛╨▓╨╛\", region: \"North Central\", population: 66000 },\r\n  { value: \"vratsa\", label: \"Vratsa\", labelBg: \"╨Æ╤Ç╨░╤å╨░\", region: \"Northwest\", population: 56000 },\r\n  { value: \"gabrovo\", label: \"Gabrovo\", labelBg: \"╨ô╨░╨▒╤Ç╨╛╨▓╨╛\", region: \"North Central\", population: 53000 },\r\n  { value: \"asenovgrad\", label: \"Asenovgrad\", labelBg: \"╨É╤ü╨╡╨╜╨╛╨▓╨│╤Ç╨░╨┤\", region: \"South Central\", population: 50000 },\r\n  { value: \"vidin\", label: \"Vidin\", labelBg: \"╨Æ╨╕╨┤╨╕╨╜\", region: \"Northwest\", population: 43000 },\r\n  { value: \"kazanlak\", label: \"Kazanlak\", labelBg: \"╨Ü╨░╨╖╨░╨╜╨╗╤è╨║\", region: \"South Central\", population: 42000 },\r\n  { value: \"kyustendil\", label: \"Kyustendil\", labelBg: \"╨Ü╤Ä╤ü╤é╨╡╨╜╨┤╨╕╨╗\", region: \"Southwest\", population: 40000 },\r\n  { value: \"kardzhali\", label: \"Kardzhali\", labelBg: \"╨Ü╤è╤Ç╨┤╨╢╨░╨╗╨╕\", region: \"South Central\", population: 39000 },\r\n  { value: \"montana\", label: \"Montana\", labelBg: \"╨£╨╛╨╜╤é╨░╨╜╨░\", region: \"Northwest\", population: 38000 },\r\n  { value: \"targovishte\", label: \"Targovishte\", labelBg: \"╨ó╤è╤Ç╨│╨╛╨▓╨╕╤ë╨╡\", region: \"Northeast\", population: 35000 },\r\n  { value: \"dimitrovgrad\", label: \"Dimitrovgrad\", labelBg: \"╨ö╨╕╨╝╨╕╤é╤Ç╨╛╨▓╨│╤Ç╨░╨┤\", region: \"South Central\", population: 33000 },\r\n  { value: \"lovech\", label: \"Lovech\", labelBg: \"╨¢╨╛╨▓╨╡╤ç\", region: \"Northwest\", population: 32000 },\r\n  { value: \"silistra\", label: \"Silistra\", labelBg: \"╨í╨╕╨╗╨╕╤ü╤é╤Ç╨░\", region: \"Northeast\", population: 31000 },\r\n  { value: \"razgrad\", label: \"Razgrad\", labelBg: \"╨á╨░╨╖╨│╤Ç╨░╨┤\", region: \"Northeast\", population: 29000 },\r\n  { value: \"gorna-oryahovitsa\", label: \"Gorna Oryahovitsa\", labelBg: \"╨ô╨╛╤Ç╨╜╨░ ╨₧╤Ç╤Å╤à╨╛╨▓╨╕╤å╨░\", region: \"North Central\", population: 28000 },\r\n  // Resort & Black Sea towns (important for marketplace)\r\n  { value: \"sunny-beach\", label: \"Sunny Beach\", labelBg: \"╨í╨╗╤è╨╜╤ç╨╡╨▓ ╨▒╤Ç╤Å╨│\", region: \"Southeast\", population: 3000 },\r\n  { value: \"golden-sands\", label: \"Golden Sands\", labelBg: \"╨ù╨╗╨░╤é╨╜╨╕ ╨┐╤Å╤ü╤è╤å╨╕\", region: \"Northeast\", population: 2000 },\r\n  { value: \"bansko\", label: \"Bansko\", labelBg: \"╨æ╨░╨╜╤ü╨║╨╛\", region: \"Southwest\", population: 9000 },\r\n  { value: \"pamporovo\", label: \"Pamporovo\", labelBg: \"╨ƒ╨░╨╝╨┐╨╛╤Ç╨╛╨▓╨╛\", region: \"South Central\", population: 500 },\r\n  { value: \"borovets\", label: \"Borovets\", labelBg: \"╨æ╨╛╤Ç╨╛╨▓╨╡╤å\", region: \"Sofia Region\", population: 300 },\r\n  // Other option for smaller towns/villages\r\n  { value: \"other\", label: \"Other City/Village\", labelBg: \"╨ö╤Ç╤â╨│ ╨│╤Ç╨░╨┤/╤ü╨╡╨╗╨╛\", region: null },\r\n] as const;\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\category-display.ts","messages":[{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":16,"column":15,"nodeType":"Identifier","messageId":"method","endLine":16,"endColumn":22,"fix":{"range":[412,417],"text":"All('-'"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"export type CategoryDisplay = {\n  id: string\n  name: string\n  name_bg: string | null\n  slug: string\n  image_url?: string | null\n  icon?: string | null\n}\n\nexport function getCategoryName(category: CategoryDisplay, locale: string): string {\n  if (locale === \"bg\" && category.name_bg) return category.name_bg\n  return category.name\n}\n\nexport function getCategorySlugKey(slug: string): string {\n  return slug.replace(/-/g, \"_\")\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\category-tree.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\currency.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\data\\categories.ts","messages":[{"ruleId":"prefer-const","severity":2,"message":"'l2Cats' is never reassigned. Use 'const' instead.","line":297,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":297,"endColumn":30,"fix":{"range":[9469,9499],"text":"const l2Cats: typeof l1Cats = []"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getCategoryAttributes' is defined but never used.","line":497,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":497,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getSiblingCategories' is defined but never used.","line":520,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":520,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getChildCategories' is defined but never used.","line":567,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":567,"endColumn":34}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import 'server-only'\r\n\r\nimport { cacheTag, cacheLife } from 'next/cache'\r\nimport { createStaticClient } from '@/lib/supabase/server'\nimport { normalizeOptionalImageUrl } from '@/lib/normalize-image-url'\nimport { logger } from '@/lib/logger'\nimport { resolveCategoryAttributesWithClient } from '@/lib/data/category-attributes'\nimport type { AttributeType, CategoryAttribute } from '@/lib/types/categories'\nimport { CATEGORY_TREE_NODE_SELECT } from '@/lib/supabase/selects/categories'\n\r\n// =============================================================================\r\n// Type Definitions\r\n// =============================================================================\r\n\r\nexport interface Category {\r\n  id: string\r\n  name: string\r\n  name_bg: string | null\r\n  slug: string\r\n  parent_id: string | null\r\n  image_url: string | null\r\n  icon: string | null\r\n  display_order: number | null\r\n}\r\n\r\nexport interface CategoryWithParent extends Category {\r\n  parent: Category | null\r\n}\r\n\r\nexport type { AttributeType, CategoryAttribute }\r\n\r\n\r\ninterface CategoryHierarchyRow {\r\n  id: string\r\n  name: string\r\n  name_bg: string | null\r\n  slug: string\r\n  parent_id: string | null\r\n  depth: number\r\n  path: string[]\r\n  image_url: string | null\r\n  icon: string | null\r\n  display_order: number | null\r\n}\r\n\r\nexport interface CategoryWithChildren extends Category {\r\n  children?: CategoryWithChildren[]\r\n}\r\n\r\nexport interface CategoryTreeNodeLite {\r\n  id: string\r\n  name: string\r\n  name_bg: string | null\r\n  slug: string\r\n  parent_id: string | null\r\n  display_order: number | null\r\n  children: CategoryTreeNodeLite[]\r\n  /** True if this category has children in DB (may not be loaded in tree) */\r\n  has_children: boolean\r\n}\r\n\r\nexport interface CategoryContext {\r\n  current: Category\r\n  parent: Category | null\r\n  siblings: Category[]\r\n  children: Category[]\r\n  attributes: CategoryAttribute[]\r\n}\r\n\r\n\r\n// =============================================================================\r\n// Helper Functions\r\n// =============================================================================\r\n\r\n/**\r\n * Transform flat RPC results into nested tree structure\r\n */\r\nfunction buildCategoryTree(rows: CategoryHierarchyRow[]): CategoryWithChildren[] {\r\n  const categoryMap = new Map<string, CategoryWithChildren>()\r\n  const rootCategories: CategoryWithChildren[] = []\r\n  \r\n  // Filter out deprecated/hidden categories (display_order >= 9000)\r\n  const activeRows = rows.filter(row => (row.display_order ?? 0) < 9000)\r\n  \r\n  // First pass: create all category objects\r\n  for (const row of activeRows) {\r\n    categoryMap.set(row.id, {\r\n      id: row.id,\r\n      name: row.name,\r\n      name_bg: row.name_bg,\r\n      slug: row.slug,\r\n      parent_id: row.parent_id,\r\n      icon: row.icon,\r\n      image_url: row.image_url,\r\n      display_order: row.display_order,\r\n      children: []\r\n    })\r\n  }\r\n  \r\n  // Second pass: build tree structure\r\n  for (const row of activeRows) {\r\n    const category = categoryMap.get(row.id)\r\n    if (!category) continue\r\n    \r\n    if (row.parent_id && categoryMap.has(row.parent_id)) {\r\n      const parent = categoryMap.get(row.parent_id)\r\n      if (!parent) continue\r\n      parent.children = parent.children || []\r\n      parent.children.push(category)\r\n    } else if (row.depth === 0) {\r\n      rootCategories.push(category)\r\n    }\r\n  }\r\n  \r\n  // Sort children by display_order, then by name\r\n  function sortChildren(cats: CategoryWithChildren[]): CategoryWithChildren[] {\r\n    cats.sort((a, b) => {\r\n      const orderA = a.display_order ?? 999\r\n      const orderB = b.display_order ?? 999\r\n      if (orderA !== orderB) return orderA - orderB\r\n      return a.name.localeCompare(b.name)\r\n    })\r\n    for (const cat of cats) {\r\n      if (cat.children && cat.children.length > 0) {\r\n        sortChildren(cat.children)\r\n      }\r\n    }\r\n    return cats\r\n  }\r\n  \r\n  return sortChildren(rootCategories)\r\n}\r\n\r\ntype RawCategoryTreeNodeLite = Omit<CategoryTreeNodeLite, 'children' | 'has_children'> & { has_children?: boolean }\r\n\r\nfunction buildCategoryTreeLite(\r\n  categories: RawCategoryTreeNodeLite[],\r\n  childCountMap?: Map<string, number>\r\n): CategoryTreeNodeLite[] {\r\n  const categoryMap = new Map<string, CategoryTreeNodeLite>()\r\n  const roots: CategoryTreeNodeLite[] = []\r\n\r\n  const activeCategories = categories.filter((row) => (row.display_order ?? 0) < 9000)\r\n\r\n  for (const cat of activeCategories) {\r\n    const dbChildCount = childCountMap?.get(cat.id) ?? 0\r\n    categoryMap.set(cat.id, {\r\n      ...cat,\r\n      children: [],\r\n      // has_children is true if DB says there are children OR if already marked\r\n      has_children: cat.has_children ?? dbChildCount > 0,\r\n    })\r\n  }\r\n\r\n  for (const cat of activeCategories) {\r\n    const node = categoryMap.get(cat.id)\r\n    if (!node) continue\r\n\r\n    if (cat.parent_id && categoryMap.has(cat.parent_id)) {\r\n      categoryMap.get(cat.parent_id)?.children.push(node)\r\n    } else if (!cat.parent_id) {\r\n      roots.push(node)\r\n    }\r\n  }\r\n\r\n  function sortChildren(nodes: CategoryTreeNodeLite[]) {\r\n    nodes.sort((a, b) => {\r\n      const orderA = a.display_order ?? 999\r\n      const orderB = b.display_order ?? 999\r\n      if (orderA !== orderB) return orderA - orderB\r\n      return a.name.localeCompare(b.name)\r\n    })\r\n\r\n    for (const node of nodes) {\r\n      // Ensure has_children is true if there are loaded children\r\n      if (node.children.length > 0) {\r\n        node.has_children = true\r\n        sortChildren(node.children)\r\n      }\r\n    }\r\n  }\r\n\r\n  sortChildren(roots)\r\n  return roots\r\n}\r\n\r\nasync function fetchChildCategoriesLiteBatched(\r\n  supabase: ReturnType<typeof createStaticClient>,\r\n  parentIds: string[],\r\n  {\r\n    batchSize,\r\n    concurrency,\r\n    label,\r\n  }: { batchSize: number; concurrency: number; label: string },\r\n): Promise<RawCategoryTreeNodeLite[]> {\r\n  if (parentIds.length === 0) return []\r\n\r\n  const batches: Array<{ index: number; ids: string[] }> = []\r\n  for (let i = 0; i < parentIds.length; i += batchSize) {\r\n    batches.push({ index: i / batchSize, ids: parentIds.slice(i, i + batchSize) })\r\n  }\r\n\r\n  const out: RawCategoryTreeNodeLite[] = []\r\n  for (let start = 0; start < batches.length; start += concurrency) {\r\n    const chunk = batches.slice(start, start + concurrency)\r\n    const chunkResults = await Promise.all(\r\n      chunk.map(async ({ index, ids }) => {\r\n        const { data, error } = await supabase\r\n          .from(\"categories\")\r\n          .select(\"id, name, name_bg, slug, parent_id, display_order\")\r\n          .in(\"parent_id\", ids)\r\n          .lt(\"display_order\", 9000)\r\n          .order(\"display_order\", { ascending: true })\r\n\r\n        if (error) {\r\n          logger.error(`[fetchChildCategoriesLiteBatched] ${label} query error (batch ${index})`, error)\r\n          return []\r\n        }\r\n        return data || []\r\n      }),\r\n    )\r\n\r\n    for (const part of chunkResults) out.push(...part)\r\n  }\r\n\r\n  return out\r\n}\r\n\r\n// =============================================================================\r\n// Data Fetching Functions with Next.js 16 Caching\r\n// =============================================================================\r\n// These functions use 'use cache' because they DON'T use next-intl.\r\n// The caching is applied to data fetching, NOT to pages/layouts that use getTranslations().\r\n\r\n/**\r\n * Fetch category hierarchy starting from root categories.\r\n * \r\n * PERFORMANCE OPTIMIZATION (Jan 2026):\r\n * - Fetches L0 ΓåÆ L1 ΓåÆ L2 only (~3,400 categories, ~60KB gzipped)\r\n * - L3 categories (~9,700) are lazy-loaded via /api/categories/[parentId]/children\r\n * - This reduces initial payload by ~80% (from ~400KB to ~60KB)\r\n * \r\n * @param slug - Reserved for future use (currently ignored)\r\n * @param depth - Max depth: 0=L0 only, 1=L0+L1, 2=L0+L1+L2 (default & max)\r\n * @returns Nested category tree structure (L0 ΓåÆ L1 ΓåÆ L2, no L3)\r\n */\r\nexport async function getCategoryHierarchy(\r\n  _slug?: string | null, \r\n  depth: number = 2\r\n): Promise<CategoryWithChildren[]> {\r\n  'use cache'\r\n  cacheTag('categories:tree')\r\n  cacheLife('categories')\r\n  try {\r\n    const supabase = createStaticClient()\r\n    \r\n    // Clamp depth to max 2 (L3 is always lazy-loaded)\r\n    const effectiveDepth = Math.min(depth, 2)\r\n    \r\n    // Fetch L0 categories (root)\r\n    const { data: rootCats, error: rootError } = await supabase\r\n      .from(\"categories\")\r\n      .select(\"id, name, name_bg, slug, parent_id, icon, image_url, display_order\")\r\n      .is(\"parent_id\", null)\r\n      .lt(\"display_order\", 9000)\r\n      .order(\"display_order\", { ascending: true })\r\n\r\n    if (rootError) {\r\n      logger.error('[getCategoryHierarchy] Root query error', rootError)\r\n      return []\r\n    }\r\n\r\n    if (!rootCats || rootCats.length === 0) return []\r\n\r\n    if (effectiveDepth === 0) {\r\n      return (rootCats || []).map(cat => ({\r\n        ...cat,\r\n        image_url: normalizeOptionalImageUrl(cat.image_url),\r\n        children: []\r\n      }))\r\n    }\r\n\r\n    // Fetch L1 categories\r\n    const rootIds = (rootCats || []).map(c => c.id)\r\n    const { data: l1Cats, error: l1Error } = await supabase\r\n      .from(\"categories\")\r\n      .select(\"id, name, name_bg, slug, parent_id, icon, image_url, display_order\")\r\n      .in(\"parent_id\", rootIds)\r\n      .lt(\"display_order\", 9000)\r\n      .order(\"display_order\", { ascending: true })\r\n\r\n    if (l1Error) {\r\n      logger.error('[getCategoryHierarchy] L1 query error', l1Error)\r\n    }\r\n\r\n    // Fetch L2 categories if depth >= 2 (batched to avoid large IN clauses)\r\n    let l2Cats: typeof l1Cats = []\r\n    if (effectiveDepth >= 2 && l1Cats && l1Cats.length > 0) {\r\n      const l1Ids = l1Cats.map(c => c.id)\r\n      const BATCH_SIZE = 50\r\n      \r\n      // Use Promise.all for parallel fetching\r\n      const batches = []\r\n      for (let i = 0; i < l1Ids.length; i += BATCH_SIZE) {\r\n        batches.push(l1Ids.slice(i, i + BATCH_SIZE))\r\n      }\r\n      \r\n      const results = await Promise.all(\r\n        batches.map(batchIds => \r\n          supabase\r\n            .from(\"categories\")\r\n            .select(\"id, name, name_bg, slug, parent_id, icon, image_url, display_order\")\r\n            .in(\"parent_id\", batchIds)\r\n            .lt(\"display_order\", 9000)\r\n            .order(\"display_order\", { ascending: true })\r\n        )\r\n      )\r\n      \r\n      for (const result of results) {\r\n        if (result.data) {\r\n          l2Cats.push(...result.data)\r\n        }\r\n      }\r\n    }\r\n\r\n    // NOTE: L3 categories are NOT fetched here.\r\n    // They are lazy-loaded via /api/categories/[parentId]/children when L2 is clicked.\r\n    // This reduces initial payload from ~400KB to ~60KB (13K ΓåÆ 3.4K categories).\r\n\r\n    // Combine and build tree (L0 + L1 + L2 only)\r\n    const allCats = [...(rootCats || []), ...(l1Cats || []), ...l2Cats]\r\n    \r\n    // Create sets for efficient depth lookups\r\n    const rootIdSet = new Set(rootIds)\r\n    const l1Ids = new Set((l1Cats || []).map(c => c.id))\r\n    \r\n    const rows: CategoryHierarchyRow[] = allCats.map(cat => {\r\n      // Calculate depth based on parent membership\r\n      let catDepth = 0\r\n      if (cat.parent_id === null) {\r\n        catDepth = 0  // Root/L0\r\n      } else if (rootIdSet.has(cat.parent_id)) {\r\n        catDepth = 1  // L1 (parent is L0)\r\n      } else if (l1Ids.has(cat.parent_id)) {\r\n        catDepth = 2  // L2 (parent is L1)\r\n      }\r\n      \r\n      return {\r\n        id: cat.id,\r\n        name: cat.name,\r\n        name_bg: cat.name_bg,\r\n        slug: cat.slug,\r\n        parent_id: cat.parent_id,\r\n        icon: cat.icon,\r\n        image_url: normalizeOptionalImageUrl(cat.image_url),\r\n        display_order: cat.display_order,\r\n        depth: catDepth,\r\n        path: []\r\n      }\r\n    })\r\n    \r\n    return buildCategoryTree(rows)\r\n  } catch (error) {\r\n    logger.error('[getCategoryHierarchy] Unexpected error', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Category tree for selector UIs that need stable client-side navigation.\r\n *\r\n * Used by:\r\n * - Sell flow (category picker needs L0 ΓåÆ L3 without extra client fetching)\r\n * - Business dashboard product forms (same selector requirement)\r\n */\r\nexport async function getCategoryTreeDepth3(): Promise<CategoryTreeNodeLite[]> {\r\n  'use cache'\r\n  cacheTag('categories:tree', 'categories:sell', 'categories:sell:depth:3')\r\n  cacheLife('categories')\r\n\r\n  const supabase = createStaticClient()\r\n\r\n  const { data: rootCats, error: rootError } = await supabase\r\n    .from(\"categories\")\r\n    .select(\"id, name, name_bg, slug, parent_id, display_order\")\r\n    .is(\"parent_id\", null)\r\n    .lt(\"display_order\", 9000)\r\n    .order(\"display_order\", { ascending: true })\r\n\r\n  if (rootError) {\r\n    logger.error('[getCategoryTreeDepth3] Root query error', rootError)\r\n    return []\r\n  }\r\n\r\n  if (!rootCats || rootCats.length === 0) return []\r\n\r\n  const rootIds = rootCats.map((c) => c.id)\r\n  const { data: l1Cats, error: l1Error } = await supabase\r\n    .from(\"categories\")\r\n    .select(\"id, name, name_bg, slug, parent_id, display_order\")\r\n    .in(\"parent_id\", rootIds)\r\n    .lt(\"display_order\", 9000)\r\n    .order(\"display_order\", { ascending: true })\r\n\r\n  if (l1Error) {\r\n    logger.error('[getCategoryTreeDepth3] L1 query error', l1Error)\r\n  }\r\n\r\n  const l1Ids = (l1Cats || []).map((c) => c.id)\r\n  const l2Cats = await fetchChildCategoriesLiteBatched(supabase, l1Ids, {\r\n    batchSize: 100,\r\n    concurrency: 4,\r\n    label: \"L2\",\r\n  })\r\n\r\n  const l2Ids = l2Cats.map((c) => c.id)\r\n  const l3Cats = await fetchChildCategoriesLiteBatched(supabase, l2Ids, {\r\n    batchSize: 100,\r\n    concurrency: 4,\r\n    label: \"L3\",\r\n  })\r\n\r\n  // Fetch child counts for L3 categories to know which have L4 children\r\n  const l3Ids = l3Cats.map((c) => c.id)\r\n  const childCountMap = new Map<string, number>()\r\n  \r\n  if (l3Ids.length > 0) {\r\n    // Query to get count of children for each L3 category\r\n    const BATCH_SIZE = 200\r\n    for (let i = 0; i < l3Ids.length; i += BATCH_SIZE) {\r\n      const batchIds = l3Ids.slice(i, i + BATCH_SIZE)\r\n      const { data: childCounts, error: countError } = await supabase\r\n        .from(\"categories\")\r\n        .select(\"parent_id\")\r\n        .in(\"parent_id\", batchIds)\r\n        .lt(\"display_order\", 9000)\r\n      \r\n      if (!countError && childCounts) {\r\n        // Count children per parent\r\n        for (const row of childCounts) {\r\n          if (row.parent_id) {\r\n            childCountMap.set(row.parent_id, (childCountMap.get(row.parent_id) || 0) + 1)\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  const allCats = [...rootCats, ...(l1Cats || []), ...l2Cats, ...l3Cats]\r\n  return buildCategoryTreeLite(allCats, childCountMap)\r\n}\r\n\r\n/**\r\n * Fetch a single category by slug with its parent.\r\n * Optimized for page metadata and breadcrumbs.\r\n * \r\n * @param slug - Category slug\r\n * @returns Category with parent or null if not found\r\n */\r\nexport async function getCategoryBySlug(slug: string): Promise<CategoryWithParent | null> {\r\n  'use cache'\r\n  cacheTag(`category:${slug}`)\r\n  cacheLife('categories')\r\n  \r\n  const supabase = createStaticClient()\r\n  \r\n  const { data, error } = await supabase\r\n    .from('categories')\r\n    .select(`\r\n      id, name, name_bg, slug, parent_id, image_url, icon, display_order,\r\n      parent:parent_id (id, name, name_bg, slug, parent_id, image_url, icon, display_order)\r\n    `)\r\n    .eq('slug', slug)\r\n    .single()\r\n  \r\n  if (error || !data) {\r\n    logger.error('[getCategoryBySlug] Query error', error)\r\n    return null\r\n  }\r\n  \r\n  // Supabase returns parent as array for relations, take first element\r\n  const parentData = Array.isArray(data.parent) ? data.parent[0] : data.parent\r\n  \r\n  return {\r\n    ...data,\r\n    parent: parentData as Category | null\r\n  }\r\n}\r\n\r\n/**\n * Fetch filterable attributes for a category.\n * Used to build dynamic filter UIs on category pages.\n * \n * @param categoryId - Category UUID\r\n * @returns Array of filterable attributes\r\n */\r\nasync function getCategoryAttributes(categoryId: string): Promise<CategoryAttribute[]> {\n  'use cache'\n  cacheTag(`attrs:category:${categoryId}`)\n  cacheLife('categories')\n  \n  const supabase = createStaticClient()\n\n  const { attributes } = await resolveCategoryAttributesWithClient(supabase, categoryId, {\n    includeParents: false,\n    includeGlobal: false,\n    filterableOnly: true,\n  })\n\n  return attributes\n}\n\r\n/**\r\n * Fetch sibling categories (same parent).\r\n * Used for sidebar navigation.\r\n * \r\n * @param parentId - Parent category UUID (null for root categories)\r\n * @returns Array of sibling categories\r\n */\r\nasync function getSiblingCategories(parentId: string | null): Promise<Category[]> {\n  'use cache'\r\n  cacheTag(`category-siblings:${parentId || 'root'}`)\r\n  cacheLife('categories')\r\n  \r\n  const supabase = createStaticClient()\r\n  \r\n  let query = supabase\n    .from('categories')\n    .select(CATEGORY_TREE_NODE_SELECT)\n    .lt('display_order', 9999)\n    .order('display_order', { ascending: true })\n    .order('name', { ascending: true })\n  \r\n  if (parentId) {\r\n    query = query.eq('parent_id', parentId)\r\n  } else {\r\n    query = query.is('parent_id', null)\r\n  }\r\n  \r\n  const { data, error } = await query\r\n  \r\n  if (error) {\r\n    logger.error('[getSiblingCategories] Query error', error)\r\n    return []\r\n  }\r\n  \r\n  return (data || []) as Category[]\r\n}\r\n\r\n/**\n * Fetch sibling categories with product counts for navigation circles.\n * Shows all siblings of a category (same parent) including the current one.\n * Used for leaf-level navigation where there are no children.\n * \n * @param categoryId - Current category UUID\n * @returns Array of sibling categories with product counts (current category included)\n */\n\n\r\n/**\r\n * Fetch direct children of a category.\r\n * Used for subcategory tabs and navigation.\r\n * \r\n * @param categoryId - Parent category UUID\r\n * @returns Array of child categories\r\n */\r\nasync function getChildCategories(categoryId: string): Promise<Category[]> {\n  'use cache'\r\n  cacheTag(`category-children:${categoryId}`)\r\n  cacheLife('categories')\r\n  \r\n  const supabase = createStaticClient()\r\n  \r\n  const { data, error } = await supabase\n    .from('categories')\n    .select(CATEGORY_TREE_NODE_SELECT)\n    .eq('parent_id', categoryId)\n    .lt('display_order', 9999)\n    .order('display_order', { ascending: true })\n    .order('name', { ascending: true })\r\n  \r\n  if (error) {\r\n    logger.error('[getChildCategories] Query error', error)\r\n    return []\r\n  }\r\n  \r\n  return (data || []) as Category[]\r\n}\r\n\r\n/**\r\n * Fetch complete category context for sidebar navigation.\r\n * Includes current category, parent, siblings, children, and filterable attributes.\r\n * \r\n * @param slug - Category slug\r\n * @returns Full category context or null if not found\r\n */\r\nexport async function getCategoryContext(slug: string): Promise<CategoryContext | null> {\r\n  'use cache'\r\n  cacheTag(`category:${slug}`)\r\n  cacheLife('categories')\r\n  \r\n  const supabase = createStaticClient()\r\n  \r\n  // Get current category with parent\r\n  const { data: current, error: currentError } = await supabase\r\n    .from('categories')\r\n    .select(`\r\n      id, name, name_bg, slug, parent_id, image_url, icon, display_order,\r\n      parent:parent_id (id, name, name_bg, slug, parent_id, image_url, icon, display_order)\r\n    `)\r\n    .eq('slug', slug)\r\n    .single()\r\n  \r\n  if (currentError || !current) {\r\n    logger.error('[getCategoryContext] Category not found', currentError)\r\n    return null\r\n  }\r\n  \r\n  // Fetch siblings, children (DEC-002), and attributes in parallel\r\n  const [siblingsResult, childrenWithCounts, attributesResult] = await Promise.all([\n    // Siblings (same parent, exclude hidden)\n    current.parent_id\n      ? supabase\n          .from('categories')\n          .select('id, name, name_bg, slug, parent_id, image_url, icon, display_order')\n          .eq('parent_id', current.parent_id)\r\n          .lt('display_order', 9999)\r\n          .order('display_order')\r\n          .order('name')\r\n      : supabase\r\n          .from('categories')\r\n          .select('id, name, name_bg, slug, parent_id, image_url, icon, display_order')\r\n          .is('parent_id', null)\r\n          .lt('display_order', 9999)\r\n          .order('display_order')\n          .order('name'),\n    \n    // Children: fetch ALL, sorting handles curated-first ordering\n    // filterForBrowse=false ensures all children show as navigation circles\n    getSubcategoriesForBrowse(current.id, false),\n    \n    // Filterable attributes (current + inherited by scope)\n    resolveCategoryAttributesWithClient(supabase, current.id, {\n      includeParents: true,\n      includeGlobal: true,\n      filterableOnly: true,\n    }),\n  ])\n\n  const { attributes, ancestorIds } = attributesResult\n\n  for (const id of ancestorIds) {\n    cacheTag(`attrs:category:${id}`)\n  }\n  cacheTag('attrs:global')\n  \n  return {\n    current: {\r\n      id: current.id,\r\n      name: current.name,\r\n      name_bg: current.name_bg,\r\n      slug: current.slug,\r\n      parent_id: current.parent_id,\r\n      image_url: current.image_url,\r\n      icon: current.icon,\r\n      display_order: current.display_order\r\n    },\r\n    // Supabase returns parent as array for relations, take first element\r\n    parent: (Array.isArray(current.parent) ? current.parent[0] : current.parent) as Category | null,\r\n    siblings: (siblingsResult.data || []) as Category[],\r\n    // DEC-002: Children filtered/sorted via getSubcategoriesForBrowse (curated + populated)\r\n    children: childrenWithCounts as Category[],\r\n    attributes\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// Category Stats (DEC-002 Support)\r\n// =============================================================================\r\n\r\nexport interface CategoryWithCount extends Category {\r\n  subtree_product_count: number\r\n}\r\n\r\n/**\r\n * Fetch subcategories with their product counts from category_stats.\r\n * Used for buyer browse UX to filter out empty categories.\r\n * \r\n * @param parentId - Parent category UUID (null for root categories)\r\n * @param populatedOnly - If true, only return categories with products (default: false)\r\n * @returns Array of subcategories with subtree_product_count\r\n */\r\nexport async function getSubcategoriesWithCounts(\r\n  parentId: string | null,\r\n  populatedOnly: boolean = false\r\n): Promise<CategoryWithCount[]> {\r\n  'use cache'\r\n  cacheTag(`subcategories:${parentId || 'root'}:counts`)\r\n  cacheLife('categories')\r\n  \r\n  const supabase = createStaticClient()\r\n  \r\n  // 2-query merge approach: avoids PostgREST relationship issues with materialized views\r\n  // Query 1: Get categories by parent\r\n  let catQuery = supabase\r\n    .from('categories')\r\n    .select('id, name, name_bg, slug, parent_id, image_url, icon, display_order')\r\n    .lt('display_order', 9000)\r\n    .order('display_order', { ascending: true })\r\n    .order('name', { ascending: true })\r\n  \r\n  if (parentId) {\r\n    catQuery = catQuery.eq('parent_id', parentId)\r\n  } else {\r\n    catQuery = catQuery.is('parent_id', null)\r\n  }\r\n  \r\n  const { data: categories, error: catError } = await catQuery\r\n  \r\n  if (catError) {\r\n    logger.error('[getSubcategoriesWithCounts] Categories query error', catError)\r\n    return []\r\n  }\r\n  \r\n  if (!categories || categories.length === 0) {\r\n    return []\r\n  }\r\n  \r\n  // Query 2: Get counts for these category IDs from category_stats (materialized view)\r\n  const categoryIds = categories.map(c => c.id)\r\n  \r\n  const { data: statsRaw, error: statsError } = await supabase\r\n    .from('category_stats')\r\n    .select('category_id, subtree_product_count')\r\n    .in('category_id', categoryIds)\r\n  \r\n  if (statsError) {\r\n    logger.error('[getSubcategoriesWithCounts] Stats query error', statsError)\r\n    // Fallback: return categories with 0 counts rather than failing completely\r\n  }\r\n  \r\n  const stats = statsRaw ?? []\r\n  \r\n  // Build lookup map for counts\r\n  const countMap = new Map<string, number>()\r\n  for (const stat of stats) {\r\n    if (!stat.category_id) continue\r\n    countMap.set(stat.category_id, stat.subtree_product_count ?? 0)\r\n  }\r\n  \r\n  // Merge categories with counts\r\n  const result: CategoryWithCount[] = categories.map(cat => ({\r\n    id: cat.id,\r\n    name: cat.name,\r\n    name_bg: cat.name_bg,\r\n    slug: cat.slug,\r\n    parent_id: cat.parent_id,\r\n    image_url: normalizeOptionalImageUrl(cat.image_url),\r\n    icon: cat.icon,\r\n    display_order: cat.display_order,\r\n    subtree_product_count: countMap.get(cat.id) ?? 0\r\n  }))\r\n  \r\n  // Filter for populated only if requested\r\n  if (populatedOnly) {\r\n    return result.filter(cat => cat.subtree_product_count > 0)\r\n  }\r\n  \r\n  return result\r\n}\r\n\r\n/**\r\n * Get subcategories ordered by curated first, then by product count.\r\n * Implements DEC-002 ordering: display_order > 0 first, then by subtree_product_count DESC.\r\n * \r\n * @param parentId - Parent category UUID (null for root categories)\r\n * @param filterForBrowse - If true, only shows populated OR curated categories (for homepage).\r\n *                          If false (recommended for category pages), returns ALL children.\r\n * @returns Array of subcategories sorted by curated then popularity\r\n */\r\nexport async function getSubcategoriesForBrowse(\r\n  parentId: string | null,\r\n  filterForBrowse: boolean = false\r\n): Promise<CategoryWithCount[]> {\r\n  // Always fetch all counts (we filter in TS for flexibility)\r\n  const subcats = await getSubcategoriesWithCounts(parentId, false)\r\n  \r\n  // Only filter when explicitly requested (e.g., homepage browse)\r\n  // Category pages should show ALL children for navigation\r\n  const visible = filterForBrowse\r\n    ? subcats.filter(cat => {\r\n        const isCurated = (cat.display_order ?? 0) > 0 && (cat.display_order ?? 9999) < 9000\r\n        const isPopulated = cat.subtree_product_count > 0\r\n        return isPopulated || isCurated\r\n      })\r\n    : subcats\r\n  \r\n  // Sort: curated (display_order > 0 && display_order < 9000) first, then by product count DESC\r\n  return visible.sort((a, b) => {\r\n    const aCurated = (a.display_order ?? 0) > 0 && (a.display_order ?? 9999) < 9000\r\n    const bCurated = (b.display_order ?? 0) > 0 && (b.display_order ?? 9999) < 9000\r\n    \r\n    // Curated categories first\r\n    if (aCurated && !bCurated) return -1\r\n    if (!aCurated && bCurated) return 1\r\n    \r\n    // Within curated: sort by display_order\r\n    if (aCurated && bCurated) {\r\n      return (a.display_order ?? 999) - (b.display_order ?? 999)\r\n    }\r\n    \r\n    // Within non-curated: sort by product count DESC, then by name ASC for consistency\r\n    if (b.subtree_product_count !== a.subtree_product_count) {\r\n      return b.subtree_product_count - a.subtree_product_count\r\n    }\r\n    return a.name.localeCompare(b.name)\r\n  })\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\data\\category-attributes.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_isOwn' is defined but never used.","line":235,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":235,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import 'server-only'\n\nimport type { SupabaseClient } from '@supabase/supabase-js'\nimport { createStaticClient } from '@/lib/supabase/server'\nimport type { Database } from '@/lib/supabase/database.types'\nimport { CATEGORY_ATTRIBUTES_SELECT } from '@/lib/supabase/selects/categories'\nimport { normalizeAttributeKey } from '@/lib/attributes/normalize-attribute-key'\nimport type { AttributeType, CategoryAttribute, CategoryAttributeInheritScope } from '@/lib/types/categories'\n\nconst VALID_ATTRIBUTE_TYPES: AttributeType[] = ['select', 'multiselect', 'boolean', 'number', 'text', 'date']\nconst MAX_ANCESTOR_DEPTH = 6\n\nexport type CategoryAttributeRow = Database['public']['Tables']['category_attributes']['Row']\n\nconst UUID_RE = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i\n\nfunction isUuid(value: string): boolean {\n  return UUID_RE.test(value)\n}\n\nfunction normalizeInheritScope(\n  scope: CategoryAttributeInheritScope | null,\n  categoryId: string | null,\n): CategoryAttributeInheritScope {\n  if (scope) return scope\n  return categoryId ? 'self_only' : 'global'\n}\n\nexport function toCategoryAttribute(row: CategoryAttributeRow): CategoryAttribute {\n  const attrType = VALID_ATTRIBUTE_TYPES.includes(row.attribute_type as AttributeType)\n    ? (row.attribute_type as AttributeType)\n    : 'text'\n\n  const attributeKey = row.attribute_key ?? (normalizeAttributeKey(row.name) || null)\n\n  return {\n    id: row.id,\n    category_id: row.category_id,\n    name: row.name,\n    name_bg: row.name_bg,\n    attribute_type: attrType,\n    attribute_key: attributeKey,\n    inherit_scope: normalizeInheritScope(row.inherit_scope as CategoryAttributeInheritScope | null, row.category_id),\n    options: Array.isArray(row.options) ? (row.options as string[]) : null,\n    options_bg: Array.isArray(row.options_bg) ? (row.options_bg as string[]) : null,\n    placeholder: row.placeholder ?? null,\n    placeholder_bg: row.placeholder_bg ?? null,\n    is_filterable: row.is_filterable,\n    is_required: row.is_required,\n    is_hero_spec: row.is_hero_spec ?? null,\n    hero_priority: row.hero_priority ?? null,\n    is_badge_spec: row.is_badge_spec ?? null,\n    badge_priority: row.badge_priority ?? null,\n    unit_suffix: row.unit_suffix ?? null,\n    sort_order: row.sort_order,\n    validation_rules: row.validation_rules ?? null,\n  }\n}\n\nfunction getCategoryAttributeKey(attr: Pick<CategoryAttribute, 'attribute_key' | 'name'>): string {\n  return (attr.attribute_key ?? normalizeAttributeKey(attr.name)).trim().toLowerCase()\n}\n\nfunction getCategoryAttributeMapKey(\n  attr: Pick<CategoryAttribute, 'attribute_key' | 'name' | 'attribute_type'>,\n): string {\n  return `${getCategoryAttributeKey(attr)}::${attr.attribute_type}`.trim().toLowerCase()\n}\n\nfunction hasAnyOptions(attr: CategoryAttribute): boolean {\n  const hasEn = Array.isArray(attr.options) && attr.options.length > 0\n  const hasBg = Array.isArray(attr.options_bg) && attr.options_bg.length > 0\n  return hasEn || hasBg\n}\n\nfunction withFallbackOptions(current: CategoryAttribute, fallback: CategoryAttribute): CategoryAttribute {\n  const currentHasOptions = hasAnyOptions(current)\n  const fallbackHasOptions = hasAnyOptions(fallback)\n  if (currentHasOptions || !fallbackHasOptions) return current\n\n  return {\n    ...current,\n    options: Array.isArray(current.options) && current.options.length > 0 ? current.options : fallback.options,\n    options_bg: Array.isArray(current.options_bg) && current.options_bg.length > 0 ? current.options_bg : fallback.options_bg,\n    attribute_type:\n      current.attribute_type === 'text' && fallback.attribute_type !== 'text'\n        ? fallback.attribute_type\n        : current.attribute_type,\n  }\n}\n\nexport async function resolveCategoryId(\n  supabase: SupabaseClient<Database>,\n  slugOrId: string,\n): Promise<string | null> {\n  if (!slugOrId) return null\n  if (isUuid(slugOrId)) return slugOrId\n\n  const { data, error } = await supabase\n    .from('categories')\n    .select('id')\n    .eq('slug', slugOrId)\n    .maybeSingle()\n\n  if (error || !data?.id) return null\n  return data.id\n}\n\nexport async function getCategoryAncestorIds(\n  supabase: SupabaseClient<Database>,\n  categoryId: string,\n  maxDepth: number = MAX_ANCESTOR_DEPTH,\n): Promise<string[]> {\n  const ancestorIds: string[] = [categoryId]\n  let currentId: string | null = categoryId\n\n  for (let i = 0; i < maxDepth && currentId; i++) {\n    const response = await supabase\n      .from('categories')\n      .select('parent_id')\n      .eq('id', currentId)\n      .maybeSingle()\n\n    if (response.error) break\n    const data = response.data as { parent_id: string | null } | null\n    const parentId = data?.parent_id ?? null\n    if (!parentId) break\n\n    ancestorIds.push(parentId)\n    currentId = parentId\n  }\n\n  return ancestorIds\n}\n\nfunction shouldIncludeAttribute(params: {\n  attr: CategoryAttribute\n  categoryId: string\n  includeParents: boolean\n  includeGlobal: boolean\n}): boolean {\n  const { attr, categoryId, includeParents, includeGlobal } = params\n  const scope = normalizeInheritScope(attr.inherit_scope, attr.category_id)\n\n  if (attr.category_id === categoryId) return true\n\n  if (!includeParents && attr.category_id !== categoryId) return false\n\n  if (attr.category_id === null) {\n    return includeGlobal && scope === 'global'\n  }\n\n  return scope === 'inherit' || scope === 'global'\n}\n\nexport async function resolveCategoryAttributesWithClient(\n  supabase: SupabaseClient<Database>,\n  categoryId: string,\n  {\n    includeParents = true,\n    includeGlobal = true,\n    filterableOnly = false,\n  }: { includeParents?: boolean; includeGlobal?: boolean; filterableOnly?: boolean } = {},\n): Promise<{ attributes: CategoryAttribute[]; ancestorIds: string[] }> {\n  const ancestorIds = includeParents\n    ? await getCategoryAncestorIds(supabase, categoryId)\n    : [categoryId]\n\n  const scopedQuery = supabase\n    .from('category_attributes')\n    .select(CATEGORY_ATTRIBUTES_SELECT)\n    .in('category_id', ancestorIds)\n\n  const scopedResult = filterableOnly ? scopedQuery.eq('is_filterable', true) : scopedQuery\n  const { data: scopedRows, error: scopedError } = await scopedResult.order('sort_order')\n  if (scopedError) {\n    return { attributes: [], ancestorIds }\n  }\n\n  let globalRows: CategoryAttributeRow[] = []\n  if (includeGlobal) {\n    const globalQuery = supabase\n      .from('category_attributes')\n      .select(CATEGORY_ATTRIBUTES_SELECT)\n      .is('category_id', null)\n\n    const globalResult = filterableOnly ? globalQuery.eq('is_filterable', true) : globalQuery\n    const { data: globalData } = await globalResult.order('sort_order')\n    globalRows = (globalData || []) as CategoryAttributeRow[]\n  }\n\n  const rawAttributes = [...(scopedRows || []), ...globalRows].map(toCategoryAttribute)\n  const filtered = rawAttributes.filter((attr) =>\n    shouldIncludeAttribute({ attr, categoryId, includeParents, includeGlobal })\n  )\n\n  const depthByCategoryId = new Map<string, number>()\n  ancestorIds.forEach((id, index) => depthByCategoryId.set(id, index))\n\n  const inheritedSorted = [...filtered]\n    .filter((attr) => attr.category_id !== categoryId)\n    .sort((a, b) => {\n      const da = depthByCategoryId.get(a.category_id ?? '') ?? 9999\n      const db = depthByCategoryId.get(b.category_id ?? '') ?? 9999\n      if (da !== db) return db - da\n      return (a.sort_order ?? 999) - (b.sort_order ?? 999)\n    })\n\n  const attrMap = new Map<string, CategoryAttribute & { isOwn: boolean }>()\n\n  for (const attr of inheritedSorted) {\n    const key = getCategoryAttributeMapKey(attr)\n    const existing = attrMap.get(key)\n    attrMap.set(key, {\n      ...(existing ? withFallbackOptions(attr, existing) : attr),\n      isOwn: false,\n    })\n  }\n\n  for (const attr of filtered.filter((item) => item.category_id === categoryId)) {\n    const key = getCategoryAttributeMapKey(attr)\n    const existing = attrMap.get(key)\n    attrMap.set(key, {\n      ...(existing ? withFallbackOptions(attr, existing) : attr),\n      isOwn: true,\n    })\n  }\n\n  const attributes = [...attrMap.values()]\n    .sort((a, b) => {\n      if (a.isOwn && !b.isOwn) return -1\n      if (!a.isOwn && b.isOwn) return 1\n      return (a.sort_order ?? 999) - (b.sort_order ?? 999)\n    })\n    .map(({ isOwn: _isOwn, ...attr }) => attr as CategoryAttribute)\n\n  return { attributes, ancestorIds }\n}\n\nexport async function resolveCategoryAttributes(params: {\n  slugOrId: string\n  includeParents?: boolean\n  includeGlobal?: boolean\n  filterableOnly?: boolean\n}): Promise<{ categoryId: string | null; attributes: CategoryAttribute[]; ancestorIds: string[] }> {\n  const {\n    slugOrId,\n    includeParents = true,\n    includeGlobal = true,\n    filterableOnly = false,\n  } = params\n  const supabase = createStaticClient()\n  const categoryId = await resolveCategoryId(supabase, slugOrId)\n\n  if (!categoryId) {\n    return { categoryId: null, attributes: [], ancestorIds: [] }\n  }\n\n  const { attributes, ancestorIds } = await resolveCategoryAttributesWithClient(supabase, categoryId, {\n    includeParents,\n    includeGlobal,\n    filterableOnly,\n  })\n\n  return { categoryId, attributes, ancestorIds }\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\data\\plans.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\data\\product-page.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\data\\product-reviews.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\data\\products.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getProductById' is defined but never used.","line":424,"column":16,"nodeType":"Identifier","messageId":"unusedVar","endLine":424,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'filterByZone' is defined but never used.","line":452,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":452,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'toCarouselProducts' is defined but never used.","line":611,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":611,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getGlobalDeals' is assigned a value but never used.","line":647,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":647,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getPromoProducts' is assigned a value but never used.","line":649,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":649,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getBestSellers' is assigned a value but never used.","line":650,"column":7,"nodeType":"Identifier","messageId":"unusedVar","endLine":650,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import 'server-only'\r\n\r\nimport { cacheTag, cacheLife } from 'next/cache'\r\nimport { createStaticClient } from '@/lib/supabase/server'\r\nimport { logger } from '@/lib/logger'\r\nimport { getShippingFilter, productShipsToRegion, type ShippingRegion } from '@/lib/shipping'\r\nimport { normalizeAttributeKey } from '@/lib/attributes/normalize-attribute-key'\r\nimport {\r\n  PRODUCT_BY_ID_SELECT,\r\n  PRODUCT_LIST_BY_CATEGORY_SLUG_SELECT,\r\n  PRODUCT_LIST_SELECT,\r\n} from '@/lib/supabase/selects/products'\r\nimport type { UIProduct } from '@/lib/types/products'\r\n\r\nexport type { UIProduct }\r\n\r\n// =============================================================================\r\n// Types - Minimal, practical types\r\n// =============================================================================\r\n\r\nexport interface Product {\r\n  id: string\r\n  title: string\r\n  price: number\r\n  seller_id?: string | null\r\n  list_price?: number | null\r\n  is_on_sale?: boolean | null\r\n  sale_percent?: number | null\r\n  sale_end_date?: string | null\r\n  rating?: number | null\r\n  review_count?: number | null\r\n  images: string[] | null\r\n  product_images?: Array<{\r\n    image_url: string\r\n    thumbnail_url?: string | null\r\n    display_order?: number | null\r\n    is_primary?: boolean | null\r\n  }> | null\r\n  /** True if product has a boost flag; check `boost_expires_at` for active boost status. */\r\n  is_boosted?: boolean | null\r\n  /** Boost expiration timestamp - used with is_boosted to determine active boost status */\r\n  boost_expires_at?: string | null\r\n  /** @deprecated Legacy field - not used. For promoted listings, use is_boosted + boost_expires_at */\r\n  is_featured?: boolean | null\r\n  created_at?: string | null\r\n  ships_to_bulgaria?: boolean | null\r\n  ships_to_uk?: boolean | null\r\n  ships_to_europe?: boolean | null\r\n  ships_to_usa?: boolean | null\r\n  ships_to_worldwide?: boolean | null\r\n  pickup_only?: boolean | null\r\n  free_shipping?: boolean | null\r\n  seller_city?: string | null\r\n  category_slug?: string | null\r\n  slug?: string | null\r\n  store_slug?: string | null\r\n  /** \r\n   * Embedded leaf category with parent chain (up to 4 levels).\r\n   * Supabase nested selects return parents as arrays, but the normalizeCategoryNode\r\n   * function handles both single objects and arrays, so we accept unknown here.\r\n   */\r\n  categories?: {\r\n    id?: string\r\n    slug?: string\r\n    name?: string\r\n    name_bg?: string | null\r\n    icon?: string | null\r\n    parent?: unknown // Supabase returns array[], normalizeCategoryNode handles both\r\n  } | null\r\n  seller_profile?: {\r\n    id?: string | null\r\n    username?: string | null\r\n    display_name?: string | null\r\n    business_name?: string | null\r\n    avatar_url?: string | null\r\n    tier?: string | null\r\n    account_type?: string | null\r\n    is_verified_business?: boolean | null\r\n    // Verification fields from user_verification join\r\n    email_verified?: boolean | null\r\n    phone_verified?: boolean | null\r\n    id_verified?: boolean | null\r\n  } | null\r\n  /** Product attributes - Json from DB, we accept any */\r\n  attributes?: import(\"@/lib/supabase/database.types\").Json | null\r\n  product_attributes?: Array<{\r\n    name: string\r\n    value: string\r\n  }> | null\r\n}\r\n\r\n/**\r\n * Public browsing surfaces must not show non-active listings.\r\n *\r\n * Temporary legacy allowance:\r\n * - Some older rows may have `status = NULL`; treat them as \"active\" until a cleanup pass\r\n *   normalizes them. (PROD-DATA-002)\r\n */\r\nfunction applyPublicProductVisibilityFilter<Q extends { or: (filters: string) => Q }>(q: Q): Q {\r\n  return q.or('status.eq.active,status.is.null')\r\n}\r\n\r\nfunction normalizeCategoryNode(input: unknown): Product['categories'] {\r\n  if (!input) return null\r\n\r\n  const node = Array.isArray(input) ? input[0] : input\r\n  if (!node || typeof node !== 'object') return null\r\n\r\n  const raw = node as Record<string, unknown>\r\n\r\n  const parent = raw.parent\r\n  const normalizedParent = parent ? normalizeCategoryNode(parent) : null\r\n\r\n  return {\r\n    ...(typeof raw.id === 'string' ? { id: raw.id } : {}),\r\n    ...(typeof raw.slug === 'string' ? { slug: raw.slug } : {}),\r\n    ...(typeof raw.name === 'string' ? { name: raw.name } : {}),\r\n    ...(typeof raw.name_bg === 'string' || raw.name_bg === null ? { name_bg: raw.name_bg as string | null } : {}),\r\n    ...(typeof raw.icon === 'string' || raw.icon === null ? { icon: raw.icon as string | null } : {}),\r\n    ...(normalizedParent ? { parent: normalizedParent } : {}),\r\n  }\r\n}\r\n\r\n/**\r\n * Maps raw DB row to Product with normalized fields.\r\n * Extracted to avoid duplication across getProducts/getProductsByCategorySlug.\r\n */\r\nfunction mapRowToProduct(p: unknown): Product {\r\n  const row = p as unknown as Record<string, unknown>\r\n  const categories = normalizeCategoryNode(row.categories)\r\n  const seller = (row.seller && typeof row.seller === 'object') ? (row.seller as Record<string, unknown>) : null\r\n  // Extract nested user_verification from seller\r\n  const uv = (seller?.user_verification && typeof seller.user_verification === 'object')\r\n    ? (Array.isArray(seller.user_verification) ? seller.user_verification[0] : seller.user_verification) as Record<string, unknown>\r\n    : null\r\n\r\n  const rawProduct = p as unknown as { is_boosted?: boolean | null }\r\n\r\n  return {\r\n    ...(p as unknown as Product),\r\n    is_boosted: rawProduct.is_boosted ?? null,\r\n    categories,\r\n    category_slug: categories?.slug ?? null,\r\n    store_slug: (typeof seller?.username === 'string') ? (seller.username as string) : null,\r\n    seller_profile: {\r\n      ...(seller as Product['seller_profile']),\r\n      email_verified: uv?.email_verified === true ? true : null,\r\n      phone_verified: uv?.phone_verified === true ? true : null,\r\n      id_verified: uv?.id_verified === true ? true : null,\r\n    },\r\n  } as Product\r\n}\r\n\r\nfunction buildCategoryPath(\r\n  leaf: Product['categories']\r\n): { slug: string; name: string; nameBg?: string | null; icon?: string | null }[] | undefined {\r\n  if (!leaf) return undefined\r\n\r\n  const out: { slug: string; name: string; nameBg?: string | null; icon?: string | null }[] = []\r\n\r\n  let current: Product['categories'] | null | undefined = leaf\r\n  // Guard against cycles / absurd depth.\r\n  for (let i = 0; i < 8 && current; i++) {\r\n    if (typeof current.slug === 'string' && typeof current.name === 'string') {\r\n      out.push({\r\n        slug: current.slug,\r\n        name: current.name,\r\n        ...(current.name_bg != null ? { nameBg: current.name_bg } : {}),\r\n        ...(current.icon != null ? { icon: current.icon } : {}),\r\n      })\r\n    }\r\n    current = (current.parent as Product['categories'] | null | undefined) ?? null\r\n  }\r\n\r\n  out.reverse()\r\n  return out.length ? out : undefined\r\n}\r\n\r\nfunction buildAttributesMap(p: Product): Record<string, string> {\r\n  const map: Record<string, string> = {}\r\n\r\n  // products.attributes jsonb (fast filtering source)\r\n  const raw = (p.attributes && typeof p.attributes === 'object' && !Array.isArray(p.attributes))\r\n    ? (p.attributes as Record<string, unknown>)\r\n    : {}\r\n\r\n  for (const [k, v] of Object.entries(raw)) {\r\n    if (v == null) continue\r\n    const key = normalizeAttributeKey(k)\r\n    if (!key) continue\r\n    if (typeof v === 'string') map[key] = v\r\n    else if (typeof v === 'number' || typeof v === 'boolean') map[key] = String(v)\r\n  }\r\n\r\n  // product_attributes rows (canonical item specifics)\r\n  for (const row of p.product_attributes ?? []) {\r\n    if (!row?.name || !row?.value) continue\r\n    const key = normalizeAttributeKey(row.name)\r\n    if (!key) continue\r\n    // Prefer explicit row values over jsonb when both exist\r\n    map[key] = row.value\r\n  }\r\n\r\n  // Aliases / common synonyms for UI\r\n  if (!map.condition && map.fashion_condition) map.condition = map.fashion_condition\r\n  if (!map.year && map.model_year) map.year = map.model_year\r\n  if (!map.mileage_km && map.mileage) map.mileage_km = map.mileage\r\n  if (!map.mileage && map.mileage_km) map.mileage = map.mileage_km\r\n  if (!map.size && map.clothing_size) map.size = map.clothing_size\r\n\r\n  return map\r\n}\r\n\r\nfunction pickPrimaryImage(p: Product): string {\r\n  const fromTable = (p.product_images ?? [])\r\n    .filter((img) => !!img?.image_url)\r\n    .sort((a, b) => {\r\n      const ap = a.is_primary ? 1 : 0\r\n      const bp = b.is_primary ? 1 : 0\r\n      if (ap !== bp) return bp - ap\r\n      const ao = a.display_order ?? 0\r\n      const bo = b.display_order ?? 0\r\n      return ao - bo\r\n    })\r\n\r\n  const firstUrl = fromTable[0]?.image_url\r\n  if (firstUrl) return firstUrl\r\n  return p.images?.[0] || '/placeholder.svg'\r\n}\r\n\r\n// =============================================================================\r\n// Core Cached Queries - Simple, DRY\r\n// =============================================================================\r\n\r\ntype QueryType = 'deals' | 'newest' | 'bestsellers' | 'featured' | 'promo'\r\n\r\n/**\r\n * Fetch products with stable ordering for caching.\r\n * NO new Date() inside - deterministic output for ISR.\r\n */\r\ntype LimitableResult<T> = { data: T[] | null; error: unknown | null }\r\ntype LimitableQuery<T> = PromiseLike<LimitableResult<T>> & {\r\n  limit: (count: number) => LimitableQuery<T>\r\n  order: (column: string, options: { ascending: boolean; nullsFirst?: boolean }) => LimitableQuery<T>\r\n}\r\n\r\nasync function fetchProductsStable<T, Q extends LimitableQuery<T>>(\r\n  makeQuery: () => Q,\r\n  {\r\n    limit,\r\n    applySecondaryOrder,\r\n  }: {\r\n    limit: number\r\n    applySecondaryOrder: (q: Q) => Q\r\n  }\r\n): Promise<{ data: T[]; error: unknown | null }> {\r\n  // Stable query: order by secondary criteria only, include boost fields for post-cache sorting\r\n  const query = applySecondaryOrder(makeQuery())\r\n  const { data, error } = await query.limit(limit)\r\n  \r\n  if (error) return { data: [], error }\r\n  return { data: data ?? [], error: null }\r\n}\r\n\r\n/**\r\n * Cached category query.\r\n * Mirrors `getProducts` but filters by `categories.slug`.\r\n */\r\nexport async function getProductsByCategorySlug(\r\n  categorySlug: string,\r\n  limit = 18,\r\n  zone?: ShippingRegion\r\n): Promise<Product[]> {\r\n  'use cache'\r\n  cacheTag('products:list', `products:category:${categorySlug}`)\r\n  cacheLife('products')\r\n  try {\r\n    const supabase = createStaticClient()\r\n    // NOTE: NO new Date() here - would cause ISR write storm per Vercel docs\r\n\r\n    const makeBaseQuery = () => {\r\n      // OPTIMIZED: Flat category join - no 4-level nesting!\r\n      // Use getCategoryPath() separately when breadcrumbs are needed.\r\n      // Note: user_verification joins to profiles via user_id, and we join profiles via seller_id\r\n      let q = supabase\r\n        .from('products')\r\n        .select(PRODUCT_LIST_BY_CATEGORY_SLUG_SELECT)\r\n        .eq('categories.slug', categorySlug)\r\n\r\n      q = applyPublicProductVisibilityFilter(q)\r\n\r\n      // Apply shipping zone filter (WW = show all, so no filter)\r\n      if (zone && zone !== 'WW') {\r\n        const shippingFilter = getShippingFilter(zone)\r\n        if (shippingFilter) {\r\n          q = q.or(shippingFilter)\r\n        }\r\n      }\r\n\r\n      return q\r\n    }\r\n\r\n    const { data, error } = await fetchProductsStable(makeBaseQuery, {\r\n      limit,\r\n      applySecondaryOrder: (q) => q.order('created_at', { ascending: false }),\r\n    })\r\n\r\n    if (error) {\r\n      logger.error(`[getProductsByCategorySlug:${categorySlug}] Supabase error`, error)\r\n      return []\r\n    }\r\n\r\n    // Map to Product type - boost sorting happens post-cache by caller if needed\r\n    return (data || []).map(mapRowToProduct)\r\n  } catch (error) {\r\n    logger.error(`[getProductsByCategorySlug:${categorySlug}] Unexpected error`, error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Single cached function for all product queries.\r\n * Optional zone filtering is applied at the DB query level.\r\n */\r\nexport async function getProducts(type: QueryType, limit = 36, zone?: ShippingRegion): Promise<Product[]> {\r\n  'use cache'\r\n  cacheTag('products:list', `products:type:${type}`)\r\n  cacheLife(type === 'deals' ? 'deals' : 'products')\r\n  try {\r\n    const supabase = createStaticClient()\r\n    // NOTE: NO new Date() here - would cause ISR write storm per Vercel docs\r\n\r\n    const makeBaseQuery = () => {\r\n      // OPTIMIZED: Flat category join - no 4-level nesting!\r\n      // Use getCategoryPath() separately when breadcrumbs are needed.\r\n      // Note: user_verification joins to profiles via user_id, and we join profiles via seller_id\r\n      let q =\r\n        type === 'deals'\r\n          ? supabase.from('deal_products').select(PRODUCT_LIST_SELECT)\r\n          : supabase.from('products').select(PRODUCT_LIST_SELECT)\r\n\r\n      q = applyPublicProductVisibilityFilter(q)\r\n\r\n      // Apply shipping zone filter (WW = show all, so no filter)\r\n      if (zone && zone !== 'WW') {\r\n        const shippingFilter = getShippingFilter(zone)\r\n        if (shippingFilter) {\r\n          q = q.or(shippingFilter)\r\n        }\r\n      }\r\n\r\n      // Apply type filters (but no boost ordering here)\r\n      switch (type) {\r\n        case 'deals':\r\n          // Canonical semantics live in the `deal_products` view.\r\n          break\r\n        case 'promo':\r\n          // Legacy \"promo\" uses compare-at pricing.\r\n          q = q.not('list_price', 'is', null).gt('list_price', 0)\r\n          break\r\n        case 'featured':\r\n          // Include boosted products - active filtering happens post-cache\r\n          // to avoid ISR write storms from new Date()\r\n          q = q.eq('is_boosted', true).not('boost_expires_at', 'is', null)\r\n          break\r\n      }\r\n\r\n      return q\r\n    }\r\n\r\n    type ProductListQuery = ReturnType<typeof makeBaseQuery>\r\n\r\n    const applySecondaryOrder = (q: ProductListQuery) => {\r\n      switch (type) {\r\n        case 'newest':\r\n          return q.order('created_at', { ascending: false })\r\n        case 'bestsellers':\r\n          return q.order('review_count', { ascending: false })\r\n        case 'deals':\r\n          // Prefer the biggest savings first (view computes effective_discount).\r\n          return q\r\n            .order('effective_discount', { ascending: false, nullsFirst: false })\r\n            .order('created_at', { ascending: false })\r\n        case 'featured':\r\n          // Fair rotation of active boosts\r\n          return q.order('boost_expires_at', { ascending: true })\r\n        default:\r\n          return q\r\n      }\r\n    }\r\n\r\n    // All types use stable fetch - no new Date() in cache\r\n    // Boost priority sorting happens post-cache by caller if needed\r\n    const { data, error } =\r\n      type === 'featured' || type === 'newest'\r\n        ? await applySecondaryOrder(makeBaseQuery()).limit(limit)\r\n        : await fetchProductsStable(makeBaseQuery, {\r\n            limit,\r\n            applySecondaryOrder,\r\n          })\r\n\r\n    if (error) {\r\n      logger.error(`[getProducts:${type}] Supabase error`, error)\r\n      return []\r\n    }\r\n\r\n    // Map to Product type\r\n    // NOTE: For 'featured' type, caller must filter expired boosts post-cache (boost_expires_at > now).\r\n    // This keeps the cache deterministic (no new Date() in output)\r\n    return (data || [])\r\n      .map(mapRowToProduct)\r\n      .filter((p: Product) =>\r\n        type === 'deals' || type === 'promo'\r\n          ? (p.list_price ?? 0) > p.price\r\n          : true\r\n      )\r\n  } catch (error) {\r\n    logger.error(`[getProducts:${type}] Unexpected error`, error)\r\n    return []\r\n  }\r\n}\r\n\r\n/** Fetch single product by ID */\r\nasync function getProductById(id: string): Promise<Product | null> {\r\n  'use cache'\r\n  cacheTag(`product:${id}`)\r\n  cacheLife('products')\r\n\r\n  const supabase = createStaticClient()\r\n\r\n  const { data, error } = await supabase\r\n    .from('products')\r\n    .select(PRODUCT_BY_ID_SELECT)\r\n    .eq('id', id)\r\n    .or('status.eq.active,status.is.null')\r\n    .single()\r\n\r\n  if (error) return null\r\n  return data\r\n}\r\n\r\n// =============================================================================\r\n// Utilities\r\n// =============================================================================\r\n\r\nexport type ShippingZone = 'BG' | 'UK' | 'EU' | 'US' | 'WW'\r\n\r\n/** \r\n * Filter products by shipping zone.\r\n * Can be used server-side or client-side.\r\n */\r\nfunction filterByZone<T extends {\r\n  ships_to_bulgaria?: boolean | null\r\n  ships_to_uk?: boolean | null\r\n  ships_to_europe?: boolean | null\r\n  ships_to_usa?: boolean | null\r\n  ships_to_worldwide?: boolean | null\r\n  pickup_only?: boolean | null\r\n}>(\r\n  products: T[],\r\n  zone: ShippingZone,\r\n  limit?: number\r\n): T[] {\r\n  if (zone === 'WW') return limit ? products.slice(0, limit) : products\r\n\r\n  const filtered = products.filter(p => productShipsToRegion(p, zone as ShippingRegion))\r\n  return limit ? filtered.slice(0, limit) : filtered\r\n}\r\n\r\n/**\r\n * Normalize raw Supabase query row to Product type.\r\n * This helper reduces duplication across API routes by handling the\r\n * common field mapping (seller -> seller_profile, categories.slug -> category_slug, etc.)\r\n */\r\nexport function normalizeProductRow(p: {\r\n  id: string\r\n  title: string\r\n  price: number\r\n  created_at?: string | null\r\n  seller_id?: string | null\r\n  list_price?: number | null\r\n  is_on_sale?: boolean | null\r\n  sale_percent?: number | null\r\n  sale_end_date?: string | null\r\n  rating?: number | null\r\n  review_count?: number | null\r\n  images?: string[] | null\r\n  free_shipping?: boolean | null\r\n  seller_city?: string | null\r\n  product_images?: Array<{\r\n    image_url: string\r\n    thumbnail_url?: string | null\r\n    display_order?: number | null\r\n    is_primary?: boolean | null\r\n  }> | null\r\n  product_attributes?: Array<{ name: string; value: string }> | null\r\n  is_boosted?: boolean | null\r\n  boost_expires_at?: string | null\r\n  slug?: string | null\r\n  attributes?: unknown\r\n  seller?: {\r\n    id?: string | null\r\n    username?: string | null\r\n    display_name?: string | null\r\n    business_name?: string | null\r\n    avatar_url?: string | null\r\n    tier?: string | null\r\n    account_type?: string | null\r\n    is_verified_business?: boolean | null\r\n  } | null\r\n  categories?: {\r\n    id?: string\r\n    slug?: string\r\n    name?: string\r\n    name_bg?: string | null\r\n    icon?: string | null\r\n    parent?: unknown\r\n  } | null\r\n}): Product {\r\n  const result: Product = {\r\n    id: p.id,\r\n    title: p.title,\r\n    price: p.price,\r\n    created_at: p.created_at ?? null,\r\n    seller_id: p.seller_id ?? null,\r\n    list_price: p.list_price ?? null,\r\n    is_on_sale: p.is_on_sale ?? null,\r\n    sale_percent: p.sale_percent ?? null,\r\n    sale_end_date: p.sale_end_date ?? null,\r\n    rating: p.rating ?? null,\r\n    review_count: p.review_count ?? null,\r\n    images: p.images ?? null,\r\n    free_shipping: p.free_shipping ?? null,\r\n    seller_city: p.seller_city ?? null,\r\n    product_images: p.product_images ?? null,\r\n    product_attributes: p.product_attributes ?? null,\r\n    // NOTE: This is a raw flag. Active boost status depends on `boost_expires_at` vs \"now\",\r\n    // and must be computed outside cached functions to keep cache output deterministic.\r\n    is_boosted: p.is_boosted ?? null,\r\n    boost_expires_at: p.boost_expires_at ?? null,\r\n    slug: p.slug ?? null,\r\n    store_slug: p.seller?.username ?? null,\r\n    category_slug: p.categories?.slug ?? null,\r\n    categories: p.categories ?? null,\r\n    seller_profile: p.seller ?? null,\r\n  }\r\n  // Handle optional attributes separately to satisfy exactOptionalPropertyTypes\r\n  const attrs = p.attributes\r\n  if (attrs != null) {\r\n    (result as { attributes: typeof attrs }).attributes = attrs\r\n  }\r\n  return result\r\n}\r\n\r\n/** Transform to UI format */\r\nexport function toUI(p: Product): UIProduct {\r\n  const attrs = buildAttributesMap(p)\r\n  const sellerDisplayName = p.seller_profile?.display_name || p.seller_profile?.business_name || p.seller_profile?.username || null\r\n  const rawTier = (p.seller_profile?.tier || '').toLowerCase()\r\n  const accountType = (p.seller_profile?.account_type || '').toLowerCase()  \r\n  const sellerTier: UIProduct['sellerTier'] =\r\n    accountType === 'business' ? 'business' :\r\n    rawTier === 'premium' ? 'premium' :\r\n    rawTier === 'business' ? 'business' :\r\n    'basic'\r\n  const sellerVerified = Boolean(p.seller_profile?.is_verified_business)\r\n\r\n  const categoryPath = buildCategoryPath(p.categories)\r\n  const categoryRootSlug = categoryPath?.[0]?.slug\r\n\r\n  return {\r\n    id: p.id,\r\n    title: p.title,\r\n    price: p.price,\r\n    ...(typeof p.created_at === \"string\" ? { createdAt: p.created_at } : {}),\r\n    ...(typeof p.list_price === \"number\" ? { listPrice: p.list_price } : {}),\r\n    ...(typeof p.is_on_sale === \"boolean\" ? { isOnSale: p.is_on_sale } : {}),\r\n    ...(typeof p.sale_percent === \"number\" ? { salePercent: p.sale_percent } : {}),\r\n    saleEndDate: p.sale_end_date ?? null,\r\n    isBoosted: Boolean(p.is_boosted),\r\n    boostExpiresAt: p.boost_expires_at ?? null,\r\n    image: pickPrimaryImage(p),\r\n    rating: p.rating ?? 0,\r\n    reviews: p.review_count ?? 0,\r\n    ...(p.category_slug ? { categorySlug: p.category_slug } : {}),\r\n    ...(categoryRootSlug ? { categoryRootSlug } : {}),\r\n    ...(categoryPath ? { categoryPath } : {}),\r\n    slug: p.slug ?? null,\r\n    storeSlug: p.store_slug ?? null,\r\n    sellerId: p.seller_id ?? p.seller_profile?.id ?? null,\r\n    sellerName: sellerDisplayName,\r\n    sellerAvatarUrl: p.seller_profile?.avatar_url ?? null,\r\n    sellerTier,\r\n    sellerVerified,\r\n    sellerEmailVerified: p.seller_profile?.email_verified ?? false,\r\n    sellerPhoneVerified: p.seller_profile?.phone_verified ?? false,\r\n    sellerIdVerified: p.seller_profile?.id_verified ?? false,\r\n    freeShipping: p.free_shipping === true,\n    ...(Object.keys(attrs).length ? { attributes: attrs } : {}),\r\n    ...(typeof attrs.condition === \"string\" ? { condition: attrs.condition } : {}),\r\n    ...(typeof attrs.brand === \"string\" ? { brand: attrs.brand } : {}),\r\n    ...(typeof attrs.make === \"string\" ? { make: attrs.make } : {}),\r\n    ...(typeof attrs.model === \"string\" ? { model: attrs.model } : {}),\r\n    ...(typeof attrs.year === \"string\" ? { year: attrs.year } : {}),\r\n    // Use attrs.location first, fall back to seller_city\r\n    ...((typeof attrs.location === \"string\" ? { location: attrs.location } : p.seller_city ? { location: p.seller_city } : {})),\r\n  }\r\n}\r\n\r\n/** Transform Product array to CarouselProduct format for carousel sections */\r\nfunction toCarouselProducts(products: Product[], options?: { isBoosted?: boolean }): {\r\n  id: string\r\n  title: string\r\n  price: number\r\n  listPrice?: number\r\n  isBoosted?: boolean\r\n  image: string\r\n  rating?: number\r\n  reviews?: number\r\n  slug?: string | null\r\n  storeSlug?: string | null\r\n  location?: string\r\n}[] {\r\n  return products.map((p) => {\r\n    const ui = toUI(p)\r\n    const isBoosted = Boolean(options?.isBoosted ?? ui.isBoosted)\r\n    return {\r\n      id: ui.id,\r\n      title: ui.title,\r\n      price: ui.price,\r\n      ...(ui.listPrice !== undefined ? { listPrice: ui.listPrice } : {}),\r\n      isBoosted,\r\n      image: ui.image,\r\n      rating: ui.rating,\r\n      reviews: ui.reviews,\r\n      slug: ui.slug ?? null,\r\n      storeSlug: ui.storeSlug ?? null,\r\n      ...(ui.location ? { location: ui.location } : {}),\r\n    }\r\n  })\r\n}\r\n\r\n// =============================================================================\r\n// Legacy Exports - For backward compatibility (remove after migration)\r\n// =============================================================================\r\n\r\nconst getGlobalDeals = (limit = 50, zone?: ShippingRegion) => getProducts('deals', limit, zone)\r\nexport const getNewestProducts = (limit = 36, zone?: ShippingRegion) => getProducts('newest', limit, zone)\r\nconst getPromoProducts = (limit = 36, zone?: ShippingRegion) => getProducts('promo', limit, zone)\r\nconst getBestSellers = (limit = 36, zone?: ShippingRegion) => getProducts('bestsellers', limit, zone)\r\n\r\n// =============================================================================\r\n// Homepage Curated Sections - Fetchers for category rows\r\n// =============================================================================\r\n\r\n/**\r\n * Get products currently on sale (deals/promo).\r\n * Used for \"Today's Offers\" section on homepage.\r\n */\r\nexport async function getDealsProducts(limit = 10, zone?: ShippingRegion): Promise<Product[]> {\r\n  return getProducts('deals', limit, zone)\r\n}\r\n\r\n/**\r\n * Get products for a specific root category (L0).\r\n * Used for category-specific homepage sections like \"Trending in Fashion\".\r\n */\r\nexport async function getCategoryRowProducts(\r\n  categorySlug: string,\r\n  limit = 10,\r\n  zone?: ShippingRegion\r\n): Promise<Product[]> {\r\n  return getProductsByCategorySlug(categorySlug, limit, zone)\r\n}\r\n\r\n/**\r\n * Get products eligible for the \"Promoted\" section.\r\n *\r\n * NOTE: This function must stay safe for static prerendering (no `new Date()` in RSC).\r\n * Expired boosts are filtered client-side where \"current time\" is allowed.\r\n */\r\nexport async function getBoostedProducts(limit = 36, zone?: ShippingRegion): Promise<Product[]> {\r\n  const products = await getProducts('featured', limit * 2, zone)\r\n  return products.filter((p) => Boolean(p.is_boosted) && Boolean(p.boost_expires_at)).slice(0, limit)\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\data\\profile-page.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\env.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\feature-flags.ts","messages":[{"ruleId":"unicorn/prefer-string-slice","severity":1,"message":"Prefer `String#slice()` over `String#substring()`.","line":109,"column":12,"nodeType":"CallExpression","messageId":"substring","endLine":109,"endColumn":51,"fix":{"range":[4028,4039],"text":"slice(2"}},{"ruleId":"unicorn/prefer-string-slice","severity":1,"message":"Prefer `String#slice()` over `String#substring()`.","line":116,"column":31,"nodeType":"CallExpression","messageId":"substring","endLine":116,"endColumn":74,"fix":{"range":[4226,4235],"text":"slice"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":2,"source":"/**\n * Feature Flags System\n * \n * Centralized feature flags for gradual rollout of new features.\n * Supports env-based overrides and percentage-based rollouts.\n * \n * Usage:\n *   import { isFeatureEnabled, getFeatureFlags } from \"@/lib/feature-flags\"\n *   \n *   if (isFeatureEnabled(\"drawerSystem\")) {\n *     // Use new drawer system\n *   }\n */\n\nimport \"client-only\"\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\nexport type FeatureFlagName =\n  | \"drawerSystem\"           // Mobile drawer UX (product quick view, cart, messages, account)\n  | \"drawerProductQuickView\" // Product quick view drawer specifically\n  | \"drawerCart\"             // Cart drawer\n  | \"drawerMessages\"         // Messages drawer\n  | \"drawerAccount\"          // Account drawer\n  | \"drawerAuth\"             // Auth drawer\n\r\nexport interface FeatureFlag {\r\n  /** Whether the feature is enabled by default */\r\n  enabled: boolean\r\n  /** Percentage of users to enable (0-100). Only applies if enabled=true */\r\n  rolloutPercentage: number\r\n  /** Environment variable override name */\r\n  envOverride?: string\r\n  /** Description of what this flag controls */\r\n  description: string\r\n}\r\n\r\n// =============================================================================\r\n// FLAG DEFINITIONS\r\n// =============================================================================\r\n\r\nconst FEATURE_FLAGS: Record<FeatureFlagName, FeatureFlag> = {\n  drawerSystem: {\n    enabled: true,\n    rolloutPercentage: 100, // Full rollout\n    envOverride: \"NEXT_PUBLIC_FEATURE_DRAWER_SYSTEM\",\n    description: \"Enable the new mobile drawer UX system (product quick view, cart, messages, account drawers)\",\n  },\n  drawerProductQuickView: {\r\n    enabled: true,\r\n    rolloutPercentage: 100,\r\n    envOverride: \"NEXT_PUBLIC_FEATURE_DRAWER_PRODUCT_QUICK_VIEW\",\r\n    description: \"Enable product quick view drawer on mobile\",\r\n  },\r\n  drawerCart: {\r\n    enabled: true,\r\n    rolloutPercentage: 100,\r\n    envOverride: \"NEXT_PUBLIC_FEATURE_DRAWER_CART\",\r\n    description: \"Enable cart drawer on mobile\",\r\n  },\r\n  drawerMessages: {\r\n    enabled: true,\r\n    rolloutPercentage: 100,\r\n    envOverride: \"NEXT_PUBLIC_FEATURE_DRAWER_MESSAGES\",\r\n    description: \"Enable messages drawer on mobile\",\r\n  },\r\n  drawerAccount: {\n    enabled: true,\n    rolloutPercentage: 100,\n    envOverride: \"NEXT_PUBLIC_FEATURE_DRAWER_ACCOUNT\",\n    description: \"Enable account drawer on mobile\",\n  },\n  drawerAuth: {\n    enabled: true,\n    rolloutPercentage: 100,\n    envOverride: \"NEXT_PUBLIC_FEATURE_DRAWER_AUTH\",\n    description: \"Enable auth drawer on mobile\",\n  },\n}\n\n// =============================================================================\n// HELPERS\n// =============================================================================\n\n/**\n * Next.js only inlines `process.env.NEXT_PUBLIC_*` when accessed statically.\n * Dynamic access like `process.env[flag.envOverride]` will be `undefined` in\n * the browser bundle, causing SSR/client mismatches.\n *\n * Keep a single static map so env overrides work consistently in SSR + client.\n */\nconst PUBLIC_ENV_OVERRIDES: Record<string, string | undefined> = {\n  NEXT_PUBLIC_FEATURE_DRAWER_SYSTEM: process.env.NEXT_PUBLIC_FEATURE_DRAWER_SYSTEM,\n  NEXT_PUBLIC_FEATURE_DRAWER_PRODUCT_QUICK_VIEW: process.env.NEXT_PUBLIC_FEATURE_DRAWER_PRODUCT_QUICK_VIEW,\n  NEXT_PUBLIC_FEATURE_DRAWER_CART: process.env.NEXT_PUBLIC_FEATURE_DRAWER_CART,\n  NEXT_PUBLIC_FEATURE_DRAWER_MESSAGES: process.env.NEXT_PUBLIC_FEATURE_DRAWER_MESSAGES,\n  NEXT_PUBLIC_FEATURE_DRAWER_ACCOUNT: process.env.NEXT_PUBLIC_FEATURE_DRAWER_ACCOUNT,\n  NEXT_PUBLIC_FEATURE_DRAWER_AUTH: process.env.NEXT_PUBLIC_FEATURE_DRAWER_AUTH,\n}\n\n/**\n * Get a stable user identifier for percentage-based rollouts.\n * Uses localStorage in browser, falls back to random for SSR.\n */\nfunction getStableUserId(): string {\n  if (typeof window === \"undefined\") {\r\n    return Math.random().toString(36).substring(2)\r\n  }\r\n  \r\n  const storageKey = \"treido_feature_user_id\"\r\n  let userId = localStorage.getItem(storageKey)\r\n  \r\n  if (!userId) {\r\n    userId = `${Date.now()}-${Math.random().toString(36).substring(2, 15)}`\r\n    localStorage.setItem(storageKey, userId)\r\n  }\r\n  \r\n  return userId\r\n}\r\n\r\n/**\r\n * Hash a string to a number between 0-99 for percentage rollouts.\r\n * Uses simple djb2 hash for consistency.\r\n */\r\nfunction hashToPercentage(str: string, salt: string): number {\r\n  const combined = `${str}:${salt}`\r\n  let hash = 5381\r\n  for (let i = 0; i < combined.length; i++) {\r\n    hash = ((hash << 5) + hash) ^ combined.charCodeAt(i)\r\n  }\r\n  return Math.abs(hash) % 100\r\n}\r\n\r\n// =============================================================================\r\n// PUBLIC API\r\n// =============================================================================\r\n\r\n/**\r\n * Check if a feature flag is enabled.\r\n * \r\n * Priority order:\r\n * 1. Environment variable override (if set)\r\n * 2. Percentage-based rollout (if enabled)\r\n * 3. Default enabled state\r\n */\r\nexport function isFeatureEnabled(flagName: FeatureFlagName): boolean {\n  const flag = FEATURE_FLAGS[flagName]\n  \n  if (!flag) {\n    console.warn(`[FeatureFlags] Unknown flag: ${flagName}`)\n    return false\n  }\n\n  const isServer = typeof window === \"undefined\"\n  \n  // Check env override first\n  if (flag.envOverride) {\n    const envValue = PUBLIC_ENV_OVERRIDES[flag.envOverride]\n    if (envValue !== undefined) {\n      return envValue === \"true\" || envValue === \"1\"\n    }\n  }\n  \n  // If not enabled by default, return false\n  if (!flag.enabled) {\n    return false\n  }\n  \n  // Check percentage rollout\n  if (flag.rolloutPercentage < 100) {\n    // Avoid SSR/client mismatches: only apply percentage logic on the client.\n    if (isServer) return false\n    const userId = getStableUserId()\n    const userPercentile = hashToPercentage(userId, flagName)\n    return userPercentile < flag.rolloutPercentage\n  }\n  \r\n  // Fully enabled\n  return true\n}\n\n/**\n * Check if any drawer feature is enabled.\n * Shorthand for checking if drawer system should be initialized.\n */\nexport function isDrawerSystemEnabled(): boolean {\n  return isFeatureEnabled(\"drawerSystem\")\n}\n\r\n/**\r\n * Check which specific drawers are enabled.\r\n */\r\nexport function getEnabledDrawers() {\n  return {\n    productQuickView: isFeatureEnabled(\"drawerProductQuickView\"),\n    cart: isFeatureEnabled(\"drawerCart\"),\n    messages: isFeatureEnabled(\"drawerMessages\"),\n    account: isFeatureEnabled(\"drawerAccount\"),\n    auth: isFeatureEnabled(\"drawerAuth\"),\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\filters\\category-attribute.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\filters\\pending-attributes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\format-price.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\geolocation.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'canShipTo' is defined but never used.","line":164,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":164,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getShippingZoneFilter' is defined but never used.","line":208,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":208,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getShippingZoneInfo' is defined but never used.","line":216,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":216,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Geolocation and Shipping Zone Utilities\r\n * \r\n * This module provides utilities for:\r\n * - Country detection from IP headers\r\n * - Mapping countries to shipping zones\r\n * - Filtering products by shipping availability\r\n */\r\n\r\n// Country code to display name mapping\r\nexport const COUNTRY_NAMES: Record<string, string> = {\r\n    US: \"United States\",\r\n    GB: \"United Kingdom\",\r\n    CA: \"Canada\",\r\n    AU: \"Australia\",\r\n    DE: \"Germany\",\r\n    FR: \"France\",\r\n    ES: \"Spain\",\r\n    IT: \"Italy\",\r\n    JP: \"Japan\",\r\n    CN: \"China\",\r\n    IN: \"India\",\r\n    BR: \"Brazil\",\r\n    MX: \"Mexico\",\r\n    RU: \"Russia\",\r\n    ZA: \"South Africa\",\r\n    BG: \"Bulgaria\",\r\n    AT: \"Austria\",\r\n    BE: \"Belgium\",\r\n    HR: \"Croatia\",\r\n    CY: \"Cyprus\",\r\n    CZ: \"Czech Republic\",\r\n    DK: \"Denmark\",\r\n    EE: \"Estonia\",\r\n    FI: \"Finland\",\r\n    GR: \"Greece\",\r\n    HU: \"Hungary\",\r\n    IE: \"Ireland\",\r\n    LV: \"Latvia\",\r\n    LT: \"Lithuania\",\r\n    LU: \"Luxembourg\",\r\n    MT: \"Malta\",\r\n    NL: \"Netherlands\",\r\n    PL: \"Poland\",\r\n    PT: \"Portugal\",\r\n    RO: \"Romania\",\r\n    SK: \"Slovakia\",\r\n    SI: \"Slovenia\",\r\n    SE: \"Sweden\",\r\n    CH: \"Switzerland\",\r\n    NO: \"Norway\",\r\n}\r\n\r\n// Bulgarian names for countries\r\nexport const COUNTRY_NAMES_BG: Record<string, string> = {\r\n    US: \"╨í╨É╨⌐\",\r\n    GB: \"╨Æ╨╡╨╗╨╕╨║╨╛╨▒╤Ç╨╕╤é╨░╨╜╨╕╤Å\",\r\n    CA: \"╨Ü╨░╨╜╨░╨┤╨░\",\r\n    AU: \"╨É╨▓╤ü╤é╤Ç╨░╨╗╨╕╤Å\",\r\n    DE: \"╨ô╨╡╤Ç╨╝╨░╨╜╨╕╤Å\",\r\n    FR: \"╨ñ╤Ç╨░╨╜╤å╨╕╤Å\",\r\n    ES: \"╨ÿ╤ü╨┐╨░╨╜╨╕╤Å\",\r\n    IT: \"╨ÿ╤é╨░╨╗╨╕╤Å\",\r\n    JP: \"╨»╨┐╨╛╨╜╨╕╤Å\",\r\n    CN: \"╨Ü╨╕╤é╨░╨╣\",\r\n    IN: \"╨ÿ╨╜╨┤╨╕╤Å\",\r\n    BR: \"╨æ╤Ç╨░╨╖╨╕╨╗╨╕╤Å\",\r\n    MX: \"╨£╨╡╨║╤ü╨╕╨║╨╛\",\r\n    RU: \"╨á╤â╤ü╨╕╤Å\",\r\n    ZA: \"╨«╨╢╨╜╨░ ╨É╤ä╤Ç╨╕╨║╨░\",\r\n    BG: \"╨æ╤è╨╗╨│╨░╤Ç╨╕╤Å\",\r\n    AT: \"╨É╨▓╤ü╤é╤Ç╨╕╤Å\",\r\n    BE: \"╨æ╨╡╨╗╨│╨╕╤Å\",\r\n    HR: \"╨Ñ╤è╤Ç╨▓╨░╤é╨╕╤Å\",\r\n    CY: \"╨Ü╨╕╨┐╤è╤Ç\",\r\n    CZ: \"╨º╨╡╤à╨╕╤Å\",\r\n    DK: \"╨ö╨░╨╜╨╕╤Å\",\r\n    EE: \"╨ò╤ü╤é╨╛╨╜╨╕╤Å\",\r\n    FI: \"╨ñ╨╕╨╜╨╗╨░╨╜╨┤╨╕╤Å\",\r\n    GR: \"╨ô╤è╤Ç╤å╨╕╤Å\",\r\n    HU: \"╨ú╨╜╨│╨░╤Ç╨╕╤Å\",\r\n    IE: \"╨ÿ╤Ç╨╗╨░╨╜╨┤╨╕╤Å\",\r\n    LV: \"╨¢╨░╤é╨▓╨╕╤Å\",\r\n    LT: \"╨¢╨╕╤é╨▓╨░\",\r\n    LU: \"╨¢╤Ä╨║╤ü╨╡╨╝╨▒╤â╤Ç╨│\",\r\n    MT: \"╨£╨░╨╗╤é╨░\",\r\n    NL: \"╨¥╨╕╨┤╨╡╤Ç╨╗╨░╨╜╨┤╨╕╤Å\",\r\n    PL: \"╨ƒ╨╛╨╗╤ê╨░\",\r\n    PT: \"╨ƒ╨╛╤Ç╤é╤â╨│╨░╨╗╨╕╤Å\",\r\n    RO: \"╨á╤â╨╝╤è╨╜╨╕╤Å\",\r\n    SK: \"╨í╨╗╨╛╨▓╨░╨║╨╕╤Å\",\r\n    SI: \"╨í╨╗╨╛╨▓╨╡╨╜╨╕╤Å\",\r\n    SE: \"╨¿╨▓╨╡╤å╨╕╤Å\",\r\n    CH: \"╨¿╨▓╨╡╨╣╤å╨░╤Ç╨╕╤Å\",\r\n    NO: \"╨¥╨╛╤Ç╨▓╨╡╨│╨╕╤Å\",\r\n}\r\n\r\n// Shipping zone definitions\r\nexport const SHIPPING_ZONES = {\r\n    BG: {\r\n        code: 'BG',\r\n        name: 'Bulgaria Only',\r\n        name_bg: '╨í╨░╨╝╨╛ ╨æ╤è╨╗╨│╨░╤Ç╨╕╤Å',\r\n        countries: ['BG'],\r\n    },\r\n    EU: {\r\n        code: 'EU',\r\n        name: 'Europe',\r\n        name_bg: '╨ò╨▓╤Ç╨╛╨┐╨░',\r\n        countries: [\r\n            'AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR', \r\n            'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL', \r\n            'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE', 'GB', 'CH', 'NO'\r\n        ],\r\n    },\r\n    WW: {\r\n        code: 'WW',\r\n        name: 'Worldwide',\r\n        name_bg: '╨ª╨╡╨╗╨╕╤Å╤é ╤ü╨▓╤Å╤é',\r\n        countries: [], // Empty means all countries\r\n    },\r\n} as const\r\n\r\nexport type ShippingZoneCode = keyof typeof SHIPPING_ZONES\r\n\r\n// Map country codes to their shipping zones (what zone are they IN)\r\nexport const COUNTRY_TO_ZONE: Record<string, ShippingZoneCode> = {\r\n    BG: 'BG',\r\n    // EU countries\r\n    AT: 'EU', BE: 'EU', HR: 'EU', CY: 'EU', CZ: 'EU', DK: 'EU', \r\n    EE: 'EU', FI: 'EU', FR: 'EU', DE: 'EU', GR: 'EU', HU: 'EU', \r\n    IE: 'EU', IT: 'EU', LV: 'EU', LT: 'EU', LU: 'EU', MT: 'EU', \r\n    NL: 'EU', PL: 'EU', PT: 'EU', RO: 'EU', SK: 'EU', SI: 'EU', \r\n    ES: 'EU', SE: 'EU', GB: 'EU', CH: 'EU', NO: 'EU',\r\n}\r\n\r\n/**\r\n * Get localized country name\r\n */\r\nexport function getCountryName(code: string, locale: string = 'en'): string {\r\n    const upperCode = code.toUpperCase()\r\n    if (locale === 'bg') {\r\n        return COUNTRY_NAMES_BG[upperCode] || COUNTRY_NAMES[upperCode] || code\r\n    }\r\n    return COUNTRY_NAMES[upperCode] || code\r\n}\r\n\r\n/**\r\n * Get the shipping zone for a country\r\n * @returns The zone code (BG, EU, or WW)\r\n */\r\nexport function getZoneForCountry(countryCode: string): ShippingZoneCode {\r\n    return COUNTRY_TO_ZONE[countryCode.toUpperCase()] || 'WW'\r\n}\r\n\r\n/**\r\n * Check if a product can ship to a user's country\r\n * \r\n * Hierarchy:\r\n * - WW (Worldwide) ships to everyone\r\n * - EU ships to Bulgaria and Europe\r\n * - BG only ships to Bulgaria\r\n */\r\nfunction canShipTo(productZone: string, userCountryCode: string): boolean {\r\n    const userZone = getZoneForCountry(userCountryCode)\r\n    \r\n    // Worldwide ships everywhere\r\n    if (productZone === 'WW') return true\r\n    \r\n    // EU zone ships to EU countries and Bulgaria\r\n    if (productZone === 'EU') {\r\n        return userZone === 'EU' || userZone === 'BG'\r\n    }\r\n    \r\n    // BG only ships to Bulgaria\r\n    if (productZone === 'BG') {\r\n        return userZone === 'BG'\r\n    }\r\n    \r\n    return false\r\n}\r\n\r\n/**\r\n * Get compatible shipping zones for filtering products\r\n * \r\n * For a user in Bulgaria: show BG, EU, and WW products\r\n * For a user in Germany: show EU and WW products  \r\n * For a user in USA: show only WW products\r\n */\r\nexport function getCompatibleZones(userCountryCode: string): ShippingZoneCode[] {\r\n    const userZone = getZoneForCountry(userCountryCode)\r\n    \r\n    if (userZone === 'BG') {\r\n        return ['BG', 'EU', 'WW'] // Bulgaria sees all products\r\n    }\r\n    \r\n    if (userZone === 'EU') {\r\n        return ['EU', 'WW'] // EU sees EU and Worldwide products\r\n    }\r\n    \r\n    return ['WW'] // Rest of world sees only Worldwide products\r\n}\r\n\r\n/**\r\n * Build Supabase filter for shipping zones\r\n * @returns A comma-separated string for .in() filter\r\n */\r\nfunction getShippingZoneFilter(userCountryCode: string): string {\r\n    const zones = getCompatibleZones(userCountryCode)\r\n    return zones.join(',')\r\n}\r\n\r\n/**\r\n * Get shipping zone info for display\r\n */\r\nfunction getShippingZoneInfo(zoneCode: string, locale: string = 'en') {\r\n    const zone = SHIPPING_ZONES[zoneCode as ShippingZoneCode]\r\n    if (!zone) return { code: 'WW', name: 'Worldwide', name_bg: '╨ª╨╡╨╗╨╕╤Å╤é ╤ü╨▓╤Å╤é' }\r\n    \r\n    return {\r\n        code: zone.code,\r\n        name: locale === 'bg' ? zone.name_bg : zone.name,\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\guest-sell-cta.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\image-compression.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\image-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\logger.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\next\\is-next-prerender-interrupted.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\normalize-image-url.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\order-conversations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\order-status.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\price-formatting.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\public-docs.ts","messages":[{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":33,"column":42,"nodeType":"Identifier","messageId":"method","endLine":33,"endColumn":49,"fix":{"range":[744,752],"text":"All('\\r\\n'"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":50,"column":58,"nodeType":"Identifier","messageId":"method","endLine":50,"endColumn":65,"fix":{"range":[1351,1351],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":146,"column":35,"nodeType":"Identifier","messageId":"method","endLine":146,"endColumn":42,"fix":{"range":[4513,4513],"text":"All"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":3,"source":"import \"server-only\"\n\nimport fs from \"node:fs/promises\"\nimport path from \"node:path\"\n\nexport type PublicDocLocale = \"en\" | \"bg\"\n\nexport type PublicDocSection = {\n  id: string\n  title: string\n  markdown: string\n}\n\nexport type PublicDoc = {\n  key: string\n  locale: PublicDocLocale\n  /** Absolute path on disk (server-only). */\n  absPath: string\n  /** Markdown contents. */\n  markdown: string\n}\n\ntype GetPublicDocArgs = {\n  /** Example: `legal/terms` (maps to `docs/public/legal/terms.<locale>.md`) */\n  docKey: string\n  locale: PublicDocLocale\n  fallbackLocale?: PublicDocLocale\n}\n\nconst PUBLIC_DOCS_ROOT = path.join(process.cwd(), \"docs\", \"public\")\n\nfunction normalizeMarkdown(markdown: string) {\n  return markdown.replace(/^\\uFEFF/, \"\").replace(/\\r\\n/g, \"\\n\")\n}\n\nfunction stripLastUpdatedFooter(markdown: string) {\n  const normalized = normalizeMarkdown(markdown)\n  const match = normalized.match(/\\n\\*Last updated:\\s*(\\d{4}-\\d{2}-\\d{2})\\*\\s*$/)\n  if (!match) return normalized\n\n  const idx = match.index ?? -1\n  if (idx <= 0) return normalized\n\n  // Remove trailing \"*Last updated: YYYY-MM-DD*\" and an optional preceding horizontal rule.\n  const before = normalized.slice(0, idx)\n  return before.replace(/\\n---\\s*$/m, \"\").trimEnd()\n}\n\nfunction normalizeDocKey(docKey: string): string {\n  const normalized = docKey.trim().replaceAll(\"\\\\\", \"/\").replace(/^\\/+|\\/+$/g, \"\")\n  if (!normalized) throw new Error(\"Public doc key is required\")\n  if (normalized.includes(\"..\")) throw new Error(`Invalid public doc key: '${docKey}'`)\n\n  const segments = normalized.split(\"/\")\n  for (const seg of segments) {\n    if (!/^[a-z0-9][a-z0-9-]*$/.test(seg)) {\n      throw new Error(`Invalid public doc key segment: '${seg}' (from '${docKey}')`)\n    }\n  }\n\n  return segments.join(\"/\")\n}\n\nfunction resolvePublicDocAbsPath(docKey: string, locale: PublicDocLocale): string {\n  const key = normalizeDocKey(docKey)\n  const candidate = path.resolve(PUBLIC_DOCS_ROOT, `${key}.${locale}.md`)\n\n  // Defense in depth (blocks traversal even if future changes loosen validation).\n  const rootAbs = path.resolve(PUBLIC_DOCS_ROOT) + path.sep\n  if (!candidate.startsWith(rootAbs)) {\n    throw new Error(`Public doc path traversal blocked: '${docKey}'`)\n  }\n\n  return candidate\n}\n\nasync function readFileIfExists(absPath: string): Promise<string | null> {\n  try {\n    return await fs.readFile(absPath, \"utf8\")\n  } catch (error) {\n    if (error && typeof error === \"object\" && \"code\" in error && error.code === \"ENOENT\") {\n      return null\n    }\n    throw error\n  }\n}\n\nexport async function getPublicDoc({\n  docKey,\n  locale,\n  fallbackLocale = \"en\",\n}: GetPublicDocArgs): Promise<PublicDoc> {\n  const absPath = resolvePublicDocAbsPath(docKey, locale)\n  const primary = await readFileIfExists(absPath)\n\n  if (primary !== null) {\n    return { key: normalizeDocKey(docKey), locale, absPath, markdown: primary }\n  }\n\n  const fallbackAbsPath = resolvePublicDocAbsPath(docKey, fallbackLocale)\n  const fallback = await readFileIfExists(fallbackAbsPath)\n\n  if (fallback !== null) {\n    return { key: normalizeDocKey(docKey), locale: fallbackLocale, absPath: fallbackAbsPath, markdown: fallback }\n  }\n\n  throw new Error(\n    `Missing public doc: docs/public/${normalizeDocKey(docKey)}.${locale}.md (or fallback ${fallbackLocale})`,\n  )\n}\n\nexport function extractLastUpdatedDate(markdown: string): string | null {\n  const normalized = normalizeMarkdown(markdown)\n  const match = normalized.match(/\\*Last updated:\\s*(\\d{4}-\\d{2}-\\d{2})\\*/g)\n  if (!match || match.length === 0) return null\n  const last = match.at(-1)\n  if (!last) return null\n  const dateMatch = last.match(/(\\d{4}-\\d{2}-\\d{2})/)\n  return dateMatch?.[1] ?? null\n}\n\nexport function parsePublicDocIntro(markdown: string): { notice: string; markdown: string } {\n  const normalized = stripLastUpdatedFooter(markdown)\n  const sectionMatch = normalized.match(/^##\\s+[a-z0-9][a-z0-9-]*\\s*:\\s*.+\\s*$/m)\n  const pre = sectionMatch && typeof sectionMatch.index === \"number\" ? normalized.slice(0, sectionMatch.index) : normalized\n\n  const lines = pre.split(\"\\n\")\n  const noticeLines: string[] = []\n  const bodyLines: string[] = []\n\n  for (const raw of lines) {\n    const line = raw.trimEnd()\n    if (line.startsWith(\"# \")) continue\n    if (line.trim() === \"---\") continue\n\n    const trimmed = line.trimStart()\n    if (trimmed.startsWith(\">\")) {\n      noticeLines.push(trimmed.replace(/^\\>\\s?/, \"\"))\n      continue\n    }\n\n    bodyLines.push(line)\n  }\n\n  return {\n    notice: noticeLines.join(\" \").replace(/\\s+/g, \" \").trim(),\n    markdown: bodyLines.join(\"\\n\").trim(),\n  }\n}\n\n/**\n * Parses sections from markdown using H2 headings:\n * `## <id>: <Title>`\n *\n * The `<id>` is stable across locales; `<Title>` is localized.\n */\nexport function parsePublicDocSections(markdown: string): PublicDocSection[] {\n  const lines = stripLastUpdatedFooter(markdown).split(\"\\n\")\n  const sections: PublicDocSection[] = []\n\n  const re = /^##\\s+([a-z0-9][a-z0-9-]*)\\s*:\\s*(.+)\\s*$/\n  let active: { id: string; title: string; buf: string[] } | null = null\n\n  function commit() {\n    if (!active) return\n    sections.push({\n      id: active.id,\n      title: active.title.trim(),\n      markdown: active.buf.join(\"\\n\").trim(),\n    })\n    active = null\n  }\n\n  for (const raw of lines) {\n    const match = raw.match(re)\n    if (match) {\n      const id = match[1]\n      const title = match[2]\n      if (id && title) {\n        commit()\n        active = { id, title, buf: [] }\n        continue\n      }\n    }\n    if (active) active.buf.push(raw)\n  }\n\n  commit()\n  return sections\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\safe-json.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\sell\\schema-v4.ts","messages":[{"ruleId":"unicorn/prefer-number-properties","severity":1,"message":"Prefer `Number.isNaN` over `isNaN`.","line":110,"column":21,"nodeType":"Identifier","messageId":"error","endLine":110,"endColumn":26,"suggestions":[{"messageId":"suggestion","fix":{"range":[3875,3880],"text":"Number.isNaN"},"data":{"description":"isNaN","property":"isNaN"},"desc":"Replace `isNaN` with `Number.isNaN`."}]},{"ruleId":"unicorn/prefer-number-properties","severity":1,"message":"Prefer `Number.isNaN` over `isNaN`.","line":118,"column":30,"nodeType":"Identifier","messageId":"error","endLine":118,"endColumn":35,"suggestions":[{"messageId":"suggestion","fix":{"range":[4205,4210],"text":"Number.isNaN"},"data":{"description":"isNaN","property":"isNaN"},"desc":"Replace `isNaN` with `Number.isNaN`."}]},{"ruleId":"unicorn/prefer-number-properties","severity":1,"message":"Prefer `Number.isNaN` over `isNaN`.","line":144,"column":30,"nodeType":"Identifier","messageId":"error","endLine":144,"endColumn":35,"suggestions":[{"messageId":"suggestion","fix":{"range":[5112,5117],"text":"Number.isNaN"},"data":{"description":"isNaN","property":"isNaN"},"desc":"Replace `isNaN` with `Number.isNaN`."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { z } from \"zod\";\r\n\r\n// ============================================================================\r\n// SELL FORM V4 - Complete rewrite with proper validation & UX\r\n// Canonical location: lib/sell/schema-v4.ts\r\n// ============================================================================\r\n\r\n// Condition options - clear labels\r\nexport const conditionOptions = [\n\t{ value: \"new-with-tags\", labelKey: \"conditions.newWithTags.label\", descriptionKey: \"conditions.newWithTags.description\" },\n\t{ value: \"new-without-tags\", labelKey: \"conditions.newWithoutTags.label\", descriptionKey: \"conditions.newWithoutTags.description\" },\n\t{ value: \"used-like-new\", labelKey: \"conditions.usedLikeNew.label\", descriptionKey: \"conditions.usedLikeNew.description\" },\n\t{ value: \"used-excellent\", labelKey: \"conditions.usedExcellent.label\", descriptionKey: \"conditions.usedExcellent.description\" },\n\t{ value: \"used-good\", labelKey: \"conditions.usedGood.label\", descriptionKey: \"conditions.usedGood.description\" },\n\t{ value: \"used-fair\", labelKey: \"conditions.usedFair.label\", descriptionKey: \"conditions.usedFair.description\" },\n] as const;\n\nexport const formatOptions = [\n\t{ value: \"fixed\", labelKey: \"formats.fixed.label\", descriptionKey: \"formats.fixed.description\", icon: \"Tag\" },\n\t{ value: \"auction\", labelKey: \"formats.auction.label\", descriptionKey: \"formats.auction.description\", icon: \"Gavel\" },\n] as const;\n\r\n// Image with metadata\r\nexport const imageSchema = z.object({\n\turl: z.string().url(\"validation.invalidImageUrl\"),\n\tthumbnailUrl: z.string().url(\"validation.invalidThumbnailUrl\").optional(),\n\tisPrimary: z.boolean().optional().default(false),\n});\n\r\nexport type ProductImage = z.infer<typeof imageSchema>;\r\n\r\n// Attribute for Item Specifics\r\nexport const attributeSchema = z.object({\n\tattributeId: z.string().uuid().nullable().optional(),\n\tname: z.string().min(1, \"validation.attributeNameRequired\"),\n\tvalue: z.string().min(1, \"validation.attributeValueRequired\"),\n\tisCustom: z.boolean().default(false),\n});\n\r\nexport type ProductAttribute = z.infer<typeof attributeSchema>;\r\n\r\n// Dimensions in metric\r\nexport const dimensionsSchema = z.object({\r\n\tlengthCm: z.coerce.number().min(0).optional(),\r\n\twidthCm: z.coerce.number().min(0).optional(),\r\n\theightCm: z.coerce.number().min(0).optional(),\r\n\tweightKg: z.coerce.number().min(0).optional(),\r\n});\r\n\r\n// Main form schema\r\nexport const sellFormSchemaV4 = z.object({\r\n\t// ========== PHOTOS (Required) ==========\r\n\timages: z\n\t\t.array(imageSchema)\n\t\t.min(1, \"validation.photosRequired\")\n\t\t.max(12, \"validation.photosMax\"),\n\r\n\t// ========== BASIC INFO ==========\r\n\ttitle: z\n\t\t.string()\n\t\t.min(5, \"validation.titleMin\")\n\t\t.max(80, \"validation.titleMax\")\n\t\t.refine((val) => !/[<>{}[\\]\\\\]/.test(val), \"validation.titleInvalidCharacters\"),\n\n\tcategoryId: z.string().min(1, \"validation.categoryRequired\"),\n\r\n\tcategoryPath: z\r\n\t\t.array(\r\n\t\t\tz.object({\r\n\t\t\t\tid: z.string(),\r\n\t\t\t\tname: z.string(),\r\n\t\t\t\tname_bg: z.string().nullable().optional(),\r\n\t\t\t\tslug: z.string(),\r\n\t\t\t})\r\n\t\t)\r\n\t\t.optional(),\r\n\r\n\tbrandId: z.string().uuid().nullable().optional(),\r\n\tbrandName: z.string().optional(), // For display\r\n\r\n\tcondition: z.enum([\r\n\t\t\"new-with-tags\",\r\n\t\t\"new-without-tags\",\r\n\t\t\"used-like-new\",\r\n\t\t\"used-excellent\",\r\n\t\t\"used-good\",\r\n\t\t\"used-fair\",\r\n\t], {\n\t\terror: \"validation.conditionRequired\",\n\t}),\n\r\n\t// ========== DESCRIPTION ==========\r\n\tdescription: z.string()\n\t\t.min(1, \"validation.descriptionRequired\")\n\t\t.max(4000, \"validation.descriptionMax\")\n\t\t.refine((val) => val.trim().length >= 50, {\n\t\t\tmessage: \"validation.descriptionMin\",\n\t\t})\n\t\t.default(\"\"),\n\r\n\t// ========== ITEM SPECIFICS ==========\r\n\tattributes: z.array(attributeSchema).optional().default([]),\r\n\r\n\t// ========== PRICING ==========\r\n\tformat: z.enum([\"fixed\", \"auction\"]).default(\"fixed\"),\r\n\r\n\tprice: z\n\t\t.string()\n\t\t.min(1, \"validation.priceRequired\")\n\t\t.refine((val) => !isNaN(Number.parseFloat(val)) && Number.parseFloat(val) > 0, \"validation.priceInvalid\")\n\t\t.refine((val) => Number.parseFloat(val) <= 999999.99, \"validation.priceMax\"),\n\r\n\tcurrency: z.enum([\"EUR\"]).default(\"EUR\"), // Bulgaria joined Eurozone Jan 1, 2025\r\n\r\n\tcompareAtPrice: z\n\t\t.string()\n\t\t.optional()\n\t\t.refine((val) => !val || (!isNaN(Number.parseFloat(val)) && Number.parseFloat(val) > 0), \"validation.compareAtInvalid\"),\n\r\n\tquantity: z.coerce\n\t\t.number()\n\t\t.int(\"validation.quantityInteger\")\n\t\t.min(1, \"validation.quantityMin\")\n\t\t.max(9999, \"validation.quantityMax\")\n\t\t.default(1),\n\r\n\tacceptOffers: z.boolean().default(false),\r\n\tminOfferPercent: z.coerce.number().min(1).max(99).optional(), // Auto-decline offers below X%\r\n\r\n\t// ========== SHIPPING ==========\r\n\t// Seller city - where the item ships from (required for Bulgaria shipping or local pickup)\r\n\tsellerCity: z.string().optional(),\r\n\r\n\tshipsToBulgaria: z.boolean().default(true),\r\n\tshipsToUK: z.boolean().default(false),\r\n\tshipsToEurope: z.boolean().default(false),\r\n\tshipsToUSA: z.boolean().default(false),\r\n\tshipsToWorldwide: z.boolean().default(false),\r\n\tpickupOnly: z.boolean().default(false),\r\n\r\n\tshippingPrice: z\n\t\t.string()\n\t\t.optional()\n\t\t.refine((val) => !val || (!isNaN(Number.parseFloat(val)) && Number.parseFloat(val) >= 0), \"validation.shippingPriceInvalid\"),\n\r\n\tfreeShipping: z.boolean().default(false),\r\n\r\n\tdimensions: dimensionsSchema.optional(),\r\n\r\n\tprocessingDays: z.coerce.number().min(1).max(30).default(3),\r\n\r\n\t// ========== TAGS ==========\n\ttags: z.array(z.string()).max(10, \"validation.tagsMax\").default([]),\n}).superRefine((data, ctx) => {\n\t// Discount sanity: compare-at price must be higher than the active price.\r\n\tif (!data.compareAtPrice) return;\r\n\r\n\tconst price = Number.parseFloat(data.price);\r\n\tconst compareAt = Number.parseFloat(data.compareAtPrice);\r\n\r\n\tif (!Number.isFinite(price) || !Number.isFinite(compareAt)) return;\r\n\r\n\tif (compareAt <= price) {\n\t\tctx.addIssue({\n\t\t\tcode: z.ZodIssueCode.custom,\n\t\t\tpath: [\"compareAtPrice\"],\n\t\t\tmessage: \"validation.compareAtMustBeHigher\",\n\t\t});\n\t}\n});\n\r\nexport type SellFormDataV4 = z.infer<typeof sellFormSchemaV4>;\r\n\r\n// Default form values\r\nexport const defaultSellFormValuesV4: SellFormDataV4 = {\r\n\timages: [],\r\n\ttitle: \"\",\r\n\tcategoryId: \"\",\r\n\tcategoryPath: [],\r\n\tbrandId: null,\r\n\tbrandName: \"\",\r\n\tcondition: \"used-excellent\",\r\n\tdescription: \"\",\r\n\tattributes: [],\r\n\tformat: \"fixed\",\r\n\tprice: \"\",\r\n\tcurrency: \"EUR\", // Bulgaria joined Eurozone Jan 1, 2025\r\n\tcompareAtPrice: \"\",\r\n\tquantity: 1,\r\n\tacceptOffers: false,\r\n\tminOfferPercent: undefined,\r\n\tsellerCity: \"\",\r\n\tshipsToBulgaria: true,\r\n\tshipsToUK: false,\r\n\tshipsToEurope: false,\r\n\tshipsToUSA: false,\r\n\tshipsToWorldwide: false,\r\n\tpickupOnly: false,\r\n\tshippingPrice: \"\",\r\n\tfreeShipping: false,\r\n\tdimensions: {\r\n\t\tlengthCm: undefined,\r\n\t\twidthCm: undefined,\r\n\t\theightCm: undefined,\r\n\t\tweightKg: undefined,\r\n\t},\r\n\tprocessingDays: 3,\r\n\ttags: [],\r\n};\r\n\r\n// ============================================================================\r\n// FORM PROGRESS CALCULATION\r\n// ============================================================================\r\nexport interface ProgressItem {\n\tkey: string;\n\tlabelKey: string;\n\tcompleted: boolean;\n\trequired: boolean;\n}\n\r\nexport function calculateFormProgress(data: Partial<SellFormDataV4>): {\r\n\tpercentage: number;\r\n\titems: ProgressItem[];\r\n\tnextStep: ProgressItem | null;\r\n} {\r\n\tconst items: ProgressItem[] = [\n\t\t{\n\t\t\tkey: \"photos\",\n\t\t\tlabelKey: \"checklistSidebar.items.photos\",\n\t\t\tcompleted: (data.images?.length ?? 0) > 0,\n\t\t\trequired: true,\n\t\t},\n\t\t{\n\t\t\tkey: \"title\",\n\t\t\tlabelKey: \"checklistSidebar.items.title\",\n\t\t\tcompleted: (data.title?.length ?? 0) >= 5,\n\t\t\trequired: true,\n\t\t},\n\t\t{\n\t\t\tkey: \"category\",\n\t\t\tlabelKey: \"checklistSidebar.items.category\",\n\t\t\tcompleted: !!data.categoryId && data.categoryId.length > 0,\n\t\t\trequired: true,\n\t\t},\n\t\t{\n\t\t\tkey: \"condition\",\n\t\t\tlabelKey: \"checklistSidebar.items.condition\",\n\t\t\tcompleted: !!data.condition,\n\t\t\trequired: true,\n\t\t},\n\t\t{\n\t\t\tkey: \"price\",\n\t\t\tlabelKey: \"checklistSidebar.items.price\",\n\t\t\tcompleted: !!data.price && Number.parseFloat(data.price) > 0,\n\t\t\trequired: true,\n\t\t},\n\t\t{\n\t\t\tkey: \"description\",\n\t\t\tlabelKey: \"checklistSidebar.items.description\",\n\t\t\tcompleted: (data.description?.trim().length ?? 0) >= 50,\n\t\t\trequired: true,\n\t\t},\n\t\t{\n\t\t\tkey: \"shipping\",\n\t\t\tlabelKey: \"checklistSidebar.items.shipping\",\n\t\t\tcompleted: !!(\n\t\t\t\tdata.shipsToBulgaria ||\n\t\t\t\tdata.shipsToUK ||\n\t\t\t\tdata.shipsToEurope ||\n\t\t\t\tdata.shipsToUSA ||\r\n\t\t\t\tdata.shipsToWorldwide ||\r\n\t\t\t\tdata.pickupOnly\r\n\t\t\t),\r\n\t\t\trequired: true,\r\n\t\t},\r\n\t];\r\n\r\n\tconst requiredItems = items.filter((i) => i.required);\r\n\tconst completedRequired = requiredItems.filter((i) => i.completed).length;\r\n\tconst percentage = Math.round((completedRequired / requiredItems.length) * 100);\r\n\r\n\tconst nextStep = items.find((i) => i.required && !i.completed) || null;\r\n\r\n\treturn { percentage, items, nextStep };\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\shipping.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getDeliveryLabel' is defined but never used.","line":153,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":153,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getRegionName' is defined but never used.","line":219,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":219,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Shipping utilities for calculating delivery times based on seller location ΓåÆ buyer location\r\n * \r\n * The key insight: Delivery time is calculated from WHERE the seller is (seller.country_code)\r\n * to WHERE the buyer wants delivery (their selected shipping region).\r\n * \r\n * A Bulgarian seller shipping to USA = 10-20 days\r\n * A USA seller shipping to USA = 1-5 days\r\n * Same destination, different times based on origin!\r\n * \r\n * Updated December 2025: Added UK as separate region (post-Brexit)\r\n */\r\n\r\n// Shipping regions (buyer's delivery destination)\r\n// UK added as separate region post-Brexit (no longer part of EU for shipping)\r\nexport type ShippingRegion = 'BG' | 'UK' | 'EU' | 'US' | 'WW';\r\n\r\n// Seller origin country codes\r\nexport type SellerCountry = 'BG' | 'DE' | 'US' | 'UK' | 'OTHER';\r\n\r\n// Delivery time estimate in days\r\nexport interface DeliveryEstimate {\r\n  minDays: number;\r\n  maxDays: number;\r\n  label: string;\r\n  labelBg: string;\r\n}\r\n\r\n/**\r\n * Delivery time matrix: [FROM seller country][TO buyer region]\r\n * \r\n * This prevents sellers from accidentally setting wrong delivery times.\r\n * The system automatically calculates based on their store location.\r\n */\r\nconst DELIVERY_MATRIX: Record<SellerCountry, Record<ShippingRegion, DeliveryEstimate>> = {\r\n  // Bulgarian sellers\r\n  BG: {\r\n    BG: { minDays: 1, maxDays: 3, label: '1-3 days', labelBg: '1-3 ╨┤╨╜╨╕' },\r\n    UK: { minDays: 5, maxDays: 12, label: '5-12 days', labelBg: '5-12 ╨┤╨╜╨╕' },\r\n    EU: { minDays: 5, maxDays: 10, label: '5-10 days', labelBg: '5-10 ╨┤╨╜╨╕' },\r\n    US: { minDays: 10, maxDays: 20, label: '10-20 days', labelBg: '10-20 ╨┤╨╜╨╕' },\r\n    WW: { minDays: 15, maxDays: 30, label: '15-30 days', labelBg: '15-30 ╨┤╨╜╨╕' },\r\n  },\r\n  // German sellers (example EU country)\r\n  DE: {\r\n    BG: { minDays: 5, maxDays: 10, label: '5-10 days', labelBg: '5-10 ╨┤╨╜╨╕' },\r\n    UK: { minDays: 3, maxDays: 7, label: '3-7 days', labelBg: '3-7 ╨┤╨╜╨╕' },\r\n    EU: { minDays: 2, maxDays: 5, label: '2-5 days', labelBg: '2-5 ╨┤╨╜╨╕' },\r\n    US: { minDays: 7, maxDays: 14, label: '7-14 days', labelBg: '7-14 ╨┤╨╜╨╕' },\r\n    WW: { minDays: 10, maxDays: 21, label: '10-21 days', labelBg: '10-21 ╨┤╨╜╨╕' },\r\n  },\r\n  // USA sellers\r\n  US: {\r\n    BG: { minDays: 10, maxDays: 20, label: '10-20 days', labelBg: '10-20 ╨┤╨╜╨╕' },\r\n    UK: { minDays: 5, maxDays: 10, label: '5-10 days', labelBg: '5-10 ╨┤╨╜╨╕' },\r\n    EU: { minDays: 7, maxDays: 14, label: '7-14 days', labelBg: '7-14 ╨┤╨╜╨╕' },\r\n    US: { minDays: 1, maxDays: 5, label: '1-5 days', labelBg: '1-5 ╨┤╨╜╨╕' },\r\n    WW: { minDays: 7, maxDays: 21, label: '7-21 days', labelBg: '7-21 ╨┤╨╜╨╕' },\r\n  },\r\n  // UK sellers\r\n  UK: {\r\n    BG: { minDays: 5, maxDays: 12, label: '5-12 days', labelBg: '5-12 ╨┤╨╜╨╕' },\r\n    UK: { minDays: 1, maxDays: 3, label: '1-3 days', labelBg: '1-3 ╨┤╨╜╨╕' },\r\n    EU: { minDays: 3, maxDays: 7, label: '3-7 days', labelBg: '3-7 ╨┤╨╜╨╕' },\r\n    US: { minDays: 5, maxDays: 10, label: '5-10 days', labelBg: '5-10 ╨┤╨╜╨╕' },\r\n    WW: { minDays: 10, maxDays: 21, label: '10-21 days', labelBg: '10-21 ╨┤╨╜╨╕' },\r\n  },\r\n  // Other countries (fallback)\r\n  OTHER: {\r\n    BG: { minDays: 10, maxDays: 25, label: '10-25 days', labelBg: '10-25 ╨┤╨╜╨╕' },\r\n    UK: { minDays: 7, maxDays: 18, label: '7-18 days', labelBg: '7-18 ╨┤╨╜╨╕' },\r\n    EU: { minDays: 7, maxDays: 20, label: '7-20 days', labelBg: '7-20 ╨┤╨╜╨╕' },\r\n    US: { minDays: 7, maxDays: 21, label: '7-21 days', labelBg: '7-21 ╨┤╨╜╨╕' },\r\n    WW: { minDays: 14, maxDays: 35, label: '14-35 days', labelBg: '14-35 ╨┤╨╜╨╕' },\r\n  },\r\n};\r\n\r\n/**\r\n * Map ISO country codes to seller categories\r\n */\r\nconst COUNTRY_TO_SELLER_CATEGORY: Record<string, SellerCountry> = {\r\n  BG: 'BG',\r\n  // EU countries ΓåÆ treat as German-like delivery times\r\n  AT: 'DE', BE: 'DE', HR: 'DE', CY: 'DE', CZ: 'DE', DK: 'DE',\r\n  EE: 'DE', FI: 'DE', FR: 'DE', DE: 'DE', GR: 'DE', HU: 'DE',\r\n  IE: 'DE', IT: 'DE', LV: 'DE', LT: 'DE', LU: 'DE', MT: 'DE',\r\n  NL: 'DE', PL: 'DE', PT: 'DE', RO: 'DE', SK: 'DE', SI: 'DE',\r\n  ES: 'DE', SE: 'DE', CH: 'DE', NO: 'DE',\r\n  // UK\r\n  GB: 'UK', UK: 'UK',\r\n  // USA\r\n  US: 'US',\r\n};\r\n\r\n/**\r\n * Map ISO country codes to shipping regions (buyer perspective)\r\n * Updated December 2025: GB/UK now maps to 'UK' region (post-Brexit)\r\n */\r\nconst COUNTRY_TO_REGION: Record<string, ShippingRegion> = {\r\n  BG: 'BG',\r\n  // UK - POST-BREXIT: Separate shipping zone from EU\r\n  GB: 'UK',\r\n  UK: 'UK',\r\n  // EU countries (GB removed post-Brexit)\r\n  AT: 'EU', BE: 'EU', HR: 'EU', CY: 'EU', CZ: 'EU', DK: 'EU',\r\n  EE: 'EU', FI: 'EU', FR: 'EU', DE: 'EU', GR: 'EU', HU: 'EU',\r\n  IE: 'EU', IT: 'EU', LV: 'EU', LT: 'EU', LU: 'EU', MT: 'EU',\r\n  NL: 'EU', PL: 'EU', PT: 'EU', RO: 'EU', SK: 'EU', SI: 'EU',\r\n  ES: 'EU', SE: 'EU', CH: 'EU', NO: 'EU',\r\n  // USA\r\n  US: 'US',\r\n};\r\n\r\n/**\r\n * Get the shipping region for a buyer based on their country code\r\n */\r\nexport function getShippingRegion(countryCode: string): ShippingRegion {\r\n  return COUNTRY_TO_REGION[countryCode.toUpperCase()] || 'WW';\r\n}\r\n\r\n/**\r\n * Get the seller category for delivery time calculation\r\n */\r\nexport function getSellerCategory(countryCode: string): SellerCountry {\r\n  return COUNTRY_TO_SELLER_CATEGORY[countryCode.toUpperCase()] || 'OTHER';\r\n}\r\n\r\n/**\r\n * Calculate delivery estimate from seller to buyer\r\n * \r\n * @param sellerCountryCode - ISO country code where seller is located (e.g., 'BG')\r\n * @param buyerRegion - The shipping region buyer wants delivery to\r\n * @returns DeliveryEstimate with min/max days and labels\r\n * \r\n * @example\r\n * // Bulgarian seller shipping to USA buyer\r\n * getDeliveryEstimate('BG', 'US') // { minDays: 10, maxDays: 20, label: '10-20 days' }\r\n * \r\n * // USA seller shipping to USA buyer  \r\n * getDeliveryEstimate('US', 'US') // { minDays: 1, maxDays: 5, label: '1-5 days' }\r\n */\r\nexport function getDeliveryEstimate(\r\n  sellerCountryCode: string,\r\n  buyerRegion: ShippingRegion\r\n): DeliveryEstimate {\r\n  const sellerCategory = getSellerCategory(sellerCountryCode);\r\n  return DELIVERY_MATRIX[sellerCategory][buyerRegion];\r\n}\r\n\r\n/**\r\n * Get formatted delivery label\r\n */\r\nfunction getDeliveryLabel(\r\n  sellerCountryCode: string,\r\n  buyerRegion: ShippingRegion,\r\n  locale: string = 'en'\r\n): string {\r\n  const estimate = getDeliveryEstimate(sellerCountryCode, buyerRegion);\r\n  return locale === 'bg' ? estimate.labelBg : estimate.label;\r\n}\r\n\r\n/**\r\n * Check if a product ships to a given region based on its shipping flags\r\n * Updated December 2025: Added UK support\r\n */\r\nexport function productShipsToRegion(\r\n  product: {\r\n    ships_to_bulgaria?: boolean | null;\r\n    ships_to_uk?: boolean | null;\r\n    ships_to_europe?: boolean | null;\r\n    ships_to_usa?: boolean | null;\r\n    ships_to_worldwide?: boolean | null;\r\n    pickup_only?: boolean | null;\r\n  },\r\n  buyerRegion: ShippingRegion\r\n): boolean {\r\n  // Worldwide = no filtering (show all products)\r\n  if (buyerRegion === 'WW') return true;\r\n\r\n  // Pickup only = no shipping to any destination-specific region\r\n  if (product.pickup_only) return false;\r\n  \r\n  // Worldwide covers everything\r\n  if (product.ships_to_worldwide) return true;\r\n  \r\n  switch (buyerRegion) {\r\n    case 'BG':\r\n      // Bulgaria buyers see: BG shippers + EU shippers (since BG is in EU) + Worldwide\r\n      return !!(product.ships_to_bulgaria || product.ships_to_europe || product.ships_to_worldwide);\r\n    case 'UK':\r\n      // UK buyers see: UK shippers + EU shippers (some EU sellers ship to UK) + Worldwide\r\n      return !!(product.ships_to_uk || product.ships_to_europe || product.ships_to_worldwide);\r\n    case 'EU':\r\n      // EU buyers see: EU shippers + Worldwide\r\n      return !!(product.ships_to_europe || product.ships_to_worldwide);\r\n    case 'US':\r\n      // USA buyers see: USA shippers + Worldwide\r\n      return !!(product.ships_to_usa || product.ships_to_worldwide);\r\n    default:\r\n      return !!product.ships_to_worldwide;\r\n  }\r\n}\r\n\r\n/**\r\n * Shipping region display names\r\n * Updated December 2025: Added UK\r\n */\r\nexport const SHIPPING_REGIONS: Record<ShippingRegion, { en: string; bg: string }> = {\r\n  BG: { en: 'Bulgaria', bg: '╨æ╤è╨╗╨│╨░╤Ç╨╕╤Å' },\r\n  UK: { en: 'United Kingdom', bg: '╨Æ╨╡╨╗╨╕╨║╨╛╨▒╤Ç╨╕╤é╨░╨╜╨╕╤Å' },\r\n  EU: { en: 'Europe', bg: '╨ò╨▓╤Ç╨╛╨┐╨░' },\r\n  US: { en: 'United States', bg: '╨í╨É╨⌐' },\r\n  WW: { en: 'Worldwide', bg: '╨ƒ╨╛ ╤å╨╡╨╗╨╕╤Å ╤ü╨▓╤Å╤é' },\r\n};\r\n\r\n/**\r\n * Get region display name\r\n */\r\nfunction getRegionName(region: ShippingRegion, locale: string = 'en'): string {\r\n  return SHIPPING_REGIONS[region]?.[locale as 'en' | 'bg'] || SHIPPING_REGIONS[region]?.en || region;\r\n}\r\n\r\n/**\r\n * Build Supabase filter string for shipping zone\r\n * Returns an \"or\" filter that matches products shipping to the buyer's region\r\n * Updated December 2025: Added UK support\r\n * \r\n * @example\r\n * const filter = getShippingFilter('BG')\r\n * // Returns: \"ships_to_bulgaria.eq.true,ships_to_europe.eq.true,ships_to_worldwide.eq.true\"\r\n * \r\n * const filterUK = getShippingFilter('UK')\r\n * // Returns: \"ships_to_uk.eq.true,ships_to_europe.eq.true,ships_to_worldwide.eq.true\"\r\n * \r\n * supabase.from('products').or(filter)\r\n */\r\nexport function getShippingFilter(buyerRegion: ShippingRegion): string {\r\n  switch (buyerRegion) {\r\n    case 'BG':\r\n      // Bulgaria buyers see: BG + EU (since BG is in EU) + Worldwide\r\n      return 'ships_to_bulgaria.eq.true,ships_to_europe.eq.true,ships_to_worldwide.eq.true';\r\n    case 'UK':\r\n      // UK buyers see: UK + EU (some EU sellers still ship to UK) + Worldwide\r\n      return 'ships_to_uk.eq.true,ships_to_europe.eq.true,ships_to_worldwide.eq.true';\r\n    case 'EU':\r\n      // EU buyers see: EU + Worldwide\r\n      return 'ships_to_europe.eq.true,ships_to_worldwide.eq.true';\r\n    case 'US':\r\n      // USA buyers see: USA + Worldwide\r\n      return 'ships_to_usa.eq.true,ships_to_worldwide.eq.true';\r\n    case 'WW':\r\n    default:\r\n      // Worldwide = no filter (show everything). Callers should NOT apply `.or()`.\r\n      return '';\r\n  }\r\n}\r\n\r\n/**\r\n * Validate and parse shipping region from cookie/string\r\n * Updated December 2025: Added UK support\r\n */\r\nexport function parseShippingRegion(value: string | undefined | null): ShippingRegion {\r\n  if (!value) return 'WW'; // Default to Worldwide (show all)\r\n  const upper = value.toUpperCase();\r\n  if (upper === 'BG' || upper === 'UK' || upper === 'EU' || upper === 'US' || upper === 'WW') {\r\n    return upper as ShippingRegion;\r\n  }\r\n  // Handle GB -> UK mapping for backward compatibility\r\n  if (upper === 'GB') {\r\n    return 'UK';\r\n  }\r\n  return 'WW'; // Default fallback\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\stripe-connect.ts","messages":[{"ruleId":"sonarjs/prefer-immediate-return","severity":1,"message":"Immediately return this expression instead of assigning it to the temporary variable \"account\".","line":127,"column":19,"nodeType":"AwaitExpression","messageId":"doImmediateAction","endLine":139,"endColumn":5,"fix":{"range":[4567,4926],"text":"return await stripe.accounts.create({\r\n    type: \"express\",\r\n    country,\r\n    email,\r\n    business_type: accountType === \"business\" ? \"company\" : \"individual\",\r\n    capabilities: {\r\n      card_payments: { requested: true },\r\n      transfers: { requested: true },\r\n    },\r\n    metadata: {\r\n      seller_id: sellerId,\r\n    },\r\n  })"}},{"ruleId":"sonarjs/prefer-immediate-return","severity":1,"message":"Immediately return this expression instead of assigning it to the temporary variable \"accountLink\".","line":155,"column":23,"nodeType":"AwaitExpression","messageId":"doImmediateAction","endLine":160,"endColumn":5,"fix":{"range":[5265,5465],"text":"return await stripe.accountLinks.create({\r\n    account: accountId,\r\n    refresh_url: refreshUrl,\r\n    return_url: returnUrl,\r\n    type: \"account_onboarding\",\r\n  })"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":2,"source":"import \"server-only\"\r\n\r\nimport { stripe } from \"@/lib/stripe\"\r\nimport { createClient } from \"@/lib/supabase/server\"\r\nimport type Stripe from \"stripe\"\r\n\r\n// =============================================================================\r\n// FEE STRUCTURE (Hybrid Buyer-Protection Model)\r\n// =============================================================================\r\n//\r\n// Personal accounts: 0% seller fee, buyer pays protection (3-4% + fixed)\r\n// Business accounts: Small seller fee (0.5-1.5%), lower buyer protection\r\n//\r\n// This matches the Vinted model which is proven successful in Europe.\r\n// See: PLAN-monetization-strategy.md for full details.\r\n// =============================================================================\r\n\r\n/**\r\n * Fee structure for a transaction based on seller's plan.\r\n */\r\nexport interface TransactionFees {\r\n  sellerFeePercent: number\r\n  buyerProtectionPercent: number\r\n  buyerProtectionFixed: number\r\n  buyerProtectionCap: number\r\n}\r\n\r\n\r\n/**\r\n * Get fee structure for a seller based on their subscription tier.\r\n * Fetches from database for accurate, up-to-date rates.\r\n */\r\nexport async function getFeesForSeller(sellerId: string): Promise<TransactionFees> {\r\n  const supabase = await createClient()\r\n  \r\n  // Get seller's tier and account type from profiles\r\n  const { data: seller } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"tier, account_type\")\r\n    .eq(\"id\", sellerId)\r\n    .single()\r\n  \r\n  const accountType = seller?.account_type === \"business\" ? \"business\" : \"personal\"\r\n  const tier = seller?.tier || \"free\"\r\n  \r\n  const PLAN_SELECT = \"seller_fee_percent, buyer_protection_percent, buyer_protection_fixed, buyer_protection_cap\" as const\r\n\r\n  const readPlanFees = async (params: { tier: string; accountType: \"personal\" | \"business\" }) => {\r\n    const { data: plan } = await supabase\r\n      .from(\"subscription_plans\")\r\n      .select(PLAN_SELECT)\r\n      .eq(\"tier\", params.tier)\r\n      .eq(\"account_type\", params.accountType)\r\n      .eq(\"is_active\", true)\r\n      .single()\r\n\r\n    if (!plan) return null\r\n\r\n    return {\r\n      sellerFeePercent: Number(plan.seller_fee_percent ?? 0),\r\n      buyerProtectionPercent: Number(plan.buyer_protection_percent ?? 0),\r\n      buyerProtectionFixed: Number(plan.buyer_protection_fixed ?? 0),\r\n      buyerProtectionCap: Number(plan.buyer_protection_cap ?? 0),\r\n    } satisfies TransactionFees\r\n  }\r\n\r\n  // Primary: seller's current tier + account type.\r\n  const primary = await readPlanFees({ tier, accountType })\r\n  if (primary) return primary\r\n\r\n  // Fallback: free tier for the seller's account type.\r\n  const fallback = await readPlanFees({ tier: \"free\", accountType })\r\n  if (fallback) return fallback\r\n\r\n  // Last resort: personal free tier must exist in DB.\r\n  const lastResort = await readPlanFees({ tier: \"free\", accountType: \"personal\" })\r\n  if (lastResort) return lastResort\r\n\r\n  throw new Error(\"No fee configuration found for subscription_plans\")\r\n}\r\n\r\n/**\r\n * Calculate all fees for a transaction.\r\n * \r\n * @param itemPriceEur - Item price in EUR\r\n * @param fees - Fee structure from seller's plan\r\n * @returns Breakdown of all fees and final amounts\r\n */\r\nexport function calculateTransactionFees(\r\n  itemPriceEur: number,\r\n  fees: TransactionFees\r\n): {\r\n  sellerFee: number\r\n  buyerProtectionFee: number\r\n  sellerReceives: number\r\n  buyerPays: number\r\n  platformRevenue: number\r\n} {\r\n  // Calculate seller fee (0% for personal, small % for business)\r\n  const sellerFee = itemPriceEur * (fees.sellerFeePercent / 100)\r\n  \r\n  // Calculate buyer protection (percentage + fixed, capped)\r\n  const buyerProtectionRaw = (itemPriceEur * (fees.buyerProtectionPercent / 100)) + fees.buyerProtectionFixed\r\n  const buyerProtectionFee = Math.min(buyerProtectionRaw, fees.buyerProtectionCap)\r\n  \r\n  return {\r\n    sellerFee: Math.round(sellerFee * 100) / 100,\r\n    buyerProtectionFee: Math.round(buyerProtectionFee * 100) / 100,\r\n    sellerReceives: Math.round((itemPriceEur - sellerFee) * 100) / 100,\r\n    buyerPays: Math.round((itemPriceEur + buyerProtectionFee) * 100) / 100,\r\n    platformRevenue: Math.round((sellerFee + buyerProtectionFee) * 100) / 100,\r\n  }\r\n}\r\n\r\n/**\r\n * Create a new Express connected account for a seller.\r\n * Express accounts handle onboarding UI and compliance automatically.\r\n */\r\nexport async function createConnectAccount(params: {\r\n  email: string\r\n  sellerId: string\r\n  country?: string\r\n  accountType?: \"personal\" | \"business\"\r\n}): Promise<Stripe.Account> {\r\n  const { email, sellerId, country = \"BG\", accountType = \"personal\" } = params\r\n\r\n  const account = await stripe.accounts.create({\r\n    type: \"express\",\r\n    country,\r\n    email,\r\n    business_type: accountType === \"business\" ? \"company\" : \"individual\",\r\n    capabilities: {\r\n      card_payments: { requested: true },\r\n      transfers: { requested: true },\r\n    },\r\n    metadata: {\r\n      seller_id: sellerId,\r\n    },\r\n  })\r\n\r\n  return account\r\n}\r\n\r\n/**\r\n * Create an account link for onboarding.\r\n * This URL redirects the seller to Stripe's hosted onboarding flow.\r\n */\r\nexport async function createAccountLink(params: {\r\n  accountId: string\r\n  refreshUrl: string\r\n  returnUrl: string\r\n}): Promise<Stripe.AccountLink> {\r\n  const { accountId, refreshUrl, returnUrl } = params\r\n\r\n  const accountLink = await stripe.accountLinks.create({\r\n    account: accountId,\r\n    refresh_url: refreshUrl,\r\n    return_url: returnUrl,\r\n    type: \"account_onboarding\",\r\n  })\r\n\r\n  return accountLink\r\n}\r\n\r\n/**\r\n * Create a login link for sellers to access their Express Dashboard.\r\n * Only works for accounts that have completed onboarding.\r\n */\r\nexport async function createLoginLink(accountId: string): Promise<Stripe.LoginLink> {\r\n  return stripe.accounts.createLoginLink(accountId)\r\n}\r\n\r\n/**\r\n * Retrieve a connected account to check its status.\r\n */\r\nexport async function getConnectAccount(accountId: string): Promise<Stripe.Account> {\r\n  return stripe.accounts.retrieve(accountId)\r\n}\r\n\r\n/**\r\n * Check if an account is ready to receive payments.\r\n */\r\nexport function isAccountReady(account: Stripe.Account): boolean {\r\n  return (\r\n    account.details_submitted === true &&\r\n    account.charges_enabled === true &&\r\n    account.payouts_enabled === true\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\stripe-locale.ts","messages":[{"ruleId":"sonarjs/no-identical-functions","severity":1,"message":"Update this function so that its implementation is not identical to the one on line 37.","line":59,"column":17,"nodeType":null,"endLine":59,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Stripe locale URL utilities.\r\n *\r\n * Centralizes locale-safe return URL generation for Stripe checkout/portal flows.\r\n * No app imports allowed (pure lib module).\r\n */\r\n\r\nexport type SupportedLocale = 'en' | 'bg'\r\n\r\n/**\r\n * Normalize unknown locale value to a supported locale.\r\n * Defaults to 'en' if invalid or missing.\r\n */\r\nexport function normalizeLocale(locale: unknown): SupportedLocale {\r\n  return locale === 'bg' ? 'bg' : 'en'\r\n}\r\n\r\n/**\r\n * Get the base app URL without trailing slash.\r\n */\r\nexport function getAppUrl(): string {\r\n  return (\r\n    process.env.NEXT_PUBLIC_APP_URL ||\r\n    process.env.NEXT_PUBLIC_SITE_URL ||\r\n    process.env.NEXT_PUBLIC_URL ||\r\n    'http://localhost:3000'\r\n  ).replace(/\\/$/, '')\r\n}\r\n\r\n/**\r\n * Build an absolute locale-prefixed URL using the app URL from environment.\r\n *\r\n * For Stripe return/refresh URLs, we MUST use the configured NEXT_PUBLIC_APP_URL\r\n * since Stripe redirects happen client-side and the request origin (e.g., 0.0.0.0:3000)\r\n * won't work after the redirect.\r\n */\r\nexport function buildLocaleUrlFromRequest(\r\n  _req: Request,\r\n  path: string,\r\n  locale: unknown,\r\n  query?: string,\r\n): string {\r\n  // Always use env var for Stripe URLs - request origin doesn't work for redirects\r\n  const base = getAppUrl()\r\n  const safeLocale = normalizeLocale(locale)\r\n  const cleanPath = path.replace(/^\\//, '')\r\n  const url = `${base}/${safeLocale}/${cleanPath}`\r\n  return query ? `${url}?${query}` : url\r\n}\r\n\r\n/**\r\n * Build an absolute locale-prefixed URL.\r\n *\r\n * @param path - Path without leading slash (e.g. 'account/payments')\r\n * @param locale - Locale to prefix, or unknown value that will be normalized\r\n * @param query - Optional query string (without leading ?)\r\n * @returns Absolute URL like https://example.com/en/account/payments?setup=success\r\n */\r\nexport function buildLocaleUrl(\r\n  path: string,\r\n  locale: unknown,\r\n  query?: string,\r\n): string {\r\n  const base = getAppUrl()\r\n  const safeLocale = normalizeLocale(locale)\r\n  const cleanPath = path.replace(/^\\//, '')\r\n  const url = `${base}/${safeLocale}/${cleanPath}`\r\n  return query ? `${url}?${query}` : url\r\n}\r\n\r\n/**\r\n * Infer locale from a Request object.\r\n *\r\n * Checks in order:\r\n * 1. Explicit bodyLocale parameter (if provided)\r\n * 2. x-next-intl-locale header\r\n * 3. First path segment of Referer header\r\n * 4. Defaults to 'en'\r\n */\r\nexport function inferLocaleFromRequest(\r\n  req: Request,\r\n  bodyLocale?: unknown,\r\n): SupportedLocale {\r\n  if (bodyLocale) return normalizeLocale(bodyLocale)\r\n\r\n  const headerLocale = req.headers.get('x-next-intl-locale')\r\n  if (headerLocale) return normalizeLocale(headerLocale)\r\n\r\n  const referer = req.headers.get('referer')\r\n  if (referer) {\r\n    try {\r\n      const url = new URL(referer)\r\n      const firstSegment = url.pathname.split('/').filter(Boolean)[0]\r\n      if (firstSegment) return normalizeLocale(firstSegment)\r\n    } catch {\r\n      // ignore invalid referer\r\n    }\r\n  }\r\n\r\n  return 'en'\r\n}\r\n\r\n/**\r\n * Infer locale from headers() async call (Next.js server context).\r\n *\r\n * Checks in order:\r\n * 1. x-next-intl-locale header\r\n * 2. First path segment of Referer header\r\n * 3. First path segment of Origin header (fallback - only useful if origin includes locale path)\r\n * 4. Defaults to 'en'\r\n */\r\nexport function inferLocaleFromHeaders(headersList: {\r\n  get: (name: string) => string | null\r\n}): SupportedLocale {\r\n  const headerLocale = headersList.get('x-next-intl-locale')\r\n  if (headerLocale) return normalizeLocale(headerLocale)\r\n\r\n  const referer = headersList.get('referer')\r\n  if (referer) {\r\n    try {\r\n      const url = new URL(referer)\r\n      const firstSegment = url.pathname.split('/').filter(Boolean)[0]\r\n      if (firstSegment) return normalizeLocale(firstSegment)\r\n    } catch {\r\n      // ignore invalid referer\r\n    }\r\n  }\r\n\r\n  // Origin fallback (rarely useful since origin typically has no path, but included for completeness)\r\n  const origin = headersList.get('origin')\r\n  if (origin) {\r\n    try {\r\n      const url = new URL(origin)\r\n      const firstSegment = url.pathname.split('/').filter(Boolean)[0]\r\n      if (firstSegment) return normalizeLocale(firstSegment)\r\n    } catch {\r\n      // ignore invalid origin\r\n    }\r\n  }\r\n\r\n  return 'en'\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\stripe.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\structured-log.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\supabase\\client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\supabase\\database.types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\supabase\\messages.ts","messages":[{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":205,"column":52,"nodeType":"CallExpression","messageId":"array-from","endLine":205,"endColumn":71,"fix":{"range":[5981,6000],"text":"[...userIds]"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import type { SupabaseClient } from \"@supabase/supabase-js\"\r\nimport { logger } from \"@/lib/logger\"\r\nimport type { Database } from \"@/lib/supabase/database.types\"\r\nimport type {\r\n  Conversation,\r\n  Message,\r\n  RawConversationRow,\r\n  RawProfileRow,\r\n  RawMessageRow,\r\n  MessageType,\r\n} from \"@/lib/types/messages\"\r\n\r\n// =============================================================================\r\n// PROFILE HELPERS\r\n// =============================================================================\r\n\r\n/**\r\n * Fetch profiles for a list of user IDs\r\n */\r\nexport async function fetchProfiles(\r\n  supabase: SupabaseClient<Database>,\r\n  userIds: string[]\r\n): Promise<Map<string, RawProfileRow>> {\r\n  if (userIds.length === 0) return new Map()\r\n\r\n  const { data: profiles } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"id, full_name, avatar_url, display_name, business_name, username\")\r\n    .in(\"id\", userIds)\r\n\r\n  return new Map(profiles?.map((p) => [p.id, p]) || [])\r\n}\r\n\r\n// =============================================================================\r\n// CONVERSATION TRANSFORMERS\r\n// =============================================================================\r\n\r\n/**\r\n * Transform raw conversation row to Conversation type with profile data\r\n */\r\nexport function transformConversation(\r\n  conv: RawConversationRow,\r\n  profileMap: Map<string, RawProfileRow>\r\n): Conversation {\r\n  const buyerProfile = profileMap.get(conv.buyer_id)\r\n  const sellerProfile = profileMap.get(conv.seller_id)\r\n  const productRow = Array.isArray(conv.product) ? conv.product[0] ?? null : conv.product\r\n\r\n  return {\r\n    ...conv,\r\n    status: (conv.status || \"open\") as \"open\" | \"closed\" | \"archived\",\r\n    buyer_unread_count: conv.buyer_unread_count || 0,\r\n    seller_unread_count: conv.seller_unread_count || 0,\r\n    buyer_profile: buyerProfile\r\n      ? {\r\n          id: buyerProfile.id,\r\n          full_name: buyerProfile.full_name,\r\n          avatar_url: buyerProfile.avatar_url,\r\n          display_name: buyerProfile.display_name,\r\n          username: buyerProfile.username,\r\n        }\r\n      : null,\r\n    seller_profile: sellerProfile\r\n      ? {\r\n          id: sellerProfile.id,\r\n          full_name: sellerProfile.full_name,\r\n          avatar_url: sellerProfile.avatar_url,\r\n          display_name: sellerProfile.display_name,\r\n          business_name: sellerProfile.business_name,\r\n          username: sellerProfile.username,\r\n        }\r\n      : null,\r\n    product: productRow\r\n      ? {\r\n          id: productRow.id,\r\n          title: productRow.title,\r\n          images: productRow.images || [],\r\n        }\r\n      : null,\r\n    // Legacy compatibility mappings\r\n    buyer: buyerProfile\r\n      ? {\r\n          id: buyerProfile.id,\r\n          full_name: buyerProfile.display_name || buyerProfile.full_name,\r\n          avatar_url: buyerProfile.avatar_url,\r\n        }\r\n      : { id: conv.buyer_id, full_name: null, avatar_url: null },\r\n    seller: sellerProfile\r\n      ? {\r\n          id: sellerProfile.id,\r\n          business_name:\r\n            sellerProfile.business_name ||\r\n            sellerProfile.display_name ||\r\n            sellerProfile.full_name,\r\n          user_id: sellerProfile.id,\r\n          profile: {\r\n            full_name: sellerProfile.display_name || sellerProfile.full_name,\r\n            avatar_url: sellerProfile.avatar_url,\r\n          },\r\n        }\r\n      : { id: conv.seller_id, business_name: null, user_id: conv.seller_id },\r\n  }\r\n}\r\n\r\n/**\r\n * Transform raw message row to Message type with sender profile\r\n */\r\nexport function transformMessage(\r\n  msg: RawMessageRow,\r\n  senderProfile?: RawProfileRow\r\n): Message {\r\n  const base = {\r\n    id: msg.id,\r\n    conversation_id: msg.conversation_id,\r\n    sender_id: msg.sender_id,\r\n    content: msg.content,\r\n    message_type: (msg.message_type || \"text\") as MessageType,\r\n    is_read: msg.is_read,\r\n    read_at: msg.read_at,\r\n    created_at: msg.created_at,\r\n  }\r\n\r\n  if (senderProfile) {\r\n    return {\r\n      ...base,\r\n      sender: {\r\n        id: senderProfile.id,\r\n        full_name: senderProfile.full_name,\r\n        avatar_url: senderProfile.avatar_url,\r\n      },\r\n    }\r\n  }\r\n\r\n  return base\r\n}\r\n\r\n// =============================================================================\r\n// CONVERSATION QUERIES\r\n// =============================================================================\r\n\r\nconst CONVERSATION_SELECT = `\r\n  id,\r\n  buyer_id,\r\n  seller_id,\r\n  product_id,\r\n  order_id,\r\n  subject,\r\n  status,\r\n  last_message_at,\r\n  buyer_unread_count,\r\n  seller_unread_count,\r\n  created_at,\r\n  updated_at,\r\n  product:products(id, title, images)\r\n`\r\n\r\ntype UserConversationRpcRow = {\r\n  id: string\r\n  buyer_id: string\r\n  seller_id: string\r\n  product_id: string | null\r\n  order_id: string | null\r\n  subject: string | null\r\n  status: string | null\r\n  last_message_at: string | null\r\n  buyer_unread_count: number | null\r\n  seller_unread_count: number | null\r\n  created_at: string\r\n  updated_at: string\r\n  product_title: string | null\r\n  product_images: string[] | null\r\n  last_message_content: string | null\r\n  last_message_sender_id: string | null\r\n  last_message_type: string | null\r\n  last_message_created_at: string | null\r\n}\r\n\r\n/**\r\n * Fetch all conversations for a user\r\n */\r\nexport async function fetchConversations(\r\n  supabase: SupabaseClient<Database>,\r\n  userId: string\r\n): Promise<{ conversations: Conversation[]; unreadCount: number }> {\r\n  const { data: rows, error } = await supabase.rpc(\"get_user_conversations\", {\r\n    p_user_id: userId,\r\n  })\r\n\r\n  if (error) throw error\r\n\r\n  const convs = (rows ?? []) as UserConversationRpcRow[]\r\n\r\n  if (convs.length === 0) {\r\n    return { conversations: [], unreadCount: 0 }\r\n  }\r\n\r\n  // Collect all unique user IDs\r\n  const userIds = new Set<string>()\r\n  convs.forEach((conv) => {\r\n    userIds.add(conv.buyer_id)\r\n    userIds.add(conv.seller_id)\r\n  })\r\n\r\n  // Fetch profiles for richer display_name/username fields\r\n  const profileMap = await fetchProfiles(supabase, Array.from(userIds))\r\n\r\n  // Transform conversations with last message data\r\n  const conversations = convs.map((conv) => {\r\n    const raw: RawConversationRow = {\r\n      id: conv.id,\r\n      buyer_id: conv.buyer_id,\r\n      seller_id: conv.seller_id,\r\n      product_id: conv.product_id,\r\n      order_id: conv.order_id,\r\n      subject: conv.subject,\r\n      status: conv.status,\r\n      last_message_at: conv.last_message_at,\r\n      buyer_unread_count: conv.buyer_unread_count,\r\n      seller_unread_count: conv.seller_unread_count,\r\n      created_at: conv.created_at,\r\n      updated_at: conv.updated_at,\r\n      product:\r\n        conv.product_id && conv.product_title\r\n          ? { id: conv.product_id, title: conv.product_title, images: conv.product_images }\r\n          : null,\r\n    }\r\n\r\n    const transformed = transformConversation(raw, profileMap)\r\n\r\n    if (\r\n      conv.last_message_content &&\r\n      conv.last_message_sender_id &&\r\n      conv.last_message_type &&\r\n      conv.last_message_created_at\r\n    ) {\r\n      transformed.last_message = {\r\n        content: conv.last_message_content,\r\n        sender_id: conv.last_message_sender_id,\r\n        message_type: conv.last_message_type,\r\n        created_at: conv.last_message_created_at,\r\n      }\r\n    }\r\n\r\n    return transformed\r\n  })\r\n\r\n  // Calculate total unread\r\n  const unreadCount = conversations.reduce((sum, conv) => {\r\n    if (conv.buyer_id === userId) {\r\n      return sum + (conv.buyer_unread_count || 0)\r\n    }\r\n    return sum + (conv.seller_unread_count || 0)\r\n  }, 0)\r\n\r\n  return { conversations, unreadCount }\r\n}\r\n\r\n/**\r\n * Fetch a single conversation by ID\r\n */\r\nexport async function fetchConversation(\r\n  supabase: SupabaseClient<Database>,\r\n  conversationId: string\r\n): Promise<Conversation> {\r\n  const { data, error } = await supabase\r\n    .from(\"conversations\")\r\n    .select(CONVERSATION_SELECT)\r\n    .eq(\"id\", conversationId)\r\n    .single()\r\n\r\n  if (error) throw error\r\n\r\n  // Fetch profiles for buyer and seller\r\n  const profileMap = await fetchProfiles(supabase, [data.buyer_id, data.seller_id])\r\n\r\n  // Fetch last message for this conversation\r\n  const { data: lastMsgData } = await supabase\r\n    .from(\"messages\")\r\n    .select(\"content, sender_id, message_type, created_at\")\r\n    .eq(\"conversation_id\", conversationId)\r\n    .order(\"created_at\", { ascending: false })\r\n    .limit(1)\r\n    .single()\r\n\r\n  const transformed = transformConversation(data as RawConversationRow, profileMap)\r\n  if (lastMsgData) {\r\n    transformed.last_message = {\r\n      content: lastMsgData.content,\r\n      sender_id: lastMsgData.sender_id,\r\n      message_type: lastMsgData.message_type ?? \"text\",\r\n      created_at: lastMsgData.created_at,\r\n    }\r\n  }\r\n  return transformed\r\n}\r\n\r\n// =============================================================================\r\n// MESSAGE QUERIES\r\n// =============================================================================\r\n\r\nconst MESSAGE_SELECT =\r\n  \"id, conversation_id, sender_id, content, message_type, is_read, read_at, created_at\"\r\n\r\n/**\r\n * Fetch messages for a conversation\r\n */\r\nexport async function fetchMessages(\r\n  supabase: SupabaseClient<Database>,\r\n  conversationId: string\r\n): Promise<Message[]> {\r\n  const { data: msgs, error } = await supabase\r\n    .from(\"messages\")\r\n    .select(MESSAGE_SELECT)\r\n    .eq(\"conversation_id\", conversationId)\r\n    .order(\"created_at\", { ascending: true })\r\n\r\n  if (error) throw error\r\n\r\n  if (!msgs || msgs.length === 0) return []\r\n\r\n  // Fetch sender profiles\r\n  const senderIds = [...new Set(msgs.map((m) => m.sender_id))]\r\n  const senderMap = await fetchProfiles(supabase, senderIds)\r\n\r\n  return msgs.map((msg) =>\r\n    transformMessage(msg as RawMessageRow, senderMap.get(msg.sender_id))\r\n  )\r\n}\r\n\r\n/**\r\n * Fetch a single sender profile\r\n */\r\nexport async function fetchSenderProfile(\r\n  supabase: SupabaseClient<Database>,\r\n  senderId: string\r\n): Promise<Pick<RawProfileRow, \"id\" | \"full_name\" | \"avatar_url\"> | null> {\r\n  const { data } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"id, full_name, avatar_url\")\r\n    .eq(\"id\", senderId)\r\n    .single()\r\n\r\n  return data\r\n}\r\n\r\n// =============================================================================\r\n// MESSAGE MUTATIONS\r\n// =============================================================================\r\n\r\n/**\r\n * Send a new message\r\n */\r\nexport async function sendMessageToConversation(\r\n  supabase: SupabaseClient<Database>,\r\n  conversationId: string,\r\n  senderId: string,\r\n  content: string\r\n): Promise<RawMessageRow> {\r\n  const { data, error } = await supabase\r\n    .from(\"messages\")\r\n    .insert({\r\n      conversation_id: conversationId,\r\n      sender_id: senderId,\r\n      content: content.trim(),\r\n      message_type: \"text\",\r\n    })\r\n    .select(MESSAGE_SELECT)\r\n    .single()\r\n\r\n  if (error) throw error\r\n\r\n  return data as RawMessageRow\r\n}\r\n\r\n/**\r\n * Mark messages as read in a conversation\r\n */\r\nexport async function markConversationRead(\r\n  supabase: SupabaseClient<Database>,\r\n  conversationId: string\r\n): Promise<void> {\r\n  const { error } = await supabase.rpc(\"mark_messages_read\", {\r\n    p_conversation_id: conversationId,\r\n  })\r\n\r\n  if (error) throw error\r\n}\r\n\r\n/**\r\n * Close a conversation\r\n */\r\nexport async function closeConversationInDb(\r\n  supabase: SupabaseClient<Database>,\r\n  conversationId: string\r\n): Promise<void> {\r\n  const { error } = await supabase\r\n    .from(\"conversations\")\r\n    .update({ status: \"closed\" })\r\n    .eq(\"id\", conversationId)\r\n\r\n  if (error) throw error\r\n}\r\n\r\n/**\r\n * Get or create a conversation\r\n */\r\nexport async function getOrCreateConversation(\r\n  supabase: SupabaseClient<Database>,\r\n  sellerId: string,\r\n  productId?: string,\r\n  subject?: string\r\n): Promise<string> {\r\n  const { data, error } = await supabase.rpc(\"get_or_create_conversation\", {\r\n    p_seller_id: sellerId,\r\n    ...(productId ? { p_product_id: productId } : {}),\r\n    ...(subject ? { p_subject: subject } : {}),\r\n  })\r\n\r\n  if (error) throw error\r\n\r\n  return data as string\r\n}\r\n\r\n/**\r\n * Refresh unread count via RPC\r\n */\r\nexport async function fetchTotalUnreadCount(\r\n  supabase: SupabaseClient<Database>\r\n): Promise<number> {\r\n  const { data, error } = await supabase.rpc(\"get_total_unread_messages\")\r\n\r\n  if (error) {\r\n    logger.error(\"[Chat] Error fetching unread count\", error)\r\n    return 0\r\n  }\r\n\r\n  return data ?? 0\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\supabase\\middleware.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\supabase\\selects\\billing.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\supabase\\selects\\categories.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\supabase\\selects\\products.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\supabase\\server.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\supabase\\shared.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\types\\badges.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BadgeAccountType' is defined but never used.","line":20,"column":6,"nodeType":"Identifier","messageId":"unusedVar","endLine":20,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BadgeCriteria' is defined but never used.","line":22,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":22,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UserBadge' is defined but never used.","line":77,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":77,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'IdDocumentType' is defined but never used.","line":94,"column":6,"nodeType":"Identifier","messageId":"unusedVar","endLine":94,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SellerStats' is defined but never used.","line":137,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":137,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BuyerStats' is defined but never used.","line":160,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":160,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SellerFeedback' is defined but never used.","line":181,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":181,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BuyerFeedback' is defined but never used.","line":202,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":202,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrustScoreBreakdown' is defined but never used.","line":237,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":237,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SellerProfileBadges' is defined but never used.","line":251,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":251,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BuyerProfileBadges' is defined but never used.","line":259,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":259,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BadgeEvaluationResult' is defined but never used.","line":270,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":270,"endColumn":32},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'VerificationStatus' is defined but never used.","line":276,"column":11,"nodeType":"Identifier","messageId":"unusedVar","endLine":276,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":13,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Badge & Verification System Types\r\n * Version 1.0 | December 2025\r\n */\r\n\r\n// =====================================================\r\n// BADGE DEFINITIONS\r\n// =====================================================\r\n\r\nexport type BadgeCategory =\r\n  | \"seller_milestone\"\r\n  | \"seller_rating\"\r\n  | \"seller_special\"\r\n  | \"buyer_milestone\"\r\n  | \"buyer_rating\"\r\n  | \"buyer_special\"\r\n  | \"verification\"\r\n  | \"subscription\"\r\n\r\ntype BadgeAccountType = \"personal\" | \"business\" | \"buyer\" | \"all\"\r\n\r\ninterface BadgeCriteria {\r\n  // Listing criteria\r\n  min_listings?: number\r\n  max_listings?: number\r\n  // Sales criteria\r\n  min_sales?: number\r\n  max_sales?: number\r\n  // Rating criteria\r\n  min_rating?: number\r\n  min_reviews?: number\r\n  min_ratings?: number\r\n  // Order criteria (for buyers)\r\n  min_orders?: number\r\n  max_orders?: number\r\n  // Engagement criteria\r\n  min_reviews_written?: number\r\n  min_stores_following?: number\r\n  min_wishlist_count?: number\r\n  min_followers?: number\r\n  min_conversations?: number\r\n  // Performance criteria\r\n  min_shipped_on_time_pct?: number\r\n  max_response_time_hours?: number\r\n  min_repeat_customer_pct?: number\r\n  min_account_age_years?: number\r\n  // Verification criteria\r\n  email_verified?: boolean\r\n  phone_verified?: boolean\r\n  id_verified?: boolean\r\n  vat_verified?: boolean\r\n  registration_verified?: boolean\r\n  verification_level?: number\r\n  // Subscription criteria\r\n  subscription_tier?: \"starter\" | \"professional\" | \"enterprise\"\r\n}\r\n\r\nexport interface BadgeDefinition {\r\n  id: string\r\n  code: string\r\n  name: string\r\n  name_bg: string | null\r\n  description: string | null\r\n  description_bg: string | null\r\n  // DB returns string, we accept it broadly for compatibility\r\n  category: string\r\n  account_type: string | null\r\n  icon: string | null\r\n  color: string | null\r\n  tier: number | null\r\n  is_automatic: boolean | null\r\n  is_active: boolean | null\r\n  criteria: Record<string, unknown>\r\n  created_at: string | null\r\n}\r\n\r\ninterface UserBadge {\r\n  id: string\r\n  user_id: string\r\n  badge_id: string\r\n  awarded_at: string | null\r\n  awarded_by: string | null\r\n  revoked_at: string | null\r\n  revoke_reason: string | null\r\n  metadata: Record<string, unknown>\r\n  // Joined badge definition\r\n  badge_definition?: BadgeDefinition\r\n}\r\n\r\n// =====================================================\r\n// VERIFICATION TYPES\r\n// =====================================================\r\n\r\ntype IdDocumentType = \"passport\" | \"id_card\" | \"drivers_license\"\r\n\r\nexport interface UserVerification {\r\n  id: string\r\n  user_id: string\r\n  email_verified: boolean | null\r\n  phone_verified: boolean | null\r\n  phone_number: string | null\r\n  id_verified: boolean | null\r\n  // DB returns string, but we validate against IdDocumentType\r\n  id_document_type: string | null\r\n  id_verified_at: string | null\r\n  address_verified: boolean | null\r\n  address_verified_at: string | null\r\n  trust_score: number | null\r\n  created_at: string | null\r\n  updated_at: string | null\r\n}\r\n\r\nexport interface BusinessVerification {\r\n  id: string\r\n  seller_id: string\r\n  legal_name: string | null\r\n  vat_number: string | null\r\n  eik_number: string | null\r\n  vat_verified: boolean | null\r\n  vat_verified_at: string | null\r\n  registration_doc_url: string | null\r\n  registration_verified: boolean | null\r\n  registration_verified_at: string | null\r\n  verified_by: string | null\r\n  bank_verified: boolean | null\r\n  bank_verified_at: string | null\r\n  verification_level: number | null\r\n  verification_notes: string | null\r\n  created_at: string | null\r\n  updated_at: string | null\r\n}\r\n\r\n// =====================================================\r\n// STATS TYPES\r\n// =====================================================\r\n\r\ninterface SellerStats {\r\n  seller_id: string\r\n  total_listings: number | null\r\n  active_listings: number | null\r\n  total_sales: number | null\r\n  total_revenue: number | null\r\n  average_rating: number | null\r\n  total_reviews: number | null\r\n  five_star_reviews: number | null\r\n  positive_feedback_pct: number | null\r\n  item_described_pct: number | null\r\n  shipping_speed_pct: number | null\r\n  communication_pct: number | null\r\n  follower_count: number | null\r\n  response_time_hours: number | null\r\n  response_rate_pct: number | null\r\n  shipped_on_time_pct: number | null\r\n  repeat_customer_pct: number | null\r\n  first_sale_at: string | null\r\n  last_sale_at: string | null\r\n  updated_at: string | null\r\n}\r\n\r\ninterface BuyerStats {\r\n  user_id: string\r\n  total_orders: number | null\r\n  total_spent: number | null\r\n  average_rating: number | null\r\n  total_ratings: number | null\r\n  reviews_written: number | null\r\n  stores_following: number | null\r\n  wishlist_count: number | null\r\n  conversations_started: number | null\r\n  disputes_opened: number | null\r\n  disputes_won: number | null\r\n  first_purchase_at: string | null\r\n  last_purchase_at: string | null\r\n  updated_at: string | null\r\n}\r\n\r\n// =====================================================\r\n// FEEDBACK TYPES\r\n// =====================================================\r\n\r\ninterface SellerFeedback {\r\n  id: string\r\n  buyer_id: string\r\n  seller_id: string\r\n  order_id: string | null\r\n  rating: number\r\n  comment: string | null\r\n  item_as_described: boolean | null\r\n  shipping_speed: boolean | null\r\n  communication: boolean | null\r\n  buyer_response: string | null\r\n  buyer_response_at: string | null\r\n  created_at: string | null\r\n  updated_at: string | null\r\n  // Joined data\r\n  buyer?: {\r\n    full_name: string | null\r\n    avatar_url: string | null\r\n  }\r\n}\r\n\r\ninterface BuyerFeedback {\r\n  id: string\r\n  seller_id: string\r\n  buyer_id: string\r\n  order_id: string | null\r\n  rating: number\r\n  comment: string | null\r\n  payment_promptness: boolean | null\r\n  communication: boolean | null\r\n  reasonable_expectations: boolean | null\r\n  seller_response: string | null\r\n  seller_response_at: string | null\r\n  created_at: string | null\r\n  updated_at: string | null\r\n  // Joined data from profiles\r\n  seller?: {\r\n    display_name: string | null\r\n    username: string | null\r\n  }\r\n}\r\n\r\n// =====================================================\r\n// DISPLAY TYPES (for UI components)\r\n// =====================================================\r\n\r\nexport interface DisplayBadge {\r\n  code: string\r\n  name: string\r\n  icon: string\r\n  color: string\r\n  description: string\r\n  tier: number\r\n  category: BadgeCategory\r\n}\r\n\r\ninterface TrustScoreBreakdown {\r\n  verification: number\r\n  performance: number\r\n  total: number\r\n}\r\n\r\nexport interface BadgeProgress {\r\n  badge: BadgeDefinition\r\n  progress: number // 0-100\r\n  requirement: string // Human-readable requirement text\r\n  currentValue: number\r\n  targetValue: number\r\n}\r\n\r\ninterface SellerProfileBadges {\r\n  verification: DisplayBadge[]\r\n  rating: DisplayBadge[]\r\n  milestone: DisplayBadge[]\r\n  special: DisplayBadge[]\r\n  subscription: DisplayBadge | null\r\n}\r\n\r\ninterface BuyerProfileBadges {\r\n  verification: DisplayBadge[]\r\n  milestone: DisplayBadge[]\r\n  rating: DisplayBadge[]\r\n  special: DisplayBadge[]\r\n}\r\n\r\n// =====================================================\r\n// API RESPONSE TYPES\r\n// =====================================================\r\n\r\ninterface BadgeEvaluationResult {\r\n  awarded: BadgeDefinition[]\r\n  revoked: BadgeDefinition[]\r\n  progress: BadgeProgress[]\r\n}\r\n\r\ninterface VerificationStatus {\r\n  user: UserVerification | null\r\n  business: BusinessVerification | null\r\n  trustScore: number\r\n  level: number // 0-5\r\n  levelName: string\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\types\\categories.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\types\\messages.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\types\\products.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\ui\\badge-intent.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\upload\\image-upload.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\url-utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\utils\\category-type.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\validation\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\validation\\orders.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\validation\\password-strength.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\lib\\view-models\\product-page.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Metadata' is defined but never used.","line":1,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":23,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"Metadata"},"fix":{"range":[0,37],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { Metadata } from \"next\";\r\nimport { getCategoryType, type CategoryType } from \"@/lib/utils/category-type\";\r\nimport type { HeroSpec } from \"@/lib/data/product-page\";\r\nexport type { HeroSpec };\r\n\r\n/**\r\n * Resolved hero spec ready for rendering.\r\n * Now sourced from database via get_hero_specs RPC.\r\n */\r\nexport interface ResolvedHeroSpec {\r\n  label: string;\r\n  value: string;\r\n  priority: number;\r\n}\r\n\r\nexport interface GalleryImage {\r\n  src: string;\r\n  altKey: string;\r\n  altParams: Record<string, string | number>;\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport interface ItemSpecificDetail {\r\n  key: string;\r\n  value: string;\r\n}\r\n\r\nexport interface ProductPageItemSpecifics {\r\n  details: ItemSpecificDetail[];\r\n  attributes: Record<string, unknown>;\r\n}\r\n\r\nexport interface SellerProductsGridItem {\r\n  id: string;\r\n  title: string;\r\n  price: number;\r\n  originalPrice: number | null;\r\n  image: string;\r\n  rating: number;\r\n  reviews: number;\r\n  sellerName: string;\r\n  sellerVerified: boolean;\r\n  sellerAvatarUrl: string;\r\n  condition: string;\r\n  freeShipping: boolean;\r\n  categorySlug: string;\r\n  attributes: Record<string, string>;\r\n  storeSlug?: string | null;\r\n  slug?: string | null;\r\n}\r\n\r\nexport interface ProductPageViewModel {\r\n  sellerName: string;\r\n  sellerAvatarUrl: string;\r\n  sellerVerified: boolean;\r\n  galleryImages: GalleryImage[];\r\n  itemSpecifics: ProductPageItemSpecifics;\r\n  relatedProducts: SellerProductsGridItem[];\r\n  jsonLd: Record<string, unknown>;\r\n  breadcrumbJsonLd: Record<string, unknown>;\r\n  /** Category-adaptive hero specs (up to 4 key attributes) */\r\n  heroSpecs: ResolvedHeroSpec[];\r\n  /** Category type for CTA customization */\r\n  categoryType: CategoryType;\r\n}\r\n\r\nexport type ProductPageProductLike = {\r\n  id: string;\r\n  title: string;\r\n  description?: string | null;\r\n  meta_description?: string | null;\r\n  images?: unknown;\r\n  attributes?: unknown;\r\n  condition?: string | null;\r\n  price?: unknown;\r\n  list_price?: unknown;\r\n  rating?: unknown;\r\n  review_count?: unknown;\r\n  stock?: unknown;\r\n  free_shipping?: unknown;\r\n} & Record<string, unknown>;\r\n\r\nexport type ProductPageSellerLike = {\r\n  id: string;\r\n  username?: string | null;\r\n  display_name?: string | null;\r\n  avatar_url?: string | null;\r\n  verified?: unknown;\r\n} & Record<string, unknown>;\r\n\r\nexport type ProductPageCategoryLike = {\r\n  id: string;\r\n  name?: string | null;\r\n  slug?: string | null;\r\n  parent_id?: string | null;\r\n} & Record<string, unknown>;\r\n\r\nconst UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\r\n\r\nexport function isUuid(value: unknown): value is string {\r\n  return typeof value === \"string\" && UUID_REGEX.test(value);\r\n}\r\n\r\nfunction toRecord(value: unknown): Record<string, unknown> {\r\n  return value && typeof value === \"object\" && !Array.isArray(value)\r\n    ? (value as Record<string, unknown>)\r\n    : {};\r\n}\r\n\r\nfunction buildItemSpecificsDetails(attributes: unknown, condition?: string | null) {\r\n  const details: ItemSpecificDetail[] = [];\r\n  \r\n  // Condition comes from dedicated column only (not attributes JSONB)\r\n  if (condition) {\r\n    details.push({ key: \"condition\", value: condition });\r\n  }\r\n\r\n  const attrs = toRecord(attributes);\r\n  for (const [key, value] of Object.entries(attrs)) {\r\n    if (value == null) continue;\r\n    // Skip 'condition' from attributes - it's already shown from the dedicated column above\r\n    if (key.toLowerCase() === 'condition') continue;\r\n    details.push({ key, value: String(value) });\r\n  }\r\n\r\n  return details;\r\n}\r\n\r\nfunction buildGalleryImages(productTitle: string, images: string[]) {\r\n  return images.map((src, idx) => ({\r\n    src,\r\n    altKey: \"imageAlt\",\r\n    altParams: { title: productTitle, index: idx + 1 },\r\n    width: 1200,\r\n    height: 1200,\r\n  }));\r\n}\r\n\r\n/**\r\n * Get product images - prioritizes normalized product_images table (WebP),\r\n * falls back to legacy images JSON array\r\n */\r\nfunction getProductImages(product: ProductPageProductLike): string[] {\r\n  // First check for product_images relation (normalized table with WebP images)\r\n  const productImages = (product as { product_images?: Array<{ image_url: string; is_primary?: boolean; display_order?: number }> }).product_images;\r\n  \r\n  if (Array.isArray(productImages) && productImages.length > 0) {\r\n    // Sort by display_order, then prioritize primary image first\r\n    const sorted = [...productImages].sort((a, b) => {\r\n      // Primary image always comes first\r\n      if (a.is_primary && !b.is_primary) return -1;\r\n      if (!a.is_primary && b.is_primary) return 1;\r\n      // Then sort by display_order\r\n      return (a.display_order ?? 0) - (b.display_order ?? 0);\r\n    });\r\n    return sorted.map(img => img.image_url);\r\n  }\r\n  \r\n  // Fallback to legacy images JSON array\r\n  const raw = product.images;\r\n  return Array.isArray(raw) && raw.length > 0 ? (raw as string[]) : [\"/placeholder.svg\"];\r\n}\r\n\r\nexport function buildProductPageViewModel(args: {\n  username: string;\n  product: ProductPageProductLike;\n  seller: ProductPageSellerLike;\n  category: ProductPageCategoryLike | null;\n  parentCategory: ProductPageCategoryLike | null;\n  relatedProductsRaw: unknown[];\n  /** Database-driven hero specs (preferred). Falls back to config-based if not provided. */\n  heroSpecs?: HeroSpec[];\n  jsonLd: Record<string, unknown>;\n  breadcrumbJsonLd: Record<string, unknown>;\n}): ProductPageViewModel {\n  const { username, product, seller, category, parentCategory, relatedProductsRaw, heroSpecs: dbHeroSpecs, jsonLd, breadcrumbJsonLd } = args;\n\r\n  const sellerName = seller.display_name || seller.username || username;\r\n  const sellerAvatarUrl = seller.avatar_url || \"\";\r\n  const sellerVerified = Boolean(seller.verified);\r\n\r\n  const images = getProductImages(product);\r\n  const galleryImages = buildGalleryImages(product.title, images);\r\n\r\n  const itemSpecifics = {\r\n    details: buildItemSpecificsDetails(product.attributes, product.condition),\r\n    attributes: toRecord(product.attributes),\r\n  } satisfies ProductPageItemSpecifics;\r\n\r\n  const relatedProducts = (Array.isArray(relatedProductsRaw) ? relatedProductsRaw : []).map((p) => {\r\n    const row = p as Record<string, unknown>;\r\n    const rowImages = row.images;\r\n\r\n    return {\r\n      id: String(row.id ?? \"\"),\r\n      title: String(row.title ?? \"\"),\r\n      price: Number(row.price ?? 0),\r\n      originalPrice: row.list_price != null ? Number(row.list_price) : null,\r\n      image: (Array.isArray(rowImages) ? (rowImages[0] as string | undefined) : undefined) || \"/placeholder.svg\",\r\n      rating: Number(row.rating ?? 0),\r\n      reviews: Number(row.review_count ?? 0),\r\n      sellerName,\r\n      sellerVerified,\n      sellerAvatarUrl,\n      condition: String(row.condition || \"\"),\n      freeShipping: row.free_shipping === true,\n      categorySlug: String(row.category_id || \"\"),\n      attributes: (toRecord(row.attributes) as Record<string, string>) ?? {},\n      storeSlug: (seller.username ?? username) ?? null,\n      slug: (row.slug as string | null | undefined) ?? null,\r\n    } satisfies SellerProductsGridItem;\r\n  });\r\n\r\n  // Hero specs are database-driven via get_hero_specs RPC\r\n  // Returns up to 4 key attributes based on category_attributes.is_hero_spec\r\n  const heroSpecs: ResolvedHeroSpec[] = (dbHeroSpecs ?? []).map(spec => ({\r\n    label: spec.label,\r\n    value: spec.value,\r\n    priority: spec.priority,\r\n  }));\r\n  \r\n  const categorySlug = category?.slug ?? null;\r\n  const parentSlug = parentCategory?.slug ?? null;\r\n  const categoryType = getCategoryType(categorySlug, parentSlug);\r\n\r\n  return {\n    sellerName,\n    sellerAvatarUrl,\n    sellerVerified,\n    galleryImages,\n    itemSpecifics,\n    relatedProducts,\n    jsonLd,\n    breadcrumbJsonLd,\n    heroSpecs,\n    categoryType,\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\playwright.config.ts","messages":[{"ruleId":"unicorn/prefer-number-properties","severity":1,"message":"Prefer `Number.parseInt` over `parseInt`.","line":109,"column":5,"nodeType":"Identifier","messageId":"error","endLine":109,"endColumn":13,"fix":{"range":[4139,4147],"text":"Number.parseInt"}},{"ruleId":"unicorn/prefer-number-properties","severity":1,"message":"Prefer `Number.parseInt` over `parseInt`.","line":110,"column":5,"nodeType":"Identifier","messageId":"error","endLine":110,"endColumn":13,"fix":{"range":[4170,4178],"text":"Number.parseInt"}},{"ruleId":"sonarjs/no-collapsible-if","severity":1,"message":"Merge this if statement with the nested one.","line":116,"column":1,"nodeType":null,"messageId":"mergeNestedIfStatement","endLine":116,"endColumn":3},{"ruleId":"unicorn/no-lonely-if","severity":1,"message":"Unexpected `if` as the only statement in a `if` block without `else`.","line":118,"column":3,"nodeType":"IfStatement","messageId":"no-lonely-if","endLine":121,"endColumn":4,"fix":{"range":[4336,4574],"text":"(!reuseExistingServer && !explicitBaseURL && !latchedBaseURL && isLocalHost && // Check if the default port is in use\r\n  isPortInUse(defaultPort)) {\r\n    finalPort = findFreePort(defaultPort + 1)\r\n    didAutoPickPort = true\r\n  }"}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":3,"source":"import { defineConfig, devices } from '@playwright/test'\r\nimport { execSync } from 'node:child_process'\r\nimport fs from 'node:fs'\r\nimport path from 'node:path'\r\nimport dotenv from 'dotenv'\r\n\r\n// Capture shell environment BEFORE dotenv runs\r\nconst shellReuseServer = process.env.REUSE_EXISTING_SERVER\r\nconst shellBaseURL = process.env.BASE_URL\r\n// Internal latch: when we auto-pick a port, persist it so subsequent config\r\n// evaluations (Playwright can load config in multiple processes) stay consistent.\r\nconst latchedBaseURL = process.env.PW_LATCHED_BASE_URL\r\nconst latchedPort = process.env.PW_LATCHED_PORT\r\n\r\n/**\r\n * Check if a port is currently in use (synchronous via spawnSync).\r\n * Returns true if port is occupied, false if available.\r\n */\r\nfunction isPortInUse(port: number): boolean {\r\n  try {\r\n    if (process.platform === 'win32') {\r\n      // Windows: use netstat to check if port is listening\r\n      const result = execSync(\r\n        `netstat -ano | findstr \":${port}\" | findstr \"LISTENING\"`,\r\n        { encoding: 'utf8', timeout: 5000, stdio: ['pipe', 'pipe', 'pipe'] }\r\n      )\r\n      return result.trim().length > 0\r\n    } else {\r\n      // Unix: use lsof\r\n      execSync(`lsof -i :${port} -sTCP:LISTEN`, {\r\n        encoding: 'utf8',\r\n        timeout: 5000,\r\n        stdio: ['pipe', 'pipe', 'pipe'],\r\n      })\r\n      return true\r\n    }\r\n  } catch {\r\n    // Command failed = port not in use (or command not found, assume available)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Find a free port starting from the given port.\r\n * Returns the first available port.\r\n */\r\nfunction findFreePort(startPort: number, maxAttempts = 20): number {\r\n  for (let i = 0; i < maxAttempts; i++) {\r\n    const port = startPort + i\r\n    if (!isPortInUse(port)) {\r\n      return port\r\n    }\r\n  }\r\n  // Fallback: return a port in the dynamic range\r\n  return 3000 + Math.floor(Math.random() * 1000)\r\n}\r\n\r\n// Ensure Playwright has access to the same env vars as Next.js dev.\r\n// - Does not override already-set process.env (CI or shell takes precedence).\r\n// - Keeps E2E runs deterministic without requiring cross-env for every command.\r\nfor (const file of ['.env.local', '.env']) {\r\n  const fullPath = path.join(process.cwd(), file)\r\n  if (fs.existsSync(fullPath)) dotenv.config({ path: fullPath, override: false })\r\n}\r\n\r\n// Restore shell value if it was set (dotenv should NOT have overridden it, but just in case)\r\nif (shellReuseServer != null) {\r\n  process.env.REUSE_EXISTING_SERVER = shellReuseServer\r\n}\r\n\r\n/**\r\n * Playwright Configuration for Production Readiness Testing\r\n * \r\n * This configuration supports:\r\n * - Smoke testing against dev server (pnpm dev)\r\n * - Production testing against build (pnpm start)\r\n * - Cross-browser testing (Chromium, Firefox, WebKit)\r\n * - Mobile viewport testing\r\n * - Accessibility testing with axe-core\r\n * - Console error capture\r\n */\r\n\r\nconst isCI = !!process.env.CI\r\nconst isProdTest = process.env.TEST_PROD === 'true'\r\nconst outputDir = process.env.PW_OUTPUT_DIR || 'test-results'\r\nconst debugConfig =\r\n  process.env.PW_DEBUG_CONFIG === 'true' || process.env.PW_DEBUG_CONFIG === '1'\r\n// E2E should be self-contained by default (start its own server) to avoid\r\n// flakiness when no dev server is running.\r\n// Override explicitly via REUSE_EXISTING_SERVER=true/false.\r\nconst reuseExistingServer =\r\n  process.env.REUSE_EXISTING_SERVER != null\r\n    ? process.env.REUSE_EXISTING_SERVER === 'true'\r\n    : false\r\n\r\n// Determine if we should auto-pick a free port:\r\n// - Only when NOT reusing an existing server\r\n// - Only when BASE_URL was NOT explicitly set by the user\r\n// - Only for local hosts (localhost / 127.0.0.1)\r\nconst explicitBaseURL = shellBaseURL // captured before dotenv\r\n// Prefer 127.0.0.1 over localhost on Windows to avoid IPv6 ::1 resolution\r\n// mismatches when the dev server is bound to IPv4 only.\r\nconst defaultBaseURL = 'http://127.0.0.1:3000'\r\nconst rawBaseURL = explicitBaseURL || latchedBaseURL || defaultBaseURL\r\nconst parsedBase = new URL(rawBaseURL)\r\nconst isLocalHost =\r\n  parsedBase.hostname === 'localhost' || parsedBase.hostname === '127.0.0.1'\r\nconst defaultPort = latchedPort\r\n  ? parseInt(latchedPort, 10)\r\n  : parseInt(parsedBase.port || '3000', 10)\r\n\r\n// Auto-pick logic: find a free port if conditions are met\r\nlet finalPort = defaultPort\r\nlet didAutoPickPort = false\r\n\r\nif (!reuseExistingServer && !explicitBaseURL && !latchedBaseURL && isLocalHost) {\r\n  // Check if the default port is in use\r\n  if (isPortInUse(defaultPort)) {\r\n    finalPort = findFreePort(defaultPort + 1)\r\n    didAutoPickPort = true\r\n  }\r\n}\r\n\r\n// Construct the final baseURL\r\nconst baseURL = explicitBaseURL\r\n  ? explicitBaseURL\r\n  : latchedBaseURL\r\n    ? latchedBaseURL\r\n    : `${parsedBase.protocol}//${parsedBase.hostname}:${finalPort}`\r\n\r\nconst basePort = String(finalPort)\r\n\r\n// Latch computed baseURL/port for consistency across Playwright processes.\r\n// Do not override a user-provided BASE_URL.\r\nif (!explicitBaseURL) {\r\n  process.env.PW_LATCHED_BASE_URL = baseURL\r\n  process.env.PW_LATCHED_PORT = basePort\r\n}\r\n\r\n// Propagate resolved values so fixtures that read process.env directly stay in sync.\r\nprocess.env.BASE_URL = baseURL\r\nprocess.env.PORT = basePort\r\n\r\n// Safety: avoid accidentally running E2E against production/staging (can create data).\r\n// Override explicitly when you really intend to run against a remote environment.\r\nconst allowNonLocalE2E =\r\n  process.env.PW_ALLOW_NON_LOCAL === 'true' ||\r\n  process.env.PW_ALLOW_NON_LOCAL === '1' ||\r\n  process.env.E2E_ALLOW_NON_LOCAL === 'true' ||\r\n  process.env.E2E_ALLOW_NON_LOCAL === '1'\r\n\r\nconst finalBase = new URL(baseURL)\r\nconst isFinalLocalHost =\r\n  finalBase.hostname === 'localhost' || finalBase.hostname === '127.0.0.1'\r\n\r\nif (!isFinalLocalHost && !allowNonLocalE2E) {\r\n  throw new Error(\r\n    `[Playwright Config] Refusing to run against non-local BASE_URL (${baseURL}). ` +\r\n      `Set PW_ALLOW_NON_LOCAL=true (or E2E_ALLOW_NON_LOCAL=true) to override.`\r\n  )\r\n}\r\n\r\nif (debugConfig) {\r\n  // Debug: Log the configuration (quiet by default for CI/tooling like knip)\r\n  console.log(\r\n    '[Playwright Config] REUSE_EXISTING_SERVER:',\r\n    process.env.REUSE_EXISTING_SERVER,\r\n    '-> reuseExistingServer:',\r\n    reuseExistingServer\r\n  )\r\n  if (didAutoPickPort) {\r\n    console.log(\r\n      `[Playwright Config] Port ${defaultPort} is busy, auto-picked port: ${finalPort}`\r\n    )\r\n  }\r\n  console.log('[Playwright Config] baseURL:', baseURL)\r\n}\r\n// Use an endpoint that should reliably return 2xx once Next is up.\r\n// NOTE: /robots.txt can be affected by app metadata/route issues; /en is a\r\n// better readiness signal for this app.\r\nconst webServerURL = `${baseURL}/en`\r\nconst timestampedReport =\r\n  process.env.PW_TIMESTAMPED_REPORT === 'true' ||\r\n  process.env.PW_TIMESTAMPED_REPORT === '1'\r\n\r\nconst skipWebServer =\r\n  process.env.PW_SKIP_WEBSERVER === 'true' || process.env.PW_SKIP_WEBSERVER === '1'\r\n\r\nconst htmlReportFolder =\r\n  process.env.PW_HTML_REPORT_DIR ||\r\n  (timestampedReport ? `playwright-report-${Date.now()}` : 'playwright-report')\r\n\r\nfunction envWith(overrides: Record<string, string>): Record<string, string> {\r\n  const env: Record<string, string> = {}\r\n  for (const [key, value] of Object.entries(process.env)) {\r\n    if (typeof value === 'string') env[key] = value\r\n  }\r\n  for (const [key, value] of Object.entries(overrides)) env[key] = value\r\n  return env\r\n}\r\n\r\nexport default defineConfig({\r\n  // Warm key routes once before all tests so first-hit Next.js dev compilation\r\n  // does not cause early test timeouts.\r\n  globalSetup: require.resolve('./e2e/global-setup'),\r\n\r\n  // Test directory\r\n  testDir: './e2e',\r\n\r\n  // Run tests in parallel\r\n  fullyParallel: true,\r\n\r\n  // Fail the build on CI if you accidentally left test.only in the source code\r\n  forbidOnly: isCI,\r\n\r\n  // Retry on CI only\r\n  retries: isCI ? 2 : 0,\r\n\r\n  // Opt out of parallel tests on CI for stability\r\n  ...(isProdTest && !isCI ? {} : { workers: 1 }),\r\n\r\n  // Reporter configuration\r\n  reporter: [\r\n    ['html', { outputFolder: htmlReportFolder, open: 'never' }],\r\n    ['list'],\r\n    ...(isCI ? [['github'] as const] : []),\r\n  ],\r\n\r\n  // Global timeout for each test\r\n  // Next.js dev mode can spend significant time compiling routes on first hit.\r\n  // Keep tests stable by allowing more time for initial navigations.\r\n  timeout: 60_000,\r\n\r\n  // Shared settings for all projects\r\n  use: {\r\n    // Base URL for navigation\r\n    baseURL,\r\n\r\n    // Next.js dev-mode route compilation can exceed Playwright's 30s default.\r\n    navigationTimeout: 60_000,\r\n\r\n    // Collect trace on first retry\r\n    trace: 'on-first-retry',\r\n\r\n    // Screenshot on failure\r\n    screenshot: 'only-on-failure',\r\n\r\n    // Video on failure\r\n    video: 'on-first-retry',\r\n\r\n    // Viewport\r\n    viewport: { width: 1280, height: 720 },\r\n\r\n    // Ignore HTTPS errors\r\n    ignoreHTTPSErrors: true,\r\n\r\n    // Standardize test-id selector across the suite.\r\n    // Prefer page.getByTestId('...') over brittle CSS.\r\n    testIdAttribute: 'data-testid',\r\n  },\r\n\r\n  // Test projects for different browsers/viewports\r\n  projects: [\r\n    // Desktop browsers\r\n    {\r\n      name: 'chromium',\r\n      testIgnore: /accessibility\\.spec\\.ts/,\r\n      use: { ...devices['Desktop Chrome'] },\r\n    },\r\n    {\r\n      name: 'firefox',\r\n      testIgnore: /accessibility\\.spec\\.ts/,\r\n      use: { ...devices['Desktop Firefox'] },\r\n    },\r\n    {\r\n      name: 'webkit',\r\n      testIgnore: /accessibility\\.spec\\.ts/,\r\n      use: { ...devices['Desktop Safari'] },\r\n    },\r\n\r\n    // Mobile viewports\r\n    {\r\n      name: 'mobile-chrome',\r\n      testIgnore: /accessibility\\.spec\\.ts/,\r\n      use: { ...devices['Pixel 5'] },\r\n    },\r\n    {\r\n      name: 'mobile-safari',\r\n      testIgnore: /accessibility\\.spec\\.ts/,\r\n      use: { ...devices['iPhone 12'] },\r\n    },\r\n\r\n    // Accessibility-focused project (runs subset of tests)\r\n    {\r\n      name: 'accessibility',\r\n      use: { ...devices['Desktop Chrome'] },\r\n      testMatch: /accessibility\\.spec\\.ts/,\r\n    },\r\n  ],\r\n\r\n  // Web server configuration\r\n  // - If the server is already running, reuse it.\r\n  // - If not, start it using the command below.\r\n  //\r\n  // With `exactOptionalPropertyTypes: true`, avoid `webServer: undefined`.\r\n  ...(skipWebServer\r\n    ? {}\r\n    : {\r\n        webServer: {\r\n          command:\r\n            process.env.TEST_PROD === 'true'\r\n              ? `pnpm -s build && pnpm -s start`\r\n              : `node scripts/playwright-web-server.mjs`,\r\n          url: webServerURL,\r\n          reuseExistingServer,\r\n          env:\r\n            process.env.TEST_PROD === 'true'\r\n              ? envWith({ PORT: basePort })\r\n              : envWith({\r\n                  NEXT_PUBLIC_E2E: 'true',\r\n                  PW_USE_WEBPACK: 'true',\r\n                  PORT: basePort,\r\n                  HOSTNAME: '127.0.0.1',\r\n                }),\r\n          // Even when reusing an existing dev server, the first request to a route can\r\n          // trigger slow on-demand compilation. Keep the readiness timeout generous.\r\n          timeout: 120_000,\r\n          ...(isCI ? { stdout: 'pipe', stderr: 'pipe' } : {}),\r\n        },\r\n      }),\r\n\r\n  // Output directory for test artifacts\r\n  outputDir,\r\n\r\n  // Expect configuration\r\n  expect: {\r\n    // Increase timeout for accessibility tests\r\n    timeout: 10_000,\r\n  },\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\proxy.ts","messages":[{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":29,"column":5,"nodeType":"CallExpression","messageId":"array-from","endLine":29,"endColumn":29,"fix":{"range":[985,1009],"text":"[...overrideList]"}},{"ruleId":"unicorn/consistent-function-scoping","severity":1,"message":"Move arrow function 'normalizeCountry' to the outer scope.","line":45,"column":43,"nodeType":"ArrowFunctionExpression","messageId":"consistent-function-scoping","endLine":45,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import createMiddleware from 'next-intl/middleware';\nimport { routing } from './i18n/routing';\nimport { NextRequest } from 'next/server';\nimport { updateSession } from \"@/lib/supabase/middleware\"\nimport { getShippingRegion } from '@/lib/shipping';\n\r\n// Create the i18n routing handler\r\nconst handleI18nRouting = createMiddleware(routing);\r\n\r\n/**\n * Next.js 16 Proxy (renamed from middleware)\n * Handles i18n routing, geo-detection, and session management\n */\nexport default async function proxy(request: NextRequest) {\n  const response = handleI18nRouting(request);\n\n  // Pass pathname to layout for conditional rendering (request headers, not response headers)\n  const overrideHeaders = response.headers.get('x-middleware-override-headers');\n  const overrideList = new Set(\n    (overrideHeaders ?? '')\n      .split(',')\n      .map((value) => value.trim())\n      .filter(Boolean)\n  );\n\n  overrideList.add('x-pathname');\n  response.headers.set(\n    'x-middleware-override-headers',\n    Array.from(overrideList).join(',')\n  );\n  response.headers.set('x-middleware-request-x-pathname', request.nextUrl.pathname);\n\r\n  // Geo-detection: Set user-country and user-zone cookies if not present\r\n  const existingCountryRaw = request.cookies.get('user-country')?.value;\r\n  const existingZone = request.cookies.get('user-zone')?.value;\r\n\r\n  // Prefer existing cookie country; otherwise detect from headers\r\n  const detectedCountryRaw =\r\n    request.headers.get('x-vercel-ip-country') ||\r\n    request.headers.get('cf-ipcountry') ||\r\n    request.headers.get('x-country-code') ||\r\n    'BG'; // Default to Bulgaria for local development\r\n\r\n  // Normalize legacy/alternate values\r\n  const normalizeCountry = (code: string) => {\r\n    const upper = code.toUpperCase();\r\n    if (upper === 'UK') return 'GB';\r\n    if (upper === 'WW') return 'BG';\r\n    return upper;\r\n  };\r\n\r\n  const countryCode = normalizeCountry(existingCountryRaw || detectedCountryRaw);\r\n  const shippingRegion = existingZone || getShippingRegion(countryCode);\r\n\r\n  // Set cookies for 1 year (only if missing)\r\n  if (!existingCountryRaw) {\r\n    response.cookies.set('user-country', countryCode, {\r\n      maxAge: 60 * 60 * 24 * 365,\r\n      path: '/',\r\n      sameSite: 'lax',\r\n    });\r\n  }\r\n\r\n  if (!existingZone) {\r\n    response.cookies.set('user-zone', shippingRegion, {\r\n      maxAge: 60 * 60 * 24 * 365,\r\n      path: '/',\r\n      sameSite: 'lax',\r\n    });\r\n  }\r\n\n  return await updateSession(request, response);\n}\n\n// Named export for tests and internal usage.\nexport { proxy }\n\nexport const config = {\n  // Run proxy only for actual app routes.\n  // Avoid executing on:\n  // - API routes\n  // - Next.js internals\n  // - common static files (icons, images, maps, etc.)\n  // - robots/sitemap\n  matcher: [\n    '/((?!api(?:/|$)|_next(?:/|$)|_vercel(?:/|$)|favicon\\\\.ico$|robots\\\\.txt$|sitemap\\\\.xml$|manifest\\\\.webmanifest$|.*\\\\.(?:png|jpg|jpeg|gif|webp|avif|svg|ico|css|js|mjs|map|txt|xml|json|woff|woff2|ttf|otf)$).*)',\n  ],\n};\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\build-launch-readiness.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\check-docs-site.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\clean-artifacts.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\clear-next-dev-lock.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\docs-gate.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\export-admin-docs.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\next-build.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\playwright-web-server.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\prod\\archive-junk-products.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\run-playwright.mjs","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'no-await-in-loop').","line":61,"column":5,"severity":1,"nodeType":null,"fix":{"range":[1742,1786],"text":" "}},{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'no-await-in-loop').","line":84,"column":5,"severity":1,"nodeType":null,"fix":{"range":[2353,2397],"text":" "}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":2,"source":"import { spawn } from 'node:child_process'\nimport net from 'node:net'\nimport path from 'node:path'\nimport { setTimeout as delay } from 'node:timers/promises'\n\nconst READY_PATH = process.env.PW_READY_PATH || '/api/health/env'\n\nasync function detectRunningBaseURL() {\n  if (process.env.BASE_URL) return process.env.BASE_URL\n\n  const host = process.env.PW_E2E_HOST || '127.0.0.1'\n\r\n  // If a port is explicitly provided, prefer it.\r\n  if (process.env.PORT) {\r\n    return `http://${host}:${process.env.PORT}`\r\n  }\r\n\r\n  // Only attempt auto-detection when the caller asked to reuse an existing server.\r\n  if (process.env.REUSE_EXISTING_SERVER !== 'true') return undefined\r\n\r\n  const portsToTry = Array.from({ length: 11 }, (_, i) => 3000 + i)\r\n\r\n  for (const port of portsToTry) {\n    const controller = new AbortController()\n    const timeout = setTimeout(() => controller.abort(), 800)\n\n    try {\n      // Prefer a lightweight endpoint so cold starts don't time out on Windows.\n      const res = await fetch(`http://${host}:${port}${READY_PATH}`, {\n        method: 'GET',\n        signal: controller.signal,\n      })\n\n      if (res.ok) {\n        return `http://${host}:${port}`\r\n      }\r\n    } catch {\r\n      // ignore\r\n    } finally {\r\n      clearTimeout(timeout)\r\n    }\r\n  }\r\n\n  return undefined\n}\n\nasync function isPortFree(port) {\n  return await new Promise((resolve) => {\n    const server = net.createServer()\n    server.unref()\n    server.on('error', () => resolve(false))\n    server.listen({ port, host: '127.0.0.1' }, () => {\n      server.close(() => resolve(true))\n    })\n  })\n}\n\nasync function findFreePort(startPort = 3000, attempts = 20) {\n  for (let offset = 0; offset < attempts; offset++) {\n    const port = startPort + offset\n    // eslint-disable-next-line no-await-in-loop\n    if (await isPortFree(port)) return port\n  }\n  return startPort\n}\n\nasync function waitForServerReady(baseURL, timeoutMs = 120_000) {\n  const startedAt = Date.now()\n  const url = `${baseURL}${READY_PATH}`\n\n  while (Date.now() - startedAt < timeoutMs) {\n    const controller = new AbortController()\n    const timeout = setTimeout(() => controller.abort(), 2_500)\n\n    try {\n      const res = await fetch(url, { method: 'GET', signal: controller.signal })\n      if (res.ok) return\n    } catch {\n      // ignore\n    } finally {\n      clearTimeout(timeout)\n    }\n\n    // eslint-disable-next-line no-await-in-loop\n    await delay(250)\n  }\n\n  throw new Error(`[e2e] Timed out waiting for server readiness at ${url}`)\n}\n\nconst args = process.argv.slice(2)\n\n// pnpm forwards a literal \"--\" into script args on this setup.\n// Playwright treats it as a positional test-file pattern and reports \"No tests found\".\nconst cleanedArgs = args.filter(a => a !== '--')\n\nconst isWin = process.platform === 'win32'\n\nconst repoRoot = process.cwd()\nconst host = process.env.PW_E2E_HOST || '127.0.0.1'\n\nconst detectedBaseURL = await detectRunningBaseURL()\nconst env = { ...process.env }\n\n// Force Playwright to not manage webServer; we manage it here for Windows reliability.\nenv.PW_SKIP_WEBSERVER = 'true'\n\nlet serverProc = null\nlet startedServer = false\n\ntry {\n  if (detectedBaseURL) {\n    env.BASE_URL = detectedBaseURL\n  } else {\n    const requestedPort = process.env.PORT ? Number(process.env.PORT) : undefined\n    const port = Number.isFinite(requestedPort) ? requestedPort : await findFreePort(3000)\n    const baseURL = `http://${host}:${port}`\n\n    const webServerEnv = {\n      ...process.env,\n      NEXT_PUBLIC_E2E: 'true',\n      PORT: String(port),\n      HOSTNAME: host,\n    }\n\n    const serverScript = path.join(repoRoot, 'scripts', 'playwright-web-server.mjs')\n    serverProc = spawn(process.execPath, [serverScript], {\n      stdio: 'inherit',\n      env: webServerEnv,\n    })\n    startedServer = true\n    env.BASE_URL = baseURL\n\n    await waitForServerReady(baseURL, 120_000)\n  }\n\n  const child = isWin\n    ? spawn('cmd.exe', ['/d', '/s', '/c', 'pnpm', 'exec', 'playwright', ...cleanedArgs], {\n        stdio: 'inherit',\n        env,\n      })\n    : spawn('pnpm', ['exec', 'playwright', ...cleanedArgs], {\n        stdio: 'inherit',\n        env,\n      })\n\n  const code = await new Promise((resolve) => {\n    child.on('exit', (exitCode, signal) => {\n      if (typeof exitCode === 'number') return resolve(exitCode)\n      resolve(signal ? 1 : 0)\n    })\n  })\n\n  process.exit(code)\n} finally {\n  if (startedServer && serverProc && !serverProc.killed) {\n    if (isWin) {\n      // Ensure the entire process tree is terminated on Windows.\n      spawn('cmd.exe', ['/d', '/s', '/c', 'taskkill', '/PID', String(serverProc.pid), '/T', '/F'], {\n        stdio: 'ignore',\n      })\n    } else {\n      try {\n        serverProc.kill('SIGTERM')\n      } catch {}\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\scan-mobile-chrome-consistency.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\scan-tailwind-arbitrary.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\scan-tailwind-palette.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\scan-tailwind-semantic-tokens.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\scan-tailwind-token-alpha.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\seed-admin-docs.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\sync-docs-site.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\ts-safety-gate.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\ux-audit-screenshot.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\scripts\\validate-launch-readiness.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\supabase\\functions\\ai-shopping-assistant\\index.ts","messages":[{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":86,"column":46,"nodeType":"Identifier","messageId":"method","endLine":86,"endColumn":53,"fix":{"range":[2613,2613],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":93,"column":26,"nodeType":"Identifier","messageId":"method","endLine":93,"endColumn":33,"fix":{"range":[2850,2850],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":142,"column":29,"nodeType":"Identifier","messageId":"method","endLine":142,"endColumn":36,"fix":{"range":[4473,4473],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":148,"column":29,"nodeType":"Identifier","messageId":"method","endLine":148,"endColumn":36,"fix":{"range":[4625,4625],"text":"All"}},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":195,"column":6,"nodeType":"Identifier","messageId":"method","endLine":195,"endColumn":13,"fix":{"range":[5257,5257],"text":"All"}},{"ruleId":"unicorn/prefer-spread","severity":1,"message":"Prefer the spread operator over `Array.from(ΓÇª)`.","line":204,"column":10,"nodeType":"CallExpression","messageId":"array-from","endLine":204,"endColumn":36,"fix":{"range":[5474,5500],"text":"[...new Set(words)]"}},{"ruleId":"sonarjs/cognitive-complexity","severity":1,"message":"Refactor this function to reduce its Cognitive Complexity from 61 to the 25 allowed.","line":207,"column":19,"nodeType":null,"messageId":"refactorFunction","endLine":207,"endColumn":21},{"ruleId":"unicorn/prefer-optional-catch-binding","severity":1,"message":"Remove unused catch binding `e`.","line":218,"column":14,"nodeType":"Identifier","messageId":"with-name","endLine":218,"endColumn":15,"fix":{"range":[5793,5797],"text":""}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":218,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":218,"endColumn":15},{"ruleId":"@typescript-eslint/ban-ts-comment","severity":2,"message":"Use \"@ts-expect-error\" instead of \"@ts-ignore\", as \"@ts-ignore\" will do nothing if the following line is error-free.","line":515,"column":9,"nodeType":"Line","messageId":"tsIgnoreInsteadOfExpectError","endLine":515,"endColumn":22,"suggestions":[{"messageId":"replaceTsIgnoreWithTsExpectError","fix":{"range":[15674,15687],"text":"// @ts-expect-error"},"desc":"Replace \"@ts-ignore\" with \"@ts-expect-error\"."}]},{"ruleId":"unicorn/prefer-string-replace-all","severity":1,"message":"Prefer `String#replaceAll()` over `String#replace()`.","line":526,"column":47,"nodeType":"Identifier","messageId":"method","endLine":526,"endColumn":54,"fix":{"range":[16096,16096],"text":"All"}},{"ruleId":"unicorn/prefer-optional-catch-binding","severity":1,"message":"Remove unused catch binding `error`.","line":568,"column":12,"nodeType":"Identifier","messageId":"with-name","endLine":568,"endColumn":17,"fix":{"range":[17396,17404],"text":""}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":568,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":568,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":12,"fixableErrorCount":0,"fixableWarningCount":9,"source":"import { serve } from \"https://deno.land/std@0.168.0/http/server.ts\";\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2.39.3\";\n\nconst DEFAULT_SUGGESTIONS = [\"Under $5,000\", \"Under $10,000\", \"Used\", \"New\", \"Sedan\", \"SUV\"];\n\nconst corsHeadersBase = {\n  \"Access-Control-Allow-Headers\": \"authorization, x-client-info, apikey, content-type\",\n};\n\nfunction resolveCorsOrigin(origin: string | null): string {\n  const configured = Deno.env.get(\"AI_ASSISTANT_ALLOWED_ORIGINS\") ?? \"\";\n  const allowlist = configured\n    .split(\",\")\n    .map((value) => value.trim())\n    .filter(Boolean);\n\n  if (allowlist.length === 0) return \"*\";\n  if (origin && allowlist.includes(origin)) return origin;\n  return allowlist[0];\n}\n\nfunction buildCorsHeaders(origin: string | null) {\n  return {\n    ...corsHeadersBase,\n    \"Access-Control-Allow-Origin\": resolveCorsOrigin(origin),\n  };\n}\n\nasync function callGeminiDirect(params: {\n  apiKey: string;\n  systemPrompt: string;\n  conversationHistory: Array<{ role: string; content: string }>;\n  message: string;\n}): Promise<string | null> {\n  const { apiKey, systemPrompt, conversationHistory, message } = params;\n\n  // Gemini uses roles: user | model\n  const contents = [\n    ...conversationHistory\n      .filter((m) => m && typeof m.content === \"string\")\n      .map((m) => ({\n        role: m.role === \"assistant\" ? \"model\" : \"user\",\n        parts: [{ text: String(m.content) }],\n      })),\n    { role: \"user\", parts: [{ text: message }] },\n  ];\n\n  const resp = await fetch(\n    \"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent\",\n    {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        // Prefer header over query param to avoid accidental logging.\n        \"x-goog-api-key\": apiKey,\n      },\n      body: JSON.stringify({\n        systemInstruction: {\n          parts: [{ text: systemPrompt }],\n        },\n        contents,\n        generationConfig: {\n          temperature: 0.7,\n        },\n      }),\n    }\n  );\n\n  if (!resp.ok) {\n    console.error(\"Gemini direct error:\", resp.status);\n    return null;\n  }\n\n  const data: unknown = await resp.json().catch(() => null);\n  const parts = (data as { candidates?: Array<{ content?: { parts?: Array<{ text?: string }> } }> })\n    ?.candidates?.[0]?.content?.parts;\n  if (!Array.isArray(parts)) return null;\n  const text = parts\n    .map((p) => (typeof p?.text === \"string\" ? p.text : \"\"))\n    .join(\"\")\n    .trim();\n  return text || null;\n}\n\nfunction parseNumberLike(input: string): number | null {\n  const cleaned = input.trim().toLowerCase().replace(/[,\\\\s]/g, \"\");\n  const kMatch = cleaned.match(/^\\\\$?(\\\\d+(?:\\\\.\\\\d+)?)k$/);\n  if (kMatch) {\n    const value = Number(kMatch[1]);\n    return Number.isFinite(value) ? Math.round(value * 1000) : null;\n  }\n\n  const digits = cleaned.replace(/[^0-9.]/g, \"\");\n  if (!digits) return null;\n  const value = Number(digits);\n  return Number.isFinite(value) ? Math.round(value) : null;\n}\n\nfunction extractPriceRange(message: string): { priceMin: number | null; priceMax: number | null } {\n  const text = message.toLowerCase();\n\n  // between X and Y, X-Y, X to Y\n  const betweenMatch = text.match(\n    /(?:between|from)\\\\s+\\\\$?([0-9.,]+\\\\s*k?)\\\\s+(?:and|to|-|ΓÇô)\\\\s*\\\\$?([0-9.,]+\\\\s*k?)/i\n  );\n  if (betweenMatch) {\n    const a = parseNumberLike(betweenMatch[1]);\n    const b = parseNumberLike(betweenMatch[2]);\n    if (a !== null && b !== null) {\n      return { priceMin: Math.min(a, b), priceMax: Math.max(a, b) };\n    }\n  }\n\n  // under/below/max\n  const underMatch = text.match(/(?:under|below|max(?:imum)?|<=)\\\\s*\\\\$?\\\\s*([0-9.,]+\\\\s*k?)/i);\n  if (underMatch) {\n    const max = parseNumberLike(underMatch[1]);\n    if (max !== null) return { priceMin: null, priceMax: max };\n  }\n\n  // over/above/min\n  const overMatch = text.match(/(?:over|above|min(?:imum)?|>=)\\\\s*\\\\$?\\\\s*([0-9.,]+\\\\s*k?)/i);\n  if (overMatch) {\n    const min = parseNumberLike(overMatch[1]);\n    if (min !== null) return { priceMin: min, priceMax: null };\n  }\n\n  return { priceMin: null, priceMax: null };\n}\n\nfunction resolveCategorySlug(\n  message: string,\n  categoryList: Array<{ name: string; slug: string }>\n): string | null {\n  const text = message.toLowerCase();\n  for (const c of categoryList) {\n    const slug = String(c.slug ?? \"\").toLowerCase();\n    const name = String(c.name ?? \"\").toLowerCase();\n    if (!slug && !name) continue;\n    if (\n      slug &&\n      new RegExp(`\\\\b${slug.replace(/[-/\\\\^$*+?.()|[\\\\]{}]/g, \"\\\\\\\\$&\")}\\\\b`, \"i\").test(text)\n    ) {\n      return c.slug;\n    }\n    if (\n      name &&\n      new RegExp(`\\\\b${name.replace(/[-/\\\\^$*+?.()|[\\\\]{}]/g, \"\\\\\\\\$&\")}\\\\b`, \"i\").test(text)\n    ) {\n      return c.slug;\n    }\n  }\n  return null;\n}\n\nfunction extractTags(message: string): string[] {\n  const stop = new Set([\n    \"i\",\n    \"im\",\n    \"i'm\",\n    \"want\",\n    \"to\",\n    \"buy\",\n    \"get\",\n    \"need\",\n    \"show\",\n    \"me\",\n    \"a\",\n    \"an\",\n    \"the\",\n    \"some\",\n    \"any\",\n    \"for\",\n    \"with\",\n    \"and\",\n    \"or\",\n    \"under\",\n    \"below\",\n    \"over\",\n    \"above\",\n    \"between\",\n    \"from\",\n    \"in\",\n    \"on\",\n    \"at\",\n    \"near\",\n    \"around\",\n    \"cheap\",\n    \"budget\",\n    \"price\",\n  ]);\n\n  const words = message\n    .toLowerCase()\n    .replace(/[^a-z0-9\\\\s-]/g, \" \")\n    .split(/\\\\s+/)\n    .map((w) => w.trim())\n    .filter(Boolean)\n    .filter((w) => w.length >= 3)\n    .filter((w) => !stop.has(w))\n    .filter((w) => !/^\\\\d/.test(w));\n\n  // de-dupe\n  return Array.from(new Set(words)).slice(0, 6);\n}\n\nserve(async (req) => {\n  const corsHeaders = buildCorsHeaders(req.headers.get(\"Origin\"));\n\n  if (req.method === \"OPTIONS\") {\n    return new Response(null, { headers: corsHeaders });\n  }\n\n  try {\n    let body: unknown = {};\n    try {\n      body = await req.json();\n    } catch (e) {\n      return new Response(\n        JSON.stringify({\n          error: \"invalid_json\",\n          message: \"Invalid request body. Expected JSON.\",\n          messageKey: \"ai.invalidJson\",\n          products: [],\n          filters: {},\n          suggestions: [],\n        }),\n        {\n          status: 400,\n          headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\n        }\n      );\n    }\n\n    const payload = body as {\n      message?: string;\n      conversationHistory?: Array<{ role: string; content: string }>;\n    };\n\n    const message: string = typeof payload.message === \"string\" ? payload.message : \"\";\n    const conversationHistory = Array.isArray(payload.conversationHistory)\n      ? payload.conversationHistory\n      : [];\n\n    const LOVABLE_API_KEY = Deno.env.get(\"LOVABLE_API_KEY\") ?? null;\n    const GEMINI_API_KEY = Deno.env.get(\"GEMINI_API_KEY\") ?? null;\n\n    // Initialize Supabase client\n    const supabaseUrl = Deno.env.get(\"SUPABASE_URL\");\n    const supabaseKey = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\");\n    if (!supabaseUrl || !supabaseKey) {\n      throw new Error(\"Missing required Supabase environment variables\");\n    }\n    const supabase = createClient(supabaseUrl, supabaseKey);\n\n    const { data: categories, error: categoriesError } = await supabase\n      .from(\"categories\")\n      .select(\"id, name, slug\");\n\n    if (categoriesError) {\n      console.error(\"Error fetching categories\");\n    }\n\n    const categoryList = (categories ?? []).map((c: { id: string; name: string; slug: string }) => ({\n      id: c.id,\n      name: c.name,\n      slug: c.slug,\n    }));\n\n    const systemPrompt = `You are an expert AI shopping assistant for a marketplace.\n\nYour job is to extract search filters from the user's message so the server can query the database.\n\nAvailable categories (name + slug):\n${JSON.stringify(categoryList, null, 2)}\n\nRULES:\n1) ALWAYS extract filters and let the server show products. DO NOT ask clarifying questions unless the query is just 1-2 generic words like \"stuff\" or \"things\".\n   - If user says \"BMW 325xi\" -> tags: [\"bmw\", \"325xi\"], category: \"automotive\" or similar\n   - If user says \"used iPhone\" -> tags: [\"used\", \"iphone\"], category: \"electronics\" or similar\n   - If user says \"laptop under 500\" -> tags: [\"laptop\"], priceMax: 500\n\n2) Keep message SHORT or empty. Never lecture the user. Just show results.\n\n3) ALWAYS respond with JSON in EXACTLY this format:\n{\n  \"message\": \"\",\n  \"products\": [],\n  \"filters\": {\n    \"priceMin\": null,\n    \"priceMax\": null,\n    \"category\": null,\n    \"tags\": []\n  },\n  \"suggestions\": []\n}\n\nGuidance:\n- \"filters.category\" must be a category slug from the list above (or null).\n- \"filters.tags\" should capture ALL keywords: brand, model, condition, type (e.g. [\"bmw\", \"325xi\", \"used\"]).\n- Suggestion chips: 4-6 short refinements (e.g., \"Under $5,000\", \"Automatic\", \"Low mileage\").\n`;\n\n    // Either call an LLM (if configured) or fall back to a heuristic intent extractor.\n    let parsedResponse: Record<string, unknown> | null = null;\n    let provider: \"lovable\" | \"gemini\" | \"heuristic\" = \"heuristic\";\n\n    if (LOVABLE_API_KEY) {\n      const messages = [\n        { role: \"system\", content: systemPrompt },\n        ...conversationHistory.map((msg) => ({\n          role: msg.role,\n          content: msg.content,\n        })),\n        { role: \"user\", content: message },\n      ];\n\n      const response = await fetch(\"https://ai.gateway.lovable.dev/v1/chat/completions\", {\n        method: \"POST\",\n        headers: {\n          Authorization: `Bearer ${LOVABLE_API_KEY}`,\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          model: \"google/gemini-2.5-flash\",\n          messages,\n          temperature: 0.7,\n        }),\n      });\n\n      if (!response.ok) {\n        console.error(\"AI gateway error:\", response.status);\n\n        if (response.status === 429) {\n          return new Response(\n            JSON.stringify({\n              error: \"rate_limited\",\n              message: \"Rate limit exceeded. Please try again in a moment.\",\n              messageKey: \"ai.rateLimited\",\n            }),\n            {\n              status: 429,\n              headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\n            }\n          );\n        }\n        if (response.status === 402) {\n          return new Response(\n            JSON.stringify({\n              error: \"service_unavailable\",\n              message: \"Service temporarily unavailable. Please try again later.\",\n              messageKey: \"ai.unavailable\",\n            }),\n            {\n              status: 402,\n              headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\n            }\n          );\n        }\n\n        // If the AI gateway is misconfigured, fall back to heuristic mode rather than 500'ing.\n        parsedResponse = null;\n      } else {\n        const data = (await response.json().catch(() => null)) as {\n          choices?: Array<{ message?: { content?: string } }>;\n        } | null;\n        const aiResponse = data?.choices?.[0]?.message?.content;\n        if (typeof aiResponse !== \"string\") {\n          parsedResponse = null;\n        } else {\n          try {\n            const jsonMatch =\n              aiResponse.match(/```json\\\\s*([\\\\s\\\\S]*?)\\\\s*```/) ||\n              aiResponse.match(/```\\\\s*([\\\\s\\\\S]*?)\\\\s*```/) ||\n              [null, aiResponse];\n            const jsonStr = jsonMatch[1] || aiResponse;\n            parsedResponse = JSON.parse(jsonStr.trim()) as Record<string, unknown>;\n            provider = \"lovable\";\n          } catch {\n            parsedResponse = {\n              message: aiResponse,\n              messageKey: \"ai.response\",\n              products: [],\n              filters: {},\n              suggestions: [],\n            };\n            provider = \"lovable\";\n          }\n        }\n      }\n    }\n\n    if (!parsedResponse && GEMINI_API_KEY) {\n      const geminiText = await callGeminiDirect({\n        apiKey: GEMINI_API_KEY,\n        systemPrompt,\n        conversationHistory,\n        message,\n      });\n\n      if (geminiText) {\n        try {\n          const jsonMatch =\n            geminiText.match(/```json\\\\s*([\\\\s\\\\S]*?)\\\\s*```/) ||\n            geminiText.match(/```\\\\s*([\\\\s\\\\S]*?)\\\\s*```/) ||\n            [null, geminiText];\n          const jsonStr = jsonMatch[1] || geminiText;\n          parsedResponse = JSON.parse(String(jsonStr).trim()) as Record<string, unknown>;\n          provider = \"gemini\";\n        } catch {\n          parsedResponse = {\n            message: geminiText,\n            messageKey: \"ai.response\",\n            products: [],\n            filters: {},\n            suggestions: [],\n          };\n          provider = \"gemini\";\n        }\n      }\n    }\n\n    if (!parsedResponse) {\n      const { priceMin, priceMax } = extractPriceRange(message);\n      const category = resolveCategorySlug(message, categoryList);\n      const tags = extractTags(message);\n      parsedResponse = {\n        message: \"\",\n        products: [],\n        filters: {\n          priceMin,\n          priceMax,\n          category,\n          tags,\n        },\n        suggestions: [],\n      };\n      provider = \"heuristic\";\n    }\n\n    parsedResponse._meta = { provider };\n\n    // Server-side: ALWAYS show products. Only ask clarifying questions for extremely vague queries.\n    const filters = (parsedResponse.filters ?? {}) as {\n      priceMin?: number | null;\n      priceMax?: number | null;\n      category?: string | null;\n      tags?: string[];\n    };\n    const priceMin = typeof filters.priceMin === \"number\" ? filters.priceMin : null;\n    const priceMax = typeof filters.priceMax === \"number\" ? filters.priceMax : null;\n    const tags = Array.isArray(filters.tags)\n      ? filters.tags.filter(Boolean).map((t) => String(t).toLowerCase())\n      : [];\n    const categorySlug = typeof filters.category === \"string\" ? filters.category : null;\n\n    // Show products if: any price filter, any tags, any category, or message has 3+ words (specific query)\n    const msgWords = String(message ?? \"\")\n      .trim()\n      .split(/\\\\s+/)\n      .filter((w) => w.length > 1).length;\n    const isSpecific =\n      priceMin !== null || priceMax !== null || tags.length >= 1 || categorySlug !== null || msgWords >= 3;\n\n    // Resolve category slug -> id\n    const categoryId = categorySlug\n      ? categoryList.find((c) => c.slug === categorySlug)?.id ?? null\n      : null;\n\n    // If not specific, force clarification: no products.\n    if (!isSpecific) {\n      parsedResponse.products = [];\n      parsedResponse.filters = {\n        priceMin,\n        priceMax,\n        category: categorySlug,\n        tags,\n      };\n\n      if (!parsedResponse.message || typeof parsedResponse.message !== \"string\") {\n        parsedResponse.message =\n          \"Quick question so I can narrow it down: what's your budget, and any preferences (make/model/type)?\";\n        parsedResponse.messageKey = \"ai.clarify\";\n      }\n\n      if (!Array.isArray(parsedResponse.suggestions) || parsedResponse.suggestions.length === 0) {\n        parsedResponse.suggestions = DEFAULT_SUGGESTIONS;\n      }\n\n      return new Response(JSON.stringify(parsedResponse), {\n        headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\n      });\n    }\n\n    // Specific enough: query DB to get product IDs.\n    const buildBaseQuery = () => {\n      let q = supabase\n        .from(\"products\")\n        .select(\"id\")\n        .order(\"created_at\", { ascending: false })\n        .limit(12);\n\n      if (categoryId) q = q.eq(\"category_id\", categoryId);\n      if (priceMin !== null) q = q.gte(\"price\", priceMin);\n      if (priceMax !== null) q = q.lte(\"price\", priceMax);\n      return q;\n    };\n\n    let matched: Array<{ id: string }> | null = null;\n    let matchError: unknown = null;\n\n    if (tags.length > 0) {\n      // 1) Prefer array overlap on tags.\n      try {\n        // @ts-ignore\n        const { data, error } = await buildBaseQuery().overlaps(\"tags\", tags);\n        matched = data ?? null;\n        matchError = error;\n      } catch (e) {\n        matchError = e;\n      }\n\n      // 2) If overlap fails or returns nothing, try searching the name.\n      if (matchError || !matched || matched.length === 0) {\n        const safeTags = tags\n          .map((t) => String(t).toLowerCase().replace(/[^a-z0-9-]/g, \"\"))\n          .filter(Boolean)\n          .slice(0, 4);\n\n        if (safeTags.length > 0) {\n          const orFilter = safeTags.map((t) => `name.ilike.%${t}%`).join(\",\");\n          const { data, error } = await buildBaseQuery().or(orFilter);\n          if (!error && data && data.length > 0) {\n            matched = data;\n            matchError = null;\n          }\n        }\n      }\n\n      // 3) Last resort: return latest matches without tags so the UI isn't empty.\n      if (!matched || matched.length === 0) {\n        const { data, error } = await buildBaseQuery();\n        matched = data ?? null;\n        matchError = error;\n      }\n    } else {\n      const { data, error } = await buildBaseQuery();\n      matched = data ?? null;\n      matchError = error;\n    }\n\n    if (matchError) console.error(\"Error querying matched products\");\n\n    parsedResponse.products = (matched ?? []).map((r) => r.id);\n    parsedResponse.filters = {\n      priceMin,\n      priceMax,\n      category: categorySlug,\n      tags,\n    };\n\n    // Make sure suggestions exists.\n    if (!Array.isArray(parsedResponse.suggestions)) parsedResponse.suggestions = [];\n\n    return new Response(JSON.stringify(parsedResponse), {\n      headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\n    });\n  } catch (error) {\n    console.error(\"Error in ai-shopping-assistant\");\n    return new Response(\n      JSON.stringify({\n        error: \"internal_error\",\n        message: \"I'm having trouble right now. Please try again!\",\n        messageKey: \"ai.error\",\n        products: [],\n        filters: {},\n        suggestions: [],\n      }),\n      {\n        status: 500,\n        headers: { ...corsHeaders, \"Content-Type\": \"application/json\" },\n      }\n    );\n  }\n});\n","usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\test\\setup.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"J:\\amazong\\vitest.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
